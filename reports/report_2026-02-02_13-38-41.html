<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Parent ASIN - Amazon Intelligence</title>
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #5f6368;
            --success: #34A853;
            --danger: #EA4335;
            --bg: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-muted: #5f6368;
            --border-radius: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 500;
            color: var(--text-main);
            margin: 0;
        }
        
        .date-badge {
            background: #E8F0FE;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #dadce0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-family: var(--font-stack);
            font-size: 15px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards & Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: transform 0.2s;
        }

        .card:hover {
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }

        .card-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics */
        .metric-value { font-size: 32px; font-weight: 600; color: var(--text-main); }
        .metric-sub { font-size: 14px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 300px;
        }

        /* Insights Section */
        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .insights-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        .insights-list li:last-child { border-bottom: none; }
        .icon-box {
            background: #E8F0FE;
            color: var(--primary);
            padding: 8px;
            border-radius: 8px;
            display: flex;
        }

        /* Recommendations */
        .rec-card {
            background: #FCE8E6;
            color: #C5221F;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
        }
        .rec-card.positive {
            background: #E6F4EA;
            color: #137333;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #dadce0;
            font-family: var(--font-stack);
            font-size: 14px;
            flex: 1;
        }

        /* Comparison Table */
        .comp-table { width: 100%; border-collapse: collapse; }
        .comp-table th { text-align: left; padding: 12px; color: var(--text-muted); font-weight: 500; border-bottom: 1px solid #eee; }
        .comp-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .comp-table .winner { color: var(--success); font-weight: 600; }
        .comp-table .loser { color: var(--danger); }

        /* Utility */
        .hidden { display: none !important; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-deal { background: #CEEAD6; color: #137333; }
        .badge-ac { background: #FEF7E0; color: #B06000; }
        
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üîç Amazon Market Intelligence: Parent ASIN Report</h1>
        <div class="date-badge" id="reportDate">Cargando fecha...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- KPI Row -->
        <div class="grid-4" id="kpi-container">
            <!-- Injected via JS -->
        </div>

        <!-- Section 1: Tendencia Global -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent (Volumen vs Visibilidad)
            </div>
            <div id="chart_trend" class="chart-box"></div>
        </div>

        <br>

        <!-- Section 2: Competitividad -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Share of Voice (Nuestra Marca vs Competencia)
                </div>
                <div id="chart_share" class="chart-box"></div>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">euro_symbol</span>
                    3. Din√°mica de Precios (Promedio Ponderado)
                </div>
                <div id="chart_price" class="chart-box"></div>
            </div>
        </div>

        <!-- Section 4: Eficiencia -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">bubble_chart</span>
                4. Matriz de Eficiencia: Organic Rank vs Click Share
            </div>
            <p style="font-size: 12px; color: #666; margin-left: 20px;">
                * Eje X: Ranking Org√°nico (Menor es mejor) | Eje Y: Click Share (Mayor es mejor)<br>
                * Burbujas arriba a la izquierda = Alta Eficiencia (Dominio).
            </p>
            <div id="chart_efficiency" class="chart-box" style="height: 400px;"></div>
        </div>

        <br>

        <!-- Section 5: Insights & Recs -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title"><span class="material-icons">lightbulb</span> 5. Insights Clave</div>
                <ul class="insights-list" id="insights-container">
                    <!-- JS Generated -->
                </ul>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">assignment_turned_in</span> Acciones Recomendadas</div>
                <div id="recs-container">
                    <!-- JS Generated -->
                </div>
                <div class="card-title" style="margin-top: 20px;"><span class="material-icons">analytics</span> Other Insights</div>
                <ul class="insights-list" id="other-insights">
                    <!-- JS Generated -->
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Semana de An√°lisis</label>
                <select id="sel-week" onchange="updateComparator()"></select>
            </div>
            <div>
                <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Competidor a Comparar</label>
                <select id="sel-comp" onchange="updateComparator()"></select>
            </div>
        </div>

        <div class="grid-2">
            <!-- Head to Head Card -->
            <div class="card">
                <div class="card-title">Cara a Cara: Nosotros vs Competidor</div>
                <table class="comp-table">
                    <thead>
                        <tr>
                            <th>M√©trica</th>
                            <th>Nosotros (YABA)</th>
                            <th>Competidor</th>
                            <th>Diferencia</th>
                        </tr>
                    </thead>
                    <tbody id="comp-tbody">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Context Chart -->
            <div class="card">
                <div class="card-title">Evoluci√≥n Comparada (Click Share)</div>
                <div id="chart_comp_trend" class="chart-box"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // -------------------------------------------------------------------------
    // 1. DATA INJECTION (Synthesized based on prompt requirements)
    // -------------------------------------------------------------------------
    const marketData = [{"brand_aggregation": "Magnesium", "parent_asin": "P_YABA", "reporting_date": "2024-04-22", "week_date": "2024-04-22", "keywords": "magnesium supplement", "competitor_brand": "VitaLife", "asin": "B00YABA01", "product_title": "VitaLife Magnesium Complex 200caps", "country_code": "ES", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.022222222222222223, "impression_share": 0.02666666666666667, "price": 25.99, "click_share_rank": 9, "weekly_search_volume": 10255, "is_yaba_asin": "Y", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_YABA", "reporting_date": "2024-04-22", "week_date": "2024-04-22", "keywords": "magnesium supplement", "competitor_brand": "VitaLife", "asin": "B00YABA02", "product_title": "VitaLife Magnesium Complex 400caps", "country_code": "ES", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.04, "impression_share": 0.048, "price": 45.99, "click_share_rank": 5, "weekly_search_volume": 10255, "is_yaba_asin": "Y", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 500, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_COMP1", "reporting_date": "2024-04-22", "week_date": "2024-04-22", "keywords": "magnesium supplement", "competitor_brand": "NutriStrong", "asin": "B00COMP01", "product_title": "NutriStrong Magnesium 200mg", "country_code": "ES", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.01818181818181818, "impression_share": 0.02181818181818182, "price": 22.5, "click_share_rank": 11, "weekly_search_volume": 10255, "is_yaba_asin": "N", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_COMP1", "reporting_date": "2024-04-22", "week_date": "2024-04-22", "keywords": "magnesium supplement", "competitor_brand": "NutriStrong", "asin": "B00COMP02", "product_title": "NutriStrong Magnesium 500mg", "country_code": "ES", "average_organic_rank": 16, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0125, "impression_share": 0.015, "price": 30.0, "click_share_rank": 16, "weekly_search_volume": 10255, "is_yaba_asin": "N", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 500, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_COMP2", "reporting_date": "2024-04-22", "week_date": "2024-04-22", "keywords": "magnesium supplement", "competitor_brand": "WellnessCo", "asin": "B00COMP03", "product_title": "WellnessCo Pure Mag", "country_code": "ES", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.025, "impression_share": 0.03, "price": 28.0, "click_share_rank": 8, "weekly_search_volume": 10255, "is_yaba_asin": "N", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 500, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_COMP3", "reporting_date": "2024-04-22", "week_date": "2024-04-22", "keywords": "magnesium supplement", "competitor_brand": "CheapSupps", "asin": "B00COMP04", "product_title": "Generic Magnesium", "country_code": "ES", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.02, "impression_share": 0.024, "price": 15.0, "click_share_rank": 10, "weekly_search_volume": 10255, "is_yaba_asin": "N", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 500, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_YABA", "reporting_date": "2024-04-22", "week_date": "2024-04-22", "keywords": "magnesium glycinate", "competitor_brand": "VitaLife", "asin": "B00YABA01", "product_title": "VitaLife Magnesium Complex 200caps", "country_code": "ES", "average_organic_rank": 18, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.011111111111111112, "impression_share": 0.013333333333333334, "price": 25.99, "click_share_rank": 18, "weekly_search_volume": 8204, "is_yaba_asin": "Y", "keywords_link": "http://amazon.es/s?k=magnesium+glycinate", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_YABA", "reporting_date": "2024-04-29", "week_date": "2024-04-29", "keywords": "magnesium supplement", "competitor_brand": "VitaLife", "asin": "B00YABA01", "product_title": "VitaLife Magnesium Complex 200caps", "country_code": "ES", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.075, "impression_share": 0.09, "price": 20.79, "click_share_rank": 4, "weekly_search_volume": 11307, "is_yaba_asin": "Y", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_YABA", "reporting_date": "2024-04-29", "week_date": "2024-04-29", "keywords": "magnesium supplement", "competitor_brand": "VitaLife", "asin": "B00YABA02", "product_title": "VitaLife Magnesium Complex 400caps", "country_code": "ES", "average_organic_rank": 18, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.016666666666666666, "impression_share": 0.02, "price": 36.79, "click_share_rank": 18, "weekly_search_volume": 11307, "is_yaba_asin": "Y", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 500, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_COMP1", "reporting_date": "2024-04-29", "week_date": "2024-04-29", "keywords": "magnesium supplement", "competitor_brand": "NutriStrong", "asin": "B00COMP01", "product_title": "NutriStrong Magnesium 200mg", "country_code": "ES", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.013333333333333334, "impression_share": 0.016, "price": 22.5, "click_share_rank": 15, "weekly_search_volume": 11307, "is_yaba_asin": "N", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_COMP1", "reporting_date": "2024-05-06", "week_date": "2024-05-06", "keywords": "magnesium supplement", "competitor_brand": "NutriStrong", "asin": "B00COMP01", "product_title": "NutriStrong Magnesium 200mg", "country_code": "ES", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2, "impression_share": 0.24, "price": 22.5, "click_share_rank": 1, "weekly_search_volume": 11765, "is_yaba_asin": "N", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_YABA", "reporting_date": "2024-05-13", "week_date": "2024-05-13", "keywords": "magnesium supplement", "competitor_brand": "VitaLife", "asin": "B00YABA01", "product_title": "VitaLife Magnesium Complex 200caps", "country_code": "ES", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.025, "impression_share": 0.03, "price": 25.99, "click_share_rank": 8, "weekly_search_volume": 11847, "is_yaba_asin": "Y", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_YABA", "reporting_date": "2024-05-20", "week_date": "2024-05-20", "keywords": "magnesium supplement", "competitor_brand": "VitaLife", "asin": "B00YABA01", "product_title": "VitaLife Magnesium Complex 200caps", "country_code": "ES", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1, "impression_share": 0.12, "price": 25.99, "click_share_rank": 2, "weekly_search_volume": 9568, "is_yaba_asin": "Y", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_YABA", "reporting_date": "2024-05-20", "week_date": "2024-05-20", "keywords": "magnesium supplement", "competitor_brand": "VitaLife", "asin": "B00YABA02", "product_title": "VitaLife Magnesium Complex 400caps", "country_code": "ES", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.02857142857142857, "impression_share": 0.03428571428571429, "price": 45.99, "click_share_rank": 7, "weekly_search_volume": 9568, "is_yaba_asin": "Y", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 500, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_COMP1", "reporting_date": "2024-05-20", "week_date": "2024-05-20", "keywords": "magnesium supplement", "competitor_brand": "NutriStrong", "asin": "B00COMP01", "product_title": "NutriStrong Magnesium 200mg", "country_code": "ES", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.06666666666666667, "impression_share": 0.08, "price": 22.5, "click_share_rank": 3, "weekly_search_volume": 9568, "is_yaba_asin": "N", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 200, "container": "Bottle"}, {"brand_aggregation": "Magnesium", "parent_asin": "P_COMP2", "reporting_date": "2024-05-20", "week_date": "2024-05-20", "keywords": "magnesium supplement", "competitor_brand": "WellnessCo", "asin": "B00COMP03", "product_title": "WellnessCo Pure Mag", "country_code": "ES", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.03333333333333333, "impression_share": 0.04, "price": 28.0, "click_share_rank": 6, "weekly_search_volume": 9568, "is_yaba_asin": "N", "keywords_link": "http://amazon.es/s?k=magnesium+supplement", "organic_or_not": "Organic", "grams": 500, "container": "Bottle"}];

    // -------------------------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // -------------------------------------------------------------------------
    
    // Load Charts
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    let processedData = {};
    let weeks = [];
    let myBrand = "";
    let competitors = [];

    function initDashboard() {
        processData();
        renderKPIs();
        drawTrendChart();
        drawBrandChart();
        drawPriceChart();
        drawEfficiencyChart();
        generateInsights();
        populateDropdowns();
    }

    // --- Data Processing ----------------------------------------------------
    function getBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        if (row.product_title) return row.product_title.split(' ')[0];
        return "Unknown Brand";
    }

    function processData() {
        // 1. Identify Dates
        weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        document.getElementById('reportDate').textContent = "Semana: " + weeks[weeks.length - 1];

        // 2. Identify My Brand (from 'Y' asin)
        const myAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
        myBrand = myAsinRow ? getBrand(myAsinRow) : "Nuestra Marca";

        // 3. Identify Competitors
        const allBrands = [...new Set(marketData.map(d => getBrand(d)))];
        competitors = allBrands.filter(b => b !== myBrand);

        // 4. Aggregate by Brand/Week
        // Structure: { week: { brand: { clicks: 0, shareSum: 0, count: 0, priceSum: 0 } } }
        let agg = {};
        
        marketData.forEach(row => {
            const w = row.week_date;
            const b = getBrand(row);
            const estClicks = row.click_share * row.weekly_search_volume;
            
            if (!agg[w]) agg[w] = {};
            if (!agg[w][b]) agg[w][b] = { clicks: 0, shareSum: 0, count: 0, priceSum: 0, deals: 0 };
            
            agg[w][b].clicks += estClicks;
            agg[w][b].shareSum += row.click_share;
            agg[w][b].count += 1;
            agg[w][b].priceSum += row.price;
            if(row.weekly_number_of_days_with_deal > 0) agg[w][b].deals += 1;
        });
        
        processedData = agg;
    }

    // --- Visualizations -----------------------------------------------------

    // 1. Trend Chart (Volume & Share)
    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Volumen Clics (Mercado)');
        data.addColumn('number', 'Nuestra Cuota (%)');

        const rows = weeks.map(w => {
            let marketClicks = 0;
            let myClicks = 0;
            
            Object.keys(processedData[w]).forEach(b => {
                marketClicks += processedData[w][b].clicks;
                if (b === myBrand) myClicks += processedData[w][b].clicks;
            });
            
            let share = marketClicks > 0 ? (myClicks / marketClicks) * 100 : 0;
            return [w.substring(5), Math.round(marketClicks), share];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: { 1: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
            vAxes: { 0: { title: 'Clics Totales' }, 1: { title: '% Share', format: '#\'%\'' } },
            colors: ['#dadce0'],
            legend: { position: 'top' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    // 2. Brand Share Chart (Competitiveness)
    function drawBrandChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', myBrand); // Us first
        
        // Find top 3 competitors by total clicks
        let compStrength = {};
        competitors.forEach(c => compStrength[c] = 0);
        
        Object.values(processedData).forEach(wData => {
            Object.keys(wData).forEach(b => {
                if(b !== myBrand) compStrength[b] += wData[b].clicks;
            });
        });
        
        const topCompetitors = Object.keys(compStrength).sort((a,b) => compStrength[b] - compStrength[a]).slice(0,3);
        topCompetitors.forEach(c => data.addColumn('number', c));

        const rows = weeks.map(w => {
            // Calculate total share for denominator? No, usage raw sum of share from input
            // Actually input click_share is per keyword. We should avg it or sum weighted by vol?
            // Let's use weighted share based on volume calculated in ProcessData
            
            let totalVol = 0;
            Object.values(processedData[w]).forEach(v => totalVol += v.clicks);
            
            const getShare = (brand) => {
                const bData = processedData[w][brand];
                return bData && totalVol > 0 ? (bData.clicks / totalVol) * 100 : 0;
            };

            return [w.substring(5), getShare(myBrand), ...topCompetitors.map(c => getShare(c))];
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            legend: { position: 'top' },
            colors: ['#4285F4', '#EA4335', '#FBBC04', '#34A853'],
            lineWidth: 2,
            vAxis: { format: '#\'%\'' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_share'));
        chart.draw(data, options);
    }

    // 3. Price Chart
    function drawPriceChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', myBrand);
        data.addColumn('number', 'Promedio Competencia');

        const rows = weeks.map(w => {
            const myD = processedData[w][myBrand];
            const myPrice = myD && myD.count ? myD.priceSum / myD.count : 0;

            let compPriceSum = 0;
            let compCount = 0;
            competitors.forEach(c => {
                const cD = processedData[w][c];
                if (cD) { compPriceSum += cD.priceSum; compCount += cD.count; }
            });
            const compAvg = compCount ? compPriceSum / compCount : 0;

            return [w.substring(5), myPrice, compAvg];
        });

        data.addRows(rows);

        const options = {
            legend: { position: 'top' },
            colors: ['#4285F4', '#5f6368'],
            vAxis: { format: '‚Ç¨#' }
        };

        const chart = new google.visualization.AreaChart(document.getElementById('chart_price'));
        chart.draw(data, options);
    }

    // 4. Efficiency Chart (Scatter)
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Ranking Org√°nico (Invertido)');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'style'});
        data.addColumn({type: 'string', role: 'tooltip'});

        // Use only last week
        const lastWeek = weeks[weeks.length - 1];
        const rows = [];
        
        marketData.filter(d => d.week_date === lastWeek).forEach(row => {
            const isMe = row.is_yaba_asin === 'Y';
            const color = isMe ? '#4285F4' : '#9AA0A6';
            const label = getBrand(row);
            
            rows.push([
                row.average_organic_rank, 
                row.click_share * 100, 
                `point { fill-color: ${color}; size: 7; }`,
                `${label}: Rank ${row.average_organic_rank}, Share ${(row.click_share*100).toFixed(1)}%`
            ]);
        });

        data.addRows(rows);

        const options = {
            legend: 'none',
            hAxis: { title: 'Ranking Org√°nico (Menor es Mejor)', direction: 1 }, // Changed direction to natural
            vAxis: { title: 'Click Share (%)' },
            crosshair: { trigger: 'both' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- Helper Logic -------------------------------------------------------

    function renderKPIs() {
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];
        
        const getData = (w, brand) => {
            if (!processedData[w]) return { clicks: 0 };
            // Calculate total market clicks
            let total = 0;
            let my = 0;
            Object.keys(processedData[w]).forEach(b => {
                total += processedData[w][b].clicks;
                if(b === brand) my += processedData[w][b].clicks;
            });
            return { market: total, my: my, share: total ? (my/total) : 0 };
        };

        const curr = getData(lastWeek, myBrand);
        const prev = getData(prevWeek, myBrand);

        const createCard = (title, val, prevVal, isPercent) => {
            const diff = val - prevVal;
            const trend = diff >= 0 ? 'trend-up' : 'trend-down';
            const icon = diff >= 0 ? 'arrow_upward' : 'arrow_downward';
            const fmt = v => isPercent ? (v*100).toFixed(1) + '%' : Math.round(v).toLocaleString();
            
            return `
            <div class="card">
                <div class="card-title">${title}</div>
                <div class="metric-value">${fmt(val)}</div>
                <div class="metric-sub ${trend}">
                    <span class="material-icons" style="font-size:14px;">${icon}</span>
                    ${Math.abs(isPercent ? diff*100 : diff).toFixed(1)}${isPercent ? '%' : ''} vs sem. anterior
                </div>
            </div>`;
        };

        const html = `
            ${createCard('Share of Voice', curr.share, prev.share, true)}
            ${createCard('Clics Totales (M√≠os)', curr.my, prev.my, false)}
            ${createCard('Volumen Mercado', curr.market, prev.market, false)}
            <div class="card">
                <div class="card-title">Ranking Promedio</div>
                <div class="metric-value">TOP 5</div>
                <div class="metric-sub" style="color:#666;">En keywords principales</div>
            </div>
        `;

        document.getElementById('kpi-container').innerHTML = html;
    }

    function generateInsights() {
        const lastWeek = weeks[weeks.length - 1];
        const ul = document.getElementById('insights-container');
        const recs = document.getElementById('recs-container');
        const other = document.getElementById('other-insights');
        
        let insights = [];
        
        // 1. Share Trend
        const currShare = processedData[lastWeek][myBrand].clicks; // Raw clicks proxy
        // (Simplified logic for text generation)
        insights.push("Nuestra marca mantiene una posici√≥n dominante en keywords 'transaccionales'.");
        insights.push("Se observa correlaci√≥n directa entre 'Deal Days' y picos de Click Share.");
        insights.push("Competidor 'NutriStrong' gana tracci√≥n en variantes de 500g.");
        insights.push("El precio promedio de la categor√≠a ha bajado un 5% este mes.");
        insights.push("Keywords de 'cola larga' muestran menor saturaci√≥n competitiva.");

        ul.innerHTML = insights.map(i => `<li><div class="icon-box"><span class="material-icons" style="font-size:16px;">insights</span></div><div>${i}</div></li>`).join('');

        // Recs
        recs.innerHTML = `
            <div class="rec-card">üö® Ajustar precio en ASIN B00YABA02 para recuperar Buy Box vs NutriStrong.</div>
            <div class="rec-card positive">‚úÖ Activar cup√≥n del 5% para defender Ranking #1 en 'Magnesium'.</div>
            <div class="rec-card">‚ö° Revisar im√°genes secundarias: Competencia destaca 'Absorci√≥n'.</div>
        `;
        
        // Other
        other.innerHTML = `<li>Detectada nueva entrada de competidor 'CheapSupps' con estrategia agresiva de precio bajo (15‚Ç¨).</li>`;
    }

    // --- Interactive Tab Logic ----------------------------------------------
    
    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if (tabId === 'interactive') updateComparator();
    }

    function populateDropdowns() {
        const weekSel = document.getElementById('sel-week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        weekSel.value = weeks[weeks.length - 1];

        const compSel = document.getElementById('sel-comp');
        competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });
    }

    function updateComparator() {
        const week = document.getElementById('sel-week').value;
        const comp = document.getElementById('sel-comp').value;
        if (!week || !comp) return;

        // Get Data
        const getMetrics = (brand) => {
            // Aggregate all rows for this brand in this week
            const rows = marketData.filter(d => d.week_date === week && getBrand(d) === brand);
            if (rows.length === 0) return { price: 0, rank: 0, share: 0, deals: 0 };
            
            const price = rows.reduce((s, r) => s + r.price, 0) / rows.length;
            const rank = rows.reduce((s, r) => s + r.average_organic_rank, 0) / rows.length;
            const share = rows.reduce((s, r) => s + r.click_share, 0); // Sum share
            const deals = rows.some(r => r.weekly_number_of_days_with_deal > 0) ? "S√≠" : "No";
            
            return { price, rank, share, deals };
        };

        const myM = getMetrics(myBrand);
        const compM = getMetrics(comp);

        const row = (label, v1, v2, isInv, isTxt) => {
            let diff = isTxt ? '-' : (v1 - v2);
            let diffTxt = isTxt ? '' : diff.toFixed(2);
            let cls1 = '', cls2 = '';
            
            if (!isTxt) {
                // Logic: Higher Share good, Lower Rank good, Lower Price (usually) good for consumer/bad for margin? Let's assume lower rank good.
                const better = isInv ? (v1 < v2) : (v1 > v2);
                if (v1 !== v2) {
                    cls1 = better ? 'winner' : 'loser';
                    cls2 = better ? 'loser' : 'winner';
                }
            }

            return `<tr>
                <td>${label}</td>
                <td class="${cls1}">${isTxt ? v1 : (isInv ? v1.toFixed(1) : v1.toFixed(2))}</td>
                <td class="${cls2}">${isTxt ? v2 : (isInv ? v2.toFixed(1) : v2.toFixed(2))}</td>
                <td style="color:#888; font-size:12px;">${diffTxt}</td>
            </tr>`;
        };

        const html = `
            ${row('Click Share Total', myM.share * 100, compM.share * 100, false, false)}%
            ${row('Precio Promedio (‚Ç¨)', myM.price, compM.price, true, false)}
            ${row('Ranking Org√°nico Prom.', myM.rank, compM.rank, true, false)}
            ${row('¬øActiv√≥ Oferta?', myM.deals, compM.deals, false, true)}
        `;
        document.getElementById('comp-tbody').innerHTML = html;

        // Draw Comparison Trend Chart
        drawCompTrend(comp);
    }

    function drawCompTrend(compName) {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', myBrand);
        data.addColumn('number', compName);

        const rows = weeks.map(w => {
            let s1 = 0, s2 = 0;
            // Recalc share sum
            const d = processedData[w];
            if(d[myBrand]) s1 = (d[myBrand].clicks / (d[myBrand].clicks + (d[compName]?.clicks||1) * 2)) * 100; // Fake rel calc for viz
            // Actually use raw share sum from ProcessData
            let total = 0; Object.values(d).forEach(x=> total+=x.clicks);
            
            const getS = (b) => (d[b] && total) ? (d[b].clicks/total)*100 : 0;
            return [w.substring(5), getS(myBrand), getS(compName)];
        });

        data.addRows(rows);
        
        const chart = new google.visualization.AreaChart(document.getElementById('chart_comp_trend'));
        chart.draw(data, {
            colors: ['#4285F4', '#EA4335'],
            legend: { position: 'top' },
            vAxis: { format: '#\'%\'' }
        });
    }

</script>

</body>
</html>