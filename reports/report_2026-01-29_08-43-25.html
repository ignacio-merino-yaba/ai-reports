<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- React & Babel (CDN) as requested -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom Overrides for Google Native Feel */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            color: #202124;
            margin: 0;
            padding: 0;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            padding: 24px;
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            margin-bottom: 24px;
        }
        .card:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        }
        .header {
            background-color: white;
            padding: 20px 40px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brand-pill {
            background-color: #e8f0fe;
            color: #1967d2;
            padding: 6px 16px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .nav-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
            padding-left: 40px;
            background: white;
        }
        .nav-item {
            padding: 16px 4px;
            cursor: pointer;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 3px solid transparent;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: #1967d2;
            border-bottom-color: #1967d2;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #202124;
        }
        .kpi-label {
            color: #5f6368;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .kpi-trend {
            font-size: 0.9rem;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .trend-up { color: #188038; }
        .trend-down { color: #d93025; }
        
        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        
        /* Insights Section */
        .insight-box {
            border-left: 4px solid #1967d2;
            padding-left: 16px;
            margin-bottom: 16px;
        }
        .insight-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: #1967d2;
        }
        .rec-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }
        .rec-icon {
            color: #ea8600;
        }

        /* Controls */
        .control-panel {
            background: #f1f3f4;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            background: white;
            font-family: inherit;
            font-size: 14px;
        }
        
        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 1.5rem;">Análisis Parent ASIN: Matcha Premium</h1>
            <p style="margin:4px 0 0; color:#5f6368; font-size: 0.9rem;">Reporting Period: Dec 2025 - Jan 2026</p>
        </div>
        <div class="brand-pill">NaturaleBio</div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <div class="nav-item active" onclick="switchTab('static')">Reporte Estratégico</div>
        <div class="nav-item" onclick="switchTab('interactive')">Comparador Interactivo</div>
    </div>

    <!-- Main Content -->
    <div class="container">
        
        <!-- STATIC REPORT TAB -->
        <div id="static-tab">
            <!-- KPIs -->
            <div class="kpi-grid">
                <div class="card">
                    <div class="kpi-label">Cuota de Mercado (Última Semana)</div>
                    <div class="kpi-value" id="kpi-share">--%</div>
                    <div class="kpi-trend trend-up">
                        <span class="material-icons" style="font-size:16px">trending_up</span>
                        <span>vs sem. anterior</span>
                    </div>
                </div>
                <div class="card">
                    <div class="kpi-label">Rank Orgánico Promedio</div>
                    <div class="kpi-value" id="kpi-rank">--</div>
                    <div class="kpi-trend" style="color:#5f6368">
                        <span class="material-icons" style="font-size:16px">info</span>
                        <span>Lower is better</span>
                    </div>
                </div>
                <div class="card">
                    <div class="kpi-label">Precio Promedio</div>
                    <div class="kpi-value" id="kpi-price">--€</div>
                    <div class="kpi-trend trend-down" id="kpi-price-trend">
                        <!-- Dynamic -->
                    </div>
                </div>
                <div class="card">
                    <div class="kpi-label">Top Competidor</div>
                    <div class="kpi-value" id="kpi-comp" style="font-size: 1.4rem;">--</div>
                    <div class="kpi-trend">
                        <span>Mayor amenaza por Share</span>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <!-- 1. Global Trend -->
                <div class="card full-width">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">1. Tendencia Global del Parent</h2>
                    <p class="text-sm text-gray-500 mb-4">Evolución del volumen total de clics estimados y la cuota de mercado de NaturaleBio.</p>
                    <div id="chart_global_trend" class="chart-container"></div>
                </div>

                <!-- 2. Competitiveness -->
                <div class="card full-width">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">2. Competitividad de Marca (Click Share %)</h2>
                    <p class="text-sm text-gray-500 mb-4">Comparativa semana a semana contra Top 3 competidores.</p>
                    <div id="chart_competitiveness" class="chart-container"></div>
                </div>

                <!-- 3. Efficiency -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">3. Ranking vs Eficiencia (Scatter)</h2>
                    <p class="text-sm text-gray-500 mb-4">Eje X: Rank Orgánico (inv), Eje Y: Click Share. Burbujas arriba a la derecha son más eficientes.</p>
                    <div id="chart_efficiency" class="chart-container"></div>
                </div>

                <!-- 4. Price Analysis -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">4. Sensibilidad al Precio</h2>
                    <p class="text-sm text-gray-500 mb-4">Relación entre Precio Medio y Click Share por marca (Última semana).</p>
                    <div id="chart_price_share" class="chart-container"></div>
                </div>

                <!-- 5. Insights & Recommendations -->
                <div class="card full-width bg-gradient-to-r from-blue-50 to-white">
                    <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                        <span class="material-icons text-blue-600">lightbulb</span>
                        Conclusiones Clave y Recomendaciones
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Insights Estratégicos</h3>
                            <div id="insights-container">
                                <!-- Injected via JS -->
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Acciones Recomendadas</h3>
                            <div id="recommendations-container">
                                <!-- Injected via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INTERACTIVE TAB -->
        <div id="interactive-tab" style="display: none;">
            <div class="control-panel">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Semana</label>
                    <select id="select-week" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Comparar con</label>
                    <select id="select-competitor" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h3 class="font-bold text-gray-700 mb-4">Cara a Cara: Métricas Clave</h3>
                    <div id="table_comparison" style="height: 300px;"></div>
                </div>
                <div class="card">
                    <h3 class="font-bold text-gray-700 mb-4">Distribución de Precios</h3>
                    <div id="chart_interactive_price" class="chart-container" style="height: 300px;"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- DATA & LOGIC -->
    <script type="text/javascript">
        // INJECTED DATA FROM PYTHON
        const marketData = [{"week_str": "2026-01", "final_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.27, "click_share": 2.68, "average_organic_rank": null, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": null, "weekly_number_of_days_with_best_seller_badge": null, "weekly_number_of_days_with_amazon_choice_badge": null, "weekly_number_of_days_with_coupon": null}, {"week_str": "2026-01", "final_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "click_share": 2.39, "average_organic_rank": 10.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "Unknown Brand", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "click_share": 2.39, "average_organic_rank": 10.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "Unknown Brand", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 12.367142857, "click_share": 2.44, "average_organic_rank": 10.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 12.367142857, "click_share": 2.44, "average_organic_rank": 10.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 23.91, "click_share": 19.34, "average_organic_rank": 2.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0}, {"week_str": "2025-52", "final_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 24.648571429, "click_share": 18.77, "average_organic_rank": 2.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0}, {"week_str": "2025-52", "final_brand": "Ceremonial", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.037142857, "click_share": 8.42, "average_organic_rank": 6.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "Ceremonial", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.5575, "click_share": 7.38, "average_organic_rank": 6.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.5575, "click_share": 7.38, "average_organic_rank": 6.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.037142857, "click_share": 8.42, "average_organic_rank": 6.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.704285714, "click_share": 2.93, "average_organic_rank": 23.0, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 15.058571429, "click_share": 11.66, "average_organic_rank": 2.0, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.538571429, "click_share": 3.75, "average_organic_rank": 4.0, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.855714286, "click_share": 3.49, "average_organic_rank": 5.0, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 14.6075, "click_share": 12.9, "average_organic_rank": 2.0, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.5275, "click_share": 3.66, "average_organic_rank": 5.0, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.2225, "click_share": 3.35, "average_organic_rank": 5.0, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "UNREAL\u00ae", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "price": 31.2725, "click_share": 1.57, "average_organic_rank": 19.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 10.43, "click_share": 3.15, "average_organic_rank": 9.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 9.895714286, "click_share": 4.19, "average_organic_rank": 7.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2025-52", "final_brand": "VAHDAM", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "price": 9.895714286, "click_share": 1.47, "average_organic_rank": 20.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_str": "2026-01", "final_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "click_share": 3.0, "average_organic_rank": 16.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0}, {"week_str": "2026-01", "final_brand": "Matcha", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "click_share": 3.0, "average_organic_rank": 16.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0}, {"week_str": "2025-52", "final_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.71, "click_share": 3.4, "average_organic_rank": 13.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0}, {"week_str": "2025-52", "final_brand": "Matcha", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.71, "click_share": 3.4, "average_organic_rank": 13.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0}];
        
        const insightsData = {"target_brand": "NaturaleBio", "top_competitors": ["NORITUAL LAB", "Ceremonial", "VAHDAM"], "insights": ["Tendencia Global: NaturaleBio experimenta una crecimiento de cuota de mercado, pasando del 29.2% al 31.3% en la \u00faltima semana (2026-01).", "Competencia Principal: NORITUAL LAB lidera la oposici\u00f3n. Nuestros productos son un 21.7% m\u00e1s caros que el promedio de los Top 3 competidores (NORITUAL LAB, etc).", "Eficiencia de ASINs: El ASIN B06XQ5DCYJ es actualmente nuestro motor principal de tr\u00e1fico.", "An\u00e1lisis de Deals: Se detecta que la presencia de badges 'Best Seller' en competidores correlaciona con ca\u00eddas en nuestra cuota.", "Oportunidad de Rankings: Variantes con precio bajo ganan ranking org\u00e1nico m\u00e1s r\u00e1pido, pero no siempre convierten en click share alto."], "recommendations": ["Ajuste de Precios: Considerar igualar precios con el competidor l\u00edder en las variantes de entrada para recuperar cuota.", "Defensa de Marca: Aumentar puja en keywords de marca propia para evitar fuga de tr\u00e1fico hacia competidores agresivos.", "Optimizaci\u00f3n Visual: Revisar CTR de variantes con buen ranking org\u00e1nico pero bajo click share."], "market_data_sample": [{"week_str": "2026-01", "final_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.27, "click_share": 2.68, "average_organic_rank": null, "is_yaba_asin": "Y", "weekly_number_of_days_with_deal": null, "weekly_number_of_days_with_best_seller_badge": null, "weekly_number_of_days_with_amazon_choice_badge": null, "weekly_number_of_days_with_coupon": null}, {"week_str": "2026-01", "final_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "click_share": 2.39, "average_organic_rank": 10.0, "is_yaba_asin": "N", "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}], "len_data": 26};

        // Constants
        const OUR_BRAND = insightsData.target_brand;
        const TOP_COMPS = insightsData.top_competitors;
        const COLOR_US = '#1967d2';
        const COLOR_COMP_1 = '#d93025';
        const COLOR_COMP_2 = '#ea8600';
        const COLOR_OTHER = '#9aa0a6';

        // Initialize Google Charts
        google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            populateControls();
            renderInsights();
            updateKPIs();
            drawGlobalTrend();
            drawCompetitiveness();
            drawEfficiency();
            drawPriceShare();
            updateInteractive(); // Initial draw of interactive tab
        }

        // --- Logic Sections ---

        function getWeeks() {
            return [...new Set(marketData.map(d => d.week_str))].sort();
        }

        function populateControls() {
            const weeks = getWeeks();
            const weekSel = document.getElementById('select-week');
            weekSel.innerHTML = weeks.map(w => `<option value="${w}">${w}</option>`).join('');
            weekSel.value = weeks[weeks.length - 1]; // Default to latest

            const brands = [...new Set(marketData.map(d => d.final_brand))].filter(b => b !== OUR_BRAND);
            const compSel = document.getElementById('select-competitor');
            compSel.innerHTML = brands.map(b => `<option value="${b}">${b}</option>`).join('');
            if (brands.includes(TOP_COMPS[0])) compSel.value = TOP_COMPS[0];
        }

        function renderInsights() {
            const insContainer = document.getElementById('insights-container');
            insContainer.innerHTML = insightsData.insights.map(txt => `
                <div class="insight-box">
                    <div class="insight-title">${txt.split(':')[0]}</div>
                    <div class="text-sm text-gray-600">${txt.split(':')[1] || ''}</div>
                </div>
            `).join('');

            const recContainer = document.getElementById('recommendations-container');
            recContainer.innerHTML = insightsData.recommendations.map(txt => `
                <div class="rec-item">
                    <span class="material-icons rec-icon">check_circle</span>
                    <span class="text-sm text-gray-700 font-medium">${txt}</span>
                </div>
            `).join('');
        }

        function updateKPIs() {
            const weeks = getWeeks();
            const latest = weeks[weeks.length - 1];
            
            // Filter latest week data
            const lwData = marketData.filter(d => d.week_str === latest);
            
            // Share
            const ourData = lwData.filter(d => d.final_brand === OUR_BRAND);
            // Re-calc share based on total sum of click_share in dataset? 
            // Note: click_share in CSV sums to 100% per keyword roughly. 
            // Since we have multiple keywords, we average or sum? 
            // Better to sum click_share across keywords for Brand / sum total click_share.
            // Simplified: Sum of click_share for brand / Sum of all click_share
            const totalShare = lwData.reduce((sum, d) => sum + (d.click_share || 0), 0);
            const ourShareVal = ourData.reduce((sum, d) => sum + (d.click_share || 0), 0);
            const sharePct = totalShare > 0 ? (ourShareVal / totalShare) * 100 : 0;
            
            document.getElementById('kpi-share').innerText = sharePct.toFixed(1) + '%';
            
            // Rank
            const ranks = ourData.map(d => d.average_organic_rank).filter(r => r > 0);
            const avgRank = ranks.length ? (ranks.reduce((a,b)=>a+b,0)/ranks.length).toFixed(1) : '-';
            document.getElementById('kpi-rank').innerText = avgRank;

            // Price
            const prices = ourData.map(d => d.price).filter(p => p > 0);
            const avgPrice = prices.length ? (prices.reduce((a,b)=>a+b,0)/prices.length).toFixed(2) : '-';
            document.getElementById('kpi-price').innerText = avgPrice + '€';
            
            document.getElementById('kpi-comp').innerText = TOP_COMPS[0] || 'N/A';
        }

        // --- Chart Functions ---

        function drawGlobalTrend() {
            const weeks = getWeeks();
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', 'Volumen Clics Mercado');
            dataTable.addColumn('number', 'Nuestra Cuota (%)');
            
            // Aggregations
            const rows = weeks.map(w => {
                const wData = marketData.filter(d => d.week_str === w);
                // Estimated Clicks Logic (Replicating Python logic simply: sum of click_share as proxy for volume if volume const)
                // Actually let's just sum click_share as "Volume Index" for visualization if real volume missing
                // Python injected specific volume data? No, just raw.
                // Proxy: Sum(click_share) represents total captured attention. 
                // Better: Sum(click_share) of All Brands = Market Size (100% * keywords).
                const mktVol = wData.reduce((acc, d) => acc + (d.click_share || 0), 0);
                const ourVol = wData.filter(d => d.final_brand === OUR_BRAND)
                                    .reduce((acc, d) => acc + (d.click_share || 0), 0);
                const share = mktVol > 0 ? (ourVol / mktVol) * 100 : 0;
                return [w, mktVol, share];
            });

            dataTable.addRows(rows);

            const options = {
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1, color: COLOR_US}},
                colors: ['#e0e0e0'],
                vAxes: {0: {title: 'Volumen Index'}, 1: {title: 'Share %', format: '#\'%\''}},
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(dataTable, options);
        }

        function drawCompetitiveness() {
            const weeks = getWeeks();
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', OUR_BRAND);
            dataTable.addColumn('number', TOP_COMPS[0] || 'Comp 1');
            if(TOP_COMPS[1]) dataTable.addColumn('number', TOP_COMPS[1]);

            const rows = weeks.map(w => {
                const wData = marketData.filter(d => d.week_str === w);
                const total = wData.reduce((a,b) => a + (b.click_share||0), 0);
                
                const getShare = (brand) => {
                    const bVal = wData.filter(d => d.final_brand === brand).reduce((a,b)=>a+(b.click_share||0), 0);
                    return total > 0 ? (bVal/total)*100 : 0;
                };

                const row = [w, getShare(OUR_BRAND), getShare(TOP_COMPS[0])];
                if(TOP_COMPS[1]) row.push(getShare(TOP_COMPS[1]));
                return row;
            });

            dataTable.addRows(rows);

            const options = {
                curveType: 'function',
                colors: [COLOR_US, COLOR_COMP_1, COLOR_COMP_2],
                vAxis: {title: 'Share %'},
                legend: {position: 'bottom'},
                chartArea: {width: '90%', height: '70%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(dataTable, options);
        }

        function drawEfficiency() {
            const weeks = getWeeks();
            const latest = weeks[weeks.length-1];
            const wData = marketData.filter(d => d.week_str === latest && d.average_organic_rank > 0 && d.click_share > 0);

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('number', 'Rank Orgánico (Inv)');
            dataTable.addColumn('number', 'Click Share %');
            dataTable.addColumn({type: 'string', role: 'style'});
            dataTable.addColumn({type: 'string', role: 'tooltip'});

            const rows = wData.map(d => {
                const isUs = d.final_brand === OUR_BRAND;
                const color = isUs ? `point {fill-color: ${COLOR_US}}` : `point {fill-color: #bdbdbd}`;
                return [d.average_organic_rank, d.click_share, color, `${d.asin} (${d.final_brand}): Rank ${d.average_organic_rank}, Share ${d.click_share}%`];
            });

            dataTable.addRows(rows);

            const options = {
                hAxis: {title: 'Rank Orgánico (Menor es mejor)', direction: -1}, // Invert to show rank 1 on right or left? Usually Rank 1 is "High" efficiency. Let's invert so 1 is far right? Or standard left. Let's standard left (1 -> 50).
                vAxis: {title: 'Click Share %'},
                legend: 'none',
                chartArea: {width: '85%', height: '80%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(dataTable, options);
        }
        
        function drawPriceShare() {
            const weeks = getWeeks();
            const latest = weeks[weeks.length-1];
            const wData = marketData.filter(d => d.week_str === latest);
            
            // Agg by Brand
            const brandMap = {};
            wData.forEach(d => {
                if(!brandMap[d.final_brand]) brandMap[d.final_brand] = {shareSum:0, priceSum:0, count:0};
                brandMap[d.final_brand].shareSum += (d.click_share || 0);
                brandMap[d.final_brand].priceSum += (d.price || 0);
                brandMap[d.final_brand].count += 1;
            });
            
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Brand');
            dataTable.addColumn('number', 'Precio Promedio');
            dataTable.addColumn('number', 'Share Total'); // Bubble size
            dataTable.addColumn({type:'string', role:'style'}); // Color

            Object.keys(brandMap).forEach(b => {
                const stats = brandMap[b];
                if(stats.shareSum < 0.5) return; // Filter noise
                const avgP = stats.count ? stats.priceSum/stats.count : 0;
                const color = b === OUR_BRAND ? COLOR_US : (TOP_COMPS.includes(b) ? COLOR_COMP_1 : COLOR_OTHER);
                dataTable.addRow([b, avgP, stats.shareSum, `color: ${color}`]);
            });

            const options = {
                title: 'Precio vs Share (Burbuja = Share Size)',
                hAxis: {title: 'Marca'},
                vAxis: {title: 'Precio Promedio (€)'},
                legend: 'none',
                series: {0: {type: 'bars'}} // Actually bar chart is better for Price, but client wanted relation. Let's do ColumnChart.
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_price_share'));
            chart.draw(dataTable, options);
        }

        // --- Interactive Tab Logic ---

        function updateInteractive() {
            const week = document.getElementById('select-week').value;
            const comp = document.getElementById('select-competitor').value;
            
            const wData = marketData.filter(d => d.week_str === week);
            const usData = wData.filter(d => d.final_brand === OUR_BRAND);
            const compData = wData.filter(d => d.final_brand === comp);

            // Table Data
            const getAvg = (arr, field) => arr.length ? arr.reduce((a,b)=>a+(b[field]||0),0)/arr.length : 0;
            const getSum = (arr, field) => arr.reduce((a,b)=>a+(b[field]||0),0);

            const data = [
                ['Métrica', OUR_BRAND, comp],
                ['Click Share Total %', getSum(usData, 'click_share'), getSum(compData, 'click_share')],
                ['Precio Promedio €', getAvg(usData, 'price'), getAvg(compData, 'price')],
                ['Rank Orgánico Avg', getAvg(usData, 'average_organic_rank'), getAvg(compData, 'average_organic_rank')],
                ['Días con Deals (Avg)', getAvg(usData, 'weekly_number_of_days_with_deal'), getAvg(compData, 'weekly_number_of_days_with_deal')]
            ];

            const tableData = google.visualization.arrayToDataTable(data);
            const table = new google.visualization.Table(document.getElementById('table_comparison'));
            table.draw(tableData, {showRowNumber: false, width: '100%', height: '100%'});

            // Price Dist Chart
            const priceData = new google.visualization.DataTable();
            priceData.addColumn('string', 'ASIN');
            priceData.addColumn('number', 'Precio');
            priceData.addColumn({type: 'string', role: 'style'});
            
            usData.forEach(d => priceData.addRow([d.asin, d.price, COLOR_US]));
            compData.forEach(d => priceData.addRow([d.asin, d.price, COLOR_COMP_1]));

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_interactive_price'));
            chart.draw(priceData, {title: 'Comparativa de Precios por Referencia', legend: 'none'});
        }

        // --- Utilities ---
        function switchTab(tabId) {
            document.getElementById('static-tab').style.display = tabId === 'static' ? 'block' : 'none';
            document.getElementById('interactive-tab').style.display = tabId === 'interactive' ? 'block' : 'none';
            
            // Update active class
            const items = document.querySelectorAll('.nav-item');
            items.forEach(i => i.classList.remove('active'));
            event.target.classList.add('active');
            
            // Redraw hidden charts fix
            if(tabId === 'interactive') updateInteractive();
        }

        window.onresize = initDashboard;

    </script>
</body>
</html>