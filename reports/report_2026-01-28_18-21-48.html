<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0066CC; /* Azul Corporativo */
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        h1 { font-size: 24px; font-weight: 700; margin: 0; }
        .subtitle { color: var(--text-muted); font-size: 14px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: white;
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .tab-btn {
            border: none;
            background: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 102, 204, 0.2);
        }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        
        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            .col-8, .col-6, .col-4 { grid-column: span 12; }
        }

        h2 { font-size: 18px; font-weight: 600; margin-top: 0; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .icon { color: var(--primary); }

        /* Metrics */
        .metric-big { font-size: 32px; font-weight: 700; color: var(--text-main); }
        .metric-delta { font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; }
        .delta-pos { color: var(--success); }
        .delta-neg { color: var(--danger); }

        /* Lists */
        ul.insights-list { padding-left: 20px; margin: 0; }
        ul.insights-list li { margin-bottom: 8px; font-size: 14px; color: var(--text-main); }
        
        .recommendation-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
        }

        /* Charts Container */
        .chart-box {
            width: 100%;
            height: 300px;
        }

        /* Interactivity */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 14px;
            outline: none;
            min-width: 150px;
        }

        /* Table */
        .google-visualization-table-table {
            font-family: 'Inter', sans-serif !important;
        }
        
        .hidden { display: none; }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .badge-y { background: #dbeafe; color: #1e40af; }
        .badge-n { background: #f3f4f6; color: #374151; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Análisis de Parent ASIN</h1>
            <div class="subtitle">Inteligencia de Mercado • Últimas 5 Semanas</div>
        </div>
        <div>
            <span class="badge badge-y" id="ourBrandBadge">Nuestra Marca: Analizando...</span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Dashboard Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: DASHBOARD ESTÁTICO -->
    <div id="tab-static">
        
        <!-- KPIs Globales -->
        <div class="grid">
            <div class="card col-4">
                <h2><span class="material-icons icon">trending_up</span> Tendencia Global (Última Semana)</h2>
                <div id="kpi-trend-text" style="font-size: 14px; margin-bottom: 10px;">Cargando análisis...</div>
                <div class="metric-big" id="kpi-share">--%</div>
                <div class="subtitle">Cuota de Clicks (Nuestra Marca)</div>
            </div>
            <div class="card col-8">
                <h2><span class="material-icons icon">bar_chart</span> Volumen vs Share (Parent Total)</h2>
                <div id="chart_global_trend" class="chart-box"></div>
            </div>
        </div>

        <!-- Competitividad -->
        <div class="grid">
            <div class="card col-8">
                <h2><span class="material-icons icon">people_outline</span> Competitividad de Marca (Click Share %)</h2>
                <div id="chart_brand_comp" class="chart-box"></div>
                <div style="font-size:12px; color:var(--text-muted); margin-top:10px;">
                    *Comparativa semanal entre Nuestra Marca y el Top 3 Competidores.
                </div>
            </div>
            <div class="card col-4">
                <h2><span class="material-icons icon">lightbulb</span> Insights de Competitividad</h2>
                <ul class="insights-list" id="comp-insights-list">
                    <li>Cargando...</li>
                </ul>
            </div>
        </div>

        <!-- Eficiencia y Palancas -->
        <div class="grid">
            <div class="card col-6">
                <h2><span class="material-icons icon">speed</span> Eficiencia: Rank Orgánico vs Click Share</h2>
                <div id="chart_efficiency" class="chart-box"></div>
                <div class="subtitle" style="text-align: center; margin-top: 5px;">
                    Eje X: Rank Orgánico (Menor es mejor) | Eje Y: Click Share
                </div>
            </div>
            <div class="card col-6">
                <h2><span class="material-icons icon">tune</span> Palancas Activas (Deals/Cupones)</h2>
                <div id="levers-analysis" style="font-size: 14px;"></div>
            </div>
        </div>

        <!-- Conclusiones -->
        <div class="grid">
            <div class="card col-6 recommendation-card">
                <h2 style="color: #0369a1;"><span class="material-icons">verified</span> Recomendaciones Accionables</h2>
                <ul class="insights-list" id="recommendations-list">
                    <li>Cargando recomendaciones...</li>
                </ul>
            </div>
            <div class="card col-6">
                <h2><span class="material-icons icon">insights</span> Otros Hallazgos</h2>
                <ul class="insights-list" id="other-insights-list">
                    <!-- Se llenará dinámicamente -->
                </ul>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 2: INTERACTIVO -->
    <div id="tab-interactive" class="hidden">
        <div class="card col-12">
            <div class="controls">
                <label>Semana:</label>
                <select id="sel-week" onchange="updateInteractive()"></select>
                
                <label>Comparar con:</label>
                <select id="sel-comp" onchange="updateInteractive()"></select>
            </div>
            
            <div id="interactive-comparison">
                <!-- Se inyectará tabla dinámica -->
                <div id="table_interactive" style="width: 100%; min-height: 400px;"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // -------------------------------------------------------------------------
    // 1. INYECCIÓN DE DATOS (PROCESADOS EN PYTHON)
    // -------------------------------------------------------------------------
    const marketData = [{"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": "NaturaleBio", "asin": "B01M0LGD6A", "product_title": "NaturaleBio Organic Virgin Coconut Oil 200 ml. Raw...", "country_code": "it", "average_organic_rank": 1.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 1.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 11.25, "impression_share": 3.25, "price": 8.99, "click_share_rank": 2, "weekly_search_volume": 7932.05, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "NaturaleBio", "estimated_clicks": 892.355625}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": "by Amazon", "asin": "B07W8PPQQM", "product_title": "by Amazon - Olio di cocco vergine biologico, 950 m...", "country_code": "it", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 19.28, "impression_share": 6.28, "price": 13.312857143, "click_share_rank": 1, "weekly_search_volume": 7932.05, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "by Amazon", "estimated_clicks": 1529.29924}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": null, "asin": "B08HK4YWGH", "product_title": "Eco nature, Olio di cocco bio, 200g", "country_code": "it", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.81, "impression_share": 3.67, "price": 4.5, "click_share_rank": 3, "weekly_search_volume": 7932.05, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "Unknown Brand", "estimated_clicks": 698.813605}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": "Plan\u00e8te au Naturel", "asin": "B0D6S1L6PL", "product_title": "Olio di Cocco Bio 150 ml - Plan\u00e8te au Naturel - Cr...", "country_code": "it", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 7.55, "impression_share": 3.66, "price": 5.9, "click_share_rank": 4, "weekly_search_volume": 7932.05, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "Plan\u00e8te au Naturel", "estimated_clicks": 598.869775}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": "NaturaleBio", "asin": "B01JA3S1F8", "product_title": "NaturaleBio Olio di Cocco Biologico Vergine 500 ml...", "country_code": "it", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 6.12, "impression_share": 3.63, "price": 13.99, "click_share_rank": 6, "weekly_search_volume": 7932.05, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "NaturaleBio", "estimated_clicks": 485.44146}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": "NaturaleBio", "asin": "B01JIB2T32", "product_title": "NaturaleBio Olio di Cocco Biologico Vergine 1000 m...", "country_code": "it", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.8, "impression_share": 3.63, "price": 19.49, "click_share_rank": 7, "weekly_search_volume": 7932.05, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "NaturaleBio", "estimated_clicks": 380.7384}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": "BENVOLIO", "asin": "B0CH11HMCS", "product_title": "BENVOLIO - Olio di Cocco Biologico Deodorato | 950...", "country_code": "it", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.23, "impression_share": 3.63, "price": 10.9, "click_share_rank": 8, "weekly_search_volume": 7932.05, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "BENVOLIO", "estimated_clicks": 335.525715}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": "CocoNativo", "asin": "B073P974FR", "product_title": "CocoNativo Biologico Extra Vergine Olio di Cocco, ...", "country_code": "it", "average_organic_rank": 8.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 6.22, "impression_share": 6.16, "price": 18.95, "click_share_rank": 5, "weekly_search_volume": 7932.05, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "CocoNativo", "estimated_clicks": 493.37351}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": null, "asin": "B0FVM32PSK", "product_title": "Pipkin Olio di Cocco 100% Biologico e Puro 1L \u2013 Na...", "country_code": "it", "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.54, "impression_share": 6.4, "price": 14.99, "click_share_rank": 9, "weekly_search_volume": 7932.05, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "Unknown Brand", "estimated_clicks": 201.47407}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "olio di cocco", "competitor_brand": "Crudolio", "asin": "B09G757HB2", "product_title": "CRUDOLIO - Olio Di Cocco Vergine Bio 200ml. | Spre...", "country_code": "it", "average_organic_rank": 11.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.34, "impression_share": 3.47, "price": 7.99, "click_share_rank": 10, "weekly_search_volume": 7932.05, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "Crudolio", "estimated_clicks": 185.60997}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": "NaturaleBio", "asin": "B01M0LGD6A", "product_title": "NaturaleBio Organic Virgin Coconut Oil 200 ml. Raw...", "country_code": "it", "average_organic_rank": 1.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 1.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 13.51, "impression_share": 3.67, "price": 8.99, "click_share_rank": 2, "weekly_search_volume": 5123.86, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "NaturaleBio", "estimated_clicks": 692.233486}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": "by Amazon", "asin": "B07W8PPQQM", "product_title": "by Amazon - Olio di cocco vergine biologico, 950 m...", "country_code": "it", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 3.0, "weekly_number_of_days_with_coupon": 1.0, "click_share": 18.98, "impression_share": 6.7, "price": 13.33, "click_share_rank": 1, "weekly_search_volume": 5123.86, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "by Amazon", "estimated_clicks": 972.508628}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": null, "asin": "B08HK4YWGH", "product_title": "Eco nature, Olio di cocco bio, 200g", "country_code": "it", "average_organic_rank": 3.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.67, "impression_share": 3.69, "price": 4.5, "click_share_rank": 3, "weekly_search_volume": 5123.86, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "Unknown Brand", "estimated_clicks": 444.238662}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": "Plan\u00e8te au Naturel", "asin": "B0D6S1L6PL", "product_title": "Olio di Cocco Bio 150 ml - Plan\u00e8te au Naturel - Cr...", "country_code": "it", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 7.29, "impression_share": 3.68, "price": 5.9, "click_share_rank": 4, "weekly_search_volume": 5123.86, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "Plan\u00e8te au Naturel", "estimated_clicks": 373.529394}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": "NaturaleBio", "asin": "B01JIB2T32", "product_title": "NaturaleBio Olio di Cocco Biologico Vergine 1000 m...", "country_code": "it", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.52, "impression_share": 3.66, "price": 19.49, "click_share_rank": 6, "weekly_search_volume": 5123.86, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "NaturaleBio", "estimated_clicks": 231.598472}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": "NaturaleBio", "asin": "B01JA3S1F8", "product_title": "NaturaleBio Olio di Cocco Biologico Vergine 500 ml...", "country_code": "it", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.11, "impression_share": 3.66, "price": 13.99, "click_share_rank": 8, "weekly_search_volume": 5123.86, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "NaturaleBio", "estimated_clicks": 210.590646}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": "BENVOLIO", "asin": "B0CH11HMCS", "product_title": "BENVOLIO - Olio di Cocco Biologico Deodorato | 950...", "country_code": "it", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.26, "impression_share": 3.66, "price": 10.9, "click_share_rank": 7, "weekly_search_volume": 5123.86, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "BENVOLIO", "estimated_clicks": 218.276436}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": "CocoNativo", "asin": "B073P974FR", "product_title": "CocoNativo Biologico Extra Vergine Olio di Cocco, ...", "country_code": "it", "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 6.62, "impression_share": 6.56, "price": 18.95, "click_share_rank": 5, "weekly_search_volume": 5123.86, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "CocoNativo", "estimated_clicks": 339.199532}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": null, "asin": "B0FVM32PSK", "product_title": "Pipkin Olio di Cocco 100% Biologico e Puro 1L \u2013 Na...", "country_code": "it", "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.87, "impression_share": 6.81, "price": 14.99, "click_share_rank": 9, "weekly_search_volume": 5123.86, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "Unknown Brand", "estimated_clicks": 147.054782}, {"brand_aggregation": "naturalebio", "parent_asin": "Coconut oil", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "olio di cocco", "competitor_brand": "Monte Nativo", "asin": "B07TMGBPL7", "product_title": "Olio di Cocco Biologico Extra Vergin Monte Nativo ...", "country_code": "it", "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.52, "impression_share": 3.72, "price": 17.95, "click_share_rank": 10, "weekly_search_volume": 5123.86, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.it/s?k=olio+di+cocco", "real_brand": "Monte Nativo", "estimated_clicks": 77.882672}];

    // -------------------------------------------------------------------------
    // 2. LÓGICA DE NEGOCIO Y VISUALIZACIÓN
    // -------------------------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    let ourBrand = "";
    
    function initDashboard() {
        // A. Identificar Nuestra Marca
        const ourAsins = marketData.filter(d => d.is_yaba_asin === 'Y');
        if (ourAsins.length > 0) {
            // Moda simple
            const brands = ourAsins.map(d => d.real_brand);
            ourBrand = brands.sort((a,b) => brands.filter(v => v===a).length - brands.filter(v => v===b).length).pop();
        } else {
            ourBrand = "Nuestra Marca (Def)";
        }
        document.getElementById('ourBrandBadge').textContent = "Marca: " + ourBrand;

        // B. Semanas
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const lastWeek = weeks[weeks.length - 1];
        
        // C. Render Charts
        drawGlobalTrend(weeks);
        drawCompetitiveness(weeks);
        drawEfficiency(lastWeek);
        generateInsights(lastWeek, weeks[weeks.length-2]);
        populateInteractiveControls(weeks);
    }

    // --- CHART 1: TENDENCIA GLOBAL ---
    function drawGlobalTrend(weeks) {
        // Agrupar por semana: Clicks Totales, Nuestra Share, Comp Share
        const dataMap = {};
        
        marketData.forEach(d => {
            if (!dataMap[d.week_date]) {
                dataMap[d.week_date] = { totalClicks: 0, ourClicks: 0 };
            }
            dataMap[d.week_date].totalClicks += d.estimated_clicks;
            if (d.real_brand === ourBrand) {
                dataMap[d.week_date].ourClicks += d.estimated_clicks;
            }
        });

        const chartData = [['Semana', 'Clicks Totales', 'Nuestro Click Share (%)']];
        weeks.forEach(w => {
            const t = dataMap[w];
            const share = t.totalClicks > 0 ? (t.ourClicks / t.totalClicks * 100) : 0;
            chartData.push([w, t.totalClicks, share]);
        });

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
            seriesType: 'bars',
            series: { 1: { type: 'line', targetAxisIndex: 1, color: '#0066CC', lineWidth: 3 } },
            colors: ['#e5e7eb'],
            vAxes: {
                0: { title: 'Volumen Estimado' },
                1: { title: 'Click Share %', format: '#\'%\'' }
            },
            legend: { position: 'bottom' },
            chartArea: { width: '80%', height: '70%' },
            fontName: 'Inter'
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // --- CHART 2: COMPETITIVIDAD ---
    function drawCompetitiveness(weeks) {
        // 1. Identificar Top 3 Competidores (por share promedio)
        const brandStats = {};
        marketData.forEach(d => {
            if (d.real_brand !== ourBrand) {
                if (!brandStats[d.real_brand]) brandStats[d.real_brand] = { clicks: 0, total: 0 };
                brandStats[d.real_brand].clicks += d.estimated_clicks;
            }
        });
        
        // Calcular total market clicks para normalizar o simplemente usar volumen absoluto
        // El prompt pide Click Share curves. Necesitamos el total de la semana.
        const weekTotals = {};
        marketData.forEach(d => {
            if (!weekTotals[d.week_date]) weekTotals[d.week_date] = 0;
            weekTotals[d.week_date] += d.estimated_clicks;
        });

        const topCompetitors = Object.keys(brandStats)
            .sort((a,b) => brandStats[b].clicks - brandStats[a].clicks)
            .slice(0, 3);

        const header = ['Semana', ourBrand, ...topCompetitors];
        const rows = weeks.map(w => {
            const row = [w];
            // Nuestra Share
            const ourClick = marketData.filter(d => d.week_date === w && d.real_brand === ourBrand)
                                       .reduce((sum, d) => sum + d.estimated_clicks, 0);
            row.push((ourClick / weekTotals[w]) * 100);
            
            // Competidores
            topCompetitors.forEach(comp => {
                const compClick = marketData.filter(d => d.week_date === w && d.real_brand === comp)
                                            .reduce((sum, d) => sum + d.estimated_clicks, 0);
                row.push((compClick / weekTotals[w]) * 100);
            });
            return row;
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#0066CC', '#ef4444', '#f59e0b', '#10b981'],
            vAxis: { title: 'Click Share %' },
            chartArea: { width: '85%', height: '70%' },
            fontName: 'Inter',
            lineWidth: 3
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
        
        // Llenar lista de insights
        const list = document.getElementById('comp-insights-list');
        list.innerHTML = `
            <li><b>Top Competidor:</b> ${topCompetitors[0]} domina junto a nosotros.</li>
            <li><b>Dinámica:</b> Observar cruces de líneas en el gráfico.</li>
            <li><b>Resto:</b> ${Object.keys(brandStats).length - 3} marcas conforman la "long tail".</li>
        `;
    }

    // --- CHART 3: EFICIENCIA (SCATTER) ---
    function drawEfficiency(lastWeek) {
        // X: Rank, Y: Share, Color: Brand Type
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        const dataArray = [['Organic Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        currentData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? '#0066CC' : '#9ca3af';
            const tooltip = `${d.real_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            dataArray.push([d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: 10; }`, tooltip]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            hAxis: { title: 'Organic Rank (Invertido)', direction: -1 }, // Rank 1 es mejor
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' },
            fontName: 'Inter'
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- INSIGHTS TEXTUALES ---
    function generateInsights(lastWeek, prevWeek) {
        const curWeekData = marketData.filter(d => d.week_date === lastWeek);
        const prevWeekData = marketData.filter(d => d.week_date === prevWeek);
        
        // Calcular Totales y Shares
        const getMetrics = (data) => {
            const total = data.reduce((s, d) => s + d.estimated_clicks, 0);
            const our = data.filter(d => d.real_brand === ourBrand).reduce((s, d) => s + d.estimated_clicks, 0);
            return { total, our, share: total ? (our/total*100) : 0 };
        };

        const cur = getMetrics(curWeekData);
        const prev = getMetrics(prevWeekData);
        const shareDiff = cur.share - prev.share;

        // KPI Display
        document.getElementById('kpi-share').innerText = cur.share.toFixed(1) + "%";
        const trendDiv = document.getElementById('kpi-trend-text');
        trendDiv.innerHTML = `
            Cambio vs Semana Anterior: 
            <span class="${shareDiff >= 0 ? 'delta-pos' : 'delta-neg'}">
                ${shareDiff > 0 ? '+' : ''}${shareDiff.toFixed(1)} pts
            </span>
        `;

        // Recomendaciones
        const recList = document.getElementById('recommendations-list');
        let recs = "";
        
        if (shareDiff < 0) {
            recs += `<li><b>Acción Inmediata:</b> Revisar precios. Nuestra cuota cayó ${Math.abs(shareDiff).toFixed(1)} puntos.</li>`;
        } else {
            recs += `<li><b>Consolidación:</b> Tendencia positiva. Evaluar si podemos subir precio ligeramente sin perder rank.</li>`;
        }
        
        // Análisis de Deals
        const dealsActive = curWeekData.some(d => d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_deal > 0);
        if (!dealsActive) {
            recs += `<li><b>Oportunidad:</b> Sin Deals activos en la última semana. Planificar Lightning Deal para fin de mes.</li>`;
        }

        // Palabras Clave
        recs += `<li><b>SEO:</b> Monitorear ASINs con Rank > 5 y optimizar backend keywords.</li>`;
        recList.innerHTML = recs;

        // Other Insights
        const otherList = document.getElementById('other-insights-list');
        otherList.innerHTML = `
            <li>El volumen de búsqueda total es de aprox. ${Math.round(cur.total)} clicks estimados en la semana.</li>
            <li>Detectados ${curWeekData.filter(d => d.is_yaba_asin === 'N').length} ASINs competidores activos.</li>
        `;
        
        // Palancas Texto
        const dealsComp = curWeekData.filter(d => d.is_yaba_asin === 'N' && d.weekly_number_of_days_with_coupon > 0).length;
        document.getElementById('levers-analysis').innerText = 
            `En la última semana, ${dealsComp} competidores usaron Cupones. ` + 
            (dealsActive ? "Nosotros tuvimos actividad promocional." : "Nosotros NO tuvimos actividad promocional.");
    }

    // --- INTERACTIVIDAD ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
        
        if (tab === 'static') {
            document.getElementById('tab-static').classList.remove('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
        } else {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.remove('hidden');
            updateInteractive(); // Redraw
        }
    }

    function populateInteractiveControls(weeks) {
        const selWeek = document.getElementById('sel-week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            selWeek.add(opt);
        });
        selWeek.value = weeks[weeks.length-1]; // Select last

        const selComp = document.getElementById('sel-comp');
        // Get unique competitors
        const comps = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.real_brand))];
        comps.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            selComp.add(opt);
        });
    }

    function updateInteractive() {
        const week = document.getElementById('sel-week').value;
        const compBrand = document.getElementById('sel-comp').value;
        
        // Filter Data
        const ourData = marketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
        const compData = marketData.filter(d => d.week_date === week && d.real_brand === compBrand);
        
        // Combine for Table
        const rows = [];
        // Helper to format
        const fmt = (arr, brand) => {
            arr.forEach(item => {
                rows.push([
                    brand,
                    item.asin,
                    item.product_title.substring(0, 30) + "...",
                    {v: item.price, f: '€'+item.price.toFixed(2)},
                    item.click_share + '%',
                    item.average_organic_rank,
                    item.weekly_number_of_days_with_coupon > 0 ? 'Sí' : 'No'
                ]);
            });
        };
        
        fmt(ourData, ourBrand);
        fmt(compData, compBrand);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Marca');
        data.addColumn('string', 'ASIN');
        data.addColumn('string', 'Título');
        data.addColumn('number', 'Precio');
        data.addColumn('string', 'Share');
        data.addColumn('number', 'Rank Org');
        data.addColumn('string', 'Cupón?');
        
        data.addRows(rows);

        const table = new google.visualization.Table(document.getElementById('table_interactive'));
        table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
    }

</script>

</body>
</html>