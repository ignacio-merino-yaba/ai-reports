<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Análisis Parent ASIN</title>
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --danger: #EA4335;
            --warning: #FBBC05;
            --bg: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-sub: #5F6368;
            --border: #DADCE0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout & Containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 400;
            margin: 0 0 8px 0;
        }

        .header p {
            color: var(--text-sub);
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-item {
            background: #F1F3F4;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-val {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-sub);
            text-transform: uppercase;
        }

        /* Charts Containers */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Text Sections */
        .insights-section h3 {
            font-size: 16px;
            color: var(--text-main);
            margin-top: 0;
        }

        .insight-list {
            list-style: none;
            padding: 0;
        }

        .insight-list li {
            position: relative;
            padding-left: 24px;
            margin-bottom: 12px;
            color: var(--text-sub);
        }

        .insight-list li::before {
            content: '•';
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
            font-size: 18px;
            line-height: 1.2;
        }

        /* Recommendations */
        .rec-card {
            border-left: 4px solid var(--secondary);
            background: #E6F4EA;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border);
            font-family: inherit;
            background: white;
        }

        /* Utilities */
        .hidden { display: none; }
        .text-up { color: var(--secondary); font-weight: bold; }
        .text-down { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Análisis de Parent ASIN y Competitividad</h1>
        <p>Inteligencia de Mercado | Generado automáticamente</p>
    </div>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Dashboard Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: REPORT ESTÁTICO -->
    <div id="tab-static">
        
        <!-- Section 1: Tendencia Global -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent
            </div>
            <div class="metrics-grid" id="global-metrics">
                <!-- Injected via JS -->
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="insights-section" style="margin-top: 16px;">
                <p id="trend-commentary" style="font-style: italic; color: var(--text-sub);"></p>
            </div>
        </div>

        <!-- Section 2: Competitividad de Marca -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Share of Voice)
            </div>
            <div id="chart_competitiveness" class="chart-container"></div>
            <div class="insights-section">
                <h3>Dinámica Competitiva</h3>
                <ul class="insight-list" id="comp-insights"></ul>
            </div>
        </div>

        <!-- Section 3 & 4: Palancas & Eficiencia -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">speed</span>
                3. Palancas y Eficiencia (Rank vs Click Share)
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 24px;">
                <div style="flex: 2; min-width: 300px;">
                    <div id="chart_efficiency" class="chart-container"></div>
                </div>
                <div style="flex: 1; min-width: 250px;">
                    <h3>Análisis de Palancas</h3>
                    <ul class="insight-list" id="levers-insights">
                        <!-- Filled by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 5: Conclusiones -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones y Recomendaciones
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h3>Insights Clave</h3>
                    <ul class="insight-list" id="key-insights"></ul>
                </div>
                <div id="recommendations-container">
                    <h3>Acciones Recomendadas</h3>
                </div>
            </div>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVO -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-title">Cara a Cara: Nosotros vs Competencia</div>
            <div class="controls">
                <select id="week-selector" onchange="updateInteractive()">
                    <!-- Options populated by JS -->
                </select>
                <select id="comp-selector" onchange="updateInteractive()">
                    <!-- Options populated by JS -->
                </select>
            </div>
            
            <div id="table_interactive" style="width: 100%;"></div>
        </div>
    </div>

</div>

<!-- DATA AND LOGIC -->
<script>
    // 1. DATA INJECTION (Processed from Python)
    const marketData = [{"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B08HK4YWGH", "clean_brand": "Unknown Brand", "is_yaba_asin": "N", "click_share": 8.81, "estimated_clicks": 698.8136050000001, "average_organic_rank": 4, "price": 4.5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "Eco nature, Olio di cocco bio, 200g", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B0FVM32PSK", "clean_brand": "Unknown Brand", "is_yaba_asin": "N", "click_share": 2.54, "estimated_clicks": 201.47407, "average_organic_rank": 9, "price": 14.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "Pipkin Olio di Cocco 100% Biologico e Puro 1L \u2013 Na...", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B0CH11HMCS", "clean_brand": "BENVOLIO", "is_yaba_asin": "N", "click_share": 4.23, "estimated_clicks": 335.525715, "average_organic_rank": 7, "price": 10.9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "BENVOLIO - Olio di Cocco Biologico Deodorato | 950...", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B073P974FR", "clean_brand": "CocoNativo", "is_yaba_asin": "N", "click_share": 6.22, "estimated_clicks": 493.37351000000004, "average_organic_rank": 8, "price": 18.95, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "CocoNativo Biologico Extra Vergine Olio di Cocco, ...", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B09G757HB2", "clean_brand": "Crudolio", "is_yaba_asin": "N", "click_share": 2.34, "estimated_clicks": 185.61, "average_organic_rank": 11, "price": 7.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "CRUDOLIO - Olio Di Cocco Vergine Bio 200ml. | Spre...", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B01JIB2T32", "clean_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 4.8, "estimated_clicks": 380.7384, "average_organic_rank": 6, "price": 19.49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "NaturaleBio Olio di Cocco Biologico Vergine 1000 m...", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B01JA3S1F8", "clean_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 6.12, "estimated_clicks": 485.44146000000006, "average_organic_rank": 5, "price": 13.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "NaturaleBio Olio di Cocco Biologico Vergine 500 ml...", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B01M0LGD6A", "clean_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 11.25, "estimated_clicks": 892.355625, "average_organic_rank": 1, "price": 8.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 1, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "NaturaleBio Organic Virgin Coconut Oil 200 ml. Raw...", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B0D6S1L6PL", "clean_brand": "Plan\u00e8te", "is_yaba_asin": "N", "click_share": 7.55, "estimated_clicks": 598.869775, "average_organic_rank": 4, "price": 5.9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "Olio di Cocco Bio 150 ml - Plan\u00e8te au Naturel - Cr...", "weekly_search_volume": 7932.05}, {"week_date": "2025-12-27", "parent_asin": "Coconut oil", "asin": "B07W8PPQQM", "clean_brand": "by", "is_yaba_asin": "N", "click_share": 19.28, "estimated_clicks": 1529.2992399999999, "average_organic_rank": 2, "price": 13.312857143, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "by Amazon - Olio di cocco vergine biologico, 950 m...", "weekly_search_volume": 7932.05}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B08HK4YWGH", "clean_brand": "Unknown Brand", "is_yaba_asin": "N", "click_share": 8.67, "estimated_clicks": 444.23866200000003, "average_organic_rank": 3, "price": 4.5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "Eco nature, Olio di cocco bio, 200g", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B0FVM32PSK", "clean_brand": "Unknown Brand", "is_yaba_asin": "N", "click_share": 2.87, "estimated_clicks": 147.05478200000001, "average_organic_rank": 9, "price": 14.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "Pipkin Olio di Cocco 100% Biologico e Puro 1L \u2013 Na...", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B0CH11HMCS", "clean_brand": "BENVOLIO", "is_yaba_asin": "N", "click_share": 4.26, "estimated_clicks": 218.276436, "average_organic_rank": 7, "price": 10.9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "BENVOLIO - Olio di Cocco Biologico Deodorato | 950...", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B073P974FR", "clean_brand": "CocoNativo", "is_yaba_asin": "N", "click_share": 6.62, "estimated_clicks": 339.199532, "average_organic_rank": 9, "price": 18.95, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "CocoNativo Biologico Extra Vergine Olio di Cocco, ...", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B07TMGBPL7", "clean_brand": "Monte", "is_yaba_asin": "N", "click_share": 1.52, "estimated_clicks": 77.882672, "average_organic_rank": 14, "price": 17.95, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "Olio di Cocco Biologico Extra Vergin Monte Nativo ...", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B01JIB2T32", "clean_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 4.52, "estimated_clicks": 231.598472, "average_organic_rank": 6, "price": 19.49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "NaturaleBio Olio di Cocco Biologico Vergine 1000 m...", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B01JA3S1F8", "clean_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 4.11, "estimated_clicks": 210.590646, "average_organic_rank": 6, "price": 13.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "NaturaleBio Olio di Cocco Biologico Vergine 500 ml...", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B01M0LGD6A", "clean_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 13.51, "estimated_clicks": 692.233486, "average_organic_rank": 1, "price": 8.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 1, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "NaturaleBio Organic Virgin Coconut Oil 200 ml. Raw...", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B0D6S1L6PL", "clean_brand": "Plan\u00e8te", "is_yaba_asin": "N", "click_share": 7.29, "estimated_clicks": 373.529394, "average_organic_rank": 4, "price": 5.9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "Olio di Cocco Bio 150 ml - Plan\u00e8te au Naturel - Cr...", "weekly_search_volume": 5123.86}, {"week_date": "2026-01-03", "parent_asin": "Coconut oil", "asin": "B07W8PPQQM", "clean_brand": "by", "is_yaba_asin": "N", "click_share": 18.98, "estimated_clicks": 972.508628, "average_organic_rank": 2, "price": 13.33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 3, "weekly_number_of_days_with_best_seller_badge": 1, "weekly_number_of_days_with_amazon_choice_badge": 0, "product_title": "by Amazon - Olio di cocco vergine biologico, 950 m...", "weekly_search_volume": 5123.86}];

    // 2. CONFIGURATION
    const MY_BRAND = marketData.find(d => d.is_yaba_asin === 'Y')?.clean_brand || "NaturaleBio";
    
    // Initialize Google Charts
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    // 3. LOGIC FUNCTIONS
    function initDashboard() {
        processData();
        drawTrendChart();
        drawCompetitorChart();
        drawEfficiencyChart();
        generateTextInsights();
        populateInteractiveControls();
    }

    let weeks = [];
    let processedTrend = [];
    let brandShares = {};

    function processData() {
        // Unique weeks sorted
        weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        // --- Trend Data ---
        // Aggregate Clicks by Week and Owner (My ASIN vs Competitor)
        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const myClicks = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((s, c) => s + c.estimated_clicks, 0);
            const compClicks = weekData.filter(d => d.is_yaba_asin === 'N').reduce((s, c) => s + c.estimated_clicks, 0);
            const totalClicks = myClicks + compClicks;
            
            processedTrend.push({
                week,
                myClicks: Math.round(myClicks),
                compClicks: Math.round(compClicks),
                myShare: totalClicks > 0 ? (myClicks / totalClicks) * 100 : 0
            });
        });

        // --- Brand Competitiveness ---
        const allBrands = [...new Set(marketData.map(d => d.clean_brand))];
        // Calculate Total Clicks per brand per week to get real Share of Voice (SOV)
        
        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalWeekClicks = weekData.reduce((s, c) => s + c.estimated_clicks, 0);
            
            allBrands.forEach(brand => {
                if (!brandShares[brand]) brandShares[brand] = [];
                const brandClicks = weekData.filter(d => d.clean_brand === brand).reduce((s, c) => s + c.estimated_clicks, 0);
                brandShares[brand].push({
                    week,
                    share: totalWeekClicks > 0 ? (brandClicks / totalWeekClicks) * 100 : 0
                });
            });
        });
    }

    // --- CHART 1: TREND ---
    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Clicks Nuestros');
        data.addColumn('number', 'Clicks Competencia');
        data.addColumn('number', 'Nuestra Cuota (%)');

        processedTrend.forEach(d => {
            data.addRow([d.week, d.myClicks, d.compClicks, d.myShare]);
        });

        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3} },
            colors: ['#8AB4F8', '#DADCE0'],
            isStacked: true,
            vAxes: {
                0: {title: 'Volumen de Clicks'},
                1: {title: 'Cuota de Clicks (%)', format: '#\'%\''}
            },
            legend: { position: 'bottom' },
            chartArea: {width: '85%', height: '70%'},
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    // --- CHART 2: COMPETITIVENESS ---
    function drawCompetitorChart() {
        // Identify Top 3 Competitors (excluding My Brand) by avg share
        const compBrands = Object.keys(brandShares).filter(b => b !== MY_BRAND);
        const avgShares = compBrands.map(b => {
            const sum = brandShares[b].reduce((acc, curr) => acc + curr.share, 0);
            return { brand: b, avg: sum / weeks.length };
        }).sort((a, b) => b.avg - a.avg);

        const top3 = avgShares.slice(0, 3).map(x => x.brand);
        
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', MY_BRAND);
        top3.forEach(b => data.addColumn('number', b));
        data.addColumn('number', 'Resto');

        weeks.forEach((week, i) => {
            const row = [week];
            // My Brand
            row.push(brandShares[MY_BRAND][i].share);
            // Top 3
            let top3Sum = 0;
            top3.forEach(b => {
                const val = brandShares[b][i].share;
                row.push(val);
                top3Sum += val;
            });
            // Rest
            const myVal = brandShares[MY_BRAND][i].share;
            row.push(100 - myVal - top3Sum); // Simplified approximation or calculate exact
            
            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            vAxis: {title: 'Click Share (%)'},
            legend: { position: 'bottom' },
            chartArea: {width: '90%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    // --- CHART 3: EFFICIENCY (Scatter) ---
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({'type': 'string', 'role': 'style'}); // Color
        data.addColumn({'type': 'string', 'role': 'tooltip'}); // Custom text

        const latestWeek = weeks[weeks.length - 1];
        const currentData = marketData.filter(d => d.week_date === latestWeek);

        currentData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? 'point {fill-color: #4285F4; size: 10}' : 'point {fill-color: #9AA0A6}';
            const tooltip = `${d.product_title}\nPrecio: €${d.price}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            data.addRow([d.average_organic_rank, d.click_share, color, tooltip]);
        });

        const options = {
            hAxis: {title: 'Posición Orgánica (Rank)', direction: -1}, // Invert ranks (1 is best)
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
            chartArea: {width: '85%', height: '80%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- INSIGHTS GENERATION ---
    function generateTextInsights() {
        const latest = processedTrend[processedTrend.length - 1];
        const prev = processedTrend[processedTrend.length - 2] || latest;
        
        // 1. Global Metrics
        const htmlMetrics = `
            <div class="metric-item">
                <div class="metric-val">${latest.myShare.toFixed(1)}%</div>
                <div class="metric-label">Nuestra Cuota</div>
            </div>
            <div class="metric-item">
                <div class="metric-val">${latest.myClicks}</div>
                <div class="metric-label">Nuestros Clicks</div>
            </div>
            <div class="metric-item">
                <div class="metric-val">${(latest.myClicks + latest.compClicks)}</div>
                <div class="metric-label">Mercado Total</div>
            </div>
        `;
        document.getElementById('global-metrics').innerHTML = htmlMetrics;

        // 2. Trend Commentary
        const trendDiff = latest.myShare - prev.myShare;
        const textTrend = trendDiff >= 0 
            ? `Nuestra marca gana tracción con un aumento del ${trendDiff.toFixed(1)}% en cuota respecto a la semana anterior.`
            : `Ligera pérdida de visibilidad (${trendDiff.toFixed(1)}%) en la última semana.`;
        document.getElementById('trend-commentary').textContent = textTrend;

        // 3. Competitive & Levers Insights
        const latestWeekData = marketData.filter(d => d.week_date === weeks[weeks.length - 1]);
        const myData = latestWeekData.filter(d => d.is_yaba_asin === 'Y');
        const bestComp = latestWeekData.filter(d => d.is_yaba_asin === 'N').sort((a,b) => b.click_share - a.click_share)[0];

        // Competitor Insight
        const compList = document.getElementById('comp-insights');
        compList.innerHTML += `<li>Líder de mercado: <strong>${bestComp.clean_brand}</strong> con ${bestComp.click_share}% share.</li>`;
        if (bestComp.price < myData[0]?.price) {
            compList.innerHTML += `<li>Competencia gana por precio: El líder es más barato (€${bestComp.price}).</li>`;
        }

        // Levers Insight
        const leversList = document.getElementById('levers-insights');
        const myBestSeller = myData.find(d => d.weekly_number_of_days_with_best_seller_badge > 0);
        if (myBestSeller) {
            leversList.innerHTML += `<li><strong>Badge Best Seller:</strong> Activo en ${myBestSeller.asin}, impulsando rank #${myBestSeller.average_organic_rank}.</li>`;
        } else {
            leversList.innerHTML += `<li><strong>Oportunidad:</strong> Ningún ASIN propio tiene badge de Best Seller esta semana.</li>`;
        }

        // Recommendations
        const recContainer = document.getElementById('recommendations-container');
        let recs = "";
        
        if (latest.myShare < 25) {
            recs += `<div class="rec-card"><strong>Defensiva:</strong> La cuota es baja. Considerar cupón agresivo para recuperar tráfico.</div>`;
        }
        if (bestComp.price < myData[0]?.price) {
             recs += `<div class="rec-card"><strong>Precio:</strong> Revisar elasticidad. Competidor líder está a €${bestComp.price}.</div>`;
        }
        recs += `<div class="rec-card"><strong>Eficiencia:</strong> Optimizar keywords en ASINs con rank < 10 pero share < 5%.</div>`;
        
        recContainer.innerHTML += recs;
        
        // Key Insights
        const keyList = document.getElementById('key-insights');
        keyList.innerHTML += `<li>Tendencia: ${trendDiff >= 0 ? 'Positiva' : 'Negativa'} en la última semana.</li>`;
        keyList.innerHTML += `<li>Volumen: El mercado total mueve aprox ${latest.myClicks + latest.compClicks} clicks/semana.</li>`;
        keyList.innerHTML += `<li>Ranking: Nuestro mejor rank orgánico es #${Math.min(...myData.map(d=>d.average_organic_rank))}.</li>`;
    }

    // --- INTERACTIVE TAB LOGIC ---
    function switchTab(tabId) {
        document.getElementById('tab-static').className = tabId === 'static' ? '' : 'hidden';
        document.getElementById('tab-interactive').className = tabId === 'interactive' ? '' : 'hidden';
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function populateInteractiveControls() {
        const weekSel = document.getElementById('week-selector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        weekSel.value = weeks[weeks.length - 1]; // Select latest

        const compSel = document.getElementById('comp-selector');
        const brands = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.clean_brand))];
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            compSel.add(opt);
        });

        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('week-selector').value;
        const compBrand = document.getElementById('comp-selector').value;
        
        const myData = marketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
        const compData = marketData.filter(d => d.week_date === week && d.clean_brand === compBrand);
        
        // Draw Table Chart
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'ASIN');
        data.addColumn('string', 'Título');
        data.addColumn('number', 'Precio (€)');
        data.addColumn('number', 'Rank');
        data.addColumn('number', 'Share (%)');
        data.addColumn('string', 'Tipo'); // Hidden logic col if needed

        // Add rows
        myData.forEach(d => data.addRow([d.asin, d.product_title.substring(0,30)+'...', d.price, d.average_organic_rank, d.click_share, 'Nosotros']));
        compData.forEach(d => data.addRow([d.asin, d.product_title.substring(0,30)+'...', d.price, d.average_organic_rank, d.click_share, 'Competidor']));

        const table = new google.visualization.Table(document.getElementById('table_interactive'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
    }

</script>

</body>
</html>