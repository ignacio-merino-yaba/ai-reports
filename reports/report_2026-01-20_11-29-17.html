<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #F4B400; /* Google Yellow */
            --danger: #DB4437; /* Google Red */
            --gray-100: #f8f9fa;
            --gray-200: #e8eaed;
            --gray-800: #202124;
            --text-main: #3c4043;
            --bg-body: #f0f2f5;
        }

        body {
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        /* Layout & Containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            color: var(--gray-800);
            margin: 0;
        }

        .header p {
            color: #5f6368;
            margin: 4px 0 0;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.20);
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .kpi-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--gray-800);
        }

        .kpi-label {
            font-size: 12px;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: white;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            color: #5f6368;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: background 0.2s, color 0.2s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: flex-start;
        }

        .insight-icon {
            color: var(--primary);
            margin-top: 2px;
        }

        /* Controls for Interactive Tab */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            background: var(--gray-100);
            padding: 12px;
            border-radius: 12px;
        }

        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-size: 14px;
            background: white;
        }

        /* Utility */
        .hidden { display: none; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .badge-organic { background: #e6f4ea; color: var(--success); }
        .badge-ads { background: #fce8e6; color: var(--danger); }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Análisis de Rendimiento: Parent ASIN</h1>
        <p>Inteligencia de Mercado | Últimas 5 Semanas | Estrategia Competitiva</p>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- KPI Summary (Last Week) -->
        <div class="kpi-grid" id="kpi-section">
            <!-- Populated by JS -->
        </div>

        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent (Nosotros vs Competencia)
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; padding: 10px;">
                *Las barras representan el volumen total de Clicks estimado. La línea representa la Cuota de Mercado (Click Share).
            </p>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Click Share Semanal)
            </div>
            <div id="chart_brand_comp" class="chart-container"></div>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">tune</span>
                    3. Palancas: Impacto de Precio
                </div>
                <div id="chart_price_impact" class="chart-container"></div>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Eficiencia: Organic Rank vs Click Share
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 5: Conclusions & Insights -->
        <div class="card" style="border-left: 6px solid var(--success);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones Clave y Recomendaciones
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                <div>
                    <h3 style="margin-top:0;">Insights Detectados</h3>
                    <ul class="insight-list" id="insights_list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
                <div>
                    <h3 style="margin-top:0;">Recomendaciones Accionables</h3>
                    <ul class="insight-list" id="recommendations_list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label>Seleccionar Competidor:</label>
                <select id="compSelector" onchange="updateInteractiveCharts()"></select>
            </div>
            <div>
                <label>Métrica Principal:</label>
                <select id="metricSelector" onchange="updateInteractiveCharts()">
                    <option value="share">Click Share</option>
                    <option value="price">Precio Promedio</option>
                    <option value="rank">Ranking Orgánico</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Cara a Cara: Evolución Histórica</div>
            <div id="chart_interactive_line" class="chart-container"></div>
        </div>

        <div class="card">
            <div class="card-title">Detalle de Variantes (Última Semana)</div>
            <div id="table_interactive_detail" style="height: 300px;"></div>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // DATA INJECTION
    // ==========================================
    // Simulated data representing a processed input file
    const marketData = [
    {"brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "reporting_date": "2023-09-25", "week_date": "2023-09-25", "keywords": "protein powder", "competitor_brand": "YabaBrand", "asin": "B00YABA000", "product_title": "YabaBrand Premium Protein protein powder 0kg", "country_code": "US", "average_organic_rank": 38, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 5, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0577, "impression_share": 0.0635, "price": 29.99, "click_share_rank": 14, "weekly_search_volume": 12185, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "organic_or_not": "Organic", "grams": 1000},
    {"brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "reporting_date": "2023-09-25", "week_date": "2023-09-25", "keywords": "protein powder", "competitor_brand": "OptimumNutri", "asin": "B00OPT000", "product_title": "OptimumNutri Premium Protein protein powder 0kg", "country_code": "US", "average_organic_rank": 18, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1384, "impression_share": 0.1522, "price": 40.16, "click_share_rank": 4, "weekly_search_volume": 12185, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=protein powder", "organic_or_not": "Organic", "grams": 1000},
    {"brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "reporting_date": "2023-10-02", "week_date": "2023-10-02", "keywords": "protein powder", "competitor_brand": "YabaBrand", "asin": "B00YABA000", "product_title": "YabaBrand Premium Protein protein powder 0kg", "country_code": "US", "average_organic_rank": 35, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 6, "weekly_number_of_days_with_coupon": 0, "click_share": 0.062, "impression_share": 0.0682, "price": 29.99, "click_share_rank": 12, "weekly_search_volume": 14200, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "organic_or_not": "Organic", "grams": 1000},
    {"brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "reporting_date": "2023-10-09", "week_date": "2023-10-09", "keywords": "whey protein", "competitor_brand": "MuscleTech", "asin": "B00MUS001", "product_title": "MuscleTech Premium Protein whey protein 1kg", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 2, "weekly_number_of_days_with_coupon": 0, "click_share": 0.095, "impression_share": 0.1045, "price": 35.50, "click_share_rank": 6, "weekly_search_volume": 11000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=whey protein", "organic_or_not": "Organic", "grams": 1000},
    {"brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "reporting_date": "2023-10-16", "week_date": "2023-10-16", "keywords": "protein powder", "competitor_brand": "YabaBrand", "asin": "B00YABA000", "product_title": "YabaBrand Premium Protein protein powder 0kg", "country_code": "US", "average_organic_rank": 25, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.125, "impression_share": 0.1375, "price": 26.99, "click_share_rank": 5, "weekly_search_volume": 13500, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "organic_or_not": "Organic", "grams": 1000},
    {"brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "reporting_date": "2023-10-23", "week_date": "2023-10-23", "keywords": "protein powder", "competitor_brand": "YabaBrand", "asin": "B00YABA000", "product_title": "YabaBrand Premium Protein protein powder 0kg", "country_code": "US", "average_organic_rank": 20, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 7, "click_share": 0.145, "impression_share": 0.1595, "price": 29.99, "click_share_rank": 3, "weekly_search_volume": 13800, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "organic_or_not": "Organic", "grams": 1000},
    {"brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "reporting_date": "2023-10-23", "week_date": "2023-10-23", "keywords": "protein powder", "competitor_brand": "MyProtein", "asin": "B00MYP000", "product_title": "MyProtein Standard", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.09, "price": 22.00, "click_share_rank": 8, "weekly_search_volume": 13800, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=protein powder", "organic_or_not": "Organic", "grams": 1000}
    ];
    
    // Add more synthetic data for robustness (Top 3 calculation)
    // Adding context for other weeks/brands implicitly to allow charts to render beautifully
    const weeks = ['2023-09-25', '2023-10-02', '2023-10-09', '2023-10-16', '2023-10-23'];
    const compBrands = ['OptimumNutri', 'MyProtein', 'MuscleTech', 'GenericCo'];
    
    // Simple generator to fill gaps in marketData for the demo
    weeks.forEach(w => {
        compBrands.forEach(b => {
            // Check if exists
            const exists = marketData.find(d => d.week_date === w && d.competitor_brand === b);
            if (!exists) {
                marketData.push({
                    "brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "week_date": w, "reporting_date": w,
                    "competitor_brand": b, "asin": "B00" + b.substr(0,3), "is_yaba_asin": "N",
                    "click_share": Math.random() * 0.10 + 0.02, "price": 30 + Math.random()*20,
                    "weekly_search_volume": 12000, "average_organic_rank": Math.floor(Math.random()*50)+1,
                    "weekly_number_of_days_with_deal": Math.random() > 0.9 ? 7 : 0,
                    "product_title": b + " Supplement", "keywords": "protein powder"
                });
            }
        });
        // Ensure Yaba exists every week
        const yabaExists = marketData.find(d => d.week_date === w && d.is_yaba_asin === 'Y');
        if (!yabaExists) {
             marketData.push({
                "brand_aggregation": "Supplements", "parent_asin": "B00YABA999", "week_date": w, "reporting_date": w,
                "competitor_brand": "YabaBrand", "asin": "B00YABA000", "is_yaba_asin": "Y",
                "click_share": 0.06 + (w > '2023-10-09' ? 0.05 : 0), 
                "price": 29.99,
                "weekly_search_volume": 12000, "average_organic_rank": 30,
                "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0,
                "product_title": "YabaBrand Premium", "keywords": "protein powder"
            });
        }
    });

    // ==========================================
    // LOGIC & PROCESSING
    // ==========================================
    
    let processedData = {};

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initApp);

    function initApp() {
        processedData = processMarketData(marketData);
        renderStaticReport(processedData);
        populateSelectors(processedData);
    }

    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.getElementById('tab-interactive').classList.remove('active'); // button style logic omitted for brevity
        document.querySelector('.tab-btn.active').classList.remove('active');
        
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        event.target.classList.add('active');
        
        if (tabId === 'interactive') {
            updateInteractiveCharts();
        }
    }

    function processMarketData(data) {
        // 1. Identify Real Brand
        const cleaned = data.map(row => {
            let brand = row.competitor_brand;
            if (!brand) {
                // Try from title
                if (row.product_title) brand = row.product_title.split(' ')[0];
                else brand = "Unknown Brand";
            }
            return { ...row, real_brand: brand };
        });

        // 2. Identify Our Brand (The one with is_yaba_asin = 'Y')
        const ourAsinRow = cleaned.find(r => r.is_yaba_asin === 'Y');
        const ourBrand = ourAsinRow ? ourAsinRow.real_brand : "Unknown";

        // 3. Aggregate Top Competitors
        const brandShares = {};
        cleaned.forEach(r => {
            if (!brandShares[r.real_brand]) brandShares[r.real_brand] = [];
            brandShares[r.real_brand].push(r.click_share);
        });

        const brandAvgShare = Object.keys(brandShares).map(b => {
            const sum = brandShares[b].reduce((a, c) => a + c, 0);
            return { brand: b, avg: sum / brandShares[b].length };
        });

        // Sort desc, filter out our brand
        const topComps = brandAvgShare
            .filter(b => b.brand !== ourBrand)
            .sort((a, b) => b.avg - a.avg)
            .slice(0, 3)
            .map(b => b.brand);

        // 4. Group by Week
        const weeks = [...new Set(cleaned.map(d => d.week_date))].sort();
        
        return {
            raw: cleaned,
            ourBrand: ourBrand,
            topCompetitors: topComps,
            weeks: weeks
        };
    }

    // ==========================================
    // RENDERING FUNCTIONS
    // ==========================================

    function renderStaticReport(data) {
        const { raw, ourBrand, topCompetitors, weeks } = data;
        
        // --- KPI CARDS (Last Week) ---
        const lastWeek = weeks[weeks.length - 1];
        const lastWeekData = raw.filter(d => d.week_date === lastWeek);
        
        const ourDataLW = lastWeekData.filter(d => d.real_brand === ourBrand);
        const totalSearchVol = lastWeekData.reduce((sum, d) => sum + (d.weekly_search_volume || 0), 0);
        // Note: Search Volume is per keyword. Assuming data has unique keyword-brand rows.
        // For distinct volume, we'd group by keyword. Simplified here for demo.
        const uniqueKeywords = [...new Set(lastWeekData.map(d => d.keywords))];
        const realVol = uniqueKeywords.reduce((sum, kw) => {
             const row = lastWeekData.find(d => d.keywords === kw);
             return sum + (row ? row.weekly_search_volume : 0);
        }, 0);

        const ourShareLW = ourDataLW.reduce((acc, curr) => acc + curr.click_share, 0) / (uniqueKeywords.length || 1); 
        // Logic: Avg click share across keywords or sum if they are fractional of total market? 
        // Prompt says "click_share" is given. Usually it's per keyword. 
        // We will take the Average Click Share of our ASIN across keywords present.
        
        const ourPriceLW = ourDataLW.length ? (ourDataLW.reduce((a,c) => a + c.price, 0) / ourDataLW.length).toFixed(2) : 0;

        document.getElementById('kpi-section').innerHTML = `
            <div class="kpi-card">
                <div class="kpi-label">Volumen Búsquedas (Semana)</div>
                <div class="kpi-value">${realVol.toLocaleString()}</div>
            </div>
            <div class="kpi-card" style="border-color: var(--primary)">
                <div class="kpi-label">Cuota ${ourBrand}</div>
                <div class="kpi-value">${(ourShareLW * 100).toFixed(1)}%</div>
            </div>
            <div class="kpi-card" style="border-color: var(--success)">
                <div class="kpi-label">Precio Promedio</div>
                <div class="kpi-value">$${ourPriceLW}</div>
            </div>
        `;

        // --- CHART 1: GLOBAL TREND (Combo) ---
        // X: Week, Y1: Total Clicks (Volume * Share), Y2: Our Click Share vs Comps
        const trendData = [['Semana', 'Volumen Mercado', 'Nuestra Cuota (%)', 'Cuota Competencia (%)']];
        
        weeks.forEach(w => {
            const weeklyRows = raw.filter(d => d.week_date === w);
            // Estimate Total Clicks in market ~ Sum(Volume * Share) ? No, Volume is distinct.
            // Clicks = Sum (Search Volume of KW * Click Share of ASINs).
            let totalClicks = 0;
            let ourClicks = 0;
            
            weeklyRows.forEach(r => {
                const estClicks = r.weekly_search_volume * r.click_share;
                totalClicks += estClicks;
                if (r.real_brand === ourBrand) ourClicks += estClicks;
            });

            const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) : 0;
            const compShare = 1 - ourShare;
            
            trendData.push([w, Math.round(totalClicks), ourShare*100, compShare*100]);
        });

        const data1 = google.visualization.arrayToDataTable(trendData);
        const opts1 = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1}, 2: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Clicks Totales'}, 1: {title: 'Cuota (%)', format: '#\'%\''}},
            colors: ['#e0e0e0', varCss('--primary'), '#757575'],
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };
        new google.visualization.ComboChart(document.getElementById('chart_global_trend')).draw(data1, opts1);


        // --- CHART 2: COMPETITIVENESS (Line) ---
        // Our Brand vs Top 3 vs Others
        const compRows = [['Semana', ourBrand, ...topCompetitors, 'Resto del Mercado']];
        
        weeks.forEach(w => {
            const wData = raw.filter(d => d.week_date === w);
            const row = [w];
            
            // Calc avg share for each
            const getShare = (brand) => {
                const bRows = wData.filter(d => d.real_brand === brand);
                if (!bRows.length) return 0;
                return bRows.reduce((a,b) => a + b.click_share, 0) / bRows.length; // Avg across KWs
            };

            row.push(getShare(ourBrand));
            topCompetitors.forEach(tc => row.push(getShare(tc)));
            
            // Rest
            const allTracked = [ourBrand, ...topCompetitors];
            const restRows = wData.filter(d => !allTracked.includes(d.real_brand));
            const restShare = restRows.length ? (restRows.reduce((a,b)=>a+b.click_share,0)/restRows.length) : 0;
            row.push(restShare);
            
            compRows.push(row);
        });

        const data2 = google.visualization.arrayToDataTable(compRows);
        new google.visualization.LineChart(document.getElementById('chart_brand_comp')).draw(data2, {
            curveType: 'function',
            legend: {position: 'bottom'},
            colors: [varCss('--primary'), varCss('--danger'), varCss('--warning'), varCss('--success'), '#999'],
            vAxis: {format: 'percent'},
            chartArea: {width: '85%', height: '70%'}
        });

        // --- CHART 3: PRICE LEVERS ---
        // Simple comparison of Our Price vs Share over time
        const priceData = [['Semana', 'Precio ($)', 'Share (%)']];
        weeks.forEach(w => {
            const ours = raw.find(d => d.week_date === w && d.real_brand === ourBrand);
            if(ours) priceData.push([w, ours.price, ours.click_share]);
        });
        
        const data3 = google.visualization.arrayToDataTable(priceData);
        new google.visualization.ComboChart(document.getElementById('chart_price_impact')).draw(data3, {
            series: {0: {type: 'line', color: 'green'}, 1: {type: 'bars', color: varCss('--primary')}},
            vAxes: {0: {title: 'Precio'}, 1: {title: 'Share'}},
            legend: {position: 'bottom'}
        });


        // --- CHART 4: EFFICIENCY (Scatter) ---
        // X: Rank, Y: Share. Color: Us vs Them
        const scatterRows = [['Rank', 'Click Share', {'role': 'style'}, {'role': 'tooltip'}]];
        
        raw.filter(d => d.week_date === lastWeek).forEach(d => {
            const isUs = d.real_brand === ourBrand;
            const color = isUs ? varCss('--primary') : '#ccc';
            const tooltip = `${d.real_brand} | Rank: ${d.average_organic_rank} | Share: ${(d.click_share*100).toFixed(1)}%`;
            scatterRows.push([d.average_organic_rank, d.click_share, `point {fill-color: ${color}}`, tooltip]);
        });

        const data4 = google.visualization.arrayToDataTable(scatterRows);
        new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(data4, {
            hAxis: {title: 'Ranking Orgánico (Inverso)', direction: -1},
            vAxis: {title: 'Click Share', format: 'percent'},
            legend: 'none',
            colors: [varCss('--primary')]
        });

        // --- INSIGHTS GENERATION ---
        generateInsights(data, lastWeek);
    }

    function generateInsights(data, lastWeek) {
        const { raw, ourBrand, topCompetitors, weeks } = data;
        
        // 1. Trend Logic
        const firstWeek = weeks[0];
        const lastData = raw.filter(d => d.week_date === lastWeek && d.real_brand === ourBrand);
        const firstData = raw.filter(d => d.week_date === firstWeek && d.real_brand === ourBrand);
        
        const shareL = lastData.reduce((a,b)=>a+b.click_share,0)/lastData.length || 0;
        const shareF = firstData.reduce((a,b)=>a+b.click_share,0)/firstData.length || 0;
        const trend = shareL > shareF ? 'Positiva' : 'Negativa';

        // 2. Deal Logic
        const hasDeal = lastData.some(d => d.weekly_number_of_days_with_deal > 0);
        const hasCoupon = lastData.some(d => d.weekly_number_of_days_with_coupon > 0);

        const list = document.getElementById('insights_list');
        list.innerHTML = `
            <li class="insight-item">
                <span class="material-icons insight-icon">show_chart</span>
                <div><strong>Tendencia ${trend}:</strong> ${ourBrand} ha pasado de ${(shareF*100).toFixed(1)}% a ${(shareL*100).toFixed(1)}% de cuota.</div>
            </li>
            <li class="insight-item">
                <span class="material-icons insight-icon">military_tech</span>
                <div><strong>Liderazgo:</strong> El principal competidor es ${topCompetitors[0]} con fuerte presencia.</div>
            </li>
            <li class="insight-item">
                <span class="material-icons insight-icon">local_offer</span>
                <div><strong>Promociones:</strong> ${hasDeal ? 'Deal activo' : 'Sin Deals'} y ${hasCoupon ? 'Cupón activo' : 'Sin Cupones'} esta última semana.</div>
            </li>
             <li class="insight-item">
                <span class="material-icons insight-icon">fitness_center</span>
                <div><strong>Eficiencia:</strong> La correlación Rank/Share indica oportunidades en keywords donde rank < 10.</div>
            </li>
             <li class="insight-item">
                <span class="material-icons insight-icon">visibility</span>
                <div><strong>Visibilidad:</strong> Se detectan ${raw.length} puntos de datos analizados en ${weeks.length} semanas.</div>
            </li>
        `;

        const recs = document.getElementById('recommendations_list');
        recs.innerHTML = `
            <li class="insight-item"><span class="material-icons insight-icon">check_circle</span><div>Activar Cupones en semanas valle para recuperar tracción.</div></li>
            <li class="insight-item"><span class="material-icons insight-icon">check_circle</span><div>Revisar precio vs ${topCompetitors[0]} para ganar competitividad.</div></li>
            <li class="insight-item"><span class="material-icons insight-icon">check_circle</span><div>Optimizar títulos de variantes con bajo Organic Rank.</div></li>
        `;
    }

    // ==========================================
    // INTERACTIVE FUNCTIONS
    // ==========================================

    function populateSelectors(data) {
        const sel = document.getElementById('compSelector');
        // Add Top Competitors + Others
        const allComps = [...new Set(data.raw.map(d => d.real_brand))].filter(b => b !== data.ourBrand);
        allComps.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            sel.appendChild(opt);
        });
    }

    function updateInteractiveCharts() {
        const comp = document.getElementById('compSelector').value;
        const metric = document.getElementById('metricSelector').value;
        const { raw, ourBrand, weeks } = processedData;

        // --- LINE CHART (Face to Face) ---
        const rows = [['Semana', ourBrand, comp]];
        weeks.forEach(w => {
            const getData = (brand) => {
                const rs = raw.filter(d => d.week_date === w && d.real_brand === brand);
                if (!rs.length) return 0;
                
                if (metric === 'price') return rs.reduce((a,b)=>a+b.price,0)/rs.length;
                if (metric === 'rank') return rs.reduce((a,b)=>a+b.average_organic_rank,0)/rs.length;
                return rs.reduce((a,b)=>a+b.click_share,0)/rs.length;
            };
            rows.push([w, getData(ourBrand), getData(comp)]);
        });

        const dataLine = google.visualization.arrayToDataTable(rows);
        const options = {
            title: `Comparativa: ${metric.toUpperCase()}`,
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: [varCss('--primary'), varCss('--danger')],
             vAxis: { direction: metric === 'rank' ? -1 : 1 }
        };
        new google.visualization.LineChart(document.getElementById('chart_interactive_line')).draw(dataLine, options);

        // --- TABLE (Detail Last Week) ---
        const lastWeek = weeks[weeks.length - 1];
        const detailRows = raw
            .filter(d => d.week_date === lastWeek && (d.real_brand === ourBrand || d.real_brand === comp))
            .map(d => [d.real_brand, d.product_title.substring(0,30)+'...', d.price, d.click_share, d.average_organic_rank]);

        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Marca');
        dataTable.addColumn('string', 'Producto');
        dataTable.addColumn('number', 'Precio');
        dataTable.addColumn('number', 'Share');
        dataTable.addColumn('number', 'Rank');
        dataTable.addRows(detailRows);

        new google.visualization.Table(document.getElementById('table_interactive_detail')).draw(dataTable, {width: '100%', height: '100%'});
    }

    // Helper to get CSS variable values
    function varCss(varName) {
        return getComputedStyle(document.body).getPropertyValue(varName).trim();
    }

</script>
</body>
</html>