<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIN Performance Report</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        :root {
            --primary: #0071e3; /* Amazon/Apple Blue */
            --success: #34c759;
            --danger: #ff3b30;
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --text-sec: #86868b;
            --border: #d2d2d7;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        h1 { font-size: 28px; font-weight: 600; margin: 0; }
        .date-badge {
            background: #e3e3e3;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.05);
            padding: 5px;
            border-radius: 12px;
            width: fit-content;
        }
        .tab-btn {
            border: none;
            background: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-sec);
        }
        .tab-btn.active {
            background: white;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }
        .card-title {
            font-size: 16px;
            color: var(--text-sec);
            font-weight: 500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .full-width { grid-column: 1 / -1; }

        /* KPI Specifics */
        .kpi-value { font-size: 32px; font-weight: 600; margin-bottom: 5px; }
        .kpi-trend { font-size: 14px; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .trend-flat { color: var(--text-sec); }

        /* Insights Box */
        .insights-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
            border: 1px solid #bae6fd;
        }
        .insight-item {
            display: flex;
            align-items: start;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.5;
        }
        .insight-icon { color: var(--primary); margin-top: 2px; }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        select {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 14px;
            background: white;
            outline: none;
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 10px;
        }
        .chart-container-lg { height: 400px; }

        /* Footer */
        footer {
            margin-top: 40px;
            text-align: center;
            color: var(--text-sec);
            font-size: 12px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Reporte de Rendimiento ASIN</h1>
            <div style="color: var(--text-sec); font-size: 14px; margin-top: 4px;">Parent Analysis & Competitor Intelligence</div>
        </div>
        <div class="date-badge" id="reportDate">Cargando fecha...</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTRATÉGICO -->
    <div id="tab-static" class="tab-content">
        
        <!-- KPI Row -->
        <div class="grid">
            <div class="card">
                <div class="card-title"><span class="material-icons">touch_app</span>Total Clicks (Nuestro)</div>
                <div class="kpi-value" id="kpiClicks">-</div>
                <div class="kpi-trend" id="kpiClicksTrend">Calculando...</div>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">pie_chart</span>Click Share Avg</div>
                <div class="kpi-value" id="kpiShare">-</div>
                <div class="kpi-trend" id="kpiShareTrend">Calculando...</div>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">leaderboard</span>Organic Rank Avg</div>
                <div class="kpi-value" id="kpiRank">-</div>
                <div class="kpi-trend" id="kpiRankTrend">Calculando...</div>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">attach_money</span>Precio Avg</div>
                <div class="kpi-value" id="kpiPrice">-</div>
                <div class="kpi-trend" id="kpiPriceTrend">Calculando...</div>
            </div>
        </div>

        <!-- Section 1: Global Trend -->
        <div class="card full-width">
            <div class="card-title">1. Tendencia Global del Parent (Volumen & Share)</div>
            <div id="chart_global_trend" class="chart-container-lg"></div>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="card full-width">
            <div class="card-title">2. Competitividad de Marca (Click Share Semanal)</div>
            <div id="chart_brand_comp" class="chart-container-lg"></div>
        </div>

        <!-- Section 4: Efficiency (Placed here for flow) -->
        <div class="card full-width">
            <div class="card-title">3. Eficiencia: Organic Rank vs Click Share (Última Semana)</div>
            <div style="font-size: 12px; color: #666; margin-bottom:10px;">Cuadrante Superior Derecho = Alta Eficiencia (Alto Rank, Alto Share)</div>
            <div id="chart_efficiency" class="chart-container-lg"></div>
        </div>

        <!-- Section 3 & 5: Insights & Levers -->
        <div class="grid">
            <div class="card full-width insights-box">
                <div class="card-title" style="color: #0071e3;"><span class="material-icons">lightbulb</span>Conclusiones Clave y Recomendaciones</div>
                <div id="insightsList">
                    <!-- Javascript will populate this -->
                </div>
            </div>
        </div>

        <div class="card full-width">
            <div class="card-title">Other Insights (Anomalías y Oportunidades)</div>
            <div id="otherInsightsList" style="font-size: 14px; line-height: 1.6; color: #444;"></div>
        </div>
    </div>

    <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
    <div id="tab-interactive" class="tab-content" style="display: none;">
        <div class="card full-width">
            <div class="card-title">Cara a Cara: Nosotros vs Competencia</div>
            
            <div class="controls">
                <select id="compWeekSelect" onchange="updateInteractiveCharts()"></select>
                <select id="compBrandSelect" onchange="updateInteractiveCharts()">
                    <option value="" disabled selected>Selecciona Competidor</option>
                </select>
            </div>

            <div class="grid">
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 600; margin-bottom: 10px;">Comparativa de Precios</div>
                    <div id="chart_int_price" class="chart-container"></div>
                </div>
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 600; margin-bottom: 10px;">Share de Clics</div>
                    <div id="chart_int_share" class="chart-container"></div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <div style="text-align: center; font-weight: 600; margin-bottom: 10px;">Estado de Promociones (Deals & Badges)</div>
                <div id="table_int_status"></div>
            </div>
        </div>
    </div>

    <footer>
        Generado automáticamente por Amazon Market Intelligence AI • Confidencial
    </footer>
</div>

<script>
    // --- 1. DATA INJECTION ---
    const rawData = [{"week_date": "2026-01", "final_brand": "Double Dragon", "is_yaba_asin": "N", "is_our_brand": false, "estimated_clicks": 1204.0, "click_share": 4.92, "average_organic_rank": 11.0, "price": 6.98, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "asin": "B08YRXQ2JH"}, {"week_date": "2026-01", "final_brand": "Heapwell Superfoods", "is_yaba_asin": "N", "is_our_brand": false, "estimated_clicks": 1781.52, "click_share": 7.28, "average_organic_rank": 6.0, "price": 9.99, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "asin": "B06XTYYYJ8"}, {"week_date": "2026-01", "final_brand": "SuperSelf", "is_yaba_asin": "N", "is_our_brand": false, "estimated_clicks": 3298.76, "click_share": 13.48, "average_organic_rank": 3.0, "price": 9.9, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "asin": "B08YK2RPBZ"}, {"week_date": "2026-01", "final_brand": "Perfect Ted", "is_yaba_asin": "N", "is_our_brand": false, "estimated_clicks": 1845.15, "click_share": 7.54, "average_organic_rank": 4.0, "price": 16.99, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 1.0, "weekly_number_of_days_with_coupon": 0.0, "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "asin": "B0F21VZMJQ"}, {"week_date": "2026-01", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "is_our_brand": true, "estimated_clicks": 496.77, "click_share": 2.03, "average_organic_rank": 10.0, "price": 16.49, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "asin": "B07B29VZ6W"}, {"week_date": "2026-01", "final_brand": "SuperSelf", "is_yaba_asin": "N", "is_our_brand": false, "estimated_clicks": 993.54, "click_share": 4.06, "average_organic_rank": 7.0, "price": 14.86, "weekly_number_of_days_with_deal": 4.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "asin": "B082DKRSB4"}, {"week_date": "2026-01", "final_brand": "Perfect Ted", "is_yaba_asin": "N", "is_our_brand": false, "estimated_clicks": 1145.27, "click_share": 4.68, "average_organic_rank": 34.0, "price": 2.1225, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "asin": "B09DQ1PWGX"}, {"week_date": "2026-01", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "is_our_brand": true, "estimated_clicks": 3470.06, "click_share": 14.18, "average_organic_rank": 1.0, "price": 12.49, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0, "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "asin": "B06XQ5DCYJ"}, {"week_date": "2026-01", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "is_our_brand": true, "estimated_clicks": 780.64, "click_share": 3.19, "average_organic_rank": 7.0, "price": 20.99, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "asin": "B079VQ52MK"}, {"week_date": "2026-01", "final_brand": "Perfect Ted", "is_yaba_asin": "N", "is_our_brand": false, "estimated_clicks": 579.97, "click_share": 2.37, "average_organic_rank": 11.0, "price": 11.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "asin": "B0D9M91WZD"}];
    const OUR_BRAND_NAME = "NaturaleBio";

    // --- 2. LOGIC & PROCESSING ---

    // Get unique weeks sorted
    const weeks = [...new Set(rawData.map(d => d.week_date))].sort();
    const currentWeek = weeks[weeks.length - 1];
    const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;

    document.getElementById('reportDate').innerText = `Periodo: ${weeks[0]} - ${currentWeek}`;

    // Helper: Filter data
    const getDataByBrand = (brand) => rawData.filter(d => d.final_brand === brand);
    const getDataByWeek = (week) => rawData.filter(d => d.week_date === week);

    // --- 3. GOOGLE CHARTS SETUP ---
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawEfficiencyChart();
        populateKPIs();
        generateInsights();
        setupInteractiveControls();
    }

    // --- CHART 1: GLOBAL TREND (Our Brand vs Competitors) ---
    function drawGlobalTrend() {
        // Aggregate Clicks per Week for "Our Brand" vs "Rest"
        const chartData = [['Semana', 'Clicks (Nosotros)', 'Clicks (Competencia)', 'Share % (Nosotros)']];
        
        weeks.forEach(week => {
            const weekData = getDataByWeek(week);
            const ourClicks = weekData.filter(d => d.is_our_brand).reduce((sum, d) => sum + d.estimated_clicks, 0);
            const compClicks = weekData.filter(d => !d.is_our_brand).reduce((sum, d) => sum + d.estimated_clicks, 0);
            const totalClicks = ourClicks + compClicks;
            const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
            
            chartData.push([week, Math.round(ourClicks), Math.round(compClicks), ourShare]);
        });

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1, color: '#1d1d1f', lineWidth: 3} },
            colors: ['#0071e3', '#d2d2d7'],
            vAxes: {
                0: {title: 'Volumen de Clics', gridlines: {color: 'transparent'}},
                1: {title: 'Click Share %', format: '#\'%\'', gridlines: {color: '#f0f0f0'}}
            },
            hAxis: { title: 'Semana', gridlines: {color: 'transparent'} },
            legend: { position: 'top' },
            animation: { startup: true, duration: 1000, easing: 'out' },
            bar: { groupWidth: '60%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // --- CHART 2: BRAND COMPETITIVENESS ---
    function drawBrandCompetitiveness() {
        // Identify Top 3 Competitors by Avg Share
        const brandShares = {};
        rawData.forEach(d => {
            if (!brandShares[d.final_brand]) brandShares[d.final_brand] = 0;
            brandShares[d.final_brand] += d.click_share;
        });
        
        // Remove our brand from "Competitor" list ranking
        const compEntries = Object.entries(brandShares)
            .filter(([b]) => b !== OUR_BRAND_NAME)
            .sort((a, b) => b[1] - a[1]);
        
        const top3Comps = compEntries.slice(0, 3).map(e => e[0]);
        
        // Prepare data columns: Week, Our Brand, Comp 1, Comp 2, Comp 3, Others
        const header = ['Semana', OUR_BRAND_NAME, ...top3Comps, 'Resto del Mercado'];
        const rows = [];

        weeks.forEach(week => {
            const weekData = getDataByWeek(week);
            const row = [week];
            
            // Ours
            const ourShare = weekData.filter(d => d.is_our_brand).reduce((sum, d) => sum + d.click_share, 0);
            row.push(ourShare);

            // Top 3 Comps
            let top3Sum = 0;
            top3Comps.forEach(comp => {
                const s = weekData.filter(d => d.final_brand === comp).reduce((sum, d) => sum + d.click_share, 0);
                row.push(s);
                top3Sum += s;
            });

            // Others
            const allShare = weekData.reduce((sum, d) => sum + d.click_share, 0);
            row.push(Math.max(0, allShare - ourShare - top3Sum)); // Residual

            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#0071e3', '#ff3b30', '#ff9500', '#af52de', '#8e8e93'], // Blue for us, colors for comps, grey for rest
            vAxis: { title: 'Click Share (%)', gridlines: {color: '#f0f0f0'} },
            hAxis: { gridlines: {color: 'transparent'} },
            legend: { position: 'top' },
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    // --- CHART 4: EFFICIENCY (Scatter) ---
    function drawEfficiencyChart() {
        const lastWeekData = getDataByWeek(currentWeek);
        
        // Header: [ID, Rank, Share, Brand (Color), Size(dummy)]
        const chartData = [['ID', 'Organic Rank', 'Click Share (%)', 'Tipo', 'Precio']];
        
        lastWeekData.forEach(d => {
            const label = d.is_our_brand ? 'Nuestra Marca' : 'Competencia';
            // Note: Invert Rank on axis ideally, but for scatter X axis: 1 is left (good).
            chartData.push([
                d.asin, 
                d.average_organic_rank, 
                d.click_share, 
                label,
                d.price // Radius or tooltip
            ]);
        });

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
            title: 'Eficiencia: Rank (X) vs Share (Y) - Última Semana',
            hAxis: { title: 'Organic Rank (Menor es mejor)', direction: -1, gridlines: {color: '#eee'} }, // Reversed axis for Rank
            vAxis: { title: 'Click Share %', gridlines: {color: '#eee'} },
            legend: { position: 'top' },
            colors: ['#0071e3', '#86868b'],
            sizeAxis: { minValue: 0, maxSize: 15 },
            bubble: { textStyle: { fontSize: 11 } }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- 4. KPIs & INSIGHTS GENERATION ---
    function populateKPIs() {
        const thisWeek = getDataByWeek(currentWeek).filter(d => d.is_our_brand);
        // Aggregates
        const totalClicks = thisWeek.reduce((sum, d) => sum + d.estimated_clicks, 0);
        const totalShare = thisWeek.reduce((sum, d) => sum + d.click_share, 0);
        const avgRank = thisWeek.length ? thisWeek.reduce((sum, d) => sum + d.average_organic_rank, 0) / thisWeek.length : 0;
        const avgPrice = thisWeek.length ? thisWeek.reduce((sum, d) => sum + d.price, 0) / thisWeek.length : 0;

        document.getElementById('kpiClicks').innerText = Math.round(totalClicks).toLocaleString();
        document.getElementById('kpiShare').innerText = totalShare.toFixed(2) + '%';
        document.getElementById('kpiRank').innerText = avgRank.toFixed(1);
        document.getElementById('kpiPrice').innerText = avgPrice.toFixed(2) + '€';
        
        // Simple logic since we might have 1 week only
        document.getElementById('kpiClicksTrend').innerHTML = weeks.length > 1 ? 'vs semana anterior' : '<span class="trend-flat">Sin histórico suficiente</span>';
        document.getElementById('kpiShareTrend').innerHTML = weeks.length > 1 ? 'vs semana anterior' : '<span class="trend-flat">--</span>';
    }

    function generateInsights() {
        const insightsDiv = document.getElementById('insightsList');
        const othersDiv = document.getElementById('otherInsightsList');
        const weekData = getDataByWeek(currentWeek);
        const ourData = weekData.filter(d => d.is_our_brand);
        const compData = weekData.filter(d => !d.is_our_brand);

        let html = '';
        let recs = '';

        // Insight 1: Dominance
        const ourTotalShare = ourData.reduce((s,d) => s + d.click_share, 0);
        const topComp = compData.sort((a,b) => b.click_share - a.click_share)[0];
        
        if (ourTotalShare > topComp.click_share) {
            html += `<div class="insight-item"><span class="material-icons insight-icon">check_circle</span><div><strong>Liderazgo de Mercado:</strong> Nuestra marca domina con un ${ourTotalShare.toFixed(1)}% de cuota, superando a ${topComp.final_brand} (${topComp.click_share}%)</div></div>`;
        } else {
            html += `<div class="insight-item"><span class="material-icons insight-icon" style="color:var(--danger)">warning</span><div><strong>Desafío Competitivo:</strong> ${topComp.final_brand} lidera la categoría con un ${topComp.click_share}% de share. Nosotros tenemos un ${ourTotalShare.toFixed(1)}%.</div></div>`;
            recs += `<li>Analizar la estrategia de precio/deals de ${topComp.final_brand} para recuperar cuota.</li>`;
        }

        // Insight 2: Pricing Power
        const avgOurPrice = ourData.reduce((s,d) => s + d.price, 0) / (ourData.length || 1);
        const avgCompPrice = compData.reduce((s,d) => s + d.price, 0) / (compData.length || 1);
        const priceDiff = ((avgOurPrice - avgCompPrice) / avgCompPrice) * 100;

        if (priceDiff > 10) {
            html += `<div class="insight-item"><span class="material-icons insight-icon">payments</span><div><strong>Posicionamiento Premium:</strong> Vendemos un ${priceDiff.toFixed(0)}% más caro que la media. Vigilar conversión si el share baja.</div></div>`;
        } else if (priceDiff < -10) {
            html += `<div class="insight-item"><span class="material-icons insight-icon">trending_down</span><div><strong>Estrategia de Penetración:</strong> Estamos un ${Math.abs(priceDiff).toFixed(0)}% por debajo del precio medio. ¿Hay margen para subir precios?</div></div>`;
            recs += `<li>Testear subida de precio gradual (+2-3%) monitorizando el ranking orgánico.</li>`;
        }

        // Insight 3: Deals Impact
        const compsWithDeals = compData.filter(d => d.weekly_number_of_days_with_deal > 0);
        if (compsWithDeals.length > 0) {
            html += `<div class="insight-item"><span class="material-icons insight-icon">local_offer</span><div><strong>Presión Promocional:</strong> ${compsWithDeals.length} ASINs competidores tienen Deals activos. Esto puede erosionar nuestro Click Share.</div></div>`;
            recs += `<li>Activar cupones defensivos en nuestros Top Sellers para contrarrestar Deals de competidores.</li>`;
        }

        // Insight 4: Efficiency
        const inefficientASINs = ourData.filter(d => d.average_organic_rank < 5 && d.click_share < 5); // Good rank, low share
        if (inefficientASINs.length > 0) {
            html += `<div class="insight-item"><span class="material-icons insight-icon">visibility</span><div><strong>Problema de CTR:</strong> ${inefficientASINs.length} de nuestros ASINs tienen buen ranking (Top 5) pero baja cuota. Revisar imagen principal y título.</div></div>`;
            recs += `<li>Optimizar Main Image y Título para ASIN: ${inefficientASINs[0].asin}.</li>`;
        } else {
            html += `<div class="insight-item"><span class="material-icons insight-icon">thumb_up</span><div><strong>Alta Eficiencia:</strong> Nuestros ASINs en Top Rank convierten bien a clics.</div></div>`;
        }

        insightsDiv.innerHTML = html + `<div style="margin-top:15px; font-weight:600; color:#0071e3;">Recomendaciones:</div><ul style="margin:5px 0 0 20px; font-size:14px;">${recs || '<li>Mantener estrategia actual y monitorizar nuevos entrantes.</li>'}</ul>`;

        // Other Insights
        othersDiv.innerHTML = `
            <p><strong>• Estructura de Catálogo:</strong> Tenemos ${ourData.length} variantes posicionadas vs una media de ${(compData.length/3).toFixed(1)} por competidor principal.</p>
            <p><strong>• Amazon Choice:</strong> Tenemos presencia de badge en ${ourData.filter(d=>d.weekly_number_of_days_with_amazon_choice_badge>0).length} ASINs.</p>
        `;
    }

    // --- 5. INTERACTIVE LOGIC ---
    function setupInteractiveControls() {
        const weekSel = document.getElementById('compWeekSelect');
        const brandSel = document.getElementById('compBrandSelect');

        // Populate Weeks
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            if(w === currentWeek) opt.selected = true;
            weekSel.appendChild(opt);
        });

        // Populate Competitors
        const uniqueComps = [...new Set(rawData.filter(d => !d.is_our_brand).map(d => d.final_brand))].sort();
        uniqueComps.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            brandSel.appendChild(opt);
        });
        
        // Select first competitor by default
        if(uniqueComps.length > 0) {
            brandSel.value = uniqueComps[0];
            updateInteractiveCharts();
        }
    }

    function updateInteractiveCharts() {
        const selectedWeek = document.getElementById('compWeekSelect').value;
        const selectedComp = document.getElementById('compBrandSelect').value;
        if (!selectedComp) return;

        const weekData = getDataByWeek(selectedWeek);
        const ourItems = weekData.filter(d => d.is_our_brand);
        const compItems = weekData.filter(d => d.final_brand === selectedComp);

        // Averages for comparison
        const getAvg = (items, key) => items.length ? items.reduce((s,d) => s + d[key], 0)/items.length : 0;

        const dataPrice = google.visualization.arrayToDataTable([
            ['Marca', 'Precio Promedio', { role: 'style' }],
            [OUR_BRAND_NAME, getAvg(ourItems, 'price'), '#0071e3'],
            [selectedComp, getAvg(compItems, 'price'), '#86868b']
        ]);

        const dataShare = google.visualization.arrayToDataTable([
            ['Marca', 'Total Click Share', { role: 'style' }],
            [OUR_BRAND_NAME, ourItems.reduce((s,d)=>s+d.click_share,0), '#0071e3'],
            [selectedComp, compItems.reduce((s,d)=>s+d.click_share,0), '#86868b']
        ]);

        const chartPrice = new google.visualization.BarChart(document.getElementById('chart_int_price'));
        chartPrice.draw(dataPrice, { legend: 'none', hAxis: {title: 'Precio (€)'} });

        const chartShare = new google.visualization.BarChart(document.getElementById('chart_int_share'));
        chartShare.draw(dataShare, { legend: 'none', hAxis: {title: '% Share'} });

        // Status Table
        let tableHtml = `<table style="width:100%; font-size:13px; border-collapse: collapse;">
            <tr style="background:#f5f5f7; text-align:left;"><th style="padding:8px;">Métrica</th><th>${OUR_BRAND_NAME}</th><th>${selectedComp}</th></tr>`;
        
        const metrics = [
            {label: 'Avg Rank Orgánico', key: 'average_organic_rank', fmt: v => v.toFixed(1)},
            {label: 'Días con Deal', key: 'weekly_number_of_days_with_deal', fmt: v => v.toFixed(0)},
            {label: 'Días con Cupones', key: 'weekly_number_of_days_with_coupon', fmt: v => v.toFixed(0)}
        ];

        metrics.forEach(m => {
            tableHtml += `<tr>
                <td style="padding:8px; border-bottom:1px solid #eee;">${m.label}</td>
                <td style="padding:8px; border-bottom:1px solid #eee; font-weight:600; color:#0071e3;">${m.fmt(getAvg(ourItems, m.key))}</td>
                <td style="padding:8px; border-bottom:1px solid #eee;">${m.fmt(getAvg(compItems, m.key))}</td>
            </tr>`;
        });
        tableHtml += '</table>';
        document.getElementById('table_int_status').innerHTML = tableHtml;
    }

    // --- UI HELPERS ---
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).style.display = 'block';
        event.target.classList.add('active');
        
        // Redraw charts to fix width issues when unhiding
        if(tabName === 'static') drawCharts();
        if(tabName === 'interactive') updateInteractiveCharts();
    };

</script>

</body>
</html>