<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Amazon ASIN</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-primary: #202124;
            --text-secondary: #5F6368;
            --border-radius: 16px;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Layout & Grid */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 400;
            color: var(--text-primary);
            margin: 0;
        }

        .header .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #DADCE0;
            padding-bottom: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            padding: 24px;
            margin-bottom: 24px;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-item {
            background: #F1F3F4;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 500;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: #F8F9FA;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .insight-item.warning { border-left-color: var(--warning-color); }
        .insight-item.danger { border-left-color: var(--danger-color); }
        .insight-item.success { border-left-color: var(--success-color); }

        .insight-text { font-size: 14px; }

        /* Interactive Elements */
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #DADCE0;
            font-size: 14px;
            color: var(--text-primary);
            background: white;
            outline: none;
        }

        .hidden { display: none; }
        
        /* Table Styles for Google Table */
        .google-visualization-table-table {
            font-family: 'Roboto', sans-serif !important;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Reporte de Inteligencia de Mercado</h1>
            <div class="subtitle" id="report-subtitle">Parent ASIN Analysis & Competitor Benchmarking</div>
        </div>
        <div>
            <span class="material-icons" style="font-size: 36px; color: var(--primary-color);">analytics</span>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static-report')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive-compare')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static-report">
        
        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent (Clicks & Share)
                </div>
            </div>
            <div class="metrics-grid" id="global-metrics">
                <!-- Metrics injected by JS -->
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="insight-list" id="trend-insights"></div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Share %)
                </div>
            </div>
            <div id="chart_competitiveness" class="chart-container"></div>
            <div class="insight-list" id="brand-insights"></div>
        </div>

        <!-- Section 3: Palancas (Levers) -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">tune</span>
                    3. üöÄ Palancas de Crecimiento
                </div>
            </div>
            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                <div id="chart_price_share" class="chart-container" style="flex: 1; min-width: 300px;"></div>
                <div id="chart_deals_share" class="chart-container" style="flex: 1; min-width: 300px;"></div>
            </div>
            <div class="insight-list" id="levers-insights"></div>
        </div>

        <!-- Section 4: Efficiency -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Eficiencia (Organic Rank vs Click Share)
                </div>
            </div>
            <div id="chart_efficiency" class="chart-container"></div>
            <div class="insight-list" id="efficiency-insights"></div>
        </div>

        <!-- Section 5 & 6: Conclusions & Recommendations -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Conclusiones y Recomendaciones
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h3 style="color: var(--primary-color);">Insights Clave</h3>
                    <ul class="insight-list" id="final-insights"></ul>
                </div>
                <div>
                    <h3 style="color: var(--success-color);">Recomendaciones Accionables</h3>
                    <ul class="insight-list" id="final-recommendations"></ul>
                </div>
            </div>
            <div style="margin-top: 24px;">
                 <h3 style="color: var(--text-secondary);">Other Insights (Anomal√≠as)</h3>
                 <ul class="insight-list" id="other-insights"></ul>
            </div>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVE COMPARE -->
    <div id="interactive-compare" class="hidden">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Cara a Cara: Nosotros vs Competencia</div>
                <div>
                    <select id="competitor-select" onchange="renderComparison()">
                        <option value="">Selecciona Competidor...</option>
                    </select>
                </div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value" id="comp-price-diff">-</div>
                    <div class="metric-label">Diferencial Precio</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="comp-share-diff">-</div>
                    <div class="metric-label">Diferencial Share</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="comp-rank-diff">-</div>
                    <div class="metric-label">Diferencial Rank</div>
                </div>
            </div>

            <div id="comparison_table" style="width: 100%;"></div>
        </div>
    </div>

</div>

<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION
    // ---------------------------------------------------------
    // Data processed from CSV
    const marketData = [{"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "final_brand": "VAHDAM", "is_yaba_asin": "N", "clicks": 850.1780699999999, "click_share": 3.15, "average_organic_rank": 9.0, "price": 10.43, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "clicks": 5219.823452, "click_share": 19.34, "average_organic_rank": 2.0, "price": 23.91, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "clicks": 987.825948, "click_share": 3.66, "average_organic_rank": 5.0, "price": 24.5275, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "clicks": 3481.68162, "click_share": 12.9, "average_organic_rank": 2.0, "price": 14.6075, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "final_brand": "Ceremonial", "is_yaba_asin": "N", "clicks": 1991.845764, "click_share": 7.38, "average_organic_rank": 6.0, "price": 15.5575, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "clicks": 1991.845764, "click_share": 7.38, "average_organic_rank": 6.0, "price": 15.5575, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "final_brand": "bioKontor", "is_yaba_asin": "N", "clicks": 645.055742, "click_share": 2.39, "average_organic_rank": 10.0, "price": 11.9975, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "final_brand": "Bio", "is_yaba_asin": "N", "clicks": 645.055742, "click_share": 2.39, "average_organic_rank": 10.0, "price": 11.9975, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "clicks": 723.3261040000001, "click_share": 2.68, "average_organic_rank": 0.0, "price": 30.27, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "final_brand": "UNREAL\u00ae", "is_yaba_asin": "N", "clicks": 423.739546, "click_share": 1.57, "average_organic_rank": 19.0, "price": 31.2725, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "clicks": 904.15763, "click_share": 3.35, "average_organic_rank": 5.0, "price": 10.2225, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "final_brand": "Special Leaves", "is_yaba_asin": "N", "clicks": 809.6934, "click_share": 3.0, "average_organic_rank": 16.0, "price": 10.39, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}, {"week_date": "2026-01-03", "parent_asin": "Matcha Premium", "keyword": "matcha", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "final_brand": "Matcha", "is_yaba_asin": "N", "clicks": 809.6934, "click_share": 3.0, "average_organic_rank": 16.0, "price": 10.39, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_search_volume": 26989.78, "grams": "", "container": "", "organic_or_not": ""}];

    // ---------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // ---------------------------------------------------------

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processData();
        renderDashboard();
    }

    // Helper: Determine "Our Brand" dynamically
    function getOurBrandName() {
        const ourItems = marketData.filter(d => d.is_yaba_asin === 'Y');
        if(ourItems.length > 0) return ourItems[0].final_brand;
        return "Unknown";
    }

    let OUR_BRAND = getOurBrandName();
    let processedWeeks = [];
    let brandsData = {};

    function processData() {
        // Unique Weeks
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        processedWeeks = weeks;

        // Group by Brand
        marketData.forEach(row => {
            if (!brandsData[row.final_brand]) {
                brandsData[row.final_brand] = {
                    totalClicks: 0,
                    avgShare: 0,
                    count: 0,
                    isUs: (row.final_brand === OUR_BRAND)
                };
            }
            brandsData[row.final_brand].totalClicks += row.clicks;
            brandsData[row.final_brand].avgShare += row.click_share;
            brandsData[row.final_brand].count += 1;
        });
    }

    function switchTab(tabId) {
        document.getElementById('static-report').classList.add('hidden');
        document.getElementById('interactive-compare').classList.add('hidden');
        document.getElementById(tabId).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // ---------------------------------------------------------
    // 3. RENDERING CHARTS & METRICS
    // ---------------------------------------------------------

    function renderDashboard() {
        document.getElementById('report-subtitle').innerText = `An√°lisis de Parent ASIN - √öltima Semana: ${processedWeeks[processedWeeks.length-1]} | Marca: ${OUR_BRAND}`;

        // Populate Competitor Select
        const select = document.getElementById('competitor-select');
        Object.keys(brandsData).forEach(b => {
            if (b !== OUR_BRAND) {
                const opt = document.createElement('option');
                opt.value = b;
                opt.innerText = b;
                select.appendChild(opt);
            }
        });

        drawGlobalTrend();
        drawCompetitiveness();
        drawLevers();
        drawEfficiency();
        generateInsights();
    }

    // --- CHART 1: TREND ---
    function drawGlobalTrend() {
        // Aggregate Clicks by Week for Us vs Competition
        // Structure: [Week, Us Clicks, Comp Clicks, Us Share (line)]
        const dataArr = [['Semana', 'Clicks (Nosotros)', 'Clicks (Competencia)', 'Share % (Nosotros)']];
        
        processedWeeks.forEach(week => {
            const weeklyData = marketData.filter(d => d.week_date === week);
            const usData = weeklyData.filter(d => d.final_brand === OUR_BRAND);
            const compData = weeklyData.filter(d => d.final_brand !== OUR_BRAND);

            const usClicks = usData.reduce((sum, d) => sum + d.clicks, 0);
            const compClicks = compData.reduce((sum, d) => sum + d.clicks, 0);
            
            // Weighted Share calculation
            const totalVol = usClicks + compClicks;
            const usShare = totalVol > 0 ? (usClicks / totalVol) * 100 : 0;

            dataArr.push([week, usClicks, compClicks, usShare]);
        });

        const data = google.visualization.arrayToDataTable(dataArr);
        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Volumen Clicks'}, 1: {title: '% Share', format: '#\'%\''}},
            colors: ['#4285F4', '#EA4335', '#34A853'],
            legend: {position: 'bottom'},
            chartArea: {width: '80%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);

        // Fill Metrics
        const lastWeek = processedWeeks[processedWeeks.length-1];
        const lastRow = dataArr[dataArr.length-1]; // [week, usClicks, compClicks, usShare]
        
        const totalClicks = Math.round(lastRow[1] + lastRow[2]);
        const share = lastRow[3].toFixed(2);
        
        document.getElementById('global-metrics').innerHTML = `
            <div class="metric-item">
                <div class="metric-value">${totalClicks.toLocaleString()}</div>
                <div class="metric-label">Total Clicks (Semana)</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${share}%</div>
                <div class="metric-label">Nuestro Share</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${(lastRow[1] > lastRow[2] ? 'L√≠der' : 'Seguidor')}</div>
                <div class="metric-label">Posici√≥n</div>
            </div>
        `;
    }

    // --- CHART 2: COMPETITIVENESS ---
    function drawCompetitiveness() {
        // Calculate shares per brand per week
        // We need top 3 competitors + Us + Others
        
        // 1. Identify Top 3 Competitors by Avg Share
        const competitors = Object.keys(brandsData).filter(b => b !== OUR_BRAND);
        competitors.sort((a,b) => (brandsData[b].avgShare/brandsData[b].count) < (brandsData[a].avgShare/brandsData[a].count) ? 1 : -1);
        const top3 = competitors.slice(0, 3);
        
        // 2. Build Data Table
        const header = ['Semana', OUR_BRAND, ...top3, 'Resto del Mercado'];
        const rows = [];

        processedWeeks.forEach(week => {
            const weeklyData = marketData.filter(d => d.week_date === week);
            const totalShare = weeklyData.reduce((sum, d) => sum + d.click_share, 0); // Should be approx 100 or sum of tracked
            
            // Helper to sum share for a brand
            const getShare = (brand) => {
                return weeklyData.filter(d => d.final_brand === brand).reduce((sum, d) => sum + d.click_share, 0);
            };

            const usShare = getShare(OUR_BRAND);
            const t1 = getShare(top3[0] || 'N/A');
            const t2 = getShare(top3[1] || 'N/A');
            const t3 = getShare(top3[2] || 'N/A');
            const others = totalShare - usShare - t1 - t2 - t3;

            rows.push([week, usShare, t1, t2, t3, others > 0 ? others : 0]);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    // --- CHART 3: LEVERS (Scatter or Bar) ---
    function drawLevers() {
        // Price vs Share (Scatter)
        // Aggregated by ASIN to see if cheaper ASINs get more share
        const dataArr = [['ASIN', 'Precio', 'Click Share', 'Marca']];
        
        // Filter for last week for relevance
        const lastWeek = processedWeeks[processedWeeks.length-1];
        const currentData = marketData.filter(d => d.week_date === lastWeek);

        currentData.forEach(d => {
             dataArr.push([d.asin, d.price, d.click_share, d.final_brand]);
        });

        const data = google.visualization.arrayToDataTable(dataArr);
        const options = {
            title: 'Correlaci√≥n Precio vs Click Share (Semana Actual)',
            hAxis: {title: 'Precio (‚Ç¨)'},
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
            bubble: {textStyle: {fontSize: 11}},
            colors: ['#4285F4']
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_price_share'));
        chart.draw(data, options);

        // Deals Impact (Bar Chart: Avg Share with Deal vs Without Deal)
        // Since dataset is small, let's look at Deal Days > 0 vs Deal Days = 0 across all history
        
        let dealShareSum = 0, dealCount = 0;
        let noDealShareSum = 0, noDealCount = 0;

        marketData.forEach(d => {
            if (d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0) {
                dealShareSum += d.click_share;
                dealCount++;
            } else {
                noDealShareSum += d.click_share;
                noDealCount++;
            }
        });

        const avgDealShare = dealCount ? dealShareSum/dealCount : 0;
        const avgNoDealShare = noDealCount ? noDealShareSum/noDealCount : 0;

        const dealData = google.visualization.arrayToDataTable([
            ['Estado', 'Share Promedio', { role: 'style' }],
            ['Con Promo/Deal', avgDealShare, '#34A853'],
            ['Sin Promo', avgNoDealShare, '#9AA0A6']
        ]);

        const dealOptions = {
            title: 'Impacto Promociones en Share',
            legend: 'none'
        };

        const dealChart = new google.visualization.ColumnChart(document.getElementById('chart_deals_share'));
        dealChart.draw(dealData, dealOptions);
    }

    // --- CHART 4: EFFICIENCY (Rank vs Share) ---
    function drawEfficiency() {
        const dataArr = [['Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        const lastWeek = processedWeeks[processedWeeks.length-1];
        const currentData = marketData.filter(d => d.week_date === lastWeek && d.average_organic_rank > 0); // Ignore rank 0

        currentData.forEach(d => {
            const color = d.final_brand === OUR_BRAND ? 'point { fill-color: #4285F4; size: 10; }' : 'point { fill-color: #EA4335; }';
            const tooltip = `${d.final_brand} (${d.asin})\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            dataArr.push([d.average_organic_rank, d.click_share, color, tooltip]);
        });

        const data = google.visualization.arrayToDataTable(dataArr);
        const options = {
            title: 'Eficiencia: Organic Rank vs Click Share',
            hAxis: {title: 'Organic Rank (Menor es mejor)', direction: -1}, // Invert axis
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // ---------------------------------------------------------
    // 4. GENERATE INSIGHTS (TEXTUAL ANALYSIS)
    // ---------------------------------------------------------
    function generateInsights() {
        // Helpers
        const lastWeek = processedWeeks[processedWeeks.length-1];
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        const usData = currentData.filter(d => d.final_brand === OUR_BRAND);
        const compData = currentData.filter(d => d.final_brand !== OUR_BRAND);

        // --- TREND INSIGHTS ---
        const totalUsClicks = usData.reduce((a,b)=>a+b.clicks,0);
        const totalCompClicks = compData.reduce((a,b)=>a+b.clicks,0);
        const totalShare = usData.reduce((a,b)=>a+b.click_share,0);
        
        const trendDiv = document.getElementById('trend-insights');
        trendDiv.innerHTML = `
            <li class="insight-item ${totalUsClicks > totalCompClicks ? 'success' : 'warning'}">
                <span class="material-icons">info</span>
                <span class="insight-text">
                    Nuestra marca (${OUR_BRAND}) captur√≥ <strong>${totalShare.toFixed(1)}%</strong> del share esta semana. 
                    ${totalUsClicks < totalCompClicks ? 'Los competidores acumulan la mayor√≠a del volumen.' : 'Dominamos el volumen de la categor√≠a.'}
                </span>
            </li>
        `;

        // --- LEVERS INSIGHTS ---
        const usAvgPrice = usData.length ? (usData.reduce((a,b)=>a+b.price,0)/usData.length).toFixed(2) : 0;
        const compAvgPrice = compData.length ? (compData.reduce((a,b)=>a+b.price,0)/compData.length).toFixed(2) : 0;
        
        const leverDiv = document.getElementById('levers-insights');
        let priceInsight = "";
        if (Number(usAvgPrice) > Number(compAvgPrice)) {
            priceInsight = `Nuestro precio promedio (‚Ç¨${usAvgPrice}) es superior al de la competencia (‚Ç¨${compAvgPrice}), lo que puede limitar el Click Share si no hay diferenciaci√≥n clara.`;
        } else {
            priceInsight = `Somos m√°s competitivos en precio (‚Ç¨${usAvgPrice}) que el promedio rival (‚Ç¨${compAvgPrice}).`;
        }

        leverDiv.innerHTML = `
            <li class="insight-item">
                <span class="material-icons">euro</span>
                <span class="insight-text">${priceInsight}</span>
            </li>
        `;

        // --- FINAL INSIGHTS & RECOMENDATIONS ---
        const finalInsights = document.getElementById('final-insights');
        const finalRecs = document.getElementById('final-recommendations');
        const otherInsights = document.getElementById('other-insights');

        // Logic for specific insights
        const topCompetitor = compData.sort((a,b) => b.click_share - a.click_share)[0];
        
        // Insight 1: Dominance
        finalInsights.innerHTML += `<li><strong>Dominio de Mercado:</strong> ${totalShare > 20 ? 'Tenemos una posici√≥n s√≥lida.' : 'El mercado est√° muy fragmentado o dominado por competidores.'}</li>`;
        
        // Insight 2: Top Threat
        if(topCompetitor) {
            finalInsights.innerHTML += `<li><strong>Amenaza Principal:</strong> La marca <em>${topCompetitor.final_brand}</em> tiene un ASIN con ${topCompetitor.click_share}% de share.</li>`;
        }

        // Insight 3: Deals
        const activeDeals = usData.some(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);
        finalInsights.innerHTML += `<li><strong>Promociones:</strong> ${activeDeals ? 'Estamos activamente promocionando.' : 'No detectamos actividad promocional agresiva esta semana.'}</li>`;

        // Insight 4: Efficiency
        finalInsights.innerHTML += `<li><strong>Eficiencia Org√°nica:</strong> Revisar gr√°fico de dispersi√≥n. ASINs con buen Rank pero bajo Share requieren optimizaci√≥n de T√≠tulo/Imagen.</li>`;

        // Insight 5: Price
        finalInsights.innerHTML += `<li><strong>Posicionamiento Precio:</strong> ${Number(usAvgPrice) > Number(compAvgPrice)*1.2 ? 'Premium (Riesgo de conversi√≥n).' : 'Mainstream/Econ√≥mico.'}</li>`;

        // Recommendations
        if (totalShare < 15) {
            finalRecs.innerHTML += `<li>‚ö†Ô∏è <strong>Aumentar Visibilidad:</strong> El share es bajo. Evaluar campa√±a agresiva de PPC o Cupones para ganar tracci√≥n inicial.</li>`;
        }
        if (Number(usAvgPrice) > Number(compAvgPrice)) {
            finalRecs.innerHTML += `<li>üí∞ <strong>Revisi√≥n de Precio:</strong> Testear una bajada temporal de precio o a√±adir cup√≥n de 5-10% para mejorar CTR.</li>`;
        } else {
            finalRecs.innerHTML += `<li>‚≠ê <strong>Defensa de Margen:</strong> El precio es competitivo. Enfocarse en optimizar conversi√≥n (Listing, A+ Content) m√°s que en bajar precios.</li>`;
        }
        finalRecs.innerHTML += `<li>üîç <strong>Keyword Focus:</strong> Revisar rankings org√°nicos en keywords donde competidores top rankean mejor.</li>`;

        // Other Insights (Anomalies)
        // Check for anomalies: High Rank but Low Share
        const anomalies = usData.filter(d => d.average_organic_rank < 5 && d.click_share < 5);
        if(anomalies.length > 0) {
            otherInsights.innerHTML += `<li><strong>Anomal√≠a de Eficiencia:</strong> El ASIN ${anomalies[0].asin} tiene excelente ranking (${anomalies[0].average_organic_rank}) pero bajo share. ¬øLa imagen principal es atractiva?</li>`;
        } else {
            otherInsights.innerHTML += `<li>Sin anomal√≠as cr√≠ticas de ranking/share detectadas en nuestros ASINs.</li>`;
        }
    }

    // ---------------------------------------------------------
    // 5. INTERACTIVE COMPARISON
    // ---------------------------------------------------------
    function renderComparison() {
        const compSelect = document.getElementById('competitor-select');
        const competitorName = compSelect.value;
        if(!competitorName) return;

        const lastWeek = processedWeeks[processedWeeks.length-1];
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        
        // Aggregate Metrics
        const getMetrics = (brand) => {
            const brandRows = currentData.filter(d => d.final_brand === brand);
            const avgPrice = brandRows.length ? brandRows.reduce((a,b)=>a+b.price,0)/brandRows.length : 0;
            const totalShare = brandRows.reduce((a,b)=>a+b.click_share,0);
            const avgRank = brandRows.length ? brandRows.reduce((a,b)=>a+b.average_organic_rank,0)/brandRows.length : 0;
            return { avgPrice, totalShare, avgRank, brandRows };
        };

        const usMetrics = getMetrics(OUR_BRAND);
        const compMetrics = getMetrics(competitorName);

        // Diff Cards
        const priceDiff = ((usMetrics.avgPrice - compMetrics.avgPrice)/compMetrics.avgPrice * 100).toFixed(1);
        const shareDiff = (usMetrics.totalShare - compMetrics.totalShare).toFixed(1);
        const rankDiff = (usMetrics.avgRank - compMetrics.avgRank).toFixed(1); // Lower is better

        document.getElementById('comp-price-diff').innerText = `${priceDiff > 0 ? '+' : ''}${priceDiff}%`;
        document.getElementById('comp-price-diff').style.color = priceDiff > 0 ? '#EA4335' : '#34A853'; // Higher price usually red

        document.getElementById('comp-share-diff').innerText = `${shareDiff > 0 ? '+' : ''}${shareDiff}%`;
        document.getElementById('comp-share-diff').style.color = shareDiff > 0 ? '#34A853' : '#EA4335';

        document.getElementById('comp-rank-diff').innerText = `${rankDiff}`; // Negative is usually good in rank, but complex context
        
        // Draw Table
        const tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'ASIN');
        tableData.addColumn('string', 'T√≠tulo');
        tableData.addColumn('number', 'Precio');
        tableData.addColumn('number', 'Share %');
        tableData.addColumn('number', 'Rank');
        tableData.addColumn('string', 'Marca');

        // Combine rows
        [...usMetrics.brandRows, ...compMetrics.brandRows].forEach(r => {
            tableData.addRow([r.asin, r.product_title.substring(0,30)+'...', r.price, r.click_share, r.average_organic_rank, r.final_brand]);
        });

        const table = new google.visualization.Table(document.getElementById('comparison_table'));
        table.draw(tableData, {showRowNumber: true, width: '100%', height: '100%'});
    }

</script>
</body>
</html>