<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence: Parent ASIN Analysis</title>
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-500: #6B7280;
            --gray-800: #1F2937;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-800);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout Structure */
        .container {
            max-width: 1280px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin: 0;
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tabs System */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: white;
            padding: 6px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            width: fit-content;
        }

        .tab-btn {
            border: none;
            background: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .metric-card {
            text-align: center;
            padding: 20px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* Charts Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            padding: 12px;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .insight-icon {
            color: var(--secondary);
        }
        
        .insight-icon.warning { color: var(--warning); }
        .insight-icon.danger { color: var(--danger); }

        /* Controls */
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-size: 0.9rem;
            background-color: white;
        }

        /* Tab Visibility */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .bg-green { background-color: #E6F4EA; color: #137333; }
        .bg-red { background-color: #FCE8E6; color: #C5221F; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Amazon Market Intelligence</h1>
            <span style="color: var(--gray-500); font-size: 0.9rem;">Parent ASIN Analysis & Competitor Benchmarking</span>
        </div>
        <div>
            <span class="badge bg-green" id="date-range-badge">Latest: 2023-10-29</span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">1. Strategic Dashboard</button>
        <button class="tab-btn" onclick="switchTab('comparator')">2. Interactive Comparator</button>
    </div>

    <!-- TAB 1: DASHBOARD -->
    <div id="dashboard" class="tab-content active">
        
        <!-- Metrics Row -->
        <div class="grid-4" style="margin-bottom: 24px;">
            <div class="card metric-card" style="margin-bottom:0">
                <div class="metric-value" id="m-share">0%</div>
                <div class="metric-label">Avg Click Share (Last Week)</div>
            </div>
            <div class="card metric-card" style="margin-bottom:0">
                <div class="metric-value" id="m-rank">#0</div>
                <div class="metric-label">Avg Organic Rank</div>
            </div>
            <div class="card metric-card" style="margin-bottom:0">
                <div class="metric-value" id="m-price">$0</div>
                <div class="metric-label">Avg Price</div>
            </div>
             <div class="card metric-card" style="margin-bottom:0">
                <div class="metric-value" id="m-comp-gap" style="color: var(--danger)">0%</div>
                <div class="metric-label">Gap vs Top Competitor</div>
            </div>
        </div>

        <!-- Section 1: Trend -->
        <div class="card">
            <h2><span class="material-icons">trending_up</span> 1. Global Parent Trend (Clicks & Share)</h2>
            <div id="chart_trend" class="chart-container"></div>
            <p style="font-size: 0.9rem; color: var(--gray-500); margin-top: 10px;">
                *Bars represent Total Market Volume (Clicks). Line represents Our Brand Click Share.
            </p>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="card">
            <h2><span class="material-icons">pie_chart</span> 2. Brand Competitiveness (Share Evolution)</h2>
            <div id="chart_brand" class="chart-container"></div>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div class="grid-2">
            <div class="card">
                <h2><span class="material-icons">speed</span> 4. Efficiency: Rank vs Click Share</h2>
                <div id="chart_efficiency" class="chart-container"></div>
                <p style="font-size: 0.8rem; color: var(--gray-500);">
                    Top Left = Efficient (High Share / Low Rank). Bubbles = Individual Keywords.
                </p>
            </div>
            <div class="card">
                <h2><span class="material-icons">tune</span> 3. Levers Impact (Last Wk)</h2>
                <div id="chart_levers" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="grid-2">
            <div class="card">
                <h2><span class="material-icons">lightbulb</span> 5. Key Insights & Conclusions</h2>
                <ul class="insight-list" id="insights-container">
                    <!-- Populated by JS -->
                </ul>
            </div>
            <div class="card">
                <h2><span class="material-icons">ads_click</span> Recommendations</h2>
                <ul class="insight-list" id="recommendations-container">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: COMPARATOR -->
    <div id="comparator" class="tab-content">
        <div class="card">
            <div style="display:flex; gap: 16px; align-items:center; margin-bottom: 20px; background: var(--gray-100); padding: 16px; border-radius: 12px;">
                <div>
                    <label style="font-size:0.8rem; display:block; margin-bottom:4px;">Select Week</label>
                    <select id="comp-week-select" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="font-size:0.8rem; display:block; margin-bottom:4px;">Select Competitor</label>
                    <select id="comp-brand-select" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="grid-2">
                <div>
                    <h3>Price Comparison</h3>
                    <div id="comp_chart_price" class="chart-container" style="height: 250px;"></div>
                </div>
                <div>
                    <h3>Click Share Comparison</h3>
                    <div id="comp_chart_share" class="chart-container" style="height: 250px;"></div>
                </div>
            </div>
            
            <div style="margin-top: 24px;">
                <h3>Detailed Attribute Matrix</h3>
                <div id="comp_table_div"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION (Synthetic Data as CSV was empty)
    // ---------------------------------------------------------
    
    // We generated this data to simulate the scenario described in the prompt.
    // In a real execution, this would be parsed from the CSV.
    const marketData = [
        {"week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "is_yaba_asin": "Y", "click_share": 0.12, "price": 49.99, "average_organic_rank": 6, "clicks": 1200, "weekly_search_volume": 10000},
        {"week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Sony", "is_yaba_asin": "N", "click_share": 0.28, "price": 89.99, "average_organic_rank": 1, "clicks": 2800, "weekly_search_volume": 10000},
        {"week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "JBL", "is_yaba_asin": "N", "click_share": 0.18, "price": 59.99, "average_organic_rank": 3, "clicks": 1800, "weekly_search_volume": 10000},
        
        {"week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "is_yaba_asin": "Y", "click_share": 0.13, "price": 49.99, "average_organic_rank": 5, "clicks": 1430, "weekly_search_volume": 11000},
        {"week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "Sony", "is_yaba_asin": "N", "click_share": 0.27, "price": 89.99, "average_organic_rank": 2, "clicks": 2970, "weekly_search_volume": 11000},
        
        {"week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "is_yaba_asin": "Y", "click_share": 0.11, "price": 49.99, "average_organic_rank": 7, "clicks": 1155, "weekly_search_volume": 10500},
        {"week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "Sony", "is_yaba_asin": "N", "click_share": 0.30, "price": 89.99, "average_organic_rank": 1, "clicks": 3150, "weekly_search_volume": 10500},
        
        // Week 4: YabaTech drops price + Deal
        {"week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "is_yaba_asin": "Y", "click_share": 0.22, "price": 39.99, "average_organic_rank": 3, "clicks": 2640, "weekly_search_volume": 12000, "weekly_number_of_days_with_deal": 7},
        {"week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "Sony", "is_yaba_asin": "N", "click_share": 0.25, "price": 89.99, "average_organic_rank": 1, "clicks": 3000, "weekly_search_volume": 12000},
        
        // Week 5: Momentum continues
        {"week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "is_yaba_asin": "Y", "click_share": 0.25, "price": 39.99, "average_organic_rank": 2, "clicks": 3125, "weekly_search_volume": 12500, "weekly_number_of_days_with_deal": 7},
        {"week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Sony", "is_yaba_asin": "N", "click_share": 0.24, "price": 89.99, "average_organic_rank": 1, "clicks": 3000, "weekly_search_volume": 12500},
        {"week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "JBL", "is_yaba_asin": "N", "click_share": 0.15, "price": 59.99, "average_organic_rank": 4, "clicks": 1875, "weekly_search_volume": 12500},
        {"week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Anker", "is_yaba_asin": "N", "click_share": 0.08, "price": 45.00, "average_organic_rank": 8, "clicks": 1000, "weekly_search_volume": 12500}
    ];

    // ---------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // ---------------------------------------------------------
    
    let OUR_BRAND = "Unknown";
    let TOP_COMPETITORS = [];
    let ALL_WEEKS = [];

    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processCoreData();
        setupControls();
        
        drawTrendChart();
        drawBrandCompetitivenessChart();
        drawEfficiencyChart();
        drawLeversChart();
        generateInsights();
        
        // Initialize interactive tab
        updateComparator();
    }

    function processCoreData() {
        // 1. Identify Our Brand
        const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
        if (ourAsinRow) {
            OUR_BRAND = ourAsinRow.competitor_brand || "Our Brand";
        }

        // 2. Identify Unique Weeks
        ALL_WEEKS = [...new Set(marketData.map(d => d.week_date))].sort();
        document.getElementById('date-range-badge').innerText = `Range: ${ALL_WEEKS[0]} to ${ALL_WEEKS[ALL_WEEKS.length-1]}`;

        // 3. Identify Top Competitors (by Avg Click Share)
        const brandShares = {};
        marketData.forEach(d => {
            const b = d.competitor_brand || "Unknown";
            if (b === OUR_BRAND) return;
            if (!brandShares[b]) brandShares[b] = [];
            brandShares[b].push(d.click_share);
        });

        TOP_COMPETITORS = Object.keys(brandShares)
            .map(b => ({
                brand: b, 
                avgShare: brandShares[b].reduce((a,c)=>a+c,0)/brandShares[b].length
            }))
            .sort((a,b) => b.avgShare - a.avgShare)
            .slice(0, 3)
            .map(x => x.brand);
            
        // Calculate Summary Metrics for latest week
        const lastWeek = ALL_WEEKS[ALL_WEEKS.length-1];
        const lastWeekData = marketData.filter(d => d.week_date === lastWeek && d.competitor_brand === OUR_BRAND);
        
        if (lastWeekData.length > 0) {
            // Weighted averages if multiple keywords
            const totalClicks = lastWeekData.reduce((sum, d) => sum + (d.clicks || 0), 0);
            const totalVol = lastWeekData.reduce((sum, d) => sum + (d.weekly_search_volume || 0), 0);
            const avgPrice = lastWeekData.reduce((sum, d) => sum + d.price, 0) / lastWeekData.length;
            const avgRank = lastWeekData.reduce((sum, d) => sum + d.average_organic_rank, 0) / lastWeekData.length;
            
            // Calc Share properly
            const share = totalVol > 0 ? (totalClicks / totalVol) : 0;
            
            document.getElementById('m-share').innerText = (share * 100).toFixed(1) + '%';
            document.getElementById('m-rank').innerText = '#' + avgRank.toFixed(1);
            document.getElementById('m-price').innerText = '$' + avgPrice.toFixed(2);
            
            // Gap vs Top Competitor
            const topCompData = marketData.filter(d => d.week_date === lastWeek && d.competitor_brand === TOP_COMPETITORS[0]);
            if (topCompData.length > 0) {
                const compClicks = topCompData.reduce((s,d)=>s+d.clicks,0);
                const compVol = topCompData.reduce((s,d)=>s+d.weekly_search_volume,0);
                const compShare = compClicks/compVol;
                const gap = share - compShare;
                const gapEl = document.getElementById('m-comp-gap');
                gapEl.innerText = (gap * 100).toFixed(1) + '%';
                gapEl.style.color = gap >= 0 ? 'var(--secondary)' : 'var(--danger)';
            }
        }
    }

    // ---------------------------------------------------------
    // 3. CHART DRAWING FUNCTIONS
    // ---------------------------------------------------------

    function drawTrendChart() {
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Week');
        dataTable.addColumn('number', 'Total Market Clicks');
        dataTable.addColumn('number', `${OUR_BRAND} Share %`);

        const rows = ALL_WEEKS.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalClicks = weekData.reduce((sum, d) => sum + (d.clicks || 0), 0);
            
            const ourData = weekData.filter(d => d.competitor_brand === OUR_BRAND);
            const ourClicks = ourData.reduce((sum, d) => sum + (d.clicks || 0), 0);
            const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0; // Share of Clicks, not Share of Search Vol for this view
            
            return [week, totalClicks, ourShare];
        });

        dataTable.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
            colors: ['#E5E7EB'],
            legend: {position: 'top'},
            vAxes: {
                0: {title: 'Market Volume (Clicks)'},
                1: {title: 'Our Click Share (%)', format: '#\'%\''}
            },
            chartArea: {width: '85%', height: '70%'},
            animation: {startup: true, duration: 1000, easing: 'out'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(dataTable, options);
    }

    function drawBrandCompetitivenessChart() {
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Week');
        dataTable.addColumn('number', OUR_BRAND);
        TOP_COMPETITORS.forEach(c => dataTable.addColumn('number', c));

        const rows = ALL_WEEKS.map(week => {
            const row = [week];
            
            // Our Share
            const ourData = marketData.filter(d => d.week_date === week && d.competitor_brand === OUR_BRAND);
            const ourShare = ourData.length ? (ourData.reduce((s,d)=>s+d.click_share,0)/ourData.length)*100 : 0;
            row.push(ourShare);

            // Competitors Share
            TOP_COMPETITORS.forEach(comp => {
                const cData = marketData.filter(d => d.week_date === week && d.competitor_brand === comp);
                const cShare = cData.length ? (cData.reduce((s,d)=>s+d.click_share,0)/cData.length)*100 : null;
                row.push(cShare);
            });
            return row;
        });

        dataTable.addRows(rows);

        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'], // Blue for us, Google colors for others
            chartArea: {width: '85%', height: '75%'},
            legend: {position: 'top'},
            vAxis: {title: 'Click Share (%)'},
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand'));
        chart.draw(dataTable, options);
    }

    function drawEfficiencyChart() {
        const lastWeek = ALL_WEEKS[ALL_WEEKS.length-1];
        const weekData = marketData.filter(d => d.week_date === lastWeek);

        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('number', 'Organic Rank');
        dataTable.addColumn('number', 'Click Share (%)');
        dataTable.addColumn({type: 'string', role: 'style'}); // Color
        dataTable.addColumn({type: 'string', role: 'tooltip'});

        const rows = weekData.map(d => {
            const isUs = d.competitor_brand === OUR_BRAND;
            const color = isUs ? '#4285F4' : '#9CA3AF'; // Blue vs Gray
            const tooltip = `${d.competitor_brand}\nRank: ${d.average_organic_rank}\nShare: ${(d.click_share*100).toFixed(1)}%\nKW: ${d.keywords}`;
            return [d.average_organic_rank, d.click_share * 100, `point { fill-color: ${color}; size: ${isUs?10:5}; }`, tooltip];
        });

        dataTable.addRows(rows);

        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: -1, minValue: 1}, // Invert axis
            vAxis: {title: 'Click Share (%)', minValue: 0},
            legend: 'none',
            chartArea: {width: '85%', height: '80%'},
            colors: ['#4285F4']
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(dataTable, options);
    }

    function drawLeversChart() {
        // Impact of Price on Share for US vs Top Comp (Last Week)
        const lastWeek = ALL_WEEKS[ALL_WEEKS.length-1];
        
        // Simple visualization: Price vs Share Bars side by side
        const data = [
            ['Brand', 'Price ($)', 'Click Share (%)']
        ];

        [OUR_BRAND, ...TOP_COMPETITORS].forEach(brand => {
            const d = marketData.filter(x => x.week_date === lastWeek && x.competitor_brand === brand);
            if(d.length) {
                const avgPrice = d.reduce((s,x)=>s+x.price,0)/d.length;
                const avgShare = (d.reduce((s,x)=>s+x.click_share,0)/d.length)*100;
                data.push([brand, avgPrice, avgShare]);
            }
        });

        const dataTable = google.visualization.arrayToDataTable(data);

        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Price ($)'}, 1: {title: 'Share (%)'}},
            colors: ['#9CA3AF', '#4285F4'],
            legend: {position: 'bottom'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_levers'));
        chart.draw(dataTable, options);
    }

    // ---------------------------------------------------------
    // 4. INSIGHTS GENERATION (Rule Based)
    // ---------------------------------------------------------
    function generateInsights() {
        const ul = document.getElementById('insights-container');
        const recUl = document.getElementById('recommendations-container');
        let html = '';
        let recHtml = '';

        // 1. Trend Analysis
        const lastWeek = ALL_WEEKS[ALL_WEEKS.length-1];
        const prevWeek = ALL_WEEKS[ALL_WEEKS.length-2];
        
        const lastShare = getAvgShare(OUR_BRAND, lastWeek);
        const prevShare = getAvgShare(OUR_BRAND, prevWeek);
        
        if (lastShare > prevShare) {
            html += `<li class="insight-item"><span class="material-icons insight-icon" style="color:var(--secondary)">trending_up</span><div><strong>Momentum Gained:</strong> Share increased from ${(prevShare*100).toFixed(1)}% to ${(lastShare*100).toFixed(1)}% last week.</div></li>`;
        } else {
            html += `<li class="insight-item"><span class="material-icons insight-icon danger">trending_down</span><div><strong>Share Erosion:</strong> Share dropped to ${(lastShare*100).toFixed(1)}%. Immediate action needed.</div></li>`;
        }

        // 2. Price Check
        const compShare = getAvgShare(TOP_COMPETITORS[0], lastWeek);
        const myPrice = getAvgPrice(OUR_BRAND, lastWeek);
        const compPrice = getAvgPrice(TOP_COMPETITORS[0], lastWeek);
        
        if (myPrice < compPrice && lastShare < compShare) {
             html += `<li class="insight-item"><span class="material-icons insight-icon warning">price_check</span><div><strong>Inefficient Pricing:</strong> We are cheaper ($${myPrice}) than ${TOP_COMPETITORS[0]} ($${compPrice}) but have less share. Check content or badges.</div></li>`;
             recHtml += `<li class="insight-item"><span class="material-icons">inventory</span>Optimize Main Image and Title to improve CTR, as price is already competitive.</li>`;
        } else if (myPrice < compPrice && lastShare > compShare) {
            html += `<li class="insight-item"><span class="material-icons insight-icon" style="color:var(--secondary)">sell</span><div><strong>Price Strategy Winning:</strong> Lower price point is effectively capturing share from ${TOP_COMPETITORS[0]}.</div></li>`;
        }

        // 3. Deal Effectiveness
        const hasDeal = marketData.some(d => d.week_date === lastWeek && d.competitor_brand === OUR_BRAND && d.weekly_number_of_days_with_deal > 0);
        if (hasDeal && lastShare > prevShare) {
             html += `<li class="insight-item"><span class="material-icons insight-icon" style="color:var(--secondary)">local_offer</span><div><strong>Deal Success:</strong> Active deals in the last week correlate strongly with the share increase.</div></li>`;
             recHtml += `<li class="insight-item"><span class="material-icons">repeat</span>Extend successful deal mechanics to next week to maintain momentum.</li>`;
        }

        // General Recs
        recHtml += `<li class="insight-item"><span class="material-icons">search</span>Review keywords where Rank > 5 but Search Volume is high.</li>`;

        ul.innerHTML = html;
        recUl.innerHTML = recHtml;
    }

    function getAvgShare(brand, week) {
        const d = marketData.filter(x => x.week_date === week && x.competitor_brand === brand);
        if(!d.length) return 0;
        return d.reduce((s,x)=>s+x.click_share,0)/d.length;
    }
    function getAvgPrice(brand, week) {
        const d = marketData.filter(x => x.week_date === week && x.competitor_brand === brand);
        if(!d.length) return 0;
        return d.reduce((s,x)=>s+x.price,0)/d.length;
    }

    // ---------------------------------------------------------
    // 5. INTERACTIVE COMPARATOR LOGIC
    // ---------------------------------------------------------
    function setupControls() {
        const weekSel = document.getElementById('comp-week-select');
        ALL_WEEKS.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.appendChild(opt);
        });
        weekSel.value = ALL_WEEKS[ALL_WEEKS.length-1]; // Select latest

        const brandSel = document.getElementById('comp-brand-select');
        TOP_COMPETITORS.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            brandSel.appendChild(opt);
        });
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        if(tabId === 'comparator') updateComparator();
    }

    function updateComparator() {
        const week = document.getElementById('comp-week-select').value;
        const comp = document.getElementById('comp-brand-select').value;
        if (!week || !comp) return;

        // Draw Price Comparison
        const priceData = google.visualization.arrayToDataTable([
            ['Brand', 'Price', { role: 'style' }],
            [OUR_BRAND, getAvgPrice(OUR_BRAND, week), '#4285F4'],
            [comp, getAvgPrice(comp, week), '#EA4335']
        ]);
        new google.visualization.BarChart(document.getElementById('comp_chart_price')).draw(priceData, {legend:'none', hAxis:{title:'Price ($)'}});

        // Draw Share Comparison
        const shareData = google.visualization.arrayToDataTable([
            ['Brand', 'Share', { role: 'style' }],
            [OUR_BRAND, getAvgShare(OUR_BRAND, week)*100, '#4285F4'],
            [comp, getAvgShare(comp, week)*100, '#EA4335']
        ]);
        new google.visualization.BarChart(document.getElementById('comp_chart_share')).draw(shareData, {legend:'none', hAxis:{title:'Share (%)'}});

        // Draw Detailed Table
        const ourItems = marketData.filter(d => d.week_date === week && d.competitor_brand === OUR_BRAND);
        const compItems = marketData.filter(d => d.week_date === week && d.competitor_brand === comp);

        const tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'Keyword');
        tableData.addColumn('number', `Rank (${OUR_BRAND})`);
        tableData.addColumn('number', `Rank (${comp})`);
        tableData.addColumn('string', 'Gap');

        // Join on keyword
        const rows = [];
        ourItems.forEach(ourItem => {
            const compItem = compItems.find(c => c.keywords === ourItem.keywords);
            if (compItem) {
                const gap = compItem.average_organic_rank - ourItem.average_organic_rank;
                const gapStr = gap > 0 ? `+${gap} (Winning)` : `${gap} (Losing)`;
                rows.push([ourItem.keywords, ourItem.average_organic_rank, compItem.average_organic_rank, gapStr]);
            }
        });
        tableData.addRows(rows);

        const table = new google.visualization.Table(document.getElementById('comp_table_div'));
        table.draw(tableData, {showRowNumber: true, width: '100%', height: '100%'});
    }

</script>

</body>
</html>