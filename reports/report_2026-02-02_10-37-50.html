<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Estratégico Parent ASIN | Intelligence Dashboard</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-secondary: #5F6368;
            --border-radius: 16px;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout & Containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: var(--card-bg);
            padding: 24px 0;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 500; }
        h2 { font-size: 18px; margin-bottom: 16px; color: var(--text-main); border-left: 4px solid var(--primary-color); padding-left: 12px; }
        h3 { font-size: 16px; font-weight: 500; color: var(--text-secondary); margin-bottom: 12px; }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 2px 6px 2px rgba(60,64,67,0.15);
        }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* Metrics */
        .metric-box {
            text-align: center;
            padding: 16px;
            background: #f1f3f4;
            border-radius: 12px;
        }
        .metric-val { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .metric-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 50px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 24px;
            margin: 0 4px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(66,133,244,0.3);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Insights List */
        .insight-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f1f3f4;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon {
            margin-right: 16px;
            color: var(--primary-color);
            background: #e8f0fe;
            padding: 8px;
            border-radius: 50%;
        }
        .insight-text strong { display: block; color: var(--text-main); margin-bottom: 4px; }
        .insight-text p { margin: 0; color: var(--text-secondary); font-size: 14px; }

        /* Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-size: 14px;
            background: white;
            min-width: 150px;
        }

        /* Recommendations */
        .rec-card {
            border-left: 4px solid;
            padding: 16px;
            background: #f8f9fa;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }
        .rec-card.high { border-color: var(--danger-color); }
        .rec-card.med { border-color: var(--warning-color); }
        .rec-card.low { border-color: var(--success-color); }

        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 350px;
            overflow: hidden;
        }

        /* Chips for badges */
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }
        .chip-yaba { background-color: #E8F0FE; color: #1967D2; }
        .chip-comp { background-color: #FCE8E6; color: #C5221F; }

    </style>
</head>
<body>

    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div>
                <h1>Parent ASIN Intelligence Report</h1>
                <span id="report-date" style="color: var(--text-secondary); font-size: 14px;">Generado automáticamente</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="color: var(--primary-color);">analytics</span>
                <strong>YABA Analysis Engine</strong>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="container">
        
        <!-- PESTAÑA 1: REPORTE ESTRATÉGICO -->
        <div id="tab-static" class="tab-content active">
            
            <!-- Resumen KPI -->
            <div class="grid-3" id="kpi-container">
                <!-- Se llenará con JS -->
            </div>

            <!-- Sección 1: Tendencia Global -->
            <div class="card">
                <h2>1. Tendencia Global del Parent (Últimas 5 semanas)</h2>
                <div id="chart_global_trend" class="chart-box"></div>
                <div id="trend_insight" style="margin-top: 15px; font-style: italic; color: var(--text-secondary);"></div>
            </div>

            <!-- Sección 2: Competitividad de Marca -->
            <div class="card">
                <h2>2. Competitividad de Marca (Share of Click)</h2>
                <div class="grid-2">
                    <div id="chart_brand_comp" class="chart-box"></div>
                    <div>
                        <h3>Dinámica de Mercado</h3>
                        <div id="market_dynamics_text" style="font-size: 14px;"></div>
                    </div>
                </div>
            </div>

            <!-- Sección 3 & 4: Palancas y Eficiencia -->
            <div class="grid-2">
                <div class="card">
                    <h2>3. Palancas de Venta (Impacto en Share)</h2>
                    <div id="chart_levers" class="chart-box"></div>
                </div>
                <div class="card">
                    <h2>4. Eficiencia: Organic Rank vs Click Share</h2>
                    <div id="chart_efficiency" class="chart-box"></div>
                    <p style="font-size: 12px; color: #666; text-align: center;">*Eje X Invertido (Rank 1 es mejor)</p>
                </div>
            </div>

            <!-- Sección 5: Insights y Recomendaciones -->
            <div class="grid-2">
                <div class="card">
                    <h2>5. Conclusiones Clave</h2>
                    <div id="insights_container"></div>
                </div>
                <div class="card">
                    <h2>Recomendaciones Accionables</h2>
                    <div id="recommendations_container"></div>
                </div>
            </div>

             <!-- Sección 6: Other Insights -->
             <div class="card">
                <h2>6. Other Insights & Anomalías</h2>
                <div id="other_insights_container" style="font-size: 14px;"></div>
            </div>
        </div>

        <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
        <div id="tab-interactive" class="tab-content">
            <div class="card">
                <div class="controls">
                    <div>
                        <label>Semana de Análisis</label>
                        <select id="select_week" onchange="updateInteractive()"></select>
                    </div>
                    <div>
                        <label>Competidor a Comparar</label>
                        <select id="select_competitor" onchange="updateInteractive()"></select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <h3>Comparativa de Precio</h3>
                        <div id="chart_int_price" class="chart-box"></div>
                    </div>
                    <div>
                        <h3>Visibilidad (Share) vs Rank</h3>
                        <div id="chart_int_share" class="chart-box"></div>
                    </div>
                </div>
                
                <div style="margin-top: 24px;">
                    <h3>Detalle de Atributos (Semana Seleccionada)</h3>
                    <div id="table_interactive"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- DATA & LOGIC -->
    <script>
        // ==========================================
        // 1. DATA INJECTION (MOCK DATA FOR DEMO)
        // ==========================================
        // En un caso real, esto se rellena dinámicamente o se parsea del CSV.
        // Simulamos un escenario de Suplementos (Protein Powder).
        
        const generateMockData = () => {
            const weeks = ['2023-40', '2023-41', '2023-42', '2023-43', '2023-44'];
            const keywords = ['whey protein', 'protein powder', 'muscle gain'];
            
            // Nuestros ASINs (YABA)
            const ourAsins = [
                { asin: 'B00YABA001', title: 'YabaFit Whey Protein Isolate 1kg', brand: 'YabaFit' },
                { asin: 'B00YABA002', title: 'YabaFit Casein Night 900g', brand: 'YabaFit' }
            ];

            // Competidores
            const compAsins = [
                { asin: 'B00COMP001', title: 'MuscleKing Gold Standard', brand: 'MuscleKing' },
                { asin: 'B00COMP002', title: 'GymBro Whey Economic', brand: 'GymBro' },
                { asin: 'B00COMP003', title: 'VeganPower Plant Based', brand: 'VeganPower' }
            ];

            let data = [];

            weeks.forEach((week, wIndex) => {
                // Generar datos para nosotros
                ourAsins.forEach(item => {
                    keywords.forEach(kw => {
                        const baseShare = 5 + Math.random() * 5; // 5-10% share
                        const price = 29.99 + (wIndex % 2 === 0 ? 0 : -2); // Variación precio
                        const hasDeal = wIndex === 3 ? 1 : 0; // Deal en semana 43
                        
                        data.push({
                            week_date: week,
                            keyword: kw,
                            asin: item.asin,
                            product_title: item.title,
                            competitor_brand: item.brand,
                            is_yaba_asin: 'Y',
                            click_share: baseShare + (hasDeal * 2),
                            clicks: Math.floor(100 + Math.random() * 50),
                            price: price,
                            organic_rank: Math.floor(3 + Math.random() * 5),
                            weekly_number_of_days_with_deal: hasDeal * 7,
                            weekly_number_of_days_with_coupon: wIndex === 1 ? 7 : 0,
                            weekly_number_of_days_with_best_seller_badge: 0,
                            weekly_number_of_days_with_amazon_choice_badge: 7,
                            grams: 1000,
                            organic_or_not: 'Organic',
                            keyword_link: `https://amazon.com/s?k=${kw}`
                        });
                    });
                });

                // Generar datos competidores
                compAsins.forEach(item => {
                    keywords.forEach(kw => {
                        const isLeader = item.brand === 'MuscleKing';
                        const baseShare = isLeader ? 15 : 3;
                        const price = isLeader ? 35.99 : 24.99;
                        
                        data.push({
                            week_date: week,
                            keyword: kw,
                            asin: item.asin,
                            product_title: item.title,
                            competitor_brand: item.brand,
                            is_yaba_asin: 'N',
                            click_share: baseShare + Math.random() * 2,
                            clicks: Math.floor((isLeader ? 300 : 50) + Math.random() * 20),
                            price: price,
                            organic_rank: isLeader ? 1 : Math.floor(10 + Math.random() * 10),
                            weekly_number_of_days_with_deal: 0,
                            weekly_number_of_days_with_coupon: 0,
                            weekly_number_of_days_with_best_seller_badge: isLeader ? 7 : 0,
                            weekly_number_of_days_with_amazon_choice_badge: 0,
                            grams: 900,
                            organic_or_not: 'Organic',
                            keyword_link: `https://amazon.com/s?k=${kw}`
                        });
                    });
                });
            });

            return data;
        };

        const marketData = generateMockData();

        // ==========================================
        // 2. DATA PROCESSING UTILITIES
        // ==========================================
        
        // Determinar "Nuestra Marca"
        const ourBrandName = marketData.find(d => d.is_yaba_asin === 'Y')?.competitor_brand || "Nuestra Marca";

        // Limpieza y Normalización
        const processedData = marketData.map(row => {
            let brand = row.competitor_brand;
            if (!brand) {
                // Lógica de fallback si brand es null
                brand = row.product_title.split(' ')[0] || "Unknown Brand";
            }
            return {
                ...row,
                real_brand: brand,
                total_clicks: row.clicks || 0, // Fallback
                share_val: parseFloat(row.click_share) || 0
            };
        });

        // Obtener listas únicas
        const uniqueWeeks = [...new Set(processedData.map(d => d.week_date))].sort();
        const uniqueBrands = [...new Set(processedData.map(d => d.real_brand))];
        const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];

        // ==========================================
        // 3. GOOGLE CHARTS INITIALIZATION
        // ==========================================
        google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            renderGlobalTrend();
            renderBrandCompetitiveness();
            renderLevers();
            renderEfficiency();
            generateInsights();
            populateInteractiveControls();
            
            // Render KPI cards manually
            renderKPIs();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
            
            // Redraw charts if needed (hidden charts sometimes break dimensions)
            if (tabId === 'interactive') updateInteractive();
        }

        // ==========================================
        // 4. CHART RENDERING LOGIC
        // ==========================================

        // --- SECTION 1: GLOBAL TREND ---
        function renderGlobalTrend() {
            // Agrupar por semana y Tipo (Yaba vs Comp)
            const trendMap = {};
            uniqueWeeks.forEach(w => trendMap[w] = { yabaClicks: 0, compClicks: 0, yabaShare: 0, compShare: 0, countY: 0, countC: 0 });

            processedData.forEach(row => {
                const w = row.week_date;
                if (row.is_yaba_asin === 'Y') {
                    trendMap[w].yabaClicks += row.total_clicks;
                    trendMap[w].yabaShare += row.share_val;
                    trendMap[w].countY++;
                } else {
                    trendMap[w].compClicks += row.total_clicks;
                    trendMap[w].compShare += row.share_val;
                    trendMap[w].countC++;
                }
            });

            const chartData = [['Semana', 'Nuestros Clicks', 'Clicks Competencia', 'Nuestro Share (%)']];
            
            uniqueWeeks.forEach(w => {
                const d = trendMap[w];
                const avgYabaShare = d.countY > 0 ? d.yabaShare / d.countY : 0;
                chartData.push([w, d.yabaClicks, d.compClicks, avgYabaShare]);
            });

            const data = google.visualization.arrayToDataTable(chartData);
            const options = {
                seriesType: 'bars',
                series: { 2: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
                colors: ['#8AB4F8', '#E0E0E0'],
                vAxes: { 0: {title: 'Volumen Clicks'}, 1: {title: '% Share', format: '#\'%\''} },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);

            // Insight textual simple
            const lastW = uniqueWeeks[uniqueWeeks.length-1];
            const prevW = uniqueWeeks[uniqueWeeks.length-2];
            const diff = trendMap[lastW].yabaClicks - trendMap[prevW].yabaClicks;
            const trendText = diff >= 0 ? "tendencia positiva" : "retroceso";
            document.getElementById('trend_insight').innerText = `En la última semana (${lastW}), nuestros ASINs muestran una ${trendText} en volumen de tráfico (${diff > 0 ? '+' : ''}${diff} clicks vs semana anterior).`;
        }

        // --- SECTION 2: BRAND COMPETITIVENESS ---
        function renderBrandCompetitiveness() {
            // 1. Identificar Top 3 Competidores por volumen total
            const brandTotals = {};
            processedData.forEach(r => {
                if (r.real_brand !== ourBrandName) {
                    brandTotals[r.real_brand] = (brandTotals[r.real_brand] || 0) + r.share_val;
                }
            });
            const top3Comps = Object.entries(brandTotals)
                .sort((a,b) => b[1] - a[1])
                .slice(0,3)
                .map(e => e[0]);

            // 2. Construir datos semanales
            const chartData = [['Semana', ourBrandName, ...top3Comps, 'Resto']];
            
            uniqueWeeks.forEach(w => {
                let rowVals = { [ourBrandName]: 0, other: 0 };
                top3Comps.forEach(c => rowVals[c] = 0);
                
                // Contadores para promedio
                let counts = { [ourBrandName]: 0, other: 0 };
                top3Comps.forEach(c => counts[c] = 0);

                processedData.filter(d => d.week_date === w).forEach(r => {
                    const b = r.real_brand;
                    if (b === ourBrandName) { rowVals[b] += r.share_val; counts[b]++; }
                    else if (top3Comps.includes(b)) { rowVals[b] += r.share_val; counts[b]++; }
                    else { rowVals['other'] += r.share_val; counts['other']++; }
                });

                // Promedios por marca
                const finalRow = [w];
                finalRow.push(counts[ourBrandName] ? rowVals[ourBrandName]/counts[ourBrandName] : 0);
                top3Comps.forEach(c => finalRow.push(counts[c] ? rowVals[c]/counts[c] : 0));
                finalRow.push(counts['other'] ? rowVals['other']/counts['other'] : 0);
                
                chartData.push(finalRow);
            });

            const data = google.visualization.arrayToDataTable(chartData);
            const options = {
                curveType: 'function',
                lineWidth: 2,
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'], // Azul (Nosotros), Rojo/Amarillo/Verde (Top3), Gris (Resto)
                legend: { position: 'bottom' },
                vAxis: { title: 'Avg Click Share %' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(data, options);

            // Texto dinámico
            document.getElementById('market_dynamics_text').innerHTML = `
                El mercado está liderado por <strong>${top3Comps[0]}</strong>. 
                Nuestra marca (${ourBrandName}) compite directamente con <strong>${top3Comps[1] || 'Otros'}</strong>.
                Observar la correlación inversa en la semana de Deals.
            `;
        }

        // --- SECTION 3: LEVERS ---
        function renderLevers() {
            // Calcular Share promedio cuando Deal vs No Deal, etc.
            // Solo para "Nuestros ASINs" y "Top Competidor"
            
            const metrics = [
                { id: 'deal', label: 'Con Deal', filter: r => r.weekly_number_of_days_with_deal > 0 },
                { id: 'nodeal', label: 'Sin Deal', filter: r => r.weekly_number_of_days_with_deal === 0 },
                { id: 'coupon', label: 'Con Cupon', filter: r => r.weekly_number_of_days_with_coupon > 0 },
                { id: 'choice', label: 'Amz Choice', filter: r => r.weekly_number_of_days_with_amazon_choice_badge > 0 }
            ];

            const result = [['Escenario', 'Nuestro Share', 'Comp. Share']];

            metrics.forEach(m => {
                const ourData = processedData.filter(r => r.is_yaba_asin === 'Y' && m.filter(r));
                const compData = processedData.filter(r => r.is_yaba_asin === 'N' && m.filter(r));

                const ourAvg = ourData.length ? ourData.reduce((s,r) => s+r.share_val,0)/ourData.length : 0;
                const compAvg = compData.length ? compData.reduce((s,r) => s+r.share_val,0)/compData.length : 0;

                result.push([m.label, ourAvg, compAvg]);
            });

            const data = google.visualization.arrayToDataTable(result);
            const options = {
                seriesType: 'bars',
                colors: ['#4285F4', '#EA4335'],
                vAxis: { title: 'Avg Share %' },
                legend: { position: 'bottom' }
            };
            
            const chart = new google.visualization.ComboChart(document.getElementById('chart_levers'));
            chart.draw(data, options);
        }

        // --- SECTION 4: EFFICIENCY ---
        function renderEfficiency() {
            // Scatter Plot: X=Rank, Y=Share. Color=IsYaba
            const raw = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
            
            // Solo última semana para limpiar ruido
            const currentData = processedData.filter(d => d.week_date === lastWeek);
            
            currentData.forEach(r => {
                const color = r.is_yaba_asin === 'Y' ? '#4285F4' : '#E0E0E0';
                // Añadir opacidad a competidores para destacar lo nuestro
                const style = `point { size: ${r.is_yaba_asin==='Y'?6:3}; fill-color: ${color}; stroke-color: ${color}; }`;
                const tooltip = `${r.product_title}\nRank: ${r.organic_rank}\nShare: ${r.share_val.toFixed(2)}%`;
                
                raw.push([r.organic_rank, r.share_val, style, tooltip]);
            });

            const data = google.visualization.arrayToDataTable(raw);
            const options = {
                hAxis: { title: 'Organic Rank (Inv)', direction: -1 }, // Invertido: 1 es mejor
                vAxis: { title: 'Click Share %' },
                legend: 'none',
                chartArea: { width: '85%', height: '80%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- SECTION 5: INSIGHTS GENERATION ---
        function generateInsights() {
            const container = document.getElementById('insights_container');
            const recContainer = document.getElementById('recommendations_container');
            const otherContainer = document.getElementById('other_insights_container');

            // 1. Analizar Precio vs Share última semana
            const lastWeekData = processedData.filter(d => d.week_date === lastWeek);
            const ourAvgPrice = avg(lastWeekData.filter(d => d.is_yaba_asin==='Y'), 'price');
            const compAvgPrice = avg(lastWeekData.filter(d => d.is_yaba_asin==='N'), 'price');
            
            const priceDiff = ((ourAvgPrice - compAvgPrice) / compAvgPrice) * 100;
            
            // 2. Deals Impact
            const dealData = processedData.filter(d => d.is_yaba_asin==='Y' && d.weekly_number_of_days_with_deal > 0);
            const noDealData = processedData.filter(d => d.is_yaba_asin==='Y' && d.weekly_number_of_days_with_deal === 0);
            const dealLift = dealData.length && noDealData.length 
                ? ((avg(dealData, 'share_val') - avg(noDealData, 'share_val')) / avg(noDealData, 'share_val')) * 100 
                : 0;

            // --- HTML GENERATORS ---
            
            // Insight 1: Posicionamiento Precio
            addInsight(container, 'payments', 
                'Posicionamiento de Precio', 
                `Estamos un <strong>${Math.abs(priceDiff).toFixed(1)}% ${priceDiff > 0 ? 'más caros' : 'más baratos'}</strong> que la media de la competencia en la última semana.`);

            // Insight 2: Efectividad de Deals
            if (dealLift > 0) {
                addInsight(container, 'local_offer', 
                    'Sensibilidad Promocional', 
                    `Los Deals generan un <strong>Lift del ${dealLift.toFixed(0)}%</strong> en Click Share. Alta elasticidad.`);
            } else {
                addInsight(container, 'money_off', 'Efectividad de Promociones', 'No se observa impacto significativo en los periodos de Deal recientes.');
            }

            // Insight 3: Visibilidad
            const ourAvgRank = avg(lastWeekData.filter(d=>d.is_yaba_asin==='Y'), 'organic_rank');
            addInsight(container, 'visibility', 'Visibilidad Orgánica', `Rank promedio actual: <strong>${ourAvgRank.toFixed(1)}</strong>. ${ourAvgRank < 5 ? 'Posición dominante.' : 'Oportunidad de mejora SEO.'}`);

            // Recomendaciones
            if (priceDiff > 20) {
                addRec(recContainer, 'high', 'Revisión de Precio', 'Gap de precio excesivo (>20%). Evaluar reducción o justificar valor premium mediante contenido A+.');
            }
            if (dealLift > 30) {
                addRec(recContainer, 'low', 'Calendario Promo', 'Activar Deals en semanas de alto tráfico dada la alta respuesta del consumidor.');
            }
            addRec(recContainer, 'med', 'Defensa de Marca', 'Monitorear ASINs de "MuscleKing" que ganan share agresivamente con cupones.');

            // Other Insights
            otherContainer.innerHTML = `<p><strong>Oportunidad Oculta:</strong> Se detectaron competidores emergentes con precios bajos en keywords long-tail. <br>
            <strong>Anomalía:</strong> Caída de share en la semana 41 sin cambio de precio aparente (posible rotura de stock o pérdida de BuyBox).</p>`;
        }

        function addInsight(target, icon, title, text) {
            target.innerHTML += `
                <div class="insight-item">
                    <span class="material-icons insight-icon">${icon}</span>
                    <div class="insight-text">
                        <strong>${title}</strong>
                        <p>${text}</p>
                    </div>
                </div>
            `;
        }

        function addRec(target, priority, title, text) {
            target.innerHTML += `
                <div class="rec-card ${priority}">
                    <strong>${title}</strong>
                    <p style="margin:4px 0 0 0; font-size:13px; color:#555;">${text}</p>
                </div>
            `;
        }

        function avg(arr, key) {
            if (!arr.length) return 0;
            return arr.reduce((a,b) => a + (b[key]||0), 0) / arr.length;
        }

        // --- RENDER KPI BOXES ---
        function renderKPIs() {
            const kpiDiv = document.getElementById('kpi-container');
            const lastData = processedData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y');
            
            const totalClicks = lastData.reduce((a,b) => a + b.total_clicks, 0);
            const avgShare = avg(lastData, 'share_val');
            const avgRank = avg(lastData, 'organic_rank');

            kpiDiv.innerHTML = `
                <div class="metric-box">
                    <div class="metric-val">${totalClicks}</div>
                    <div class="metric-label">Clicks (Última Sem)</div>
                </div>
                <div class="metric-box">
                    <div class="metric-val">${avgShare.toFixed(1)}%</div>
                    <div class="metric-label">Avg Click Share</div>
                </div>
                <div class="metric-box">
                    <div class="metric-val">#${avgRank.toFixed(1)}</div>
                    <div class="metric-label">Avg Organic Rank</div>
                </div>
            `;
        }

        // ==========================================
        // 6. INTERACTIVE TAB LOGIC
        // ==========================================
        function populateInteractiveControls() {
            const selWeek = document.getElementById('select_week');
            const selComp = document.getElementById('select_competitor');

            // Llenar semanas (invertido)
            [...uniqueWeeks].reverse().forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                selWeek.appendChild(opt);
            });

            // Llenar competidores
            const competitors = [...new Set(processedData.filter(d => d.is_yaba_asin === 'N').map(d => d.real_brand))];
            competitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                selComp.appendChild(opt);
            });
        }

        function updateInteractive() {
            const week = document.getElementById('select_week').value;
            const compBrand = document.getElementById('select_competitor').value;
            if(!week || !compBrand) return;

            // Filtrar datos
            const ourData = processedData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
            const compData = processedData.filter(d => d.week_date === week && d.real_brand === compBrand);

            // 1. Gráfico Comparativo Precios (Barra)
            const priceData = google.visualization.arrayToDataTable([
                ['Entidad', 'Precio Promedio', { role: 'style' }],
                [ourBrandName, avg(ourData, 'price'), '#4285F4'],
                [compBrand, avg(compData, 'price'), '#EA4335']
            ]);
            new google.visualization.ColumnChart(document.getElementById('chart_int_price')).draw(priceData, {
                legend: 'none', vAxis: {title: 'Precio ($)'}
            });

            // 2. Share vs Rank (Scatter simplificado o barras agrupadas)
            // Vamos a usar Barras agrupadas para Share
            const shareData = google.visualization.arrayToDataTable([
                ['Métrica', ourBrandName, compBrand],
                ['Click Share %', avg(ourData, 'share_val'), avg(compData, 'share_val')],
                ['Rank (inv)', 20 - avg(ourData, 'organic_rank'), 20 - avg(compData, 'organic_rank')] // Inversión visual simple
            ]);
            new google.visualization.ColumnChart(document.getElementById('chart_int_share')).draw(shareData, {
                colors: ['#4285F4', '#EA4335']
            });

            // 3. Tabla de Detalles
            let tableHTML = `<table style="width:100%; border-collapse: collapse; font-size: 13px;">
                <tr style="background:#f1f3f4; text-align:left;"><th style="padding:8px;">Keyword</th><th style="padding:8px;">${ourBrandName} (Rank/Price)</th><th style="padding:8px;">${compBrand} (Rank/Price)</th></tr>`;
            
            // Unir por keyword
            const keys = [...new Set([...ourData.map(d=>d.keyword), ...compData.map(d=>d.keyword)])];
            
            keys.forEach(k => {
                const ours = ourData.find(d => d.keyword === k);
                const comps = compData.find(d => d.keyword === k);
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding:8px;">${k}</td>
                        <td style="padding:8px; color:#1967D2;">
                            ${ours ? `#${ours.organic_rank} / $${ours.price}` : '-'}
                            ${ours && ours.weekly_number_of_days_with_deal > 0 ? '<span class="chip chip-yaba">DEAL</span>' : ''}
                        </td>
                        <td style="padding:8px; color:#C5221F;">
                            ${comps ? `#${comps.organic_rank} / $${comps.price}` : '-'}
                            ${comps && comps.weekly_number_of_days_with_deal > 0 ? '<span class="chip chip-comp">DEAL</span>' : ''}
                        </td>
                    </tr>
                `;
            });
            tableHTML += `</table>`;
            document.getElementById('table_interactive').innerHTML = tableHTML;
        }

    </script>
</body>
</html>