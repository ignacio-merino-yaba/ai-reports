<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence: Parent ASIN Report</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* CSS Reset & Google Material-like Styles */
        :root {
            --primary: #4285F4;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray-100: #F1F3F4;
            --gray-300: #DADCE0;
            --text-main: #202124;
            --text-sec: #5F6368;
            --font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: #F8F9FA;
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            margin-bottom: 24px;
        }
        h1 {
            font-size: 28px;
            font-weight: 400;
            margin: 0;
            color: var(--text-main);
        }
        .subtitle {
            color: var(--text-sec);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-300);
            padding-bottom: 12px;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-sec);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background-color: #E8F0FE;
            color: var(--primary);
        }
        .tab-btn:hover:not(.active) {
            background-color: var(--gray-100);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
        }
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-100);
        }
        .insight-icon {
            color: var(--primary);
        }
        .rec-tag {
            background: #E6F4EA;
            color: var(--success);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }

        /* Metrics */
        .metric-big {
            font-size: 32px;
            font-weight: 400;
            color: var(--primary);
        }
        .metric-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-sec);
        }

        /* Comparator Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--gray-100);
            padding: 16px;
            border-radius: 8px;
        }
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--gray-300);
            font-family: inherit;
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 400px;
        }
        
        /* Helper Utilities */
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Parent ASIN Analysis Report</h1>
        <div class="subtitle">Generated automatically based on weekly performance data.</div>
    </header>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">
            <span class="material-icons" style="font-size:16px; vertical-align:text-bottom;">analytics</span>
            Strategic Analysis
        </button>
        <button class="tab-btn" onclick="switchTab('interactive')">
            <span class="material-icons" style="font-size:16px; vertical-align:text-bottom;">compare_arrows</span>
            Interactive Comparator
        </button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">show_chart</span>
                    1. Global Parent Trend (Market Traction)
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="subtitle" style="margin-top:10px;">
                *Bars represent Absolute Clicks. The Line represents Total Click Share %.
            </div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Brand Competitiveness (Share of Voice)
                </div>
            </div>
            <div id="chart_share" class="chart-container"></div>
        </div>

        <div class="grid-2">
            <!-- Section 3: Drivers -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">tune</span>
                        3. Growth Drivers (Last 4 Weeks)
                    </div>
                </div>
                <div id="chart_drivers" style="height: 300px;"></div>
                <div style="font-size: 13px; color: var(--text-sec); margin-top: 8px;">
                    Compares average Click Share when specific levers (Deals, Coupons, Badges) are active vs inactive.
                </div>
            </div>

            <!-- Section 4: Efficiency -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">scatter_plot</span>
                        4. Organic Rank Efficiency
                    </div>
                </div>
                <div id="chart_scatter" style="height: 300px;"></div>
                <div style="font-size: 13px; color: var(--text-sec); margin-top: 8px;">
                    X-Axis: Organic Rank (Inverted). Y-Axis: Click Share. Points above the trendline are "Overperformers".
                </div>
            </div>
        </div>

        <!-- Section 5: Insights & Recommendations -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Key Insights & Actionable Recommendations
                </div>
            </div>
            <ul id="insights_container" class="insight-list">
                <!-- Javascript will populate this -->
            </ul>
        </div>
        
        <!-- Section 6: Other Insights -->
        <div class="card">
             <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">search</span>
                    6. Other Market Patterns
                </div>
            </div>
            <div id="other_insights" style="font-size: 14px; color: var(--text-main);"></div>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Head-to-Head Comparator</div>
            </div>
            <div class="controls">
                <div>
                    <label style="display:block; font-size:12px; margin-bottom:4px;">Select Week</label>
                    <select id="sel_week" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="display:block; font-size:12px; margin-bottom:4px;">Select Competitor</label>
                    <select id="sel_competitor" onchange="updateComparator()"></select>
                </div>
            </div>
            
            <div id="comparator_output" class="grid-2">
                <!-- Dynamic Content -->
            </div>
            <div id="chart_comparator" class="chart-container" style="height:300px; margin-top:24px;"></div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION
    // ---------------------------------------------------------
    const marketData = [{"week": "2025-51", "brand": "NaturaleBio", "asin": "B079VQ52MK", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 2245.55, "org_rank": 5.0, "price": 23.075714286, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "VAHDAM", "asin": "B07MD4LB49", "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "is_yaba": "N", "clicks": 2123.84, "org_rank": 8.0, "price": 9.005714286, "has_deal": 1, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "Matcha", "asin": "B0DRP6Y6XC", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "is_yaba": "N", "clicks": 2117.76, "org_rank": 14.0, "price": 10.44, "has_deal": 0, "has_coupon": 1, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 6803.6, "org_rank": 2.0, "price": 14.084285714, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "is_yaba": "N", "clicks": 10138.46, "org_rank": 2.0, "price": 24.03, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 1, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "NaturaleBio", "asin": "B06XQ69YCQ", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 2342.92, "org_rank": 5.0, "price": 9.2, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "Jean", "asin": "B0F5BVFRC1", "title": "Jean & Len Handcreme I Love You So Matcha, f\u00fcr nor...", "is_yaba": "N", "clicks": 1168.42, "org_rank": 12.0, "price": 3.095714286, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "Ceremonial", "asin": "B0G1T7N675", "title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "is_yaba": "N", "clicks": 1557.89, "org_rank": 12.0, "price": 8.898571429, "has_deal": 1, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "Special Leaves", "asin": "B0DRP6Y6XC", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "is_yaba": "N", "clicks": 2117.76, "org_rank": 14.0, "price": 10.44, "has_deal": 0, "has_coupon": 1, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba": "N", "clicks": 5385.68, "org_rank": 5.0, "price": 15.635714286, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "NaturaleBio", "asin": "B07SZFD3P9", "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "is_yaba": "Y", "clicks": 1795.23, "org_rank": 22.0, "price": 26.748571429, "has_deal": 1, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-51", "brand": "Ceremonial", "asin": "B0FSL3C3Z8", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba": "N", "clicks": 5385.68, "org_rank": 5.0, "price": 15.635714286, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 43182.78}, {"week": "2025-52", "brand": "Special Leaves", "asin": "B0DRP6Y6XC", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "is_yaba": "N", "clicks": 1622.07, "org_rank": 13.0, "price": 10.71, "has_deal": 0, "has_coupon": 1, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "NaturaleBio", "asin": "B079VQ52MK", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 1665.01, "org_rank": 5.0, "price": 24.855714286, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "NaturaleBio", "asin": "B06XQ69YCQ", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 1789.05, "org_rank": 4.0, "price": 10.538571429, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 5562.76, "org_rank": 2.0, "price": 15.058571429, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "NaturaleBio", "asin": "B07SZFD3P9", "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "is_yaba": "Y", "clicks": 1397.85, "org_rank": 23.0, "price": 30.704285714, "has_deal": 1, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "VAHDAM", "asin": "B07MD4LB49", "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "is_yaba": "N", "clicks": 1998.97, "org_rank": 7.0, "price": 9.895714286, "has_deal": 1, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "VAHDAM", "asin": "B07K1WBH4K", "title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "is_yaba": "N", "clicks": 701.31, "org_rank": 20.0, "price": 9.895714286, "has_deal": 1, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "Ceremonial", "asin": "B0FSL3C3Z8", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba": "N", "clicks": 4017.02, "org_rank": 6.0, "price": 16.037142857, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba": "N", "clicks": 4017.02, "org_rank": 6.0, "price": 16.037142857, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "Bio", "asin": "B08XVX8V1T", "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "is_yaba": "N", "clicks": 1164.08, "org_rank": 10.0, "price": 12.367142857, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "bioKontor", "asin": "B08XVX8V1T", "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "is_yaba": "N", "clicks": 1164.08, "org_rank": 10.0, "price": 12.367142857, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "Matcha", "asin": "B0DRP6Y6XC", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "is_yaba": "N", "clicks": 1622.07, "org_rank": 13.0, "price": 10.71, "has_deal": 0, "has_coupon": 1, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 35676.09}, {"week": "2025-52", "brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "is_yaba": "N", "clicks": 8954.8, "org_rank": 2.0, "price": 24.648571429, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 1, "market_clicks": 35676.09}, {"week": "2026-01", "brand": "Matcha", "asin": "B0DRP6Y6XC", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "is_yaba": "N", "clicks": 810.33, "org_rank": 16.0, "price": 10.39, "has_deal": 0, "has_coupon": 1, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "bioKontor", "asin": "B08XVX8V1T", "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "is_yaba": "N", "clicks": 645.57, "org_rank": 10.0, "price": 11.9975, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "VAHDAM", "asin": "B07MD4LB49", "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "is_yaba": "N", "clicks": 850.85, "org_rank": 9.0, "price": 10.43, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "UNREAL\u00ae", "asin": "B0F9B1LWQQ", "title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "is_yaba": "N", "clicks": 424.07, "org_rank": 19.0, "price": 31.2725, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 3484.43, "org_rank": 2.0, "price": 14.6075, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "is_yaba": "N", "clicks": 5223.95, "org_rank": 2.0, "price": 23.91, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 1, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "NaturaleBio", "asin": "B079VQ52MK", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 988.61, "org_rank": 5.0, "price": 24.5275, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba": "N", "clicks": 1993.42, "org_rank": 6.0, "price": 15.5575, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "NaturaleBio", "asin": "B06XQ69YCQ", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba": "Y", "clicks": 904.87, "org_rank": 5.0, "price": 10.2225, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "NaturaleBio", "asin": "B07SZFD3P9", "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "is_yaba": "Y", "clicks": 723.9, "org_rank": 100, "price": 30.27, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "Special Leaves", "asin": "B0DRP6Y6XC", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "is_yaba": "N", "clicks": 810.33, "org_rank": 16.0, "price": 10.39, "has_deal": 0, "has_coupon": 1, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "Ceremonial", "asin": "B0FSL3C3Z8", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba": "N", "clicks": 1993.42, "org_rank": 6.0, "price": 15.5575, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}, {"week": "2026-01", "brand": "Bio", "asin": "B08XVX8V1T", "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "is_yaba": "N", "clicks": 645.57, "org_rank": 10.0, "price": 11.9975, "has_deal": 0, "has_coupon": 0, "is_best_seller": 0, "is_amazon_choice": 0, "market_clicks": 19499.31}];
    
    const metaInfo = {"our_brand": "NaturaleBio", "top_competitors": ["NORITUAL LAB", "Ceremonial", "VAHDAM"]};

    // ---------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // ---------------------------------------------------------
    
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        event.target.classList.add('active');
        
        if(tabId === 'interactive') updateComparator();
    }

    // Helper: Group By
    const groupBy = (array, key) => {
        return array.reduce((result, currentValue) => {
            (result[currentValue[key]] = result[currentValue[key]] || []).push(currentValue);
            return result;
        }, {});
    };

    function drawDashboard() {
        drawTrendChart();
        drawShareChart();
        drawScatterChart();
        drawDriverChart();
        generateInsights();
        setupInteractiveControls();
    }

    function drawTrendChart() {
        // Group by week, sum clicks for Us vs Comp
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const dataArray = [['Week', 'Our Clicks', 'Comp Clicks', 'Market Total', 'Our Share %']];
        
        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week === w);
            const ourClicks = weekData.filter(d => d.is_yaba === 'Y').reduce((s, c) => s + c.clicks, 0);
            const compClicks = weekData.filter(d => d.is_yaba === 'N').reduce((s, c) => s + c.clicks, 0);
            const marketTotal = weekData[0].market_clicks; 
            const share = (ourClicks / marketTotal) * 100;
            
            dataArray.push([w, ourClicks, compClicks, marketTotal, share]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1, color: '#9AA0A6', lineDashStyle: [4, 4]}, 3: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3} },
            colors: ['#4285F4', '#EA4335'],
            vAxes: { 0: {title: 'Clicks Volume'}, 1: {title: 'Share %', format: '#\'%\''} },
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'},
            bar: {groupWidth: '60%'}
        };

        new google.visualization.ComboChart(document.getElementById('chart_trend')).draw(data, options);
    }

    function drawShareChart() {
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const brands = [metaInfo.our_brand, ...metaInfo.top_competitors, 'Rest of Market'];
        const header = ['Week', metaInfo.our_brand, ...metaInfo.top_competitors, 'Rest of Market'];
        const dataArray = [header];

        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week === w);
            const totalClicks = weekData[0].market_clicks;
            
            const row = [w];
            // Our Brand
            const ourClicks = weekData.filter(d => d.brand === metaInfo.our_brand).reduce((s, c) => s + c.clicks, 0);
            row.push((ourClicks/totalClicks)*100);

            // Top Competitors
            metaInfo.top_competitors.forEach(comp => {
                const compClicks = weekData.filter(d => d.brand === comp).reduce((s, c) => s + c.clicks, 0);
                row.push((compClicks/totalClicks)*100);
            });

            // Rest
            const trackedBrands = [metaInfo.our_brand, ...metaInfo.top_competitors];
            const restClicks = weekData.filter(d => !trackedBrands.includes(d.brand)).reduce((s, c) => s + c.clicks, 0);
            row.push((restClicks/totalClicks)*100);

            dataArray.push(row);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            curveType: 'function',
            lineWidth: 2,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            vAxis: {format: '#\'%\''},
            legend: {position: 'bottom'},
            chartArea: {width: '90%', height: '70%'}
        };

        new google.visualization.LineChart(document.getElementById('chart_share')).draw(data, options);
    }

    function drawDriverChart() {
        // Simple analysis: Our Brand Deal vs No Deal Share
        // Filter our brand
        const ourData = marketData.filter(d => d.is_yaba === 'Y');
        
        // Calculate Weighted Share with Deal vs Without
        const calcWeightedShare = (subset) => {
            if(subset.length === 0) return 0;
            const totalC = subset.reduce((s,x) => s + x.clicks, 0);
            const totalM = subset.reduce((s,x) => s + x.market_clicks, 0); // Approx
            // Better: Average share weighted by volume? No, just sum clicks / sum market clicks of those weeks
            // To simplify for this chart: Avg Click Share of ASINs
            // Let's use Sum Clicks / Total Market of that week to get "Brand Share" then average it?
            // Let's stick to ASIN level performance shift.
            // Avg Click Share of an ASIN when it has a deal vs when it doesn't.
            let sumShare = 0;
            subset.forEach(s => {
                sumShare += (s.clicks / s.market_clicks) * 100;
            });
            return sumShare / subset.length; // Avg Share per ASIN per week
        };

        const withDeal = ourData.filter(d => d.has_deal > 0);
        const noDeal = ourData.filter(d => d.has_deal === 0);
        
        const withCoupon = ourData.filter(d => d.has_coupon > 0);
        const noCoupon = ourData.filter(d => d.has_coupon === 0);

        // Competitor Avg Price vs Us
        const compData = marketData.filter(d => d.is_yaba === 'N');
        const avgPriceUs = ourData.reduce((s,c)=>s+c.price,0) / ourData.length;
        const avgPriceComp = compData.reduce((s,c)=>s+c.price,0) / compData.length;

        const data = google.visualization.arrayToDataTable([
            ['Driver', 'Impact (Avg Share %)', { role: 'style' }],
            ['With Deal', calcWeightedShare(withDeal), '#4285F4'],
            ['No Deal', calcWeightedShare(noDeal), '#AECBFA'],
            ['With Coupon', calcWeightedShare(withCoupon), '#34A853'],
            ['No Coupon', calcWeightedShare(noCoupon), '#A8DAB5']
        ]);

        const options = {
            legend: {position: 'none'},
            vAxis: {title: 'Avg ASIN Click Share %'},
            bar: {groupWidth: '50%'}
        };

        new google.visualization.ColumnChart(document.getElementById('chart_drivers')).draw(data, options);
    }

    function drawScatterChart() {
        // Last week only for cleaner scatter
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const lastWeek = weeks[weeks.length-1];
        const currentData = marketData.filter(d => d.week === lastWeek);

        const dataArray = [['Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        currentData.forEach(d => {
            const share = (d.clicks / d.market_clicks) * 100;
            const color = d.is_yaba === 'Y' ? 'point {fill-color: #4285F4; size: 10}' : 'point {fill-color: #EA4335}';
            const tooltip = `${d.brand}\n${d.title.substring(0,30)}...\nRank: ${d.org_rank}\nShare: ${share.toFixed(2)}%`;
            
            // Filter out outliers/long tail for cleaner chart if rank > 50
            if(d.org_rank <= 60) {
                dataArray.push([d.org_rank, share, color, tooltip]);
            }
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: -1}, // Invert axis
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            crosshair: { trigger: 'both' }
        };

        new google.visualization.ScatterChart(document.getElementById('chart_scatter')).draw(data, options);
    }

    function generateInsights() {
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const lastWeek = weeks[weeks.length-1];
        const prevWeek = weeks[weeks.length-2];
        
        // Data Prep
        const lastWeekData = marketData.filter(d => d.week === lastWeek);
        const prevWeekData = marketData.filter(d => d.week === prevWeek);

        const getShare = (dataSet, brand) => {
            const clicks = dataSet.filter(d => d.brand === brand).reduce((s,c)=>s+c.clicks,0);
            const total = dataSet[0].market_clicks;
            return (clicks/total)*100;
        };

        const usShareNow = getShare(lastWeekData, metaInfo.our_brand);
        const usSharePrev = getShare(prevWeekData, metaInfo.our_brand);
        const diff = usShareNow - usSharePrev;

        // Logic for Recommendations
        const insights = [];
        
        // 1. Trend Insight
        if(diff > 0) {
            insights.push(`<li class="insight-item"><span class="material-icons text-green">trending_up</span> <div><strong>Momentum Gained:</strong> ${metaInfo.our_brand} gained +${diff.toFixed(2)}% market share vs previous week.</div></li>`);
        } else {
            insights.push(`<li class="insight-item"><span class="material-icons text-red">trending_down</span> <div><strong>Share Erosion:</strong> ${metaInfo.our_brand} lost ${Math.abs(diff).toFixed(2)}% share. Check competitor deals.</div></li>`);
        }

        // 2. Competitor Mover
        let maxCompGrowth = {name: '', val: -100};
        metaInfo.top_competitors.forEach(c => {
            const gr = getShare(lastWeekData, c) - getShare(prevWeekData, c);
            if(gr > maxCompGrowth.val) maxCompGrowth = {name: c, val: gr};
        });
        if(maxCompGrowth.val > 0.5) {
             insights.push(`<li class="insight-item"><span class="material-icons" style="color:#EA4335">warning</span> <div><strong>Competitive Threat:</strong> ${maxCompGrowth.name} surged +${maxCompGrowth.val.toFixed(2)}% in share recently.</div></li>`);
        }

        // 3. Efficiency
        const badRankGoodShare = lastWeekData.filter(d => d.is_yaba === 'Y' && d.org_rank > 15 && (d.clicks/d.market_clicks)*100 > 2);
        if(badRankGoodShare.length > 0) {
             insights.push(`<li class="insight-item"><span class="material-icons text-green">verified</span> <div><strong>Hidden Gem:</strong> Variant ${badRankGoodShare[0].asin} converts well despite poor rank (${badRankGoodShare[0].org_rank}). <strong>Recommendation:</strong> Boost PPC.</div></li>`);
        }

        // 4. Recommendation based on Deal
        const activeDeals = lastWeekData.filter(d => d.is_yaba === 'Y' && d.has_deal).length;
        if(activeDeals === 0 && diff < 0) {
             insights.push(`<li class="insight-item"><span class="rec-tag">ACTION</span> <div><strong>Activate Promo:</strong> No active deals for our brand while share dropped. Consider a 7-day deal to regain rank.</div></li>`);
        }

        // 5. Price Check
        const ourPrice = lastWeekData.filter(d=>d.is_yaba==='Y').reduce((s,c)=>s+c.price,0)/lastWeekData.filter(d=>d.is_yaba==='Y').length;
        const compPrice = lastWeekData.filter(d=>d.is_yaba==='N').reduce((s,c)=>s+c.price,0)/lastWeekData.filter(d=>d.is_yaba==='N').length;
        if(ourPrice > compPrice * 1.2) {
            insights.push(`<li class="insight-item"><span class="rec-tag">PRICING</span> <div><strong>Price Sensitivity:</strong> We are ${(ourPrice/compPrice * 100 - 100).toFixed(0)}% more expensive than market avg. Evaluate elasticity.</div></li>`);
        }

        document.getElementById('insights_container').innerHTML = insights.join('');
        document.getElementById('other_insights').innerHTML = `Detected ${metaInfo.top_competitors.length} major competitors. The market is consolidating around top 3 players holding approx 50-60% of clicks.`;
    }

    // ---------------------------------------------------------
    // 3. INTERACTIVE COMPARATOR
    // ---------------------------------------------------------
    function setupInteractiveControls() {
        const weeks = [...new Set(marketData.map(d => d.week))].sort().reverse();
        const selWeek = document.getElementById('sel_week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            selWeek.appendChild(opt);
        });

        const selComp = document.getElementById('sel_competitor');
        metaInfo.top_competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            selComp.appendChild(opt);
        });
    }

    function updateComparator() {
        const week = document.getElementById('sel_week').value;
        const comp = document.getElementById('sel_competitor').value;
        
        const weekData = marketData.filter(d => d.week === week);
        
        // Aggregates
        const calcMetrics = (brandData) => {
            if(!brandData.length) return {share: 0, price: 0, rank: 0};
            const totalM = brandData[0].market_clicks;
            const clicks = brandData.reduce((s,c)=>s+c.clicks,0);
            const price = brandData.reduce((s,c)=>s+c.price,0) / brandData.length;
            const rank = brandData.reduce((s,c)=>s+c.org_rank,0) / brandData.length;
            return { share: (clicks/totalM)*100, price: price, rank: rank };
        };

        const usMetrics = calcMetrics(weekData.filter(d => d.brand === metaInfo.our_brand));
        const compMetrics = calcMetrics(weekData.filter(d => d.brand === comp));

        // Render Cards
        const html = `
            <div style="background:#E8F0FE; padding:16px; border-radius:8px;">
                <div style="font-weight:bold; color:#4285F4; margin-bottom:8px;">${metaInfo.our_brand} (Us)</div>
                <div class="metric-big">${usMetrics.share.toFixed(2)}%</div>
                <div class="metric-label">Click Share</div>
                <hr style="border:0; border-top:1px solid #ccc; margin:8px 0;">
                <div>Avg Rank: <strong>${usMetrics.rank.toFixed(1)}</strong></div>
                <div>Avg Price: <strong>€${usMetrics.price.toFixed(2)}</strong></div>
            </div>
            <div style="background:#FCE8E6; padding:16px; border-radius:8px;">
                <div style="font-weight:bold; color:#EA4335; margin-bottom:8px;">${comp}</div>
                <div class="metric-big">${compMetrics.share.toFixed(2)}%</div>
                <div class="metric-label">Click Share</div>
                <hr style="border:0; border-top:1px solid #ccc; margin:8px 0;">
                <div>Avg Rank: <strong>${compMetrics.rank.toFixed(1)}</strong></div>
                <div>Avg Price: <strong>€${compMetrics.price.toFixed(2)}</strong></div>
            </div>
        `;
        document.getElementById('comparator_output').innerHTML = html;

        // Draw Comparison Chart (Price vs Rank)
        const data = google.visualization.arrayToDataTable([
            ['Metric', 'Us', comp],
            ['Price', usMetrics.price, compMetrics.price],
            ['Rank', usMetrics.rank, compMetrics.rank]
        ]);
        
        const options = {
            title: 'Price vs Rank Comparison',
            seriesType: 'bars',
            colors: ['#4285F4', '#EA4335']
        };
        new google.visualization.ComboChart(document.getElementById('chart_comparator')).draw(data, options);
    }

</script>
</body>
</html>