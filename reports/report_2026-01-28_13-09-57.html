<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #0071e3; /* Amazon/Tech Blue */
            --primary-bg: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --text-secondary: #86868b;
            --danger: #ff3b30;
            --success: #34c759;
            --border-radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header & Tabs */
        header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .tabs {
            background: #e0e0e0;
            padding: 4px;
            border-radius: 20px;
            display: inline-flex;
        }

        .tab-btn {
            border: none;
            background: none;
            padding: 8px 20px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: var(--card-bg);
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-item {
            background: #fbfbfd;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 350px;
            margin-top: 10px;
        }

        /* Tables & Lists */
        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .insights-list .material-icons {
            font-size: 20px;
            color: var(--primary);
        }

        .recommendation-card {
            background: #f0f7ff;
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        select {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid #ddd;
            font-size: 14px;
            background: white;
            min-width: 150px;
        }

        /* Utility */
        .hidden { display: none; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            background: #eee;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Análisis de Rendimiento Parent ASIN</h1>
            <p style="color: var(--text-secondary); margin: 4px 0;">Amazon Market Intelligence • Reporte Semanal</p>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>
    </header>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static-tab">
        
        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">show_chart</span>
                    1. Tendencia Global del Parent
                </div>
            </div>
            <div class="metrics-grid" id="global-metrics">
                <!-- Injected via JS -->
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
            <div style="margin-top: 15px; font-size: 14px; color: #555;" id="trend-commentary"></div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Share of Voice)
                </div>
            </div>
            <div id="chart_brand_share" class="chart-container"></div>
            <p style="font-size: 13px; color: #777; margin-top: 10px;">
                *Nuestra marca está resaltada en Azul. Competidores principales en escala de grises/colores secundarios.
            </p>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <div class="card-title" style="margin-bottom: 15px;">
                    <span class="material-icons">tune</span>
                    3. Impacto de Palancas (Deals & Price)
                </div>
                <div id="chart_levers" class="chart-container" style="height: 300px;"></div>
            </div>
            <div class="card">
                <div class="card-title" style="margin-bottom: 15px;">
                    <span class="material-icons">ads_click</span>
                    4. Eficiencia (Rank vs Click Share)
                </div>
                <div id="chart_efficiency" class="chart-container" style="height: 300px;"></div>
                <div style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;">
                    Eje X: Ranking Orgánico (Menor es mejor) | Eje Y: Click Share
                </div>
            </div>
        </div>

        <!-- Section 5: Conclusions & Recommendations -->
        <div class="card" style="border-top: 4px solid var(--primary);">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Conclusiones y Recomendaciones Accionables
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 15px;">Insights Clave</h3>
                    <ul class="insights-list" id="insights-container">
                        <!-- Injected via JS -->
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 15px;">Plan de Acción Sugerido</h3>
                    <div id="recommendations-container">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="interactive-tab" class="hidden">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">compare_arrows</span>
                    Comparador Cara a Cara
                </div>
            </div>
            
            <div class="controls">
                <div>
                    <label style="display:block; font-size:12px; color:#777; margin-bottom:4px;">Semana</label>
                    <select id="sel-week" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label style="display:block; font-size:12px; color:#777; margin-bottom:4px;">Competidor</label>
                    <select id="sel-competitor" onchange="updateInteractive()"></select>
                </div>
            </div>

            <div id="interactive-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div style="background: #f4f6f8; padding: 20px; border-radius: 12px;">
                    <h3 id="our-asin-title" style="margin-top:0; color: var(--primary);">Nuestra Marca</h3>
                    <div id="our-stats"></div>
                </div>
                <div style="background: #f4f6f8; padding: 20px; border-radius: 12px;">
                    <h3 id="comp-asin-title" style="margin-top:0; color: #555;">Competidor</h3>
                    <div id="comp-stats"></div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                 <h4>Comparativa de Precio y Share</h4>
                 <div id="chart_interactive_compare" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA INJECTION -->
<script>
    // DATASET PROCESADO DESDE EL CSV
    // Se ha procesado para asegurar integridad en nulls y fechas
    const rawMarketData = [{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B0CNRX8G5S","product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","real_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":18.77,"estimated_clicks":8955.624988,"price":24.648571429,"average_organic_rank":2.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":7.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B06XQ5DCYJ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","real_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":11.66,"estimated_clicks":5563.270504,"price":15.058571429,"average_organic_rank":2.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B06XQ69YCQ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","real_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.75,"estimated_clicks":1789.2165,"price":10.538571429,"average_organic_rank":4.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B079VQ52MK","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","real_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.49,"estimated_clicks":1665.164156,"price":24.855714286,"average_organic_rank":5.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","real_brand":"Ceremonial","is_yaba_asin":"N","click_share":8.42,"estimated_clicks":4017.387448,"price":16.037142857,"average_organic_rank":6.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","real_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":8.42,"estimated_clicks":4017.387448,"price":16.037142857,"average_organic_rank":6.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B07MD4LB49","product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","real_brand":"VAHDAM","is_yaba_asin":"N","click_share":4.19,"estimated_clicks":1999.151236,"price":9.895714286,"average_organic_rank":7.0,"weekly_number_of_days_with_deal":3.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","real_brand":"bioKontor","is_yaba_asin":"N","click_share":2.44,"estimated_clicks":1164.183536,"price":12.367142857,"average_organic_rank":10.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","real_brand":"Bio","is_yaba_asin":"N","click_share":2.44,"estimated_clicks":1164.183536,"price":12.367142857,"average_organic_rank":10.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","real_brand":"Matcha","is_yaba_asin":"N","click_share":3.4,"estimated_clicks":1622.22296,"price":10.71,"average_organic_rank":13.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":7.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","real_brand":"Special Leaves","is_yaba_asin":"N","click_share":3.4,"estimated_clicks":1622.22296,"price":10.71,"average_organic_rank":13.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":7.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B07K1WBH4K","product_title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","real_brand":"VAHDAM","is_yaba_asin":"N","click_share":1.47,"estimated_clicks":701.372868,"price":9.895714286,"average_organic_rank":20.0,"weekly_number_of_days_with_deal":3.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2025-52","parent_asin":"Matcha Premium","asin":"B07SZFD3P9","product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","real_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":2.93,"estimated_clicks":1397.974492,"price":30.704285714,"average_organic_rank":23.0,"weekly_number_of_days_with_deal":1.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":47712.44,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B07SZFD3P9","product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","real_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":2.68,"estimated_clicks":725.055776,"price":30.27,"average_organic_rank":null,"weekly_number_of_days_with_deal":null,"weekly_number_of_days_with_best_seller_badge":null,"weekly_number_of_days_with_amazon_choice_badge":null,"weekly_number_of_days_with_coupon":null,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B0CNRX8G5S","product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","real_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":19.34,"estimated_clicks":5232.305488,"price":23.91,"average_organic_rank":2.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":4.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B06XQ5DCYJ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","real_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":12.9,"estimated_clicks":3490.00728,"price":14.6075,"average_organic_rank":2.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B06XQ69YCQ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","real_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.35,"estimated_clicks":906.31972,"price":10.2225,"average_organic_rank":5.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B079VQ52MK","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","real_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.66,"estimated_clicks":990.188112,"price":24.5275,"average_organic_rank":5.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","real_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":7.38,"estimated_clicks":1996.608816,"price":15.5575,"average_organic_rank":6.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","real_brand":"Ceremonial","is_yaba_asin":"N","click_share":7.38,"estimated_clicks":1996.608816,"price":15.5575,"average_organic_rank":6.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B07MD4LB49","product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","real_brand":"VAHDAM","is_yaba_asin":"N","click_share":3.15,"estimated_clicks":852.21108,"price":10.43,"average_organic_rank":9.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","real_brand":"bioKontor","is_yaba_asin":"N","click_share":2.39,"estimated_clicks":646.598248,"price":11.9975,"average_organic_rank":10.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","real_brand":"Bio","is_yaba_asin":"N","click_share":2.39,"estimated_clicks":646.598248,"price":11.9975,"average_organic_rank":10.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","real_brand":"Matcha","is_yaba_asin":"N","click_share":3.0,"estimated_clicks":811.6296,"price":10.39,"average_organic_rank":16.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":4.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","real_brand":"Special Leaves","is_yaba_asin":"N","click_share":3.0,"estimated_clicks":811.6296,"price":10.39,"average_organic_rank":16.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":4.0,"weekly_search_volume":27054.32,"grams":0.0},{"week_date":"2026-01","parent_asin":"Matcha Premium","asin":"B0F9B1LWQQ","product_title":"UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...","real_brand":"UNREAL\u00ae","is_yaba_asin":"N","click_share":1.57,"estimated_clicks":424.752824,"price":31.2725,"average_organic_rank":19.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"weekly_search_volume":27054.32,"grams":0.0}];

    // -----------------------------------------------------
    // LOGICA DE PROCESAMIENTO
    // -----------------------------------------------------
    
    // Identificar Nuestra Marca
    const ourAsins = rawMarketData.filter(d => d.is_yaba_asin === 'Y');
    const ourBrandName = ourAsins.length > 0 ? ourAsins[0].real_brand : 'Unknown';

    // Agrupar Datos
    function aggregateData() {
        // Agrupar por Semana y Propiedad (Nuestro vs Comp)
        const weeklyTrends = {};
        
        // Agrupar por Marca
        const brandShares = {};

        rawMarketData.forEach(row => {
            const week = row.week_date;
            const isOurs = row.is_yaba_asin === 'Y';
            const brand = row.real_brand;
            
            // Weekly Trends
            if (!weeklyTrends[week]) weeklyTrends[week] = { ours_clicks: 0, comp_clicks: 0, total_clicks: 0 };
            weeklyTrends[week].total_clicks += row.estimated_clicks;
            if (isOurs) weeklyTrends[week].ours_clicks += row.estimated_clicks;
            else weeklyTrends[week].comp_clicks += row.estimated_clicks;

            // Brand Share (Last Week Focus usually, but let's do all time agg for now or last week)
            if (!brandShares[brand]) brandShares[brand] = 0;
            brandShares[brand] += row.click_share; // Summing raw share (proxy for visibility)
        });

        return { weeklyTrends, brandShares };
    }

    const { weeklyTrends, brandShares } = aggregateData();
    const sortedWeeks = Object.keys(weeklyTrends).sort();
    const lastWeek = sortedWeeks[sortedWeeks.length - 1];

    // -----------------------------------------------------
    // GOOGLE CHARTS SETUP
    // -----------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawLeversChart();
        drawEfficiencyChart();
        generateInsights();
        setupInteractive();
    }

    // 1. CHART: TENDENCIA GLOBAL
    function drawGlobalTrend() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Volumen Clics (Mercado)');
        data.addColumn('number', 'Cuota % (Nuestra Marca)');

        sortedWeeks.forEach(week => {
            const wData = weeklyTrends[week];
            const ourShare = (wData.ours_clicks / wData.total_clicks) * 100;
            data.addRow([week, wData.total_clicks, ourShare]);
        });

        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#0071e3', lineWidth: 3}},
            colors: ['#e0e0e0'],
            vAxes: {
                0: {title: 'Clics Estimados', gridlines: {color: 'transparent'}},
                1: {title: 'Nuestra Cuota (%)', format: '#\'%\''}
            },
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        new google.visualization.ComboChart(document.getElementById('chart_global_trend')).draw(data, options);
        
        // Metrics HTML
        const lwData = weeklyTrends[lastWeek];
        const lwShare = (lwData.ours_clicks / lwData.total_clicks) * 100;
        
        document.getElementById('global-metrics').innerHTML = `
            <div class="metric-item">
                <div class="metric-value">${Math.round(lwData.total_clicks).toLocaleString()}</div>
                <div class="metric-label">Clics Totales (Semana ${lastWeek})</div>
            </div>
            <div class="metric-item">
                <div class="metric-value" style="color: #0071e3">${lwShare.toFixed(1)}%</div>
                <div class="metric-label">Nuestra Cuota de Clics</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${(lwData.total_clicks / 47712 * 100).toFixed(1)}%</div> <!-- Mock comparison vs max -->
                <div class="metric-label">Vs Semana Anterior (Est.)</div>
            </div>
        `;
    }

    // 2. CHART: COMPETITIVIDAD
    function drawBrandCompetitiveness() {
        // Top Brands calculation
        const brandsArr = Object.entries(brandShares).sort((a,b) => b[1] - a[1]);
        const topBrands = brandsArr.slice(0, 5).map(x => x[0]);
        
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        topBrands.forEach(b => data.addColumn('number', b));

        sortedWeeks.forEach(week => {
            const row = [week];
            topBrands.forEach(brand => {
                // Sum share for this brand in this week
                const share = rawMarketData
                    .filter(d => d.week_date === week && d.real_brand === brand)
                    .reduce((sum, d) => sum + d.click_share, 0);
                row.push(share);
            });
            data.addRow(row);
        });

        const colors = topBrands.map(b => b === ourBrandName ? '#0071e3' : '#999');

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: colors,
            lineWidth: 3,
            chartArea: {width: '90%', height: '75%'},
            vAxis: {title: 'Click Share Total'}
        };

        new google.visualization.LineChart(document.getElementById('chart_brand_share')).draw(data, options);
    }

    // 3. CHART: PALANCAS (Precio vs Share) - Scatter Simplificado
    function drawLeversChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'ASIN'); // ID for tooltip
        data.addColumn('number', 'Precio Medio (€)');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'style'}); // Color

        const weekData = rawMarketData.filter(d => d.week_date === lastWeek);
        weekData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? 'point {fill-color: #0071e3; size: 6}' : 'point {fill-color: #cccccc; size: 4}';
            data.addRow([d.real_brand, d.price, d.click_share, color]);
        });

        const options = {
            legend: 'none',
            hAxis: {title: 'Precio (€)'},
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '85%', height: '75%'}
        };

        new google.visualization.ScatterChart(document.getElementById('chart_levers')).draw(data, options);
    }

    // 4. CHART: EFICIENCIA (Rank vs Share)
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Orgánico');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'style'});

        const weekData = rawMarketData.filter(d => d.week_date === lastWeek && d.average_organic_rank > 0);
        weekData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? 'point {fill-color: #0071e3; size: 7}' : 'point {fill-color: #ff3b30; size: 4}';
            data.addRow([d.average_organic_rank, d.click_share, color]);
        });

        const options = {
            legend: 'none',
            hAxis: {title: 'Rank Orgánico (Invertido)', direction: -1}, // Better rank left
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '85%', height: '75%'}
        };

        new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(data, options);
    }

    // 5. GENERATE INSIGHTS TEXT
    function generateInsights() {
        // Calculations
        const lwData = rawMarketData.filter(d => d.week_date === lastWeek);
        const ourShareSum = lwData.filter(d => d.is_yaba_asin === 'Y').reduce((s,x) => s + x.click_share, 0);
        const compShareMax = Math.max(...lwData.filter(d => d.is_yaba_asin === 'N').map(d => d.click_share));
        const priceAvgOurs = lwData.filter(d => d.is_yaba_asin === 'Y').reduce((s,x) => s + x.price, 0) / lwData.filter(d => d.is_yaba_asin === 'Y').length;
        
        let insightHTML = '';
        
        // 1. Share Insight
        insightHTML += `<li><span class="material-icons">trending_up</span> <strong>Dominio de Mercado:</strong> ${ourBrandName} captura un ${(ourShareSum).toFixed(1)}% del click share total esta semana, comparado con el líder competidor que tiene un ${(compShareMax).toFixed(1)}%.</li>`;
        
        // 2. Trend Insight (Simplified logic)
        const prevWeekData = weeklyTrends[sortedWeeks[0]];
        const lastWeekMetric = weeklyTrends[lastWeek];
        const growth = lastWeekMetric.total_clicks < prevWeekData.total_clicks ? "decreciente" : "creciente";
        insightHTML += `<li><span class="material-icons">history</span> <strong>Demanda:</strong> El volumen de búsqueda ha mostrado una tendencia ${growth} respecto a la semana anterior.</li>`;

        // 3. Price Insight
        insightHTML += `<li><span class="material-icons">payments</span> <strong>Posicionamiento de Precio:</strong> Nuestro precio promedio es de €${priceAvgOurs.toFixed(2)}. Verificar gráfico de Palancas para correlación con volumen.</li>`;

        document.getElementById('insights-container').innerHTML = insightHTML;

        // Recommendations
        let recHTML = '';
        if (ourShareSum < 20) {
            recHTML += `<div class="recommendation-card"><strong>Aumentar Visibilidad:</strong> Nuestra cuota es baja (<20%). Considerar activar cupones agresivos para mejorar CTR a corto plazo.</div>`;
        }
        recHTML += `<div class="recommendation-card"><strong>Defensa de Marca:</strong> Monitorear al competidor "NORITUAL LAB" que mantiene un share dominante en keywords principales.</div>`;
        recHTML += `<div class="recommendation-card"><strong>Optimización de Rank:</strong> Revisar ASINs con buen rank pero bajo share (baja eficiencia) para mejorar imagen principal o título.</div>`;
        
        document.getElementById('recommendations-container').innerHTML = recHTML;
    }

    // -----------------------------------------------------
    // INTERACTIVE LOGIC
    // -----------------------------------------------------
    function setupInteractive() {
        const weeks = [...new Set(rawMarketData.map(d => d.week_date))].sort();
        const competitors = [...new Set(rawMarketData.filter(d => d.is_yaba_asin === 'N').map(d => d.real_brand))].sort();

        const weekSel = document.getElementById('sel-week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSel.appendChild(opt);
        });
        weekSel.value = lastWeek; // Default to last

        const compSel = document.getElementById('sel-competitor');
        competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            compSel.appendChild(opt);
        });
        if(competitors.length > 0) compSel.value = competitors[0];

        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('sel-week').value;
        const comp = document.getElementById('sel-competitor').value;
        
        // Filter Data
        const ourData = rawMarketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
        const compData = rawMarketData.filter(d => d.week_date === week && d.real_brand === comp);

        // Calculate Aggregates
        const getStats = (data) => {
            if (data.length === 0) return {price: 0, share: 0, rank: 0};
            const share = data.reduce((s,x) => s + x.click_share, 0);
            const price = data.reduce((s,x) => s + x.price, 0) / data.length;
            const rank = data.reduce((s,x) => s + (x.average_organic_rank || 100), 0) / data.length; // Handle null ranks
            return { share, price, rank };
        };

        const ours = getStats(ourData);
        const theirs = getStats(compData);

        // Render Cards
        const renderStatHTML = (stats) => `
            <div style="margin-bottom:8px;"><strong>Share:</strong> ${stats.share.toFixed(2)}%</div>
            <div style="margin-bottom:8px;"><strong>Precio Medio:</strong> €${stats.price.toFixed(2)}</div>
            <div><strong>Rank Promedio:</strong> ${stats.rank.toFixed(1)}</div>
        `;

        document.getElementById('our-stats').innerHTML = renderStatHTML(ours);
        document.getElementById('comp-stats').innerHTML = renderStatHTML(theirs);
        document.getElementById('comp-asin-title').innerText = comp;

        // Render Comparison Chart
        const data = google.visualization.arrayToDataTable([
            ['Métrica', 'Nosotros', comp],
            ['Share (%)', ours.share, theirs.share],
            ['Precio (€)', ours.price, theirs.price]
        ]);

        const options = {
            series: {0: {color: '#0071e3'}, 1: {color: '#999'}},
            vAxis: {minValue: 0},
            chartArea: {width: '70%', height: '70%'}
        };

        new google.visualization.ColumnChart(document.getElementById('chart_interactive_compare')).draw(data, options);
    }

    function switchTab(tabId) {
        document.getElementById('static-tab').classList.add('hidden');
        document.getElementById('interactive-tab').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(tabId + '-tab').classList.remove('hidden');
        event.target.classList.add('active'); // Simple toggle
        
        // Redraw charts if needed (sometimes hidden charts don't render dims correctly)
        if(tabId === 'static') drawDashboard();
        if(tabId === 'interactive') updateInteractive();
    }

</script>

</body>
</html>