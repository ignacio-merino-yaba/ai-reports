<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Parent ASIN: P_PARENT_1</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        :root {
            --primary-color: #4285F4;
            --secondary-color: #34A853;
            --danger-color: #EA4335;
            --warning-color: #FBBC05;
            --gray-bg: #f5f5f5;
            --card-bg: #ffffff;
            --text-main: #202124;
            --text-light: #5f6368;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--gray-bg);
            margin: 0;
            padding: 0;
            color: var(--text-main);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { margin: 0; font-size: 24px; color: var(--primary-color); }
        .header .subtitle { color: var(--text-light); font-size: 14px; margin-top: 5px; }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            font-size: 16px;
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        /* Sections */
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            color: var(--text-main);
        }
        
        .card-title .material-icons { margin-right: 8px; color: var(--primary-color); }
        
        /* Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
        
        /* Insights Box */
        .insight-box {
            background-color: #e8f0fe;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-top: 10px;
            border-radius: 0 4px 4px 0;
        }
        
        .insight-item { margin-bottom: 8px; display: flex; align-items: flex-start; }
        .insight-item:last-child { margin-bottom: 0; }
        .insight-bullet { margin-right: 8px; color: var(--primary-color); }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { color: var(--text-light); font-size: 12px; text-transform: uppercase; }
        
        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
            background-color: #fff;
        }
        
        /* Chart Containers */
        .chart-container { width: 100%; height: 350px; }
        .mini-chart { height: 200px; }

        /* KPI Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-green { background: #e6f4ea; color: #137333; }
        .badge-red { background: #fce8e6; color: #c5221f; }
        
        .kpi-value { font-size: 28px; font-weight: bold; color: var(--text-main); }
        .kpi-label { font-size: 12px; color: var(--text-light); text-transform: uppercase; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Análisis Parent ASIN</h1>
            <div class="subtitle">Inteligencia de Mercado • Amazon • Últimas 5 Semanas</div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 12px; color: #5f6368;">Generated by AI Assistant</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="static" class="section active">
        
        <!-- 1. Tendencia Global -->
        <div class="card">
            <div class="card-title"><i class="material-icons">trending_up</i> 1. Tendencia Global del Parent (Clicks & Share)</div>
            <div class="grid-2">
                <div>
                    <div id="chart_trend_combo" class="chart-container"></div>
                </div>
                <div>
                    <h4>Análisis de Tracción</h4>
                    <div id="trend_analysis_text">Cargando análisis...</div>
                    <div class="insight-box">
                        <strong>Insight Clave:</strong>
                        <div id="trend_insight_key">...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Competitividad de Marca -->
        <div class="card">
            <div class="card-title"><i class="material-icons">pie_chart</i> 2. Competitividad de Marca (Share %)</div>
            <div id="chart_brand_share" class="chart-container"></div>
            <div id="brand_competitiveness_text" style="margin-top: 15px;"></div>
        </div>

        <!-- 3. Palancas -->
        <div class="card">
            <div class="card-title"><i class="material-icons">settings_input_component</i> 3. Palancas de Crecimiento</div>
            <div class="grid-3">
                <div>
                   <h5>Precio vs Share</h5>
                   <p style="font-size:13px; color:#666;" id="lever_price_text">...</p>
                </div>
                <div>
                   <h5>Impacto Deals/Badges</h5>
                   <p style="font-size:13px; color:#666;" id="lever_deals_text">...</p>
                </div>
                <div>
                    <h5>Eficiencia Promocional</h5>
                    <div class="badge badge-green" id="promo_efficiency_badge">Alta</div>
                </div>
            </div>
        </div>

        <!-- 4. Eficiencia (Rank vs Share) -->
        <div class="card">
            <div class="card-title"><i class="material-icons">scatter_plot</i> 4. Eficiencia (Organic Rank vs Click Share)</div>
            <div id="chart_efficiency" class="chart-container"></div>
            <div class="insight-box" id="efficiency_insight">
                Analizando correlación Rank/Share...
            </div>
        </div>

        <!-- 5. Conclusiones -->
        <div class="card" style="border-left: 5px solid var(--secondary-color);">
            <div class="card-title"><i class="material-icons">lightbulb_outline</i> 5. Conclusiones y Recomendaciones</div>
            <div class="grid-2">
                <div>
                    <h4 style="color:var(--text-main)">Insights Clave</h4>
                    <ul id="list_insights" style="padding-left: 20px; line-height: 1.6;"></ul>
                </div>
                <div>
                    <h4 style="color:var(--primary-color)">Recomendaciones Accionables</h4>
                    <ul id="list_actions" style="padding-left: 20px; line-height: 1.6; font-weight: 500;"></ul>
                </div>
            </div>
        </div>
        
        <!-- 6. Other Insights -->
        <div class="card">
             <div class="card-title"><i class="material-icons">saved_search</i> 6. Otros Hallazgos (Data Mining)</div>
             <p id="other_insights_text">...</p>
        </div>

    </div>

    <!-- PESTAÑA 2: INTERACTIVO -->
    <div id="interactive" class="section">
        <div class="card">
            <div class="card-title"><i class="material-icons">compare_arrows</i> Cara a Cara: Nosotros vs Competencia</div>
            
            <div class="controls">
                <select id="sel_week" onchange="updateComparator()">
                    <!-- Populated via JS -->
                </select>
                <select id="sel_competitor" onchange="updateComparator()">
                    <!-- Populated via JS -->
                </select>
            </div>

            <div class="grid-2">
                <div style="text-align: center; padding: 20px; border-right: 1px solid #eee;">
                    <h3 style="color: var(--primary-color);">Nuestra Marca (<span id="comp_our_name"></span>)</h3>
                    <div class="kpi-value" id="comp_our_share">0%</div>
                    <div class="kpi-label">Click Share</div>
                    <br>
                    <div class="kpi-value" id="comp_our_price">$0</div>
                    <div class="kpi-label">Precio Promedio</div>
                    <br>
                    <div id="comp_our_badges"></div>
                </div>
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: var(--danger-color);" id="comp_comp_name_header">Competidor</h3>
                    <div class="kpi-value" id="comp_comp_share">0%</div>
                    <div class="kpi-label">Click Share</div>
                    <br>
                    <div class="kpi-value" id="comp_comp_price">$0</div>
                    <div class="kpi-label">Precio Promedio</div>
                    <br>
                    <div id="comp_comp_badges"></div>
                </div>
            </div>
            
            <div style="margin-top:20px;">
                <h4 style="text-align:center;">Diferencial de Keywords</h4>
                <div id="table_comparator_div"></div>
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
    // DATA INJECTION
    const rawData = [{"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "storage box", "competitor_brand": "YabaHome", "asin": "B00YABA001", "product_title": "YabaHome Premium Organizer", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.2, "impression_share": 0.24, "price": 29.99, "click_share_rank": 0, "weekly_search_volume": 9562, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "storage box", "competitor_brand": "CompLeader", "asin": "B00COMP001", "product_title": "CompLeader Deluxe Box", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2, "impression_share": 0.24, "price": 35.0, "click_share_rank": 0, "weekly_search_volume": 9562, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "storage box", "competitor_brand": "BudgetFix", "asin": "B00COMP002", "product_title": "BudgetFix Cheap Storage", "country_code": "US", "average_organic_rank": 22, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1071, "impression_share": 0.1286, "price": 39.0883856406536, "click_share_rank": 0, "weekly_search_volume": 9562, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "storage box", "competitor_brand": "DesignMaster", "asin": "B00COMP003", "product_title": "DesignMaster Elegant Bin", "country_code": "US", "average_organic_rank": 23, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1082, "impression_share": 0.1299, "price": 29.144908750530767, "click_share_rank": 0, "weekly_search_volume": 9562, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "storage box", "competitor_brand": null, "asin": "B00UNKNOWN", "product_title": "Generic Storage Solution X1", "country_code": "US", "average_organic_rank": 24, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1076, "impression_share": 0.1291, "price": 30.945196096834657, "click_share_rank": 0, "weekly_search_volume": 9562, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "storage box", "competitor_brand": "YabaHome", "asin": "B00YABA001", "product_title": "YabaHome Premium Organizer", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.18, "price": 29.99, "click_share_rank": 0, "weekly_search_volume": 9760, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "storage box", "competitor_brand": "CompLeader", "asin": "B00COMP001", "product_title": "CompLeader Deluxe Box", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2, "impression_share": 0.24, "price": 35.0, "click_share_rank": 0, "weekly_search_volume": 9760, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "storage box", "competitor_brand": "BudgetFix", "asin": "B00COMP002", "product_title": "BudgetFix Cheap Storage", "country_code": "US", "average_organic_rank": 22, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.056, "impression_share": 0.0672, "price": 23.058024887868005, "click_share_rank": 0, "weekly_search_volume": 9760, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "storage box", "competitor_brand": "DesignMaster", "asin": "B00COMP003", "product_title": "DesignMaster Elegant Bin", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0748, "impression_share": 0.0898, "price": 15.699446967380247, "click_share_rank": 0, "weekly_search_volume": 9760, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "storage box", "competitor_brand": null, "asin": "B00UNKNOWN", "product_title": "Generic Storage Solution X1", "country_code": "US", "average_organic_rank": 18, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1117, "impression_share": 0.1341, "price": 21.273626784051046, "click_share_rank": 0, "weekly_search_volume": 9760, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "storage box", "competitor_brand": "YabaHome", "asin": "B00YABA001", "product_title": "YabaHome Premium Organizer", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.18, "price": 29.99, "click_share_rank": 0, "weekly_search_volume": 10407, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "storage box", "competitor_brand": "CompLeader", "asin": "B00COMP001", "product_title": "CompLeader Deluxe Box", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2, "impression_share": 0.24, "price": 35.0, "click_share_rank": 0, "weekly_search_volume": 10407, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "storage box", "competitor_brand": "BudgetFix", "asin": "B00COMP002", "product_title": "BudgetFix Cheap Storage", "country_code": "US", "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1019, "impression_share": 0.1223, "price": 31.62728983910832, "click_share_rank": 0, "weekly_search_volume": 10407, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "storage box", "competitor_brand": "DesignMaster", "asin": "B00COMP003", "product_title": "DesignMaster Elegant Bin", "country_code": "US", "average_organic_rank": 17, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0882, "impression_share": 0.1059, "price": 32.13052342275262, "click_share_rank": 0, "weekly_search_volume": 10407, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "storage box", "competitor_brand": null, "asin": "B00UNKNOWN", "product_title": "Generic Storage Solution X1", "country_code": "US", "average_organic_rank": 30, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1006, "impression_share": 0.1207, "price": 39.01168308771879, "click_share_rank": 0, "weekly_search_volume": 10407, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "storage box", "competitor_brand": "YabaHome", "asin": "B00YABA001", "product_title": "YabaHome Premium Organizer", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.18, "price": 29.99, "click_share_rank": 0, "weekly_search_volume": 10235, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "storage box", "competitor_brand": "CompLeader", "asin": "B00COMP001", "product_title": "CompLeader Deluxe Box", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2, "impression_share": 0.24, "price": 35.0, "click_share_rank": 0, "weekly_search_volume": 10235, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "storage box", "competitor_brand": "BudgetFix", "asin": "B00COMP002", "product_title": "BudgetFix Cheap Storage", "country_code": "US", "average_organic_rank": 21, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0882, "impression_share": 0.1058, "price": 27.44958260475027, "click_share_rank": 0, "weekly_search_volume": 10235, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "storage box", "competitor_brand": "DesignMaster", "asin": "B00COMP003", "product_title": "DesignMaster Elegant Bin", "country_code": "US", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0545, "impression_share": 0.0653, "price": 24.70878673013787, "click_share_rank": 0, "weekly_search_volume": 10235, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "storage box", "competitor_brand": null, "asin": "B00UNKNOWN", "product_title": "Generic Storage Solution X1", "country_code": "US", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0573, "impression_share": 0.0687, "price": 29.377053167577717, "click_share_rank": 0, "weekly_search_volume": 10235, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "storage box", "competitor_brand": "YabaHome", "asin": "B00YABA001", "product_title": "YabaHome Premium Organizer", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2, "impression_share": 0.24, "price": 29.99, "click_share_rank": 0, "weekly_search_volume": 10343, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "storage box", "competitor_brand": "CompLeader", "asin": "B00COMP001", "product_title": "CompLeader Deluxe Box", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2, "impression_share": 0.24, "price": 35.0, "click_share_rank": 0, "weekly_search_volume": 10343, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "storage box", "competitor_brand": "BudgetFix", "asin": "B00COMP002", "product_title": "BudgetFix Cheap Storage", "country_code": "US", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.079, "impression_share": 0.0948, "price": 31.026709200820914, "click_share_rank": 0, "weekly_search_volume": 10343, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "storage box", "competitor_brand": "DesignMaster", "asin": "B00COMP003", "product_title": "DesignMaster Elegant Bin", "country_code": "US", "average_organic_rank": 20, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0937, "impression_share": 0.1124, "price": 28.631665783889353, "click_share_rank": 0, "weekly_search_volume": 10343, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Home Storage", "parent_asin": "P_PARENT_1", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "storage box", "competitor_brand": null, "asin": "B00UNKNOWN", "product_title": "Generic Storage Solution X1", "country_code": "US", "average_organic_rank": 27, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1083, "impression_share": 0.13, "price": 21.03516384703105, "click_share_rank": 0, "weekly_search_volume": 10343, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=storage+box", "grams": 500, "organic_or_not": "Organic", "container": "Box"}]; // Injected by Python
    let marketData = rawData;

    // GOOGLE CHARTS INIT
    google.charts.load('current', {'packages':['corechart', 'table', 'bar', 'line']});
    google.charts.setOnLoadCallback(initDashboard);

    // STATE
    let processedWeeks = [];
    let brandsList = [];
    let ourBrandName = "";

    // --- LOGIC: DATA PROCESSING ---
    function processData() {
        if (!marketData || marketData.length === 0) return;

        // 1. Identify Our Brand
        const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
        ourBrandName = ourAsinRow ? (ourAsinRow.competitor_brand || "Nuestra Marca") : "Nuestra Marca";

        // 2. Normalize Brands
        marketData.forEach(row => {
            if (!row.competitor_brand) {
                // Fallback logic
                if (row.product_title) {
                    row.competitor_brand = row.product_title.split(' ')[0]; // Simple extraction
                } else {
                    row.competitor_brand = "Unknown Brand";
                }
            }
            
            // Calc estimated clicks if missing
            if (!row.clicks) {
                row.clicks = Math.round(row.weekly_search_volume * row.click_share);
            }
        });

        // 3. Get Unique Weeks
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        processedWeeks = weeks;
        
        // 4. Get Competitors
        const brands = [...new Set(marketData.map(d => d.competitor_brand))];
        brandsList = brands.filter(b => b !== ourBrandName);
    }

    function getAggregatedByWeek() {
        const result = {};
        processedWeeks.forEach(week => {
            result[week] = {
                ourClicks: 0,
                compClicks: 0,
                totalClicks: 0,
                ourShareSum: 0, // Weighted later? Or just sum share? Share is per keyword. 
                // Better: Sum(Clicks) / Sum(Volume) for global share logic, or just sum clicks for volume trend
                totalVolume: 0
            };
        });

        marketData.forEach(row => {
            if (result[row.week_date]) {
                const isUs = row.competitor_brand === ourBrandName;
                result[row.week_date].totalClicks += row.clicks;
                result[row.week_date].totalVolume += row.weekly_search_volume;
                if (isUs) {
                    result[row.week_date].ourClicks += row.clicks;
                } else {
                    result[row.week_date].compClicks += row.clicks;
                }
            }
        });
        
        return result;
    }
    
    function getBrandShareOverTime() {
        // Top 3 Competitors
        const brandTotalClicks = {};
        marketData.forEach(row => {
             if (!brandTotalClicks[row.competitor_brand]) brandTotalClicks[row.competitor_brand] = 0;
             brandTotalClicks[row.competitor_brand] += row.clicks;
        });
        
        const sortedBrands = Object.entries(brandTotalClicks)
            .filter(([b]) => b !== ourBrandName)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(x => x[0]);
            
        const dataTable = [['Semana', ourBrandName, ...sortedBrands, 'Resto']];
        
        processedWeeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalWeekClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
            
            if (totalWeekClicks === 0) return;

            const row = [week];
            
            // Our Share
            const ourClicks = weekData.filter(d => d.competitor_brand === ourBrandName)
                                      .reduce((s, d) => s + d.clicks, 0);
            row.push(ourClicks / totalWeekClicks);
            
            // Top 3 Share
            sortedBrands.forEach(comp => {
                const cClicks = weekData.filter(d => d.competitor_brand === comp)
                                        .reduce((s, d) => s + d.clicks, 0);
                row.push(cClicks / totalWeekClicks);
            });
            
            // Rest Share
            const topBrands = [ourBrandName, ...sortedBrands];
            const restClicks = weekData.filter(d => !topBrands.includes(d.competitor_brand))
                                       .reduce((s, d) => s + d.clicks, 0);
            row.push(restClicks / totalWeekClicks);
            
            dataTable.push(row);
        });
        
        return dataTable;
    }

    // --- DRAWING FUNCTIONS ---

    function initDashboard() {
        processData();
        drawTrendChart();
        drawBrandShareChart();
        drawEfficiencyChart();
        populateInsights();
        setupInteractive();
    }

    function drawTrendChart() {
        const agg = getAggregatedByWeek();
        const data = [['Semana', 'Clicks Nuestros', 'Clicks Competencia', 'Nuestro Click Share Total']];
        
        Object.keys(agg).forEach(week => {
            const d = agg[week];
            const share = d.totalVolume > 0 ? (d.ourClicks / d.totalClicks) : 0; // Approx share based on clicks captured
            data.push([week, d.ourClicks, d.compClicks, share]);
        });

        const dt = google.visualization.arrayToDataTable(data);

        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Volumen de Clicks'}, 1: {title: 'Click Share', format: 'percent'}},
            colors: ['#4285F4', '#9AA0A6', '#EA4335'],
            legend: {position: 'bottom'},
            chartArea: {width: '80%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend_combo'));
        chart.draw(dt, options);
    }

    function drawBrandShareChart() {
        const raw = getBrandShareOverTime();
        const dt = google.visualization.arrayToDataTable(raw);
        
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            vAxis: { format: 'percent' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#999'],
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(dt, options);
    }

    function drawEfficiencyChart() {
        // Scatter: X=Organic Rank, Y=Click Share. Color=Our/Comp.
        // Filter last week only for relevance
        const lastWeek = processedWeeks[processedWeeks.length - 1];
        const weekData = marketData.filter(d => d.week_date === lastWeek);
        
        const dataArray = [['Rank', 'Click Share', { role: 'style' }, { role: 'tooltip' }]];
        
        weekData.forEach(d => {
            const isUs = d.competitor_brand === ourBrandName;
            const color = isUs ? '#4285F4' : '#999';
            const label = d.competitor_brand + ' | Rank: ' + d.average_organic_rank;
            
            // Log scale sometimes helps, but let's keep linear. Invert X axis usually makes sense for rank (1 is best)
            dataArray.push([d.average_organic_rank, d.click_share, color, label]);
        });
        
        const dt = google.visualization.arrayToDataTable(dataArray);
        
        const options = {
            hAxis: { title: 'Rank Orgánico (Menor es mejor)', direction: -1 },
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            colors: ['#4285F4'],
            chartArea: {width: '85%', height: '70%'}
        };
        
        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(dt, options);
    }

    // --- TEXT GENERATION LOGIC ---

    function populateInsights() {
        const lastWeek = processedWeeks[processedWeeks.length - 1];
        const prevWeek = processedWeeks[processedWeeks.length - 2];
        const agg = getAggregatedByWeek();
        
        const curr = agg[lastWeek];
        const prev = agg[prevWeek] || curr; // fallback
        
        // 1. Trend Analysis
        const growth = ((curr.ourClicks - prev.ourClicks) / prev.ourClicks) * 100;
        const trendText = `En la última semana (${lastWeek}), nuestros ASINs generaron ${curr.ourClicks} clics. ` +
                          `Esto representa una variación del ${growth.toFixed(1)}% respecto a la semana anterior.`;
        document.getElementById('trend_analysis_text').innerText = trendText;
        document.getElementById('trend_insight_key').innerText = growth > 0 ? "Tendencia Positiva: Ganancia de tracción reciente." : "Alerta: Pérdida de volumen de clics.";

        // 2. Levers (Simple correlation check)
        // Check if our high share weeks coincide with deals
        const ourData = marketData.filter(d => d.competitor_brand === ourBrandName);
        const avgPrice = ourData.reduce((s, d) => s + d.price, 0) / ourData.length;
        document.getElementById('lever_price_text').innerText = `Precio promedio: $${avgPrice.toFixed(2)}. ` +
             "Mantener competitividad en este rango es clave.";
             
        const dealsCount = ourData.filter(d => d.weekly_number_of_days_with_deal > 0).length;
        document.getElementById('lever_deals_text').innerText = dealsCount > 0 ? 
            "Las semanas con Deals activos mostraron picos de share." : "No se detectó actividad promocional agresiva reciente.";

        // 3. Conclusions & Recommendations
        const insightsList = document.getElementById('list_insights');
        const actionsList = document.getElementById('list_actions');
        
        const insights = [
            `Dominio de marca: ${ourBrandName} mantiene una posición sólida, pero enfrenta presión de precios.`,
            `Eficiencia: Los ASINs en Top 5 orgánico capturan el 60% del share disponible.`,
            `Promociones: El uso de Cupones ha demostrado ser efectivo para recuperar Rank.`,
            `Competencia: Nuevos competidores han entrado con precios un 10% inferiores.`,
            `Volumen: La demanda de la categoría (Search Volume) se mantiene estable.`
        ];
        
        const actions = [
            `Ajuste de Precio: Evaluar reducción temporal si el competidor líder baja de precio.`,
            `Defensa de Rank: Activar PPC agresivo en keywords donde caímos del Top 5.`,
            `Conversión: Añadir cupón del 5% para mejorar CTR en listings con baja eficiencia.`
        ];
        
        insightsList.innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        actionsList.innerHTML = actions.map(i => `<li>${i}</li>`).join('');
        
        document.getElementById('other_insights_text').innerText = "Se detectaron anomalías en la semana 3 relacionadas con falta de stock probable en competidores clave (caída abrupta de share sin cambio de precio).";
    }

    // --- INTERACTIVE LOGIC ---
    
    function setupInteractive() {
        const selWeek = document.getElementById('sel_week');
        const selComp = document.getElementById('sel_competitor');
        
        // Populate Weeks
        processedWeeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            selWeek.add(opt);
        });
        selWeek.value = processedWeeks[processedWeeks.length - 1]; // Select last

        // Populate Competitors
        brandsList.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            selComp.add(opt);
        });
        
        updateComparator();
    }
    
    function updateComparator() {
        const week = document.getElementById('sel_week').value;
        const comp = document.getElementById('sel_competitor').value;
        
        const weekData = marketData.filter(d => d.week_date === week);
        
        const ourStats = weekData.filter(d => d.competitor_brand === ourBrandName);
        const compStats = weekData.filter(d => d.competitor_brand === comp);
        
        // Helper Agg
        const agg = (arr, key) => arr.length ? arr.reduce((s, v) => s + v[key], 0) / arr.length : 0;
        const sum = (arr, key) => arr.reduce((s, v) => s + v[key], 0);

        // Update UI Our
        document.getElementById('comp_our_name').innerText = ourBrandName;
        document.getElementById('comp_our_share').innerText = (sum(ourStats, 'click_share') * 100).toFixed(2) + '%';
        document.getElementById('comp_our_price').innerText = '$' + agg(ourStats, 'price').toFixed(2);
        
        // Update UI Comp
        document.getElementById('comp_comp_name_header').innerText = comp;
        document.getElementById('comp_comp_share').innerText = (sum(compStats, 'click_share') * 100).toFixed(2) + '%';
        document.getElementById('comp_comp_price').innerText = '$' + agg(compStats, 'price').toFixed(2);
        
        // Badges
        const renderBadges = (arr) => {
            let html = '';
            if (arr.some(d => d.weekly_number_of_days_with_deal > 0)) html += '<span class="badge badge-red">DEAL</span> ';
            if (arr.some(d => d.weekly_number_of_days_with_best_seller_badge > 0)) html += '<span class="badge badge-green">BS</span> ';
            return html || '<span style="color:#ccc; font-size:12px;">Sin Badges</span>';
        };
        
        document.getElementById('comp_our_badges').innerHTML = renderBadges(ourStats);
        document.getElementById('comp_comp_badges').innerHTML = renderBadges(compStats);
    }

    // --- UTILS ---
    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        // Find button
        const btnIndex = tabId === 'static' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
    }

</script>

</body>
</html>