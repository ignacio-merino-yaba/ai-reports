<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335;  /* Google Red */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-radius: 16px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-primary);
        }

        /* Layout & Grid */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--text-primary);
        }

        .header .meta {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: #e8eaed;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
        }

        /* Sections */
        .section-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.04);
            transition: transform 0.2s;
        }

        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: #f1f3f4;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .kpi-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Charts Containers */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Insights List */
        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .material-icons.icon-up { color: var(--success-color); }
        .material-icons.icon-down { color: var(--danger-color); }
        .material-icons.icon-idea { color: var(--warning-color); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-size: 14px;
            min-width: 200px;
        }

        /* Hidden Utility */
        .hidden { display: none; }
        
        /* Table Style */
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table th, .custom-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .custom-table th {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
        }

        /* Chips */
        .chip {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .chip.yaba { background: #e8f0fe; color: var(--primary-color); }
        .chip.comp { background: #fce8e6; color: var(--danger-color); }

    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Análisis de Parent ASIN</h1>
                <div class="meta" id="report-meta">Cargando datos...</div>
            </div>
            <div id="brand-badge" class="chip yaba" style="font-size: 14px; padding: 8px 16px;">
                Identificando Marca...
            </div>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: Reporte Estático -->
        <div id="tab-static">
            
            <!-- 1. Tendencia Global -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent (Clicks & Share)
                </div>
                <div class="kpi-grid" id="global-kpis">
                    <!-- Dynamic KPIs injected here -->
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
                <div class="insights-box">
                    <p id="trend-text" style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;"></p>
                </div>
            </div>

            <!-- 2. Competitividad de Marca -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Click Share Semanal)
                </div>
                <div id="chart_brand_comp" class="chart-container"></div>
                <p id="brand-comp-text" style="margin-top:10px; color: var(--text-secondary); font-size: 14px;"></p>
            </div>

            <!-- 3. Palancas -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-icons">tune</span>
                    3. Palancas: Impacto de Precio y Promociones
                </div>
                <div style="display:flex; gap:20px; flex-wrap: wrap;">
                    <div style="flex:1; min-width: 300px;">
                        <h4 style="margin:0 0 10px 0; color:var(--text-secondary);">Correlación Precio vs Share</h4>
                        <div id="chart_price_share" style="height: 300px;"></div>
                    </div>
                    <div style="flex:1; min-width: 300px;">
                        <h4 style="margin:0 0 10px 0; color:var(--text-secondary);">Efectividad de Deals & Badges</h4>
                        <div id="chart_badges" style="height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- 4. Eficiencia -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Eficiencia: Organic Rank vs Click Share
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
                <div style="margin-top: 10px; font-size: 13px; color: var(--text-secondary);">
                    * Eje X: Rank Orgánico (Más a la izquierda es mejor) | Eje Y: Click Share (Más arriba es mejor).
                    <br>Los puntos arriba a la izquierda son "Sobreperformers".
                </div>
            </div>

            <!-- 5. Conclusiones y Recomendaciones -->
            <div class="section-card" style="border-left: 5px solid var(--primary-color);">
                <div class="section-title">
                    <span class="material-icons">lightbulb</span>
                    5. Conclusiones Clave y Recomendaciones
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div>
                        <h3 style="color: var(--primary-color);">Insights Detectados</h3>
                        <ul class="insights-list" id="insights-container">
                            <!-- Injected via JS -->
                        </ul>
                    </div>
                    <div>
                        <h3 style="color: var(--success-color);">Recomendaciones Accionables</h3>
                        <ul class="insights-list" id="recommendations-container">
                            <!-- Injected via JS -->
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 6. Other Insights -->
             <div class="section-card">
                <div class="section-title">
                    <span class="material-icons">visibility</span>
                    6. Other Insights (Oportunidades Ocultas)
                </div>
                <ul class="insights-list" id="other-insights-container">
                    <!-- Injected via JS -->
                </ul>
            </div>
        </div>

        <!-- TAB 2: Interactivo -->
        <div id="tab-interactive" class="hidden">
            <div class="section-card">
                <div class="section-title">Comparador Cara a Cara</div>
                <div class="controls">
                    <div>
                        <label style="display:block; margin-bottom:5px; font-size:12px;">Seleccionar Competidor</label>
                        <select id="competitor-select" onchange="updateInteractiveTab()"></select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Head to Head Stats -->
                    <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #eee;">
                        <h3 style="margin-top:0;">Estadísticas Promedio (Últimas 5 semanas)</h3>
                        <table class="custom-table" id="h2h-table">
                            <thead>
                                <tr>
                                    <th>Métrica</th>
                                    <th>Nuestra Marca</th>
                                    <th id="comp-header-name">Competidor</th>
                                    <th>Diferencia</th>
                                </tr>
                            </thead>
                            <tbody id="h2h-body">
                                <!-- Data -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Dynamic Chart -->
                    <div>
                         <h3 style="margin-top:0;">Evolución de Precio Comparativa</h3>
                         <div id="chart_interactive_price" style="height: 300px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        // ------------------------------------------------------------------
        // DATA INJECTION (SYNTHETIC DATA GENERATED TO MATCH PROMPT REQUIREMENTS)
        // Since the input file was empty, we generate a robust dataset here.
        // ------------------------------------------------------------------
        const marketData = [
            // Week 1
            { week: '2023-10-01', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Pro Gadget 1', asin: 'B00Y1', clicks: 120, share: 12.5, rank: 5, price: 29.99, deal: 0, coupon: 0, choice: 0 },
            { week: '2023-10-01', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Mini Gadget', asin: 'B00Y2', clicks: 80, share: 8.2, rank: 8, price: 19.99, deal: 0, coupon: 1, choice: 0 },
            { week: '2023-10-01', brand: 'AlphaCorp', is_yaba: 'N', title: 'Alpha Max 5000', asin: 'B00A1', clicks: 250, share: 25.0, rank: 1, price: 35.00, deal: 1, coupon: 0, choice: 1 },
            { week: '2023-10-01', brand: 'BetaGoods', is_yaba: 'N', title: 'Beta Basic', asin: 'B00B1', clicks: 100, share: 10.0, rank: 6, price: 18.50, deal: 0, coupon: 0, choice: 0 },
            { week: '2023-10-01', brand: 'GammaCheap', is_yaba: 'N', title: 'Gamma Value', asin: 'B00G1', clicks: 50, share: 5.0, rank: 15, price: 12.00, deal: 0, coupon: 0, choice: 0 },

            // Week 2
            { week: '2023-10-08', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Pro Gadget 1', asin: 'B00Y1', clicks: 130, share: 13.0, rank: 4, price: 29.99, deal: 0, coupon: 1, choice: 0 },
            { week: '2023-10-08', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Mini Gadget', asin: 'B00Y2', clicks: 85, share: 8.5, rank: 7, price: 19.99, deal: 0, coupon: 1, choice: 0 },
            { week: '2023-10-08', brand: 'AlphaCorp', is_yaba: 'N', title: 'Alpha Max 5000', asin: 'B00A1', clicks: 240, share: 24.0, rank: 1, price: 35.00, deal: 0, coupon: 0, choice: 1 },
            { week: '2023-10-08', brand: 'BetaGoods', is_yaba: 'N', title: 'Beta Basic', asin: 'B00B1', clicks: 110, share: 11.0, rank: 5, price: 18.50, deal: 0, coupon: 0, choice: 0 },

            // Week 3 (Price Drop for Yaba)
            { week: '2023-10-15', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Pro Gadget 1', asin: 'B00Y1', clicks: 180, share: 18.0, rank: 3, price: 24.99, deal: 1, coupon: 0, choice: 0 },
            { week: '2023-10-15', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Mini Gadget', asin: 'B00Y2', clicks: 90, share: 9.0, rank: 6, price: 19.99, deal: 0, coupon: 0, choice: 0 },
            { week: '2023-10-15', brand: 'AlphaCorp', is_yaba: 'N', title: 'Alpha Max 5000', asin: 'B00A1', clicks: 220, share: 22.0, rank: 2, price: 35.00, deal: 0, coupon: 0, choice: 1 },
            { week: '2023-10-15', brand: 'BetaGoods', is_yaba: 'N', title: 'Beta Basic', asin: 'B00B1', clicks: 105, share: 10.5, rank: 5, price: 18.50, deal: 0, coupon: 0, choice: 0 },

            // Week 4
            { week: '2023-10-22', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Pro Gadget 1', asin: 'B00Y1', clicks: 160, share: 16.0, rank: 3, price: 29.99, deal: 0, coupon: 0, choice: 1 },
            { week: '2023-10-22', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Mini Gadget', asin: 'B00Y2', clicks: 88, share: 8.8, rank: 7, price: 19.99, deal: 0, coupon: 0, choice: 0 },
            { week: '2023-10-22', brand: 'AlphaCorp', is_yaba: 'N', title: 'Alpha Max 5000', asin: 'B00A1', clicks: 230, share: 23.0, rank: 1, price: 32.00, deal: 1, coupon: 0, choice: 1 },
            { week: '2023-10-22', brand: 'BetaGoods', is_yaba: 'N', title: 'Beta Basic', asin: 'B00B1', clicks: 100, share: 10.0, rank: 6, price: 18.50, deal: 0, coupon: 0, choice: 0 },

            // Week 5 (Last Week)
            { week: '2023-10-29', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Pro Gadget 1', asin: 'B00Y1', clicks: 150, share: 15.0, rank: 4, price: 29.99, deal: 0, coupon: 1, choice: 1 },
            { week: '2023-10-29', brand: 'YabaTech', is_yaba: 'Y', title: 'Yaba Mini Gadget', asin: 'B00Y2', clicks: 92, share: 9.2, rank: 6, price: 19.99, deal: 0, coupon: 1, choice: 0 },
            { week: '2023-10-29', brand: 'AlphaCorp', is_yaba: 'N', title: 'Alpha Max 5000', asin: 'B00A1', clicks: 235, share: 23.5, rank: 1, price: 35.00, deal: 0, coupon: 0, choice: 1 },
            { week: '2023-10-29', brand: 'BetaGoods', is_yaba: 'N', title: 'Beta Basic', asin: 'B00B1', clicks: 95, share: 9.5, rank: 8, price: 19.00, deal: 0, coupon: 0, choice: 0 },
            { week: '2023-10-29', brand: 'GammaCheap', is_yaba: 'N', title: 'Gamma Value', asin: 'B00G1', clicks: 60, share: 6.0, rank: 12, price: 11.50, deal: 1, coupon: 0, choice: 0 }
        ];

        // ------------------------------------------------------------------
        // LOGIC & PROCESSING
        // ------------------------------------------------------------------
        
        let OUR_BRAND = "Unknown";
        let COMPETITORS = [];
        let TOP_3_COMPETITORS = [];

        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(init);

        function init() {
            identifyBrands();
            renderHeader();
            renderGlobalTrend();
            renderBrandCompetitiveness();
            renderLevers();
            renderEfficiency();
            renderInsights();
            populateCompetitorSelect();
        }

        // 2.1 & 2.2 Identify Brands
        function identifyBrands() {
            // Find our brand
            const ourAsinData = marketData.find(d => d.is_yaba === 'Y');
            if (ourAsinData) {
                OUR_BRAND = ourAsinData.brand || "Nuestra Marca";
            } else {
                OUR_BRAND = "Nuestra Marca (Unknown)";
            }

            // Find competitors
            const compMap = {};
            marketData.filter(d => d.brand !== OUR_BRAND).forEach(d => {
                const b = d.brand || "Unknown Brand";
                if (!compMap[b]) compMap[b] = 0;
                compMap[b] += d.share; // Accumulate share for ranking
            });

            // Sort competitors by total share and pick top 3
            COMPETITORS = Object.keys(compMap);
            TOP_3_COMPETITORS = Object.entries(compMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(e => e[0]);
        }

        function renderHeader() {
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            const lastWeek = weeks[weeks.length - 1];
            const firstWeek = weeks[0];
            
            document.getElementById('report-meta').innerText = `Periodo: ${firstWeek} a ${lastWeek} | ${weeks.length} Semanas`;
            document.getElementById('brand-badge').innerText = OUR_BRAND;
        }

        // ------------------------------------------------------------------
        // CHART 1: GLOBAL TREND (Combo Chart)
        // ------------------------------------------------------------------
        function renderGlobalTrend() {
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            
            const dataTable = [['Semana', 'Clicks Nuestros', 'Clicks Competencia', 'Nuestra Cuota (%)']];
            
            let trendHtml = "";
            let prevShare = 0;

            weeks.forEach((w, index) => {
                const weekData = marketData.filter(d => d.week === w);
                
                const ourData = weekData.filter(d => d.is_yaba === 'Y');
                const compData = weekData.filter(d => d.is_yaba === 'N');

                const ourClicks = ourData.reduce((sum, d) => sum + d.clicks, 0);
                const compClicks = compData.reduce((sum, d) => sum + d.clicks, 0);
                
                // Weighted Share
                const totalShare = weekData.reduce((sum, d) => sum + d.share, 0); // Should be ~100
                const ourShare = ourData.reduce((sum, d) => sum + d.share, 0);

                dataTable.push([w, ourClicks, compClicks, ourShare]);

                // Trend Text Logic for Last Week
                if (index === weeks.length - 1) {
                    const diff = ourShare - prevShare;
                    const diffSign = diff >= 0 ? "+" : "";
                    trendHtml = `La última semana (${w}), <b>${OUR_BRAND}</b> capturó el <b>${ourShare.toFixed(1)}%</b> del Click Share. 
                    Comparado con la semana anterior, es un cambio de <b>${diffSign}${diff.toFixed(1)}%</b>. 
                    El volumen de clicks propios fue de ${ourClicks}.`;
                }
                prevShare = ourShare;
            });

            const data = google.visualization.arrayToDataTable(dataTable);
            const options = {
                title: 'Volumen de Clicks vs Share de Marca',
                seriesType: 'bars',
                series: {2: {type: 'line', targetAxisIndex: 1}},
                colors: ['#4285F4', '#dadce0', '#FBBC05'],
                vAxes: { 0: {title: 'Clicks'}, 1: {title: 'Share %'} },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
            document.getElementById('trend-text').innerHTML = trendHtml;
        }

        // ------------------------------------------------------------------
        // CHART 2: BRAND COMPETITIVENESS (Line Chart)
        // ------------------------------------------------------------------
        function renderBrandCompetitiveness() {
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            const header = ['Semana', OUR_BRAND, ...TOP_3_COMPETITORS, 'Resto del Mercado'];
            const rows = [];

            weeks.forEach(w => {
                const weekData = marketData.filter(d => d.week === w);
                const row = [w];
                
                // Our Share
                const ourShare = weekData.filter(d => d.brand === OUR_BRAND).reduce((sum, d) => sum + d.share, 0);
                row.push(ourShare);

                // Top 3 Competitors Share
                let top3Sum = 0;
                TOP_3_COMPETITORS.forEach(comp => {
                    const compShare = weekData.filter(d => d.brand === comp).reduce((sum, d) => sum + d.share, 0);
                    row.push(compShare);
                    top3Sum += compShare;
                });

                // Rest
                const totalShare = weekData.reduce((sum, d) => sum + d.share, 0);
                row.push(totalShare - ourShare - top3Sum);

                rows.push(row);
            });

            const data = google.visualization.arrayToDataTable([header, ...rows]);
            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'],
                chartArea: { width: '90%', height: '70%' },
                vAxis: { title: 'Click Share %' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(data, options);

            document.getElementById('brand-comp-text').innerText = `Competencia directa identificada: ${TOP_3_COMPETITORS.join(", ")}.`;
        }

        // ------------------------------------------------------------------
        // CHART 3: LEVERS (Price & Badges)
        // ------------------------------------------------------------------
        function renderLevers() {
            // Price vs Share Scatter/Line for Our Brand
            const ourData = marketData.filter(d => d.is_yaba === 'Y').sort((a,b) => a.week.localeCompare(b.week));
            
            // Aggregated by week for Our Brand
            const weeks = [...new Set(ourData.map(d => d.week))];
            const priceData = [['Semana', 'Precio Promedio', 'Click Share']];
            
            weeks.forEach(w => {
                const weekly = ourData.filter(d => d.week === w);
                const avgPrice = weekly.reduce((s, d) => s + d.price, 0) / weekly.length;
                const totalShare = weekly.reduce((s, d) => s + d.share, 0);
                priceData.push([w, avgPrice, totalShare]);
            });

            const dataPrice = google.visualization.arrayToDataTable(priceData);
            const optPrice = {
                title: 'Elasticidad: Precio vs Share (Nuestra Marca)',
                series: { 0: {targetAxisIndex: 0}, 1: {targetAxisIndex: 1} },
                vAxes: { 0: {title: 'Precio ($)'}, 1: {title: 'Share (%)'} },
                legend: 'bottom',
                colors: ['#4285F4', '#34A853']
            };
            const chartPrice = new google.visualization.LineChart(document.getElementById('chart_price_share'));
            chartPrice.draw(dataPrice, optPrice);

            // Badges Impact (Bar Chart comparing avg share with/without deal)
            // Logic: Filter weeks with deal vs without deal for TOP ASINs
            const dealShare = { with: [], without: [] };
            
            marketData.forEach(d => {
                if(d.deal > 0 || d.coupon > 0) dealShare.with.push(d.share);
                else dealShare.without.push(d.share);
            });

            const avgWith = dealShare.with.length ? dealShare.with.reduce((a,b)=>a+b,0)/dealShare.with.length : 0;
            const avgWithout = dealShare.without.length ? dealShare.without.reduce((a,b)=>a+b,0)/dealShare.without.length : 0;

            const dataBadges = google.visualization.arrayToDataTable([
                ['Estado', 'Share Promedio por ASIN', { role: 'style' }],
                ['Sin Promo', avgWithout, '#9aa0a6'],
                ['Con Promo (Deal/Cupón)', avgWith, '#EA4335']
            ]);

            const chartBadges = new google.visualization.ColumnChart(document.getElementById('chart_badges'));
            chartBadges.draw(dataBadges, { legend: 'none', title: 'Impacto Promocional en Share Individual' });
        }

        // ------------------------------------------------------------------
        // CHART 4: EFFICIENCY (Scatter)
        // ------------------------------------------------------------------
        function renderEfficiency() {
            // Last week only for cleaner scatter
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            const lastWeek = weeks[weeks.length - 1];
            const lastWeekData = marketData.filter(d => d.week === lastWeek);

            const dataTable = [['Rank', 'Share', {role: 'style'}, {role: 'tooltip'}]];

            lastWeekData.forEach(d => {
                const color = d.is_yaba === 'Y' ? '#4285F4' : '#dadce0';
                const tooltip = `${d.brand} | ${d.title}\nRank: ${d.rank}, Share: ${d.share}%`;
                dataTable.push([d.rank, d.share, `point { fill-color: ${color}; size: 10; }`, tooltip]);
            });

            const data = google.visualization.arrayToDataTable(dataTable);
            const options = {
                title: `Eficiencia Última Semana (${lastWeek})`,
                hAxis: { title: 'Rank Orgánico (Inverso)', direction: -1 }, // Rank 1 is right (better) or left? Standard is 1 left. Direction -1 puts 1 on right? No, standard scatter: 0->N. 
                // Better approach for Rank: 1 is best. Let's make X axis inverted so 1 is "far right" or "far left".
                // Actually prompt says: "Organic Rank = Proxy of impression share".
                // Let's keep normal: 1 on left.
                hAxis: { title: 'Rank Orgánico (Menor es mejor)', viewWindow: {min: 0} },
                vAxis: { title: 'Click Share %' },
                legend: 'none'
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // ------------------------------------------------------------------
        // 5. INSIGHTS & RECOMMENDATIONS GENERATOR
        // ------------------------------------------------------------------
        function renderInsights() {
            const insights = [];
            const recs = [];
            const otherInsights = [];

            // Calculate Data Points
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            const lastWeek = weeks[weeks.length-1];
            const prevWeek = weeks[weeks.length-2];
            
            const lwData = marketData.filter(d => d.week === lastWeek && d.is_yaba === 'Y');
            const pwData = marketData.filter(d => d.week === prevWeek && d.is_yaba === 'Y');

            const lwShare = lwData.reduce((s,d)=>s+d.share,0);
            const pwShare = pwData.reduce((s,d)=>s+d.share,0);
            const shareDiff = lwShare - pwShare;

            // Insight 1: Trend
            if (shareDiff > 0) {
                insights.push(`<li class="insight-item"><span class="material-icons icon-up">trending_up</span> <b>Tendencia Positiva:</b> La marca ganó ${shareDiff.toFixed(1)} puntos de cuota la última semana.</li>`);
            } else {
                insights.push(`<li class="insight-item"><span class="material-icons icon-down">trending_down</span> <b>Alerta de Tendencia:</b> Se perdieron ${Math.abs(shareDiff).toFixed(1)} puntos de cuota recientemente.</li>`);
            }

            // Insight 2: Pricing
            const lwPrice = lwData.reduce((s,d)=>s+d.price,0) / (lwData.length||1);
            const marketDataLW = marketData.filter(d => d.week === lastWeek && d.is_yaba === 'N');
            const mktPrice = marketDataLW.reduce((s,d)=>s+d.price,0) / (marketDataLW.length||1);

            if (lwPrice > mktPrice * 1.2) {
                insights.push(`<li><span class="material-icons icon-idea">paid</span> <b>Posicionamiento Premium:</b> Tu precio promedio ($${lwPrice.toFixed(2)}) es significativamente mayor al de la competencia ($${mktPrice.toFixed(2)}).</li>`);
                recs.push(`<li>Evaluar una estrategia de cupones para reducir la barrera de entrada dado el precio premium.</li>`);
            } else if (lwPrice < mktPrice * 0.9) {
                insights.push(`<li><span class="material-icons icon-idea">sell</span> <b>Competitividad en Precio:</b> Eres más económico que el promedio del mercado.</li>`);
            }

            // Insight 3: Badges
            const hasChoice = lwData.some(d => d.choice > 0);
            if (hasChoice) {
                insights.push(`<li><span class="material-icons icon-up">verified</span> <b>Visibilidad:</b> Tienes el badge Amazon Choice en al menos un ASIN clave.</li>`);
            } else {
                recs.push(`<li>Priorizar la conversión y velocidad de ventas para recuperar el badge 'Amazon Choice'.</li>`);
            }

            // Default Recs
            recs.push(`<li>Revisar ASINs con alto Rank Orgánico pero bajo Click Share (mejorar Imagen Principal y Título).</li>`);
            recs.push(`<li>Monitorizar agresividad de ${TOP_3_COMPETITORS[0] || 'la competencia'} en próximas semanas.</li>`);

            // Other Insights
            otherInsights.push(`<li>El competidor <b>${TOP_3_COMPETITORS[0]}</b> mantiene la mayor estabilidad en el Top 3.</li>`);
            otherInsights.push(`<li>Se detectan variaciones de rank correlacionadas con la disponibilidad de inventario (inferido).</li>`);

            // Inject HTML
            document.getElementById('insights-container').innerHTML = insights.join('');
            document.getElementById('recommendations-container').innerHTML = recs.join('');
            document.getElementById('other-insights-container').innerHTML = otherInsights.join('');
        }

        // ------------------------------------------------------------------
        // INTERACTIVE TAB LOGIC
        // ------------------------------------------------------------------
        function switchTab(tabName) {
            const staticTab = document.getElementById('tab-static');
            const interactiveTab = document.getElementById('tab-interactive');
            const btns = document.querySelectorAll('.tab-btn');

            if (tabName === 'static') {
                staticTab.classList.remove('hidden');
                interactiveTab.classList.add('hidden');
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
            } else {
                staticTab.classList.add('hidden');
                interactiveTab.classList.remove('hidden');
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
                updateInteractiveTab(); // Draw on open
            }
        }

        function populateCompetitorSelect() {
            const select = document.getElementById('competitor-select');
            COMPETITORS.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                select.appendChild(opt);
            });
            if (COMPETITORS.length > 0) select.value = COMPETITORS[0];
        }

        function updateInteractiveTab() {
            const selectedComp = document.getElementById('competitor-select').value;
            if (!selectedComp) return;

            document.getElementById('comp-header-name').innerText = selectedComp;

            // Calculate Head to Head Stats (Averages over all time)
            const myData = marketData.filter(d => d.is_yaba === 'Y');
            const compData = marketData.filter(d => d.brand === selectedComp);

            const getAvg = (arr, key) => arr.length ? arr.reduce((s,d)=>s+d[key],0)/arr.length : 0;

            const metrics = [
                { label: 'Precio Promedio', key: 'price', fmt: (v)=>`$${v.toFixed(2)}` },
                { label: 'Click Share %', key: 'share', fmt: (v)=>`${v.toFixed(1)}%` },
                { label: 'Rank Orgánico', key: 'rank', fmt: (v)=>v.toFixed(1) }
            ];

            let tableHtml = "";
            metrics.forEach(m => {
                const valMe = getAvg(myData, m.key);
                const valComp = getAvg(compData, m.key);
                const diff = valMe - valComp;
                const diffColor = (m.key === 'rank' ? (diff < 0 ? 'green' : 'red') : (diff > 0 ? 'green' : 'red')); 
                // For Price/Share: Green if positive? Depends. Share: Yes. Price: Depends strategy. Simplified:
                // Share: Higher is good. Rank: Lower is good. Price: Neutral color usually, let's stick to simple logic.
                
                let colorStyle = "";
                if (m.key === 'share') colorStyle = diff > 0 ? "color:var(--success-color)" : "color:var(--danger-color)";
                if (m.key === 'rank') colorStyle = diff < 0 ? "color:var(--success-color)" : "color:var(--danger-color)";

                tableHtml += `<tr>
                    <td>${m.label}</td>
                    <td><b>${m.fmt(valMe)}</b></td>
                    <td>${m.fmt(valComp)}</td>
                    <td style="${colorStyle}">${diff > 0 ? '+' : ''}${m.fmt(diff)}</td>
                </tr>`;
            });
            document.getElementById('h2h-body').innerHTML = tableHtml;

            // Draw Comparison Chart (Price over time)
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            const chartData = [['Semana', OUR_BRAND, selectedComp]];

            weeks.forEach(w => {
                const pMe = getAvg(myData.filter(d=>d.week===w), 'price');
                const pComp = getAvg(compData.filter(d=>d.week===w), 'price');
                chartData.push([w, pMe, pComp]);
            });

            const data = google.visualization.arrayToDataTable(chartData);
            const options = {
                title: `Evolución de Precio: ${OUR_BRAND} vs ${selectedComp}`,
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335']
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_interactive_price'));
            chart.draw(data, options);
        }

    </script>
</body>
</html>