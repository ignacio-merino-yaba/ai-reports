<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Parent ASIN Analysis: Matcha Premium</title>
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray: #F1F3F4;
            --text: #202124;
            --subtext: #5F6368;
            --card-bg: #FFFFFF;
            --radius: 16px;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: #F8F9FA;
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1280px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 500;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 20px;
            color: var(--subtext);
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 6px rgba(66, 133, 244, 0.3);
        }

        /* Cards & Grid */
        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .full-width { grid-column: span 2; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .card h3 {
            margin-top: 0;
            font-size: 16px;
            color: var(--subtext);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-big {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .insight-box {
            background-color: #F8F9FA;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .insight-box.alert { border-color: var(--danger); }
        .insight-box.success { border-color: var(--success); }

        /* Tables & Lists */
        ul.insight-list li {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .recommendation-card {
            background: #E8F0FE;
            color: #1967D2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        /* Interactive Section */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--radius);
        }

        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            min-width: 200px;
        }

        /* Utilities */
        .hidden { display: none; }
        .chart-container { height: 350px; width: 100%; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1 id="reportTitle">Parent ASIN Analysis: Matcha Premium</h1>
            <span style="font-size: 14px; color: #5F6368;" id="dateRangeDisplay">Loading data...</span>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 12px; color: #5F6368;">OUR BRAND</div>
            <div style="font-weight: bold; color: var(--primary); font-size: 18px;" id="ourBrandDisplay">Detecting...</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Executive Report</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Interactive Comparator</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- KPI Row -->
        <div class="grid-dashboard" style="grid-template-columns: repeat(4, 1fr);">
            <div class="card">
                <h3><span class="material-icons">ads_click</span> Total Clicks (Last Week)</h3>
                <div class="metric-big" id="kpiClicks">-</div>
                <div class="insight-box" id="kpiClicksTrend">-</div>
            </div>
            <div class="card">
                <h3><span class="material-icons">pie_chart</span> Our Click Share</h3>
                <div class="metric-big" id="kpiShare">-</div>
                <div class="insight-box" id="kpiShareDiff">-</div>
            </div>
            <div class="card">
                <h3><span class="material-icons">attach_money</span> Avg Price</h3>
                <div class="metric-big" id="kpiPrice">-</div>
                <div class="insight-box" id="kpiPriceGap">-</div>
            </div>
            <div class="card">
                <h3><span class="material-icons">trending_up</span> Organic Rank</h3>
                <div class="metric-big" id="kpiRank">-</div>
                <div class="insight-box" id="kpiEfficiency">-</div>
            </div>
        </div>

        <!-- Section 1 & 2: Trends -->
        <div class="grid-dashboard">
            <div class="card full-width">
                <h3>1. Global Parent Trend & Market Visibility</h3>
                <div id="chart_global_trend" class="chart-container"></div>
                <div class="insight-box" id="insight_global_trend">Analyzing market volume vs. our visibility...</div>
            </div>
            
            <div class="card full-width">
                <h3>2. Brand Competitiveness (Click Share Evolution)</h3>
                <div id="chart_brand_share" class="chart-container"></div>
                <div class="insight-box" id="insight_brand_comp">Identifying dominance shifts...</div>
            </div>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div class="grid-dashboard">
            <div class="card">
                <h3>3. Price vs. Share Correlation</h3>
                <div id="chart_price_share" class="chart-container"></div>
                <div class="insight-box" id="insight_price">Does higher price hurt our share?</div>
            </div>
            <div class="card">
                <h3>4. Organic Efficiency (Rank vs. Share)</h3>
                <div id="chart_efficiency" class="chart-container"></div>
                <div class="insight-box" id="insight_efficiency">Are we converting rank into clicks efficiently?</div>
            </div>
        </div>

        <!-- Section 5: Conclusions -->
        <div class="grid-dashboard">
            <div class="card">
                <h3><span class="material-icons">lightbulb</span> 5. Key Insights & Conclusions</h3>
                <ul class="insight-list" id="list_conclusions">
                    <li>Loading insights...</li>
                </ul>
            </div>
            <div class="card">
                <h3><span class="material-icons">check_circle</span> Recommendations</h3>
                <div id="list_recommendations">
                    <!-- Dynamic recs go here -->
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label style="display:block; font-size:12px; margin-bottom:4px;">Select Week</label>
                <select id="selWeek" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label style="display:block; font-size:12px; margin-bottom:4px;">Compare vs Competitor</label>
                <select id="selCompetitor" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="grid-dashboard">
            <div class="card full-width">
                <h3>Head-to-Head: Us vs. <span id="compNameDisplay">Competitor</span></h3>
                <div id="table_interactive" style="width: 100%; min-height: 200px;"></div>
            </div>
            <div class="card">
                <h3>Share Comparison</h3>
                <div id="chart_int_share" class="chart-container"></div>
            </div>
            <div class="card">
                <h3>Price Position</h3>
                <div id="chart_int_price" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA INJECTION -->
<script>
    // Injected Data from CSV Processing
    const rawData = [{"week": "2025-52", "asin": "B06XTYYYJ8", "brand": "Heapwell Superfoods", "is_yaba": "N", "title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "clicks": 6.46, "click_share": 6.46, "search_volume": 60416.88, "rank": 6.0, "price": 8.7, "deal_days": 6, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "Heapwell Superfoods"}, {"week": "2025-52", "asin": "B079VQ52MK", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "clicks": 4.59, "click_share": 4.59, "search_volume": 60416.88, "rank": 5.0, "price": 20.99, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "NaturaleBio"}, {"week": "2025-52", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "clicks": 13.11, "click_share": 13.11, "search_volume": 60416.88, "rank": 2.0, "price": 12.49, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 7, "raw_brand": "NaturaleBio"}, {"week": "2025-52", "asin": "B0F21VZMJQ", "brand": "Perfect Ted", "is_yaba": "N", "title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "clicks": 8.65, "click_share": 8.65, "search_volume": 60416.88, "rank": 3.0, "price": 16.99, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "Perfect Ted"}, {"week": "2025-52", "asin": "B08YRXQ2JH", "brand": "Double", "is_yaba": "N", "title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "clicks": 3.4, "click_share": 3.4, "search_volume": 60416.88, "rank": 13.0, "price": 6.98, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": null}, {"week": "2025-52", "asin": "B0D9M91WZD", "brand": "Perfect Ted", "is_yaba": "N", "title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "clicks": 3.45, "click_share": 3.45, "search_volume": 60416.88, "rank": 10.0, "price": 9.49, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "Perfect Ted"}, {"week": "2025-52", "asin": "B09DQ1PWGX", "brand": "Perfect Ted", "is_yaba": "N", "title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "clicks": 9.27, "click_share": 9.27, "search_volume": 60416.88, "rank": 8.0, "price": 9.49, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "Perfect Ted"}, {"week": "2026-01", "asin": "B06XTYYYJ8", "brand": "Heapwell Superfoods", "is_yaba": "N", "title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "clicks": 5.74, "click_share": 5.74, "search_volume": 40891.21, "rank": 6.0, "price": 9.99, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "Heapwell Superfoods"}, {"week": "2026-01", "asin": "B079VQ52MK", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "clicks": 3.39, "click_share": 3.39, "search_volume": 40891.21, "rank": 7.0, "price": 20.99, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "NaturaleBio"}, {"week": "2026-01", "asin": "B0C71LZNV6", "brand": "Matcha", "is_yaba": "N", "title": "Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...", "clicks": 2.56, "click_share": 2.56, "search_volume": 40891.21, "rank": 12.0, "price": 24.95, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": null}, {"week": "2026-01", "asin": "B09DQ1PWGX", "brand": "Perfect Ted", "is_yaba": "N", "title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "clicks": 4.64, "click_share": 4.64, "search_volume": 40891.21, "rank": 34.0, "price": 2.12, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "Perfect Ted"}, {"week": "2026-01", "asin": "B08YRXQ2JH", "brand": "Double", "is_yaba": "N", "title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "clicks": 3.32, "click_share": 3.32, "search_volume": 40891.21, "rank": 13.0, "price": 6.98, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": null}, {"week": "2026-01", "asin": "B0F21VZMJQ", "brand": "Perfect Ted", "is_yaba": "N", "title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "clicks": 10.49, "click_share": 10.49, "search_volume": 40891.21, "rank": 3.0, "price": 16.99, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 1, "raw_brand": "Perfect Ted"}, {"week": "2026-01", "asin": "B0D9M91WZD", "brand": "Perfect Ted", "is_yaba": "N", "title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "clicks": 2.79, "click_share": 2.79, "search_volume": 40891.21, "rank": 9.0, "price": 11.0, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "Perfect Ted"}, {"week": "2026-01", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "clicks": 13.79, "click_share": 13.79, "search_volume": 40891.21, "rank": 1.0, "price": 12.49, "deal_days": 0, "coupon_days": 0, "best_seller_days": 0, "amazon_choice_days": 4, "raw_brand": "NaturaleBio"}, {"week": "2026-01", "asin": "B08YK2RPBZ", "brand": "SuperSelf", "is_yaba": "N", "title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "clicks": 9.83, "click_share": 9.83, "search_volume": 40891.21, "rank": 4.0, "price": 9.9, "deal_days": 0, "coupon_days": 4, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "SuperSelf"}, {"week": "2026-01", "asin": "B082DKRSB4", "brand": "SuperSelf", "is_yaba": "N", "title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "clicks": 3.96, "click_share": 3.96, "search_volume": 40891.21, "rank": 8.0, "price": 14.86, "deal_days": 4, "coupon_days": 4, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "SuperSelf"}, {"week": "2025-52", "asin": "B082DKRSB4", "brand": "SuperSelf", "is_yaba": "N", "title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "clicks": 2.95, "click_share": 2.95, "search_volume": 60416.88, "rank": 8.0, "price": 19.18, "deal_days": 1, "coupon_days": 7, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "SuperSelf"}, {"week": "2025-52", "asin": "B08YK2RPBZ", "brand": "SuperSelf", "is_yaba": "N", "title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "clicks": 7.98, "click_share": 7.98, "search_volume": 60416.88, "rank": 5.0, "price": 9.9, "deal_days": 0, "coupon_days": 7, "best_seller_days": 0, "amazon_choice_days": 1, "raw_brand": "SuperSelf"}, {"week": "2025-52", "asin": "B00HNDSOCI", "brand": "PureChimp", "is_yaba": "Y", "title": "PureChimp Ceremonial Grade Matcha Powder 50g. 100%...", "clicks": 2.34, "click_share": 2.34, "search_volume": 60416.88, "rank": 12.0, "price": 14.95, "deal_days": 0, "coupon_days": 7, "best_seller_days": 0, "amazon_choice_days": 0, "raw_brand": "PureChimp"}];
    
    // Calculate Clicks from Share and Vol
    rawData.forEach(d => {
        d.est_clicks = (d.click_share / 100) * d.search_volume;
    });

    let MY_BRAND = "Unknown";
    const myBrandEntry = rawData.find(d => d.is_yaba === 'Y');
    if (myBrandEntry) MY_BRAND = myBrandEntry.brand;
    document.getElementById('ourBrandDisplay').textContent = MY_BRAND;

    // Helper: Sort weeks
    const weeks = [...new Set(rawData.map(d => d.week))].sort();
    const lastWeek = weeks[weeks.length - 1];
    const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;

    document.getElementById('dateRangeDisplay').textContent = `Period: ${weeks[0]} to ${lastWeek}`;

    // --- LOGIC: AGGREGATE DATA ---
    function aggregateData() {
        // By Week + Brand
        const agg = {}; 
        
        rawData.forEach(d => {
            const key = `${d.week}_${d.brand}`;
            if (!agg[key]) {
                agg[key] = {
                    week: d.week,
                    brand: d.brand,
                    clicks: 0,
                    shareSum: 0,
                    shareCount: 0, // for simple avg if needed, but we sum share for brand total
                    revenueProxy: 0,
                    minRank: 999,
                    is_yaba: d.is_yaba === 'Y',
                    priceSum: 0,
                    count: 0
                };
            }
            agg[key].clicks += d.est_clicks;
            agg[key].shareSum += d.click_share; // Sum share across ASINs of same brand
            agg[key].priceSum += d.price;
            agg[key].count += 1;
            if (d.rank < agg[key].minRank && d.rank > 0) agg[key].minRank = d.rank;
        });

        const result = Object.values(agg).map(d => ({
            ...d,
            avgPrice: d.priceSum / d.count
        }));
        
        return result;
    }

    const brandData = aggregateData();

    // --- IDENTIFY TOP COMPETITORS ---
    // Based on total share in last week
    const lastWeekBrands = brandData.filter(d => d.week === lastWeek).sort((a,b) => b.shareSum - a.shareSum);
    const topCompetitors = lastWeekBrands
        .filter(d => d.brand !== MY_BRAND)
        .slice(0, 3)
        .map(d => d.brand);
    
    // --- GOOGLE CHARTS LOGIC ---
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawPriceCorrelation();
        drawEfficiency();
        calculateKPIs();
        generateTextInsights();
        setupInteractive();
    }

    // 1. GLOBAL TREND (Parent Level)
    function drawGlobalTrend() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Total Market Clicks');
        data.addColumn('number', 'Our Share (%)');
        data.addColumn('number', 'Competitor Share (%)');

        weeks.forEach(w => {
            // My stats
            const myStats = brandData.find(d => d.week === w && d.brand === MY_BRAND);
            const myShare = myStats ? myStats.shareSum : 0;
            
            // Total Market Clicks (Sum of all est_clicks for that week)
            const weekEntries = rawData.filter(d => d.week === w);
            const totalClicks = weekEntries.reduce((sum, d) => sum + d.est_clicks, 0);
            
            // Competitor Share (Total - Mine)
            // Note: Total Share sum of all ASINs might not be 100% due to data limitation, 
            // but we use Sum of Comp Brands share.
            const compShare = weekEntries
                .filter(d => d.is_yaba !== 'Y')
                .reduce((sum, d) => sum + d.click_share, 0);

            data.addRow([w, totalClicks, myShare, compShare]);
        });

        const options = {
            seriesType: 'bars',
            series: {
                1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3},
                2: {type: 'line', targetAxisIndex: 1, color: '#EA4335', lineDashStyle: [4, 4]}
            },
            vAxes: {
                0: {title: 'Est. Clicks (Volume)'},
                1: {title: 'Click Share %', format: '#\'%\''}
            },
            legend: {position: 'bottom'},
            chartArea: {width: '80%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // 2. BRAND COMPETITIVENESS
    function drawBrandCompetitiveness() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', MY_BRAND);
        topCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Others');

        weeks.forEach(w => {
            const row = [w];
            // Me
            const myD = brandData.find(d => d.week === w && d.brand === MY_BRAND);
            row.push(myD ? myD.shareSum : 0);
            
            // Top Comps
            let topCompSum = 0;
            topCompetitors.forEach(c => {
                const cD = brandData.find(d => d.week === w && d.brand === c);
                const val = cD ? cD.shareSum : 0;
                row.push(val);
                topCompSum += val;
            });

            // Others
            // Total share this week
            const weekTotalShare = rawData.filter(d => d.week === w).reduce((s,x) => s + x.click_share, 0);
            const myShare = myD ? myD.shareSum : 0;
            const others = Math.max(0, weekTotalShare - myShare - topCompSum);
            row.push(others);

            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            legend: {position: 'bottom'},
            vAxis: {title: 'Click Share %'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    // 3. PRICE VS SHARE
    function drawPriceCorrelation() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'ASIN (Week)'); // ID
        data.addColumn('number', 'Price');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'});
        data.addColumn({type: 'string', role: 'tooltip'});

        // Plot individual ASIN points for the LAST WEEK only to see current landscape
        const weekData = rawData.filter(d => d.week === lastWeek);
        
        weekData.forEach(d => {
            const color = d.is_yaba === 'Y' ? '#4285F4' : (topCompetitors.includes(d.brand) ? '#EA4335' : '#9AA0A6');
            const tooltip = `${d.brand} \nPrice: Â£${d.price} \nShare: ${d.click_share}%`;
            data.addRow([d.asin, d.price, d.click_share, `point {fill-color: ${color}}`, tooltip]);
        });

        const options = {
            hAxis: {title: 'Price (Â£)'},
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_price_share'));
        chart.draw(data, options);
    }

    // 4. EFFICIENCY (Rank vs Share)
    function drawEfficiency() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        // Last week only
        const weekData = rawData.filter(d => d.week === lastWeek);

        weekData.forEach(d => {
            const color = d.is_yaba === 'Y' ? '#4285F4' : '#999';
            // Invert Rank for visual (1 is top) -> Actually ScatterChart standard is X axis. 
            // We want High Share (Y) and Low Rank (X left).
            data.addRow([d.rank, d.click_share, `point {fill-color: ${color}}`, `${d.brand}: Rank ${d.rank}, Share ${d.click_share}%`]);
        });

        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: 1},
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // 5. CALCULATE KPIs
    function calculateKPIs() {
        // Last week specific logic
        const myLast = brandData.find(d => d.week === lastWeek && d.brand === MY_BRAND);
        const myPrev = prevWeek ? brandData.find(d => d.week === prevWeek && d.brand === MY_BRAND) : null;

        // Share
        const share = myLast ? myLast.shareSum.toFixed(2) : "0.00";
        const shareDiff = (myLast && myPrev) ? (myLast.shareSum - myPrev.shareSum).toFixed(2) : "0.00";
        
        document.getElementById('kpiShare').innerText = share + '%';
        setInsightBox('kpiShareDiff', shareDiff, '% vs prev week');

        // Clicks
        const clicks = myLast ? Math.round(myLast.clicks) : 0;
        const clicksPrev = myPrev ? myPrev.clicks : 0;
        const clickDiff = clicks - clicksPrev;
        document.getElementById('kpiClicks').innerText = clicks.toLocaleString();
        setInsightBox('kpiClicksTrend', clickDiff > 0 ? '+' + clickDiff : clickDiff, ' clicks vs prev week');

        // Avg Price
        const price = myLast ? myLast.avgPrice.toFixed(2) : "0.00";
        // Market Avg Price
        const marketLast = rawData.filter(d => d.week === lastWeek);
        const marketAvgPrice = marketLast.reduce((s,d) => s+d.price,0) / marketLast.length;
        const priceGap = myLast ? (myLast.avgPrice - marketAvgPrice) : 0;
        
        document.getElementById('kpiPrice').innerText = 'Â£' + price;
        const gapText = priceGap > 0 ? `+Â£${priceGap.toFixed(2)} vs Market` : `-Â£${Math.abs(priceGap).toFixed(2)} vs Market`;
        setInsightBox('kpiPriceGap', gapText, '', priceGap > 0 ? 'alert' : 'success'); // High price = alert generally? Context dependent.

        // Rank
        const rank = myLast ? myLast.minRank : "-";
        document.getElementById('kpiRank').innerText = "#" + rank;
        document.getElementById('kpiEfficiency').innerText = "Best Organic Position";
    }

    function setInsightBox(id, val, suffix, type) {
        const el = document.getElementById(id);
        el.innerText = `${val}${suffix}`;
        if(parseFloat(val) > 0) el.className = "insight-box success";
        else if(parseFloat(val) < 0) el.className = "insight-box alert";
        else el.className = "insight-box";
        
        if (type) el.className = `insight-box ${type}`;
    }

    // 6. GENERATE TEXT INSIGHTS
    function generateTextInsights() {
        const ul = document.getElementById('list_conclusions');
        const recs = document.getElementById('list_recommendations');
        ul.innerHTML = '';
        recs.innerHTML = '';

        const myLast = brandData.find(d => d.week === lastWeek && d.brand === MY_BRAND);
        const lastWeekMarket = rawData.filter(d => d.week === lastWeek);
        
        // Insight 1: Share Trend
        const shareTrend = (parseFloat(document.getElementById('kpiShareDiff').innerText) >= 0) ? "growing" : "declining";
        ul.innerHTML += `<li><span class="material-icons" style="color:${shareTrend==='growing'?'green':'red'}">trending_${shareTrend==='growing'?'up':'down'}</span> <strong>Global Trend:</strong> Our brand is ${shareTrend} in click share this week compared to last.</li>`;

        // Insight 2: Dominator
        const winner = lastWeekBrands[0];
        ul.innerHTML += `<li><span class="material-icons" style="color:#FBBC05">emoji_events</span> <strong>Market Leader:</strong> ${winner.brand} leads with ${winner.shareSum.toFixed(1)}% share.</li>`;

        // Insight 3: Price Position
        const myPrice = myLast ? myLast.avgPrice : 0;
        const cheaperCompetitors = lastWeekBrands.filter(b => b.brand !== MY_BRAND && b.avgPrice < myPrice);
        if (cheaperCompetitors.length > 0) {
            ul.innerHTML += `<li><span class="material-icons">sell</span> <strong>Price Pressure:</strong> ${cheaperCompetitors.length} competitors are priced lower, notably ${cheaperCompetitors[0].brand} at Â£${cheaperCompetitors[0].avgPrice.toFixed(2)}.</li>`;
        }

        // Insight 4: Deals
        const myDeals = lastWeekMarket.filter(d => d.is_yaba === 'Y' && d.deal_days > 0);
        if (myDeals.length === 0) {
            ul.innerHTML += `<li><span class="material-icons">warning</span> <strong>Promo Gap:</strong> We had no active deals this week. Competitors with deals gained visibility.</li>`;
        } else {
             ul.innerHTML += `<li><span class="material-icons">local_offer</span> <strong>Promo Active:</strong> We ran deals on ${myDeals.length} ASINs. Check efficiency chart for impact.</li>`;
        }

        // Insight 5: Badges
        const acBadge = lastWeekMarket.find(d => d.is_yaba === 'Y' && d.amazon_choice_days > 0);
        if (acBadge) {
             ul.innerHTML += `<li><span class="material-icons">verified</span> <strong>Badging:</strong> We hold the Amazon Choice badge on at least one ASIN, boosting CTR potential.</li>`;
        }

        // Recommendations
        if (shareTrend === 'declining') {
            recs.innerHTML += `<div class="recommendation-card">ðŸ“‰ Action: Investigate price elasticity. Consider a temporary coupon to regain momentum.</div>`;
        }
        if (myPrice > 15 && winner.avgPrice < 12) {
             recs.innerHTML += `<div class="recommendation-card">ðŸ’² Pricing: Gap vs Leader (${winner.brand}) is significant. Review Value Proposition or Bundle strategy.</div>`;
        }
        recs.innerHTML += `<div class="recommendation-card">ðŸ”Ž SEO: Ensure 'Matcha' keywords are optimized in bullets for ASINs ranking below #5.</div>`;
    }

    // --- INTERACTIVE SECTION ---
    function setupInteractive() {
        const selWeek = document.getElementById('selWeek');
        const selComp = document.getElementById('selCompetitor');
        
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            selWeek.add(opt);
        });
        selWeek.value = lastWeek; // Default to latest

        topCompetitors.forEach(c => {
             const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            selComp.add(opt);
        });
        // Add others if needed
        const allBrands = [...new Set(rawData.map(d => d.brand))].filter(b => b!==MY_BRAND && !topCompetitors.includes(b));
        allBrands.forEach(c => {
             const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            selComp.add(opt);
        });

        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('selWeek').value;
        const comp = document.getElementById('selCompetitor').value;
        document.getElementById('compNameDisplay').innerText = comp;

        const weekData = rawData.filter(d => d.week === week);
        
        // 1. Table Data
        // Aggregate specific to this comparison
        // We compare My Brand (Aggregated) vs Competitor Brand (Aggregated)
        
        const getStats = (brand) => {
            const entries = weekData.filter(d => d.brand === brand);
            if (entries.length === 0) return { share: 0, price: 0, rank: 0, deals: 0 };
            return {
                share: entries.reduce((s,d)=>s+d.click_share,0).toFixed(2),
                price: (entries.reduce((s,d)=>s+d.price,0) / entries.length).toFixed(2),
                rank: Math.min(...entries.map(d=>d.rank)),
                deals: entries.reduce((s,d)=>s+d.deal_days,0)
            };
        };

        const myStats = getStats(MY_BRAND);
        const compStats = getStats(comp);

        const tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'Metric');
        tableData.addColumn('string', 'Our Brand');
        tableData.addColumn('string', comp);
        tableData.addColumn('string', 'Diff');

        const metrics = [
            {k:'Click Share %', v:'share'},
            {k:'Avg Price (Â£)', v:'price'},
            {k:'Best Rank', v:'rank'},
            {k:'Total Deal Days', v:'deals'}
        ];

        metrics.forEach(m => {
            const v1 = parseFloat(myStats[m.v]);
            const v2 = parseFloat(compStats[m.v]);
            let diff = (v1 - v2).toFixed(2);
            if (m.v === 'rank') diff = (v2 - v1).toFixed(0); // Lower rank is better, so Pos means we are better
            
            tableData.addRow([m.k, myStats[m.v].toString(), compStats[m.v].toString(), diff > 0 ? '+'+diff : diff]);
        });

        const table = new google.visualization.Table(document.getElementById('table_interactive'));
        table.draw(tableData, {width: '100%', height: '100%'});

        // 2. Interactive Charts (Share History Comparison)
        const histData = new google.visualization.DataTable();
        histData.addColumn('string', 'Week');
        histData.addColumn('number', 'Us');
        histData.addColumn('number', comp);

        weeks.forEach(w => {
            const dMy = brandData.find(d => d.week === w && d.brand === MY_BRAND);
            const dComp = brandData.find(d => d.week === w && d.brand === comp);
            histData.addRow([w, dMy?dMy.shareSum:0, dComp?dComp.shareSum:0]);
        });

        new google.visualization.LineChart(document.getElementById('chart_int_share')).draw(histData, {
            legend: 'bottom', colors: ['#4285F4', '#EA4335'], title: 'Share History'
        });

        // Price History
        const priceData = new google.visualization.DataTable();
        priceData.addColumn('string', 'Week');
        priceData.addColumn('number', 'Us');
        priceData.addColumn('number', comp);
        weeks.forEach(w => {
            const dMy = brandData.find(d => d.week === w && d.brand === MY_BRAND);
            const dComp = brandData.find(d => d.week === w && d.brand === comp);
            priceData.addRow([w, dMy?dMy.avgPrice:0, dComp?dComp.avgPrice:0]);
        });
         new google.visualization.LineChart(document.getElementById('chart_int_price')).draw(priceData, {
            legend: 'bottom', colors: ['#4285F4', '#EA4335'], title: 'Avg Price History', curveType: 'function'
        });

    }

    // Helper for Tabs
    window.switchTab = function(tabName) {
        document.getElementById('tab-static').className = tabName === 'static' ? '' : 'hidden';
        document.getElementById('tab-interactive').className = tabName === 'interactive' ? '' : 'hidden';
        
        const btns = document.querySelectorAll('.tab-btn');
        btns[0].className = tabName === 'static' ? 'tab-btn active' : 'tab-btn';
        btns[1].className = tabName === 'interactive' ? 'tab-btn active' : 'tab-btn';
    }

</script>

</body>
</html>