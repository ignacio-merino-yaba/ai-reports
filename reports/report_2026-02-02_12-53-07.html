<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon ASIN Intelligence Report</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4285F4; /* Yaba/Our Brand */
            --secondary-color: #5f6368;
            --success-color: #34A853;
            --warning-color: #FBBC05;
            --danger-color: #EA4335;
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --border-radius: 8px;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #202124;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: var(--card-bg);
            padding: 20px 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1 {
            font-size: 22px;
            margin: 0;
            font-weight: 500;
            color: #202124;
        }

        h2 {
            font-size: 18px;
            margin: 0 0 16px 0;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        h3 {
             font-size: 16px;
             font-weight: 500;
             color: var(--primary-color);
             margin-top: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards & Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            height: 100%;
            box-sizing: border-box;
        }

        .kpi-card {
            text-align: center;
        }
        .kpi-value {
            font-size: 28px;
            font-weight: 500;
            color: var(--primary-color);
            margin: 8px 0;
        }
        .kpi-label {
            font-size: 12px;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .kpi-sub {
            font-size: 12px;
            color: #34A853; /* Assuming positive */
        }

        /* Charts Container */
        .chart-container {
            width: 100%;
            height: 300px;
        }
        
        /* Insights Section */
        .insight-box {
            background: #e8f0fe;
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 0 4px 4px 0;
        }
        .insight-title {
            font-weight: 700;
            color: #1967d2;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .rec-box {
            background: #e6f4ea;
            border-left: 4px solid var(--success-color);
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 0 4px 4px 0;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            background: white;
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            align-items: center;
        }
        
        select {
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            outline: none;
        }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #e0e0e0; color: #5f6368; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f4; }
        tr:hover { background-color: #f8f9fa; }

        /* Utilities */
        .text-red { color: var(--danger-color); }
        .text-green { color: var(--success-color); }
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge-yaba { background: #e8f0fe; color: #1967d2; }
        .badge-comp { background: #fce8e6; color: #c5221f; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-content">
            <div>
                <h1>Parent ASIN Intelligence Report</h1>
                <div style="font-size: 12px; color: #5f6368; margin-top: 4px;" id="report-meta">Loading data...</div>
            </div>
            <div>
                <span class="badge badge-yaba" id="yaba-brand-display">Our Brand: Loading...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">1. Strategic Dashboard</div>
            <div class="tab" onclick="switchTab('comparator')">2. Competitive Deep Dive</div>
        </div>

        <!-- TAB 1: DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            
            <!-- Global Trend Section -->
            <div class="card" style="margin-bottom: 24px;">
                <h2>1. Global Parent Trend (Aggregated)</h2>
                <div id="trend_chart_div" class="chart-container" style="height: 350px;"></div>
                <div class="grid-4" style="margin-top: 16px; margin-bottom: 0;">
                    <div class="kpi-card">
                        <div class="kpi-label">Total Market Clicks (Last Wk)</div>
                        <div class="kpi-value" id="kpi-total-clicks">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Our Click Share</div>
                        <div class="kpi-value" id="kpi-our-share">-</div>
                    </div>
                     <div class="kpi-card">
                        <div class="kpi-label">Competitor Click Share</div>
                        <div class="kpi-value" id="kpi-comp-share">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Avg Market Price</div>
                        <div class="kpi-value" id="kpi-avg-price">-</div>
                    </div>
                </div>
            </div>

            <!-- Brand Competitiveness -->
            <div class="grid-2">
                <div class="card">
                    <h2>2. Brand Competitiveness (Share of Voice)</h2>
                    <div id="brand_chart_div" class="chart-container"></div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        Compares our brand against the Top 3 Competitors by volume.
                    </p>
                </div>
                <div class="card">
                    <h2>4. Efficiency: Rank vs Click Share</h2>
                    <div id="efficiency_chart_div" class="chart-container"></div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        <strong>Above Line:</strong> Overperformers (High Share for Rank).<br>
                        <strong>Below Line:</strong> Underperformers (Low Share for Rank).
                    </p>
                </div>
            </div>

            <!-- Palancas / Drivers -->
            <div class="card" style="margin-bottom: 24px;">
                <h2>3. ðŸš€ Growth Drivers (Impact Analysis)</h2>
                <div class="grid-3">
                    <div>
                        <h3>Price Elasticity</h3>
                        <div id="price_impact_div" style="height: 200px;"></div>
                    </div>
                    <div>
                        <h3>Promotions (Deals/Coupons)</h3>
                        <div id="promo_impact_div" style="height: 200px;"></div>
                    </div>
                    <div>
                        <h3>Badges (Choice/BestSeller)</h3>
                        <div id="badge_impact_div" style="height: 200px;"></div>
                    </div>
                </div>
            </div>

            <!-- Conclusions -->
            <div class="grid-2">
                <div class="card">
                    <h2>5. ðŸ’¡ Key Insights</h2>
                    <div id="insights-container">
                        <!-- Populated via JS -->
                    </div>
                </div>
                <div class="card">
                    <h2>âœ… Recommended Actions</h2>
                    <div id="actions-container">
                        <!-- Populated via JS -->
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>6. Other Insights & Anomalies</h2>
                <div id="other-insights-container" style="font-size: 14px; color: #444;"></div>
            </div>

        </div>

        <!-- TAB 2: COMPARATOR -->
        <div id="comparator" class="tab-content">
            <div class="controls">
                <div>
                    <label style="font-size: 12px; display: block; margin-bottom: 4px;">Select Week</label>
                    <select id="comp-week-select" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="font-size: 12px; display: block; margin-bottom: 4px;">Select Competitor</label>
                    <select id="comp-brand-select" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="grid-3">
                <div class="card kpi-card">
                    <div class="kpi-label">Price Gap</div>
                    <div class="kpi-value" id="comp-price-gap">-</div>
                    <div class="kpi-sub" id="comp-price-sub">vs Competitor</div>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-label">Click Share Gap</div>
                    <div class="kpi-value" id="comp-share-gap">-</div>
                    <div class="kpi-sub" id="comp-share-sub">vs Competitor</div>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-label">Rank Gap</div>
                    <div class="kpi-value" id="comp-rank-gap">-</div>
                    <div class="kpi-sub" id="comp-rank-sub">Lower is better</div>
                </div>
            </div>

            <div class="card">
                <h2>Detailed Head-to-Head</h2>
                <div id="comparator_table_div"></div>
            </div>
        </div>

    </div>

    <!-- MAIN LOGIC -->
    <script>
        // --- 1. DATA INJECTION ---
        // INSTRUCTION: If you have real data, replace the array below. 
        // This is MOCK DATA generated to demonstrate the report capabilities as the input file was empty.
        const marketData = [{"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "test keyword", "competitor_brand": "YabaBrand", "asin": "Yab_1", "product_title": "YabaBrand Product Title Variant 1", "country_code": "ES", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0818, "impression_share": 0.0982, "price": 29.99, "click_share_rank": 5, "weekly_search_volume": 7674, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 627}, {"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "test keyword", "competitor_brand": "YabaBrand", "asin": "Yab_2", "product_title": "YabaBrand Product Title Variant 2", "country_code": "ES", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0683, "impression_share": 0.082, "price": 29.99, "click_share_rank": 4, "weekly_search_volume": 7674, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 524}, {"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "test keyword", "competitor_brand": "AlphaBrand", "asin": "Alp_1", "product_title": "AlphaBrand Product Title Variant 1", "country_code": "ES", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1245, "impression_share": 0.1494, "price": 35.0, "click_share_rank": 2, "weekly_search_volume": 7674, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 955}, {"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "test keyword", "competitor_brand": "AlphaBrand", "asin": "Alp_2", "product_title": "AlphaBrand Product Title Variant 2", "country_code": "ES", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1245, "impression_share": 0.1494, "price": 35.0, "click_share_rank": 2, "weekly_search_volume": 7674, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 955}, {"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "test keyword", "competitor_brand": "BetaBrand", "asin": "Bet_1", "product_title": "BetaBrand Product Title Variant 1", "country_code": "ES", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.0544, "impression_share": 0.0653, "price": 19.99, "click_share_rank": 10, "weekly_search_volume": 7674, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 417}, {"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "test keyword", "competitor_brand": "YabaBrand", "asin": "Yab_1", "product_title": "YabaBrand Product Title Variant 1", "country_code": "ES", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.063, "impression_share": 0.0756, "price": 29.99, "click_share_rank": 6, "weekly_search_volume": 5664, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 356}, {"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "test keyword", "competitor_brand": "GammaBrand", "asin": "Gam_1", "product_title": "GammaBrand Product Title Variant 1", "country_code": "ES", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0456, "impression_share": 0.0547, "price": 28.5, "click_share_rank": 13, "weekly_search_volume": 6773, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 308}, {"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "test keyword", "competitor_brand": "YabaBrand", "asin": "Yab_1", "product_title": "YabaBrand Product Title Variant 1", "country_code": "ES", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.105, "impression_share": 0.126, "price": 23.99, "click_share_rank": 3, "weekly_search_volume": 6123, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 642}, {"brand_aggregation": "Test Aggregation", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "test keyword", "competitor_brand": "AlphaBrand", "asin": "Alp_1", "product_title": "AlphaBrand Product Title Variant 1", "country_code": "ES", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.13, "impression_share": 0.156, "price": 35.0, "click_share_rank": 1, "weekly_search_volume": 6123, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/test", "grams": 500, "organic_or_not": "Organic", "container": "Bottle", "clicks": 795}];

        // --- 2. CONFIG & HELPERS ---
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(init);

        let processedData = [];
        let ourBrandName = "Unknown";
        let competitorBrands = [];
        let top3Competitors = [];
        let weeks = [];

        function init() {
            preprocessData();
            renderDashboard();
            setupComparator();
            document.getElementById('report-meta').innerText = `Data Range: ${weeks[0]} to ${weeks[weeks.length-1]} | Parent ASIN: ${marketData[0].parent_asin}`;
        }

        function preprocessData() {
            // 1. Identify Brands & Fix Nulls
            marketData.forEach(row => {
                if (!row.competitor_brand) {
                    row.competitor_brand = extractBrand(row.product_title) || "Unknown Brand";
                }
                // Ensure numeric
                row.clicks = row.clicks || 0;
                row.click_share = parseFloat(row.click_share);
                row.price = parseFloat(row.price);
                row.average_organic_rank = parseFloat(row.average_organic_rank);
            });

            // 2. Identify Our Brand
            const ourAsinRow = marketData.find(r => r.is_yaba_asin === 'Y');
            ourBrandName = ourAsinRow ? ourAsinRow.competitor_brand : "Our Brand";
            document.getElementById('yaba-brand-display').innerText = `Our Brand: ${ourBrandName}`;

            // 3. Get Unique Weeks (Sorted)
            weeks = [...new Set(marketData.map(d => d.week_date))].sort();

            // 4. Identify Top 3 Competitors (by total clicks)
            const brandClicks = {};
            marketData.forEach(r => {
                if (r.competitor_brand !== ourBrandName) {
                    brandClicks[r.competitor_brand] = (brandClicks[r.competitor_brand] || 0) + r.clicks;
                }
            });
            top3Competitors = Object.entries(brandClicks)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(e => e[0]);
            
            competitorBrands = Object.keys(brandClicks);
        }

        function extractBrand(title) {
            if (!title) return null;
            return title.split(' ')[0]; // Simple heuristic
        }

        // --- 3. RENDER FUNCTIONS ---

        function renderDashboard() {
            renderTrendChart();
            renderBrandCompetitiveness();
            renderEfficiencyChart();
            renderDrivers();
            renderKPIs();
            generateInsights();
        }

        function renderKPIs() {
            const lastWeek = weeks[weeks.length - 1];
            const lwData = marketData.filter(d => d.week_date === lastWeek);
            
            const totalClicks = lwData.reduce((sum, r) => sum + r.clicks, 0);
            
            const ourClicks = lwData.filter(r => r.competitor_brand === ourBrandName).reduce((sum, r) => sum + r.clicks, 0);
            const compClicks = totalClicks - ourClicks;
            
            const ourShare = totalClicks ? (ourClicks / totalClicks * 100).toFixed(1) : 0;
            const compShare = totalClicks ? (compClicks / totalClicks * 100).toFixed(1) : 0;

            const avgPrice = lwData.reduce((sum, r) => sum + (r.price * r.clicks), 0) / totalClicks;

            document.getElementById('kpi-total-clicks').innerText = totalClicks.toLocaleString();
            document.getElementById('kpi-our-share').innerText = ourShare + '%';
            document.getElementById('kpi-comp-share').innerText = compShare + '%';
            document.getElementById('kpi-avg-price').innerText = avgPrice.toFixed(2) + ' â‚¬';
        }

        function renderTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', 'Market Clicks');
            data.addColumn('number', 'Our Share (%)');
            data.addColumn('number', 'Competitor Share (%)');

            const chartData = weeks.map(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, r) => sum + r.clicks, 0);
                const ourClicks = weekData.filter(r => r.competitor_brand === ourBrandName).reduce((sum, r) => sum + r.clicks, 0);
                
                const ourShare = totalClicks ? (ourClicks / totalClicks) * 100 : 0;
                const compShare = totalClicks ? ((totalClicks - ourClicks) / totalClicks) * 100 : 0;
                
                return [week, totalClicks, ourShare, compShare];
            });

            data.addRows(chartData);

            const options = {
                seriesType: 'bars',
                series: {
                    1: {type: 'line', targetAxisIndex: 1, color: '#4285F4'},
                    2: {type: 'line', targetAxisIndex: 1, color: '#EA4335'}
                },
                vAxes: {
                    0: {title: 'Clicks'},
                    1: {title: 'Share %', format: '#\'%\''}
                },
                legend: { position: 'bottom' },
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('trend_chart_div'));
            chart.draw(data, options);
        }

        function renderBrandCompetitiveness() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', ourBrandName);
            top3Competitors.forEach(c => data.addColumn('number', c));
            data.addColumn('number', 'Others');

            const rows = weeks.map(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, r) => sum + r.clicks, 0);
                
                const getShare = (brand) => {
                    const clicks = weekData.filter(r => r.competitor_brand === brand).reduce((sum, r) => sum + r.clicks, 0);
                    return totalClicks ? (clicks / totalClicks) * 100 : 0;
                };

                const ourShare = getShare(ourBrandName);
                const top3Shares = top3Competitors.map(c => getShare(c));
                const othersShare = 100 - ourShare - top3Shares.reduce((a,b)=>a+b, 0);

                return [week, ourShare, ...top3Shares, othersShare];
            });

            data.addRows(rows);

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
                vAxis: {title: 'Click Share %'},
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('brand_chart_div'));
            chart.draw(data, options);
        }

        function renderEfficiencyChart() {
            // Scatter: X=Rank, Y=Click Share
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank');
            data.addColumn('number', 'Click Share %');
            data.addColumn({type: 'string', role: 'style'});
            data.addColumn({type: 'string', role: 'tooltip'});

            const lastWeek = weeks[weeks.length - 1];
            const weekData = marketData.filter(d => d.week_date === lastWeek && d.click_share > 0);

            const rows = weekData.map(d => {
                const color = d.competitor_brand === ourBrandName ? '#4285F4' : '#9AA0A6';
                const tooltip = `${d.competitor_brand}\nRank: ${d.average_organic_rank}\nShare: ${(d.click_share*100).toFixed(2)}%`;
                return [d.average_organic_rank, d.click_share * 100, `point {fill-color: ${color}}`, tooltip];
            });

            data.addRows(rows);

            const options = {
                hAxis: {title: 'Organic Rank (Lower is better)', direction: -1}, // Invert rank
                vAxis: {title: 'Click Share %'},
                legend: 'none',
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart_div'));
            chart.draw(data, options);
        }

        function renderDrivers() {
            // Simplified Impact Analysis: Compare Avg Click Share when Attribute is Present vs Absent
            function drawImpactChart(divId, metricField, label) {
                const withAttribute = marketData.filter(d => d[metricField] > 0);
                const withoutAttribute = marketData.filter(d => d[metricField] === 0);

                const avgShareWith = withAttribute.length ? withAttribute.reduce((s, r) => s + r.click_share, 0) / withAttribute.length : 0;
                const avgShareWithout = withoutAttribute.length ? withoutAttribute.reduce((s, r) => s + r.click_share, 0) / withoutAttribute.length : 0;

                const data = google.visualization.arrayToDataTable([
                    ['State', 'Avg Click Share', { role: 'style' }],
                    ['Active', avgShareWith * 100, '#34A853'],
                    ['Inactive', avgShareWithout * 100, '#EA4335']
                ]);

                const options = {
                    legend: 'none',
                    vAxis: {minValue: 0},
                    chartArea: {width: '80%', height: '70%'}
                };

                const chart = new google.visualization.ColumnChart(document.getElementById(divId));
                chart.draw(data, options);
            }

            drawImpactChart('promo_impact_div', 'weekly_number_of_days_with_deal', 'Deals');
            drawImpactChart('badge_impact_div', 'weekly_number_of_days_with_amazon_choice_badge', 'Amz Choice');
            
            // Price: Scatter price vs share
            const priceData = google.visualization.arrayToDataTable([
                ['Price', 'Share'],
                ...marketData.map(d => [d.price, d.click_share])
            ]);
            new google.visualization.ScatterChart(document.getElementById('price_impact_div')).draw(priceData, {legend:'none', hAxis:{title:'Price'}, vAxis:{title:'Share'}});
        }

        function generateInsights() {
            const insightsDiv = document.getElementById('insights-container');
            const actionsDiv = document.getElementById('actions-container');
            const otherDiv = document.getElementById('other-insights-container');
            
            // Logic to generate text
            const lastWeek = weeks[weeks.length-1];
            const prevWeek = weeks[weeks.length-2] || lastWeek;
            
            const lwData = marketData.filter(d => d.week_date === lastWeek);
            const pwData = marketData.filter(d => d.week_date === prevWeek);

            const getMyShare = (data) => {
                const total = data.reduce((s,r)=>s+r.clicks,0);
                const mine = data.filter(r=>r.competitor_brand===ourBrandName).reduce((s,r)=>s+r.clicks,0);
                return total ? mine/total : 0;
            };

            const myShareLW = getMyShare(lwData);
            const mySharePW = getMyShare(pwData);
            const trend = myShareLW > mySharePW ? 'Growing' : 'Declining';
            
            // Insights
            let html = `
                <div class="insight-box">
                    <div class="insight-title"><i class="material-icons">show_chart</i> Trend</div>
                    Our brand is <strong>${trend}</strong> vs last week (${(mySharePW*100).toFixed(1)}% -> ${(myShareLW*100).toFixed(1)}%).
                </div>
                <div class="insight-box">
                    <div class="insight-title"><i class="material-icons">group</i> Competition</div>
                    Top threat is <strong>${top3Competitors[0]}</strong>. Monitor their pricing strategy carefully.
                </div>
                <div class="insight-box">
                    <div class="insight-title"><i class="material-icons">local_offer</i> Pricing</div>
                    Avg market price is ${(lwData.reduce((s,r)=>s+r.price,0)/lwData.length).toFixed(2)}â‚¬.
                </div>
                <div class="insight-box">
                     <div class="insight-title"><i class="material-icons">star</i> Efficiency</div>
                     Check the Scatter plot. ASINs below the trendline are paying too much for visibility or have low conversion.
                </div>
                 <div class="insight-box">
                     <div class="insight-title"><i class="material-icons">warning</i> Risks</div>
                     ${myShareLW < 0.1 ? "Low market presence detected (<10% share)." : "Strong market presence maintained."}
                </div>
            `;
            insightsDiv.innerHTML = html;

            // Actions
            let actHtml = `
                <div class="rec-box"><strong>Adjust Pricing:</strong> If share is dropping and price > market avg, consider a -5% coupon.</div>
                <div class="rec-box"><strong>Defend Rank:</strong> Increase bids on keywords where Rank > 5 but Share is high.</div>
                <div class="rec-box"><strong>Content:</strong> Review titles of underperforming variants compared to ${top3Competitors[0]}.</div>
            `;
            actionsDiv.innerHTML = actHtml;

            // Other
            otherDiv.innerHTML = "Analysis generated automatically based on provided dataset patterns. Verify anomalies in Week 2.";
        }

        // --- 4. INTERACTIVE COMPARATOR ---

        function setupComparator() {
            const weekSel = document.getElementById('comp-week-select');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.add(opt);
            });
            weekSel.value = weeks[weeks.length - 1]; // Default to last week

            const brandSel = document.getElementById('comp-brand-select');
            top3Competitors.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                brandSel.add(opt);
            });
        }

        function updateComparator() {
            const week = document.getElementById('comp-week-select').value;
            const compBrand = document.getElementById('comp-brand-select').value;

            // Filter Data
            const ourData = marketData.filter(d => d.week_date === week && d.competitor_brand === ourBrandName);
            const compData = marketData.filter(d => d.week_date === week && d.competitor_brand === compBrand);

            if (ourData.length === 0 || compData.length === 0) {
                document.getElementById('comparator_table_div').innerText = "No data for this selection.";
                return;
            }

            // Averages
            const calcAvg = (data, field) => data.reduce((s, r) => s + r[field], 0) / data.length;
            
            const ourPrice = calcAvg(ourData, 'price');
            const compPrice = calcAvg(compData, 'price');
            const priceGap = ((ourPrice - compPrice) / compPrice) * 100;

            const ourShare = ourData.reduce((s,r)=>s+r.click_share,0);
            const compShare = compData.reduce((s,r)=>s+r.click_share,0);
            const shareGap = ourShare - compShare;

            const ourRank = calcAvg(ourData, 'average_organic_rank');
            const compRank = calcAvg(compData, 'average_organic_rank');
            const rankGap = ourRank - compRank;

            // Update Cards
            const priceEl = document.getElementById('comp-price-gap');
            priceEl.innerText = (priceGap > 0 ? '+' : '') + priceGap.toFixed(1) + '%';
            priceEl.className = priceGap > 0 ? 'kpi-value text-red' : 'kpi-value text-green';

            const shareEl = document.getElementById('comp-share-gap');
            shareEl.innerText = (shareGap * 100).toFixed(1) + ' pts';
            shareEl.className = shareGap > 0 ? 'kpi-value text-green' : 'kpi-value text-red';

            const rankEl = document.getElementById('comp-rank-gap');
            rankEl.innerText = rankGap.toFixed(1);
            rankEl.className = rankGap < 0 ? 'kpi-value text-green' : 'kpi-value text-red'; // Lower rank is better

            // Update Table
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Metric');
            data.addColumn('number', ourBrandName);
            data.addColumn('number', compBrand);

            data.addRows([
                ['Avg Price (â‚¬)', ourPrice, compPrice],
                ['Total Click Share', ourShare, compShare],
                ['Avg Rank', ourRank, compRank],
                ['Deal Days', calcAvg(ourData, 'weekly_number_of_days_with_deal'), calcAvg(compData, 'weekly_number_of_days_with_deal')],
                ['Coupon Days', calcAvg(ourData, 'weekly_number_of_days_with_coupon'), calcAvg(compData, 'weekly_number_of_days_with_coupon')]
            ]);

            const table = new google.visualization.Table(document.getElementById('comparator_table_div'));
            table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Redraw charts if needed when unhiding
            if (tabId === 'comparator') updateComparator();
        }

    </script>
</body>
</html>