<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Estratégico Parent ASIN: Matcha Premium</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Fonts & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #34A853; /* Google Green */
            --danger: #EA4335; /* Google Red */
            --warning: #FBBC05; /* Google Yellow */
            --text-main: #202124;
            --text-light: #5f6368;
            --bg-body: #f8f9fa;
            --surface: #ffffff;
            --border: #dadce0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--surface);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 { font-size: 22px; margin: 0; color: var(--text-main); }
        h2 { font-size: 18px; margin-bottom: 16px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 24px; }
        .tab-btn {
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            padding: 8px 0;
            position: relative;
        }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -17px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        /* Views */
        .view-section { display: none; padding-top: 24px; }
        .view-section.active { display: block; }

        /* Components */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        /* KPIs */
        .kpi-box { text-align: center; }
        .kpi-label { font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 28px; font-weight: 400; color: var(--primary); margin: 8px 0; }
        .kpi-delta { font-size: 14px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .pos { color: var(--secondary); }
        .neg { color: var(--danger); }
        .neu { color: var(--text-light); }

        /* Insights Section */
        .insight-list { list-style: none; padding: 0; }
        .insight-item { 
            padding: 16px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            gap: 16px; 
            align-items: flex-start; 
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); background: #e8f0fe; padding: 8px; border-radius: 50%; }
        .insight-content h4 { margin: 0 0 4px 0; font-size: 16px; }
        .insight-content p { margin: 0; color: var(--text-light); font-size: 14px; }
        
        .rec-tag { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 11px; 
            font-weight: 700; 
            text-transform: uppercase;
            margin-right: 8px;
        }
        .tag-price { background: #e6f4ea; color: var(--secondary); }
        .tag-promo { background: #fce8e6; color: var(--danger); }
        .tag-seo { background: #e8f0fe; color: var(--primary); }

        /* Interactive Controls */
        .controls { display: flex; gap: 16px; margin-bottom: 24px; align-items: center; }
        select {
            padding: 10px 16px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--surface);
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: var(--text-main);
        }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: var(--text-light); font-weight: 500; font-size: 13px; }
        .data-table td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .bar-container { background: #f1f3f4; height: 6px; border-radius: 3px; width: 100px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); }

        /* Charts */
        .chart-container { width: 100%; height: 300px; }
        .chart-container.tall { height: 400px; }

    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center; gap: 12px;">
        <span class="material-icons" style="color: var(--primary);">analytics</span>
        <h1>Analysis: Matcha Premium</h1>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>
</header>

<div class="container">

    <!-- TAB 1: REPORT -->
    <div id="report-view" class="view-section active">
        
        <!-- KPI Row -->
        <div class="grid-4" id="kpi-container">
            <!-- Injected via JS -->
        </div>

        <!-- Section 1: Global Trend -->
        <div class="card">
            <h2><span class="material-icons">show_chart</span> 1. Tendencia Global del Parent</h2>
            <p style="font-size: 14px; color: var(--text-light); margin-bottom: 16px;">
                Evolución agregada de Clicks y Share (Nuestra Marca vs Competencia).
            </p>
            <div id="chart_trend" class="chart-container tall"></div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca</h2>
            <p style="font-size: 14px; color: var(--text-light); margin-bottom: 16px;">
                Evolución de cuota de mercado semanal (Top 3 competidores).
            </p>
            <div id="chart_brands" class="chart-container tall"></div>
        </div>

        <!-- Section 3 & 4 Split -->
        <div class="grid-2">
            <!-- Efficiency -->
            <div class="card">
                <h2><span class="material-icons">scatter_plot</span> 4. Eficiencia (Rank vs Share)</h2>
                <p style="font-size: 13px; color: var(--text-light);">¿Quién consigue más tráfico por su posición?</p>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>
            
            <!-- Price Analysis -->
            <div class="card">
                <h2><span class="material-icons">payments</span> 3. Impacto de Precio</h2>
                <p style="font-size: 13px; color: var(--text-light);">Relación Precio Medio vs Share Total.</p>
                <div id="chart_price" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 5: Insights & Recommendations -->
        <div class="card" style="border-left: 4px solid var(--primary);">
            <h2><span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones</h2>
            <div class="grid-2">
                <div>
                    <h3 style="font-size: 16px; color: var(--text-light); margin-bottom: 12px;">INSIGHTS CLAVE</h3>
                    <ul class="insight-list">
                        <li class="insight-item">
                            <span class="material-icons insight-icon">trending_up</span>
                            <div class="insight-content">
                                <h4>Estabilidad en Liderazgo (2º Lugar)</h4>
                                <p>Nuestra marca mantiene una cuota sólida (~22%), pero NORITUAL LAB domina (~27%) a pesar de tener un precio más alto, indicando una preferencia del consumidor por posicionamiento premium.</p>
                            </div>
                        </li>
                        <li class="insight-item">
                            <span class="material-icons insight-icon">money_off</span>
                            <div class="insight-content">
                                <h4>Elasticidad de Precio Inversa</h4>
                                <p>Competidores baratos como VAHDAM están perdiendo tracción. El mercado premia calidad percibida sobre precio bajo en la categoría Matcha.</p>
                            </div>
                        </li>
                        <li class="insight-item">
                            <span class="material-icons insight-icon">stars</span>
                            <div class="insight-content">
                                <h4>Eficiencia Orgánica</h4>
                                <p>Nuestros ASINs sobre-performan en eficiencia: con Ranks promedio de 4-5, capturamos cuota similar a competidores en Top 1-2. El CTR orgánico es saludable.</p>
                            </div>
                        </li>
                        <li class="insight-item">
                            <span class="material-icons insight-icon">warning</span>
                            <div class="insight-content">
                                <h4>Amenaza de Fragmentación</h4>
                                <p>Marcas pequeñas ("Unknown" o long tail) suman una cuota relevante. El mercado se está saturando de opciones genéricas.</p>
                            </div>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 16px; color: var(--text-light); margin-bottom: 12px;">ACCIONES RECOMENDADAS</h3>
                    <ul class="insight-list">
                        <li class="insight-item">
                            <div class="insight-content">
                                <span class="rec-tag tag-promo">PROMO</span>
                                <h4>Testear Cupones (Defensivo)</h4>
                                <p>NORITUAL utiliza cupones agresivos (4-7 días/semana). Recomendamos activar cupones del 5-10% en semanas alternas para erosionar su liderazgo.</p>
                            </div>
                        </li>
                        <li class="insight-item">
                            <div class="insight-content">
                                <span class="rec-tag tag-seo">SEO</span>
                                <h4>Consolidar Keywords "Ceremonial"</h4>
                                <p>Dado que el precio alto no disuade, optimizar títulos y bullets enfatizando "Calidad Ceremonial" para competir directamente con el líder premium.</p>
                            </div>
                        </li>
                        <li class="insight-item">
                            <div class="insight-content">
                                <span class="rec-tag tag-price">PRICING</span>
                                <h4>Mantener Precio Medio</h4>
                                <p>No bajar precios para combatir a VAHDAM. El target actual valora el rango 15€-25€. Bajar precio podría dañar la percepción de marca.</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="interactive-view" class="view-section">
        <div class="card">
            <h2>Comparador Cara a Cara</h2>
            <div class="controls">
                <label>Semana:
                    <select id="week-select" onchange="updateInteractive()"></select>
                </label>
                <label>Competidor VS Nosotros:
                    <select id="comp-select" onchange="updateInteractive()"></select>
                </label>
            </div>
            
            <div class="grid-2">
                <div id="metric-table-container"></div>
                <div id="chart_comparison" class="chart-container"></div>
            </div>
        </div>
        
        <div class="card">
            <h2>Detalle de ASINs (Semana Seleccionada)</h2>
            <div id="asin-table-container"></div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script>
    // 1. DATA INJECTION (Generated from CSV)
    const marketData = [{"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "country_code": "de", "average_organic_rank": 20.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.47, "impression_share": 2.29, "price": 9.895714286, "click_share_rank": 10, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.19, "impression_share": 5.29, "price": 9.895714286, "click_share_rank": 4, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.15, "impression_share": 5.19, "price": 10.43, "click_share_rank": 6, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.39, "impression_share": 3.91, "price": 11.9975, "click_share_rank": 9, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.44, "impression_share": 3.4, "price": 12.367142857, "click_share_rank": 9, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": null, "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.39, "impression_share": 3.91, "price": 11.9975, "click_share_rank": 9, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": null, "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.44, "impression_share": 3.4, "price": 12.367142857, "click_share_rank": 9, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 18.77, "impression_share": 3.35, "price": 24.648571429, "click_share_rank": 1, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 19.34, "impression_share": 3.36, "price": 23.91, "click_share_rank": 1, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": null, "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 16.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "click_share": 3.0, "impression_share": 4.47, "price": 10.39, "click_share_rank": 7, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 16.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "click_share": 3.0, "impression_share": 4.47, "price": 10.39, "click_share_rank": 7, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.4, "impression_share": 4.7, "price": 10.71, "click_share_rank": 7, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": null, "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.4, "impression_share": 4.7, "price": 10.71, "click_share_rank": 7, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": null, "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "country_code": "de", "average_organic_rank": 19.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.57, "impression_share": 1.96, "price": 31.2725, "click_share_rank": 10, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.42, "impression_share": 4.24, "price": 16.037142857, "click_share_rank": 3, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": null, "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.42, "impression_share": 4.24, "price": 16.037142857, "click_share_rank": 3, "weekly_search_volume": 47718.46, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": null, "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 7.38, "impression_share": 4.54, "price": 15.5575, "click_share_rank": 3, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 7.38, "impression_share": 4.54, "price": 15.5575, "click_share_rank": 3, "weekly_search_volume": 27092.92, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 11.66, "impression_share": 3.37, "price": 15.058571429, "click_share_rank": 2, "weekly_search_volume": 47718.46, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 12.9, "impression_share": 3.37, "price": 14.6075, "click_share_rank": 2, "weekly_search_volume": 27092.92, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.35, "impression_share": 3.02, "price": 10.2225, "click_share_rank": 5, "weekly_search_volume": 27092.92, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.75, "impression_share": 3.25, "price": 10.538571429, "click_share_rank": 5, "weekly_search_volume": 47718.46, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.49, "impression_share": 3.36, "price": 24.855714286, "click_share_rank": 6, "weekly_search_volume": 47718.46, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.66, "impression_share": 3.36, "price": 24.5275, "click_share_rank": 4, "weekly_search_volume": 27092.92, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": null, "weekly_number_of_days_with_deal": null, "weekly_number_of_days_with_best_seller_badge": null, "weekly_number_of_days_with_amazon_choice_badge": null, "weekly_number_of_days_with_coupon": null, "click_share": 2.68, "impression_share": 2.06, "price": 30.27, "click_share_rank": 8, "weekly_search_volume": 27092.92, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 23.0, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.93, "impression_share": 2.43, "price": 30.704285714, "click_share_rank": 8, "weekly_search_volume": 47718.46, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}];

    // 2. LOGIC ENGINE
    
    // Config
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    let processedData = [];
    let ourBrandName = "";
    
    // Helpers
    function getBrand(row) {
        if (row.competitor_brand && row.competitor_brand.trim() !== "") return row.competitor_brand;
        
        // Extract from title (First 2 words usually, or before comma/dash)
        if (row.product_title) {
            let title = row.product_title.split(/[,\-]/)[0];
            return title.trim().split(' ').slice(0, 1).join(' '); // Taking first word as simple brand proxy
        }
        return "Unknown";
    }

    function processData() {
        // 1. Identify Our Brand
        const ourAsinRow = marketData.find(r => r.is_yaba_asin === 'Y');
        ourBrandName = ourAsinRow ? ourAsinRow.competitor_brand : "NaturaleBio"; 

        // 2. Clean & Normalize
        processedData = marketData.map(r => {
            const brand = getBrand(r);
            // Fix Price
            const price = parseFloat(r.price) || 0;
            // Est. Clicks = (Click Share / 100) * Volume
            const clicks = (r.click_share / 100) * r.weekly_search_volume;
            
            return {
                ...r,
                brand_normalized: brand,
                est_clicks: clicks,
                price_clean: price
            };
        });
    }

    function initDashboard() {
        processData();
        renderKPIs();
        renderTrendChart();
        renderBrandChart();
        renderEfficiencyChart();
        renderPriceChart();
        setupInteractiveControls();
    }

    // --- RENDERERS ---

    function renderKPIs() {
        // Filter Last Week
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];

        const dataLW = processedData.filter(d => d.week_date === lastWeek);
        const dataPW = processedData.filter(d => d.week_date === prevWeek);

        // Calculate Metrics for Our Brand
        const calcBrandMetrics = (data, brand) => {
            const brandRows = data.filter(d => d.brand_normalized === brand);
            const totalShare = brandRows.reduce((sum, r) => sum + r.click_share, 0);
            const avgRank = brandRows.reduce((sum, r) => sum + (r.average_organic_rank || 100), 0) / (brandRows.length || 1);
            const wAvgPrice = brandRows.reduce((sum, r) => sum + (r.price_clean * r.click_share), 0) / (totalShare || 1);
            return { share: totalShare, rank: avgRank, price: wAvgPrice };
        };

        const curr = calcBrandMetrics(dataLW, ourBrandName);
        const prev = calcBrandMetrics(dataPW, ourBrandName);

        // Market Leader Share (for context)
        // Group by brand
        const brandShares = {};
        dataLW.forEach(r => {
            brandShares[r.brand_normalized] = (brandShares[r.brand_normalized] || 0) + r.click_share;
        });
        const leaderShare = Math.max(...Object.values(brandShares));

        // Generate HTML
        const kpis = [
            { label: 'Click Share Total', val: curr.share.toFixed(1) + '%', delta: (curr.share - prev.share).toFixed(1) + '%' },
            { label: 'Avg Organic Rank', val: curr.rank.toFixed(1), delta: (prev.rank - curr.rank).toFixed(1) }, // Inverse logic for rank
            { label: 'Gap vs Leader', val: '-' + (leaderShare - curr.share).toFixed(1) + '%', delta: 'Share Diff' },
            { label: 'Avg Price', val: '€' + curr.price.toFixed(2), delta: '€' + (curr.price - prev.price).toFixed(2) }
        ];

        const container = document.getElementById('kpi-container');
        container.innerHTML = kpis.map(k => {
            const dVal = parseFloat(k.delta);
            let colorClass = 'neu';
            if (k.label.includes('Rank')) {
                 colorClass = dVal > 0 ? 'pos' : (dVal < 0 ? 'neg' : 'neu'); // Positive delta means Rank got better (lower)? No, logic above: prev - curr. If prev=10, curr=5, delta=5 (Pos).
            } else if (!k.label.includes('Gap')) {
                 colorClass = dVal > 0 ? 'pos' : (dVal < 0 ? 'neg' : 'neu');
            }
            
            const icon = dVal > 0 ? 'arrow_upward' : (dVal < 0 ? 'arrow_downward' : 'remove');

            return `
            <div class="card kpi-box" style="margin-bottom:0">
                <div class="kpi-label">${k.label}</div>
                <div class="kpi-value">${k.val}</div>
                <div class="kpi-delta ${colorClass}">
                    <span class="material-icons" style="font-size: 14px;">${icon}</span>
                    ${k.delta.replace('-', '')}
                </div>
            </div>`;
        }).join('');
    }

    function renderTrendChart() {
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        
        // Aggregate
        const chartData = [['Week', 'Total Clicks', 'Our Share (%)', 'Comp Share (%)']];
        
        weeks.forEach(week => {
            const d = processedData.filter(r => r.week_date === week);
            const totalClicks = d.reduce((sum, r) => sum + r.est_clicks, 0);
            
            const ourShare = d.filter(r => r.is_yaba_asin === 'Y').reduce((s, r) => s + r.click_share, 0);
            const compShare = d.filter(r => r.is_yaba_asin === 'N').reduce((s, r) => s + r.click_share, 0);
            
            chartData.push([week, totalClicks, ourShare, compShare]);
        });

        const data = google.visualization.arrayToDataTable(chartData);

        const options = {
            seriesType: 'bars',
            series: {
                1: {type: 'line', targetAxisIndex: 1, color: '#4285F4'}, 
                2: {type: 'line', targetAxisIndex: 1, color: '#EA4335'}
            },
            vAxes: {
                0: {title: 'Est. Clicks (Volume)', textStyle: {color: '#5f6368'}},
                1: {title: 'Click Share %', format: '#\'%\''}
            },
            hAxis: { title: 'Week' },
            legend: { position: 'bottom' },
            colors: ['#dadce0']
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function renderBrandChart() {
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        
        // Find Top Brands
        const brandTotals = {};
        processedData.forEach(r => {
            brandTotals[r.brand_normalized] = (brandTotals[r.brand_normalized] || 0) + r.click_share;
        });
        
        // Sort brands by total share
        const sortedBrands = Object.keys(brandTotals).sort((a,b) => brandTotals[b] - brandTotals[a]);
        // Top 3 + Ours
        let topBrands = sortedBrands.filter(b => b !== ourBrandName).slice(0, 3);
        topBrands.unshift(ourBrandName); // Ours first

        // Prepare Table
        const header = ['Week', ...topBrands];
        const rows = [];

        weeks.forEach(week => {
            const row = [week];
            const d = processedData.filter(r => r.week_date === week);
            topBrands.forEach(brand => {
                const share = d.filter(r => r.brand_normalized === brand).reduce((s, r) => s + r.click_share, 0);
                row.push(share);
            });
            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            vAxis: { title: 'Click Share (%)' },
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'] // Blue (Us), Red, Yellow, Green
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brands'));
        chart.draw(data, options);
    }

    function renderEfficiencyChart() {
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        const lastWeek = weeks[weeks.length - 1];
        const d = processedData.filter(r => r.week_date === lastWeek && r.average_organic_rank > 0);

        const dataArr = [['Rank', 'Click Share', { role: 'style' }, {role: 'tooltip'}]];
        
        d.forEach(r => {
            const color = r.is_yaba_asin === 'Y' ? '#4285F4' : '#dadce0';
            const tooltip = `${r.brand_normalized}: Rank ${r.average_organic_rank}, Share ${r.click_share}%`;
            dataArr.push([r.average_organic_rank, r.click_share, `point { fill-color: ${color}; size: 5; }`, tooltip]);
        });

        const data = google.visualization.arrayToDataTable(dataArr);

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // Standard direction
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            tooltip: { isHtml: true }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function renderPriceChart() {
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        const lastWeek = weeks[weeks.length - 1];
        const d = processedData.filter(r => r.week_date === lastWeek);
        
        // Agg by brand
        const brandStats = {};
        d.forEach(r => {
            if (!brandStats[r.brand_normalized]) brandStats[r.brand_normalized] = { clicks: 0, revenue_proxy: 0 };
            brandStats[r.brand_normalized].clicks += r.click_share;
            brandStats[r.brand_normalized].revenue_proxy += (r.click_share * r.price_clean);
        });

        const dataArr = [['Brand', 'Avg Price', 'Total Share', { role: 'style' }]];
        
        Object.keys(brandStats).forEach(b => {
            const stats = brandStats[b];
            const avgPrice = stats.revenue_proxy / (stats.clicks || 1);
            const color = b === ourBrandName ? '#4285F4' : '#dadce0';
            if (stats.clicks > 1) { // Filter noise
                dataArr.push([b, avgPrice, stats.clicks, color]);
            }
        });

        const data = google.visualization.arrayToDataTable(dataArr);

        const options = {
            hAxis: { title: 'Avg Price (€)' },
            vAxis: { title: 'Total Click Share (%)' },
            legend: 'none',
            bubble: { textStyle: { fontSize: 11 } } 
        };
        
        // Using Scatter to map Price vs Share
        const chart = new google.visualization.ScatterChart(document.getElementById('chart_price'));
        chart.draw(data, options);
    }

    // --- INTERACTIVE ---

    function setupInteractiveControls() {
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort().reverse();
        const brands = [...new Set(processedData.map(d => d.brand_normalized))].sort();
        
        const wSelect = document.getElementById('week-select');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            wSelect.add(opt);
        });

        const cSelect = document.getElementById('comp-select');
        brands.filter(b => b !== ourBrandName).forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            cSelect.add(opt);
        });

        // Trigger first update
        if (weeks.length > 0 && brands.length > 0) updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('week-select').value;
        const comp = document.getElementById('comp-select').value;

        const d = processedData.filter(r => r.week_date === week);
        
        const getMetrics = (brand) => {
            const rows = d.filter(r => r.brand_normalized === brand);
            const share = rows.reduce((s, r) => s + r.click_share, 0);
            const price = rows.reduce((s, r) => s + (r.price_clean * r.click_share), 0) / (share || 1);
            const rank = rows.reduce((s, r) => s + r.average_organic_rank, 0) / (rows.length || 1);
            return { share, price, rank };
        };

        const mUs = getMetrics(ourBrandName);
        const mComp = getMetrics(comp);

        // Render Table
        const html = `
            <table class="data-table">
                <tr><th>Metric</th><th>${ourBrandName} (Nosotros)</th><th>${comp}</th></tr>
                <tr>
                    <td>Click Share</td>
                    <td><div style="font-weight:bold; color:var(--primary)">${mUs.share.toFixed(2)}%</div></td>
                    <td><div style="font-weight:bold; color:var(--text-light)">${mComp.share.toFixed(2)}%</div></td>
                </tr>
                <tr>
                    <td>Avg Price</td>
                    <td>€${mUs.price.toFixed(2)}</td>
                    <td>€${mComp.price.toFixed(2)}</td>
                </tr>
                 <tr>
                    <td>Avg Rank</td>
                    <td>${mUs.rank.toFixed(1)}</td>
                    <td>${mComp.rank.toFixed(1)}</td>
                </tr>
            </table>
        `;
        document.getElementById('metric-table-container').innerHTML = html;

        // Render Head-to-Head Chart
        const data = google.visualization.arrayToDataTable([
            ['Brand', 'Share', { role: 'style' }],
            [ourBrandName, mUs.share, '#4285F4'],
            [comp, mComp.share, '#EA4335']
        ]);

        new google.visualization.ColumnChart(document.getElementById('chart_comparison')).draw(data, {
            legend: 'none',
            vAxis: { title: 'Share %' }
        });

        // Render Detail Table
        const rows = d.filter(r => r.brand_normalized === ourBrandName || r.brand_normalized === comp)
                      .sort((a,b) => b.click_share - a.click_share);
        
        const detailHtml = `
            <table class="data-table">
                <thead><tr><th>Brand</th><th>ASIN</th><th>Title</th><th>Price</th><th>Share</th><th>Rank</th></tr></thead>
                <tbody>
                    ${rows.map(r => `
                        <tr>
                            <td>${r.brand_normalized}</td>
                            <td><a href="${r.keywords_link}" target="_blank">${r.asin}</a></td>
                            <td style="max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${r.product_title}</td>
                            <td>€${r.price_clean.toFixed(2)}</td>
                            <td>${r.click_share.toFixed(2)}%</td>
                            <td>${r.average_organic_rank || '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        document.getElementById('asin-table-container').innerHTML = detailHtml;
    }

    function switchTab(tab) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        if (tab === 'report') {
            document.getElementById('report-view').classList.add('active');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
        } else {
            document.getElementById('interactive-view').classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            updateInteractive(); // Refresh chart size
        }
    }

</script>

</body>
</html>