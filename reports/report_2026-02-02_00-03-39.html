<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-500: #6b7280;
            --gray-800: #1f2937;
            --bg-color: #f8f9fa;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--gray-800);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout & Containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
            margin: 0;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }

        /* Metrics */
        .metric-box {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .metric-value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 12px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: white;
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: var(--gray-500);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background-color: var(--gray-100);
            color: var(--primary);
            font-weight: 600;
        }

        /* Insights List */
        .insight-list { list-style: none; padding: 0; }
        .insight-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            align-items: start;
        }
        .insight-list li:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); margin-top: 2px; }

        /* Interactive Controls */
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
            background-color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>An√°lisis de Rendimiento: Parent ASIN</h1>
            <p style="color: var(--gray-500); margin-top: 4px;">Snapshot Semanal ‚Ä¢ Mercado UK</p>
        </div>
        <div style="text-align: right;">
            <span class="metric-label" style="display:block;">√öltima Actualizaci√≥n</span>
            <strong id="last-update-date">-</strong>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">
            <span class="material-icons">analytics</span> Reporte Estrat√©gico
        </button>
        <button class="tab-btn" onclick="switchTab('interactive')">
            <span class="material-icons">compare_arrows</span> Comparador Interactivo
        </button>
    </div>

    <!-- TAB 1: REPORT -->
    <div id="tab-report">
        
        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span> 1. Tendencia Global del Parent
            </div>
            <div class="grid-3" style="margin-bottom: 20px;">
                <div class="metric-box">
                    <div class="metric-value" id="total-clicks">-</div>
                    <div class="metric-label">Clicks Totales (Est.)</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="our-share">-</div>
                    <div class="metric-label">Nuestro Click Share Total</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="comp-share">-</div>
                    <div class="metric-label">Click Share Competencia</div>
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div id="trend-insights" style="margin-top: 15px; font-size: 14px; color: var(--gray-500);"></div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span> 2. Competitividad de Marca
            </div>
            <div id="chart_brand_share" class="chart-container"></div>
            <p style="font-size: 0.9em; color: var(--gray-500); margin-top: 10px;">
                *Comparativa de Click Share: Nuestra Marca vs Top 3 Competidores vs Resto.
            </p>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div class="grid-2">
            <!-- Levers -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">tune</span> 3. Palancas (Precio & Promos)
                </div>
                <div id="table_levers" style="width: 100%; min-height: 200px;"></div>
                <div id="levers-text" style="margin-top: 12px; font-size: 13px;"></div>
            </div>

            <!-- Efficiency -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span> 4. Eficiencia (Rank vs Share)
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
                <div style="font-size: 12px; text-align: center; color: var(--gray-500);">
                    Eje X: Rank Org√°nico (Inv.) | Eje Y: Click Share
                </div>
            </div>
        </div>

        <!-- Section 5: Conclusions & Recommendations -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones
            </div>
            <div class="grid-2">
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 10px;">Insights Clave</h3>
                    <ul class="insight-list" id="insights-list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 10px;">Recomendaciones Accionables</h3>
                    <ul class="insight-list" id="recommendations-list">
                         <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Section 6: Other Insights -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">search</span> 6. Otros Hallazgos
            </div>
            <p id="other-insights-text" style="font-size: 14px;"></p>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive" style="display: none;">
        <div class="card">
            <div class="card-title">
                <span class="material-icons">face</span> Cara a Cara: Nosotros vs Competidor
            </div>
            
            <div style="display: flex; gap: 20px; margin-bottom: 20px; background: var(--gray-100); padding: 15px; border-radius: 12px;">
                <div>
                    <label style="display: block; font-size: 12px; margin-bottom: 4px;">Semana</label>
                    <select id="select-week" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; margin-bottom: 4px;">Competidor</label>
                    <select id="select-competitor" onchange="updateInteractive()"></select>
                </div>
            </div>

            <div class="grid-3">
                <div class="metric-box" style="background: white; border: 1px solid var(--gray-200);">
                    <div class="metric-label">Diferencial Precio</div>
                    <div class="metric-value" id="diff-price" style="font-size: 20px;">-</div>
                </div>
                <div class="metric-box" style="background: white; border: 1px solid var(--gray-200);">
                    <div class="metric-label">Gap de Visibilidad (Share)</div>
                    <div class="metric-value" id="diff-share" style="font-size: 20px;">-</div>
                </div>
                <div class="metric-box" style="background: white; border: 1px solid var(--gray-200);">
                    <div class="metric-label">Rank Promedio</div>
                    <div class="metric-value" id="diff-rank" style="font-size: 20px;">-</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div id="table_interactive"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // -------------------------------------------------------------------------
    // 1. DATA INJECTION
    // -------------------------------------------------------------------------
    const rawData = [
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "SuperSelf",
    "asin": "B08YK2RPBZ",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 4,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 4,
    "click_share": 9.83,
    "impression_share": 3.56,
    "price": 9.9,
    "click_share_rank": 3,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Heapwell Superfoods",
    "asin": "B06XTYYYJ8",
    "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...",
    "country_code": "uk",
    "average_organic_rank": 6,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 5.74,
    "impression_share": 5.52,
    "price": 9.99,
    "click_share_rank": 4,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 1,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 4,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 13.79,
    "impression_share": 3.33,
    "price": 12.49,
    "click_share_rank": 1,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0C71LZNV6",
    "product_title": "Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...",
    "country_code": "uk",
    "average_organic_rank": 12,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 2.56,
    "impression_share": 4.22,
    "price": 24.95,
    "click_share_rank": 10,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B09DQ1PWGX",
    "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 34,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 4.64,
    "impression_share": 3.45,
    "price": 2.1225,
    "click_share_rank": 5,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B08YRXQ2JH",
    "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...",
    "country_code": "uk",
    "average_organic_rank": 13,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 3.32,
    "impression_share": 3.16,
    "price": 6.98,
    "click_share_rank": 8,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "SuperSelf",
    "asin": "B082DKRSB4",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 8,
    "weekly_number_of_days_with_deal": 4,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 4,
    "click_share": 3.96,
    "impression_share": 4.48,
    "price": 14.86,
    "click_share_rank": 6,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B0D9M91WZD",
    "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...",
    "country_code": "uk",
    "average_organic_rank": 9,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 2.79,
    "impression_share": 3.5,
    "price": 11,
    "click_share_rank": 9,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B0F21VZMJQ",
    "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...",
    "country_code": "uk",
    "average_organic_rank": 3,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 1,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 10.49,
    "impression_share": 3.3,
    "price": 16.99,
    "click_share_rank": 2,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 7,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 3.39,
    "impression_share": 3.28,
    "price": 20.99,
    "click_share_rank": 7,
    "weekly_search_volume": 40768.78,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  }
];

    // -------------------------------------------------------------------------
    // 2. DATA PROCESSING LOGIC
    // -------------------------------------------------------------------------
    
    // Helpers
    const formatPct = num => (num).toFixed(2) + '%';
    const formatCurrency = num => '¬£' + Number(num).toFixed(2);
    
    // 2.1 Brand Identification & Filling
    function cleanBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        
        // Extract from title if null
        const title = row.product_title || "";
        if (title.includes('|')) return title.split('|')[0].trim();
        if (title.includes('-')) return title.split('-')[0].trim();
        const words = title.split(' ');
        if (words.length >= 2) return words.slice(0, 2).join(' ');
        return "Unknown Brand";
    }

    const marketData = rawData.map(row => ({
        ...row,
        real_brand: cleanBrand(row)
    }));

    // Identify OUR Brand (from Yaba ASINs)
    const ourAsinData = marketData.find(d => d.is_yaba_asin === 'Y');
    const OUR_BRAND = ourAsinData ? ourAsinData.real_brand : "Our Brand";

    // 2.2 Aggregations by Week and Brand
    const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
    const lastWeek = weeks[weeks.length - 1];

    // Update Header
    document.getElementById('last-update-date').innerText = lastWeek;

    // -------------------------------------------------------------------------
    // 3. GOOGLE CHARTS IMPLEMENTATION
    // -------------------------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawTrendChart();
        drawBrandShareChart();
        drawLeversTable();
        drawEfficiencyChart();
        generateInsights();
        setupInteractiveTab();
    }

    // --- CHART 1: TREND (Parent Click Share vs Market) ---
    function drawTrendChart() {
        // Aggregate by week: Our Clicks vs Competitor Clicks
        const trendData = [['Week', 'Our Clicks', 'Competitor Clicks', 'Our Share (%)']];
        
        weeks.forEach(w => {
            const weeklyData = marketData.filter(d => d.week_date === w);
            const totalVol = weeklyData[0].weekly_search_volume; // Assuming constant per keyword group
            
            // Calculate estimated clicks = volume * click_share
            let ourClicks = 0;
            let compClicks = 0;
            let ourShareSum = 0;

            weeklyData.forEach(d => {
                const estClicks = totalVol * (d.click_share / 100);
                if (d.is_yaba_asin === 'Y') {
                    ourClicks += estClicks;
                    ourShareSum += d.click_share;
                } else {
                    compClicks += estClicks;
                }
            });

            trendData.push([w, Math.round(ourClicks), Math.round(compClicks), ourShareSum]);
            
            // Update Metric Boxes
            if (w === lastWeek) {
                document.getElementById('total-clicks').innerText = Math.round(ourClicks + compClicks).toLocaleString();
                document.getElementById('our-share').innerText = ourShareSum.toFixed(2) + '%';
                
                // Comp Share
                const totalShare = weeklyData.reduce((sum, d) => sum + d.click_share, 0);
                document.getElementById('comp-share').innerText = (totalShare - ourShareSum).toFixed(2) + '%';
            }
        });

        const data = google.visualization.arrayToDataTable(trendData);
        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1} },
            vAxes: { 0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''} },
            colors: ['#4285F4', '#E0E0E0', '#34A853'],
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    // --- CHART 2: BRAND COMPETITIVENESS ---
    function drawBrandShareChart() {
        // 1. Identify Top 3 Competitors (excluding us)
        const brandShares = {};
        marketData.forEach(d => {
            if (d.real_brand === OUR_BRAND) return;
            if (!brandShares[d.real_brand]) brandShares[d.real_brand] = 0;
            brandShares[d.real_brand] += d.click_share;
        });

        const sortedBrands = Object.entries(brandShares).sort((a,b) => b[1] - a[1]);
        const top3Competitors = sortedBrands.slice(0, 3).map(b => b[0]);

        // 2. Build Time Series
        const header = ['Week', OUR_BRAND, ...top3Competitors, 'Others'];
        const rows = [];

        weeks.forEach(w => {
            const weeklyData = marketData.filter(d => d.week_date === w);
            const row = [w, 0, 0, 0, 0, 0]; // Init based on header length

            weeklyData.forEach(d => {
                const share = d.click_share;
                if (d.real_brand === OUR_BRAND) {
                    row[1] += share;
                } else {
                    const idx = top3Competitors.indexOf(d.real_brand);
                    if (idx !== -1) {
                        row[2 + idx] += share;
                    } else {
                        row[row.length - 1] += share; // Others
                    }
                }
            });
            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            vAxis: { title: 'Click Share %' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    // --- CHART 3: LEVERS TABLE ---
    function drawLeversTable() {
        // Show Top ASINs by Share and their Price/Badges status for Last Week
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        currentData.sort((a,b) => b.click_share - a.click_share);

        const tableData = [['Brand', 'ASIN', 'Price', 'Share', 'Deals?', 'Badges']];
        
        currentData.slice(0, 8).forEach(d => {
            const deals = d.weekly_number_of_days_with_deal > 0 ? 'üè∑Ô∏è' : '';
            const coupon = d.weekly_number_of_days_with_coupon > 0 ? '‚úÇÔ∏è' : '';
            const choice = d.weekly_number_of_days_with_amazon_choice_badge > 0 ? '‚≠ê' : '';
            const badges = [deals, coupon, choice].join(' ');
            
            tableData.push([
                d.real_brand, 
                d.asin, 
                {v: d.price, f: formatCurrency(d.price)}, 
                {v: d.click_share, f: formatPct(d.click_share)},
                deals || coupon ? 'Yes' : 'No',
                badges
            ]);
        });

        const data = google.visualization.arrayToDataTable(tableData);
        const table = new google.visualization.Table(document.getElementById('table_levers'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});

        // Levers text analysis
        const cheapest = currentData.reduce((prev, curr) => prev.price < curr.price ? prev : curr);
        const mostExp = currentData.reduce((prev, curr) => prev.price > curr.price ? prev : curr);
        const ourAvgPrice = currentData.filter(d => d.is_yaba_asin==='Y').reduce((sum, d) => sum + d.price, 0) / currentData.filter(d => d.is_yaba_asin==='Y').length;
        
        document.getElementById('levers-text').innerHTML = `
            <strong>An√°lisis de Precio:</strong> Rango del mercado de ${formatCurrency(cheapest.price)} a ${formatCurrency(mostExp.price)}. 
            Nuestra media: <span style="color:var(--primary)">${formatCurrency(ourAvgPrice)}</span>. 
            El l√≠der en share (${currentData[0].real_brand}) tiene precio de ${formatCurrency(currentData[0].price)}.
        `;
    }

    // --- CHART 4: EFFICIENCY (Scatter) ---
    function drawEfficiencyChart() {
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        
        // Header: [Rank, Share, Tooltip]
        const dataArr = [['Organic Rank', 'Click Share', {role: 'style'}, {role: 'tooltip'}]];
        
        currentData.forEach(d => {
            const isUs = d.is_yaba_asin === 'Y';
            const color = isUs ? '#4285F4' : '#9AA0A6';
            const pointSize = isUs ? 'point { size: 10; shape-type: circle; fill-color: #4285F4; }' : null;
            
            dataArr.push([
                d.average_organic_rank, 
                d.click_share, 
                pointSize,
                `${d.real_brand} (${d.asin})\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataArr);
        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // Changed direction to standard
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            colors: ['#9AA0A6'],
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // -------------------------------------------------------------------------
    // 4. INSIGHTS GENERATION (Rule-Based Text)
    // -------------------------------------------------------------------------
    function generateInsights() {
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        const ourData = currentData.filter(d => d.is_yaba_asin === 'Y');
        
        // Calculate shares
        const ourTotalShare = ourData.reduce((s,d) => s+d.click_share, 0);
        const brandShares = {};
        currentData.forEach(d => {
            if(!brandShares[d.real_brand]) brandShares[d.real_brand] = 0;
            brandShares[d.real_brand] += d.click_share;
        });
        
        const sortedBrands = Object.entries(brandShares).sort((a,b) => b[1]-a[1]);
        const leader = sortedBrands[0];
        
        // Insights List
        const insights = [];
        const recommendations = [];

        // Insight 1: Dominance
        if (sortedBrands[0][0] === OUR_BRAND) {
            insights.push(`<strong>Liderazgo de Mercado:</strong> ${OUR_BRAND} lidera la categor√≠a con un ${formatPct(ourTotalShare)} de click share total.`);
        } else {
            insights.push(`<strong>Competencia Fuerte:</strong> ${leader[0]} lidera el mercado (${formatPct(leader[1])}), superando a ${OUR_BRAND} (${formatPct(ourTotalShare)}).`);
        }

        // Insight 2: Badge Impact
        const badgeWinners = currentData.filter(d => d.weekly_number_of_days_with_amazon_choice_badge > 0 && d.click_share > 5);
        if (badgeWinners.length > 0) {
            insights.push(`<strong>Efecto Amazon Choice:</strong> ASINs con badge AC (ej. ${badgeWinners[0].real_brand}) muestran alta conversi√≥n a clics.`);
        }

        // Insight 3: Price Positioning
        const avgMarketPrice = currentData.reduce((s,d)=>s+d.price,0)/currentData.length;
        const ourAvg = ourData.reduce((s,d)=>s+d.price,0)/ourData.length;
        if(ourAvg > avgMarketPrice * 1.2) {
            insights.push(`<strong>Posicionamiento Premium:</strong> Tu precio medio (${formatCurrency(ourAvg)}) es significativamente superior a la media (${formatCurrency(avgMarketPrice)}).`);
        } else if (ourAvg < avgMarketPrice * 0.8) {
             insights.push(`<strong>Estrategia de Valor:</strong> Tu precio es competitivo por debajo de la media del mercado.`);
        } else {
             insights.push(`<strong>Precio Alineado:</strong> Tu estrategia de precios est√° alineada con el promedio de la categor√≠a.`);
        }

        // Insight 4: Efficiency
        const inefficientAsins = ourData.filter(d => d.average_organic_rank < 5 && d.click_share < 5);
        if(inefficientAsins.length > 0) {
            insights.push(`<strong>Oportunidad de Conversi√≥n:</strong> El ASIN ${inefficientAsins[0].asin} tiene buen rank (${inefficientAsins[0].average_organic_rank}) pero bajo share. Revisar imagen principal y t√≠tulo.`);
        } else {
            insights.push(`<strong>Alta Eficiencia:</strong> Tus ASINs top capturan cuota proporcional a su ranking org√°nico.`);
        }

        // Insight 5: Competitor Threats
        const threats = currentData.filter(d => d.is_yaba_asin === 'N' && d.weekly_number_of_days_with_deal > 0);
        if (threats.length > 0) {
            insights.push(`<strong>Presi√≥n Promocional:</strong> Competidores como ${threats[0].real_brand} est√°n activando deals agresivos.`);
        }

        // Recommendations
        if (ourTotalShare < 20) recommendations.push(`Activar cupones en ASINs principales para recuperar cuota frente a ${leader[0]}.`);
        recommendations.push(`Revisar palabras clave del ASIN top performer para defender la posici√≥n org√°nica.`);
        if (currentData.some(d => d.is_yaba_asin ==='N' && d.price < ourAvg - 5)) recommendations.push(`Monitorizar ASINs low-cost que puedan estar robando tr√°fico sensible al precio.`);
        
        // Render
        document.getElementById('insights-list').innerHTML = insights.map(i => `<li><span class="material-icons insight-icon">arrow_right</span><span>${i}</span></li>`).join('');
        document.getElementById('recommendations-list').innerHTML = recommendations.map(i => `<li><span class="material-icons insight-icon">check_circle</span><span>${i}</span></li>`).join('');

        // Other Insights
        document.getElementById('other-insights-text').innerText = "Se observa una fragmentaci√≥n de marcas. 'Perfect Ted' muestra m√∫ltiples variantes con precios muy distintos, atacando varios segmentos (Premium vs Entry).";
    }

    // -------------------------------------------------------------------------
    // 5. INTERACTIVE TAB LOGIC
    // -------------------------------------------------------------------------
    function switchTab(tabId) {
        document.getElementById('tab-report').style.display = tabId === 'report' ? 'block' : 'none';
        document.getElementById('tab-interactive').style.display = tabId === 'interactive' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(tabId === 'interactive') updateInteractive();
    }

    function setupInteractiveTab() {
        const weekSelect = document.getElementById('select-week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSelect.add(opt);
        });
        
        // Competitors list
        const compSelect = document.getElementById('select-competitor');
        const competitors = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.real_brand))];
        competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSelect.add(opt);
        });
    }

    function updateInteractive() {
        const selectedWeek = document.getElementById('select-week').value;
        const selectedComp = document.getElementById('select-competitor').value;

        const weekData = marketData.filter(d => d.week_date === selectedWeek);
        const us = weekData.filter(d => d.is_yaba_asin === 'Y');
        const them = weekData.filter(d => d.real_brand === selectedComp);

        // Metrics Calc (Weighted Averages)
        const calcAvg = (arr, field) => arr.length ? arr.reduce((s,d)=>s+d[field],0)/arr.length : 0;
        const calcSum = (arr, field) => arr.reduce((s,d)=>s+d[field],0);

        const ourPrice = calcAvg(us, 'price');
        const theirPrice = calcAvg(them, 'price');
        
        const ourShare = calcSum(us, 'click_share');
        const theirShare = calcSum(them, 'click_share');

        const ourRank = calcAvg(us, 'average_organic_rank');
        const theirRank = calcAvg(them, 'average_organic_rank');

        // Update DOM
        const priceDiff = ourPrice - theirPrice;
        const diffPriceEl = document.getElementById('diff-price');
        diffPriceEl.innerText = (priceDiff > 0 ? '+' : '') + formatCurrency(priceDiff);
        diffPriceEl.style.color = priceDiff > 0 ? 'var(--danger)' : 'var(--success)'; // Green if we are cheaper? Depends on strategy. Assuming cheaper is green for consumer.

        const shareDiff = ourShare - theirShare;
        const diffShareEl = document.getElementById('diff-share');
        diffShareEl.innerText = (shareDiff > 0 ? '+' : '') + formatPct(shareDiff);
        diffShareEl.style.color = shareDiff > 0 ? 'var(--success)' : 'var(--danger)';

        const rankDiff = ourRank - theirRank; // Lower is better
        const diffRankEl = document.getElementById('diff-rank');
        diffRankEl.innerText = (rankDiff < 0 ? 'Mejor' : 'Peor') + ` (${Math.abs(rankDiff).toFixed(1)})`;
        diffRankEl.style.color = rankDiff < 0 ? 'var(--success)' : 'var(--danger)';

        // Draw Table Comparison
        const tableData = [['Metric', 'Nosotros', selectedComp, 'Delta']];
        tableData.push(['Avg Price', formatCurrency(ourPrice), formatCurrency(theirPrice), formatCurrency(priceDiff)]);
        tableData.push(['Total Click Share', formatPct(ourShare), formatPct(theirShare), formatPct(shareDiff)]);
        tableData.push(['Avg Rank', ourRank.toFixed(1), theirRank.toFixed(1), rankDiff.toFixed(1)]);
        tableData.push(['Active ASINs', us.length, them.length, us.length - them.length]);

        const data = google.visualization.arrayToDataTable(tableData);
        const table = new google.visualization.Table(document.getElementById('table_interactive'));
        table.draw(data, {width: '100%'});
    }

</script>

</body>
</html>