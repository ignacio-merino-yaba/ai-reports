<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Analysis - Matcha Premium</title>
    
    <!-- Google Charts & Icons -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC04; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray: #5F6368;
            --bg: #F8F9FA;
            --card-bg: #FFFFFF;
            --font-main: 'Roboto', 'Segoe UI', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: #202124;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 400;
            color: var(--gray);
            margin: 0;
        }
        .header h2 {
            font-size: 32px;
            font-weight: 500;
            margin: 8px 0;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-title {
            font-size: 18px;
            color: var(--gray);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-1-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 24px; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-1-2 { grid-template-columns: 1fr; }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* KPI Badges */
        .kpi-value { font-size: 36px; font-weight: bold; color: #202124; }
        .kpi-label { font-size: 14px; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-up { color: var(--success); display: flex; align-items: center; font-size: 14px; font-weight: 500;}
        .trend-down { color: var(--danger); display: flex; align-items: center; font-size: 14px; font-weight: 500;}

        /* Insights List */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: flex-start;
        }
        .insight-icon {
            color: var(--primary);
            background: #E8F0FE;
            padding: 8px;
            border-radius: 50%;
        }
        .rec-icon {
            color: var(--success);
            background: #E6F4EA;
            padding: 8px;
            border-radius: 50%;
        }
        
        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            background: #fff;
            min-width: 150px;
        }

        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 350px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Parent ASIN Analysis</h1>
        <h2>Matcha Premium <span style="font-size: 16px; color: var(--gray); vertical-align: middle;">(Last 4 Weeks)</span></h2>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard Estratégico</button>
        <button class="tab-btn" onclick="switchTab('comparator')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: DASHBOARD -->
    <div id="dashboard" class="tab-content active">
        
        <!-- KPI Row -->
        <div class="grid-3">
            <div class="card">
                <div class="kpi-label">Nuestra Cuota (Semana Actual)</div>
                <div class="kpi-value" id="kpi-share">--%</div>
                <div id="kpi-trend-share"></div>
            </div>
            <div class="card">
                <div class="kpi-label">Clicks Estimados</div>
                <div class="kpi-value" id="kpi-clicks">--</div>
                <div id="kpi-trend-clicks"></div>
            </div>
            <div class="card">
                <div class="kpi-label">Top Competidor</div>
                <div class="kpi-value" id="kpi-competitor" style="font-size: 24px;">--</div>
                <div class="kpi-label" style="margin-top:5px; font-size:11px;">Amenaza Principal</div>
            </div>
        </div>

        <!-- Section 1 & 2: Trends -->
        <div class="grid-1-2">
            <div class="card">
                <div class="card-title"><span class="material-icons">trending_up</span> Tendencia Global del Parent</div>
                <div id="chart_trend" class="chart-box"></div>
                <p style="font-size:12px; color:#666; margin-top:10px;">Barras: Volumen Clicks | Línea: Cuota de Mercado</p>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">show_chart</span> Competitividad de Marca (Click Share)</div>
                <div id="chart_comp" class="chart-box"></div>
            </div>
        </div>

        <!-- Section 3 & 4: Efficiency & Levers -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title"><span class="material-icons">scatter_plot</span> Eficiencia (Rank vs Share)</div>
                <div id="chart_efficiency" class="chart-box"></div>
                <p style="font-size:12px; color:#666;">Eje X: Ranking Orgánico (invertido) | Eje Y: Click Share. <br>Burbujas arriba a la derecha = Alta Eficiencia.</p>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">tune</span> Palancas de Crecimiento (Impacto)</div>
                <div id="chart_levers" class="chart-box"></div>
                <p style="font-size:12px; color:#666;">Comparativa de Share promedio cuando activamos Deals vs Semanas normales.</p>
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="grid-2">
            <div class="card" style="background-color: #F8F9FA; border-left: 4px solid var(--primary);">
                <div class="card-title" style="color: var(--primary); font-weight:bold;">
                    <span class="material-icons">lightbulb</span> Insights Clave
                </div>
                <div id="insights-container"></div>
            </div>
            <div class="card" style="background-color: #F8F9FA; border-left: 4px solid var(--success);">
                <div class="card-title" style="color: var(--success); font-weight:bold;">
                    <span class="material-icons">check_circle</span> Recomendaciones Accionables
                </div>
                <div id="recs-container"></div>
            </div>
        </div>
    </div>

    <!-- TAB 2: COMPARATOR -->
    <div id="comparator" class="tab-content">
        <div class="card">
            <div class="controls">
                <label>Seleccionar Semana:</label>
                <select id="comp-week-select" onchange="drawInteractiveTable()"></select>
                <label>Filtrar Marca (Opcional):</label>
                <select id="comp-brand-select" onchange="drawInteractiveTable()">
                    <option value="ALL">Todas</option>
                </select>
            </div>
            <div id="table_comparator" style="width: 100%; min-height: 500px;"></div>
        </div>
    </div>

</div>

<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION (FROM PYTHON)
    // ---------------------------------------------------------
    const rawData = [{"week":"2025-51","brand":"NaturaleBio","is_yaba":"Y","share":11.18,"price":14.084285714,"rank":2.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":6803.60018,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ5DCYJ"},{"week":"2026-01","brand":"NaturaleBio","is_yaba":"Y","share":12.9,"price":14.6075,"rank":2.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":3484.4319,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ5DCYJ"},{"week":"2025-52","brand":"NaturaleBio","is_yaba":"Y","share":11.66,"price":15.058571429,"rank":2.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":5562.759796,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ5DCYJ"},{"week":"2025-52","brand":"NaturaleBio","is_yaba":"Y","share":3.75,"price":10.538571429,"rank":4.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1789.05225,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ69YCQ"},{"week":"2026-01","brand":"NaturaleBio","is_yaba":"Y","share":3.35,"price":10.2225,"rank":5.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":904.87185,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ69YCQ"},{"week":"2025-51","brand":"NaturaleBio","is_yaba":"Y","share":3.85,"price":9.2,"rank":5.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":2342.92135,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ69YCQ"},{"week":"2025-51","brand":"NaturaleBio","is_yaba":"Y","share":3.69,"price":23.075714286,"rank":5.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":2245.55319,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B079VQ52MK"},{"week":"2025-52","brand":"NaturaleBio","is_yaba":"Y","share":3.49,"price":24.855714286,"rank":5.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1665.011294,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B079VQ52MK"},{"week":"2026-01","brand":"NaturaleBio","is_yaba":"Y","share":3.66,"price":24.5275,"rank":5.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":988.60626,"title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B079VQ52MK"},{"week":"2025-52","brand":"VAHDAM","is_yaba":"N","share":1.47,"price":9.895714286,"rank":20.0,"days_deal":3.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":701.308482,"title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","asin":"B07K1WBH4K"},{"week":"2025-52","brand":"VAHDAM","is_yaba":"N","share":4.19,"price":9.895714286,"rank":7.0,"days_deal":3.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1998.967714,"title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","asin":"B07MD4LB49"},{"week":"2025-51","brand":"VAHDAM","is_yaba":"N","share":3.49,"price":9.005714286,"rank":8.0,"days_deal":5.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":2123.84299,"title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","asin":"B07MD4LB49"},{"week":"2026-01","brand":"VAHDAM","is_yaba":"N","share":3.15,"price":10.43,"rank":9.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":850.84965,"title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","asin":"B07MD4LB49"},{"week":"2026-01","brand":"NaturaleBio","is_yaba":"Y","share":2.68,"price":30.27,"rank":100.0,"days_deal":null,"days_coupon":null,"days_bs":null,"days_ac":null,"clicks":723.89748,"title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","asin":"B07SZFD3P9"},{"week":"2025-51","brand":"NaturaleBio","is_yaba":"Y","share":2.95,"price":26.748571429,"rank":22.0,"days_deal":7.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1795.22545,"title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","asin":"B07SZFD3P9"},{"week":"2025-52","brand":"NaturaleBio","is_yaba":"Y","share":2.93,"price":30.704285714,"rank":23.0,"days_deal":1.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1397.846158,"title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","asin":"B07SZFD3P9"},{"week":"2025-52","brand":"Bio","is_yaba":"N","share":2.44,"price":12.367142857,"rank":10.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1164.076664,"title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","asin":"B08XVX8V1T"},{"week":"2026-01","brand":"Bio","is_yaba":"N","share":2.39,"price":11.9975,"rank":10.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":645.56529,"title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","asin":"B08XVX8V1T"},{"week":"2026-01","brand":"bioKontor","is_yaba":"N","share":2.39,"price":11.9975,"rank":10.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":645.56529,"title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","asin":"B08XVX8V1T"},{"week":"2025-52","brand":"bioKontor","is_yaba":"N","share":2.44,"price":12.367142857,"rank":10.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1164.076664,"title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","asin":"B08XVX8V1T"},{"week":"2026-01","brand":"NORITUAL LAB","is_yaba":"N","share":19.34,"price":23.91,"rank":2.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":4.0,"clicks":5223.94674,"title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","asin":"B0CNRX8G5S"},{"week":"2025-51","brand":"NORITUAL LAB","is_yaba":"N","share":16.66,"price":24.03,"rank":2.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":7.0,"clicks":10138.45966,"title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","asin":"B0CNRX8G5S"},{"week":"2025-52","brand":"NORITUAL LAB","is_yaba":"N","share":18.77,"price":24.648571429,"rank":2.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":7.0,"clicks":8954.802862,"title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","asin":"B0CNRX8G5S"},{"week":"2025-52","brand":"Matcha","is_yaba":"N","share":3.4,"price":10.71,"rank":13.0,"days_deal":0.0,"days_coupon":7.0,"days_bs":0.0,"days_ac":0.0,"clicks":1622.07404,"title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week":"2025-52","brand":"Special Leaves","is_yaba":"N","share":3.4,"price":10.71,"rank":13.0,"days_deal":0.0,"days_coupon":7.0,"days_bs":0.0,"days_ac":0.0,"clicks":1622.07404,"title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week":"2025-51","brand":"Special Leaves","is_yaba":"N","share":3.48,"price":10.44,"rank":14.0,"days_deal":0.0,"days_coupon":7.0,"days_bs":0.0,"days_ac":0.0,"clicks":2117.75748,"title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week":"2025-51","brand":"Matcha","is_yaba":"N","share":3.48,"price":10.44,"rank":14.0,"days_deal":0.0,"days_coupon":7.0,"days_bs":0.0,"days_ac":0.0,"clicks":2117.75748,"title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week":"2026-01","brand":"Special Leaves","is_yaba":"N","share":3.0,"price":10.39,"rank":16.0,"days_deal":0.0,"days_coupon":4.0,"days_bs":0.0,"days_ac":0.0,"clicks":810.333,"title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week":"2026-01","brand":"Matcha","is_yaba":"N","share":3.0,"price":10.39,"rank":16.0,"days_deal":0.0,"days_coupon":4.0,"days_bs":0.0,"days_ac":0.0,"clicks":810.333,"title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week":"2025-51","brand":"Jean","is_yaba":"N","share":1.92,"price":3.095714286,"rank":12.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1168.41792,"title":"Jean & Len Handcreme I Love You So Matcha, f\u00fcr nor...","asin":"B0F5BVFRC1"},{"week":"2026-01","brand":"UNREAL","is_yaba":"N","share":1.57,"price":31.2725,"rank":19.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":424.07427,"title":"UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...","asin":"B0F9B1LWQQ"},{"week":"2025-51","brand":"Ceremonial","is_yaba":"N","share":8.85,"price":15.635714286,"rank":5.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":5385.67635,"title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week":"2025-51","brand":"NORITUAL LAB","is_yaba":"N","share":8.85,"price":15.635714286,"rank":5.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":5385.67635,"title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week":"2025-52","brand":"Ceremonial","is_yaba":"N","share":8.42,"price":16.037142857,"rank":6.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":4017.018652,"title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week":"2026-01","brand":"NORITUAL LAB","is_yaba":"N","share":7.38,"price":15.5575,"rank":6.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1993.41918,"title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week":"2025-52","brand":"NORITUAL LAB","is_yaba":"N","share":8.42,"price":16.037142857,"rank":6.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":4017.018652,"title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week":"2026-01","brand":"Ceremonial","is_yaba":"N","share":7.38,"price":15.5575,"rank":6.0,"days_deal":0.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1993.41918,"title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week":"2025-51","brand":"Ceremonial","is_yaba":"N","share":2.56,"price":8.898571429,"rank":12.0,"days_deal":7.0,"days_coupon":0.0,"days_bs":0.0,"days_ac":0.0,"clicks":1557.89056,"title":"Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...","asin":"B0G1T7N675"}];
    const ourBrand = "NaturaleBio";
    const insights = ["Alerta de tr\u00e1fico: Nuestros clicks cayeron de 10414 a 6101 (2026-01).", "Competidor principal: 'NORITUAL LAB' lidera la oposici\u00f3n. Comparar sus badges esta semana.", "Eficiencia promo baja: Las promociones actuales no generan lift significativo en share.", "Posicionamiento: Tu precio medio (19.49\u20ac) es superior al mercado (13.90\u20ac).", "Rank & Share: Revisa el gr\u00e1fico de Eficiencia para detectar ASINs con alto rank pero bajo share."];
    const recommendations = ["Acci\u00f3n inmediata: Revisar ASINs 'Underperformers' en el gr\u00e1fico de Eficiencia (cuadrante inferior derecho).", "Pricing: Evaluar reducci\u00f3n de precio temporal o cupones en lugar de Deals, ya que el Deal no tracciona.", "Competencia: Analizar keywords donde NORITUAL LAB gana share sin bajar precio."];
    const topCompetitors = ["NORITUAL LAB", "Ceremonial", "VAHDAM"];
    const lastWeek = "2026-01";

    // ---------------------------------------------------------
    // 2. SETUP & INITIALIZATION
    // ---------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        populateInsights();
        populateKPIs();
        populateSelectors();
        drawTrendChart();
        drawCompChart();
        drawEfficiencyChart();
        drawLeversChart();
        drawInteractiveTable(); // Init with defaults
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        // Redraw table if comparator is clicked to ensure size is correct
        if(tabId === 'comparator') drawInteractiveTable();
    }

    function populateInsights() {
        const insDiv = document.getElementById('insights-container');
        insights.forEach(text => {
            insDiv.innerHTML += `<div class="insight-item"><span class="material-icons insight-icon">analytics</span><span>${text}</span></div>`;
        });
        const recDiv = document.getElementById('recs-container');
        recommendations.forEach(text => {
            recDiv.innerHTML += `<div class="insight-item"><span class="material-icons rec-icon">bolt</span><span>${text}</span></div>`;
        });
    }

    function populateKPIs() {
        // Calculate latest share
        const lastWeekData = rawData.filter(d => d.week === lastWeek && d.is_yaba === 'Y');
        const totalShare = lastWeekData.reduce((acc, c) => acc + c.share, 0).toFixed(1);
        const totalClicks = lastWeekData.reduce((acc, c) => acc + c.clicks, 0).toFixed(0);

        document.getElementById('kpi-share').innerText = totalShare + '%';
        document.getElementById('kpi-clicks').innerText = Number(totalClicks).toLocaleString();
        document.getElementById('kpi-competitor').innerText = topCompetitors[0] || 'N/A';
    }

    // ---------------------------------------------------------
    // 3. CHARTING FUNCTIONS
    // ---------------------------------------------------------

    // SECTION 1: GLOBAL TREND (COMBO)
    function drawTrendChart() {
        // Aggregation: Group by week
        const weeks = [...new Set(rawData.map(d => d.week))].sort();
        const data = [['Week', 'Nuestros Clicks', 'Clicks Competencia', 'Nuestra Cuota (%)']];
        
        weeks.forEach(w => {
            const our = rawData.filter(d => d.week === w && d.is_yaba === 'Y');
            const comp = rawData.filter(d => d.week === w && d.is_yaba === 'N');
            const ourClicks = our.reduce((a,b) => a + b.clicks, 0);
            const compClicks = comp.reduce((a,b) => a + b.clicks, 0);
            const ourShare = our.reduce((a,b) => a + b.share, 0);
            data.push([w, ourClicks, compClicks, ourShare]);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3} },
            colors: ['#8AB4F8', '#E8EAED'],
            vAxes: { 0: {title: 'Volumen Clicks'}, 1: {title: 'Cuota %'} },
            legend: { position: 'bottom' },
            chartArea: {width: '85%', height: '70%'}
        };
        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(dt, options);
    }

    // SECTION 2: COMPETITIVENESS (LINE)
    function drawCompChart() {
        const weeks = [...new Set(rawData.map(d => d.week))].sort();
        const header = ['Week', ourBrand, ...topCompetitors, 'Otros'];
        const data = [header];

        weeks.forEach(w => {
            const weekData = rawData.filter(d => d.week === w);
            const row = [w];
            
            // Our Brand
            row.push(weekData.filter(d => d.brand === ourBrand).reduce((a,b)=>a+b.share,0) || 0);
            
            // Top 3 Comps
            topCompetitors.forEach(tc => {
                row.push(weekData.filter(d => d.brand === tc).reduce((a,b)=>a+b.share,0) || 0);
            });

            // Others
            const tracked = [ourBrand, ...topCompetitors];
            const others = weekData.filter(d => !tracked.includes(d.brand)).reduce((a,b)=>a+b.share,0) || 0;
            row.push(others);

            data.push(row);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            curveType: 'function',
            lineWidth: 2,
            colors: ['#4285F4', '#EA4335', '#FBBC04', '#34A853', '#9AA0A6'],
            legend: { position: 'bottom' },
            chartArea: {width: '90%', height: '70%'},
            vAxis: { title: 'Click Share %' }
        };
        const chart = new google.visualization.LineChart(document.getElementById('chart_comp'));
        chart.draw(dt, options);
    }

    // SECTION 4: EFFICIENCY (SCATTER)
    function drawEfficiencyChart() {
        // Rank vs Share for Last Week
        const data = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        const lwData = rawData.filter(d => d.week === lastWeek);
        
        lwData.forEach(d => {
            const color = d.is_yaba === 'Y' ? '#4285F4' : '#EA4335';
            const tooltip = `${d.brand} - Rank: ${d.rank}, Share: ${d.share}%`;
            // Rank is usually 1=Best, so we invert or just plot standard. 
            // Better visualization: Y=Share, X=Rank.
            data.push([d.rank, d.share, `point {fill-color: ${color}; opacity: 0.7; size: 10}`, tooltip]);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            title: `Distribución Semana ${lastWeek} (Azul: Nosotros, Rojo: Comp)`,
            hAxis: { title: 'Organic Rank (Menor es mejor)', direction: 1 },
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: {width: '85%', height: '75%'}
        };
        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(dt, options);
    }

    // SECTION 3: LEVERS (BAR)
    function drawLeversChart() {
        // Calculate avg share with Deal vs No Deal for our brand
        const ourAsins = rawData.filter(d => d.brand === ourBrand);
        
        // Helper
        const avg = (arr) => arr.length ? arr.reduce((a,b)=>a+b.share,0)/arr.length : 0;

        const withDeal = ourAsins.filter(d => d.days_deal > 0);
        const withoutDeal = ourAsins.filter(d => !d.days_deal || d.days_deal === 0);
        const withCoupon = ourAsins.filter(d => d.days_coupon > 0);

        const valDeal = avg(withDeal);
        const valNoDeal = avg(withoutDeal);
        const valCoupon = avg(withCoupon);

        const data = google.visualization.arrayToDataTable([
            ['Estado', 'Share Promedio %', { role: 'style' }],
            ['Sin Promo', valNoDeal, '#9AA0A6'],
            ['Con Deal', valDeal, '#EA4335'],
            ['Con Cupón', valCoupon, '#34A853']
        ]);

        const options = {
            legend: { position: "none" },
            vAxis: { minValue: 0 },
            bar: { groupWidth: "50%" },
            chartArea: {width: '80%', height: '70%'}
        };
        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    // ---------------------------------------------------------
    // 4. INTERACTIVE TAB LOGIC
    // ---------------------------------------------------------
    function populateSelectors() {
        const weeks = [...new Set(rawData.map(d => d.week))].sort();
        const brands = [...new Set(rawData.map(d => d.brand))].sort();
        
        const weekSel = document.getElementById('comp-week-select');
        const brandSel = document.getElementById('comp-brand-select');

        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            if (w === lastWeek) opt.selected = true;
            weekSel.add(opt);
        });

        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            brandSel.add(opt);
        });
    }

    function drawInteractiveTable() {
        const selWeek = document.getElementById('comp-week-select').value;
        const selBrand = document.getElementById('comp-brand-select').value;

        let filtered = rawData.filter(d => d.week === selWeek);
        if(selBrand !== 'ALL') {
            filtered = filtered.filter(d => d.brand === selBrand);
        }

        // Create DataTable
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Brand');
        data.addColumn('string', 'ASIN');
        data.addColumn('number', 'Share %');
        data.addColumn('number', 'Rank');
        data.addColumn('number', 'Price');
        data.addColumn('string', 'Deal');
        data.addColumn('string', 'Badge');

        filtered.forEach(row => {
            const dealTxt = row.days_deal > 0 ? 'YES' : (row.days_coupon > 0 ? 'Cpn' : '-');
            const badgeTxt = row.days_bs > 0 ? 'BS' : (row.days_ac > 0 ? 'AC' : '-');
            data.addRow([
                row.brand, 
                row.asin, 
                row.share, 
                row.rank, 
                row.price, 
                dealTxt, 
                badgeTxt
            ]);
        });

        const table = new google.visualization.Table(document.getElementById('table_comparator'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
    }

    // Responsive Redraw
    window.onresize = function(){
        drawTrendChart();
        drawCompChart();
        drawEfficiencyChart();
        drawLeversChart();
        drawInteractiveTable();
    };

</script>

</body>
</html>