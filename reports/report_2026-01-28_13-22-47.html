<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Market Intelligence Report</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-500: #6B7280;
            --gray-800: #1F2937;
            --white: #FFFFFF;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #F8F9FA;
            color: var(--gray-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout & Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            margin-bottom: 32px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #111;
            margin: 0 0 8px 0;
        }

        .subtitle {
            color: var(--gray-500);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 12px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: var(--primary);
            color: var(--white);
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.02);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-box {
            background: #F8FAFC;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        .metric-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .metric-trend {
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Chart Containers */
        .chart-wrapper {
            width: 100%;
            height: 400px;
            overflow: hidden;
        }

        /* Insights Section */
        .insights-container {
            background-color: #F0F7FF;
            border: 1px solid #DBEAFE;
            border-radius: var(--radius);
            padding: 24px;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .insight-icon {
            color: var(--primary);
            flex-shrink: 0;
        }

        .insight-text strong {
            display: block;
            color: var(--gray-800);
            margin-bottom: 2px;
        }
        
        .insight-text {
            font-size: 14px;
            color: var(--gray-800);
        }

        /* Interactive Section */
        .comparison-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-size: 14px;
            min-width: 200px;
            outline: none;
            background-color: white;
            cursor: pointer;
        }

        .vs-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: 700;
            color: var(--gray-500);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Utility */
        .hidden { display: none; }
        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .tag-us { background: #E8F0FE; color: var(--primary); }
        .tag-comp { background: #FEF2F2; color: var(--danger); }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Parent ASIN Intelligence Report</h1>
        <div class="subtitle">Market Analysis • Click Share • Competitiveness • Efficiency</div>
    </header>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Market Dashboard</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Interactive Comparator</button>
    </div>

    <!-- MAIN DASHBOARD TAB -->
    <div id="tab-static">
        
        <!-- KPI Row -->
        <div class="metrics-grid" id="kpi-container">
            <!-- Populated by JS -->
        </div>

        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">show_chart</span>
                    Global Trend (Clicks & Share)
                </div>
            </div>
            <div id="chart_trend" class="chart-wrapper"></div>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">inventory_2</span>
                    Brand Competitiveness (Share %)
                </div>
                <div class="subtitle">Top 3 Competitors vs Us</div>
            </div>
            <div id="chart_competitiveness" class="chart-wrapper"></div>
        </div>

        <!-- Section 3 & 4: Efficiency & Levers -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">scatter_plot</span>
                        Organic Rank vs. Click Share
                    </div>
                </div>
                <div id="chart_efficiency" class="chart-wrapper"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">local_offer</span>
                        Promotional Levers Impact
                    </div>
                </div>
                <div id="chart_levers" class="chart-wrapper"></div>
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    Key Insights & Recommendations
                </div>
            </div>
            <div class="insights-container" id="insights-list">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>

    <!-- INTERACTIVE TAB -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Head-to-Head Comparison</div>
            </div>
            
            <div class="comparison-controls">
                <div>
                    <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Our Brand</label>
                    <select id="select-us" disabled style="background:#f3f4f6; cursor:not-allowed;"></select>
                </div>
                <div class="vs-badge">VS</div>
                <div>
                    <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Competitor</label>
                    <select id="select-competitor" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="comparison-grid">
                <!-- Our Side -->
                <div style="border-right: 1px solid #eee; padding-right: 20px;">
                    <h3 style="color: var(--primary); margin-top:0;" id="comp-us-title">Us</h3>
                    <div id="comp-us-metrics"></div>
                </div>
                <!-- Competitor Side -->
                <div>
                    <h3 style="color: var(--danger); margin-top:0;" id="comp-them-title">Competitor</h3>
                    <div id="comp-them-metrics"></div>
                </div>
            </div>
            
            <div id="chart_comparison" class="chart-wrapper" style="margin-top: 24px;"></div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script>
    // 1. DATA INJECTION (Processed from CSV)
    const marketData = [{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":"Crafti","asin":"B0CXT6L9H5","product_title":"Crafti Ceremonial Grade Matcha Powder (Organic) - ...","country_code":"us","average_organic_rank":21,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":1.97,"estimated_clicks":2179.050096,"price":20.95,"competitor_brand":"Crafti","is_yaba_asin":"N"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":"Naoki Matcha","asin":"B01L2GW7SI","product_title":"Naoki Matcha Superior Ceremonial Blend \u2013 Authentic...","country_code":"us","average_organic_rank":3,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":4,"weekly_number_of_days_with_coupon":0,"click_share":8.35,"estimated_clicks":9236.07528,"price":24.99,"competitor_brand":"Naoki Matcha","is_yaba_asin":"N"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":"Chaism","asin":"B0BPXQ2PR5","product_title":"Chaism Ceremonial Grade Matcha Green Tea Powder - ...","country_code":"us","average_organic_rank":9,"weekly_number_of_days_with_deal":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":5.66,"estimated_clicks":6260.621088,"price":17.847142857,"competitor_brand":"Chaism","is_yaba_asin":"N"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":null,"asin":"B0DV6Z5MYZ","product_title":"Soeos Organic Matcha Powder, Matcha Green Tea Powd...","country_code":"us","average_organic_rank":12,"weekly_number_of_days_with_deal":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":2.47,"estimated_clicks":2732.108496,"price":6.69,"competitor_brand":"Soeos","is_yaba_asin":"N"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":"MATCHA DNA","asin":"B077572GG8","product_title":"MATCHA DNA Certified Organic Matcha Green Tea Powd...","country_code":"us","average_organic_rank":8,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":3.93,"estimated_clicks":4347.039024,"price":19.99,"competitor_brand":"MATCHA DNA","is_yaba_asin":"Y"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":"Jade Leaf Matcha","asin":"B089Q9XD2T","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":7,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":3,"click_share":4.47,"estimated_clicks":4944.342096,"price":30.984285714,"competitor_brand":"Jade Leaf Matcha","is_yaba_asin":"N"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":"Jade Leaf Matcha","asin":"B01DTQD7VA","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":6,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":4.83,"estimated_clicks":5342.544144,"price":10.99,"competitor_brand":"Jade Leaf Matcha","is_yaba_asin":"N"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":"Jade Leaf Matcha","asin":"B00PFDH0IC","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":13.99,"estimated_clicks":15474.574032,"price":10.99,"competitor_brand":"Jade Leaf Matcha","is_yaba_asin":"N"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":null,"asin":"B097Z6ZH1S","product_title":"Jade Leaf Matcha Premium Ceremonial Grade Matcha G...","country_code":"us","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":2.78,"estimated_clicks":3075.004704,"price":17.99,"competitor_brand":"Jade Leaf Matcha","is_yaba_asin":"N"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","original_brand":"Micro Ingredients","asin":"B08PY3Q8XS","product_title":"Micro Ingredients Organic Matcha Green Tea Powder,...","country_code":"us","average_organic_rank":3,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":5,"weekly_number_of_days_with_coupon":7,"click_share":5.16,"estimated_clicks":5707.562688,"price":23.19,"competitor_brand":"Micro Ingredients","is_yaba_asin":"N"}];

    // 2. CONFIGURATION & STATE
    let OUR_BRAND = '';
    let TOP_COMPETITORS = [];
    
    // Google Charts Initialization
    google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processData();
        renderKPIs();
        drawTrendChart();
        drawCompetitivenessChart();
        drawEfficiencyChart();
        drawLeversChart();
        generateInsights();
        initInteractiveTab();
    }

    // 3. DATA PROCESSING
    function processData() {
        // Identify Our Brand
        const ourAsinData = marketData.find(d => d.is_yaba_asin === 'Y');
        OUR_BRAND = ourAsinData ? ourAsinData.competitor_brand : 'Unknown';

        // Calculate Brand Shares to find Top 3
        const brandShares = {};
        marketData.forEach(d => {
            const b = d.competitor_brand || 'Unknown';
            brandShares[b] = (brandShares[b] || 0) + d.click_share;
        });

        // Sort brands excluding ours
        TOP_COMPETITORS = Object.keys(brandShares)
            .filter(b => b !== OUR_BRAND && b !== 'Unknown')
            .sort((a, b) => brandShares[b] - brandShares[a])
            .slice(0, 3);
    }

    // 4. CHART FUNCTIONS
    
    // CHART 1: Global Trend (Aggregated)
    function drawTrendChart() {
        // Aggregate by week
        const weekData = {};
        marketData.forEach(d => {
            if (!weekData[d.week_date]) {
                weekData[d.week_date] = { clicks: 0, my_share_sum: 0, total_share: 0, count: 0 };
            }
            weekData[d.week_date].clicks += d.estimated_clicks;
            weekData[d.week_date].total_share += d.click_share;
            if (d.is_yaba_asin === 'Y') {
                weekData[d.week_date].my_share_sum += d.click_share;
            }
        });

        const dataArray = [['Week', 'Total Market Clicks', 'Our Share (%)']];
        Object.keys(weekData).sort().forEach(week => {
            dataArray.push([
                week, 
                weekData[week].clicks, 
                weekData[week].my_share_sum
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
            colors: ['#E5E7EB'],
            legend: { position: 'bottom' },
            vAxes: {
                0: {title: 'Clicks Volume', gridlines: {color: 'transparent'}},
                1: {title: 'Our Share %', format: '#\'%\''}
            },
            chartArea: {width: '85%', height: '75%'},
            bar: { groupWidth: '60%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    // CHART 2: Competitiveness (Line Chart)
    function drawCompetitivenessChart() {
        // Aggregate share per brand per week
        const brandWeekly = {};
        // Initialize structure
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        marketData.forEach(d => {
            const b = d.competitor_brand;
            const w = d.week_date;
            if (!brandWeekly[w]) brandWeekly[w] = {};
            brandWeekly[w][b] = (brandWeekly[w][b] || 0) + d.click_share;
        });

        const dataArray = [['Week', OUR_BRAND, ...TOP_COMPETITORS]];
        
        weeks.forEach(week => {
            const row = [week];
            // Our Brand
            row.push(brandWeekly[week][OUR_BRAND] || 0);
            // Competitors
            TOP_COMPETITORS.forEach(comp => {
                row.push(brandWeekly[week][comp] || 0);
            });
            dataArray.push(row);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'], // Blue for us, others for comps
            vAxis: { title: 'Click Share (%)' },
            chartArea: {width: '85%', height: '75%'},
            pointSize: 7
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    // CHART 3: Efficiency (Scatter: Rank vs Share)
    function drawEfficiencyChart() {
        const dataArray = [['Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        marketData.forEach(d => {
            const isUs = d.is_yaba_asin === 'Y';
            const color = isUs ? '#4285F4' : '#999999';
            const pointShape = isUs ? 'circle' : 'triangle';
            const tooltip = `${d.competitor_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%\nPrice: $${d.price}`;
            
            dataArray.push([
                d.average_organic_rank, 
                d.click_share, 
                `point { size: ${isUs ? 10 : 5}; shape-type: ${pointShape}; fill-color: ${color}; stroke-color: ${color}; }`,
                tooltip
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // Changed direction to natural rank
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            chartArea: {width: '85%', height: '75%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // CHART 4: Levers (Bar Chart: With Deal vs Without)
    function drawLeversChart() {
        // Logic: Compare Avg Share for items with Deal vs No Deal
        let dealShareSum = 0, dealCount = 0;
        let noDealShareSum = 0, noDealCount = 0;

        marketData.forEach(d => {
            if (d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0) {
                dealShareSum += d.click_share;
                dealCount++;
            } else {
                noDealShareSum += d.click_share;
                noDealCount++;
            }
        });

        const avgDeal = dealCount ? dealShareSum / dealCount : 0;
        const avgNoDeal = noDealCount ? noDealShareSum / noDealCount : 0;

        const data = google.visualization.arrayToDataTable([
            ['Condition', 'Avg Click Share %', { role: 'style' }],
            ['With Promo (Deal/Coupon)', avgDeal, '#34A853'],
            ['No Promo', avgNoDeal, '#E5E7EB']
        ]);

        const options = {
            legend: { position: 'none' },
            vAxis: { title: 'Avg Click Share %' },
            chartArea: {width: '70%', height: '75%'}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    // 5. RENDER TEXT CONTENT & INSIGHTS
    function renderKPIs() {
        const ourData = marketData.filter(d => d.is_yaba_asin === 'Y');
        
        // Safety check if we have data
        const currentShare = ourData.reduce((acc, curr) => acc + curr.click_share, 0);
        const currentRank = ourData.length ? (ourData.reduce((acc, curr) => acc + curr.average_organic_rank, 0) / ourData.length).toFixed(1) : '-';
        const currentPrice = ourData.length ? (ourData.reduce((acc, curr) => acc + curr.price, 0) / ourData.length).toFixed(2) : '-';

        const container = document.getElementById('kpi-container');
        container.innerHTML = `
            <div class="metric-box">
                <div class="metric-label">Our Click Share</div>
                <div class="metric-value" style="color: var(--primary)">${currentShare.toFixed(2)}%</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Avg Organic Rank</div>
                <div class="metric-value">${currentRank}</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Avg Price</div>
                <div class="metric-value">$${currentPrice}</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Top Competitor</div>
                <div class="metric-value" style="font-size: 18px; margin-top:4px;">${TOP_COMPETITORS[0] || 'N/A'}</div>
            </div>
        `;
    }

    function generateInsights() {
        const container = document.getElementById('insights-list');
        let html = '';

        // Insight 1: Share Dominance
        const ourShare = marketData.filter(d => d.is_yaba_asin === 'Y').reduce((a,b)=>a+b.click_share,0);
        const leader = TOP_COMPETITORS[0];
        const leaderShare = marketData.filter(d => d.competitor_brand === leader).reduce((a,b)=>a+b.click_share,0);
        
        html += createInsight('emoji_events', 'Market Leadership', 
            ourShare > leaderShare 
            ? `We are leading with <strong>${ourShare.toFixed(1)}%</strong> share vs ${leader} (${leaderShare.toFixed(1)}%).`
            : `${leader} dominates with <strong>${leaderShare.toFixed(1)}%</strong> share. We trail at ${ourShare.toFixed(1)}%.`
        );

        // Insight 2: Pricing Strategy
        const ourPrice = marketData.find(d => d.is_yaba_asin === 'Y')?.price || 0;
        const leaderPrice = marketData.find(d => d.competitor_brand === leader && d.price > 0)?.price || 0;
        
        if (ourPrice && leaderPrice) {
            const diff = ((ourPrice - leaderPrice) / leaderPrice) * 100;
            const status = diff > 0 ? 'premium' : 'competitive';
            html += createInsight('payments', 'Price Positioning', 
                `Our price ($${ourPrice}) is <strong>${Math.abs(diff).toFixed(0)}% ${diff > 0 ? 'higher' : 'lower'}</strong> than the category leader.`
            );
        }

        // Insight 3: Promo Efficiency
        const deals = marketData.filter(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);
        const dealShare = deals.reduce((a,b)=>a+b.click_share,0) / (deals.length || 1);
        const noDeals = marketData.filter(d => d.weekly_number_of_days_with_deal === 0 && d.weekly_number_of_days_with_coupon === 0);
        const noDealShare = noDeals.reduce((a,b)=>a+b.click_share,0) / (noDeals.length || 1);
        
        if (dealShare > noDealShare) {
             html += createInsight('trending_up', 'Promotion Impact', 
                `ASINs with deals/coupons capture <strong>${((dealShare/noDealShare - 1)*100).toFixed(0)}% more share</strong> on average.`
            );
        }

        // Recommendations
        html += '<h4 style="margin: 24px 0 12px 0; color:var(--gray-800);">Actionable Recommendations</h4>';
        
        if (ourShare < leaderShare) {
            html += createInsight('ads_click', 'Defend Visibility', 'Activate coupons to close the gap with the category leader, as promo elasticity is high.');
        }
        
        const myRank = marketData.find(d => d.is_yaba_asin === 'Y')?.average_organic_rank || 100;
        if (myRank > 5) {
             html += createInsight('upgrade', 'SEO Focus', `Our Rank #${myRank} is limiting visibility. Review title keywords against top performers like ${TOP_COMPETITORS[0]}.`);
        }

        container.innerHTML = html;
    }

    function createInsight(icon, title, text) {
        return `
            <div class="insight-item">
                <div class="insight-icon"><span class="material-icons">${icon}</span></div>
                <div class="insight-text"><strong>${title}</strong>${text}</div>
            </div>
        `;
    }

    // 6. INTERACTIVE TAB LOGIC
    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        event.target.classList.add('active');
        
        // Redraw charts if needed to fix width issues
        if (tabId === 'static') {
            drawTrendChart();
            drawCompetitivenessChart();
        } else {
            initInteractiveTab();
        }
    }

    function initInteractiveTab() {
        const usSelect = document.getElementById('select-us');
        const compSelect = document.getElementById('select-competitor');

        // Populate Us
        usSelect.innerHTML = `<option>${OUR_BRAND}</option>`;
        
        // Populate Competitors
        if (compSelect.options.length === 0) {
            compSelect.innerHTML = '';
            TOP_COMPETITORS.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                compSelect.appendChild(opt);
            });
            // Add others
            const others = [...new Set(marketData.map(d => d.competitor_brand))].filter(b => b !== OUR_BRAND && !TOP_COMPETITORS.includes(b));
            others.forEach(c => {
                 const opt = document.createElement('option');
                 opt.value = c;
                 opt.innerText = c;
                 compSelect.appendChild(opt);
            });
        }
        updateComparator();
    }

    function updateComparator() {
        const compName = document.getElementById('select-competitor').value;
        const usData = marketData.filter(d => d.is_yaba_asin === 'Y');
        const compData = marketData.filter(d => d.competitor_brand === compName);

        // Calculate Averages for the table
        const getAvg = (data, field) => {
            if (!data.length) return 0;
            return data.reduce((a,b) => a + (b[field]||0), 0) / data.length;
        };

        const usShare = getAvg(usData, 'click_share');
        const compShare = getAvg(compData, 'click_share');
        const usPrice = getAvg(usData, 'price');
        const compPrice = getAvg(compData, 'price');
        const usRank = getAvg(usData, 'average_organic_rank');
        const compRank = getAvg(compData, 'average_organic_rank');

        // Update Titles
        document.getElementById('comp-us-title').innerText = OUR_BRAND;
        document.getElementById('comp-them-title').innerText = compName;

        // Update Metrics HTML
        const renderMetric = (label, val, suffix='') => `
            <div style="margin-bottom:12px;">
                <div style="font-size:12px; color:#666;">${label}</div>
                <div style="font-size:20px; font-weight:700;">${val.toFixed(1)}${suffix}</div>
            </div>`;

        document.getElementById('comp-us-metrics').innerHTML = 
            renderMetric('Share', usShare, '%') + 
            renderMetric('Price', usPrice, '$') + 
            renderMetric('Avg Rank', usRank);

        document.getElementById('comp-them-metrics').innerHTML = 
            renderMetric('Share', compShare, '%') + 
            renderMetric('Price', compPrice, '$') + 
            renderMetric('Avg Rank', compRank);

        // Draw Comparison Chart (Side by Side Bar)
        const data = google.visualization.arrayToDataTable([
            ['Metric', 'Us', 'Them'],
            ['Share %', usShare, compShare],
            ['Price ($)', usPrice, compPrice],
            ['Rank', usRank, compRank]
        ]);

        const options = {
            colors: ['#4285F4', '#EA4335'],
            bars: 'horizontal',
            chartArea: {width: '70%'}
        };

        const chart = new google.visualization.BarChart(document.getElementById('chart_comparison'));
        chart.draw(data, options);
    }

</script>
</body>
</html>