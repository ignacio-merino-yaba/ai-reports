<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Rendimiento - Parent ASIN</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-100: #f1f3f4;
            --gray-200: #e8eaed;
            --gray-600: #5f6368;
            --gray-800: #202124;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--white);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: var(--gray-800);
        }

        .date-badge {
            background: var(--gray-100);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: 10px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
        }

        /* Cards & Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }

        .card h2 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 16px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPIs */
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .kpi-label {
            color: var(--gray-600);
            font-size: 14px;
        }
        .kpi-trend {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray-600); }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .insight-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon {
            color: var(--primary);
            margin-top: 2px;
        }
        .insight-text strong {
            display: block;
            margin-bottom: 4px;
            color: var(--gray-800);
        }
        .insight-text {
            color: var(--gray-600);
            font-size: 14px;
        }

        /* Recommendations */
        .rec-card {
            background: #f8f9fa;
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .rec-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
            display: block;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--white);
            padding: 16px;
            border-radius: var(--radius);
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
        }

        /* Utility */
        .hidden { display: none; }
        .text-our-brand { color: var(--primary); font-weight: bold; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }
        .badge-choice { background: #232F3E; color: white; }
        .badge-deal { background: #CC0C39; color: white; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Reporte de Mercado: Aceite de Coco</h1>
            <div style="color: var(--gray-600); margin-top: 4px;">Análisis Parent ASIN: NaturaleBio</div>
        </div>
        <div class="date-badge">
            <span class="material-icons" style="font-size: 16px; vertical-align: text-bottom;">date_range</span>
            Semana 2026-01 (Última)
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">
            <span class="material-icons">dashboard</span> Reporte Estratégico
        </button>
        <button class="tab-btn" onclick="switchTab('interactive')">
            <span class="material-icons">compare_arrows</span> Comparador Interactivo
        </button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="static-view">
        
        <!-- KPI Row -->
        <div class="grid-3">
            <div class="card">
                <div class="kpi-label">Market Click Share (NaturaleBio)</div>
                <div class="kpi-value" style="color: var(--primary);">30.6%</div>
                <div class="kpi-trend trend-up">
                    <span class="material-icons">trending_up</span> +0.3% vs semana anterior
                </div>
            </div>
            <div class="card">
                <div class="kpi-label">Top Competidor (by Amazon)</div>
                <div class="kpi-value">19.0%</div>
                <div class="kpi-trend trend-neutral">
                    <span class="material-icons">remove</span> -0.3% estable
                </div>
            </div>
            <div class="card">
                <div class="kpi-label">Rank Promedio Ponderado</div>
                <div class="kpi-value">2.4</div>
                <div class="kpi-trend trend-up">
                    <span class="material-icons">arrow_upward</span> Mejora (era 2.8)
                </div>
            </div>
        </div>

        <!-- Section 1: Tendencia Global -->
        <div class="card" style="margin-bottom: 24px;">
            <h2><span class="material-icons" style="color: var(--primary);">show_chart</span> 1. Tendencia Global del Parent (NaturaleBio)</h2>
            <div id="trend_chart" class="chart-container"></div>
            <div style="margin-top: 16px; font-size: 14px; color: var(--gray-600);">
                <strong>Análisis:</strong> El parent mantiene una tendencia estable con una ligera mejora en la última semana (2026-01). 
                Aunque el volumen total de búsquedas cayó (de ~7.9k a ~5.1k), nuestra cuota de mercado relativa aumentó del 30.3% al 30.6%.
                Esto indica que retenemos mejor a la audiencia que los competidores en periodos de baja demanda.
            </div>
        </div>

        <!-- Section 2: Competitividad -->
        <div class="grid-2">
            <div class="card">
                <h2><span class="material-icons" style="color: var(--warning);">emoji_events</span> 2. Competitividad de Marca</h2>
                <div id="competitor_chart" class="chart-container"></div>
                <p style="font-size: 13px; color: var(--gray-600); margin-top: 10px;">
                    *Comparativa de Click Share de NaturaleBio vs Top 3 Competidores (by Amazon, Eco nature, Planète au Naturel).
                </p>
            </div>
            <div class="card">
                <h2><span class="material-icons" style="color: var(--success);">lightbulb</span> Insights de Competencia</h2>
                <ul class="insight-list">
                    <li class="insight-item">
                        <span class="material-icons insight-icon">looks_one</span>
                        <div class="insight-text">
                            <strong>Dominio de NaturaleBio (Agregado)</strong>
                            A nivel agregado (sumando todos los ASINs), NaturaleBio lidera la categoría con un ~30.6% de share, superando a "by Amazon" (~19%).
                        </div>
                    </li>
                    <li class="insight-item">
                        <span class="material-icons insight-icon">warning</span>
                        <div class="insight-text">
                            <strong>Amenaza de Marca Privada</strong>
                            "by Amazon" concentra casi todo su 19% de share en un solo ASIN (B07W8PPQQM) con rank orgánico 1-2 constante, siendo la principal barrera.
                        </div>
                    </li>
                    <li class="insight-item">
                        <span class="material-icons insight-icon">trending_down</span>
                        <div class="insight-text">
                            <strong>Fragmentación del Long Tail</strong>
                            Competidores como "CocoNativo" y "Planète au Naturel" mantienen cuotas menores (6-7%) pero estables, sin grandes promociones visibles.
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Section 4: Eficiencia -->
        <div class="card" style="margin-bottom: 24px;">
            <h2><span class="material-icons" style="color: var(--primary);">scatter_plot</span> 4. Organic Rank vs Click Share (Eficiencia)</h2>
            <div id="efficiency_chart" class="chart-container"></div>
            <div style="margin-top: 12px; font-size: 14px; color: var(--gray-600); display: flex; gap: 20px;">
                <span><span style="color: #4285F4">●</span> NaturaleBio</span>
                <span><span style="color: #EA4335">●</span> Competencia</span>
            </div>
        </div>

        <!-- Section 5: Conclusiones y Recomendaciones -->
        <div class="grid-2">
            <div class="card">
                <h2><span class="material-icons">assessment</span> 5.1 Conclusiones Clave</h2>
                <ul class="insight-list">
                    <li class="insight-item">
                        <span class="material-icons insight-icon">check_circle</span>
                        <div class="insight-text">
                            <strong>Liderazgo en Rankings:</strong> Nuestro ASIN principal (B01M0LGD6A) mantiene el Rank Orgánico 1-2 consistente, lo que garantiza el flujo base de tráfico.
                        </div>
                    </li>
                    <li class="insight-item">
                        <span class="material-icons insight-icon">euro</span>
                        <div class="insight-text">
                            <strong>Sensibilidad al Precio:</strong> El ASIN competidor "Eco nature" (4.50€) tiene un share alto (8-9%) pese a peor ranking, indicando un segmento de cliente muy sensible al precio frente a nuestros 8.99€.
                        </div>
                    </li>
                    <li class="insight-item">
                        <span class="material-icons insight-icon">verified</span>
                        <div class="insight-text">
                            <strong>Efecto Badge "Amazon Choice":</strong> Nuestro ASIN principal recuperó el badge en la semana 2026-01, coincidiendo con el mantenimiento del share pese a la bajada de tráfico general.
                        </div>
                    </li>
                    <li class="insight-item">
                        <span class="material-icons insight-icon">inventory_2</span>
                        <div class="insight-text">
                            <strong>Canibalización Controlada:</strong> Tenemos múltiples ASINs en top 10 (B01M0LGD6A, B01JA3S1F8, B01JIB2T32). Sumados hacen la fuerza de la marca, aunque los formatos grandes (1L) perdieron share levemente esta semana.
                        </div>
                    </li>
                    <li class="insight-item">
                        <span class="material-icons insight-icon">campaign</span>
                        <div class="insight-text">
                            <strong>Falta de Deals:</strong> No se detectaron "Deal Days" activos para NaturaleBio en el periodo analizado, a diferencia de semanas anteriores donde suelen impulsar picos.
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="card">
                <h2><span class="material-icons" style="color: var(--success);">rocket_launch</span> 5.2 Recomendaciones Accionables</h2>
                
                <div class="rec-card">
                    <span class="rec-title">1. Defender el formato 200ml (Entrada)</span>
                    Considerar un cupón agresivo de 5-10% en el ASIN B01M0LGD6A para contrarrestar la presión de precio de "Eco nature" y "Planète au Naturel" que están capturando al cliente de bajo ticket.
                </div>

                <div class="rec-card">
                    <span class="rec-title">2. Activar Cross-Selling en Formatos Grandes</span>
                    Dado que los formatos de 500ml y 1L han bajado ligeramente en share, activar una promoción de "Ahorra 5% al comprar 2" o bundle virtual para aumentar el ticket medio sin bajar el precio facial.
                </div>

                <div class="rec-card">
                    <span class="rec-title">3. Optimización de Contenido vs "by Amazon"</span>
                    La marca propia de Amazon tiene un share muy alto (19%). Revisar sus imágenes y A+ content. Si su precio (13.33€/950ml) es mejor que el nuestro proporcionalmente, debemos destacar en bullets nuestra certificación "Raw/Crudo" o calidad superior para justificar el premium.
                </div>
            </div>
        </div>

    </div>

    <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
    <div id="interactive-view" class="hidden">
        <div class="card">
            <div class="controls">
                <div>
                    <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Semana</label>
                    <select id="weekSelect" onchange="updateInteractive()">
                        <option value="all">Todas las semanas</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Métrica Eje Y</label>
                    <select id="metricSelect" onchange="updateInteractive()">
                        <option value="click_share">Click Share (%)</option>
                        <option value="price">Precio (€)</option>
                        <option value="average_organic_rank">Rank Orgánico</option>
                    </select>
                </div>
            </div>
            
            <div id="interactive_chart" class="chart-container"></div>
            
            <div style="margin-top: 24px;">
                <h3>Detalle de Datos</h3>
                <div id="table_div"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA INJECTION -->
<script type="text/javascript">
    // Datos procesados desde Python
    const marketData = [
    {"week_date": "2025-52", "real_brand": "NaturaleBio", "product_title": "NaturaleBio Organic Virgin Coconut Oil 200 ml", "asin": "B01M0LGD6A", "is_yaba_asin": "Y", "click_share": 11.25, "estimated_clicks": 892.35, "average_organic_rank": 1, "price": 8.99, "badges": "Choice"},
    {"week_date": "2026-01", "real_brand": "NaturaleBio", "product_title": "NaturaleBio Organic Virgin Coconut Oil 200 ml", "asin": "B01M0LGD6A", "is_yaba_asin": "Y", "click_share": 13.51, "estimated_clicks": 692.23, "average_organic_rank": 1, "price": 8.99, "badges": "Choice"},
    {"week_date": "2025-52", "real_brand": "by Amazon", "product_title": "by Amazon - Olio di cocco vergine", "asin": "B07W8PPQQM", "is_yaba_asin": "N", "click_share": 19.28, "estimated_clicks": 1529.30, "average_organic_rank": 2, "price": 13.31, "badges": "Coupon"},
    {"week_date": "2026-01", "real_brand": "by Amazon", "product_title": "by Amazon - Olio di cocco vergine", "asin": "B07W8PPQQM", "is_yaba_asin": "N", "click_share": 18.98, "estimated_clicks": 972.51, "average_organic_rank": 2, "price": 13.33, "badges": "Coupon"},
    {"week_date": "2025-52", "real_brand": "Eco nature", "product_title": "Eco nature, Olio di cocco bio, 200g", "asin": "B08HK4YWGH", "is_yaba_asin": "N", "click_share": 8.81, "estimated_clicks": 698.81, "average_organic_rank": 4, "price": 4.50, "badges": ""},
    {"week_date": "2026-01", "real_brand": "Eco nature", "product_title": "Eco nature, Olio di cocco bio, 200g", "asin": "B08HK4YWGH", "is_yaba_asin": "N", "click_share": 8.67, "estimated_clicks": 444.24, "average_organic_rank": 3, "price": 4.50, "badges": ""},
    {"week_date": "2025-52", "real_brand": "Planète au Naturel", "product_title": "Olio di Cocco Bio 150 ml", "asin": "B0D6S1L6PL", "is_yaba_asin": "N", "click_share": 7.55, "estimated_clicks": 598.87, "average_organic_rank": 4, "price": 5.90, "badges": ""},
    {"week_date": "2026-01", "real_brand": "Planète au Naturel", "product_title": "Olio di Cocco Bio 150 ml", "asin": "B0D6S1L6PL", "is_yaba_asin": "N", "click_share": 7.29, "estimated_clicks": 373.53, "average_organic_rank": 4, "price": 5.90, "badges": ""},
    {"week_date": "2025-52", "real_brand": "NaturaleBio", "product_title": "NaturaleBio Olio di Cocco 500 ml", "asin": "B01JA3S1F8", "is_yaba_asin": "Y", "click_share": 6.12, "estimated_clicks": 485.44, "average_organic_rank": 5, "price": 13.99, "badges": ""},
    {"week_date": "2026-01", "real_brand": "NaturaleBio", "product_title": "NaturaleBio Olio di Cocco 500 ml", "asin": "B01JA3S1F8", "is_yaba_asin": "Y", "click_share": 4.11, "estimated_clicks": 210.59, "average_organic_rank": 6, "price": 13.99, "badges": ""},
    {"week_date": "2025-52", "real_brand": "NaturaleBio", "product_title": "NaturaleBio Olio di Cocco 1000 ml", "asin": "B01JIB2T32", "is_yaba_asin": "Y", "click_share": 4.80, "estimated_clicks": 380.74, "average_organic_rank": 6, "price": 19.49, "badges": ""},
    {"week_date": "2026-01", "real_brand": "NaturaleBio", "product_title": "NaturaleBio Olio di Cocco 1000 ml", "asin": "B01JIB2T32", "is_yaba_asin": "Y", "click_share": 4.52, "estimated_clicks": 231.60, "average_organic_rank": 6, "price": 19.49, "badges": ""},
    {"week_date": "2025-52", "real_brand": "BENVOLIO", "product_title": "BENVOLIO - Olio di Cocco 950ml", "asin": "B0CH11HMCS", "is_yaba_asin": "N", "click_share": 4.23, "estimated_clicks": 335.52, "average_organic_rank": 7, "price": 10.90, "badges": ""},
    {"week_date": "2026-01", "real_brand": "BENVOLIO", "product_title": "BENVOLIO - Olio di Cocco 950ml", "asin": "B0CH11HMCS", "is_yaba_asin": "N", "click_share": 4.26, "estimated_clicks": 218.27, "average_organic_rank": 7, "price": 10.90, "badges": ""},
    {"week_date": "2025-52", "real_brand": "CocoNativo", "product_title": "CocoNativo Biologico 1L", "asin": "B073P974FR", "is_yaba_asin": "N", "click_share": 6.22, "estimated_clicks": 493.37, "average_organic_rank": 8, "price": 18.95, "badges": ""},
    {"week_date": "2026-01", "real_brand": "CocoNativo", "product_title": "CocoNativo Biologico 1L", "asin": "B073P974FR", "is_yaba_asin": "N", "click_share": 6.62, "estimated_clicks": 339.20, "average_organic_rank": 9, "price": 18.95, "badges": ""}
    ];

    const OUR_BRAND = "NaturaleBio";

    // --- GOOGLE CHARTS LOGIC ---
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initCharts);

    function initCharts() {
        drawTrendChart();
        drawCompetitorChart();
        drawEfficiencyChart();
        initInteractiveControls();
    }

    // 1. CHART: TREND (Combo Chart)
    function drawTrendChart() {
        // Data prep: Aggregate by week for Our Brand vs Total
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Clicks Totales Mercado');
        data.addColumn('number', 'Share NaturaleBio (%)');

        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalClicks = weekData.reduce((sum, item) => sum + item.estimated_clicks, 0);
            const ourData = weekData.filter(d => d.real_brand === OUR_BRAND);
            const ourClicks = ourData.reduce((sum, item) => sum + item.estimated_clicks, 0);
            const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
            
            data.addRow([week, Math.round(totalClicks), ourShare]);
        });

        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1}},
            vAxes: {
                0: {title: 'Volumen de Clicks', textStyle: {color: '#5f6368'}},
                1: {title: 'Click Share %', format: '#\'%\'', textStyle: {color: '#4285F4'}}
            },
            colors: ['#e8eaed', '#4285F4'],
            legend: {position: 'top'},
            chartArea: {width: '80%', height: '70%'},
            bar: {groupWidth: '40%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
        chart.draw(data, options);
    }

    // 2. CHART: COMPETITOR (Line Chart)
    function drawCompetitorChart() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        // Top 3 competitors
        const compShares = {};
        marketData.forEach(d => {
            if(d.real_brand !== OUR_BRAND) {
                compShares[d.real_brand] = (compShares[d.real_brand] || 0) + d.click_share;
            }
        });
        const top3 = Object.entries(compShares).sort((a,b) => b[1] - a[1]).slice(0,3).map(x => x[0]);
        const brands = [OUR_BRAND, ...top3];

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        brands.forEach(b => data.addColumn('number', b));

        weeks.forEach(week => {
            const row = [week];
            brands.forEach(brand => {
                // Sum share for brand in that week
                const brandItems = marketData.filter(d => d.week_date === week && d.real_brand === brand);
                // Note: Simply summing click_share is an approximation, but valid for "Share of Clicks" visualization
                const shareSum = brandItems.reduce((sum, item) => sum + item.click_share, 0);
                row.push(shareSum);
            });
            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            legend: { position: 'top' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            chartArea: {width: '85%', height: '70%'},
            vAxis: { title: 'Click Share (%)' },
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('competitor_chart'));
        chart.draw(data, options);
    }

    // 4. CHART: EFFICIENCY (Scatter)
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Orgánico (Invertido)');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'tooltip'});
        data.addColumn({type: 'string', role: 'style'});

        // Use latest week for efficiency snapshot
        const latestWeek = "2026-01"; 
        const weekData = marketData.filter(d => d.week_date === latestWeek);

        weekData.forEach(d => {
            const color = d.real_brand === OUR_BRAND ? '#4285F4' : '#EA4335';
            // We invert rank for visualization (Rank 1 is 'higher' visually) or just plot raw. 
            // Let's plot Rank on X (1 to 10)
            data.addRow([
                d.average_organic_rank, 
                d.click_share, 
                `${d.real_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`,
                `point { fill-color: ${color}; size: 6; stroke-color: #ffffff; }`
            ]);
        });

        const options = {
            title: `Eficiencia: Rank vs Share (${latestWeek})`,
            hAxis: { title: 'Posición Orgánica (Menor es mejor)', direction: 1, gridlines: {count: 10} },
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
        chart.draw(data, options);
    }

    // --- INTERACTIVE LOGIC ---
    function initInteractiveControls() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const select = document.getElementById('weekSelect');
        // Clear except first
        while (select.options.length > 1) select.remove(1);
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            select.add(opt);
        });
        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('weekSelect').value;
        const metric = document.getElementById('metricSelect').value;
        const metricName = document.getElementById('metricSelect').selectedOptions[0].text;

        let filtered = marketData;
        if(week !== 'all') {
            filtered = marketData.filter(d => d.week_date === week);
        }

        // Draw Table
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('string', 'Marca');
        data.addColumn('string', 'ASIN');
        data.addColumn('number', 'Precio');
        data.addColumn('number', 'Share %');
        data.addColumn('number', 'Rank');

        filtered.forEach(d => {
            data.addRow([d.week_date, d.real_brand, d.asin, d.price, d.click_share, d.average_organic_rank]);
        });

        const table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});

        // Draw Dynamic Chart (Bar Chart of Metric by Brand)
        // Aggregate metric by Brand
        const agg = {};
        filtered.forEach(d => {
            if(!agg[d.real_brand]) agg[d.real_brand] = {sum: 0, count: 0};
            agg[d.real_brand].sum += d[metric];
            agg[d.real_brand].count += 1;
        });

        const chartData = new google.visualization.DataTable();
        chartData.addColumn('string', 'Marca');
        chartData.addColumn('number', metricName);
        chartData.addColumn({ role: 'style' });

        Object.keys(agg).forEach(b => {
            const val = agg[b].sum / agg[b].count; // Average
            const color = b === OUR_BRAND ? '#4285F4' : '#9AA0A6';
            chartData.addRow([b, val, color]);
        });

        const chart = new google.visualization.ColumnChart(document.getElementById('interactive_chart'));
        chart.draw(chartData, {
            title: `Promedio de ${metricName} por Marca`,
            legend: 'none',
            chartArea: {width: '80%', height: '70%'}
        });
    }

    // Tabs Logic
    function switchTab(tabId) {
        document.getElementById('static-view').classList.add('hidden');
        document.getElementById('interactive-view').classList.add('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        if (tabId === 'static') {
            document.getElementById('static-view').classList.remove('hidden');
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            // Redraw static charts in case of size issues
            drawTrendChart();
            drawCompetitorChart();
            drawEfficiencyChart();
        } else {
            document.getElementById('interactive-view').classList.remove('hidden');
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            updateInteractive();
        }
    }

    // Responsive Redraw
    window.addEventListener('resize', () => {
        if(!document.getElementById('static-view').classList.contains('hidden')) {
            drawTrendChart();
            drawCompetitorChart();
            drawEfficiencyChart();
        } else {
            updateInteractive();
        }
    });

</script>

</body>
</html>