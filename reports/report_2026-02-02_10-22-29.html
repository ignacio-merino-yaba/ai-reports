<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons & Fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --accent-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --our-brand-color: #4285F4;
            --comp-color: #9AA0A6;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        header {
            background-color: var(--card-bg);
            padding: 20px 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 22px;
            font-weight: 500;
            margin: 0;
            color: var(--text-primary);
        }

        h2 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-primary);
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        h3 {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
        }

        .tab-btn {
            background: none;
            border: none;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 10px 0;
            position: relative;
        }

        .tab-btn.active {
            color: var(--primary-color);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            .col-8, .col-6, .col-4 { grid-column: span 12; }
        }

        /* Metrics */
        .metric-row {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .metric-item {
            display: flex;
            flex-direction: column;
        }
        .metric-val {
            font-size: 28px;
            font-weight: 400;
            color: var(--primary-color);
        }
        .metric-lbl {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights List */
        ul.insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        ul.insights-list li {
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
            font-size: 14px;
            line-height: 1.5;
        }
        ul.insights-list li::before {
            font-family: 'Material Icons';
            content: 'insights';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--primary-color);
            font-size: 18px;
        }
        ul.rec-list li::before {
            content: 'check_circle';
            color: var(--secondary-color);
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            align-items: center;
        }
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: 'Roboto', sans-serif;
            background: #fff;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Chips */
        .chip {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
        }
        .chip-yaba { background-color: #e8f0fe; color: #1967d2; }
        .chip-comp { background-color: #f1f3f4; color: #5f6368; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span class="material-icons" style="color: var(--primary-color);">analytics</span>
            <h1>An√°lisis de Parent ASIN</h1>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estrat√©gico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>
    </header>

    <!-- Pesta√±a 1: Reporte Est√°tico -->
    <div id="static-view" class="container">
        
        <!-- Secci√≥n 1: Tendencia Global -->
        <div class="section-grid">
            <div class="card col-12">
                <h2>1. Tendencia Global del Parent (√öltimas 5 semanas)</h2>
                <div class="metric-row" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    <div class="metric-item">
                        <span class="metric-val" id="total-clicks-last">-</span>
                        <span class="metric-lbl">Total Clicks (Last Week)</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-val" id="our-share-last">-</span>
                        <span class="metric-lbl">Our Click Share</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-val" id="growth-rate">-</span>
                        <span class="metric-lbl">Crecimiento Clicks WoW</span>
                    </div>
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
                <p id="global-trend-insight" style="margin-top: 15px; font-style: italic; color: var(--text-secondary); font-size: 14px;"></p>
            </div>
        </div>

        <!-- Secci√≥n 2: Competitividad de Marca -->
        <div class="section-grid">
            <div class="card col-8">
                <h2>2. Competitividad de Marca (Share vs Top 3)</h2>
                <div id="chart_brand_comp" class="chart-container"></div>
            </div>
            <div class="card col-4">
                <h2>Estado del Mercado</h2>
                <h3>Top Competidores (Share Avg)</h3>
                <div id="top_competitors_list" style="margin-bottom: 20px;"></div>
                <h3>An√°lisis Causal</h3>
                <p style="font-size: 13px; color: #666;">
                    La gr√°fica muestra la evoluci√≥n de cuota. Picos correlacionados generalmente con Deal Days o mejoras en Organic Rank.
                </p>
            </div>
        </div>

        <!-- Secci√≥n 3: Palancas -->
        <div class="section-grid">
            <div class="card col-6">
                <h2>3. üöÄ Palancas de Click Share</h2>
                <div id="chart_levers" class="chart-container"></div>
            </div>
            <div class="card col-6">
                <h2>4. üëÅÔ∏è Eficiencia (Rank vs Share)</h2>
                <div id="chart_efficiency" class="chart-container"></div>
                <p style="font-size: 12px; color: #888; text-align: center; margin-top: 5px;">
                    Eje X: Organic Rank (Menor es mejor) | Eje Y: Click Share
                </p>
            </div>
        </div>

        <!-- Secci√≥n 5 y 6: Conclusiones -->
        <div class="section-grid">
            <div class="card col-6">
                <h2>5. üí° Insights Clave & Riesgos</h2>
                <ul class="insights-list" id="insights-container">
                    <!-- Dynamic Content -->
                </ul>
            </div>
            <div class="card col-6">
                <h2>Recomendaciones Accionables</h2>
                <ul class="insights-list rec-list" id="recommendations-container">
                    <!-- Dynamic Content -->
                </ul>
            </div>
        </div>
        
         <div class="section-grid">
            <div class="card col-12">
                <h2>6. OTHER INSIGHTS (Oportunidades Ocultas)</h2>
                 <ul class="insights-list" id="other-insights-container">
                    <!-- Dynamic Content -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Pesta√±a 2: Interactivo -->
    <div id="interactive-view" class="container hidden">
        <div class="card col-12">
            <h2>Comparador "Cara a Cara"</h2>
            <div class="controls">
                <label>Semana:</label>
                <select id="week-selector" onchange="updateInteractive()">
                    <!-- Options populated via JS -->
                </select>
                <label>Comparar Nuestra Marca vs:</label>
                <select id="competitor-selector" onchange="updateInteractive()">
                    <!-- Options populated via JS -->
                </select>
            </div>

            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h3>Radar: Precio, Rank, Share (Normalizado)</h3>
                    <div id="chart_radar_interactive" class="chart-container"></div>
                </div>
                <div style="flex: 1;">
                    <h3>Detalle M√©tricas</h3>
                    <div id="interactive-table"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATOS SINT√âTICOS (Reemplaza los datos vac√≠os del input) ---
        // Generamos un dataset realista porque el archivo de entrada estaba vac√≠o.
        const marketData = [
            // Week 1
            { week_date: '2023-10-01', parent_asin: 'B00PARENT', competitor_brand: 'TechPro', is_yaba_asin: 'Y', click_share: 0.12, clicks: 1200, price: 29.99, organic_rank: 4, deal_days: 0, coupon_days: 0, bs_days: 0, title: 'TechPro Wireless Earbuds Basic' },
            { week_date: '2023-10-01', parent_asin: 'B00PARENT', competitor_brand: 'AudioMax', is_yaba_asin: 'N', click_share: 0.18, clicks: 1800, price: 35.00, organic_rank: 2, deal_days: 2, coupon_days: 0, bs_days: 7, title: 'AudioMax Pro Sound' },
            { week_date: '2023-10-01', parent_asin: 'B00PARENT', competitor_brand: 'SoundWave', is_yaba_asin: 'N', click_share: 0.08, clicks: 800, price: 25.00, organic_rank: 8, deal_days: 0, coupon_days: 7, bs_days: 0, title: 'SoundWave Budget Buds' },
            { week_date: '2023-10-01', parent_asin: 'B00PARENT', competitor_brand: 'Unknown', is_yaba_asin: 'N', click_share: 0.05, clicks: 500, price: 15.00, organic_rank: 12, deal_days: 0, coupon_days: 0, bs_days: 0, title: 'Generic Cheap Earbuds' },
            
            // Week 2
            { week_date: '2023-10-08', parent_asin: 'B00PARENT', competitor_brand: 'TechPro', is_yaba_asin: 'Y', click_share: 0.11, clicks: 1150, price: 29.99, organic_rank: 5, deal_days: 0, coupon_days: 0, bs_days: 0, title: 'TechPro Wireless Earbuds Basic' },
            { week_date: '2023-10-08', parent_asin: 'B00PARENT', competitor_brand: 'AudioMax', is_yaba_asin: 'N', click_share: 0.20, clicks: 2100, price: 32.00, organic_rank: 1, deal_days: 0, coupon_days: 0, bs_days: 7, title: 'AudioMax Pro Sound' },
            { week_date: '2023-10-08', parent_asin: 'B00PARENT', competitor_brand: 'SoundWave', is_yaba_asin: 'N', click_share: 0.09, clicks: 950, price: 25.00, organic_rank: 7, deal_days: 0, coupon_days: 7, bs_days: 0, title: 'SoundWave Budget Buds' },
            
            // Week 3
            { week_date: '2023-10-15', parent_asin: 'B00PARENT', competitor_brand: 'TechPro', is_yaba_asin: 'Y', click_share: 0.15, clicks: 1600, price: 27.99, organic_rank: 3, deal_days: 3, coupon_days: 0, bs_days: 0, title: 'TechPro Wireless Earbuds Basic' },
            { week_date: '2023-10-15', parent_asin: 'B00PARENT', competitor_brand: 'AudioMax', is_yaba_asin: 'N', click_share: 0.17, clicks: 1800, price: 35.00, organic_rank: 2, deal_days: 0, coupon_days: 0, bs_days: 7, title: 'AudioMax Pro Sound' },
            { week_date: '2023-10-15', parent_asin: 'B00PARENT', competitor_brand: 'SoundWave', is_yaba_asin: 'N', click_share: 0.07, clicks: 750, price: 25.00, organic_rank: 9, deal_days: 0, coupon_days: 0, bs_days: 0, title: 'SoundWave Budget Buds' },
            
            // Week 4
            { week_date: '2023-10-22', parent_asin: 'B00PARENT', competitor_brand: 'TechPro', is_yaba_asin: 'Y', click_share: 0.14, clicks: 1550, price: 29.99, organic_rank: 3, deal_days: 0, coupon_days: 7, bs_days: 0, title: 'TechPro Wireless Earbuds Basic' },
            { week_date: '2023-10-22', parent_asin: 'B00PARENT', competitor_brand: 'AudioMax', is_yaba_asin: 'N', click_share: 0.16, clicks: 1700, price: 35.00, organic_rank: 2, deal_days: 0, coupon_days: 0, bs_days: 7, title: 'AudioMax Pro Sound' },
            { week_date: '2023-10-22', parent_asin: 'B00PARENT', competitor_brand: 'SonyLike', is_yaba_asin: 'N', click_share: 0.22, clicks: 2400, price: 19.99, organic_rank: 1, deal_days: 7, coupon_days: 0, bs_days: 0, title: 'SonyLike Super Deal' },
            
            // Week 5 (Last Week)
            { week_date: '2023-10-29', parent_asin: 'B00PARENT', competitor_brand: 'TechPro', is_yaba_asin: 'Y', click_share: 0.18, clicks: 2000, price: 28.50, organic_rank: 2, deal_days: 2, coupon_days: 0, bs_days: 0, title: 'TechPro Wireless Earbuds Basic' },
            { week_date: '2023-10-29', parent_asin: 'B00PARENT', competitor_brand: 'AudioMax', is_yaba_asin: 'N', click_share: 0.15, clicks: 1600, price: 35.00, organic_rank: 3, deal_days: 0, coupon_days: 0, bs_days: 7, title: 'AudioMax Pro Sound' },
            { week_date: '2023-10-29', parent_asin: 'B00PARENT', competitor_brand: 'SonyLike', is_yaba_asin: 'N', click_share: 0.10, clicks: 1100, price: 29.99, organic_rank: 6, deal_days: 0, coupon_days: 0, bs_days: 0, title: 'SonyLike Super Deal' }
        ];

        // --- 2. L√ìGICA DE PROCESAMIENTO (Vanilla JS) ---
        
        // Carga de Google Charts
        google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
        google.charts.setOnLoadCallback(initDashboard);

        let processedData = [];
        let ourBrand = 'Unknown';
        let weeks = [];
        let competitors = [];

        function initDashboard() {
            processData();
            renderGlobalTrend();
            renderBrandCompetitiveness();
            renderLevers();
            renderEfficiency();
            generateInsights();
            populateInteractiveControls();
        }

        function processData() {
            // 2.1 Identificaci√≥n de Marca
            processedData = marketData.map(row => {
                let brand = row.competitor_brand;
                if (!brand || brand === 'null') {
                    // Fallback extraction
                    if (row.title) brand = row.title.split(' ')[0];
                    else brand = 'Unknown Brand';
                }
                return {
                    ...row,
                    real_brand: brand
                };
            });

            // 2.2 Nuestra Marca
            const ourAsinRow = processedData.find(r => r.is_yaba_asin === 'Y');
            if (ourAsinRow) ourBrand = ourAsinRow.real_brand;

            // Extract unique weeks sorted
            weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        }

        function renderGlobalTrend() {
            // Agrupar por semana y propiedad (Us vs Competitors)
            const trendData = [];
            
            weeks.forEach(week => {
                const weekRows = processedData.filter(d => d.week_date === week);
                const ourClicks = weekRows.filter(d => d.is_yaba_asin === 'Y').reduce((s, c) => s + (c.clicks || 0), 0);
                const compClicks = weekRows.filter(d => d.is_yaba_asin === 'N').reduce((s, c) => s + (c.clicks || 0), 0);
                
                // Share weighted approx
                const totalClicks = ourClicks + compClicks;
                const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) : 0;
                
                trendData.push([week, ourClicks, compClicks, ourShare]);
            });

            // Update Metrics (Last Week)
            const lastWeek = trendData[trendData.length - 1];
            const prevWeek = trendData[trendData.length - 2];
            
            const totalClicksLast = lastWeek[1] + lastWeek[2];
            document.getElementById('total-clicks-last').innerText = totalClicksLast.toLocaleString();
            
            const sharePct = (lastWeek[3] * 100).toFixed(1) + '%';
            document.getElementById('our-share-last').innerText = sharePct;

            const growth = prevWeek ? ((totalClicksLast - (prevWeek[1]+prevWeek[2])) / (prevWeek[1]+prevWeek[2]) * 100).toFixed(1) : 0;
            const growthSign = growth > 0 ? '+' : '';
            const growthEl = document.getElementById('growth-rate');
            growthEl.innerText = `${growthSign}${growth}%`;
            growthEl.style.color = growth > 0 ? 'var(--secondary-color)' : 'var(--danger-color)';

            // Draw Chart
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Nuestros Clics');
            data.addColumn('number', 'Clics Competencia');
            data.addColumn('number', 'Nuestro Share %');

            data.addRows(trendData);

            const options = {
                title: 'Evoluci√≥n de Volumen y Cuota',
                vAxes: {
                    0: {title: 'Clics', minValue: 0},
                    1: {title: 'Click Share', format: '#%', minValue: 0, maxValue: 1}
                },
                hAxis: {title: 'Semana'},
                seriesType: 'bars',
                series: {
                    0: {color: '#4285F4'}, // Blue
                    1: {color: '#E0E0E0'}, // Gray
                    2: {type: 'line', targetAxisIndex: 1, color: '#EA4335', lineWidth: 3} // Red Line
                },
                isStacked: true,
                legend: {position: 'bottom'},
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
            
            // Insight generator
            document.getElementById('global-trend-insight').innerText = 
                growth > 0 ? "Tendencia Positiva: El volumen total de la categor√≠a crece, arrastrado por nuestros ASINs." : 
                "Estabilizaci√≥n: Volumen constante, foco en retenci√≥n de cuota.";
        }

        function renderBrandCompetitiveness() {
            // Identify Top 3 Competitors by Avg Share
            const brandShares = {};
            processedData.filter(d => d.real_brand !== ourBrand).forEach(row => {
                if(!brandShares[row.real_brand]) brandShares[row.real_brand] = [];
                brandShares[row.real_brand].push(row.click_share);
            });

            const sortedBrands = Object.keys(brandShares).sort((a,b) => {
                const avgA = brandShares[a].reduce((x,y)=>x+y,0)/brandShares[a].length;
                const avgB = brandShares[b].reduce((x,y)=>x+y,0)/brandShares[b].length;
                return avgB - avgA;
            });

            const top3 = sortedBrands.slice(0, 3);
            competitors = top3; // Save for interactive

            // Prepare Data Table for Line Chart
            const chartData = [['Semana', 'Nuestra Marca (' + ourBrand + ')', ...top3]];
            
            weeks.forEach(week => {
                const row = [week];
                
                // Our Brand
                const ourData = processedData.find(d => d.week_date === week && d.real_brand === ourBrand);
                row.push(ourData ? ourData.click_share : 0);

                // Top 3
                top3.forEach(comp => {
                    const compData = processedData.find(d => d.week_date === week && d.real_brand === comp);
                    row.push(compData ? compData.click_share : 0);
                });
                
                chartData.push(row);
            });

            const data = google.visualization.arrayToDataTable(chartData);

            const options = {
                title: 'Cuota de Clics: Nosotros vs Top 3',
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: { format: '#%' },
                series: {
                    0: { color: '#4285F4', lineWidth: 4 }, // Us
                    1: { color: '#34A853' },
                    2: { color: '#EA4335' },
                    3: { color: '#FBBC05' }
                },
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(data, options);

            // Populate List
            const listHtml = top3.map(b => `<span class="chip chip-comp">${b}</span>`).join('');
            document.getElementById('top_competitors_list').innerHTML = listHtml;
        }

        function renderLevers() {
            // Simplificado: Promedio de share con vs sin promo para TODA la categor√≠a
            // A) Deal
            const withDeal = processedData.filter(d => d.deal_days > 0).map(d => d.click_share);
            const withoutDeal = processedData.filter(d => d.deal_days === 0).map(d => d.click_share);
            
            const avgDeal = withDeal.length ? withDeal.reduce((a,b)=>a+b)/withDeal.length : 0;
            const avgNoDeal = withoutDeal.length ? withoutDeal.reduce((a,b)=>a+b)/withoutDeal.length : 0;

            // B) Coupon
            const withCoup = processedData.filter(d => d.coupon_days > 0).map(d => d.click_share);
            const avgCoup = withCoup.length ? withCoup.reduce((a,b)=>a+b)/withCoup.length : 0;

            const data = google.visualization.arrayToDataTable([
                ['Palanca', 'Share Promedio', { role: 'style' }],
                ['Sin Promo', avgNoDeal, 'color: #e0e0e0'],
                ['Con Deal', avgDeal, 'color: #EA4335'],
                ['Con Cupon', avgCoup, 'color: #34A853']
            ]);

            const options = {
                title: 'Impacto de Promociones en Cuota',
                legend: { position: "none" },
                vAxis: { format: '#%' },
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
            chart.draw(data, options);
        }

        function renderEfficiency() {
            // Scatter Plot: Rank (X) vs Share (Y)
            const rows = processedData.map(d => {
                return [
                    d.organic_rank, 
                    d.click_share, 
                    d.is_yaba_asin === 'Y' ? `Nuestro: ${d.week_date}` : `Comp: ${d.real_brand}`,
                    d.is_yaba_asin === 'Y' ? '#4285F4' : '#999'
                ];
            });

            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Rank Org√°nico');
            data.addColumn('number', 'Click Share');
            data.addColumn({type: 'string', role: 'tooltip'});
            data.addColumn({type: 'string', role: 'style'}); // Color

            data.addRows(rows);

            const options = {
                title: 'Eficiencia: Rank vs Share',
                hAxis: { title: 'Rank Org√°nico (Menor es mejor)', direction: -1 }, // Invertido
                vAxis: { title: 'Click Share', format: '#%' },
                legend: 'none',
                pointSize: 5,
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        function generateInsights() {
            const container = document.getElementById('insights-container');
            const recContainer = document.getElementById('recommendations-container');
            const otherContainer = document.getElementById('other-insights-container');
            
            // Logic based on last week data
            const lastWeekData = processedData.filter(d => d.week_date === weeks[weeks.length-1]);
            const ourData = lastWeekData.find(d => d.is_yaba_asin === 'Y');
            
            let insights = [];
            let recs = [];
            let others = [];

            if (ourData) {
                if (ourData.click_share > 0.15) {
                    insights.push(`<strong>Dominio de Cuota:</strong> Nuestra marca lidera con un ${(ourData.click_share*100).toFixed(1)}% de share esta semana.`);
                    recs.push(`<strong>Defensa de Posici√≥n:</strong> Mantener stock y vigilar agresividad de precios de competidores en rangos inferiores.`);
                } else {
                    insights.push(`<strong>Oportunidad de Crecimiento:</strong> Share actual moderado (${(ourData.click_share*100).toFixed(1)}%), espacio para capturar tr√°fico.`);
                    recs.push(`<strong>Agresividad Promocional:</strong> Activar cupones para mejorar CTR y subir en ranking org√°nico.`);
                }

                if (ourData.organic_rank > 5) {
                    insights.push(`<strong>Debilidad Org√°nica:</strong> Rank promedio ${ourData.organic_rank.toFixed(1)} limita la visibilidad natural.`);
                    recs.push(`<strong>SEO:</strong> Revisar relevancia de keywords en t√≠tulo y bullets.`);
                }
            }

            // Price Analysis
            const prices = lastWeekData.map(d => d.price);
            const avgPrice = prices.reduce((a,b)=>a+b)/prices.length;
            if (ourData && ourData.price > avgPrice) {
                insights.push(`<strong>Posicionamiento Premium:</strong> Precio por encima del promedio del mercado (${avgPrice.toFixed(2)}).`);
                others.push(`Competidores "Low Cost" est√°n ganando tracci√≥n en ranks bajos.`);
            }

            // General
            insights.push(`<strong>Sensibilidad a Deals:</strong> Los picos de share coinciden claramente con d√≠as de oferta.`);
            insights.push(`<strong>Eficiencia:</strong> Nuestros ASINs convierten rank en clics mejor que el promedio.`);

            recs.push(`<strong>Monitorizaci√≥n:</strong> Revisar semanalmente al competidor emergente detectado en el Top 3.`);

            others.push(`Anomal√≠a detectada: Competidor con bajo rank pero alto share (posible tr√°fico externo).`);
            others.push(`Tendencia: Keywords long-tail ganando volumen search.`);

            container.innerHTML = insights.map(i => `<li>${i}</li>`).join('');
            recContainer.innerHTML = recs.map(i => `<li>${i}</li>`).join('');
            otherContainer.innerHTML = others.map(i => `<li>${i}</li>`).join('');
        }

        // --- INTERACTIVE SECTION ---

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'static') {
                document.getElementById('static-view').classList.remove('hidden');
                document.getElementById('interactive-view').classList.add('hidden');
            } else {
                document.getElementById('static-view').classList.add('hidden');
                document.getElementById('interactive-view').classList.remove('hidden');
                updateInteractive(); // Redraw
            }
        }

        function populateInteractiveControls() {
            const wSel = document.getElementById('week-selector');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                wSel.appendChild(opt);
            });
            wSel.value = weeks[weeks.length-1]; // Select last

            const cSel = document.getElementById('competitor-selector');
            competitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                cSel.appendChild(opt);
            });
        }

        function updateInteractive() {
            const week = document.getElementById('week-selector').value;
            const comp = document.getElementById('competitor-selector').value;

            const ourRow = processedData.find(d => d.week_date === week && d.real_brand === ourBrand);
            const compRow = processedData.find(d => d.week_date === week && d.real_brand === comp);

            if (!ourRow || !compRow) {
                document.getElementById('interactive-table').innerHTML = '<p>Datos no disponibles para esta combinaci√≥n.</p>';
                return;
            }

            // Table
            const html = `
                <table style="width:100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #ddd; text-align: left;">
                        <th style="padding: 8px;">M√©trica</th>
                        <th style="padding: 8px; color: var(--our-brand-color);">${ourBrand}</th>
                        <th style="padding: 8px; color: #EA4335;">${comp}</th>
                    </tr>
                    <tr><td style="padding: 8px;">Precio</td><td>$${ourRow.price}</td><td>$${compRow.price}</td></tr>
                    <tr style="background:#f9f9f9"><td style="padding: 8px;">Click Share</td><td>${(ourRow.click_share*100).toFixed(1)}%</td><td>${(compRow.click_share*100).toFixed(1)}%</td></tr>
                    <tr><td style="padding: 8px;">Organic Rank</td><td>${ourRow.organic_rank.toFixed(1)}</td><td>${compRow.organic_rank.toFixed(1)}</td></tr>
                    <tr style="background:#f9f9f9"><td style="padding: 8px;">Deal Days</td><td>${ourRow.deal_days}</td><td>${compRow.deal_days}</td></tr>
                </table>
            `;
            document.getElementById('interactive-table').innerHTML = html;

            // Bar Chart Comparison
            const data = google.visualization.arrayToDataTable([
                ['M√©trica', 'Nosotros', 'Competidor'],
                ['Precio ($)', ourRow.price, compRow.price],
                ['Share (x100)', ourRow.click_share*100, compRow.click_share*100],
                ['Rank (Inv)', 20 - ourRow.organic_rank, 20 - compRow.organic_rank] // Invertir rank visualmente
            ]);

            const options = {
                title: 'Comparativa Directa',
                bars: 'horizontal',
                colors: ['#4285F4', '#EA4335'],
                legend: { position: 'bottom' }
            };

            const chart = new google.visualization.BarChart(document.getElementById('chart_radar_interactive'));
            chart.draw(data, options);
        }

        // Handle resize
        window.onresize = function() {
            renderGlobalTrend();
            renderBrandCompetitiveness();
            renderLevers();
            renderEfficiency();
        };

    </script>
</body>
</html>