<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado: Matcha Premium</title>
    
    <!-- Google Charts & Icons -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4;       /* Google Blue */
            --secondary: #34A853;     /* Google Green */
            --danger: #EA4335;        /* Google Red */
            --warning: #FBBC05;       /* Google Yellow */
            --text-dark: #202124;
            --text-gray: #5f6368;
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --border: #dadce0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: var(--text-dark);
        }

        .header p {
            color: var(--text-gray);
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards & Grid */
        .grid {
            display: grid;
            gap: 24px;
        }

        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-1-2 { grid-template-columns: 1fr 2fr; }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            border: 1px solid transparent;
            transition: box-shadow 0.2s;
        }
        
        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.12);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics */
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .metric-label {
            font-size: 12px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trend-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .trend-up { background: #e6f4ea; color: var(--secondary); }
        .trend-down { background: #fce8e6; color: var(--danger); }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Recommendations */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon {
            color: var(--primary);
        }
        .insight-text h4 { margin: 0 0 4px 0; font-size: 14px; font-weight: 600; }
        .insight-text p { margin: 0; font-size: 13px; color: var(--text-gray); line-height: 1.5; }

        /* Interactive Tab */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comparison-table th, .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .comparison-table th {
            color: var(--text-gray);
            font-weight: 500;
            font-size: 12px;
        }

        /* Hidden Utility */
        .hidden { display: none; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-1-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h1>Análisis de Parent ASIN: Matcha Premium</h1>
                    <p>Marca Analizada: <span id="header-brand" style="font-weight: 600; color: var(--primary);">Detectando...</span> | Última Semana: <span id="header-date">--</span></p>
                </div>
                <div class="trend-badge" style="background: #e8f0fe; color: var(--primary); font-size: 14px; padding: 8px 16px;">
                    Estado: <span id="global-status">Calculando...</span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">1. Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">2. Comparador Interactivo</button>
        </div>

        <!-- SECTION 1: STATIC REPORT -->
        <div id="tab-static">
            
            <!-- KPI Cards -->
            <div class="grid grid-3" style="margin-bottom: 24px;">
                <div class="card">
                    <span class="metric-label">Share de Clics (Esta Semana)</span>
                    <div style="display: flex; align-items: baseline; margin-top: 8px;">
                        <span class="metric-value" id="kpi-share">--%</span>
                        <span id="kpi-share-trend" class="trend-badge">--</span>
                    </div>
                </div>
                <div class="card">
                    <span class="metric-label">Tráfico Estimado (Clicks)</span>
                    <div style="display: flex; align-items: baseline; margin-top: 8px;">
                        <span class="metric-value" id="kpi-clicks">--</span>
                    </div>
                </div>
                <div class="card">
                    <span class="metric-label">Posición Orgánica Media</span>
                    <div style="display: flex; align-items: baseline; margin-top: 8px;">
                        <span class="metric-value" id="kpi-rank">--</span>
                        <span style="font-size: 12px; color: var(--text-gray); margin-left: 8px;">(Top 1 es mejor)</span>
                    </div>
                </div>
            </div>

            <!-- 1. Global Trend -->
            <div class="grid grid-1-2" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-title"><span class="material-icons">insights</span> Resumen de Tendencia</div>
                    <div id="trend-insights" class="insight-text">
                        <!-- JS injected text -->
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Tendencia Global: Mercado vs. Nosotros</div>
                    <div id="chart-trend" class="chart-container"></div>
                </div>
            </div>

            <!-- 2. Competitiveness -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-title"><span class="material-icons">pie_chart</span> Competitividad de Marca (Share of Click %)</div>
                <p style="font-size: 13px; color: var(--text-gray); margin-bottom: 16px;">
                    Comparativa de "Nuestra Marca" frente al Top 3 Competidores y el resto del mercado.
                </p>
                <div id="chart-competitors" class="chart-container"></div>
            </div>

            <!-- 3 & 4. Levers & Efficiency -->
            <div class="grid grid-2" style="margin-bottom: 24px;">
                <!-- Efficiency Matrix -->
                <div class="card">
                    <div class="card-title"><span class="material-icons">bubble_chart</span> Eficiencia: Rank vs. Share</div>
                    <p style="font-size: 12px; color: var(--text-gray);">ASINs sobre la línea azul rinden mejor de lo esperado para su posición.</p>
                    <div id="chart-scatter" class="chart-container"></div>
                </div>

                <!-- Levers Analysis -->
                <div class="card">
                    <div class="card-title"><span class="material-icons">tune</span> Palancas de Crecimiento</div>
                    <div id="levers-analysis">
                        <!-- Dynamic Table -->
                    </div>
                </div>
            </div>

            <!-- 5. Recommendations -->
            <div class="card" style="background: linear-gradient(to right, #ffffff, #f8f9fa); border-left: 4px solid var(--primary);">
                <div class="card-title"><span class="material-icons">lightbulb</span> Conclusiones y Acciones Recomendadas</div>
                <div id="recommendations-container">
                    <!-- Dynamic Recommendations -->
                </div>
            </div>
            
            <!-- Other Insights -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-title"><span class="material-icons">saved_search</span> Other Insights (Detectados Automáticamente)</div>
                <div id="other-insights-container" style="font-size: 14px; color: var(--text-dark);">
                    
                </div>
            </div>

        </div>

        <!-- SECTION 2: INTERACTIVE -->
        <div id="tab-interactive" class="hidden">
            <div class="controls">
                <div>
                    <label style="display:block; font-size:12px; color:var(--text-gray); margin-bottom:4px;">Semana</label>
                    <select id="select-week" onchange="updateComparison()"></select>
                </div>
                <div>
                    <label style="display:block; font-size:12px; color:var(--text-gray); margin-bottom:4px;">Competidor a Comparar</label>
                    <select id="select-competitor" onchange="updateComparison()"></select>
                </div>
            </div>

            <div class="grid grid-2">
                <!-- Our Card -->
                <div class="card" style="border-top: 4px solid var(--primary);">
                    <div class="card-title" id="comp-our-title">Nuestra Marca</div>
                    <table class="comparison-table">
                        <tr><td>Precio Promedio</td><td id="our-price" style="font-weight:bold;">-</td></tr>
                        <tr><td>Click Share</td><td id="our-share" style="font-weight:bold;">-</td></tr>
                        <tr><td>Rank Orgánico</td><td id="our-rank" style="font-weight:bold;">-</td></tr>
                        <tr><td>Días con Oferta</td><td id="our-deals">-</td></tr>
                        <tr><td>Badges (Choice/BS)</td><td id="our-badges">-</td></tr>
                    </table>
                </div>

                <!-- Competitor Card -->
                <div class="card" style="border-top: 4px solid var(--danger);">
                    <div class="card-title" id="comp-rival-title">Competidor</div>
                    <table class="comparison-table">
                        <tr><td>Precio Promedio</td><td id="rival-price" style="font-weight:bold;">-</td></tr>
                        <tr><td>Click Share</td><td id="rival-share" style="font-weight:bold;">-</td></tr>
                        <tr><td>Rank Orgánico</td><td id="rival-rank" style="font-weight:bold;">-</td></tr>
                        <tr><td>Días con Oferta</td><td id="rival-deals">-</td></tr>
                        <tr><td>Badges (Choice/BS)</td><td id="rival-badges">-</td></tr>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top: 24px;">
                <div class="card-title">Diagnóstico Directo</div>
                <p id="comparison-diagnosis" style="font-size: 15px; line-height: 1.6;">
                    Seleccione una semana y un competidor para ver el diagnóstico.
                </p>
            </div>
        </div>
    </div>

    <!-- DATA INJECTION -->
    <script>
        // Data injected from Python processing
        const marketData = [{"week_date": "2025-51", "real_brand": "Jean", "is_yaba_asin": "N", "product_title": "Jean & Len Handcreme I Love You So Matcha, f\u00fcr nor...", "asin": "B0F5BVFRC1", "click_share": 1.92, "average_organic_rank": 12.0, "price": 3.095714286, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1168.4179199999999}, {"week_date": "2025-51", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "asin": "B07MD4LB49", "click_share": 3.49, "average_organic_rank": 8.0, "price": 9.005714286, "weekly_number_of_days_with_deal": 5.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 2123.84299}, {"week_date": "2025-51", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ5DCYJ", "click_share": 11.18, "average_organic_rank": 2.0, "price": 14.084285714, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 6803.5999}, {"week_date": "2025-51", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "asin": "B0CNRX8G5S", "click_share": 16.66, "average_organic_rank": 2.0, "price": 24.03, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 10138.45938}, {"week_date": "2025-51", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B079VQ52MK", "click_share": 3.69, "average_organic_rank": 5.0, "price": 23.075714286, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 2245.5528999999998}, {"week_date": "2025-51", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ69YCQ", "click_share": 3.85, "average_organic_rank": 5.0, "price": 9.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 2342.92112}, {"week_date": "2025-51", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8", "click_share": 8.85, "average_organic_rank": 5.0, "price": 15.635714286, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 5385.67604}, {"week_date": "2025-51", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8", "click_share": 8.85, "average_organic_rank": 5.0, "price": 15.635714286, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 5385.67604}, {"week_date": "2025-51", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "asin": "B0G1T7N675", "click_share": 2.56, "average_organic_rank": 12.0, "price": 8.898571429, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1557.8904599999998}, {"week_date": "2025-51", "real_brand": "Special Leaves", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC", "click_share": 3.48, "average_organic_rank": 14.0, "price": 10.44, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "estimated_clicks": 2117.75736}, {"week_date": "2025-51", "real_brand": "Matcha", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC", "click_share": 3.48, "average_organic_rank": 14.0, "price": 10.44, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "estimated_clicks": 2117.75736}, {"week_date": "2025-51", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "asin": "B07SZFD3P9", "click_share": 2.95, "average_organic_rank": 22.0, "price": 26.748571429, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1795.22533}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ5DCYJ", "click_share": 11.66, "average_organic_rank": 2.0, "price": 15.058571429, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 5562.759719999999}, {"week_date": "2025-52", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "asin": "B0CNRX8G5S", "click_share": 18.77, "average_organic_rank": 2.0, "price": 24.648571429, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 8954.80277}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ69YCQ", "click_share": 3.75, "average_organic_rank": 4.0, "price": 10.538571429, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1789.0522199999999}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B079VQ52MK", "click_share": 3.49, "average_organic_rank": 5.0, "price": 24.855714286, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1665.01126}, {"week_date": "2025-52", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8", "click_share": 8.42, "average_organic_rank": 6.0, "price": 16.037142857, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 4017.0185699999997}, {"week_date": "2025-52", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8", "click_share": 8.42, "average_organic_rank": 6.0, "price": 16.037142857, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 4017.0185699999997}, {"week_date": "2025-52", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "asin": "B07MD4LB49", "click_share": 4.19, "average_organic_rank": 7.0, "price": 9.895714286, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1998.9676799999998}, {"week_date": "2025-52", "real_brand": "Bio", "is_yaba_asin": "N", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "asin": "B08XVX8V1T", "click_share": 2.44, "average_organic_rank": 10.0, "price": 12.367142857, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1164.0766399999998}, {"week_date": "2025-52", "real_brand": "bioKontor", "is_yaba_asin": "N", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "asin": "B08XVX8V1T", "click_share": 2.44, "average_organic_rank": 10.0, "price": 12.367142857, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1164.0766399999998}, {"week_date": "2025-52", "real_brand": "Matcha", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC", "click_share": 3.4, "average_organic_rank": 13.0, "price": 10.71, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "estimated_clicks": 1622.074}, {"week_date": "2025-52", "real_brand": "Special Leaves", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC", "click_share": 3.4, "average_organic_rank": 13.0, "price": 10.71, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "estimated_clicks": 1622.074}, {"week_date": "2025-52", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "asin": "B07K1WBH4K", "click_share": 1.47, "average_organic_rank": 20.0, "price": 9.895714286, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 701.30846}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "asin": "B07SZFD3P9", "click_share": 2.93, "average_organic_rank": 23.0, "price": 30.704285714, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1397.84612}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "asin": "B07SZFD3P9", "click_share": 2.68, "average_organic_rank": 2.06, "price": 30.27, "weekly_number_of_days_with_deal": 8.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 723.89748}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ5DCYJ", "click_share": 12.9, "average_organic_rank": 2.0, "price": 14.6075, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 3484.4319}, {"week_date": "2026-01", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "asin": "B0CNRX8G5S", "click_share": 19.34, "average_organic_rank": 2.0, "price": 23.91, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 5223.94674}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B079VQ52MK", "click_share": 3.66, "average_organic_rank": 5.0, "price": 24.5275, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 988.60626}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ69YCQ", "click_share": 3.35, "average_organic_rank": 5.0, "price": 10.2225, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 904.87185}, {"week_date": "2026-01", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8", "click_share": 7.38, "average_organic_rank": 6.0, "price": 15.5575, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1993.41918}, {"week_date": "2026-01", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8", "click_share": 7.38, "average_organic_rank": 6.0, "price": 15.5575, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 1993.41918}, {"week_date": "2026-01", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "asin": "B07MD4LB49", "click_share": 3.15, "average_organic_rank": 9.0, "price": 10.43, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 850.84965}, {"week_date": "2026-01", "real_brand": "Bio", "is_yaba_asin": "N", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "asin": "B08XVX8V1T", "click_share": 2.39, "average_organic_rank": 10.0, "price": 11.9975, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 645.56529}, {"week_date": "2026-01", "real_brand": "bioKontor", "is_yaba_asin": "N", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "asin": "B08XVX8V1T", "click_share": 2.39, "average_organic_rank": 10.0, "price": 11.9975, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 645.56529}, {"week_date": "2026-01", "real_brand": "Matcha", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC", "click_share": 3.0, "average_organic_rank": 16.0, "price": 10.39, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "estimated_clicks": 810.333}, {"week_date": "2026-01", "real_brand": "Special Leaves", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC", "click_share": 3.0, "average_organic_rank": 16.0, "price": 10.39, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "estimated_clicks": 810.333}, {"week_date": "2026-01", "real_brand": "UNREAL\u00ae", "is_yaba_asin": "N", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "asin": "B0F9B1LWQQ", "click_share": 1.57, "average_organic_rank": 19.0, "price": 31.2725, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "estimated_clicks": 424.07427}];

        // LOGIC & PROCESSING
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawDashboard);

        function getOurBrandName() {
            const ourRow = marketData.find(d => d.is_yaba_asin === 'Y');
            return ourRow ? ourRow.real_brand : "Marca Propia";
        }

        function getWeeks() {
            return [...new Set(marketData.map(d => d.week_date))].sort();
        }

        function getTopCompetitors() {
            // Calculate total share per brand
            const brandShares = {};
            const ourBrand = getOurBrandName();
            const totalMarketClicks = marketData.reduce((sum, d) => sum + d.estimated_clicks, 0);

            marketData.forEach(d => {
                if (d.real_brand !== ourBrand) {
                    if (!brandShares[d.real_brand]) brandShares[d.real_brand] = 0;
                    brandShares[d.real_brand] += d.estimated_clicks;
                }
            });

            return Object.entries(brandShares)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => entry[0]);
        }

        function aggregateTrend() {
            const weeks = getWeeks();
            const result = [];
            
            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                const ourClicks = weekData.filter(d => d.is_yaba_asin === 'Y')
                                          .reduce((sum, d) => sum + d.estimated_clicks, 0);
                const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
                result.push([week, totalClicks, ourShare]);
            });
            return result;
        }

        function aggregateCompetitiveness() {
            const weeks = getWeeks();
            const ourBrand = getOurBrandName();
            const topComps = getTopCompetitors();
            const header = ['Week', ourBrand, ...topComps, 'Otros'];
            
            const result = [header];

            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                
                const row = [week];
                // Our Share
                const ourClicks = weekData.filter(d => d.real_brand === ourBrand).reduce((s, d) => s + d.estimated_clicks, 0);
                row.push((ourClicks / totalClicks) * 100);

                // Comps Share
                let topCompClicks = 0;
                topComps.forEach(comp => {
                    const cClicks = weekData.filter(d => d.real_brand === comp).reduce((s, d) => s + d.estimated_clicks, 0);
                    row.push((cClicks / totalClicks) * 100);
                    topCompClicks += cClicks;
                });

                // Others Share
                const othersClicks = totalClicks - ourClicks - topCompClicks;
                row.push((othersClicks / totalClicks) * 100);

                result.push(row);
            });
            return result;
        }

        function drawDashboard() {
            // Set Headers
            const ourBrand = getOurBrandName();
            const weeks = getWeeks();
            const currentWeek = weeks[weeks.length - 1];
            
            document.getElementById('header-brand').innerText = ourBrand;
            document.getElementById('header-date').innerText = currentWeek;

            // 1. KPI Calculation
            const currData = marketData.filter(d => d.week_date === currentWeek);
            const totalClicks = currData.reduce((s, d) => s + d.estimated_clicks, 0);
            const ourClicks = currData.filter(d => d.is_yaba_asin === 'Y').reduce((s, d) => s + d.estimated_clicks, 0);
            const ourShare = (ourClicks / totalClicks) * 100;
            
            // Weighted Rank
            const ourItems = currData.filter(d => d.is_yaba_asin === 'Y');
            const weightedRank = ourItems.reduce((s, d) => s + (d.average_organic_rank * d.estimated_clicks), 0) / ourClicks;

            document.getElementById('kpi-share').innerText = ourShare.toFixed(1) + '%';
            document.getElementById('kpi-clicks').innerText = Math.round(ourClicks).toLocaleString();
            document.getElementById('kpi-rank').innerText = weightedRank.toFixed(1);

            // Calculate Trend Status
            if (weeks.length > 1) {
                const prevWeek = weeks[weeks.length - 2];
                const prevData = marketData.filter(d => d.week_date === prevWeek);
                const prevTotal = prevData.reduce((s, d) => s + d.estimated_clicks, 0);
                const prevOur = prevData.filter(d => d.is_yaba_asin === 'Y').reduce((s, d) => s + d.estimated_clicks, 0);
                const prevShare = (prevOur / prevTotal) * 100;

                const diff = ourShare - prevShare;
                const statusEl = document.getElementById('global-status');
                const trendEl = document.getElementById('kpi-share-trend');
                
                if (diff >= 0) {
                    statusEl.innerText = "Crecimiento Semanal";
                    statusEl.style.color = "var(--secondary)";
                    statusEl.parentElement.style.background = "#e6f4ea";
                    trendEl.innerText = "+" + diff.toFixed(1) + "%";
                    trendEl.classList.add("trend-up");
                } else {
                    statusEl.innerText = "Pérdida de Cuota";
                    statusEl.style.color = "var(--danger)";
                    statusEl.parentElement.style.background = "#fce8e6";
                    trendEl.innerText = diff.toFixed(1) + "%";
                    trendEl.classList.add("trend-down");
                }
            }

            // 2. Trend Chart (Combo)
            const trendRaw = aggregateTrend();
            const dataTrend = new google.visualization.DataTable();
            dataTrend.addColumn('string', 'Semana');
            dataTrend.addColumn('number', 'Volumen Mercado (Clicks)');
            dataTrend.addColumn('number', 'Nuestra Cuota (%)');
            dataTrend.addRows(trendRaw);

            const optionsTrend = {
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
                colors: ['#dadce0'],
                vAxes: {
                    0: {title: 'Clicks Totales', textStyle: {color: '#9aa0a6'}},
                    1: {title: 'Share %', format: '#\'%\'', textStyle: {color: '#4285F4'}}
                },
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'},
                animation: { startup: true, duration: 1000, easing: 'out' }
            };
            new google.visualization.ComboChart(document.getElementById('chart-trend')).draw(dataTrend, optionsTrend);

            // Insight Text for Trend
            const trendTextEl = document.getElementById('trend-insights');
            const lastVol = trendRaw[trendRaw.length-1][1];
            const prevVol = trendRaw.length > 1 ? trendRaw[trendRaw.length-2][1] : lastVol;
            const volDiff = ((lastVol - prevVol)/prevVol)*100;
            
            trendTextEl.innerHTML = `
                <h4>Análisis de Volumen</h4>
                <p>El interés global en la categoría ${volDiff > 0 ? 'creció' : 'decreció'} un <strong>${Math.abs(volDiff).toFixed(1)}%</strong> esta semana.
                Nuestra marca acompañó esta tendencia con una cuota del <strong>${ourShare.toFixed(1)}%</strong>.</p>
            `;

            // 3. Competitiveness Chart (Line)
            const compRaw = aggregateCompetitiveness();
            const dataComp = google.visualization.arrayToDataTable(compRaw);
            const optionsComp = {
                curveType: 'function',
                lineWidth: 2,
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
                chartArea: {width: '85%', height: '70%'},
                legend: {position: 'bottom'},
                vAxis: {format: '#\'%\''}
            };
            new google.visualization.LineChart(document.getElementById('chart-competitors')).draw(dataComp, optionsComp);

            // 4. Efficiency Scatter (Rank vs Share)
            const scatterData = new google.visualization.DataTable();
            scatterData.addColumn('number', 'Rank Orgánico (Invertido)');
            scatterData.addColumn('number', 'Click Share (%)');
            scatterData.addColumn({type: 'string', role: 'tooltip'});
            scatterData.addColumn({type: 'string', role: 'style'}); // Color

            currData.forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? 'point {fill-color: #4285F4; size: 6}' : 'point {fill-color: #9AA0A6; size: 3}';
                const tooltip = `${d.real_brand}\nASIN: ${d.asin}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
                // X axis needs to be inverted visually, so we map rank 1 to max X, rank 50 to min X. 
                // Google charts doesn't support easy axis inversion for X in scatter, so we treat X as is but title it "Rank (Lower is Better)"
                // Or we plot negative rank. Let's plot actual rank and invert hAxis.
                scatterData.addRow([d.average_organic_rank, d.click_share, tooltip, color]);
            });

            const optionsScatter = {
                hAxis: { title: 'Rank Orgánico (Mejor ← Peor)', direction: -1 }, // Reverse axis so 1 is on right or left? Typically 1 is best. Let's put 1 on left (standard). 
                // Actually prompt asks for efficiency. Best is Top Left (Rank 1, High Share).
                // If direction is -1: Max Value (High Rank/Bad) -> Min Value (Low Rank/Good). 
                // Let's stick to standard: 1 on Left.
                hAxis: { title: 'Posición Orgánica (1 es mejor)', viewWindow: {min: 0} },
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                chartArea: {width: '85%', height: '70%'}
            };
            new google.visualization.ScatterChart(document.getElementById('chart-scatter')).draw(scatterData, optionsScatter);

            // 5. Generate Levers Table
            generateLeversAnalysis(currData);

            // 6. Generate Recommendations
            generateRecommendations(currData, weeks);

            // 7. Other Insights
            generateOtherInsights(currData);

            // Init Interactive Tab
            initInteractiveControls(weeks, getTopCompetitors());
        }

        function generateLeversAnalysis(data) {
            // Compare Our Avg Price vs Comp Avg Price
            const ourData = data.filter(d => d.is_yaba_asin === 'Y');
            const compData = data.filter(d => d.is_yaba_asin === 'N');

            const avgPriceOur = ourData.reduce((s,d)=>s+d.price,0)/ourData.length || 0;
            const avgPriceComp = compData.reduce((s,d)=>s+d.price,0)/compData.length || 0;
            
            // Check Deals impact
            const ourDeals = ourData.some(d => d.weekly_number_of_days_with_deal > 0);
            const compDeals = compData.some(d => d.weekly_number_of_days_with_deal > 0);

            let html = `
                <table style="width:100%; font-size:13px; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #eee;">
                        <th style="text-align:left; padding:8px;">Factor</th>
                        <th style="text-align:left; padding:8px;">Nosotros</th>
                        <th style="text-align:left; padding:8px;">Competencia</th>
                        <th style="text-align:left; padding:8px;">Impacto</th>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding:8px;">Precio Medio</td>
                        <td style="padding:8px; font-weight:bold; color:${avgPriceOur > avgPriceComp ? '#EA4335' : '#34A853'}">${avgPriceOur.toFixed(2)}€</td>
                        <td style="padding:8px;">${avgPriceComp.toFixed(2)}€</td>
                        <td style="padding:8px;">${avgPriceOur > avgPriceComp * 1.1 ? 'Riesgo (Alto)' : 'Neutro'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding:8px;">Actividad Promocional</td>
                        <td style="padding:8px;">${ourDeals ? 'ACTIVA' : 'Inactiva'}</td>
                        <td style="padding:8px;">${compDeals ? 'ACTIVA' : 'Inactiva'}</td>
                        <td style="padding:8px;">${!ourDeals && compDeals ? 'Crítico (Perdemos Visibilidad)' : 'Estable'}</td>
                    </tr>
                </table>
            `;
            document.getElementById('levers-analysis').innerHTML = html;
        }

        function generateRecommendations(currData, weeks) {
            const ourShare = parseFloat(document.getElementById('kpi-share').innerText);
            const statusText = document.getElementById('global-status').innerText;
            const topCompetitor = getTopCompetitors()[0];
            
            let recs = [];

            // 1. Trend Based
            if (statusText.includes("Pérdida")) {
                recs.push({
                    icon: 'trending_down', 
                    title: 'Frenar la pérdida de cuota', 
                    text: `La marca ha perdido tracción frente a ${topCompetitor}. Se recomienda activar cupón de defensa del 5-10% en los ASINs principales.`
                });
            } else {
                recs.push({
                    icon: 'trending_up', 
                    title: 'Consolidar Crecimiento', 
                    text: 'El momentum es positivo. Aprovecha para testear un ligero incremento de precio (+2%) monitoreando la conversión.'
                });
            }

            // 2. Visibility Based
            const ourBadRankASINs = currData.filter(d => d.is_yaba_asin === 'Y' && d.average_organic_rank > 10);
            if (ourBadRankASINs.length > 0) {
                recs.push({
                    icon: 'visibility',
                    title: 'Mejorar SEO en ASINs secundarios',
                    text: `${ourBadRankASINs.length} de nuestros variantes están fuera del Top 10. Revisar keywords del título y backend search terms.`
                });
            }

            // 3. Price Gap
            const ourData = currData.filter(d => d.is_yaba_asin === 'Y');
            const compData = currData.filter(d => d.real_brand === topCompetitor);
            if (ourData.length && compData.length) {
                const pOur = ourData.reduce((s,v)=>s+v.price,0)/ourData.length;
                const pComp = compData.reduce((s,v)=>s+v.price,0)/compData.length;
                
                if (pOur > pComp * 1.2) {
                    recs.push({
                        icon: 'sell',
                        title: 'Ajuste de Competitividad de Precio',
                        text: `Somos un 20%+ más caros que ${topCompetitor}. Evaluar justificación de valor (listing, imágenes) o reducir precio temporalmente.`
                    });
                }
            }

            let html = '';
            recs.forEach(r => {
                html += `
                    <div class="insight-item">
                        <div class="insight-icon"><span class="material-icons">${r.icon}</span></div>
                        <div class="insight-text">
                            <h4>${r.title}</h4>
                            <p>${r.text}</p>
                        </div>
                    </div>
                `;
            });
            document.getElementById('recommendations-container').innerHTML = html;
        }

        function generateOtherInsights(currData) {
            // Detect "Hidden Gem" Competitors (Low Price, High Rank)
            const hiddenGems = currData.filter(d => d.is_yaba_asin === 'N' && d.average_organic_rank < 5 && d.click_share > 5);
            let text = "";
            if (hiddenGems.length > 0) {
                const gem = hiddenGems[0];
                text += `<p><strong>Amenaza Emergente:</strong> La marca <em>${gem.real_brand}</em> tiene un posicionamiento orgánico fuerte (Rank ${gem.average_organic_rank}) con una cuota del ${gem.click_share}%. Vigilar sus movimientos de precio.</p>`;
            } else {
                text += "<p>No se detectan competidores emergentes anomalos en el Top 5 esta semana.</p>";
            }
            document.getElementById('other-insights-container').innerHTML = text;
        }

        /* --- INTERACTIVE TAB LOGIC --- */

        function switchTab(tabId) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            document.getElementById('tab-' + tabId).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function initInteractiveControls(weeks, competitors) {
            const weekSel = document.getElementById('select-week');
            const compSel = document.getElementById('select-competitor');

            weekSel.innerHTML = weeks.map(w => `<option value="${w}">${w}</option>`).join('');
            // Set last week as default
            weekSel.value = weeks[weeks.length-1];

            compSel.innerHTML = competitors.map(c => `<option value="${c}">${c}</option>`).join('');
            
            updateComparison();
        }

        function updateComparison() {
            const week = document.getElementById('select-week').value;
            const compName = document.getElementById('select-competitor').value;
            const ourName = getOurBrandName();

            const weekData = marketData.filter(d => d.week_date === week);
            
            // Helper to aggregate brand data for the week
            const getBrandStats = (brand) => {
                const items = weekData.filter(d => d.real_brand === brand);
                if (items.length === 0) return null;

                const totalClicks = items.reduce((s, d) => s + d.estimated_clicks, 0);
                // Weighted avgs
                const price = items.reduce((s, d) => s + (d.price * d.estimated_clicks), 0) / totalClicks;
                const rank = items.reduce((s, d) => s + (d.average_organic_rank * d.estimated_clicks), 0) / totalClicks;
                const deals = Math.max(...items.map(d => d.weekly_number_of_days_with_deal));
                
                // Calc share in context of total market that week
                const totalMarket = weekData.reduce((s,d) => s + d.estimated_clicks, 0);
                const share = (totalClicks / totalMarket) * 100;

                const badges = items.some(d => d.weekly_number_of_days_with_amazon_choice_badge > 0) ? "Amazon Choice" : "-";

                return { price, share, rank, deals, badges };
            };

            const ourStats = getBrandStats(ourName);
            const compStats = getBrandStats(compName);

            if (ourStats) {
                document.getElementById('comp-our-title').innerText = ourName;
                document.getElementById('our-price').innerText = ourStats.price.toFixed(2) + '€';
                document.getElementById('our-share').innerText = ourStats.share.toFixed(1) + '%';
                document.getElementById('our-rank').innerText = ourStats.rank.toFixed(1);
                document.getElementById('our-deals').innerText = ourStats.deals > 0 ? ourStats.deals + ' días' : 'No';
                document.getElementById('our-badges').innerText = ourStats.badges;
            }

            if (compStats) {
                document.getElementById('comp-rival-title').innerText = compName;
                document.getElementById('rival-price').innerText = compStats.price.toFixed(2) + '€';
                document.getElementById('rival-share').innerText = compStats.share.toFixed(1) + '%';
                document.getElementById('rival-rank').innerText = compStats.rank.toFixed(1);
                document.getElementById('rival-deals').innerText = compStats.deals > 0 ? compStats.deals + ' días' : 'No';
                document.getElementById('rival-badges').innerText = compStats.badges;
            }

            // Diagnosis
            if (ourStats && compStats) {
                const priceDiff = ((ourStats.price - compStats.price) / compStats.price) * 100;
                const shareDiff = ourStats.share - compStats.share;
                
                let diag = `En la semana ${week}, `;
                if (shareDiff > 0) {
                    diag += `<strong>superamos a ${compName}</strong> en cuota de mercado (+${shareDiff.toFixed(1)} puntos). `;
                    diag += priceDiff > 0 ? `Y lo hacemos vendiendo un <strong>${priceDiff.toFixed(0)}% más caro</strong>, lo cual demuestra fortaleza de marca.` : `Esto se apoya en un precio un ${Math.abs(priceDiff).toFixed(0)}% más bajo.`;
                } else {
                    diag += `<strong>estamos por debajo de ${compName}</strong> (-${Math.abs(shareDiff).toFixed(1)} puntos). `;
                    diag += priceDiff > 0 ? `Nuestro precio es un ${priceDiff.toFixed(0)}% superior, lo que podría estar frenando la conversión.` : `A pesar de ser más baratos, no logramos superarles. Revisar Rank Orgánico y Creatividades.`;
                }
                document.getElementById('comparison-diagnosis').innerHTML = diag;
            }
        }

    </script>
</body>
</html>