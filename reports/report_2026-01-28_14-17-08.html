<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence Report</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue for US */
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-500: #6c757d;
            --gray-800: #343a40;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: var(--gray-800);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: white;
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #202124; }
        .subtitle { color: var(--gray-500); font-size: 0.9rem; margin-top: 4px; }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: white;
            border-radius: 20px;
            font-weight: 600;
            color: var(--gray-500);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }
        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        
        /* Cards */
        .card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            height: 100%;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #202124;
        }

        /* Metrics */
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .metric-label { color: var(--gray-500); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-up { color: var(--success); font-size: 0.9rem; font-weight: 600; }
        .trend-down { color: var(--danger); font-size: 0.9rem; font-weight: 600; }

        /* Insights Section */
        .insights-list { list-style: none; padding: 0; }
        .insights-list li {
            position: relative;
            padding-left: 24px;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        .insights-list li::before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
        }
        .rec-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            background: #e8f0fe;
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
        }

        /* Comparator Styles */
        .comparator-controls {
            background: white;
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            font-family: 'Inter', sans-serif;
        }
        .vs-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--gray-100);
        }
        .vs-val { font-weight: 600; font-size: 1.1rem; }
        .vs-label { color: var(--gray-500); font-size: 0.9rem; }

        /* Charts Containers */
        .chart-box {
            width: 100%;
            min-height: 300px;
        }

        /* Utilities */
        .hidden { display: none; }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .badge-our { background: var(--primary); color: white; }
        .badge-comp { background: var(--gray-200); color: var(--gray-800); }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Parent ASIN Analysis</h1>
            <div class="subtitle" id="report-period">Loading data...</div>
        </div>
        <div>
            <span class="badge badge-our" id="brand-badge">Detecting Brand...</span>
        </div>
    </header>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchTab('dashboard')">1. Executive Dashboard</button>
        <button class="nav-btn" onclick="switchTab('comparator')">2. Interactive Comparator</button>
    </div>

    <!-- TAB 1: DASHBOARD -->
    <div id="tab-dashboard">
        
        <!-- KPI Row -->
        <div class="grid-3">
            <div class="card">
                <div class="metric-label">Total Parent Clicks (Last Week)</div>
                <div class="metric-value" id="kpi-clicks">-</div>
                <div id="kpi-clicks-trend">-</div>
            </div>
            <div class="card">
                <div class="metric-label">Our Click Share</div>
                <div class="metric-value" id="kpi-share">-</div>
                <div id="kpi-share-trend">-</div>
            </div>
            <div class="card">
                <div class="metric-label">Avg. Market Price</div>
                <div class="metric-value" id="kpi-price">-</div>
                <div id="kpi-price-trend">vs Our Avg: <span id="kpi-our-price">-</span></div>
            </div>
        </div>

        <!-- Section 1: Global Trend -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Global Parent Trend (Clicks & Share)
            </div>
            <div id="chart_global_trend" class="chart-box"></div>
            <p class="subtitle" style="padding: 0 10px;">
                <small>Bars = Total Market Volume (Est. Clicks). Lines = Click Share % (Us vs Competitors).</small>
            </p>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Brand Competitiveness (Share of Voice)
            </div>
            <div id="chart_brand_share" class="chart-box"></div>
        </div>

        <!-- Section 4 (Moved up for layout): Efficiency -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">gps_fixed</span>
                    4. Efficiency: Organic Rank vs Click Share
                </div>
                <div id="chart_efficiency" class="chart-box"></div>
                <p class="subtitle"><small>Top Left = High Share, Good Rank (Dominance). Bottom Right = Poor Rank, Low Share.</small></p>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">tune</span>
                    3. Drivers & Palancas (Impact Analysis)
                </div>
                <div id="drivers_table_div" style="height: 300px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Key Conclusions & Recommendations
            </div>
            <div class="grid-2">
                <div>
                    <h3 style="font-size: 1rem; color: var(--gray-800);">Market Insights</h3>
                    <ul class="insights-list" id="insights-list">
                        <!-- JS Generated -->
                    </ul>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h3 style="font-size: 1rem; color: var(--primary);">Actionable Recommendations</h3>
                    <ul class="insights-list" id="recommendations-list">
                        <!-- JS Generated -->
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <!-- TAB 2: COMPARATOR -->
    <div id="tab-comparator" class="hidden">
        <div class="comparator-controls">
            <label>Select Week: <select id="comp-week-select" onchange="updateComparator()"></select></label>
            <label>Select Competitor: <select id="comp-brand-select" onchange="updateComparator()"></select></label>
        </div>

        <div class="grid-2">
            <!-- Our Card -->
            <div class="card" style="border-top: 4px solid var(--primary);">
                <h2 style="color: var(--primary);" id="comp-our-name">Us</h2>
                <div class="vs-card">
                    <span class="vs-label">Click Share</span>
                    <span class="vs-val" id="comp-our-share">-</span>
                </div>
                <div class="vs-card">
                    <span class="vs-label">Avg Price</span>
                    <span class="vs-val" id="comp-our-price">-</span>
                </div>
                <div class="vs-card">
                    <span class="vs-label">Avg Org Rank</span>
                    <span class="vs-val" id="comp-our-rank">-</span>
                </div>
                <div class="vs-card">
                    <span class="vs-label">Active Deals (Days)</span>
                    <span class="vs-val" id="comp-our-deals">-</span>
                </div>
            </div>

            <!-- Competitor Card -->
            <div class="card" style="border-top: 4px solid var(--danger);">
                <h2 style="color: var(--danger);" id="comp-them-name">Competitor</h2>
                <div class="vs-card">
                    <span class="vs-label">Click Share</span>
                    <span class="vs-val" id="comp-them-share">-</span>
                </div>
                <div class="vs-card">
                    <span class="vs-label">Avg Price</span>
                    <span class="vs-val" id="comp-them-price">-</span>
                </div>
                <div class="vs-card">
                    <span class="vs-label">Avg Org Rank</span>
                    <span class="vs-val" id="comp-them-rank">-</span>
                </div>
                <div class="vs-card">
                    <span class="vs-label">Active Deals (Days)</span>
                    <span class="vs-val" id="comp-them-deals">-</span>
                </div>
            </div>
        </div>
        
        <div class="card">
             <div class="card-title">Price vs Share Comparison (History)</div>
             <div id="chart_comp_history" class="chart-box"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    /**
     * DATA INJECTION
     * In a real scenario, this is replaced by the Python processing output.
     */
    const marketData = [
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B08YRXQ2JH",
    "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...",
    "is_yaba_asin": "N",
    "final_brand": "Double",
    "click_share": 3.4,
    "impression_share": 3.43,
    "price": 6.98,
    "average_organic_rank": 13,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 2054.17392,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B06XTYYYJ8",
    "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...",
    "is_yaba_asin": "N",
    "final_brand": "Heapwell Superfoods",
    "click_share": 6.46,
    "impression_share": 4.7,
    "price": 8.704285714,
    "average_organic_rank": 6,
    "weekly_number_of_days_with_deal": 6,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 3902.930448,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "is_yaba_asin": "Y",
    "final_brand": "NaturaleBio",
    "click_share": 4.59,
    "impression_share": 3.26,
    "price": 20.99,
    "average_organic_rank": 5,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 2773.134792,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "is_yaba_asin": "Y",
    "final_brand": "NaturaleBio",
    "click_share": 13.11,
    "impression_share": 3.29,
    "price": 12.49,
    "average_organic_rank": 2,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 7,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 7920.653168,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B09DQ1PWGX",
    "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...",
    "is_yaba_asin": "N",
    "final_brand": "Perfect Ted",
    "click_share": 9.27,
    "impression_share": 6.06,
    "price": 9.49,
    "average_organic_rank": 8,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 5600.644776,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B0F21VZMJQ",
    "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...",
    "is_yaba_asin": "N",
    "final_brand": "Perfect Ted",
    "click_share": 8.65,
    "impression_share": 3.53,
    "price": 16.99,
    "average_organic_rank": 3,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 5226.06012,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B0D9M91WZD",
    "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...",
    "is_yaba_asin": "N",
    "final_brand": "Perfect Ted",
    "click_share": 3.45,
    "impression_share": 4.83,
    "price": 9.49,
    "average_organic_rank": 10,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 2084.38236,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B00HNDSOCI",
    "product_title": "PureChimp Ceremonial Grade Matcha Powder 50g. 100%...",
    "is_yaba_asin": "Y",
    "final_brand": "PureChimp",
    "click_share": 2.34,
    "impression_share": 3.39,
    "price": 14.95,
    "average_organic_rank": 12,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 7,
    "estimated_clicks": 1413.754992,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B08YK2RPBZ",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "is_yaba_asin": "N",
    "final_brand": "SuperSelf",
    "click_share": 7.98,
    "impression_share": 3.43,
    "price": 9.9,
    "average_organic_rank": 5,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 1,
    "weekly_number_of_days_with_coupon": 7,
    "estimated_clicks": 4821.267024,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2025-52",
    "keywords": "matcha",
    "asin": "B082DKRSB4",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "is_yaba_asin": "N",
    "final_brand": "SuperSelf",
    "click_share": 2.95,
    "impression_share": 4.13,
    "price": 19.18,
    "average_organic_rank": 8,
    "weekly_number_of_days_with_deal": 1,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 7,
    "estimated_clicks": 1782.29796,
    "weekly_search_volume": 60416.88,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B08YRXQ2JH",
    "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...",
    "is_yaba_asin": "N",
    "final_brand": "Double",
    "click_share": 3.32,
    "impression_share": 3.16,
    "price": 6.98,
    "average_organic_rank": 13,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 1357.588172,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B06XTYYYJ8",
    "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...",
    "is_yaba_asin": "N",
    "final_brand": "Heapwell Superfoods",
    "click_share": 5.74,
    "impression_share": 5.52,
    "price": 9.99,
    "average_organic_rank": 6,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 2347.155454,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B0C71LZNV6",
    "product_title": "Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...",
    "is_yaba_asin": "N",
    "final_brand": "Matcha",
    "click_share": 2.56,
    "impression_share": 4.22,
    "price": 24.95,
    "average_organic_rank": 12,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 1046.814976,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "is_yaba_asin": "Y",
    "final_brand": "NaturaleBio",
    "click_share": 3.39,
    "impression_share": 3.28,
    "price": 20.99,
    "average_organic_rank": 7,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 1386.212019,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "is_yaba_asin": "Y",
    "final_brand": "NaturaleBio",
    "click_share": 13.79,
    "impression_share": 3.33,
    "price": 12.49,
    "average_organic_rank": 1,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 4,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 5638.90076759,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B09DQ1PWGX",
    "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...",
    "is_yaba_asin": "N",
    "final_brand": "Perfect Ted",
    "click_share": 4.64,
    "impression_share": 3.45,
    "price": 2.1225,
    "average_organic_rank": 34,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 1897.352144,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B0F21VZMJQ",
    "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...",
    "is_yaba_asin": "N",
    "final_brand": "Perfect Ted",
    "click_share": 10.49,
    "impression_share": 3.3,
    "price": 16.99,
    "average_organic_rank": 3,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 1,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 4289.487929,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B0D9M91WZD",
    "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...",
    "is_yaba_asin": "N",
    "final_brand": "Perfect Ted",
    "click_share": 2.79,
    "impression_share": 3.5,
    "price": 11,
    "average_organic_rank": 9,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "estimated_clicks": 1140.864759,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B082DKRSB4",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "is_yaba_asin": "N",
    "final_brand": "SuperSelf",
    "click_share": 3.96,
    "impression_share": 4.48,
    "price": 14.86,
    "average_organic_rank": 8,
    "weekly_number_of_days_with_deal": 4,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 4,
    "estimated_clicks": 1619.291916,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  },
  {
    "parent_asin": "Matcha Premium",
    "week_date": "2026-01",
    "keywords": "matcha",
    "asin": "B08YK2RPBZ",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "is_yaba_asin": "N",
    "final_brand": "SuperSelf",
    "click_share": 9.83,
    "impression_share": 3.56,
    "price": 9.9,
    "average_organic_rank": 4,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 4,
    "estimated_clicks": 4019.605943,
    "weekly_search_volume": 40891.21,
    "grams": 0,
    "organic_or_not": 0,
    "container": 0
  }
];

    const OUR_BRAND = "NaturaleBio";

    /**
     * INITIALIZATION & HELPERS
     */
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        if (!marketData || marketData.length === 0) {
            alert("No data available to display.");
            return;
        }

        document.getElementById('brand-badge').textContent = `Our Brand: ${OUR_BRAND}`;

        // Get unique weeks sorted
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const lastWeek = weeks[weeks.length - 1];
        document.getElementById('report-period').textContent = `Reporting Period: ${weeks[0]} to ${lastWeek}`;

        // Get Competitors
        const competitors = [...new Set(marketData.filter(d => d.final_brand !== OUR_BRAND).map(d => d.final_brand))];

        // Populate Selectors for Tab 2
        const weekSelect = document.getElementById('comp-week-select');
        weeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            if(w === lastWeek) opt.selected = true;
            weekSelect.appendChild(opt);
        });

        const brandSelect = document.getElementById('comp-brand-select');
        competitors.forEach(b => {
            let opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            brandSelect.appendChild(opt);
        });

        // DRAW ALL CHARTS
        drawTrendChart(weeks);
        drawBrandShareChart(weeks);
        drawEfficiencyChart(lastWeek);
        renderDriversTable(lastWeek);
        renderInsights(lastWeek, weeks.length > 1 ? weeks[weeks.length-2] : null);
        updateKPIs(lastWeek, weeks.length > 1 ? weeks[weeks.length-2] : null);
        
        // Init Tab 2
        updateComparator();
    }

    function switchTab(tabName) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('[onclick="switchTab(\''+tabName+'\')"]').forEach(b => b.classList.add('active'));
        
        document.getElementById('tab-dashboard').classList.add('hidden');
        document.getElementById('tab-comparator').classList.add('hidden');
        
        document.getElementById('tab-' + tabName).classList.remove('hidden');
    }

    /* -----------------------------------------------------
       SECTION 1: GLOBAL TREND (COMBO)
       ----------------------------------------------------- */
    function drawTrendChart(weeks) {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Total Market Clicks');
        data.addColumn('number', 'Our Click Share %');
        data.addColumn('number', 'Competitors Share %');

        const rows = weeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            
            // Total Estimated Clicks in Market for this parent
            const totalClicks = weekData.reduce((sum, d) => sum + (d.estimated_clicks || 0), 0);
            
            // Weighted Share for Us
            const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
            const ourShare = ourData.reduce((sum, d) => sum + d.click_share, 0); // Share is additive across ASINs

            const compData = weekData.filter(d => d.is_yaba_asin === 'N');
            const compShare = compData.reduce((sum, d) => sum + d.click_share, 0);

            return [week, Math.round(totalClicks), ourShare, compShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: {
                1: {type: 'line', targetAxisIndex: 1, color: '#4285F4'},
                2: {type: 'line', targetAxisIndex: 1, color: '#EA4335'}
            },
            vAxes: {
                0: {title: 'Est. Clicks (Volume)'},
                1: {title: 'Click Share %'}
            },
            legend: { position: 'bottom' },
            colors: ['#e0e0e0'],
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    /* -----------------------------------------------------
       SECTION 2: BRAND COMPETITIVENESS (LINE)
       ----------------------------------------------------- */
    function drawBrandShareChart(weeks) {
        // Find Top 3 Competitors by avg share
        const brandShares = {};
        marketData.forEach(d => {
            if (d.final_brand !== OUR_BRAND) {
                if (!brandShares[d.final_brand]) brandShares[d.final_brand] = 0;
                brandShares[d.final_brand] += d.click_share;
            }
        });
        const top3 = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', OUR_BRAND);
        top3.forEach(b => data.addColumn('number', b));
        data.addColumn('number', 'Others');

        const rows = weeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const getShare = (brand) => weekData.filter(d => d.final_brand === brand).reduce((s,x) => s + x.click_share, 0);
            
            const row = [week, getShare(OUR_BRAND)];
            let othersShare = 0;
            
            // Calc Top 3
            top3.forEach(b => row.push(getShare(b)));
            
            // Calc Others
            const trackedBrands = [OUR_BRAND, ...top3];
            weekData.forEach(d => {
                if (!trackedBrands.includes(d.final_brand)) othersShare += d.click_share;
            });
            row.push(othersShare);
            
            return row;
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'],
            chartArea: { width: '90%', height: '70%' },
            vAxis: { title: 'Click Share %' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    /* -----------------------------------------------------
       SECTION 3: EFFICIENCY (SCATTER)
       ----------------------------------------------------- */
    function drawEfficiencyChart(week) {
        const weekData = marketData.filter(d => d.week_date === week);
        
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank (Inv)'); // X-axis
        data.addColumn('number', 'Click Share'); // Y-axis
        data.addColumn({type: 'string', role: 'tooltip'});
        data.addColumn({type: 'string', role: 'style'}); // Color

        const rows = weekData.map(d => {
            const color = d.is_yaba_asin === 'Y' ? 'point { fill-color: #4285F4; size: 10; }' : 'point { fill-color: #bdbdbd; }';
            // Invert rank for visualization (Rank 1 is "high" on X axis logic usually, but here standard chart: 1 is left. 
            // Let's keep Rank on X (1 to 50). Best is Left.
            return [d.average_organic_rank, d.click_share, `${d.final_brand}: Rank ${d.average_organic_rank}, Share ${d.click_share}%`, color];
        });

        data.addRows(rows);

        const options = {
            hAxis: { title: 'Avg Organic Rank (Lower is Better)', direction: 1 }, // 1 -> 50
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: { width: '85%', height: '80%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    /* -----------------------------------------------------
       SECTION 4: DRIVERS (TABLE)
       ----------------------------------------------------- */
    function renderDriversTable(week) {
        const weekData = marketData.filter(d => d.week_date === week)
            .sort((a,b) => b.click_share - a.click_share) // Top share first
            .slice(0, 10); // Top 10 ASINs

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Brand');
        data.addColumn('number', 'Price');
        data.addColumn('number', 'Share %');
        data.addColumn('string', 'Badges'); // Choice, Deals, Coupon

        const rows = weekData.map(d => {
            let badges = [];
            if(d.weekly_number_of_days_with_amazon_choice_badge > 0) badges.push("Choice");
            if(d.weekly_number_of_days_with_deal > 0) badges.push("Deal");
            if(d.weekly_number_of_days_with_coupon > 0) badges.push("Cpn");
            
            return [
                d.final_brand,
                d.price || 0,
                d.click_share,
                badges.join(" | ")
            ];
        });

        data.addRows(rows);
        
        const table = new google.visualization.Table(document.getElementById('drivers_table_div'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
    }

    /* -----------------------------------------------------
       INSIGHTS GENERATION & KPIS
       ----------------------------------------------------- */
    function updateKPIs(currentWeek, prevWeek) {
        const curr = marketData.filter(d => d.week_date === currentWeek);
        const prev = prevWeek ? marketData.filter(d => d.week_date === prevWeek) : [];

        // 1. Total Clicks
        const clicksCurr = Math.round(curr.reduce((s, d) => s + (d.estimated_clicks || 0), 0));
        const clicksPrev = Math.round(prev.reduce((s, d) => s + (d.estimated_clicks || 0), 0));
        document.getElementById('kpi-clicks').textContent = clicksCurr.toLocaleString();
        
        if (prevWeek) {
            const diff = clicksCurr - clicksPrev;
            const pct = ((diff / clicksPrev) * 100).toFixed(1);
            const el = document.getElementById('kpi-clicks-trend');
            el.innerHTML = diff > 0 ? `<span class="trend-up">▲ ${pct}%</span> vs prev week` : `<span class="trend-down">▼ ${pct}%</span> vs prev week`;
        }

        // 2. Our Share
        const getShare = (ds) => ds.filter(d => d.final_brand === OUR_BRAND).reduce((s,d) => s + d.click_share, 0);
        const shareCurr = getShare(curr);
        const sharePrev = getShare(prev);
        document.getElementById('kpi-share').textContent = shareCurr.toFixed(1) + '%';
        
        if (prevWeek) {
            const diff = shareCurr - sharePrev;
            const el = document.getElementById('kpi-share-trend');
            el.innerHTML = diff > 0 ? `<span class="trend-up">▲ +${diff.toFixed(1)}%</span>` : `<span class="trend-down">▼ ${diff.toFixed(1)}%</span>`;
        }

        // 3. Price
        const avgPriceMkt = curr.reduce((s, d) => s + (d.price || 0), 0) / curr.length;
        const ourAsins = curr.filter(d => d.final_brand === OUR_BRAND);
        const avgPriceUs = ourAsins.length ? (ourAsins.reduce((s,d) => s + d.price, 0) / ourAsins.length) : 0;
        
        document.getElementById('kpi-price').textContent = avgPriceMkt.toFixed(2);
        document.getElementById('kpi-our-price').textContent = avgPriceUs.toFixed(2);
        if (avgPriceUs > avgPriceMkt) document.getElementById('kpi-our-price').style.color = '#EA4335'; // Expensive
        else document.getElementById('kpi-our-price').style.color = '#34A853'; // Competitive
    }

    function renderInsights(currentWeek, prevWeek) {
        const insights = [];
        const recs = [];
        
        const curr = marketData.filter(d => d.week_date === currentWeek);
        const prev = prevWeek ? marketData.filter(d => d.week_date === prevWeek) : [];
        
        // Helper
        const getBrandShare = (data, b) => data.filter(d => d.final_brand === b).reduce((s,x) => s + x.click_share, 0);
        
        // 1. Share Movement
        const ourShareCurr = getBrandShare(curr, OUR_BRAND);
        const ourSharePrev = prevWeek ? getBrandShare(prev, OUR_BRAND) : 0;
        
        if (ourShareCurr > ourSharePrev && prevWeek) {
            insights.push(`<strong>Momentum:</strong> ${OUR_BRAND} grew Share of Voice by +${(ourShareCurr - ourSharePrev).toFixed(1)}% this week.`);
            recs.push(`<strong>Capitalize:</strong> Maintain current bid aggression on top keywords as organic rank is likely improving.`);
        } else if (prevWeek) {
            insights.push(`<strong>Risk:</strong> ${OUR_BRAND} lost -${(ourSharePrev - ourShareCurr).toFixed(1)}% share vs previous week.`);
            recs.push(`<strong>Defense:</strong> Audit competitors' deals. If price is stable, consider a temporary coupon to regain traction.`);
        }

        // 2. Top Threat
        let maxGrowth = 0;
        let threat = "";
        const allBrands = [...new Set(curr.map(d => d.final_brand))];
        allBrands.forEach(b => {
            if(b === OUR_BRAND) return;
            const sC = getBrandShare(curr, b);
            const sP = prevWeek ? getBrandShare(prev, b) : 0;
            if((sC - sP) > maxGrowth) {
                maxGrowth = sC - sP;
                threat = b;
            }
        });
        if (threat && maxGrowth > 1) {
            insights.push(`<strong>Competitor Alert:</strong> ${threat} is the fastest mover, gaining +${maxGrowth.toFixed(1)}% share.`);
            recs.push(`<strong>Targeting:</strong> Analyze ${threat}'s listing for new badges or price drops. Consider conquesting their ASINs.`);
        }

        // 3. Price Position
        const ourAsins = curr.filter(d => d.final_brand === OUR_BRAND);
        const ourAvgPrice = ourAsins.length ? (ourAsins.reduce((s,d) => s + d.price, 0) / ourAsins.length) : 0;
        const marketAvgPrice = curr.reduce((s,d) => s + d.price, 0) / curr.length;
        
        if(ourAvgPrice > marketAvgPrice * 1.2) {
            insights.push(`<strong>Price Sensitivity:</strong> You are priced 20%+ above market average.`);
            recs.push(`<strong>Pricing:</strong> If conversion is dropping, test a price point closer to ${marketAvgPrice.toFixed(2)}.`);
        }

        // 4. Badges
        const hasChoice = ourAsins.some(d => d.weekly_number_of_days_with_amazon_choice_badge > 3);
        if(!hasChoice) {
            insights.push(`<strong>Visibility:</strong> ${OUR_BRAND} lacks the 'Amazon Choice' badge this week on key ASINs.`);
            recs.push(`<strong>SEO:</strong> Review keyword relevance and conversion rates to reclaim the Choice badge.`);
        } else {
             insights.push(`<strong>Strength:</strong> You hold 'Amazon Choice' on at least one ASIN, aiding CTR efficiency.`);
        }

        // Render
        document.getElementById('insights-list').innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        document.getElementById('recommendations-list').innerHTML = recs.map(i => `<li><span class="rec-tag">ACTION</span> ${i}</li>`).join('');
    }

    /* -----------------------------------------------------
       TAB 2: COMPARATOR LOGIC
       ----------------------------------------------------- */
    function updateComparator() {
        const week = document.getElementById('comp-week-select').value;
        const competitor = document.getElementById('comp-brand-select').value;
        
        if(!week || !competitor) return;

        // Names
        document.getElementById('comp-our-name').innerText = OUR_BRAND;
        document.getElementById('comp-them-name').innerText = competitor;

        // Data Aggregation Helper
        const getMetrics = (brandName) => {
            const data = marketData.filter(d => d.week_date === week && d.final_brand === brandName);
            if (!data.length) return { share: 0, price: 0, rank: 0, deals: 0 };

            const share = data.reduce((s,d) => s + d.click_share, 0);
            const price = data.reduce((s,d) => s + d.price, 0) / data.length;
            const rank = data.reduce((s,d) => s + d.average_organic_rank, 0) / data.length; // Simple avg for summary
            const deals = data.reduce((s,d) => s + d.weekly_number_of_days_with_deal, 0);

            return { share, price, rank, deals };
        };

        const us = getMetrics(OUR_BRAND);
        const them = getMetrics(competitor);

        // Render Cards
        document.getElementById('comp-our-share').innerText = us.share.toFixed(2) + '%';
        document.getElementById('comp-our-price').innerText = us.price.toFixed(2);
        document.getElementById('comp-our-rank').innerText = us.rank.toFixed(1);
        document.getElementById('comp-our-deals').innerText = us.deals;

        document.getElementById('comp-them-share').innerText = them.share.toFixed(2) + '%';
        document.getElementById('comp-them-price').innerText = them.price.toFixed(2);
        document.getElementById('comp-them-rank').innerText = them.rank.toFixed(1);
        document.getElementById('comp-them-deals').innerText = them.deals;

        // Draw Historical Comparison Chart
        drawCompHistoryChart(competitor);
    }

    function drawCompHistoryChart(compName) {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', `${OUR_BRAND} Share`);
        data.addColumn('number', `${compName} Share`);
        data.addColumn('number', `${OUR_BRAND} Price`); // Dashed line ideally
        data.addColumn('number', `${compName} Price`);

        const rows = weeks.map(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            const getS = (b) => weekData.filter(d => d.final_brand === b).reduce((s,x)=>s+x.click_share,0);
            const getP = (b) => {
                const bData = weekData.filter(d => d.final_brand === b);
                return bData.length ? bData.reduce((s,x)=>s+x.price,0)/bData.length : null;
            }
            return [w, getS(OUR_BRAND), getS(compName), getP(OUR_BRAND), getP(compName)];
        });

        data.addRows(rows);

        const options = {
            series: {
                0: {targetAxisIndex: 0, color: '#4285F4', lineWidth: 3},
                1: {targetAxisIndex: 0, color: '#EA4335', lineWidth: 3},
                2: {targetAxisIndex: 1, color: '#4285F4', lineDashStyle: [4, 4], lineWidth: 1},
                3: {targetAxisIndex: 1, color: '#EA4335', lineDashStyle: [4, 4], lineWidth: 1}
            },
            vAxes: {
                0: {title: 'Share %'},
                1: {title: 'Price', format: 'currency'}
            },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_comp_history'));
        chart.draw(data, options);
    }

</script>

</body>
</html>