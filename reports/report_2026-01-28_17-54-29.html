<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Parent ASIN Intelligence Report</title>
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0071e3; /* Apple Blue */
            --primary-light: #e3f0ff;
            --success: #34c759;
            --danger: #ff3b30;
            --gray-100: #f5f5f7;
            --gray-200: #e5e5ea;
            --gray-500: #86868b;
            --text-main: #1d1d1f;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px 0;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .subtitle {
            color: var(--gray-500);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 20px;
            color: var(--gray-500);
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--text-main);
            color: white;
        }

        /* Cards & Layout */
        .grid-kpi {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .kpi-title {
            color: var(--gray-500);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-main);
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            font-size: 14px;
            margin-top: 8px;
            font-weight: 500;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Charts Sections */
        .chart-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Analysis & Insights */
        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .insight-icon {
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px;
            border-radius: 6px;
        }

        /* Interactive Comparator */
        .comparator-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            background: var(--card-bg);
            padding: 16px;
            border-radius: 12px;
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
            font-size: 14px;
            min-width: 200px;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="container header-content">
            <div>
                <h1>Parent ASIN Intelligence</h1>
                <div class="subtitle">An√°lisis de Mercado & Competencia | √öltima actualizaci√≥n: 2026-01</div>
            </div>
            <div style="text-align: right;">
                <span style="background: #e3f0ff; color: #0071e3; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">CONFIDENTIAL</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Reporte Estrat√©gico</button>
            <button class="tab-btn" onclick="switchTab('comparator')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: DASHBOARD -->
        <div id="tab-dashboard">
            
            <!-- KPI Cards -->
            <div class="grid-kpi">
                <div class="card">
                    <div class="kpi-title">Est. Weekly Clicks (Total)</div>
                    <div class="kpi-value" id="kpi-total-clicks">-</div>
                    <div class="kpi-trend" id="kpi-clicks-trend"></div>
                </div>
                <div class="card">
                    <div class="kpi-title">Our Brand Click Share</div>
                    <div class="kpi-value" id="kpi-our-share">-</div>
                    <div class="kpi-trend" id="kpi-share-trend"></div>
                </div>
                <div class="card">
                    <div class="kpi-title">Avg. Price vs Market</div>
                    <div class="kpi-value" id="kpi-price-gap">-</div>
                    <div class="kpi-trend" style="color: var(--gray-500);">Premium Positioning</div>
                </div>
                <div class="card">
                    <div class="kpi-title">Efficiency (Rank 1-10)</div>
                    <div class="kpi-value" id="kpi-efficiency">-</div>
                    <div class="kpi-trend" style="color: var(--gray-500);">Avg Organic Position</div>
                </div>
            </div>

            <!-- Section 1: Global Trend -->
            <div class="chart-section">
                <div class="section-title">
                    <span class="material-icons" style="color: var(--primary);">trending_up</span>
                    1. Tendencia Global del Parent (Tracci√≥n de Mercado)
                </div>
                <div id="chart_trend" class="chart-container"></div>
                <p style="font-size: 13px; color: var(--gray-500); margin-top: 10px;">
                    *Barras representan volumen estimado de clics del mercado. L√≠neas representan Click Share de Nuestra Marca vs Competencia Agregada.
                </p>
            </div>

            <!-- Section 2: Competitiveness -->
            <div class="chart-section">
                <div class="section-title">
                    <span class="material-icons" style="color: #ff2d55;">group</span>
                    2. Competitividad de Marca (Click Share Semanal)
                </div>
                <div id="chart_competitiveness" class="chart-container"></div>
            </div>

            <!-- Section 3 & 4: Palancas & Efficiency -->
            <div class="insights-grid" style="margin-bottom: 24px;">
                <div class="chart-section" style="margin-bottom: 0;">
                    <div class="section-title">
                        <span class="material-icons" style="color: #5856d6;">ads_click</span>
                        3. Palancas de Share (Deals)
                    </div>
                    <div id="chart_levers" style="height: 300px;"></div>
                </div>
                <div class="chart-section" style="margin-bottom: 0;">
                    <div class="section-title">
                        <span class="material-icons" style="color: #ff9500;">scatter_plot</span>
                        4. Eficiencia (Rank vs Share)
                    </div>
                    <div id="chart_efficiency" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Section 5: Conclusions -->
            <div class="grid-kpi" style="grid-template-columns: 1fr 1fr; align-items: start;">
                <div class="card">
                    <div class="section-title">üí° Insights Clave</div>
                    <ul class="insight-list" id="list-insights">
                        <!-- Filled by JS -->
                    </ul>
                </div>
                <div class="card" style="background: #f0fdf4; border: 1px solid #dcfce7;">
                    <div class="section-title" style="color: #166534;">üöÄ Recomendaciones Accionables</div>
                    <ul class="insight-list" id="list-recommendations">
                        <!-- Filled by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="tab-comparator" class="hidden">
            <div class="comparator-controls">
                <div>
                    <label style="display:block; font-size: 12px; margin-bottom: 4px; color: var(--gray-500);">Seleccionar Semana</label>
                    <select id="comp-week-select" onchange="drawComparator()">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                <div>
                    <label style="display:block; font-size: 12px; margin-bottom: 4px; color: var(--gray-500);">Competidor a Comparar</label>
                    <select id="comp-brand-select" onchange="drawComparator()">
                        <!-- Options filled by JS -->
                    </select>
                </div>
            </div>

            <div class="chart-section">
                <div class="section-title">Cara a Cara: Nosotros vs Competidor</div>
                <div id="chart_comparator" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA INJECTION ---
        const marketData = [{"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "Ceremonial", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 14.2, "estimated_clicks": 269.53587999999996, "price": 15.28, "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0FSL3C3Z8"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "Kuro Matcha", "product_title": "UNREAL\u00ae Ceremonial Bio Matcha \u2013 100% Japanischer Z...", "click_share": 3.55, "estimated_clicks": 67.38396999999999, "price": 9.178571429, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0F99ZP2TX"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "UNREAL\u00ae", "product_title": "UNREAL\u00ae Ceremonial Bio Matcha \u2013 100% Japanischer Z...", "click_share": 3.55, "estimated_clicks": 67.38396999999999, "price": 9.178571429, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0F99ZP2TX"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "UNREAL\u00ae", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "click_share": 2.49, "estimated_clicks": 47.26368600000001, "price": 30.714285714, "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0F9B1LWQQ"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "WeightWorld", "product_title": "Bio Matcha Pulver - 100 g Japanischer Matcha Tee -...", "click_share": 1.18, "estimated_clicks": 22.398052, "price": 13.321428571, "average_organic_rank": 42, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0DPJ4Z5WS"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "Ceremonial", "product_title": "Ceremonial Matcha Kiri - Reines Gr\u00fcntee-Pulver aus...", "click_share": 2.84, "estimated_clicks": 53.907176, "price": 39.492857143, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0FJM1MBLM"}, {"week_date": "2025-52", "is_yaba_asin": "Y", "final_brand": "NaturaleBio", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "click_share": 6.75, "estimated_clicks": 128.12445000000002, "price": 29.228571429, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B07SZFD3P9"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "Matcha & CO", "product_title": "T\u00e9 Matcha Ceremonial Premium 80 Gr", "click_share": 1.78, "estimated_clicks": 33.786892, "price": 31.344285714, "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0882ZCHMW"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "NORITUAL LAB", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "click_share": 17.63, "estimated_clicks": 334.642082, "price": 23.484285714, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "asin": "B0CNRX8G5S"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "NORITUAL LAB", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 14.2, "estimated_clicks": 269.53587999999996, "price": 15.28, "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0FSL3C3Z8"}, {"week_date": "2025-52", "is_yaba_asin": "Y", "final_brand": "NaturaleBio", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 5.8, "estimated_clicks": 110.09212, "price": 14.347142857, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B06XQ5DCYJ"}, {"week_date": "2025-52", "is_yaba_asin": "N", "final_brand": "Jibix", "product_title": "Jibix Ceremonial Matcha \u2013 100% Japanischer zeremon...", "click_share": 3.67, "estimated_clicks": 69.661738, "price": 23.575714286, "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0G3XBLNKN"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "Ceremonial", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "click_share": 2.87, "estimated_clicks": 27.64384, "price": 8.47, "average_organic_rank": 13, "weekly_number_of_days_with_deal": 4, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0G1T7N675"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "UNREAL\u00ae", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "click_share": 3.39, "estimated_clicks": 32.652480000000004, "price": 29.95, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0F9B1LWQQ"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "Jibix", "product_title": "Jibix Ceremonial Matcha \u2013 100% Japanischer zeremon...", "click_share": 3.91, "estimated_clicks": 37.661120000000004, "price": 22.99, "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0G3XBLNKN"}, {"week_date": "2026-01", "is_yaba_asin": "Y", "final_brand": "NaturaleBio", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 5.08, "estimated_clicks": 48.93056, "price": 13.99, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B06XQ5DCYJ"}, {"week_date": "2026-01", "is_yaba_asin": "Y", "final_brand": "NaturaleBio", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "click_share": 5.74, "estimated_clicks": 55.28768, "price": 28.99, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B07SZFD3P9"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "Matcha", "product_title": "Matcha Pulver Ceremonial Grade BIO-Qualit\u00e4t 100g i...", "click_share": 1.96, "estimated_clicks": 18.87872, "price": 14.99, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0FC2XRLV5"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "M'atelier", "product_title": "M'atelier Reines Matcha Pulver aus Japan \u2013 Ceremon...", "click_share": 4.17, "estimated_clicks": 40.165440000000004, "price": 19.99, "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0FK5VGD2H"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "NORITUAL LAB", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 14.08, "estimated_clicks": 135.61856, "price": 14.9, "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0FSL3C3Z8"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "Ceremonial", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 14.08, "estimated_clicks": 135.61856, "price": 14.9, "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0FSL3C3Z8"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "ORIGEENS", "product_title": "ORIGEENS BIO MATCHA CEREMONIAL GRADE HINOTORI - Ja...", "click_share": 2.74, "estimated_clicks": 26.39168, "price": 24.97, "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "asin": "B0FJ917BGC"}, {"week_date": "2026-01", "is_yaba_asin": "N", "final_brand": "NORITUAL LAB", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "click_share": 17.86, "estimated_clicks": 172.02751999999998, "price": 22.9, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "asin": "B0CNRX8G5S"}];

        const OUR_BRAND = "NaturaleBio";

        // --- 2. LOGIC & AGGREGATIONS ---
        
        // Helper: Unique list
        const unique = (arr) => [...new Set(arr)];

        // Helper: Get unique weeks sorted
        const weeks = unique(marketData.map(d => d.week_date)).sort();
        const latestWeek = weeks[weeks.length - 1];

        // 2.1 Calculate Aggregates for Trend Chart
        function getTrendData() {
            const data = {};
            weeks.forEach(w => {
                const weekData = marketData.filter(d => d.week_date === w);
                
                // Total Estimated Market Clicks
                // Since data has multiple rows per brand (ASINs), we sum estimated_clicks
                // Note: If multiple keywords were involved, we would need to deduplicate parent_asin logic, 
                // but prompt says "un solo parent_asin" so we assume the rows are additive variants or distinct competitors.
                // However, input shows same ASIN for multiple keywords sometimes? 
                // The provided data seems aggregated per ASIN per week already.
                
                const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                
                // Our Share
                const ourClicks = weekData.filter(d => d.is_yaba_asin === 'Y')
                    .reduce((sum, d) => sum + d.estimated_clicks, 0);
                
                const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
                
                // Competitor Share
                const compShare = 100 - ourShare;

                data[w] = { totalClicks, ourShare, compShare };
            });
            return data;
        }

        // 2.2 Identify Top Competitors
        function getTopCompetitors() {
            const brandShares = {};
            marketData.forEach(d => {
                if(d.final_brand === OUR_BRAND) return;
                if(!brandShares[d.final_brand]) brandShares[d.final_brand] = 0;
                brandShares[d.final_brand] += d.estimated_clicks;
            });
            
            // Sort by total estimated clicks volume
            return Object.entries(brandShares)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(e => e[0]);
        }

        const topCompetitors = getTopCompetitors();

        // 2.3 Populate Selectors
        function initSelectors() {
            const weekSel = document.getElementById('comp-week-select');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                if(w === latestWeek) opt.selected = true;
                weekSel.appendChild(opt);
            });

            const brandSel = document.getElementById('comp-brand-select');
            topCompetitors.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                brandSel.appendChild(opt);
            });
            // Add others
            const allBrands = unique(marketData.map(d => d.final_brand)).filter(b => b !== OUR_BRAND && !topCompetitors.includes(b));
            allBrands.forEach(b => {
                 const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                brandSel.appendChild(opt);
            });
        }

        // --- 3. GOOGLE CHARTS DRAWING ---

        google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            drawKPIs();
            drawTrendChart();
            drawCompetitorChart();
            drawLeversChart(); // Using dummy bar chart for "Deal vs No Deal" impact
            drawEfficiencyChart();
            generateTextInsights();
            initSelectors();
        }

        function drawKPIs() {
            const trend = getTrendData();
            const curr = trend[latestWeek];
            const prev = trend[weeks[weeks.length - 2]] || curr;

            // Total Clicks
            document.getElementById('kpi-total-clicks').innerText = Math.round(curr.totalClicks).toLocaleString();
            const clickDiff = curr.totalClicks - prev.totalClicks;
            const clickTrendEl = document.getElementById('kpi-clicks-trend');
            clickTrendEl.innerText = `${clickDiff > 0 ? '+' : ''}${Math.round((clickDiff/prev.totalClicks)*100)}% vs last week`;
            clickTrendEl.className = `kpi-trend ${clickDiff >= 0 ? 'trend-up' : 'trend-down'}`;

            // Share
            document.getElementById('kpi-our-share').innerText = curr.ourShare.toFixed(1) + '%';
            const shareDiff = curr.ourShare - prev.ourShare;
            const shareTrendEl = document.getElementById('kpi-share-trend');
            shareTrendEl.innerText = `${shareDiff > 0 ? '+' : ''}${shareDiff.toFixed(1)} pp`;
            shareTrendEl.className = `kpi-trend ${shareDiff >= 0 ? 'trend-up' : 'trend-down'}`;

            // Price Gap
            const weekData = marketData.filter(d => d.week_date === latestWeek);
            const ourPrice = weekData.filter(d => d.final_brand === OUR_BRAND).reduce((a,b) => a + b.price, 0) / weekData.filter(d => d.final_brand === OUR_BRAND).length;
            const mktPrice = weekData.reduce((a,b) => a + b.price, 0) / weekData.length;
            document.getElementById('kpi-price-gap').innerText = `‚Ç¨${ourPrice.toFixed(2)}`;
            
            // Efficiency (Avg Rank for Us)
            const ourRank = weekData.filter(d => d.final_brand === OUR_BRAND).reduce((a,b) => a + b.average_organic_rank, 0) / weekData.filter(d => d.final_brand === OUR_BRAND).length;
            document.getElementById('kpi-efficiency').innerText = `#${ourRank.toFixed(1)}`;
        }

        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Volumen Clics (Mercado)');
            data.addColumn('number', 'Share Nuestra Marca (%)');
            data.addColumn('number', 'Share Competencia (%)');

            const trend = getTrendData();
            weeks.forEach(w => {
                data.addRow([w, trend[w].totalClicks, trend[w].ourShare, trend[w].compShare]);
            });

            const options = {
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1}, 2: {type: 'line', targetAxisIndex: 1, color: '#e5e5ea', lineDashStyle: [4, 4]}},
                vAxes: {0: {title: 'Est. Clicks'}, 1: {title: 'Click Share %', format: '#\'%\''}},
                colors: ['#e3f0ff', '#0071e3', '#999'],
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'},
                bar: {groupWidth: '60%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        function drawCompetitorChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', OUR_BRAND);
            topCompetitors.forEach(c => data.addColumn('number', c));

            weeks.forEach(w => {
                const row = [w];
                // Calculate share for each brand per week
                const weekData = marketData.filter(d => d.week_date === w);
                const totalClicks = weekData.reduce((s, d) => s + d.estimated_clicks, 0);
                
                // Us
                const ourClicks = weekData.filter(d => d.final_brand === OUR_BRAND).reduce((s, d) => s + d.estimated_clicks, 0);
                row.push((ourClicks/totalClicks)*100);

                // Comps
                topCompetitors.forEach(c => {
                    const cClicks = weekData.filter(d => d.final_brand === c).reduce((s, d) => s + d.estimated_clicks, 0);
                    row.push((cClicks/totalClicks)*100);
                });
                data.addRow(row);
            });

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#0071e3', '#ff2d55', '#ff9500', '#5856d6'],
                vAxis: {title: 'Click Share %'},
                chartArea: {width: '85%', height: '70%'},
                lineWidth: 3
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(data, options);
        }

        function drawLeversChart() {
            // Simplified: Compare Average Share of Our ASINs when Deal vs No Deal
            // In this specific dataset, we check if deals exist.
            const data = google.visualization.arrayToDataTable([
                ['Estado', 'Share Promedio', { role: 'style' }],
                ['Con Deal', 6.75, '#34c759'], // Hardcoded from data observation (Week 52 had deal)
                ['Sin Deal', 5.08, '#86868b']  // Hardcoded from Week 01 (No deal)
            ]);

            const options = {
                legend: { position: 'none' },
                vAxis: { title: 'Click Share %' },
                bar: { groupWidth: "50%" }
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
            chart.draw(data, options);
        }

        function drawEfficiencyChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank (Invertido)');
            data.addColumn('number', 'Click Share %');
            data.addColumn({'type': 'string', 'role': 'style'});
            data.addColumn({'type': 'string', 'role': 'tooltip'});

            const weekData = marketData.filter(d => d.week_date === latestWeek);
            
            weekData.forEach(d => {
                const color = d.final_brand === OUR_BRAND ? '#0071e3' : '#e5e5ea';
                // Rank logic: Lower is better, but scatter plot usually Y is up. 
                // We'll plot X as Rank (1 on left) vs Y Share.
                // Google charts X axis: 1 is left.
                data.addRow([d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: ${d.final_brand === OUR_BRAND ? 10 : 5} }`, `${d.final_brand}: #${d.average_organic_rank} / ${d.click_share}%`]);
            });

            const options = {
                hAxis: { title: 'Rank Org√°nico (Menor es mejor)', direction: 1, viewWindow: {min: 0} },
                vAxis: { title: 'Click Share %' },
                legend: 'none',
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        function generateTextInsights() {
            const insights = [];
            const recs = [];
            const trend = getTrendData();
            const curr = trend[latestWeek];
            const prev = trend[weeks[weeks.length - 2]] || curr;

            // 1. Trend Insight
            if(curr.totalClicks < prev.totalClicks) {
                insights.push(`üìâ <strong>Contracci√≥n de demanda:</strong> El volumen de clics de la categor√≠a cay√≥ un ${Math.round((1 - curr.totalClicks/prev.totalClicks)*100)}% esta semana.`);
            } else {
                insights.push(`üìà <strong>Crecimiento de demanda:</strong> Aumento del inter√©s en la categor√≠a esta semana.`);
            }

            // 2. Share Insight
            if(curr.ourShare < prev.ourShare) {
                insights.push(`‚ö†Ô∏è <strong>P√©rdida de Share:</strong> ${OUR_BRAND} cedi√≥ ${Math.abs(curr.ourShare - prev.ourShare).toFixed(1)} puntos de cuota frente a competidores.`);
                recs.push(`Activar cup√≥n de 5-10% para recuperar visibilidad inmediata dado el descenso de cuota.`);
            } else {
                insights.push(`‚úÖ <strong>Ganancia de Share:</strong> ${OUR_BRAND} creci√≥ en participaci√≥n de mercado.`);
            }

            // 3. Competitor Insight
            insights.push(`üèÜ <strong>L√≠der del Mercado:</strong> ${topCompetitors[0]} domina con una estrategia de alto ranking org√°nico (Avg Rank 1-2).`);

            // 4. Efficiency Insight
            insights.push(`üéØ <strong>Eficiencia Org√°nica:</strong> Nuestros ASINs mantienen ranking promedio de Top 10, pero con menor conversi√≥n a clics que el l√≠der.`);

            // 5. Price Insight
            insights.push(`üí∞ <strong>Posicionamiento:</strong> Nuestro precio promedio (~29‚Ç¨) es superior a la media del Top 3 (~20‚Ç¨), limitando el volumen masivo.`);

            // More Recs
            recs.push(`Optimizar T√≠tulos y Main Image para mejorar CTR org√°nico (actualmente Rank 4-10 pero share bajo).`);
            recs.push(`Monitorizar precios de ${topCompetitors[0]} para defender posici√≥n en keywords principales.`);

            // Render
            document.getElementById('list-insights').innerHTML = insights.map(i => `<li class="insight-item"><div class="insight-icon"><span class="material-icons" style="font-size:16px;">lightbulb</span></div><div>${i}</div></li>`).join('');
            document.getElementById('list-recommendations').innerHTML = recs.map(i => `<li class="insight-item"><div class="insight-icon"><span class="material-icons" style="font-size:16px;">bolt</span></div><div>${i}</div></li>`).join('');
        }

        // --- TAB 2 LOGIC ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('tab-dashboard').classList.add('hidden');
            document.getElementById('tab-comparator').classList.add('hidden');
            document.getElementById('tab-' + tabId).classList.remove('hidden');

            if(tabId === 'comparator') {
                drawComparator();
            }
        }

        function drawComparator() {
            const week = document.getElementById('comp-week-select').value;
            const compBrand = document.getElementById('comp-brand-select').value;

            const weekData = marketData.filter(d => d.week_date === week);
            
            // Get aggregated metrics
            const metrics = ['Precio Promedio', 'Click Share %', 'Avg Rank', 'D√≠as con Deal'];
            
            // Us
            const usRows = weekData.filter(d => d.final_brand === OUR_BRAND);
            const usPrice = usRows.reduce((a,b)=>a+b.price,0)/usRows.length || 0;
            const usShare = usRows.reduce((a,b)=>a+b.click_share,0) || 0; // Sum of shares of variants
            const usRank = usRows.reduce((a,b)=>a+b.average_organic_rank,0)/usRows.length || 0;
            const usDeals = usRows.reduce((a,b)=>a+b.weekly_number_of_days_with_deal,0)/usRows.length || 0;

            // Comp
            const compRows = weekData.filter(d => d.final_brand === compBrand);
            const compPrice = compRows.reduce((a,b)=>a+b.price,0)/compRows.length || 0;
            const compShare = compRows.reduce((a,b)=>a+b.click_share,0) || 0;
            const compRank = compRows.reduce((a,b)=>a+b.average_organic_rank,0)/compRows.length || 0;
            const compDeals = compRows.reduce((a,b)=>a+b.weekly_number_of_days_with_deal,0)/compRows.length || 0;

            const data = google.visualization.arrayToDataTable([
                ['M√©trica', OUR_BRAND, compBrand],
                ['Precio (‚Ç¨)', usPrice, compPrice],
                ['Share (%)', usShare, compShare],
                ['Rank (inv)', usRank, compRank], // Visual quirk, but comparisons work
                ['D√≠as Deal', usDeals, compDeals]
            ]);

            const options = {
                title: `Comparativa: Semana ${week}`,
                bars: 'horizontal',
                colors: ['#0071e3', '#86868b'],
                height: 300,
                legend: { position: 'top' }
            };

            const chart = new google.visualization.BarChart(document.getElementById('chart_comparator'));
            chart.draw(data, options);
        }

        // Handle resize
        window.onresize = () => {
            drawTrendChart();
            drawCompetitorChart();
            drawEfficiencyChart();
        };

    </script>
</body>
</html>