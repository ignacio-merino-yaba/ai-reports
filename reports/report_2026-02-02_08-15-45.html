<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Parent ASIN Analysis Report</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-600: #5f6368;
            --gray-800: #202124;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --card-radius: 8px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: white;
            padding: 20px;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 { margin: 0; font-size: 24px; color: var(--primary); }
        .header-title p { margin: 5px 0 0; color: var(--gray-600); font-size: 14px; }
        .badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: white;
            border-radius: 20px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            .col-8, .col-6, .col-4 { grid-column: span 12; }
        }

        /* Cards */
        .card {
            background: white;
            padding: 20px;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-content { flex: 1; min-height: 300px; position: relative; }
        
        /* Metric Cards */
        .metric-card {
            text-align: center;
            padding: 15px;
        }
        .metric-value { font-size: 32px; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 12px; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-trend { font-size: 12px; margin-top: 5px; font-weight: 500; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Tables & Lists */
        .insights-list { list-style: none; padding: 0; margin: 0; }
        .insights-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 10px;
            font-size: 14px;
        }
        .insights-list li:last-child { border-bottom: none; }
        .icon-box {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .bg-blue { background: rgba(66, 133, 244, 0.1); color: var(--primary); }
        .bg-green { background: rgba(52, 168, 83, 0.1); color: var(--success); }
        .bg-red { background: rgba(234, 67, 53, 0.1); color: var(--danger); }

        /* Interactive Section */
        .controls {
            background: white;
            padding: 15px;
            border-radius: var(--card-radius);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
        }

        /* Utility */
        .hidden { display: none !important; }
        .chart-container { width: 100%; height: 100%; }
        
        table.simple-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        table.simple-table th { text-align: left; padding: 8px; border-bottom: 2px solid var(--gray-200); color: var(--gray-600); }
        table.simple-table td { padding: 8px; border-bottom: 1px solid var(--gray-200); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-title">
            <h1>Parent ASIN Intelligence Report</h1>
            <p>Analysis for: <span id="parentAsinDisplay">LOADING...</span> | Generated via Smart Agent</p>
        </div>
        <div class="badge">WEEKLY UPDATE</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Analysis Dashboard</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Interactive Comparator</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        <!-- KPI Row -->
        <div class="grid">
            <div class="col-4 card metric-card">
                <div class="metric-label">Total Parent Clicks (Last Week)</div>
                <div class="metric-value" id="kpiClicks">-</div>
                <div class="metric-trend" id="kpiClicksTrend">-</div>
            </div>
            <div class="col-4 card metric-card">
                <div class="metric-label">Our Click Share</div>
                <div class="metric-value" id="kpiShare">-</div>
                <div class="metric-trend" id="kpiShareTrend">-</div>
            </div>
            <div class="col-4 card metric-card">
                <div class="metric-label">Avg Organic Rank (Us)</div>
                <div class="metric-value" id="kpiRank">-</div>
                <div class="metric-trend" id="kpiRankTrend">-</div>
            </div>
        </div>

        <!-- Section 1: Global Trend -->
        <div class="grid">
            <div class="col-12 card">
                <div class="card-title">
                    <span class="material-icons text-blue-500">show_chart</span>
                    1. Global Parent Trend: Clicks vs. Share (Us vs. Competition)
                </div>
                <div class="card-content">
                    <div id="chart_global_trend" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="grid">
            <div class="col-8 card">
                <div class="card-title">
                    <span class="material-icons">people_outline</span>
                    2. Brand Competitiveness (Click Share History)
                </div>
                <div class="card-content">
                    <div id="chart_competitiveness" class="chart-container"></div>
                </div>
            </div>
            <div class="col-4 card">
                <div class="card-title">
                    <span class="material-icons">leaderboard</span>
                    Top 3 Competitors (Avg Share)
                </div>
                <div class="card-content" style="overflow-y: auto;">
                    <table class="simple-table" id="table_top_competitors">
                        <thead><tr><th>Brand</th><th>Share</th><th>Avg Price</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section 3 & 4: Palancas & Efficiency -->
        <div class="grid">
            <div class="col-6 card">
                <div class="card-title">
                    <span class="material-icons">monetization_on</span>
                    3. Price & Promo Drivers (Last Week)
                </div>
                <div class="card-content">
                    <div id="chart_palancas" class="chart-container"></div>
                </div>
            </div>
            <div class="col-6 card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Efficiency: Organic Rank vs. Click Share
                </div>
                <div class="card-content">
                    <div id="chart_efficiency" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="grid">
            <div class="col-12 card" style="background: linear-gradient(to right, #fff, #f8faff);">
                <div class="card-title" style="color: var(--primary);">
                    <span class="material-icons">lightbulb</span>
                    5. Key Conclusions & Actionable Recommendations
                </div>
                <ul class="insights-list" id="insights_container">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label>Select Week:</label>
                <select id="selWeek" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label>Compare Against:</label>
                <select id="selCompetitor" onchange="updateInteractive()"></select>
            </div>
        </div>
        
        <div class="grid">
            <div class="col-6 card">
                <div class="card-title">Head-to-Head: Stats</div>
                <div class="card-content">
                    <div id="table_interactive" class="chart-container"></div>
                </div>
            </div>
            <div class="col-6 card">
                <div class="card-title">Head-to-Head: Price Comparison</div>
                <div class="card-content">
                    <div id="chart_interactive_price" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION (Synthetic Data generated via Python logic)
    // ---------------------------------------------------------
    const marketData = [{"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00YABA001", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "is_yaba_asin": "Y", "product_title": "LuminaHome LED Desk Lamp, Dimmable", "clicks": 140, "click_share": 0.13400518698115655, "organic_rank": 5, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "grams": 500, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00CompetitorA01", "keywords": "led desk lamp", "competitor_brand": "CompetitorA", "is_yaba_asin": "N", "product_title": "CompetitorA Professional Lamp", "clicks": 204, "click_share": 0.09117188701988898, "organic_rank": 7, "price": 36.63471018694038, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00CompetitorB01", "keywords": "led desk lamp", "competitor_brand": "CompetitorB", "is_yaba_asin": "N", "product_title": "CompetitorB Professional Lamp", "clicks": 69, "click_share": 0.0528649479979318, "organic_rank": 7, "price": 34.02075593817349, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00CheapoBrand01", "keywords": "led desk lamp", "competitor_brand": "CheapoBrand", "is_yaba_asin": "N", "product_title": "CheapoBrand Professional Lamp", "clicks": 218, "click_share": 0.14660235377543788, "organic_rank": 10, "price": 26.69708947690326, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00LuxuryGoods01", "keywords": "led desk lamp", "competitor_brand": "LuxuryGoods", "is_yaba_asin": "N", "product_title": "LuxuryGoods Professional Lamp", "clicks": 68, "click_share": 0.17042851493416568, "organic_rank": 7, "price": 35.8166528775267, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00YABA001", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "is_yaba_asin": "Y", "product_title": "LuminaHome LED Desk Lamp, Dimmable", "clicks": 182, "click_share": 0.12920678235472173, "organic_rank": 3, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "grams": 500, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00CompetitorA01", "keywords": "led desk lamp", "competitor_brand": "CompetitorA", "is_yaba_asin": "N", "product_title": "CompetitorA Professional Lamp", "clicks": 108, "click_share": 0.1983574945417855, "organic_rank": 4, "price": 36.565408994783454, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00CompetitorB01", "keywords": "led desk lamp", "competitor_brand": "CompetitorB", "is_yaba_asin": "N", "product_title": "CompetitorB Professional Lamp", "clicks": 183, "click_share": 0.10309194294472393, "organic_rank": 12, "price": 34.69772391035072, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00CheapoBrand01", "keywords": "led desk lamp", "competitor_brand": "CheapoBrand", "is_yaba_asin": "N", "product_title": "CheapoBrand Professional Lamp", "clicks": 150, "click_share": 0.15830872210816823, "organic_rank": 10, "price": 23.36166258074903, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00LuxuryGoods01", "keywords": "led desk lamp", "competitor_brand": "LuxuryGoods", "is_yaba_asin": "N", "product_title": "LuxuryGoods Professional Lamp", "clicks": 218, "click_share": 0.1607567794348575, "organic_rank": 11, "price": 34.50536440266016, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00YABA001", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "is_yaba_asin": "Y", "product_title": "LuminaHome LED Desk Lamp, Dimmable", "clicks": 139, "click_share": 0.1479860472465366, "organic_rank": 3, "price": 29.99, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "grams": 500, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00CompetitorA01", "keywords": "led desk lamp", "competitor_brand": "CompetitorA", "is_yaba_asin": "N", "product_title": "CompetitorA Professional Lamp", "clicks": 105, "click_share": 0.08470557404494196, "organic_rank": 9, "price": 33.68205423853177, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00CompetitorB01", "keywords": "led desk lamp", "competitor_brand": "CompetitorB", "is_yaba_asin": "N", "product_title": "CompetitorB Professional Lamp", "clicks": 138, "click_share": 0.19837968499245592, "organic_rank": 4, "price": 36.31215701804368, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00CheapoBrand01", "keywords": "led desk lamp", "competitor_brand": "CheapoBrand", "is_yaba_asin": "N", "product_title": "CheapoBrand Professional Lamp", "clicks": 90, "click_share": 0.14234027735398717, "organic_rank": 10, "price": 25.07469792440337, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00LuxuryGoods01", "keywords": "led desk lamp", "competitor_brand": "LuxuryGoods", "is_yaba_asin": "N", "product_title": "LuxuryGoods Professional Lamp", "clicks": 105, "click_share": 0.050511520626388484, "organic_rank": 12, "price": 35.83965942472911, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00YABA001", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "is_yaba_asin": "Y", "product_title": "LuminaHome LED Desk Lamp, Dimmable", "clicks": 182, "click_share": 0.12519175317769992, "organic_rank": 1, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "grams": 500, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00CompetitorA01", "keywords": "led desk lamp", "competitor_brand": "CompetitorA", "is_yaba_asin": "N", "product_title": "CompetitorA Professional Lamp", "clicks": 139, "click_share": 0.14445831620677567, "organic_rank": 6, "price": 36.315729792686884, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00CompetitorB01", "keywords": "led desk lamp", "competitor_brand": "CompetitorB", "is_yaba_asin": "N", "product_title": "CompetitorB Professional Lamp", "clicks": 234, "click_share": 0.1345167086819442, "organic_rank": 11, "price": 34.02611796122606, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00CheapoBrand01", "keywords": "led desk lamp", "competitor_brand": "CheapoBrand", "is_yaba_asin": "N", "product_title": "CheapoBrand Professional Lamp", "clicks": 150, "click_share": 0.08183204910385732, "organic_rank": 16, "price": 24.329765103437508, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00LuxuryGoods01", "keywords": "led desk lamp", "competitor_brand": "LuxuryGoods", "is_yaba_asin": "N", "product_title": "LuxuryGoods Professional Lamp", "clicks": 230, "click_share": 0.16016140510650993, "organic_rank": 9, "price": 36.68961730704901, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00YABA001", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "is_yaba_asin": "Y", "product_title": "LuminaHome LED Desk Lamp, Dimmable", "clicks": 182, "click_share": 0.12658428886364024, "organic_rank": 1, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "grams": 500, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00CompetitorA01", "keywords": "led desk lamp", "competitor_brand": "CompetitorA", "is_yaba_asin": "N", "product_title": "CompetitorA Professional Lamp", "clicks": 69, "click_share": 0.17036660601570707, "organic_rank": 10, "price": 33.72591605333559, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00CompetitorB01", "keywords": "led desk lamp", "competitor_brand": "CompetitorB", "is_yaba_asin": "N", "product_title": "CompetitorB Professional Lamp", "clicks": 186, "click_share": 0.05204481352431711, "organic_rank": 12, "price": 36.32177395011749, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00CheapoBrand01", "keywords": "led desk lamp", "competitor_brand": "CheapoBrand", "is_yaba_asin": "N", "product_title": "CheapoBrand Professional Lamp", "clicks": 53, "click_share": 0.09337583626296338, "organic_rank": 14, "price": 26.549242981358907, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00LuxuryGoods01", "keywords": "led desk lamp", "competitor_brand": "LuxuryGoods", "is_yaba_asin": "N", "product_title": "LuxuryGoods Professional Lamp", "clicks": 204, "click_share": 0.12933618830172605, "organic_rank": 5, "price": 36.195190892019864, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 550, "organic_or_not": "Organic", "container": "Standard"}];

    // ---------------------------------------------------------
    // 2. HELPER FUNCTIONS
    // ---------------------------------------------------------
    
    // Identify Our Brand
    const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
    const ourBrand = ourAsinRow ? ourAsinRow.competitor_brand : (marketData[0]?.product_title.split(' ')[0] || "Unknown");
    const parentAsin = marketData[0]?.parent_asin || "Unknown";
    document.getElementById('parentAsinDisplay').innerText = parentAsin;

    // Helper to get normalized brand
    function getBrand(row) {
        if(row.competitor_brand) return row.competitor_brand;
        if(row.product_title) return row.product_title.split(" ")[0]; // Fallback
        return "Unknown Brand";
    }

    // Unique Weeks (Sorted)
    const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
    const lastWeek = weeks[weeks.length - 1];
    const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;

    // Grouping
    function groupBy(data, key) {
        return data.reduce((storage, item) => {
            const group = item[key];
            storage[group] = storage[group] || [];
            storage[group].push(item);
            return storage;
        }, {});
    }

    // ---------------------------------------------------------
    // 3. ANALYSIS LOGIC
    // ---------------------------------------------------------
    
    // Calculate Competitor Strengths
    const brandsMap = {};
    marketData.forEach(r => {
        const b = getBrand(r);
        if(b === ourBrand) return;
        if(!brandsMap[b]) brandsMap[b] = { shareSum: 0, count: 0, prices: [] };
        brandsMap[b].shareSum += (r.click_share || 0);
        brandsMap[b].count++;
        brandsMap[b].prices.push(r.price);
    });

    const topCompetitors = Object.entries(brandsMap)
        .map(([brand, data]) => ({
            brand, 
            avgShare: data.shareSum / data.count,
            avgPrice: data.prices.reduce((a,b)=>a+b,0)/data.count
        }))
        .sort((a,b) => b.avgShare - a.avgShare)
        .slice(0, 3);

    const top3Brands = topCompetitors.map(c => c.brand);

    // ---------------------------------------------------------
    // 4. CHART DRAWING
    // ---------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawGlobalTrend();
        drawCompetitiveness();
        drawPalancas();
        drawEfficiency();
        populateKPIs();
        generateInsights();
        setupInteractive();
    }

    // --- Chart 1: Global Trend ---
    function drawGlobalTrend() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Our Clicks');
        data.addColumn('number', 'Competitor Clicks');
        data.addColumn('number', 'Our Click Share %');

        const rows = weeks.map(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            const ourData = weekData.filter(d => getBrand(d) === ourBrand);
            const compData = weekData.filter(d => getBrand(d) !== ourBrand);

            const ourClicks = ourData.reduce((s, x) => s + (x.clicks||0), 0);
            const compClicks = compData.reduce((s, x) => s + (x.clicks||0), 0);
            // Avg share for "Us"
            const ourShare = ourData.reduce((s, x) => s + (x.click_share||0), 0) * 100; 

            return [w, ourClicks, compClicks, ourShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1} }, // Share on right axis
            vAxes: { 0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''} },
            colors: ['#4285F4', '#E0E0E0', '#EA4335'],
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // --- Chart 2: Competitiveness ---
    function drawCompetitiveness() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', ourBrand);
        top3Brands.forEach(b => data.addColumn('number', b));
        data.addColumn('number', 'Others');

        const rows = weeks.map(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            
            // Calc shares
            const getShare = (brand) => {
                const items = weekData.filter(d => getBrand(d) === brand);
                return items.reduce((s,x) => s + (x.click_share||0), 0);
            };

            const ourShare = getShare(ourBrand);
            const compShares = top3Brands.map(b => getShare(b));
            
            // Others
            const allShare = weekData.reduce((s,x) => s + (x.click_share||0), 0);
            const accounted = ourShare + compShares.reduce((a,b)=>a+b, 0);
            const otherShare = Math.max(0, allShare - accounted); // Simplified logic

            return [w, ourShare, ...compShares, otherShare];
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            legend: { position: 'bottom' },
            vAxis: { format: 'percent' },
            chartArea: { width: '90%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);

        // Populate Top 3 Table
        const tbody = document.querySelector("#table_top_competitors tbody");
        topCompetitors.forEach(c => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${c.brand}</td><td>${(c.avgShare*100).toFixed(1)}%</td><td>$${c.avgPrice.toFixed(2)}</td>`;
            tbody.appendChild(tr);
        });
    }

    // --- Chart 3: Palancas (Last Week) ---
    function drawPalancas() {
        // Compare Our Price vs Market Avg Price vs Share
        const lastWeekData = marketData.filter(d => d.week_date === lastWeek);
        const ourItems = lastWeekData.filter(d => getBrand(d) === ourBrand);
        const compItems = lastWeekData.filter(d => getBrand(d) !== ourBrand);

        const avgPriceUs = ourItems.reduce((a,b)=>a+b.price,0) / (ourItems.length||1);
        const avgPriceMkt = compItems.reduce((a,b)=>a+b.price,0) / (compItems.length||1);
        
        // Deals count
        const dealsUs = ourItems.filter(d => d.weekly_number_of_days_with_deal > 0).length;
        const dealsComp = compItems.filter(d => d.weekly_number_of_days_with_deal > 0).length;

        const data = google.visualization.arrayToDataTable([
            ['Metric', 'Us', 'Competitors (Avg)'],
            ['Price ($)', avgPriceUs, avgPriceMkt],
            ['Active Deals (#)', dealsUs, dealsComp],
        ]);

        const options = {
            bars: 'horizontal',
            colors: ['#4285F4', '#9AA0A6'],
            legend: { position: 'bottom' }
        };
        
        // Using BarChart
        const chart = new google.visualization.BarChart(document.getElementById('chart_palancas'));
        chart.draw(data, options);
    }

    // --- Chart 4: Efficiency (Scatter) ---
    function drawEfficiency() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank (Lower is Better)');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'tooltip'});
        data.addColumn({type: 'string', role: 'style'}); // Color

        const lastWeekData = marketData.filter(d => d.week_date === lastWeek);
        
        const rows = lastWeekData.map(d => {
            const isUs = getBrand(d) === ourBrand;
            const color = isUs ? 'point { fill-color: #4285F4; size: 10; }' : 'point { fill-color: #9AA0A6; }';
            return [d.organic_rank, d.click_share, `${getBrand(d)}: Rank ${d.organic_rank}, Share ${(d.click_share*100).toFixed(1)}%`, color];
        });

        data.addRows(rows);

        const options = {
            hAxis: { title: 'Organic Rank', direction: -1 }, // Reverse so 1 is right (or keep standard left) -> Let's keep standard: 1 on left.
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            chartArea: { width: '85%', height: '80%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- KPIs ---
    function populateKPIs() {
        const getData = (w) => {
            const weekD = marketData.filter(d => d.week_date === w);
            const us = weekD.filter(d => getBrand(d) === ourBrand);
            const allClicks = weekD.reduce((a,b)=>a+(b.clicks||0),0);
            const usShare = us.reduce((a,b)=>a+(b.click_share||0),0);
            const usRank = us.reduce((a,b)=>a+b.organic_rank,0) / (us.length||1);
            return { clicks: allClicks, share: usShare, rank: usRank };
        };

        const curr = getData(lastWeek);
        const prev = prevWeek ? getData(prevWeek) : curr;

        // Render
        document.getElementById('kpiClicks').innerText = curr.clicks.toLocaleString();
        document.getElementById('kpiShare').innerText = (curr.share * 100).toFixed(1) + '%';
        document.getElementById('kpiRank').innerText = curr.rank.toFixed(1);

        // Trends
        const setTrend = (id, val, isInverse=false) => {
            const el = document.getElementById(id);
            const diff = isInverse ? (prev.rank - curr.rank) : (val - (id.includes('Share')?prev.share:prev.clicks)); 
            // Logic correction for rank: Lower is better. If prev 5, curr 3 -> Diff +2 (Improved)
            
            let symbol = diff > 0 ? '▲' : (diff < 0 ? '▼' : '-');
            if (diff === 0) symbol = '-';
            
            // Color logic
            const good = isInverse ? (curr.rank < prev.rank) : (val > (id.includes('Share')?prev.share:prev.clicks));
            el.className = `metric-trend ${good ? 'trend-up' : (diff===0?'':'trend-down')}`;
            el.innerText = `${symbol} vs last week`;
        };

        setTrend('kpiClicksTrend', curr.clicks);
        setTrend('kpiShareTrend', curr.share);
        setTrend('kpiRankTrend', curr.rank, true);
    }

    // --- Insights Generation ---
    function generateInsights() {
        const ul = document.getElementById('insights_container');
        const insights = [];

        // 1. Trend
        const currShare = parseFloat(document.getElementById('kpiShare').innerText);
        const prevShareData = marketData.filter(d => d.week_date === prevWeek && getBrand(d) === ourBrand);
        const prevShare = prevShareData.reduce((a,b)=>a+(b.click_share||0),0) * 100;
        
        if (currShare > prevShare) {
            insights.push({icon: 'trending_up', color: 'bg-green', text: `<strong>Positive Momentum:</strong> Click Share increased from ${prevShare.toFixed(1)}% to ${currShare.toFixed(1)}% in the last week.`});
        } else {
            insights.push({icon: 'trending_down', color: 'bg-red', text: `<strong>Warning:</strong> Click Share dropped by ${(prevShare - currShare).toFixed(1)}% points.`});
        }

        // 2. Pricing
        const lastWeekUs = marketData.find(d => d.week_date === lastWeek && getBrand(d) === ourBrand);
        const lastWeekTopComp = marketData.find(d => d.week_date === lastWeek && getBrand(d) === top3Brands[0]);
        if(lastWeekUs && lastWeekTopComp) {
            const priceDiff = lastWeekUs.price - lastWeekTopComp.price;
            if(priceDiff > 0) {
                insights.push({icon: 'attach_money', color: 'bg-blue', text: `<strong>Price Premium:</strong> You are priced $${priceDiff.toFixed(2)} higher than main competitor ${top3Brands[0]}. Monitor conversion.`});
            } else {
                insights.push({icon: 'sell', color: 'bg-green', text: `<strong>Price Advantage:</strong> You are undercutting ${top3Brands[0]} by $${Math.abs(priceDiff).toFixed(2)}.`});
            }
        }

        // 3. Badges
        if(lastWeekUs && lastWeekUs.weekly_number_of_days_with_amazon_choice_badge > 0) {
             insights.push({icon: 'verified', color: 'bg-blue', text: `<strong>Visibility:</strong> Maintained Amazon Choice badge for ${lastWeekUs.weekly_number_of_days_with_amazon_choice_badge} days.`});
        }

        // 4. Recommendation
        insights.push({icon: 'lightbulb', color: 'bg-blue', text: `<strong>Action:</strong> Review keywords for ASINs where Organic Rank > 10 to recover visibility.`});

        // Render
        ul.innerHTML = insights.map(i => `
            <li>
                <div class="icon-box ${i.color}"><span class="material-icons" style="font-size:16px">${i.icon}</span></div>
                <div>${i.text}</div>
            </li>
        `).join('');
    }

    // --- Interactive Logic ---
    function setupInteractive() {
        const selWeek = document.getElementById('selWeek');
        const selComp = document.getElementById('selCompetitor');
        
        weeks.forEach(w => selWeek.add(new Option(w, w)));
        selWeek.value = lastWeek;

        top3Brands.forEach(b => selComp.add(new Option(b, b)));
        
        updateInteractive();
    }

    function updateInteractive() {
        const w = document.getElementById('selWeek').value;
        const compName = document.getElementById('selCompetitor').value;

        // Filter data
        const weekData = marketData.filter(d => d.week_date === w);
        const usData = weekData.find(d => getBrand(d) === ourBrand) || {};
        const compData = weekData.find(d => getBrand(d) === compName) || {};

        // 1. Table
        const metrics = [
            { label: 'Click Share', us: (usData.click_share||0)*100, comp: (compData.click_share||0)*100, fmt: '%' },
            { label: 'Avg Rank', us: usData.organic_rank||0, comp: compData.organic_rank||0, fmt: '' },
            { label: 'Price', us: usData.price||0, comp: compData.price||0, fmt: '$' },
            { label: 'Deal Days', us: usData.weekly_number_of_days_with_deal||0, comp: compData.weekly_number_of_days_with_deal||0, fmt: '' }
        ];

        let html = `<table class="simple-table"><thead><tr><th>Metric</th><th>Us (${ourBrand})</th><th>${compName}</th><th>Diff</th></tr></thead><tbody>`;
        metrics.forEach(m => {
            const diff = m.us - m.comp;
            const color = diff > 0 ? 'color:blue' : 'color:red'; // Naive color
            html += `<tr>
                <td>${m.label}</td>
                <td>${m.fmt === '$' ? '$' : ''}${m.us.toFixed(2)}${m.fmt === '%' ? '%' : ''}</td>
                <td>${m.fmt === '$' ? '$' : ''}${m.comp.toFixed(2)}${m.fmt === '%' ? '%' : ''}</td>
                <td style="${color}">${diff > 0 ? '+' : ''}${diff.toFixed(2)}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('table_interactive').innerHTML = html;

        // 2. Price Chart (Just a simple visual comparison)
        const data = google.visualization.arrayToDataTable([
            ['Brand', 'Price', { role: 'style' }],
            ['Us', usData.price || 0, '#4285F4'],
            [compName, compData.price || 0, '#EA4335']
        ]);
        const chart = new google.visualization.ColumnChart(document.getElementById('chart_interactive_price'));
        chart.draw(data, { legend: 'none', vAxis: { title: 'Price ($)' } });
    }

    // --- UI Helpers ---
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');

        if(tabName === 'static') {
            document.getElementById('tab-static').classList.remove('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
        } else {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.remove('hidden');
            updateInteractive(); // Refresh chart size
        }
    };

    // Responsive Redraw
    window.onresize = function() {
        drawDashboard();
    };

</script>
</body>
</html>