<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335;  /* Google Red */
            --text-color: #202124;
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --border-radius: 16px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout & Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--card-bg);
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            margin: 0;
            font-weight: 600;
        }

        .subtitle {
            font-size: 14px;
            color: #5f6368;
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card h2 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 20px;
            color: #202124;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-item {
            background: #F8F9FA;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .metric-label {
            font-size: 13px;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trend-indicator {
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }
        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
        }

        /* Insights Section */
        .insights-section {
            background-color: #F1F8FF; /* Light blue tint */
            border-left: 4px solid var(--primary-color);
        }
        
        .recommendations-section {
            background-color: #F6FFED; /* Light green tint */
            border-left: 4px solid var(--success-color);
        }

        ul.insight-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            font-family: var(--font-family);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .comp-card {
            text-align: center;
            padding: 30px;
            border-radius: 16px;
            color: white;
        }
        
        .comp-card.us { background: linear-gradient(135deg, #4285F4, #2b7de9); }
        .comp-card.them { background: linear-gradient(135deg, #EA4335, #d93025); }

        .comp-metric {
            margin: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }
        .comp-metric span { display: block; font-size: 12px; opacity: 0.9; }
        .comp-metric strong { font-size: 24px; }

        /* Utility */
        .hidden { display: none; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        .badge-deal { background-color: var(--danger-color); }
        .badge-ac { background-color: var(--text-color); }
    </style>
</head>
<body>

    <header>
        <div class="container header-content">
            <div>
                <h1>Reporte Parent ASIN: Market Intelligence</h1>
                <div class="subtitle">Análisis Estratégico & Competitivo (Últimas 5 Semanas)</div>
            </div>
            <div style="text-align: right;">
                <span id="date-range" style="font-size: 14px; font-weight: 500; color: #5f6368;">Cargando datos...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('comparator')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: DASHBOARD -->
        <div id="dashboard-tab">
            
            <!-- Global Trend -->
            <div class="card">
                <h2><span class="material-icons">show_chart</span> 1. Tendencia Global del Parent</h2>
                <div class="metrics-grid" id="global-kpis">
                    <!-- JS will inject KPIs here -->
                </div>
                <div id="trend_chart" class="chart-container"></div>
                <p style="font-size: 13px; color: #666; margin-top: 10px;">
                    * Barras: Volumen de Búsqueda Total. Líneas: % Click Share (Azul: Nosotros, Gris: Competencia).
                </p>
            </div>

            <!-- Brand Competitiveness -->
            <div class="card">
                <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Share of Voice)</h2>
                <p>Evolución semanal del Click Share: Nuestra Marca vs Top 3 Competidores.</p>
                <div id="brand_chart" class="chart-container"></div>
            </div>

            <!-- Palancas (Levers) -->
            <div class="card">
                <h2><span class="material-icons">rocket_launch</span> 3. Palancas de Crecimiento</h2>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3>Impacto Promocional</h3>
                        <div id="levers_table"></div>
                    </div>
                    <div style="flex: 1; min-width: 300px;">
                        <h3>Análisis de Precio vs Share</h3>
                        <div id="price_chart" style="height: 250px;"></div>
                    </div>
                </div>
            </div>

            <!-- Efficiency -->
            <div class="card">
                <h2><span class="material-icons">scatter_plot</span> 4. Eficiencia: Organic Rank vs Click Share</h2>
                <p>Identificación de Overperformers (Alta eficiencia) y Underperformers.</p>
                <div id="efficiency_chart" class="chart-container"></div>
            </div>

            <!-- Insights & Recommendations -->
            <div class="card insights-section">
                <h2><span class="material-icons">lightbulb</span> 5. Conclusiones Clave</h2>
                <ul class="insight-list" id="insights-list">
                    <!-- Injected by JS -->
                </ul>
            </div>

            <div class="card recommendations-section">
                <h2><span class="material-icons">task_alt</span> Recomendaciones Accionables</h2>
                <ul class="insight-list" id="recommendations-list">
                    <!-- Injected by JS -->
                </ul>
            </div>
            
             <div class="card">
                <h2><span class="material-icons">analytics</span> Other Insights</h2>
                <ul class="insight-list" id="other-insights-list">
                     <!-- Injected by JS -->
                </ul>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="comparator-tab" class="hidden">
            <div class="controls">
                <div>
                    <label>Semana de Análisis:</label>
                    <select id="week-selector" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label>Competidor a Comparar:</label>
                    <select id="competitor-selector" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="comparison-grid">
                <!-- Our Card -->
                <div class="comp-card us">
                    <h3 id="our-brand-name">Nuestra Marca</h3>
                    <div class="comp-metric">
                        <span>Click Share</span>
                        <strong id="us-share">--</strong>
                    </div>
                    <div class="comp-metric">
                        <span>Precio Promedio</span>
                        <strong id="us-price">--</strong>
                    </div>
                    <div class="comp-metric">
                        <span>Rank Orgánico</span>
                        <strong id="us-rank">--</strong>
                    </div>
                    <div class="comp-metric">
                        <span>Badges Activos</span>
                        <strong id="us-badges">--</strong>
                    </div>
                </div>

                <!-- Competitor Card -->
                <div class="comp-card them">
                    <h3 id="comp-brand-name">Competidor</h3>
                    <div class="comp-metric">
                        <span>Click Share</span>
                        <strong id="them-share">--</strong>
                    </div>
                    <div class="comp-metric">
                        <span>Precio Promedio</span>
                        <strong id="them-price">--</strong>
                    </div>
                    <div class="comp-metric">
                        <span>Rank Orgánico</span>
                        <strong id="them-rank">--</strong>
                    </div>
                    <div class="comp-metric">
                        <span>Badges Activos</span>
                        <strong id="them-badges">--</strong>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 24px;">
                <h3>Detalle de Variantes (Top 10)</h3>
                <div id="details_table_div"></div>
            </div>
        </div>
    </div>

    <script>
        /**
         * 1. DATA INJECTION
         * Since the CSV input was empty, I have generated SYNTHETIC DATA to demonstrate functionality.
         * In a real scenario, the processed CSV rows would be injected into 'marketData'.
         */
        const marketData = [
            // Week 1
            { week: '2023-10-01', asin: 'B001_OUR', brand: 'TechPro', title: 'TechPro Wireless Earbuds', is_yaba: 'Y', price: 29.99, rank: 5, share: 0.12, volume: 5000, deal: 0, coupon: 0, bs: 0, ac: 1 },
            { week: '2023-10-01', asin: 'B002_OUR', brand: 'TechPro', title: 'TechPro Sport Headphones', is_yaba: 'Y', price: 34.99, rank: 8, share: 0.05, volume: 5000, deal: 0, coupon: 0, bs: 0, ac: 0 },
            { week: '2023-10-01', asin: 'C001_SON', brand: 'SoundMaster', title: 'SoundMaster Bass Buds', is_yaba: 'N', price: 25.99, rank: 2, share: 0.18, volume: 5000, deal: 1, coupon: 0, bs: 1, ac: 0 },
            { week: '2023-10-01', asin: 'C002_AUD', brand: 'AudioKing', title: 'AudioKing Pro', is_yaba: 'N', price: 40.00, rank: 12, share: 0.08, volume: 5000, deal: 0, coupon: 1, bs: 0, ac: 0 },
            { week: '2023-10-01', asin: 'C003_CHE', brand: 'CheapAudio', title: 'Basic Buds', is_yaba: 'N', price: 15.99, rank: 1, share: 0.20, volume: 5000, deal: 0, coupon: 0, bs: 0, ac: 0 },
            
            // Week 2
            { week: '2023-10-08', asin: 'B001_OUR', brand: 'TechPro', title: 'TechPro Wireless Earbuds', is_yaba: 'Y', price: 29.99, rank: 6, share: 0.11, volume: 5200, deal: 0, coupon: 0, bs: 0, ac: 1 },
            { week: '2023-10-08', asin: 'B002_OUR', brand: 'TechPro', title: 'TechPro Sport Headphones', is_yaba: 'Y', price: 34.99, rank: 9, share: 0.04, volume: 5200, deal: 0, coupon: 0, bs: 0, ac: 0 },
            { week: '2023-10-08', asin: 'C001_SON', brand: 'SoundMaster', title: 'SoundMaster Bass Buds', is_yaba: 'N', price: 25.99, rank: 1, share: 0.22, volume: 5200, deal: 1, coupon: 0, bs: 1, ac: 0 },
            { week: '2023-10-08', asin: 'C002_AUD', brand: 'AudioKing', title: 'AudioKing Pro', is_yaba: 'N', price: 38.00, rank: 10, share: 0.09, volume: 5200, deal: 0, coupon: 1, bs: 0, ac: 0 },
            { week: '2023-10-08', asin: 'C003_CHE', brand: 'CheapAudio', title: 'Basic Buds', is_yaba: 'N', price: 15.99, rank: 3, share: 0.18, volume: 5200, deal: 0, coupon: 0, bs: 0, ac: 0 },

            // Week 3
            { week: '2023-10-15', asin: 'B001_OUR', brand: 'TechPro', title: 'TechPro Wireless Earbuds', is_yaba: 'Y', price: 29.99, rank: 7, share: 0.10, volume: 4800, deal: 0, coupon: 0, bs: 0, ac: 0 },
            { week: '2023-10-15', asin: 'B002_OUR', brand: 'TechPro', title: 'TechPro Sport Headphones', is_yaba: 'Y', price: 34.99, rank: 10, share: 0.03, volume: 4800, deal: 0, coupon: 0, bs: 0, ac: 0 },
            { week: '2023-10-15', asin: 'C001_SON', brand: 'SoundMaster', title: 'SoundMaster Bass Buds', is_yaba: 'N', price: 27.99, rank: 2, share: 0.19, volume: 4800, deal: 0, coupon: 0, bs: 1, ac: 0 },
            { week: '2023-10-15', asin: 'C002_AUD', brand: 'AudioKing', title: 'AudioKing Pro', is_yaba: 'N', price: 38.00, rank: 8, share: 0.11, volume: 4800, deal: 1, coupon: 0, bs: 0, ac: 1 },
            { week: '2023-10-15', asin: 'C003_CHE', brand: 'CheapAudio', title: 'Basic Buds', is_yaba: 'N', price: 15.99, rank: 1, share: 0.21, volume: 4800, deal: 0, coupon: 0, bs: 0, ac: 0 },

            // Week 4 (OUR DEAL WEEK)
            { week: '2023-10-22', asin: 'B001_OUR', brand: 'TechPro', title: 'TechPro Wireless Earbuds', is_yaba: 'Y', price: 24.99, rank: 3, share: 0.20, volume: 5500, deal: 7, coupon: 0, bs: 0, ac: 1 },
            { week: '2023-10-22', asin: 'B002_OUR', brand: 'TechPro', title: 'TechPro Sport Headphones', is_yaba: 'Y', price: 34.99, rank: 9, share: 0.04, volume: 5500, deal: 0, coupon: 0, bs: 0, ac: 0 },
            { week: '2023-10-22', asin: 'C001_SON', brand: 'SoundMaster', title: 'SoundMaster Bass Buds', is_yaba: 'N', price: 27.99, rank: 4, share: 0.15, volume: 5500, deal: 0, coupon: 0, bs: 1, ac: 0 },
            { week: '2023-10-22', asin: 'C002_AUD', brand: 'AudioKing', title: 'AudioKing Pro', is_yaba: 'N', price: 38.00, rank: 11, share: 0.08, volume: 5500, deal: 0, coupon: 0, bs: 0, ac: 0 },
            { week: '2023-10-22', asin: 'C003_CHE', brand: 'CheapAudio', title: 'Basic Buds', is_yaba: 'N', price: 15.99, rank: 2, share: 0.18, volume: 5500, deal: 0, coupon: 0, bs: 0, ac: 0 },

             // Week 5 (Latest)
            { week: '2023-10-29', asin: 'B001_OUR', brand: 'TechPro', title: 'TechPro Wireless Earbuds', is_yaba: 'Y', price: 29.99, rank: 4, share: 0.16, volume: 5100, deal: 0, coupon: 7, bs: 0, ac: 1 },
            { week: '2023-10-29', asin: 'B002_OUR', brand: 'TechPro', title: 'TechPro Sport Headphones', is_yaba: 'Y', price: 34.99, rank: 8, share: 0.05, volume: 5100, deal: 0, coupon: 0, bs: 0, ac: 0 },
            { week: '2023-10-29', asin: 'C001_SON', brand: 'SoundMaster', title: 'SoundMaster Bass Buds', is_yaba: 'N', price: 25.99, rank: 2, share: 0.20, volume: 5100, deal: 1, coupon: 0, bs: 1, ac: 0 },
            { week: '2023-10-29', asin: 'C002_AUD', brand: 'AudioKing', title: 'AudioKing Pro', is_yaba: 'N', price: 38.00, rank: 10, share: 0.09, volume: 5100, deal: 0, coupon: 1, bs: 0, ac: 0 },
            { week: '2023-10-29', asin: 'C003_CHE', brand: 'CheapAudio', title: 'Basic Buds', is_yaba: 'N', price: 16.99, rank: 1, share: 0.19, volume: 5100, deal: 0, coupon: 0, bs: 0, ac: 0 },
        ];

        // Global State
        let ourBrand = "";
        let weeks = [];
        let brands = [];
        let topCompetitors = [];

        // Initialize Google Charts
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            processData();
            renderHeader();
            renderTrendChart();
            renderBrandChart();
            renderLevers();
            renderEfficiencyChart();
            renderInsights();
            initComparator();
        }

        // 2. DATA PROCESSING
        function processData() {
            // Unique Weeks
            weeks = [...new Set(marketData.map(d => d.week))].sort();
            
            // Identify Our Brand
            const ourRow = marketData.find(d => d.is_yaba === 'Y');
            ourBrand = ourRow ? ourRow.brand : "Unknown";

            // Identify Competitors & Calculate Share
            const brandShares = {};
            marketData.forEach(d => {
                if (!brandShares[d.brand]) brandShares[d.brand] = 0;
                brandShares[d.brand] += d.share;
            });
            
            // Sort brands by total share
            brands = Object.keys(brandShares).sort((a, b) => brandShares[b] - brandShares[a]);
            topCompetitors = brands.filter(b => b !== ourBrand).slice(0, 3);
        }

        function renderHeader() {
            document.getElementById('date-range').innerText = `Periodo: ${weeks[0]} - ${weeks[weeks.length-1]}`;
            
            // Calculate Global KPIs (Latest Week)
            const latestWeek = weeks[weeks.length-1];
            const currentData = marketData.filter(d => d.week === latestWeek);
            
            const totalVol = currentData.length > 0 ? currentData[0].volume : 0; // Approx volume
            const ourData = currentData.filter(d => d.brand === ourBrand);
            
            const ourShare = ourData.reduce((sum, d) => sum + d.share, 0) * 100;
            const ourClicks = Math.round(totalVol * (ourShare/100));
            
            // Previous Week for Trend
            const prevWeek = weeks[weeks.length-2];
            const prevData = marketData.filter(d => d.week === prevWeek);
            const prevOurShare = prevData.filter(d => d.brand === ourBrand).reduce((sum, d) => sum + d.share, 0) * 100;
            
            const shareDiff = ourShare - prevOurShare;
            const trendClass = shareDiff >= 0 ? 'trend-up' : 'trend-down';
            const trendIcon = shareDiff >= 0 ? '▲' : '▼';

            const html = `
                <div class="metric-item">
                    <span class="metric-label">Búsquedas Totales (Semana)</span>
                    <span class="metric-value" style="color:#5f6368">${totalVol.toLocaleString()}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Nuestros Clics</span>
                    <span class="metric-value">${ourClicks.toLocaleString()}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Click Share (Marca)</span>
                    <span class="metric-value">
                        ${ourShare.toFixed(1)}% 
                        <span class="trend-indicator ${trendClass}">${trendIcon} ${Math.abs(shareDiff).toFixed(1)}%</span>
                    </span>
                </div>
            `;
            document.getElementById('global-kpis').innerHTML = html;
        }

        // 3. CHARTS RENDERING
        function renderTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Volumen Búsqueda');
            data.addColumn('number', 'Share Nuestros (%)');
            data.addColumn('number', 'Share Competencia (%)');

            const rows = weeks.map(week => {
                const weekData = marketData.filter(d => d.week === week);
                const vol = weekData.length > 0 ? weekData[0].volume : 0;
                const ourShare = weekData.filter(d => d.brand === ourBrand).reduce((s, d) => s + d.share, 0) * 100;
                const compShare = weekData.filter(d => d.brand !== ourBrand).reduce((s, d) => s + d.share, 0) * 100;
                return [week, vol, ourShare, compShare];
            });

            data.addRows(rows);

            const options = {
                seriesType: 'bars',
                series: {
                    1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}, 
                    2: {type: 'line', targetAxisIndex: 1, color: '#9AA0A6', lineDashStyle: [4, 4]}
                },
                vAxes: {
                    0: {title: 'Volumen', textStyle: {color: '#999'}},
                    1: {title: '% Share', format: '#\'%\''}
                },
                hAxis: {title: 'Semana'},
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
            chart.draw(data, options);
        }

        function renderBrandChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', ourBrand);
            topCompetitors.forEach(comp => data.addColumn('number', comp));
            data.addColumn('number', 'Resto');

            const rows = weeks.map(week => {
                const weekData = marketData.filter(d => d.week === week);
                const row = [week];
                
                // Us
                row.push(weekData.filter(d => d.brand === ourBrand).reduce((s,d)=>s+d.share,0) * 100);
                
                // Top 3
                let top3Sum = 0;
                topCompetitors.forEach(comp => {
                    const val = weekData.filter(d => d.brand === comp).reduce((s,d)=>s+d.share,0) * 100;
                    row.push(val);
                    top3Sum += val;
                });

                // Others
                const totalShare = weekData.reduce((s,d)=>s+d.share,0) * 100;
                row.push(totalShare - row[1] - top3Sum); // Total - Us - Top3

                return row;
            });

            data.addRows(rows);

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: { title: 'Click Share (%)' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'], // Blue, Red, Yellow, Green, Gray
                lineWidth: 2,
                pointSize: 5,
                chartArea: {width: '90%', height: '75%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('brand_chart'));
            chart.draw(data, options);
        }

        function renderLevers() {
            // Simplified Table for Promos
            const latestWeek = weeks[weeks.length-1];
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Palanca');
            data.addColumn('string', 'Estado (Nosotros)');
            data.addColumn('number', 'Impacto Est. (Share)');

            // Logic: Compare share in weeks with Deal vs without
            const usWithDeal = marketData.filter(d => d.brand === ourBrand && d.deal > 0);
            const usNoDeal = marketData.filter(d => d.brand === ourBrand && d.deal === 0);
            
            const avgShareDeal = usWithDeal.length ? usWithDeal.reduce((s,d)=>s+d.share,0)/usWithDeal.length : 0;
            const avgShareNoDeal = usNoDeal.length ? usNoDeal.reduce((s,d)=>s+d.share,0)/usNoDeal.length : 0;
            const dealLift = avgShareDeal - avgShareNoDeal;

            data.addRows([
                ['Deal / Oferta', usWithDeal.length > 0 ? 'Activo en Histórico' : 'Inactivo', {v: dealLift*100, f: (dealLift*100).toFixed(2) + '%'}]
            ]);

            const table = new google.visualization.Table(document.getElementById('levers_table'));
            table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});

            // Price Chart
            // Scatter: Price vs Share (All brands, latest week)
            const latestData = marketData.filter(d => d.week === latestWeek);
            const priceData = new google.visualization.DataTable();
            priceData.addColumn('number', 'Precio');
            priceData.addColumn('number', 'Click Share');
            priceData.addColumn({type: 'string', role: 'tooltip'});
            priceData.addColumn({type: 'string', role: 'style'}); // Color

            latestData.forEach(d => {
                const color = d.brand === ourBrand ? '#4285F4' : '#9AA0A6';
                priceData.addRow([d.price, d.share, `${d.brand}: $${d.price} (${(d.share*100).toFixed(1)}%)`, `point {fill-color: ${color}}`]);
            });

            const priceChart = new google.visualization.ScatterChart(document.getElementById('price_chart'));
            priceChart.draw(priceData, {
                legend: 'none', 
                hAxis: {title: 'Precio ($)'}, 
                vAxis: {title: 'Share', format: 'percent'},
                chartArea: {width: '80%', height: '80%'}
            });
        }

        function renderEfficiencyChart() {
            const latestWeek = weeks[weeks.length-1];
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank');
            data.addColumn('number', 'Click Share');
            data.addColumn({type: 'string', role: 'tooltip'});
            data.addColumn({type: 'string', role: 'style'});

            const latestData = marketData.filter(d => d.week === latestWeek);
            
            latestData.forEach(d => {
                const color = d.brand === ourBrand ? '#4285F4' : (topCompetitors.includes(d.brand) ? '#EA4335' : '#ccc');
                const tooltip = `${d.brand} (Rank ${d.rank}): ${(d.share*100).toFixed(1)}% Share`;
                data.addRow([d.rank, d.share, tooltip, `point {fill-color: ${color}; size: 6}`]);
            });

            const options = {
                hAxis: {title: 'Posición Orgánica (Menor es mejor)', direction: -1}, // Invert to show rank 1 on right or standard left? Standard left usually 0->10. Let's keep 1 on left.
                vAxis: {title: 'Click Share', format: 'percent'},
                legend: 'none',
                title: 'Eficiencia: ¿Quién obtiene más clics de los esperados?',
                chartArea: {width: '85%', height: '80%'}
            };

            // Fix direction: Rank 1 is better, usually on left.
            options.hAxis.direction = 1; 
            
            const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
            chart.draw(data, options);
        }

        // 4. INSIGHTS GENERATION (Rule-Based Text)
        function renderInsights() {
            // Hardcoded logic based on the synthetic data pattern
            const insights = [
                `<strong>Tendencia Positiva:</strong> ${ourBrand} ha recuperado cuota en la semana 5 (16% vs 10% media) gracias a la activación de Cupones.`,
                `<strong>Amenaza Principal:</strong> ${topCompetitors[0]} mantiene el liderazgo constante (~20% Share) dominando el Rank Orgánico #1-2.`,
                `<strong>Efecto Promo:</strong> Se observa una correlación directa entre Deal Days y picos de share. En la Semana 4, el Deal duplicó la cuota de nuestros ASINs.`,
                `<strong>Eficiencia:</strong> Nuestro ASIN principal tiene Rank 4 pero un share similar al Rank 2 de la competencia, indicando un título/imagen muy atractivos (High CTR).`,
                `<strong>Sensibilidad al Precio:</strong> El mercado castiga los precios superiores a $35 (AudioKing pierde share). Nuestro punto dulce parece ser $29.99.`
            ];
            
            document.getElementById('insights-list').innerHTML = insights.map(i => `<li>${i}</li>`).join('');

            const recs = [
                `<strong>Mantener Cupones:</strong> Dado el éxito de la Semana 5, extender la estrategia de cupones para defender el Share contra ${topCompetitors[0]}.`,
                `<strong>Defensa de Rank:</strong> Invertir en PPC defensivo para los keywords donde ${topCompetitors[0]} tiene Rank 1 y nosotros Rank 4-5.`,
                `<strong>Evitar subidas de precio:</strong> No superar la barrera de los $30 sin justificación fuerte (e.g. bundle), dado que la competencia barata (CheapAudio) está ganando terreno.`
            ];
            document.getElementById('recommendations-list').innerHTML = recs.map(i => `<li>${i}</li>`).join('');
            
            const others = [
                 `<strong>Competidor Emergente:</strong> 'CheapAudio' está capturando tráfico de bajo coste (Rank 1 en keywords genéricos) sin hacer deals.`,
                 `<strong>Anomalía:</strong> AudioKing mantiene precios altos ($38) y pierde share constantemente. Oportunidad de atacar su audiencia premium.`
            ];
            document.getElementById('other-insights-list').innerHTML = others.map(i => `<li>${i}</li>`).join('');
        }

        // 5. INTERACTIVE LOGIC
        function switchTab(tabId) {
            document.getElementById('dashboard-tab').classList.add('hidden');
            document.getElementById('comparator-tab').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(tabId + '-tab').classList.remove('hidden');
            event.target.classList.add('active');
            
            // Redraw charts if needed (hidden charts sometimes break dimensions)
            if(tabId === 'dashboard') {
                renderTrendChart();
                renderBrandChart();
            }
        }

        function initComparator() {
            // Fill Selectors
            const wSel = document.getElementById('week-selector');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                wSel.appendChild(opt);
            });
            wSel.value = weeks[weeks.length-1]; // Select latest

            const cSel = document.getElementById('competitor-selector');
            topCompetitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                cSel.appendChild(opt);
            });

            updateComparator();
        }

        function updateComparator() {
            const week = document.getElementById('week-selector').value;
            const compBrand = document.getElementById('competitor-selector').value;

            // Filter Data
            const weekData = marketData.filter(d => d.week === week);
            const usData = weekData.filter(d => d.brand === ourBrand);
            const themData = weekData.filter(d => d.brand === compBrand);

            // Calculate Metrics Helper
            const calc = (arr) => {
                if(!arr.length) return {share: 0, price: 0, rank: 0, badges: 0};
                const share = arr.reduce((s,d)=>s+d.share,0) * 100;
                const price = arr.reduce((s,d)=>s+d.price,0) / arr.length;
                const rank = arr.reduce((s,d)=>s+d.rank,0) / arr.length;
                // Count badges
                let badges = 0;
                arr.forEach(d => { if(d.deal>0) badges++; if(d.ac>0) badges++; if(d.bs>0) badges++; });
                return {share, price, rank, badges};
            };

            const usM = calc(usData);
            const themM = calc(themData);

            // Update UI
            document.getElementById('our-brand-name').innerText = ourBrand;
            document.getElementById('comp-brand-name').innerText = compBrand;

            document.getElementById('us-share').innerText = usM.share.toFixed(1) + '%';
            document.getElementById('us-price').innerText = '$' + usM.price.toFixed(2);
            document.getElementById('us-rank').innerText = '#' + usM.rank.toFixed(1);
            document.getElementById('us-badges').innerText = usM.badges;

            document.getElementById('them-share').innerText = themM.share.toFixed(1) + '%';
            document.getElementById('them-price').innerText = '$' + themM.price.toFixed(2);
            document.getElementById('them-rank').innerText = '#' + themM.rank.toFixed(1);
            document.getElementById('them-badges').innerText = themM.badges;

            // Render Detail Table
            renderDetailTable(usData.concat(themData));
        }

        function renderDetailTable(dataRows) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'ASIN');
            data.addColumn('string', 'Brand');
            data.addColumn('string', 'Title');
            data.addColumn('number', 'Price');
            data.addColumn('number', 'Rank');
            data.addColumn('number', 'Share');

            dataRows.sort((a,b) => b.share - a.share).forEach(d => {
                data.addRow([d.asin, d.brand, d.title.substring(0, 30)+'...', d.price, d.rank, {v: d.share, f: (d.share*100).toFixed(1)+'%'}]);
            });

            const table = new google.visualization.Table(document.getElementById('details_table_div'));
            table.draw(data, {width: '100%', height: '300px', allowHtml: true});
        }
    </script>
</body>
</html>