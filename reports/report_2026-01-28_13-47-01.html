<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIN Performance Report - Executive Summary</title>
    
    <!-- Google Native Dependencies -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    
    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-muted: #5F6368;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            margin-bottom: 30px;
        }
        h1 {
            font-size: 24px;
            font-weight: 400;
            margin: 0;
            color: var(--text-main);
        }
        .subtitle {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .col-12 { grid-column: span 12; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            .col-6, .col-4 { grid-column: span 12; }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-main);
        }
        .chart-container {
            flex-grow: 1;
            min-height: 300px;
        }

        /* Insights Section */
        .insight-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon {
            margin-right: 12px;
            color: var(--primary-color);
        }
        .insight-text { font-size: 13px; line-height: 1.5; }
        .insight-title { font-weight: 700; display: block; margin-bottom: 2px; }

        /* Recommendations */
        .rec-item {
            background-color: #E8F0FE;
            color: #1967D2;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
        }
        .rec-item i { margin-right: 8px; font-size: 18px; }

        /* KPI Badges */
        .kpi-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .kpi-badge {
            background: #f1f3f4;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }
        .trend-up { color: var(--secondary-color); }
        .trend-down { color: var(--danger-color); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: inherit;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Amazon Parent ASIN Analytics</h1>
        <div class="subtitle" id="reportSubtitle">Performance analysis for Parent ASIN (Last 5 Weeks)</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTATICO -->
    <div id="tab-static">
        <!-- Section 1: Global Trend -->
        <div class="grid">
            <div class="card col-12">
                <div class="card-header">
                    <span class="card-title">1. Tendencia Global del Parent (All Keywords)</span>
                    <i class="material-icons" style="color:var(--text-muted)">trending_up</i>
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="grid">
            <div class="card col-12">
                <div class="card-header">
                    <span class="card-title">2. Competitividad de Marca (Click Share History)</span>
                    <i class="material-icons" style="color:var(--text-muted)">people</i>
                </div>
                <div id="chart_brand_comp" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div class="grid">
            <div class="card col-6">
                <div class="card-header">
                    <span class="card-title">3. Impacto de Palancas (Precio/Deals)</span>
                    <i class="material-icons" style="color:var(--text-muted)">local_offer</i>
                </div>
                <div id="chart_levers" class="chart-container"></div>
            </div>
            <div class="card col-6">
                <div class="card-header">
                    <span class="card-title">4. Eficiencia: Organic Rank vs Share</span>
                    <i class="material-icons" style="color:var(--text-muted)">scatter_plot</i>
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 5: Insights & Recommendations -->
        <div class="grid">
            <div class="card col-6">
                <div class="card-header">
                    <span class="card-title">5. Insights Clave (Generados por IA)</span>
                    <i class="material-icons" style="color:var(--warning-color)">lightbulb</i>
                </div>
                <div id="insights_container">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="card col-6">
                <div class="card-header">
                    <span class="card-title">Recomendaciones Accionables</span>
                    <i class="material-icons" style="color:var(--primary-color)">assignment_turned_in</i>
                </div>
                <div id="recommendations_container">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 2: INTERACTIVO -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label>Semana de Análisis:</label>
                <select id="weekSelect" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label>Competidor a Comparar:</label>
                <select id="compSelect" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="grid">
            <div class="card col-4">
                <div class="card-header">
                    <span class="card-title">Cara a Cara: Precio</span>
                </div>
                <div id="chart_compare_price" class="chart-container" style="height: 200px; min-height: 200px;"></div>
            </div>
            <div class="card col-4">
                <div class="card-header">
                    <span class="card-title">Cara a Cara: Click Share</span>
                </div>
                <div id="chart_compare_share" class="chart-container" style="height: 200px; min-height: 200px;"></div>
            </div>
            <div class="card col-4">
                <div class="card-header">
                    <span class="card-title">Cara a Cara: Promociones Activas</span>
                </div>
                <div id="promo_status" style="padding: 20px; font-size: 14px;"></div>
            </div>
        </div>
        
        <div class="grid">
            <div class="card col-12">
                <div class="card-header">
                    <span class="card-title">Detalle de ASINs (Tabla)</span>
                </div>
                <div id="table_details" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // -------------------------------------------------------------------------
    // 1. DATA INJECTION (PROCESSED MOCK DATA FROM PYTHON STEP)
    // -------------------------------------------------------------------------
    const marketData = [{"week_date": "2023-10-01", "asin": "B00YABA001", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Pro Ergo Mouse", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.22, "weekly_search_volume": 5363, "clicks": 1179, "price": 20.0, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 120, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-01", "asin": "B00YABA002", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Air Lightweight", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.2, "weekly_search_volume": 5363, "clicks": 1072, "price": 20.0, "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 90, "container": "blister", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-01", "asin": "B00COMP001", "parent_asin": "PARENT_ABC123", "product_title": "LogiTechy Master 3", "competitor_brand": "LogiTechy", "is_yaba_asin": "N", "click_share": 0.311, "weekly_search_volume": 5363, "clicks": 1667, "price": 25.0, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 140, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-01", "asin": "B00COMP002", "parent_asin": "PARENT_ABC123", "product_title": "RazerSharp Gamer X", "competitor_brand": "RazerSharp", "is_yaba_asin": "N", "click_share": 0.081, "weekly_search_volume": 5363, "clicks": 434, "price": 15.0, "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 110, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-01", "asin": "B00COMP003", "parent_asin": "PARENT_ABC123", "product_title": "Generic Wireless Mouse 2.4G Black", "competitor_brand": null, "is_yaba_asin": "N", "click_share": 0.117, "weekly_search_volume": 5363, "clicks": 627, "price": 20.0, "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 100, "container": "bag", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-08", "asin": "B00YABA001", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Pro Ergo Mouse", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.207, "weekly_search_volume": 5744, "clicks": 1189, "price": 20.0, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 120, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-08", "asin": "B00YABA002", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Air Lightweight", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.198, "weekly_search_volume": 5744, "clicks": 1137, "price": 20.0, "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 90, "container": "blister", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-08", "asin": "B00COMP001", "parent_asin": "PARENT_ABC123", "product_title": "LogiTechy Master 3", "competitor_brand": "LogiTechy", "is_yaba_asin": "N", "click_share": 0.315, "weekly_search_volume": 5744, "clicks": 1809, "price": 25.0, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 140, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-08", "asin": "B00COMP002", "parent_asin": "PARENT_ABC123", "product_title": "RazerSharp Gamer X", "competitor_brand": "RazerSharp", "is_yaba_asin": "N", "click_share": 0.1, "weekly_search_volume": 5744, "clicks": 574, "price": 15.0, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 110, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-08", "asin": "B00COMP003", "parent_asin": "PARENT_ABC123", "product_title": "Generic Wireless Mouse 2.4G Black", "competitor_brand": null, "is_yaba_asin": "N", "click_share": 0.108, "weekly_search_volume": 5744, "clicks": 620, "price": 20.0, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 100, "container": "bag", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-15", "asin": "B00YABA001", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Pro Ergo Mouse", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.198, "weekly_search_volume": 5619, "clicks": 1112, "price": 20.0, "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 120, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-15", "asin": "B00YABA002", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Air Lightweight", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.21, "weekly_search_volume": 5619, "clicks": 1179, "price": 20.0, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 90, "container": "blister", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-15", "asin": "B00COMP001", "parent_asin": "PARENT_ABC123", "product_title": "LogiTechy Master 3", "competitor_brand": "LogiTechy", "is_yaba_asin": "N", "click_share": 0.41, "weekly_search_volume": 5619, "clicks": 2303, "price": 20.0, "average_organic_rank": 2, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 140, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-15", "asin": "B00COMP002", "parent_asin": "PARENT_ABC123", "product_title": "RazerSharp Gamer X", "competitor_brand": "RazerSharp", "is_yaba_asin": "N", "click_share": 0.106, "weekly_search_volume": 5619, "clicks": 595, "price": 15.0, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 110, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-15", "asin": "B00COMP003", "parent_asin": "PARENT_ABC123", "product_title": "Generic Wireless Mouse 2.4G Black", "competitor_brand": null, "is_yaba_asin": "N", "click_share": 0.106, "weekly_search_volume": 5619, "clicks": 595, "price": 20.0, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 100, "container": "bag", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-22", "asin": "B00YABA001", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Pro Ergo Mouse", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.208, "weekly_search_volume": 5950, "clicks": 1237, "price": 20.0, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 120, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-22", "asin": "B00YABA002", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Air Lightweight", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.201, "weekly_search_volume": 5950, "clicks": 1195, "price": 20.0, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 90, "container": "blister", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-22", "asin": "B00COMP001", "parent_asin": "PARENT_ABC123", "product_title": "LogiTechy Master 3", "competitor_brand": "LogiTechy", "is_yaba_asin": "N", "click_share": 0.283, "weekly_search_volume": 5950, "clicks": 1683, "price": 25.0, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 140, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-22", "asin": "B00COMP002", "parent_asin": "PARENT_ABC123", "product_title": "RazerSharp Gamer X", "competitor_brand": "RazerSharp", "is_yaba_asin": "N", "click_share": 0.117, "weekly_search_volume": 5950, "clicks": 696, "price": 15.0, "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 110, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-22", "asin": "B00COMP003", "parent_asin": "PARENT_ABC123", "product_title": "Generic Wireless Mouse 2.4G Black", "competitor_brand": null, "is_yaba_asin": "N", "click_share": 0.105, "weekly_search_volume": 5950, "clicks": 624, "price": 20.0, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 100, "container": "bag", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-29", "asin": "B00YABA001", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Pro Ergo Mouse", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.311, "weekly_search_volume": 5863, "clicks": 1823, "price": 20.0, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 120, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-29", "asin": "B00YABA002", "parent_asin": "PARENT_ABC123", "product_title": "Pivot Air Lightweight", "competitor_brand": "Pivot", "is_yaba_asin": "Y", "click_share": 0.301, "weekly_search_volume": 5863, "clicks": 1764, "price": 20.0, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 90, "container": "blister", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-29", "asin": "B00COMP001", "parent_asin": "PARENT_ABC123", "product_title": "LogiTechy Master 3", "competitor_brand": "LogiTechy", "is_yaba_asin": "N", "click_share": 0.289, "weekly_search_volume": 5863, "clicks": 1694, "price": 25.0, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 140, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-29", "asin": "B00COMP002", "parent_asin": "PARENT_ABC123", "product_title": "RazerSharp Gamer X", "competitor_brand": "RazerSharp", "is_yaba_asin": "N", "click_share": 0.108, "weekly_search_volume": 5863, "clicks": 633, "price": 15.0, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 110, "container": "box", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}, {"week_date": "2023-10-29", "asin": "B00COMP003", "parent_asin": "PARENT_ABC123", "product_title": "Generic Wireless Mouse 2.4G Black", "competitor_brand": null, "is_yaba_asin": "N", "click_share": 0.081, "weekly_search_volume": 5863, "clicks": 474, "price": 20.0, "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 100, "container": "bag", "organic_or_not": "Organic", "keyword_link": "https://amazon.com/s?k=mouse", "keywords": "wireless mouse"}];

    // -------------------------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // -------------------------------------------------------------------------
    
    // Globals
    let processedData = [];
    let ourBrand = "";
    let topCompetitors = [];
    let weeks = [];
    let allBrands = [];

    // Helper: Extract brand from title
    function extractBrandFromTitle(title) {
        if (!title) return "Unknown";
        // Simple heuristic: First word
        return title.split(' ')[0].trim();
    }

    function processMarketData() {
        // 1. Identify Brands & Our Brand
        const ourAsins = marketData.filter(d => d.is_yaba_asin === 'Y');
        // Our Brand is the competitor_brand of our ASINs. Assuming consistent.
        if (ourAsins.length > 0) {
            ourBrand = ourAsins[0].competitor_brand;
        } else {
            ourBrand = "My Brand"; // Fallback
        }

        // 2. Enrich Data
        processedData = marketData.map(d => {
            let realBrand = d.competitor_brand;
            if (!realBrand) {
                realBrand = extractBrandFromTitle(d.product_title);
            }
            return {
                ...d,
                realBrand: realBrand
            };
        });

        // 3. Identify Top 3 Competitors (by Total Click Share)
        const brandShares = {};
        processedData.forEach(d => {
            if (d.realBrand !== ourBrand) {
                brandShares[d.realBrand] = (brandShares[d.realBrand] || 0) + d.click_share;
            }
        });
        topCompetitors = Object.entries(brandShares)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(entry => entry[0]);
        
        allBrands = [ourBrand, ...topCompetitors];
        
        // 4. Get Weeks
        weeks = [...new Set(processedData.map(d => d.week_date))].sort();

        // Populate Selectors
        const weekSel = document.getElementById('weekSelect');
        const compSel = document.getElementById('compSelect');
        
        weeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        // Set last week as default
        weekSel.value = weeks[weeks.length - 1];

        topCompetitors.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });
    }

    // Google Charts Load
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processMarketData();
        drawGlobalTrend();
        drawCompetitiveness();
        drawLevers();
        drawEfficiency();
        generateInsights();
        updateInteractive();
    }

    // -------------------------------------------------------------------------
    // 3. CHARTS DRAWING
    // -------------------------------------------------------------------------

    function drawGlobalTrend() {
        // Data: Week | My Clicks | Competitor Clicks | My Click Share (Line)
        const chartData = [['Week', 'My Clicks', 'Comp Clicks', 'My Share (%)']];
        
        weeks.forEach(w => {
            const weekData = processedData.filter(d => d.week_date === w);
            const myData = weekData.filter(d => d.realBrand === ourBrand);
            const compData = weekData.filter(d => d.realBrand !== ourBrand);

            const myClicks = myData.reduce((sum, d) => sum + d.clicks, 0);
            const compClicks = compData.reduce((sum, d) => sum + d.clicks, 0);
            
            // Calc Weighted Share for us
            const totalSearchVol = weekData.length > 0 ? weekData[0].weekly_search_volume : 1; 
            // Note: Clicks are derived. Let's use Sum of click_share for simplicity in line
            const myShareSum = myData.reduce((sum, d) => sum + d.click_share, 0);

            chartData.push([w, myClicks, compClicks, myShareSum * 100]);
        });

        const data = google.visualization.arrayToDataTable(chartData);

        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1, color: '#EA4335'}},
            colors: ['#4285F4', '#E0E0E0'], // Blue for us, Grey for comps
            vAxes: {0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''}},
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    function drawCompetitiveness() {
        // Header: Week, Us, Comp1, Comp2, Comp3
        const header = ['Week', ourBrand, ...topCompetitors];
        const rows = [];

        weeks.forEach(w => {
            const weekData = processedData.filter(d => d.week_date === w);
            const row = [w];
            
            // Us
            const usShare = weekData.filter(d => d.realBrand === ourBrand)
                                    .reduce((sum, d) => sum + d.click_share, 0);
            row.push(usShare);

            // Comps
            topCompetitors.forEach(c => {
                const cShare = weekData.filter(d => d.realBrand === c)
                                       .reduce((sum, d) => sum + d.click_share, 0);
                row.push(cShare);
            });
            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            vAxis: {format: 'percent'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    function drawLevers() {
        // Compare Avg Share with Deal vs No Deal (Global)
        // Groups: Us-NoDeal, Us-Deal, Comp-NoDeal, Comp-Deal
        
        // Simple logic: Calculate avg share lift per brand when deal > 0
        const brandsToAnalyze = [ourBrand, topCompetitors[0]]; // Analyze Top 2
        const rows = [['Condition', 'Avg Click Share']];
        
        brandsToAnalyze.forEach(b => {
            const brandData = processedData.filter(d => d.realBrand === b);
            const noDeal = brandData.filter(d => d.weekly_number_of_days_with_deal === 0 && d.weekly_number_of_days_with_coupon === 0);
            const withDeal = brandData.filter(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);

            const avgNoDeal = noDeal.length ? noDeal.reduce((s, d) => s + d.click_share, 0) / noDeal.length : 0;
            const avgDeal = withDeal.length ? withDeal.reduce((s, d) => s + d.click_share, 0) / withDeal.length : 0;

            rows.push([b + ' (Base)', avgNoDeal]);
            rows.push([b + ' (Promo)', avgDeal]);
        });

        const data = google.visualization.arrayToDataTable(rows);
        const options = {
            title: 'Impacto de Promociones (Share Promedio)',
            legend: { position: 'none' },
            colors: ['#4285F4'],
            vAxis: { format: 'percent' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    function drawEfficiency() {
        // Scatter: X=Rank, Y=Share
        // Series: Us, Competitors
        const dataArray = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];

        const lastWeek = weeks[weeks.length - 1];
        const currentData = processedData.filter(d => d.week_date === lastWeek);

        currentData.forEach(d => {
            const isUs = d.realBrand === ourBrand;
            const color = isUs ? '#4285F4' : '#999';
            const tooltip = `${d.product_title}\nRank: ${d.average_organic_rank}\nShare: ${(d.click_share*100).toFixed(1)}%`;
            dataArray.push([d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: 6; }`, tooltip]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 }, // Reverse axis for rank
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            chartArea: {width: '80%', height: '70%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // -------------------------------------------------------------------------
    // 4. INSIGHTS GENERATION
    // -------------------------------------------------------------------------
    function generateInsights() {
        const insightsDiv = document.getElementById('insights_container');
        const recsDiv = document.getElementById('recommendations_container');
        
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];
        
        const lwData = processedData.filter(d => d.week_date === lastWeek);
        const pwData = processedData.filter(d => d.week_date === prevWeek);

        // Calculate Totals
        const getShare = (data, brand) => data.filter(d => d.realBrand === brand).reduce((s,d)=>s+d.click_share,0);
        
        const myShareLW = getShare(lwData, ourBrand);
        const mySharePW = getShare(pwData, ourBrand);
        const diff = myShareLW - mySharePW;
        
        let insightsHTML = '';
        let recsHTML = '';

        // Insight 1: Trend
        const trendIcon = diff > 0 ? 'trending_up' : 'trending_down';
        const trendColor = diff > 0 ? 'green' : 'red';
        insightsHTML += `
            <div class="insight-item">
                <i class="material-icons insight-icon" style="color:${trendColor}">${trendIcon}</i>
                <div class="insight-text">
                    <span class="insight-title">Tendencia Semanal</span>
                    Nuestra cuota de clics cambió un <strong>${(diff*100).toFixed(1)}%</strong> vs la semana anterior.
                </div>
            </div>`;

        // Insight 2: Top Competitor
        const topComp = topCompetitors[0];
        const compShareLW = getShare(lwData, topComp);
        insightsHTML += `
            <div class="insight-item">
                <i class="material-icons insight-icon">warning</i>
                <div class="insight-text">
                    <span class="insight-title">Amenaza Principal</span>
                    ${topComp} mantiene una cuota del ${(compShareLW*100).toFixed(1)}%.
                </div>
            </div>`;

        // Insight 3: Promo Check
        const myPromos = lwData.filter(d => d.realBrand === ourBrand && (d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0));
        if (myPromos.length > 0) {
            insightsHTML += `
            <div class="insight-item">
                <i class="material-icons insight-icon">local_offer</i>
                <div class="insight-text">
                    <span class="insight-title">Activación Promocional</span>
                    Detectamos actividad promocional activa en ${myPromos.length} de nuestros ASINs.
                </div>
            </div>`;
        } else {
             insightsHTML += `
            <div class="insight-item">
                <i class="material-icons insight-icon">money_off</i>
                <div class="insight-text">
                    <span class="insight-title">Oportunidad Promocional</span>
                    No tenemos promos activas esta semana. Competidores con Deals ganan +10% share promedio.
                </div>
            </div>`;
        }

        insightsDiv.innerHTML = insightsHTML;

        // Recommendations
        if (diff < 0) {
            recsHTML += `<div class="rec-item"><i class="material-icons">add_alert</i>Revisar competitividad de precio vs ${topComp}.</div>`;
        }
        recsHTML += `<div class="rec-item"><i class="material-icons">search</i>Optimizar keywords de bajo ranking para recuperar visibilidad orgánica.</div>`;
        recsHTML += `<div class="rec-item"><i class="material-icons">style</i>Considerar cupones de defensa en ASINs Core.</div>`;

        recsDiv.innerHTML = recsHTML;
    }

    // -------------------------------------------------------------------------
    // 5. INTERACTIVE TAB LOGIC
    // -------------------------------------------------------------------------
    function updateInteractive() {
        const week = document.getElementById('weekSelect').value;
        const comp = document.getElementById('compSelect').value;
        
        const weekData = processedData.filter(d => d.week_date === week);
        
        // Filter for Us and Comp
        const ourAsins = weekData.filter(d => d.realBrand === ourBrand);
        const compAsins = weekData.filter(d => d.realBrand === comp);

        if (ourAsins.length === 0 || compAsins.length === 0) return;

        // Avg Metrics
        const avgPriceUs = ourAsins.reduce((s,d)=>s+d.price,0) / ourAsins.length;
        const avgPriceComp = compAsins.reduce((s,d)=>s+d.price,0) / compAsins.length;
        
        const totalShareUs = ourAsins.reduce((s,d)=>s+d.click_share,0);
        const totalShareComp = compAsins.reduce((s,d)=>s+d.click_share,0);

        // 1. Price Chart
        const priceData = google.visualization.arrayToDataTable([
            ['Brand', 'Avg Price', { role: 'style' }],
            [ourBrand, avgPriceUs, '#4285F4'],
            [comp, avgPriceComp, '#EA4335']
        ]);
        new google.visualization.ColumnChart(document.getElementById('chart_compare_price')).draw(priceData, {legend:'none', vAxis:{title:'Price'}});

        // 2. Share Chart
        const shareData = google.visualization.arrayToDataTable([
            ['Brand', 'Total Share', { role: 'style' }],
            [ourBrand, totalShareUs, '#4285F4'],
            [comp, totalShareComp, '#EA4335']
        ]);
        new google.visualization.ColumnChart(document.getElementById('chart_compare_share')).draw(shareData, {legend:'none', vAxis:{format:'percent'}});

        // 3. Promo Status
        const usDeals = ourAsins.some(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);
        const compDeals = compAsins.some(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);
        
        let promoHTML = `<strong>${ourBrand}:</strong> ${usDeals ? '<span class="trend-up">ACTIVO</span>' : 'Inactivo'}<br><br>`;
        promoHTML += `<strong>${comp}:</strong> ${compDeals ? '<span class="trend-up">ACTIVO</span>' : 'Inactivo'}`;
        document.getElementById('promo_status').innerHTML = promoHTML;

        // 4. Detail Table
        const tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'ASIN');
        tableData.addColumn('string', 'Brand');
        tableData.addColumn('number', 'Price');
        tableData.addColumn('number', 'Rank');
        tableData.addColumn('number', 'Share');
        
        [...ourAsins, ...compAsins].forEach(d => {
            tableData.addRow([d.asin, d.realBrand, d.price, d.average_organic_rank, d.click_share]);
        });

        const table = new google.visualization.Table(document.getElementById('table_details'));
        table.draw(tableData, {showRowNumber: true, width: '100%', height: '100%'});
    }

    // Tab Switching
    window.switchTab = function(tabName) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        if(tabName === 'static') {
            document.getElementById('tab-static').classList.remove('hidden');
            drawGlobalTrend(); // Redraw to fix dimension bugs
            drawCompetitiveness();
        } else {
            document.getElementById('tab-interactive').classList.remove('hidden');
            updateInteractive();
        }
    }

</script>

</body>
</html>