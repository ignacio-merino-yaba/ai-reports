<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Analysis: Matcha Premium</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray-50: #F8F9FA;
            --gray-100: #F1F3F4;
            --gray-200: #E8EAED;
            --gray-700: #5F6368;
            --gray-900: #202124;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-900);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0 0 8px 0;
        }

        .header p {
            color: var(--gray-700);
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary);
        }

        .kpi-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .kpi-sub {
            font-size: 13px;
            color: var(--success);
            margin-top: 4px;
            font-weight: 500;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-size: 14px;
            background-color: var(--gray-50);
            outline: none;
            min-width: 200px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            color: var(--primary);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-our { background-color: #E8F0FE; color: var(--primary); }
        .badge-comp { background-color: #FCE8E6; color: var(--danger); }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 400px;
        }
        
        .half-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        @media (max-width: 768px) {
            .half-grid { grid-template-columns: 1fr; }
            .tabs { overflow-x: auto; }
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Matcha Premium Analysis</h1>
        <p>Market Intelligence Report • <span id="date-range">Loading...</span></p>
    </div>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Strategic Report</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Competitor Deep Dive</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static-tab" class="tab-content active">
        
        <!-- KPI Row -->
        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color: var(--primary);">
                <div class="kpi-label">Our Click Share</div>
                <div class="kpi-value" id="kpi-share">--%</div>
                <div class="kpi-sub">vs Market Leaders</div>
            </div>
            <div class="kpi-card" style="border-left-color: var(--danger);">
                <div class="kpi-label">Market Leader</div>
                <div class="kpi-value" id="kpi-leader">--</div>
                <div class="kpi-sub" id="kpi-leader-share">--% Share</div>
            </div>
            <div class="kpi-card" style="border-left-color: var(--warning);">
                <div class="kpi-label">Avg Price Gap</div>
                <div class="kpi-value" id="kpi-price">--</div>
                <div class="kpi-sub">vs Top 3 Avg</div>
            </div>
            <div class="kpi-card" style="border-left-color: var(--success);">
                <div class="kpi-label">Efficiency</div>
                <div class="kpi-value" id="kpi-rank">--</div>
                <div class="kpi-sub">Avg Organic Rank</div>
            </div>
        </div>

        <!-- Section 1: Trend -->
        <div class="card">
            <div class="card-header">
                <div class="card-title"><span class="material-icons">trending_up</span> Global Trend: Us vs Competition</div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="half-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="material-icons">pie_chart</span> Share by Brand</div>
                </div>
                <div id="chart_brand_share" class="chart-container"></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="material-icons">speed</span> Efficiency: Rank vs Share</div>
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 3: Levers -->
        <div class="card">
            <div class="card-header">
                <div class="card-title"><span class="material-icons">tune</span> Growth Levers Impact</div>
            </div>
            <div id="chart_levers" class="chart-container" style="height: 300px;"></div>
        </div>

        <!-- Section 5: Insights & Recommendations -->
        <div class="half-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="material-icons">lightbulb</span> Key Insights</div>
                </div>
                <ul class="insight-list" id="insights-container">
                    <!-- Populated by JS -->
                </ul>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="material-icons">task_alt</span> Actionable Recommendations</div>
                </div>
                <ul class="insight-list" id="actions-container">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="interactive-tab" class="tab-content">
        <div class="controls">
            <div>
                <label style="display:block; margin-bottom:4px; font-size:12px; color:var(--gray-700);">Compare Us Against:</label>
                <select id="competitor-select" onchange="updateInteractiveChart()">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div>
                <label style="display:block; margin-bottom:4px; font-size:12px; color:var(--gray-700);">Metric:</label>
                <select id="metric-select" onchange="updateInteractiveChart()">
                    <option value="click_share">Click Share (%)</option>
                    <option value="price">Price (£)</option>
                    <option value="average_organic_rank">Organic Rank</option>
                </select>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="card-title">Head-to-Head Comparison</div>
            </div>
            <div id="chart_interactive" class="chart-container"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Detailed ASIN Data</div>
            </div>
            <div id="table_interactive" style="width: 100%;"></div>
        </div>
    </div>

</div>

<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION
    // ---------------------------------------------------------
    // Raw CSV data converted to JSON for portability
    const rawData = [
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: null, asin: "B08YRXQ2JH", title: "Double Dragon | 100% Organic | Premium Matcha Gree...", country: "uk", rank: 13, deals: 0, bs: 0, ac: 0, coupon: 0, share: 3.32, imp: 3.16, price: 6.98, vol: 40744.98, yaba: "N", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: "Perfect Ted", asin: "B0F21VZMJQ", title: "PerfectTed Original Matcha Powder, Ceremonial Grad...", country: "uk", rank: 3, deals: 0, bs: 0, ac: 1, coupon: 0, share: 10.49, imp: 3.3, price: 16.99, vol: 40744.98, yaba: "N", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: "NaturaleBio", asin: "B079VQ52MK", title: "NaturaleBio Japanese Organic Matcha Green Tea Powd...", country: "uk", rank: 7, deals: 0, bs: 0, ac: 0, coupon: 0, share: 3.39, imp: 3.28, price: 20.99, vol: 40744.98, yaba: "Y", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: "Perfect Ted", asin: "B09DQ1PWGX", title: "PerfectTed Organic Matcha Powder, Ceremonial Grade...", country: "uk", rank: 34, deals: 0, bs: 0, ac: 0, coupon: 0, share: 4.64, imp: 3.45, price: 2.12, vol: 40744.98, yaba: "N", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: null, asin: "B0C71LZNV6", title: "Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...", country: "uk", rank: 12, deals: 0, bs: 0, ac: 0, coupon: 0, share: 2.56, imp: 4.22, price: 24.95, vol: 40744.98, yaba: "N", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: "SuperSelf", asin: "B082DKRSB4", title: "SuperSelf Organic Matcha Powder - Ceremonial Grade...", country: "uk", rank: 8, deals: 4, bs: 0, ac: 0, coupon: 4, share: 3.96, imp: 4.48, price: 14.86, vol: 40744.98, yaba: "N", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: "Perfect Ted", asin: "B0D9M91WZD", title: "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", country: "uk", rank: 9, deals: 0, bs: 0, ac: 0, coupon: 0, share: 2.79, imp: 3.5, price: 11.00, vol: 40744.98, yaba: "N", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: "NaturaleBio", asin: "B06XQ5DCYJ", title: "NaturaleBio Japanese Organic Matcha Green Tea Powd...", country: "uk", rank: 1, deals: 0, bs: 0, ac: 4, coupon: 0, share: 13.79, imp: 3.33, price: 12.49, vol: 40744.98, yaba: "Y", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: "SuperSelf", asin: "B08YK2RPBZ", title: "SuperSelf Organic Matcha Powder - Ceremonial Grade...", country: "uk", rank: 4, deals: 0, bs: 0, ac: 0, coupon: 4, share: 9.83, imp: 3.56, price: 9.90, vol: 40744.98, yaba: "N", link: "https://www.amazon.co.uk/s?k=matcha" },
        { brand_context: "naturalebio", parent: "Matcha Premium", date: "2026-01-03", week: "2026-01", kw: "matcha", comp_brand: "Heapwell Superfoods", asin: "B06XTYYYJ8", title: "Heapwell Matcha Powder - 50g | High Grade Japanese...", country: "uk", rank: 6, deals: 0, bs: 0, ac: 0, coupon: 0, share: 5.74, imp: 5.52, price: 9.99, vol: 40744.98, yaba: "N", link: "https://www.amazon.co.uk/s?k=matcha" }
    ];

    // ---------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // ---------------------------------------------------------

    // Brand Identification Logic
    function identifyBrand(item) {
        if (item.comp_brand) return item.comp_brand;
        const title = item.title.toLowerCase();
        if (title.includes("double dragon")) return "Double Dragon";
        if (title.includes("matcha fuel")) return "Matcha Fuel";
        if (title.includes("perfectted") || title.includes("perfect ted")) return "Perfect Ted";
        if (title.includes("naturalebio")) return "NaturaleBio";
        if (title.includes("superself")) return "SuperSelf";
        if (title.includes("heapwell")) return "Heapwell";
        return "Unknown Brand";
    }

    // Process Data
    const marketData = rawData.map(item => {
        const brand = identifyBrand(item);
        return {
            ...item,
            brand: brand,
            // Our Brand Logic: Defined by ASINs marked as Y
            is_us: item.yaba === 'Y', 
            has_badge: (item.bs > 0 || item.ac > 0),
            has_promo: (item.deals > 0 || item.coupon > 0)
        };
    });

    // Identify "Our Brand" Name
    const ourBrandEntry = marketData.find(d => d.yaba === 'Y');
    const OUR_BRAND_NAME = ourBrandEntry ? ourBrandEntry.brand : "NaturaleBio";

    // Aggregations
    const weeks = [...new Set(marketData.map(d => d.week))].sort();
    
    // Calculate Shares per Brand per Week
    const brandShares = {}; // { Brand: { Week: Share } }
    
    marketData.forEach(d => {
        if (!brandShares[d.brand]) brandShares[d.brand] = {};
        if (!brandShares[d.brand][d.week]) brandShares[d.brand][d.week] = 0;
        brandShares[d.brand][d.week] += d.share;
    });

    // Top Competitors
    const totalShareByBrand = {};
    Object.keys(brandShares).forEach(b => {
        let total = 0;
        Object.values(brandShares[b]).forEach(v => total += v);
        totalShareByBrand[b] = total;
    });

    const topCompetitors = Object.entries(totalShareByBrand)
        .filter(([b]) => b !== OUR_BRAND_NAME)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 3)
        .map(([b]) => b);

    // ---------------------------------------------------------
    // 3. GOOGLE CHARTS SETUP
    // ---------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawKPIs();
        drawTrendChart();
        drawBrandShareChart();
        drawEfficiencyChart();
        drawLeversChart();
        populateInsights();
        populateCompetitorSelect();
    }

    function drawKPIs() {
        const currentWeek = weeks[weeks.length - 1];
        const weekData = marketData.filter(d => d.week === currentWeek);
        
        // Share Us
        const shareUs = weekData.filter(d => d.brand === OUR_BRAND_NAME).reduce((sum, d) => sum + d.share, 0);
        
        // Leader
        let leaderName = "";
        let leaderShare = 0;
        Object.entries(totalShareByBrand).forEach(([b, s]) => {
            if (s > leaderShare) { leaderShare = s; leaderName = b; }
        });

        // Price Gap
        const avgPriceUs = weekData.filter(d => d.brand === OUR_BRAND_NAME).reduce((sum, d) => sum + d.price, 0) / weekData.filter(d => d.brand === OUR_BRAND_NAME).length;
        const compData = weekData.filter(d => topCompetitors.includes(d.brand));
        const avgPriceComp = compData.reduce((sum, d) => sum + d.price, 0) / compData.length;
        const gap = avgPriceUs - avgPriceComp;
        const gapStr = gap > 0 ? `+£${gap.toFixed(2)}` : `-£${Math.abs(gap).toFixed(2)}`;

        // Efficiency
        const avgRankUs = weekData.filter(d => d.brand === OUR_BRAND_NAME).reduce((sum, d) => sum + d.rank, 0) / weekData.filter(d => d.brand === OUR_BRAND_NAME).length;

        document.getElementById('date-range').innerText = `Week: ${currentWeek}`;
        document.getElementById('kpi-share').innerText = shareUs.toFixed(1) + '%';
        document.getElementById('kpi-leader').innerText = leaderName;
        document.getElementById('kpi-leader-share').innerText = leaderShare.toFixed(1) + '% Share';
        document.getElementById('kpi-price').innerText = gapStr;
        document.getElementById('kpi-rank').innerText = '#' + avgRankUs.toFixed(1);
    }

    function drawTrendChart() {
        // Prepare Data: Week, Us Share, Competitor Share
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Our Click Share');
        data.addColumn('number', 'Competitor Click Share');

        weeks.forEach(w => {
            const us = marketData.filter(d => d.week === w && d.brand === OUR_BRAND_NAME).reduce((sum, d) => sum + d.share, 0);
            const them = marketData.filter(d => d.week === w && d.brand !== OUR_BRAND_NAME).reduce((sum, d) => sum + d.share, 0);
            data.addRow([w, us, them]);
        });

        const options = {
            isStacked: true,
            colors: ['#4285F4', '#E0E0E0'],
            chartArea: {width: '85%', height: '70%'},
            legend: {position: 'bottom'},
            vAxis: {title: 'Click Share (%)'},
            seriesType: 'bars'
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function drawBrandShareChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', OUR_BRAND_NAME);
        topCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Others');

        weeks.forEach(w => {
            const row = [w];
            // Us
            row.push(brandShares[OUR_BRAND_NAME][w] || 0);
            // Top 3
            topCompetitors.forEach(c => row.push(brandShares[c][w] || 0));
            // Others
            let otherSum = 0;
            Object.keys(brandShares).forEach(b => {
                if (b !== OUR_BRAND_NAME && !topCompetitors.includes(b)) {
                    otherSum += (brandShares[b][w] || 0);
                }
            });
            row.push(otherSum);
            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            chartArea: {width: '85%', height: '70%'},
            legend: {position: 'bottom'},
            vAxis: {title: 'Share (%)'},
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6']
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'tooltip', p: {html: true}});
        data.addColumn({type: 'string', role: 'style'});

        marketData.forEach(d => {
            const color = d.is_us ? '#4285F4' : (topCompetitors.includes(d.brand) ? '#EA4335' : '#E0E0E0');
            const tooltip = `<div style="padding:10px;"><strong>${d.brand}</strong><br>${d.title.substring(0,30)}...<br>Rank: ${d.rank}, Share: ${d.share}%<br>Price: £${d.price}</div>`;
            data.addRow([d.rank, d.share, tooltip, `point { fill-color: ${color}; size: ${d.is_us ? 10 : 5} }`]);
        });

        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: 1},
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
            tooltip: {isHtml: true},
            chartArea: {width: '85%', height: '80%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function drawLeversChart() {
        // Aggregate by Badge vs No Badge
        let badgeShare = 0, badgeCount = 0;
        let noBadgeShare = 0, noBadgeCount = 0;

        marketData.forEach(d => {
            if (d.has_badge) { badgeShare += d.share; badgeCount++; }
            else { noBadgeShare += d.share; noBadgeCount++; }
        });

        const avgBadge = badgeCount ? badgeShare / badgeCount : 0;
        const avgNoBadge = noBadgeCount ? noBadgeShare / noBadgeCount : 0;

        const data = google.visualization.arrayToDataTable([
            ['Condition', 'Avg Click Share', { role: 'style' }],
            ['With Badges (Choice/BestSeller)', avgBadge, '#34A853'],
            ['No Badges', avgNoBadge, '#9AA0A6']
        ]);

        const options = {
            legend: { position: "none" },
            bar: { groupWidth: "60%" },
            vAxis: { title: "Avg Share (%)" }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    function populateInsights() {
        // Generated based on Python analysis of the data logic
        const insights = [
            { icon: 'star', text: "<strong>Hero ASIN Dominance:</strong> Our top ASIN (B06XQ5DCYJ) commands 13.8% share, driven by the 'Amazon Choice' badge and competitive pricing (£12.49).", type: 'pos' },
            { icon: 'warning', text: "<strong>Price Sensitivity Risk:</strong> Our secondary ASIN (B079VQ52MK) is priced £20.99 (vs market avg ~£12) and suffers low visibility (3.4% share, Rank #7).", type: 'neg' },
            { icon: 'trending_up', text: "<strong>Top Threat:</strong> 'Perfect Ted' is the category leader (17.9% total share) utilizing a multi-SKU strategy covering both premium (£16.99) and entry-level price points.", type: 'neu' },
            { icon: 'verified', text: "<strong>Badge Power:</strong> Listings with badges generate ~2.5x more share (12.1% vs 4.5%) than those without, validating our strategy on the hero ASIN.", type: 'pos' },
            { icon: 'loyalty', text: "<strong>Competitor Promotions:</strong> 'SuperSelf' is aggressively using coupons (4 active days) to maintain #3 position despite lower organic rank.", type: 'neu' }
        ];

        const actions = [
            { icon: 'sell', text: "<strong>Price Optimization:</strong> Reduce price on B079VQ52MK to <£18.00 to break into the mid-range volume segment." },
            { icon: 'verified_user', text: "<strong>Defend the Badge:</strong> Maintain conversion velocity on B06XQ5DCYJ to keep 'Amazon Choice' - it's the primary driver of our share." },
            { icon: 'search', text: "<strong>Conquesting:</strong> Target 'Perfect Ted' keywords; their £16.99 SKU is vulnerable to our £12.49 Hero ASIN value proposition." }
        ];

        const iContainer = document.getElementById('insights-container');
        insights.forEach(i => {
            const color = i.type === 'pos' ? 'text-green-600' : (i.type === 'neg' ? 'text-red-600' : 'text-gray-600');
            iContainer.innerHTML += `
                <li class="insight-item">
                    <span class="material-icons insight-icon">${i.icon}</span>
                    <div style="font-size: 14px; color: #374151;">${i.text}</div>
                </li>
            `;
        });

        const aContainer = document.getElementById('actions-container');
        actions.forEach(a => {
            aContainer.innerHTML += `
                <li class="insight-item">
                    <span class="material-icons insight-icon" style="color:var(--primary);">${a.icon}</span>
                    <div style="font-size: 14px; font-weight:500;">${a.text}</div>
                </li>
            `;
        });
    }

    // ---------------------------------------------------------
    // 4. INTERACTIVE TAB LOGIC
    // ---------------------------------------------------------
    function populateCompetitorSelect() {
        const select = document.getElementById('competitor-select');
        topCompetitors.forEach(c => {
            const option = document.createElement('option');
            option.value = c;
            option.text = c;
            select.appendChild(option);
        });
        // Initial Draw
        updateInteractiveChart();
    }

    function updateInteractiveChart() {
        const comp = document.getElementById('competitor-select').value;
        const metric = document.getElementById('metric-select').value;
        
        // Prepare Data for Chart
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', OUR_BRAND_NAME);
        data.addColumn('number', comp);

        // Aggregate metric by brand/week (averaging or summing)
        weeks.forEach(w => {
            // US
            const usItems = marketData.filter(d => d.week === w && d.brand === OUR_BRAND_NAME);
            let usVal = 0;
            if (metric === 'click_share') usVal = usItems.reduce((s,d) => s + d.share, 0);
            else if (metric === 'price') usVal = usItems.reduce((s,d) => s + d.price, 0) / (usItems.length || 1);
            else usVal = usItems.reduce((s,d) => s + d.rank, 0) / (usItems.length || 1);

            // THEM
            const themItems = marketData.filter(d => d.week === w && d.brand === comp);
            let themVal = 0;
            if (metric === 'click_share') themVal = themItems.reduce((s,d) => s + d.share, 0);
            else if (metric === 'price') themVal = themItems.reduce((s,d) => s + d.price, 0) / (themItems.length || 1);
            else themVal = themItems.reduce((s,d) => s + d.rank, 0) / (themItems.length || 1);

            data.addRow([w, usVal, themVal]);
        });

        const options = {
            title: `${metric.replace('_', ' ').toUpperCase()} Over Time`,
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335'],
            vAxis: { 
                title: metric,
                direction: metric === 'average_organic_rank' ? -1 : 1 
            }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_interactive'));
        chart.draw(data, options);

        // Draw Table
        drawInteractiveTable(comp);
    }

    function drawInteractiveTable(compBrand) {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Brand');
        data.addColumn('string', 'ASIN');
        data.addColumn('string', 'Title');
        data.addColumn('number', 'Price (£)');
        data.addColumn('number', 'Share (%)');
        data.addColumn('boolean', 'Deal?');

        const filtered = marketData.filter(d => d.brand === OUR_BRAND_NAME || d.brand === compBrand);
        
        filtered.forEach(d => {
            data.addRow([
                d.brand,
                d.asin,
                d.title.substring(0, 40) + '...',
                d.price,
                d.share,
                d.has_promo
            ]);
        });

        const table = new google.visualization.Table(document.getElementById('table_interactive'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
    }

    // ---------------------------------------------------------
    // UTILS
    // ---------------------------------------------------------
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId + '-tab').classList.add('active');
        event.target.classList.add('active');

        // Redraw to fix Google Charts size issues in hidden tabs
        setTimeout(drawDashboard, 100);
    }

    // Resize handling
    window.addEventListener('resize', drawDashboard);

</script>
</body>
</html>