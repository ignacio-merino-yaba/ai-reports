<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Strategic Report</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-100: #f8f9fa;
            --gray-200: #e8eaed;
            --gray-700: #5f6368;
            --gray-900: #202124;
            --surface: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-900);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--gray-900);
        }

        .header p {
            color: var(--gray-700);
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            margin-bottom: 24px;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* Metrics */
        .metric-value { font-size: 32px; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 14px; color: var(--gray-700); }
        .metric-delta { font-size: 14px; font-weight: 500; margin-left: 8px; }
        .positive { color: var(--success); }
        .negative { color: var(--danger); }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Lists */
        ul.insights-list {
            padding-left: 20px;
            margin: 0;
        }
        ul.insights-list li {
            margin-bottom: 8px;
            color: var(--gray-700);
        }
        .highlight {
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Badge Pills */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-blue { background: #e8f0fe; color: #1967d2; }
        .badge-green { background: #e6f4ea; color: #137333; }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--gray-100);
            padding: 16px;
            border-radius: var(--radius);
        }

        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            font-size: 14px;
            min-width: 150px;
        }

        /* Visibility utility */
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Parent ASIN Performance Report</h1>
        <p>Strategic analysis of market share, competitiveness, and efficiency.</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Strategic Report</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Interactive Comparator</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">show_chart</span>
                1. Global Trend (Parent View)
            </div>
            <div class="grid-2">
                <div>
                    <div id="chart_global_trend" class="chart-container"></div>
                </div>
                <div>
                    <h4>Analysis</h4>
                    <p id="trend_analysis_text" class="text-sm text-gray-700"></p>
                    <div class="grid-2" style="margin-top: 20px;">
                        <div>
                            <div class="metric-label">Total Clicks (Last Week)</div>
                            <div class="metric-value" id="metric_total_clicks">-</div>
                        </div>
                        <div>
                            <div class="metric-label">Our Click Share</div>
                            <div class="metric-value" id="metric_click_share">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Brand Competitiveness
            </div>
            <div id="chart_brand_share" class="chart-container"></div>
            <div style="margin-top: 16px;">
                <strong>Key Observation:</strong> <span id="brand_insight"></span>
            </div>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">rocket_launch</span>
                    3. Growth Levers Impact
                </div>
                <div id="levers_content">
                    <!-- Dynamic content -->
                </div>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Rank Efficiency (Organic vs Share)
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
                <p style="font-size: 12px; color: var(--gray-700); margin-top:8px;">
                    *Bubbles above the trend line are over-performing relative to rank.
                </p>
            </div>
        </div>

        <!-- Section 5: Conclusions -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Key Insights & Recommendations
            </div>
            <div class="grid-2">
                <div>
                    <h4><span class="material-icons" style="font-size:16px; vertical-align:text-bottom;">analytics</span> Insights</h4>
                    <ul class="insights-list" id="list_insights"></ul>
                </div>
                <div>
                    <h4><span class="material-icons" style="font-size:16px; vertical-align:text-bottom;">task_alt</span> Actions</h4>
                    <ul class="insights-list" id="list_actions"></ul>
                </div>
            </div>
        </div>
        
        <!-- Section 6: Other Insights -->
        <div class="card">
             <div class="card-title">6. Other Insights & Anomalies</div>
             <p id="other_insights_text">No major data anomalies detected in the provided dataset.</p>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-title">Interactive Deep Dive</div>
            <div class="controls">
                <div>
                    <label style="display:block; font-size:12px; margin-bottom:4px;">Metric</label>
                    <select id="sel_metric" onchange="drawInteractiveChart()">
                        <option value="price">Average Price</option>
                        <option value="click_share">Click Share (%)</option>
                        <option value="average_organic_rank">Organic Rank</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; font-size:12px; margin-bottom:4px;">Competitor to Compare</label>
                    <select id="sel_competitor" onchange="drawInteractiveChart()">
                        <!-- Filled by JS -->
                    </select>
                </div>
            </div>
            <div id="chart_interactive" class="chart-container"></div>
        </div>
    </div>

</div>

<script>
    // --------------------------------------------------------------------------
    // 1. DATA INJECTION (SYNTHETIC DATA GENERATED FOR DEMONSTRATION)
    // --------------------------------------------------------------------------
    // NOTE: In a real deployment, replace this array with the JSON output from your backend/CSV parser.
    const marketData = [
        {"week_date": "2023-10-01", "competitor_brand": "YabaTech", "click_share": 12.5, "price": 45.0, "average_organic_rank": 3, "is_yaba_asin": "Y", "product_title": "YabaTech Wireless Headphones", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5000},
        {"week_date": "2023-10-01", "competitor_brand": "CompAlpha", "click_share": 10.0, "price": 55.0, "average_organic_rank": 5, "is_yaba_asin": "N", "product_title": "CompAlpha Premium Sound", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5000},
        {"week_date": "2023-10-01", "competitor_brand": "CompBeta", "click_share": 8.0, "price": 40.0, "average_organic_rank": 7, "is_yaba_asin": "N", "product_title": "CompBeta Budget Buds", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5000},
        
        {"week_date": "2023-10-08", "competitor_brand": "YabaTech", "click_share": 13.0, "price": 45.0, "average_organic_rank": 3, "is_yaba_asin": "Y", "product_title": "YabaTech Wireless Headphones", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5100},
        {"week_date": "2023-10-08", "competitor_brand": "CompAlpha", "click_share": 10.5, "price": 55.0, "average_organic_rank": 4, "is_yaba_asin": "N", "product_title": "CompAlpha Premium Sound", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5100},
        
        // Week 3: YabaTech Deal (Share Spike)
        {"week_date": "2023-10-15", "competitor_brand": "YabaTech", "click_share": 22.0, "price": 39.99, "average_organic_rank": 1, "is_yaba_asin": "Y", "product_title": "YabaTech Wireless Headphones", "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 6000},
        {"week_date": "2023-10-15", "competitor_brand": "CompAlpha", "click_share": 8.0, "price": 55.0, "average_organic_rank": 6, "is_yaba_asin": "N", "product_title": "CompAlpha Premium Sound", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 6000},
        
        // Week 4: CompAlpha Reaction (Coupons)
        {"week_date": "2023-10-22", "competitor_brand": "YabaTech", "click_share": 15.0, "price": 45.0, "average_organic_rank": 2, "is_yaba_asin": "Y", "product_title": "YabaTech Wireless Headphones", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5200},
        {"week_date": "2023-10-22", "competitor_brand": "CompAlpha", "click_share": 18.0, "price": 55.0, "average_organic_rank": 2, "is_yaba_asin": "N", "product_title": "CompAlpha Premium Sound", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_search_volume": 5200},

        // Week 5: Stabilization
        {"week_date": "2023-10-29", "competitor_brand": "YabaTech", "click_share": 14.5, "price": 45.0, "average_organic_rank": 2, "is_yaba_asin": "Y", "product_title": "YabaTech Wireless Headphones", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5000},
        {"week_date": "2023-10-29", "competitor_brand": "CompAlpha", "click_share": 14.0, "price": 55.0, "average_organic_rank": 3, "is_yaba_asin": "N", "product_title": "CompAlpha Premium Sound", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5000},
        {"week_date": "2023-10-29", "competitor_brand": "CompBeta", "click_share": 9.0, "price": 40.0, "average_organic_rank": 6, "is_yaba_asin": "N", "product_title": "CompBeta Budget Buds", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_search_volume": 5000}
    ];

    // --------------------------------------------------------------------------
    // 2. DATA PROCESSING LOGIC
    // --------------------------------------------------------------------------
    
    // Helpers
    const getBrand = (row) => {
        if (row.competitor_brand) return row.competitor_brand;
        // Fallback extract from title
        const titleParts = row.product_title ? row.product_title.split(' ') : [];
        return titleParts.length > 0 ? titleParts[0] : "Unknown Brand";
    };

    // Enrich Data with implied clicks if missing
    const cleanData = marketData.map(d => {
        const brand = getBrand(d);
        // Calculate clicks if missing (Proxy: volume * share/100)
        const clicks = d.clicks || Math.round(d.weekly_search_volume * (d.click_share / 100));
        return { ...d, _brand: brand, _clicks: clicks };
    });

    // Identify OUR BRAND
    const ourAsins = cleanData.filter(d => d.is_yaba_asin === 'Y');
    // If no Yaba asin found (edge case), pick the most frequent brand or "Unknown"
    const ourBrand = ourAsins.length > 0 ? getBrand(ourAsins[0]) : "Our Brand";

    // Get Weeks and Sort
    const weeks = [...new Set(cleanData.map(d => d.week_date))].sort();
    const lastWeek = weeks[weeks.length - 1];
    const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : lastWeek;

    // Identify Top 3 Competitors
    const competitorStats = {};
    cleanData.forEach(d => {
        if(d.is_yaba_asin === 'N') {
            if(!competitorStats[d._brand]) competitorStats[d._brand] = 0;
            competitorStats[d._brand] += d.click_share;
        }
    });
    const topCompetitors = Object.entries(competitorStats)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 3)
        .map(x => x[0]);

    // --------------------------------------------------------------------------
    // 3. GOOGLE CHARTS SETUP
    // --------------------------------------------------------------------------
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawAllCharts);

    function drawAllCharts() {
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawEfficiency();
        populateTextAnalysis();
        populateInteractiveDropdowns();
    }

    // --- CHART 1: GLOBAL TREND (Combo) ---
    function drawGlobalTrend() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Our Clicks');
        data.addColumn('number', 'Competitor Clicks');
        data.addColumn('number', 'Our Click Share (%)');

        const rows = weeks.map(week => {
            const weeklyData = cleanData.filter(d => d.week_date === week);
            const ourClicks = weeklyData.filter(d => d.is_yaba_asin === 'Y').reduce((sum, d) => sum + d._clicks, 0);
            const compClicks = weeklyData.filter(d => d.is_yaba_asin === 'N').reduce((sum, d) => sum + d._clicks, 0);
            
            // Weighted average share for us
            const ourTotalShare = weeklyData
                .filter(d => d.is_yaba_asin === 'Y')
                .reduce((sum, d) => sum + d.click_share, 0); // Simplified sum for parent view

            return [week.substring(5), ourClicks, compClicks, ourTotalShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}},
            vAxes: {
                0: {title: 'Clicks Volume'},
                1: {title: 'Click Share %', format: '#\'%\''}
            },
            colors: ['#4285F4', '#EA4335', '#34A853'],
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'},
            bar: {groupWidth: '60%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // --- CHART 2: BRAND COMPETITIVENESS (Line) ---
    function drawBrandCompetitiveness() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', ourBrand);
        topCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Rest of Market');

        const rows = weeks.map(week => {
            const weeklyData = cleanData.filter(d => d.week_date === week);
            
            // Helper to sum share by brand
            const getShare = (brand) => weeklyData.filter(d => d._brand === brand).reduce((s, x) => s + x.click_share, 0);
            
            const ourShare = getShare(ourBrand);
            const compShares = topCompetitors.map(c => getShare(c));
            
            // Calculate Rest
            const trackedShare = ourShare + compShares.reduce((a,b) => a+b, 0);
            // Assuming total market is ~100% or relative to tracked keywords. 
            // Ideally we sum all shares. If data is partial, this might be small.
            // Let's sum all shares in data and subtract tracked.
            const totalShareInData = weeklyData.reduce((s, x) => s + x.click_share, 0);
            const restShare = Math.max(0, totalShareInData - trackedShare);

            return [week.substring(5), ourShare, ...compShares, restShare];
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            legend: {position: 'bottom'},
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            chartArea: {width: '90%', height: '70%'},
            vAxis: {title: 'Click Share %'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    // --- CHART 3: EFFICIENCY (Scatter) ---
    function drawEfficiency() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'}); // For color
        data.addColumn({type: 'string', role: 'tooltip'});

        const lastWeekData = cleanData.filter(d => d.week_date === lastWeek);
        
        const rows = lastWeekData.map(d => {
            const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#EA4335';
            const tooltip = `${d._brand}: Rank ${d.average_organic_rank}, Share ${d.click_share}%`;
            return [d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: 5; }`, tooltip];
        });

        data.addRows(rows);

        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: -1}, // Invert axis
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'},
            trendlines: { 0: { type: 'polynomial', degree: 2, color: 'gray', opacity: 0.5, visibleInLegend: false } }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --------------------------------------------------------------------------
    // 4. TEXT ANALYSIS & LOGIC
    // --------------------------------------------------------------------------
    function populateTextAnalysis() {
        // --- Global Trend Text ---
        const thisWeekData = cleanData.filter(d => d.week_date === lastWeek);
        const prevWeekData = cleanData.filter(d => d.week_date === prevWeek);
        
        const calcMetrics = (data) => {
            const ourShare = data.filter(d => d.is_yaba_asin === 'Y').reduce((s,x)=>s+x.click_share,0);
            const totalClicks = data.reduce((s,x)=>s+x._clicks,0);
            return { ourShare, totalClicks };
        };

        const curr = calcMetrics(thisWeekData);
        const prev = calcMetrics(prevWeekData);

        const shareDiff = curr.ourShare - prev.ourShare;
        const trendText = shareDiff > 0 ? "gaining visibility" : "losing visibility";
        const trendColor = shareDiff > 0 ? "positive" : "negative";
        
        document.getElementById('trend_analysis_text').innerHTML = 
            `Comparing the last week (${lastWeek}) vs previous, our brand is <strong class="${trendColor}">${trendText}</strong> (${shareDiff.toFixed(1)}% change). 
            Total category interest (clicks) is ${curr.totalClicks > prev.totalClicks ? 'up' : 'down'}.`;
        
        document.getElementById('metric_total_clicks').innerText = curr.totalClicks.toLocaleString();
        document.getElementById('metric_click_share').innerHTML = 
            `${curr.ourShare.toFixed(1)}% <span class="metric-delta ${trendColor}">${shareDiff > 0 ? '+' : ''}${shareDiff.toFixed(1)}%</span>`;

        // --- Brand Insight ---
        const topComp = topCompetitors[0] || "None";
        document.getElementById('brand_insight').innerText = 
            `The main threat is ${topComp}. Monitor their pricing and promo movements closely.`;

        // --- Levers (Price/Deals) ---
        // Simple logic: Did we have deals last week?
        const ourDeals = thisWeekData.filter(d => d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_deal > 0).length > 0;
        const compDeals = thisWeekData.filter(d => d.is_yaba_asin === 'N' && d.weekly_number_of_days_with_deal > 0).length > 0;
        
        let leverHtml = `<ul class="insights-list">`;
        leverHtml += `<li><strong>Price Strategy:</strong> Our average price is $${thisWeekData.find(d=>d.is_yaba_asin==='Y')?.price || '-'} vs Competitor Avg $${thisWeekData.find(d=>d.is_yaba_asin==='N')?.price || '-'}.</li>`;
        leverHtml += `<li><strong>Deals:</strong> ${ourDeals ? '<span class="badge badge-green">Active</span>' : 'Inactive'} this week. ${compDeals ? 'Competitors are active.' : 'Competitors are quiet.'}</li>`;
        leverHtml += `</ul>`;
        document.getElementById('levers_content').innerHTML = leverHtml;

        // --- Insights & Actions ---
        const insights = [];
        const actions = [];

        // 1. Trend Insight
        if (shareDiff < 0) {
            insights.push("Click Share dropped recently. Investigate competitor deal activity.");
            actions.push("Consider a short-term coupon (5-10%) to regain lost ground.");
        } else {
            insights.push("Positive momentum in Click Share. Current strategy is working.");
            actions.push("Maintain pricing but monitor competitor inventory levels.");
        }

        // 2. Rank Insight
        const ourRank = thisWeekData.find(d => d.is_yaba_asin === 'Y')?.average_organic_rank || 0;
        if (ourRank > 5) {
            insights.push(`Organic Rank (${ourRank}) is low, hurting visibility.`);
            actions.push("Optimize backend keywords and Title for 'keywords' found in data.");
        }

        // 3. Price Insight
        const myPrice = thisWeekData.find(d => d.is_yaba_asin === 'Y')?.price || 0;
        const compPrice = thisWeekData.find(d => d.is_yaba_asin === 'N' && d._brand === topCompetitors[0])?.price || 0;
        
        if (myPrice > compPrice * 1.2) {
            insights.push(`We are significantly more expensive (+20%) than ${topCompetitors[0]}.`);
            actions.push("Justify premium with A+ Content or consider price matching.");
        }

        // Render Lists
        document.getElementById('list_insights').innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        document.getElementById('list_actions').innerHTML = actions.map(i => `<li>${i}</li>`).join('');
    }

    // --------------------------------------------------------------------------
    // 5. INTERACTIVE SECTION
    // --------------------------------------------------------------------------
    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(`tab-${tabId}`).classList.remove('hidden');
        event.target.classList.add('active');
        
        if(tabId === 'interactive') drawInteractiveChart();
    }

    function populateInteractiveDropdowns() {
        const sel = document.getElementById('sel_competitor');
        topCompetitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            sel.appendChild(opt);
        });
    }

    function drawInteractiveChart() {
        const metric = document.getElementById('sel_metric').value;
        const competitor = document.getElementById('sel_competitor').value;
        if (!competitor) return; // Wait for load

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', ourBrand);
        data.addColumn('number', competitor);

        const rows = weeks.map(week => {
            const getVal = (brand) => {
                const rec = cleanData.find(d => d.week_date === week && d._brand === brand);
                return rec ? rec[metric] : 0;
            };
            return [week.substring(5), getVal(ourBrand), getVal(competitor)];
        });

        data.addRows(rows);

        const options = {
            title: `${metric} Comparison: Us vs ${competitor}`,
            curveType: 'function',
            legend: {position: 'bottom'},
            colors: ['#4285F4', '#EA4335'],
            chartArea: {width: '90%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_interactive'));
        chart.draw(data, options);
    }

    // Handle Resize
    window.addEventListener('resize', drawAllCharts);

</script>

</body>
</html>