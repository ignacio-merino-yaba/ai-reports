<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Mercado Parent ASIN: NaturaleBio</title>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* Base Apple-like Styling */
        :root {
            --primary: #0071e3;
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --text-sec: #86868b;
            --border: #d2d2d7;
            --success: #34c759;
            --danger: #ff3b30;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1, h2, h3 {
            font-weight: 600;
            margin-bottom: 0.5em;
        }

        h1 { font-size: 28px; }
        h2 { font-size: 22px; margin-top: 30px; }
        h3 { font-size: 18px; color: var(--text-sec); }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
            color: var(--primary);
        }

        .kpi-label {
            font-size: 14px;
            color: var(--text-sec);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trend-up { color: var(--success); font-size: 14px; display: flex; align-items: center; }
        .trend-down { color: var(--danger); font-size: 14px; display: flex; align-items: center; }

        /* Charts */
        .chart-container {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            height: 400px;
        }

        /* Insights Section */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .insight-card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 24px;
            border-left: 5px solid var(--primary);
        }
        .insight-card.warning { border-left-color: var(--danger); }
        .insight-card.success { border-left-color: var(--success); }

        .insight-title {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        ul.rec-list {
            padding-left: 20px;
            margin: 0;
        }
        ul.rec-list li {
            margin-bottom: 8px;
            color: var(--text-sec);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-sec);
            cursor: pointer;
            border-radius: 8px;
        }

        .tab-btn.active {
            background: rgba(0, 113, 227, 0.1);
            color: var(--primary);
        }

        /* Comparator */
        .comparator-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }
        
        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            background: var(--card-bg);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .data-table th {
            background: #f9f9f9;
            font-weight: 600;
            color: var(--text-sec);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-our { background: #e3f2fd; color: #1565c0; }
        .badge-comp { background: #ffebee; color: #c62828; }

    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="margin-bottom: 4px;">An√°lisis de Parent ASIN: NaturaleBio</h1>
            <span style="color: var(--text-sec);">√öltima semana: 2026-06</span>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 12px; color: var(--text-sec);">MARKET INTELLIGENCE</div>
            <div style="font-weight: bold; color: var(--primary);">AMAZON EU</div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('comparator')">Comparador Interactivo</button>
    </div>

    <!-- Pesta√±a 1: Reporte Est√°tico -->
    <div id="report-tab">
        
        <!-- KPI Row -->
        <div class="kpi-grid">
            <div class="card">
                <div class="kpi-label">Cuota de Mercado (NaturaleBio)</div>
                <div class="kpi-value">16.8%</div>
                <div class="trend-up"><span class="material-icons">trending_up</span> +2.2% vs prev</div>
            </div>
            <div class="card">
                <div class="kpi-label">Ranking Medio Org√°nico</div>
                <div class="kpi-value">#4.6</div>
                <div class="trend-up"><span class="material-icons">check_circle</span> Estable Top 5</div>
            </div>
            <div class="card">
                <div class="kpi-label">Precio Medio Ponderado</div>
                <div class="kpi-value">‚Ç¨20.54</div>
                <div class="trend-down"><span class="material-icons">info</span> vs Mkt ‚Ç¨19.69</div>
            </div>
            <div class="card">
                <div class="kpi-label">Top Competidor</div>
                <div class="kpi-value" style="font-size: 24px;">NORITUAL LAB</div>
                <div class="trend-down" style="color: var(--text-sec);">18.9% Share</div>
            </div>
        </div>

        <h2>1. Tendencia Global del Parent</h2>
        <div class="chart-container" id="chart_trend"></div>
        <p style="color: var(--text-sec); font-size: 14px; margin-top: -10px;">*Barras: Volumen Clics Mercado | L√≠nea: % Share NaturaleBio</p>

        <h2>2. Competitividad de Marca (Share of Voice)</h2>
        <div class="chart-container" id="chart_competitiveness"></div>

        <div class="insights-grid" style="margin-top: 30px;">
            <div class="insight-card warning">
                <div class="insight-title"><span class="material-icons" style="color:var(--danger)">warning</span> Amenaza Competitiva</div>
                <p><strong>NORITUAL LAB</strong> domina el segmento con un 18.9% de cuota (+2.1% sem/sem). A pesar de tener un precio similar al nuestro (~‚Ç¨23), su ASIN B0CNRX8G5S captura m√°s tr√°fico manteniendo el Rank #1 consistentemente.</p>
            </div>
            <div class="insight-card success">
                <div class="insight-title"><span class="material-icons" style="color:var(--success)">trending_up</span> Crecimiento Org√°nico</div>
                <p>Nuestra marca <strong>NaturaleBio</strong> ha recuperado terreno, pasando del 14.6% al 16.8% de share. El motor principal es el ASIN B06XQ5DCYJ (Precio ‚Ç¨14.34), que defiende la posici√≥n #2 org√°nicamente.</p>
            </div>
        </div>

        <h2>3. Organic Rank vs Click Share (Eficiencia)</h2>
        <div class="chart-container" id="chart_efficiency"></div>

        <h2>4. Palancas y Promociones</h2>
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-title"><span class="material-icons">local_offer</span> An√°lisis de Deals</div>
                <p>El mercado es promocionalmente activo. Competidores como <strong>VAHDAM</strong> y <strong>Monte Nativo</strong> activaron Deals durante 7 d√≠as en la semana 2026-06. Nosotros mantuvimos precio completo, lo que protegi√≥ el margen pero limit√≥ la expansi√≥n de cuota frente a agresivos descuentos.</p>
            </div>
            <div class="insight-card warning">
                <div class="insight-title"><span class="material-icons">confirmation_number</span> Oportunidad de Cupones</div>
                <p>El competidor <strong>Special Leaves</strong> (ASIN B0DRP6Y6XC) mantiene una cuota relevante del 5.5% utilizando <strong>Cupones activos los 7 d√≠as</strong>. Dado que su rango de precio es bajo (‚Ç¨9.17), atacan el segmento sensible al precio donde no estamos compitiendo agresivamente.</p>
            </div>
        </div>

        <h2>5. Recomendaciones Accionables</h2>
        <div class="card" style="border-left: 5px solid var(--primary);">
            <ul class="rec-list">
                <li><strong>1. Defensa del Top Rank:</strong> Activar cup√≥n del 5-10% en el ASIN B06XQ5DCYJ para intentar desbancar a NORITUAL LAB del Rank #1. La diferencia de visibilidad entre Rank #1 y #2 es cr√≠tica.</li>
                <li><strong>2. Premium Tier Push:</strong> Nuestros ASINs de gama alta (B07SZFD3P9, ‚Ç¨23.19) tienen baja tracci√≥n (<3% share). Revisar contenido A+ y considerar Sponsored Products defensivos en keywords de "Ceremonial Matcha" donde NORITUAL es fuerte.</li>
                <li><strong>3. Monitorizaci√≥n de Precios:</strong> El precio medio del mercado es ‚Ç¨19.69. Estamos ligeramente por encima (‚Ç¨20.54). No bajar precios directamente, pero justificar el premium mediante optimizaci√≥n de listado (destacar origen Jap√≥n/Bio).</li>
            </ul>
        </div>
    </div>

    <!-- Pesta√±a 2: Comparador Interactivo -->
    <div id="comparator-tab" style="display: none;">
        <h2>Comparador Cara a Cara</h2>
        <div class="comparator-controls">
            <select id="comp-week-select" onchange="renderComparator()">
                <!-- Populated by JS -->
            </select>
            <select id="comp-brand-select" onchange="renderComparator()">
                <option value="NORITUAL LAB">NORITUAL LAB (L√≠der)</option>
                <option value="Special Leaves">Special Leaves (Low Cost)</option>
                <option value="Ceremonial">Ceremonial (Gen√©rico)</option>
                <option value="Monte Nativo">Monte Nativo</option>
            </select>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="card">
                <h3>Nuestra Marca (NaturaleBio)</h3>
                <div id="our-stats"></div>
            </div>
            <div class="card" style="border: 1px solid var(--danger);">
                <h3 id="comp-name-header" style="color: var(--danger);">Competidor</h3>
                <div id="comp-stats"></div>
            </div>
        </div>

        <h3>Detalle de ASINs (Semana Seleccionada)</h3>
        <div style="overflow-x: auto;">
            <table class="data-table" id="comparison-table">
                <thead>
                    <tr>
                        <th>ASIN</th>
                        <th>Marca</th>
                        <th>T√≠tulo</th>
                        <th>Precio</th>
                        <th>Share %</th>
                        <th>Rank</th>
                        <th>Badges</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

<!-- DATA INJECTION -->
<script type="text/javascript">
    // Injected Data from Python Analysis
    const marketData = [{"week": "2026-04", "asin": "B0CNRX8G5S", "brand": "NORITUAL LAB", "is_yaba": "N", "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "click_share": 16.83, "clicks": 8088.176546999998, "price": 22.9, "rank": 1.0, "deal_days": 0, "coupon_days": 0, "choice_days": 7, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B0FWCJD5Y4", "brand": "Ceremonial", "is_yaba": "N", "title": "Ceremonial Matcha Uji - Reines Gr\u00fcntee-Pulver aus ...", "click_share": 3.79, "clicks": 1821.401611, "price": 39.9, "rank": 9.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B0C3FBKSLB", "brand": "Monte Nativo", "is_yaba": "N", "title": "Bio Matcha Pulver Monte Nativo (100g) - Matcha Tee...", "click_share": 3.01, "clicks": 1446.5485089999997, "price": 9.95, "rank": 4.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B0FSL3C3Z8", "brand": "Ceremonial", "is_yaba": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 10.19, "clicks": 4897.119370999999, "price": 14.9, "rank": 9.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B0FSL3C3Z8", "brand": "NORITUAL LAB", "is_yaba": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 10.19, "clicks": 4897.119370999999, "price": 14.9, "rank": 9.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B0DRP6Y6XC", "brand": "Matcha", "is_yaba": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "click_share": 5.21, "clicks": 2503.826489, "price": 9.064285714, "rank": 14.0, "deal_days": 0, "coupon_days": 7, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B0DRP6Y6XC", "brand": "Special Leaves", "is_yaba": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "click_share": 5.21, "clicks": 2503.826489, "price": 9.064285714, "rank": 14.0, "deal_days": 0, "coupon_days": 7, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B07MD4LB49", "brand": "VAHDAM", "is_yaba": "N", "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "click_share": 2.22, "clicks": 1066.889598, "price": 8.275714286, "rank": 16.0, "deal_days": 6, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B0F9B1LWQQ", "brand": "UNREAL\u00ae", "is_yaba": "N", "title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "click_share": 2.51, "clicks": 1206.2580589999998, "price": 29.95, "rank": 17.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B079VQ52MK", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 1.86, "clicks": 893.880474, "price": 23.49, "rank": 7.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 12.78, "clicks": 6141.823901999999, "price": 13.99, "rank": 2.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-04", "asin": "B07K1WBH4K", "brand": "VAHDAM", "is_yaba": "N", "title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "click_share": 3.2, "clicks": 1537.85888, "price": 7.99, "rank": 11.0, "deal_days": 7, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0DRP6Y6XC", "brand": "Matcha", "is_yaba": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "click_share": 5.49, "clicks": 2350.531422, "price": 9.178571429, "rank": 10.0, "deal_days": 0, "coupon_days": 7, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B07SZFD3P9", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "click_share": 2.84, "clicks": 1215.939752, "price": 23.192, "rank": 7.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0F9B1LWQQ", "brand": "UNREAL\u00ae", "is_yaba": "N", "title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "click_share": 2.17, "clicks": 929.080726, "price": 30.715714286, "rank": 9.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0FSL3C3Z8", "brand": "Ceremonial", "is_yaba": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 8.89, "clicks": 3806.2339420000003, "price": 15.281428571, "rank": 8.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0FSL3C3Z8", "brand": "NORITUAL LAB", "is_yaba": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 8.89, "clicks": 3806.2339420000003, "price": 15.281428571, "rank": 8.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0FJM1MBLM", "brand": "Ceremonial", "is_yaba": "N", "title": "Ceremonial Matcha Kiri - Reines Gr\u00fcntee-Pulver aus...", "click_share": 5.22, "clicks": 2234.9315159999996, "price": 34.787142857, "rank": 11.0, "deal_days": 7, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0FXY37ZS1", "brand": "Ceremonial", "is_yaba": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 3.74, "clicks": 1601.272772, "price": 30.664285714, "rank": 6.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0C3FBKSLB", "brand": "Monte Nativo", "is_yaba": "N", "title": "Bio Matcha Pulver Monte Nativo (100g) - Matcha Tee...", "click_share": 4.78, "clicks": 2046.546484, "price": 8.675714286, "rank": 5.0, "deal_days": 7, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B079VQ52MK", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 2.39, "clicks": 1023.273242, "price": 24.09, "rank": 5.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0CNRX8G5S", "brand": "NORITUAL LAB", "is_yaba": "N", "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "click_share": 18.92, "clicks": 8100.5563760000005, "price": 23.485714286, "rank": 1.0, "deal_days": 0, "coupon_days": 0, "choice_days": 1, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B0DRP6Y6XC", "brand": "Special Leaves", "is_yaba": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "click_share": 5.49, "clicks": 2350.531422, "price": 9.178571429, "rank": 10.0, "deal_days": 0, "coupon_days": 7, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}, {"week": "2026-06", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "is_yaba": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 11.61, "clicks": 4970.795958, "price": 14.347142857, "rank": 2.0, "deal_days": 0, "coupon_days": 0, "choice_days": 0, "bs_days": 0, "link": "https://www.amazon.de/s?k=matcha"}];

    // Load Google Charts
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initCharts);

    let weeks = [...new Set(marketData.map(d => d.week))].sort();
    
    // Tab Switching Logic
    function switchTab(tabId) {
        document.getElementById('report-tab').style.display = tabId === 'report' ? 'block' : 'none';
        document.getElementById('comparator-tab').style.display = tabId === 'comparator' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if(tabId === 'comparator') renderComparator();
    }

    // Chart Initialization
    function initCharts() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawEfficiencyChart();
        populateComparatorControls();
    }

    // 1. Trend Chart
    function drawTrendChart() {
        let data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Clics Totales Mercado');
        data.addColumn('number', 'Share NaturaleBio (%)');

        let aggregated = {};
        weeks.forEach(w => {
            let weekData = marketData.filter(d => d.week === w);
            let totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
            let myShare = weekData.filter(d => d.is_yaba === 'Y').reduce((sum, d) => sum + d.click_share, 0);
            aggregated[w] = [totalClicks, myShare];
        });

        Object.keys(aggregated).sort().forEach(w => {
            data.addRow([w, aggregated[w][0], aggregated[w][1]]);
        });

        let options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#0071e3', lineWidth: 3}},
            colors: ['#e0e0e0'],
            vAxes: {0: {title: 'Volumen Clics'}, 1: {title: '% Share', format: '#\'%\''}},
            legend: {position: 'top'},
            chartArea: {width: '80%', height: '70%'}
        };

        new google.visualization.ComboChart(document.getElementById('chart_trend')).draw(data, options);
    }

    // 2. Competitiveness Chart
    function drawCompetitivenessChart() {
        let data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'NaturaleBio');
        data.addColumn('number', 'NORITUAL LAB');
        data.addColumn('number', 'Ceremonial'); // Generic/Other top
        data.addColumn('number', 'Resto');

        let rows = [];
        weeks.forEach(w => {
            let wd = marketData.filter(d => d.week === w);
            // Aggregate by brand
            let shareMap = { 'NaturaleBio': 0, 'NORITUAL LAB': 0, 'Ceremonial': 0, 'Resto': 0 };
            
            wd.forEach(item => {
                let b = item.brand;
                if (b === 'NaturaleBio' || b === 'NORITUAL LAB' || b === 'Ceremonial') {
                    shareMap[b] += item.click_share;
                } else {
                    shareMap['Resto'] += item.click_share;
                }
            });
            rows.push([w, shareMap['NaturaleBio'], shareMap['NORITUAL LAB'], shareMap['Ceremonial'], shareMap['Resto']]);
        });

        data.addRows(rows);

        let options = {
            curveType: 'function',
            colors: ['#0071e3', '#ff3b30', '#ff9500', '#86868b'],
            lineWidth: 3,
            vAxis: {title: '% Click Share'},
            legend: {position: 'top'}
        };

        new google.visualization.LineChart(document.getElementById('chart_competitiveness')).draw(data, options);
    }

    // 3. Efficiency Chart (Scatter)
    function drawEfficiencyChart() {
        let data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({'type': 'string', 'role': 'style'});
        data.addColumn({'type': 'string', 'role': 'tooltip'});

        let latestWeek = weeks[weeks.length - 1];
        let wd = marketData.filter(d => d.week === latestWeek);

        wd.forEach(d => {
            let color = d.is_yaba === 'Y' ? 'point { fill-color: #0071e3; size: 10; }' : 'point { fill-color: #86868b; }';
            if (d.brand === 'NORITUAL LAB') color = 'point { fill-color: #ff3b30; size: 8; }';
            
            let tooltip = `${d.brand}\nRank: ${d.rank}\nShare: ${d.click_share}%\nPrecio: ‚Ç¨${d.price}`;
            data.addRow([d.rank, d.click_share, color, tooltip]);
        });

        let options = {
            hAxis: {title: 'Ranking Org√°nico (Menor es mejor)', direction: 1}, // 1 is normal, but rank 1 is left usually
            vAxis: {title: '% Click Share'},
            legend: 'none',
            tooltip: {isHtml: false}
        };

        new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(data, options);
    }

    // --- Comparator Logic ---

    function populateComparatorControls() {
        let weekSel = document.getElementById('comp-week-select');
        weeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        weekSel.value = weeks[weeks.length - 1]; // Select latest
    }

    function renderComparator() {
        let week = document.getElementById('comp-week-select').value;
        let compBrand = document.getElementById('comp-brand-select').value;
        document.getElementById('comp-name-header').innerText = compBrand;

        let weekData = marketData.filter(d => d.week === week);
        
        let ourData = weekData.filter(d => d.is_yaba === 'Y');
        let compData = weekData.filter(d => d.brand === compBrand);

        // Stats calculation
        function calcStats(data) {
            if(data.length === 0) return {price: 0, share: 0, count: 0};
            let totalShare = data.reduce((s, c) => s + c.click_share, 0);
            let avgPrice = data.reduce((s, c) => s + c.price, 0) / data.length;
            return {price: avgPrice.toFixed(2), share: totalShare.toFixed(2), count: data.length};
        }

        let s1 = calcStats(ourData);
        let s2 = calcStats(compData);

        document.getElementById('our-stats').innerHTML = `
            <div class="kpi-value" style="font-size:20px">‚Ç¨${s1.price}</div>
            <div style="font-size:12px; color:var(--text-sec)">Precio Medio</div>
            <div class="kpi-value" style="font-size:20px; color:var(--primary)">${s1.share}%</div>
            <div style="font-size:12px; color:var(--text-sec)">Cuota Total</div>
        `;

        document.getElementById('comp-stats').innerHTML = `
            <div class="kpi-value" style="font-size:20px">‚Ç¨${s2.price}</div>
            <div style="font-size:12px; color:var(--text-sec)">Precio Medio</div>
            <div class="kpi-value" style="font-size:20px; color:var(--danger)">${s2.share}%</div>
            <div style="font-size:12px; color:var(--text-sec)">Cuota Total</div>
        `;

        // Table
        let tbody = document.querySelector('#comparison-table tbody');
        tbody.innerHTML = '';
        
        // Combine and sort by Share
        let combined = [...ourData, ...compData].sort((a,b) => b.click_share - a.click_share);

        combined.forEach(d => {
            let row = tbody.insertRow();
            let isUs = d.is_yaba === 'Y';
            let badge = isUs ? '<span class="badge badge-our">NOSOTROS</span>' : '<span class="badge badge-comp">COMPETENCIA</span>';
            
            let promo = '';
            if(d.coupon_days > 0) promo += 'üè∑Ô∏è Coupon ';
            if(d.deal_days > 0) promo += '‚ö° Deal';
            if(d.choice_days > 0) promo += '‚≠ê Choice';

            row.innerHTML = `
                <td><a href="${d.link}" target="_blank" style="color:var(--primary); text-decoration:none;">${d.asin}</a></td>
                <td>${badge}</td>
                <td style="font-size:12px; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${d.title}</td>
                <td>‚Ç¨${d.price.toFixed(2)}</td>
                <td><strong>${d.click_share}%</strong></td>
                <td>#${d.rank}</td>
                <td style="font-size:11px;">${promo}</td>
            `;
        });
    }

</script>

</body>
</html>