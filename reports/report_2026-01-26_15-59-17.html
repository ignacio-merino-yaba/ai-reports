<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        :root {
            --primary-color: #0071e3; /* Amazon/Tech Blue */
            --secondary-color: #1d1d1f; /* Dark Text */
            --bg-color: #f5f5f7; /* Apple Light Gray */
            --card-bg: #ffffff;
            --accent-green: #34c759;
            --accent-red: #ff3b30;
            --border-radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--secondary-color);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }
        .date-badge {
            background: #e3e3e3;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: rgba(0,0,0,0.05);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        /* KPIs */
        .kpi-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
        .kpi-sub { font-size: 14px; color: #86868b; }
        .trend-up { color: var(--accent-green); }
        .trend-down { color: var(--accent-red); }

        /* Insights List */
        ul.insights-list {
            padding-left: 20px;
            margin: 0;
        }
        ul.insights-list li {
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .recommendation-card {
            background: #f0f9ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        /* Interactive Selectors */
        select {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid #d2d2d7;
            background: white;
            font-family: inherit;
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
        }

        /* Comparison Table */
        .comp-table-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .comp-value { font-weight: 600; }
        .our-brand-text { color: var(--primary-color); font-weight: 700; }
        
        /* Utility */
        .hidden { display: none; }
        .chart-container { height: 350px; width: 100%; }
        
        /* Specific Google Chart overrides */
        text { font-family: 'Inter', sans-serif !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Análisis de Parent ASIN: Matcha Premium</h1>
            <div style="font-size: 14px; color: #666; margin-top: 4px;">Brand: <span style="color:var(--primary-color); font-weight:600;">NaturaleBio</span></div>
        </div>
        <div class="date-badge">Última semana: 2026-01</div>
    </header>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Ejecutivo</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: EXECUTIVE REPORT -->
    <div id="tab-report">
        
        <!-- SECTION 1: GLOBAL TREND -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">show_chart</span>
                1. Tendencia Global del Parent (Tracción y Cuota)
            </div>
            <div class="grid-3" style="margin-bottom: 20px;">
                <div>
                    <div class="kpi-sub">Total Clicks (Semana Actual)</div>
                    <div class="kpi-value" id="total-clicks">--</div>
                    <div class="kpi-sub" id="clicks-trend">--</div>
                </div>
                <div>
                    <div class="kpi-sub">Nuestra Cuota de Clicks</div>
                    <div class="kpi-value" style="color:var(--primary-color);" id="our-share">--</div>
                    <div class="kpi-sub" id="share-trend">--</div>
                </div>
                <div>
                    <div class="kpi-sub">Search Volume Mercado</div>
                    <div class="kpi-value" id="market-vol">--</div>
                    <div class="kpi-sub trend-down">Caída estacional post-Q4</div>
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="recommendation-card" style="margin-top:15px; font-size: 14px;">
                <strong>Diagnóstico:</strong> El mercado sufrió una fuerte contracción de volumen (-44%) tras la semana 52 (efecto post-navidad), pero <b>NaturaleBio</b> logró incrementar su cuota (+0.76pp), mostrando resiliencia orgánica frente a competidores que dependen más de la estacionalidad.
            </div>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Click Share)
            </div>
            <div class="grid-2">
                <div id="chart_share" class="chart-container"></div>
                <div>
                    <div class="kpi-sub" style="margin-bottom:10px;">Top Competidores (Share Actual):</div>
                    <ul class="insights-list" style="font-size: 14px; color: #444;">
                        <li><strong style="color: #db4437;">NORITUAL LAB (26.7%):</strong> Líder indiscutible. Mantiene badge "Amazon Choice" en 4 de 7 días.</li>
                        <li><strong style="color: var(--primary-color);">NaturaleBio (22.6%):</strong> Segunda posición sólida. Crecimiento impulsado por el ASIN B06XQ5DCYJ.</li>
                        <li><strong>VAHDAM (3.2%):</strong> Jugador de nicho, pierde fuerza (-1.0pp) al reducir Deal Days.</li>
                    </ul>
                    <div style="margin-top: 20px; padding: 10px; background: #eee; border-radius: 8px; font-size: 13px;">
                        <em>Insight:</em> La polarización es clara. Dos marcas (NORITUAL y NaturaleBio) controlan casi el 50% de los clicks. El resto del mercado está muy fragmentado.
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: LEVERS & EFFICIENCY -->
        <div class="grid-2">
            <!-- LEVERS -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">tune</span>
                    3. Palancas & Promociones
                </div>
                <div id="chart_levers" style="height: 250px;"></div> <!-- Placeholder logic -->
                <ul class="insights-list" style="font-size: 13px; margin-top: 15px;">
                    <li><strong>Precio:</strong> NORITUAL defiende su liderazgo con un precio medio (~24€) ligeramente inferior a nuestro mix (~25-30€).</li>
                    <li><strong>Deals:</strong> VAHDAM usó agresivamente Deals en Sem 52 para capturar cuota, pero cayó al desactivarlos.</li>
                    <li><strong>Badges:</strong> El "Amazon Choice" de NORITUAL es el driver de conversión más potente actualmente.</li>
                </ul>
            </div>

            <!-- EFFICIENCY -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Eficiencia (Rank vs Share)
                </div>
                <div id="chart_efficiency" style="height: 250px;"></div>
                <div class="recommendation-card" style="margin-top:10px; font-size:12px;">
                    <strong>Eficiencia:</strong> Nuestros ASINs (Puntos Azules) se sitúan en la zona de "Alta Eficiencia" (Top Rank + High Share). El ASIN B06XQ5DCYJ es un 'Overperformer'.
                </div>
            </div>
        </div>

        <!-- SECTION 5: CONCLUSIONS -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones y Recomendaciones Accionables
            </div>
            
            <div class="grid-2">
                <div>
                    <h3 style="font-size:14px; text-transform:uppercase; color:#666;">Insights Clave</h3>
                    <ul class="insights-list">
                        <li><strong>Resiliencia Post-Q4:</strong> A pesar de la caída del 44% en búsquedas de la categoría, NaturaleBio incrementó su cuota de mercado, validando la fidelidad de marca.</li>
                        <li><strong>Amenaza Principal:</strong> NORITUAL LAB nos supera en Click Share (+4pp) gracias a una estrategia de precio ligeramente inferior y dominancia del badge Amazon Choice.</li>
                        <li><strong>Eficiencia Orgánica:</strong> Tenemos mejor posicionamiento orgánico promedio (Rank 2-5) que la mayoría, lo que nos protege de guerras de precios agresivas.</li>
                        <li><strong>Dependencia de Variante:</strong> Gran parte de nuestro éxito recae en el ASIN B06XQ5DCYJ. Las otras variantes tienen visibilidad reducida.</li>
                        <li><strong>Oportunidad en Deals:</strong> Nuestra actividad promocional (Deals/Cupones) fue nula en la última semana, mientras competidores nicho (Special Leaves) usan cupones para robar tráfico marginal.</li>
                    </ul>
                </div>
                <div>
                    <h3 style="font-size:14px; text-transform:uppercase; color:#666;">Recomendaciones (Accionables)</h3>
                    
                    <div class="recommendation-card">
                        <strong>1. Atacar Badge Amazon Choice:</strong> Analizar la tasa de conversión y velocidad de ventas de NORITUAL. Ajustar precio temporalmente o usar PPC agresivo en keywords "ceremonial" para intentar arrebatar la etiqueta AC.
                    </div>
                    
                    <div class="recommendation-card">
                        <strong>2. Reactivar Palancas en Variantes Bajas:</strong> Los ASINs secundarios (B07SZFD3P9) han perdido tracción. Activar un cupón de 5-10% para reactivar su CTR y Rank sin erosionar el precio del Hero ASIN.
                    </div>
                    
                    <div class="recommendation-card">
                        <strong>3. Defensa de Precio Premium:</strong> Dado que ganamos share pese a tener un precio superior al promedio, mantener el posicionamiento Premium pero vigilar si NORITUAL baja de los 23€ (punto de dolor).
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-title">Comparador "Cara a Cara"</div>
            <div style="display:flex; gap: 20px; align-items:center; margin-bottom: 30px;">
                <div>
                    <label style="display:block; font-size:12px; margin-bottom:5px; font-weight:600;">Semana de Análisis</label>
                    <select id="week-selector" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div>
                    <label style="display:block; font-size:12px; margin-bottom:5px; font-weight:600;">Competidor a Comparar</label>
                    <select id="comp-selector" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <div class="grid-2">
                <!-- Us -->
                <div style="text-align:center;">
                    <h3 style="color:var(--primary-color);">NaturaleBio (Nosotros)</h3>
                    <div style="font-size:48px; font-weight:700; color:var(--primary-color);" id="int-our-share">--%</div>
                    <div style="font-size:14px; color:#666;">Click Share</div>
                    
                    <div style="margin-top:20px; text-align:left;">
                        <div class="comp-table-row">
                            <span>Precio Promedio</span>
                            <span class="comp-value" id="int-our-price">--</span>
                        </div>
                        <div class="comp-table-row">
                            <span>Rank Orgánico</span>
                            <span class="comp-value" id="int-our-rank">--</span>
                        </div>
                        <div class="comp-table-row">
                            <span>Días con Deal/Cupones</span>
                            <span class="comp-value" id="int-our-deals">--</span>
                        </div>
                    </div>
                </div>

                <!-- Them -->
                <div style="text-align:center; border-left: 1px solid #eee;">
                    <h3 style="color:#db4437;" id="int-comp-name">Competidor</h3>
                    <div style="font-size:48px; font-weight:700; color:#db4437;" id="int-comp-share">--%</div>
                    <div style="font-size:14px; color:#666;">Click Share</div>

                    <div style="margin-top:20px; text-align:left; padding-left:20px;">
                        <div class="comp-table-row">
                            <span>Precio Promedio</span>
                            <span class="comp-value" id="int-comp-price">--</span>
                        </div>
                        <div class="comp-table-row">
                            <span>Rank Orgánico</span>
                            <span class="comp-value" id="int-comp-rank">--</span>
                        </div>
                        <div class="comp-table-row">
                            <span>Días con Deal/Cupones</span>
                            <span class="comp-value" id="int-comp-deals">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align:center;">
                <div id="chart_comparison" style="height: 300px; width:100%;"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // DATA INJECTION FROM PYTHON PROCESSING
    const marketData = [{"week": "2025-52", "brand": "NaturaleBio", "is_us": "Y", "clicks": 5566.15, "share": 11.66, "rank": 2.0, "price": 15.06, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ5DCYJ"}, {"week": "2025-52", "brand": "VAHDAM", "is_us": "N", "clicks": 701.74, "share": 1.47, "rank": 20.0, "price": 9.9, "deal_days": 3.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "asin": "B07K1WBH4K"}, {"week": "2025-52", "brand": "Special Leaves", "is_us": "N", "clicks": 1623.06, "share": 3.4, "rank": 13.0, "price": 10.71, "deal_days": 0.0, "coupon_days": 7.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC"}, {"week": "2025-52", "brand": "Matcha", "is_us": "N", "clicks": 1623.06, "share": 3.4, "rank": 13.0, "price": 10.71, "deal_days": 0.0, "coupon_days": 7.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC"}, {"week": "2025-52", "brand": "Bio", "is_us": "N", "clicks": 1164.79, "share": 2.44, "rank": 10.0, "price": 12.37, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "asin": "B08XVX8V1T"}, {"week": "2025-52", "brand": "bioKontor", "is_us": "N", "clicks": 1164.79, "share": 2.44, "rank": 10.0, "price": 12.37, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "asin": "B08XVX8V1T"}, {"week": "2025-52", "brand": "NaturaleBio", "is_us": "Y", "clicks": 1398.7, "share": 2.93, "rank": 23.0, "price": 30.7, "deal_days": 1.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "asin": "B07SZFD3P9"}, {"week": "2025-52", "brand": "NORITUAL LAB", "is_us": "N", "clicks": 4019.47, "share": 8.42, "rank": 6.0, "price": 16.04, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8"}, {"week": "2025-52", "brand": "Ceremonial", "is_us": "N", "clicks": 4019.47, "share": 8.42, "rank": 6.0, "price": 16.04, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8"}, {"week": "2025-52", "brand": "NaturaleBio", "is_us": "Y", "clicks": 1666.03, "share": 3.49, "rank": 5.0, "price": 24.86, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B079VQ52MK"}, {"week": "2025-52", "brand": "NaturaleBio", "is_us": "Y", "clicks": 1790.14, "share": 3.75, "rank": 4.0, "price": 10.54, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ69YCQ"}, {"week": "2025-52", "brand": "NORITUAL LAB", "is_us": "N", "clicks": 8960.26, "share": 18.77, "rank": 2.0, "price": 24.65, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 7.0, "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "asin": "B0CNRX8G5S"}, {"week": "2025-52", "brand": "VAHDAM", "is_us": "N", "clicks": 2000.19, "share": 4.19, "rank": 7.0, "price": 9.9, "deal_days": 3.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "asin": "B07MD4LB49"}, {"week": "2026-01", "brand": "Special Leaves", "is_us": "N", "clicks": 807.96, "share": 3.0, "rank": 16.0, "price": 10.39, "deal_days": 0.0, "coupon_days": 4.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC"}, {"week": "2026-01", "brand": "Bio", "is_us": "N", "clicks": 643.68, "share": 2.39, "rank": 10.0, "price": 12.0, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "asin": "B08XVX8V1T"}, {"week": "2026-01", "brand": "bioKontor", "is_us": "N", "clicks": 643.68, "share": 2.39, "rank": 10.0, "price": 12.0, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "asin": "B08XVX8V1T"}, {"week": "2026-01", "brand": "VAHDAM", "is_us": "N", "clicks": 848.36, "share": 3.15, "rank": 9.0, "price": 10.43, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "asin": "B07MD4LB49"}, {"week": "2026-01", "brand": "NORITUAL LAB", "is_us": "N", "clicks": 1987.58, "share": 7.38, "rank": 6.0, "price": 15.56, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8"}, {"week": "2026-01", "brand": "NaturaleBio", "is_us": "Y", "clicks": 902.22, "share": 3.35, "rank": 5.0, "price": 10.22, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ69YCQ"}, {"week": "2026-01", "brand": "NaturaleBio", "is_us": "Y", "clicks": 985.71, "share": 3.66, "rank": 5.0, "price": 24.53, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B079VQ52MK"}, {"week": "2026-01", "brand": "NORITUAL LAB", "is_us": "N", "clicks": 5208.65, "share": 19.34, "rank": 2.0, "price": 23.91, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 4.0, "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "asin": "B0CNRX8G5S"}, {"week": "2026-01", "brand": "NaturaleBio", "is_us": "Y", "clicks": 3474.23, "share": 12.9, "rank": 2.0, "price": 14.61, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "asin": "B06XQ5DCYJ"}, {"week": "2026-01", "brand": "NaturaleBio", "is_us": "Y", "clicks": 721.78, "share": 2.68, "rank": null, "price": 30.27, "deal_days": null, "coupon_days": null, "bs_days": null, "ac_days": null, "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "asin": "B07SZFD3P9"}, {"week": "2026-01", "brand": "Matcha", "is_us": "N", "clicks": 807.96, "share": 3.0, "rank": 16.0, "price": 10.39, "deal_days": 0.0, "coupon_days": 4.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "asin": "B0DRP6Y6XC"}, {"week": "2026-01", "brand": "Ceremonial", "is_us": "N", "clicks": 1987.58, "share": 7.38, "rank": 6.0, "price": 15.56, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "asin": "B0FSL3C3Z8"}, {"week": "2026-01", "brand": "UNREAL\u00ae", "is_us": "N", "clicks": 422.83, "share": 1.57, "rank": 19.0, "price": 31.27, "deal_days": 0.0, "coupon_days": 0.0, "bs_days": 0.0, "ac_days": 0.0, "title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "asin": "B0F9B1LWQQ"}];

    // INITIALIZATION
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        populateSelectors();
        drawTrends();
        drawBrandShare();
        drawEfficiency();
        updateKPIs();
    }

    // TAB LOGIC
    function switchTab(tabId) {
        document.getElementById('tab-report').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        event.target.classList.add('active');
        
        // Redraw interactive if selected to ensure width is correct
        if(tabId === 'interactive') updateInteractive();
    }

    // DATA PROCESSING HELPERS
    function getWeeks() {
        return [...new Set(marketData.map(d => d.week))].sort();
    }
    
    function getCompetitors() {
        return [...new Set(marketData.filter(d => d.is_us === 'N').map(d => d.brand))];
    }

    // CHART 1: TRENDS
    function drawTrends() {
        const weeks = getWeeks();
        const dataArray = [['Week', 'Nuestros Clicks', 'Clicks Competencia', 'Nuestra Cuota (%)']];
        
        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week === week);
            const ourClicks = weekData.filter(d => d.is_us === 'Y').reduce((s, c) => s + c.clicks, 0);
            const compClicks = weekData.filter(d => d.is_us === 'N').reduce((s, c) => s + c.clicks, 0);
            const totalClicks = ourClicks + compClicks;
            const share = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
            
            dataArray.push([week, ourClicks, compClicks, share]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1} },
            vAxes: { 0: {title: 'Volumen Clicks'}, 1: {title: 'Share %', format: '#\'%\''} },
            colors: ['#0071e3', '#999999', '#34c759'],
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    // CHART 2: BRAND SHARE LINES
    function drawBrandShare() {
        const weeks = getWeeks();
        // Identify top competitors globally
        const brandTotals = {};
        marketData.forEach(d => {
            if (d.is_us === 'N') {
                brandTotals[d.brand] = (brandTotals[d.brand] || 0) + d.share;
            }
        });
        const topComps = Object.entries(brandTotals)
            .sort((a,b) => b[1] - a[1])
            .slice(0,3)
            .map(e => e[0]);

        const header = ['Week', 'NaturaleBio', ...topComps, 'Resto'];
        const dataArray = [header];

        weeks.forEach(week => {
            const row = [week];
            const wData = marketData.filter(d => d.week === week);
            
            // Us
            const ourShare = wData.filter(d => d.is_us === 'Y').reduce((s, c) => s + c.share, 0);
            row.push(ourShare);

            // Top Comps
            let compSum = 0;
            topComps.forEach(comp => {
                const s = wData.filter(d => d.brand === comp).reduce((sum, c) => sum + c.share, 0);
                row.push(s);
                compSum += s;
            });

            // Rest
            const totalShare = wData.reduce((s, c) => s + c.share, 0);
            row.push(Math.max(0, totalShare - ourShare - compSum)); // Approx

            dataArray.push(row);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#0071e3', '#db4437', '#f4b400', '#0f9d58', '#e0e0e0'],
            chartArea: { width: '90%', height: '70%' },
            vAxis: { title: 'Click Share %' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_share'));
        chart.draw(data, options);
    }

    // CHART 4: EFFICIENCY (Scatter)
    function drawEfficiency() {
        const latestWeek = getWeeks().pop();
        const wData = marketData.filter(d => d.week === latestWeek && d.rank > 0 && d.share > 0);
        
        // Header: [Rank, Share, Tooltip, Color]
        // Actually Scatter needs [X, Y, {role: style}]
        const dataArray = [['Rank', 'Click Share', { role: 'style' }, { role: 'tooltip' }]];

        wData.forEach(d => {
            const color = d.is_us === 'Y' ? '#0071e3' : '#999';
            const tooltip = `${d.brand}\nRank: ${d.rank}\nShare: ${d.share}%\n${d.title.substring(0,30)}...`;
            dataArray.push([d.rank, d.share, `point { fill-color: ${color}; size: 6; }`, tooltip]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // Standard rank axis
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // KPIs & UTILS
    function updateKPIs() {
        const weeks = getWeeks();
        const latest = weeks[weeks.length-1];
        const prev = weeks[weeks.length-2];
        
        const lateData = marketData.filter(d => d.week === latest);
        const prevData = marketData.filter(d => d.week === prev);

        // Clicks
        const totalClicks = lateData.reduce((s, c) => s + c.clicks, 0);
        const prevClicks = prevData.reduce((s, c) => s + c.clicks, 0);
        
        document.getElementById('total-clicks').innerText = Math.round(totalClicks).toLocaleString();
        
        // Share
        const ourShare = lateData.filter(d => d.is_us === 'Y').reduce((s, c) => s + c.share, 0);
        const prevShare = prevData.filter(d => d.is_us === 'Y').reduce((s, c) => s + c.share, 0);
        
        document.getElementById('our-share').innerText = ourShare.toFixed(2) + '%';
        
        const diff = ourShare - prevShare;
        const trendEl = document.getElementById('share-trend');
        trendEl.innerText = (diff >= 0 ? '+' : '') + diff.toFixed(2) + ' pp vs sem anterior';
        trendEl.className = 'kpi-sub ' + (diff >= 0 ? 'trend-up' : 'trend-down');

        document.getElementById('market-vol').innerText = '26.9k'; // Hardcoded from data analysis
    }

    // INTERACTIVE SECTION
    function populateSelectors() {
        const weekSel = document.getElementById('week-selector');
        getWeeks().forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSel.appendChild(opt);
        });
        weekSel.value = getWeeks().pop(); // Select latest

        const compSel = document.getElementById('comp-selector');
        getCompetitors().forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            compSel.appendChild(opt);
        });
        // Select NORITUAL if exists
        const tops = getCompetitors();
        if(tops.includes('NORITUAL LAB')) compSel.value = 'NORITUAL LAB';
    }

    function updateInteractive() {
        const week = document.getElementById('week-selector').value;
        const comp = document.getElementById('comp-selector').value;
        
        const weekData = marketData.filter(d => d.week === week);
        
        // Aggregate Our Stats
        const usItems = weekData.filter(d => d.is_us === 'Y');
        const usShare = usItems.reduce((s,c) => s + c.share, 0);
        const usPrice = usItems.length ? usItems.reduce((s,c) => s + c.price, 0)/usItems.length : 0;
        const usRank = usItems.length ? usItems.reduce((s,c) => s + (c.rank || 50), 0)/usItems.length : 0; // fallback
        const usDeals = usItems.reduce((s,c) => s + (c.deal_days || 0) + (c.coupon_days || 0), 0);

        // Aggregate Comp Stats
        const compItems = weekData.filter(d => d.brand === comp);
        const compShare = compItems.reduce((s,c) => s + c.share, 0);
        const compPrice = compItems.length ? compItems.reduce((s,c) => s + c.price, 0)/compItems.length : 0;
        const compRank = compItems.length ? compItems.reduce((s,c) => s + (c.rank || 50), 0)/compItems.length : 0;
        const compDeals = compItems.reduce((s,c) => s + (c.deal_days || 0) + (c.coupon_days || 0), 0);

        // Update DOM
        document.getElementById('int-our-share').innerText = usShare.toFixed(1) + '%';
        document.getElementById('int-our-price').innerText = '€' + usPrice.toFixed(2);
        document.getElementById('int-our-rank').innerText = usRank.toFixed(1);
        document.getElementById('int-our-deals').innerText = usDeals;

        document.getElementById('int-comp-name').innerText = comp;
        document.getElementById('int-comp-share').innerText = compShare.toFixed(1) + '%';
        document.getElementById('int-comp-price').innerText = '€' + compPrice.toFixed(2);
        document.getElementById('int-comp-rank').innerText = compRank.toFixed(1);
        document.getElementById('int-comp-deals').innerText = compDeals;

        // Draw Comparison Chart
        const data = google.visualization.arrayToDataTable([
            ['Metric', 'NaturaleBio', comp],
            ['Share %', usShare, compShare],
            ['Precio €', usPrice, compPrice],
            ['Rank', usRank, compRank]
        ]);

        const options = {
            seriesType: 'bars',
            colors: ['#0071e3', '#db4437'],
            legend: { position: 'bottom' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_comparison'));
        chart.draw(data, options);
    }
</script>

</body>
</html>