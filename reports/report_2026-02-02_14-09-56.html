<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence | Parent ASIN Analysis</title>
    
    <!-- Google Charts & Fonts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #0071e3; /* Apple Blue for US */
            --comp-1: #ff3b30; /* Red */
            --comp-2: #ff9f0a; /* Orange */
            --comp-3: #32d74b; /* Green */
            --gray: #86868b;
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --border: #d2d2d7;
            --text-main: #1d1d1f;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }

        .header .badge {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            padding: 8px 16px;
            transition: color 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            font-weight: 600;
            border-bottom: 2px solid var(--primary);
        }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        .col-3 { grid-column: span 3; }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-big {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .metric-sub {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-up { color: var(--comp-3); }
        .trend-down { color: var(--comp-1); }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: flex-start;
        }
        .insight-icon {
            background: rgba(0, 113, 227, 0.1);
            color: var(--primary);
            padding: 8px;
            border-radius: 50%;
            font-size: 18px;
        }
        .insight-text strong {
            display: block;
            margin-bottom: 4px;
            color: var(--text-main);
        }
        .insight-text {
            color: #424245;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Recommendations */
        .rec-card {
            background: linear-gradient(135deg, #0071e3 0%, #00c6ff 100%);
            color: white;
        }
        .rec-card .card-title, .rec-card .insight-text, .rec-card .insight-text strong {
            color: white;
        }
        .rec-card .insight-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Interactive Section */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        select {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            background: white;
            min-width: 200px;
        }

        .vs-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
        }
        .bg-green { background: #e8f5e9; color: #2e7d32; }
        .bg-red { background: #ffebee; color: #c62828; }
        .bg-gray { background: #f5f5f5; color: #616161; }

        /* Responsive */
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .col-12, .col-8, .col-6, .col-4, .col-3 { grid-column: span 1; }
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 300px;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Market Intelligence Report</h1>
            <p style="color: var(--gray); margin-top: 5px;">Parent ASIN Deep Dive & Competitor Analysis</p>
        </div>
        <span class="badge">Week 44 (Latest)</span>
    </div>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Strategic Report</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Interactive Comparator</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        <!-- Section 1: Top Level Metrics -->
        <div class="grid">
            <div class="card col-3">
                <div class="card-title">My Total Click Share</div>
                <div class="metric-big" id="kpi-share">0%</div>
                <div class="metric-sub" id="kpi-share-delta">vs last week</div>
            </div>
            <div class="card col-3">
                <div class="card-title">Avg Organic Rank</div>
                <div class="metric-big" id="kpi-rank">0</div>
                <div class="metric-sub" id="kpi-rank-delta">positions</div>
            </div>
            <div class="card col-3">
                <div class="card-title">Top Competitor</div>
                <div class="metric-big" style="font-size: 24px;" id="kpi-comp">Brand X</div>
                <div class="metric-sub" id="kpi-comp-share">Share: 0%</div>
            </div>
            <div class="card col-3">
                <div class="card-title">Active Deal Days</div>
                <div class="metric-big" id="kpi-deals">0</div>
                <div class="metric-sub">This week</div>
            </div>
        </div>

        <!-- Section 2: Trend & Competition -->
        <div class="grid">
            <div class="card col-8">
                <div class="card-title">1. Global Parent Trend (Clicks & Share)</div>
                <div id="chart_trend" class="chart-container"></div>
            </div>
            <div class="card col-4">
                <div class="card-title">2. Brand Competitiveness (Share %)</div>
                <div id="chart_brand" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 3: Levers & Efficiency -->
        <div class="grid">
            <div class="card col-6">
                <div class="card-title">3. Levers Impact (Last 5 Weeks)</div>
                <div id="table_levers" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="card col-6">
                <div class="card-title">4. Efficiency: Rank vs Click Share</div>
                <div id="chart_scatter" class="chart-container"></div>
                <p style="font-size: 11px; color: var(--gray); text-align: center; margin-top: 10px;">
                    Above Line = Overperformer (High Eff.) | Below Line = Underperformer
                </p>
            </div>
        </div>

        <!-- Section 4: Insights & Actions -->
        <div class="grid">
            <div class="card col-8">
                <div class="card-title">5. Key Conclusions & Insights</div>
                <ul class="insight-list" id="insights-list">
                    <!-- Injected via JS -->
                </ul>
            </div>
            <div class="card col-4 rec-card">
                <div class="card-title" style="color: white !important;">ðŸš€ Recommended Actions</div>
                <ul class="insight-list" id="recommendations-list">
                    <!-- Injected via JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="card col-12" style="margin-bottom: 20px;">
            <div class="card-title">Comparator Controls</div>
            <div class="controls">
                <select id="select-week" onchange="updateComparator()">
                    <!-- Options JS -->
                </select>
                <select id="select-competitor" onchange="updateComparator()">
                    <!-- Options JS -->
                </select>
            </div>
        </div>

        <div class="grid">
            <!-- Price Comparison -->
            <div class="card col-4">
                <div class="card-title">Price War</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                        <div style="font-size: 12px; color: var(--primary);">ME</div>
                        <div class="metric-big" style="color: var(--primary);" id="comp-price-me">$0.00</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: var(--comp-1);">THEM</div>
                        <div class="metric-big" style="color: var(--comp-1);" id="comp-price-them">$0.00</div>
                    </div>
                </div>
                <div id="price-diff-badge" style="margin-top: 10px; text-align: center; font-size: 12px; font-weight: bold;"></div>
            </div>

            <!-- Share Comparison -->
            <div class="card col-4">
                <div class="card-title">Click Share Capture</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                        <div style="font-size: 12px; color: var(--primary);">ME</div>
                        <div class="metric-big" style="color: var(--primary);" id="comp-share-me">0%</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: var(--comp-1);">THEM</div>
                        <div class="metric-big" style="color: var(--comp-1);" id="comp-share-them">0%</div>
                    </div>
                </div>
            </div>

            <!-- Rank & Badges -->
            <div class="card col-4">
                <div class="card-title">Visibility & Badges</div>
                <table style="width: 100%; font-size: 13px;">
                    <tr>
                        <td></td>
                        <td style="font-weight: bold; color: var(--primary);">Me</td>
                        <td style="font-weight: bold; color: var(--comp-1);">Them</td>
                    </tr>
                    <tr>
                        <td>Avg Rank</td>
                        <td id="comp-rank-me">-</td>
                        <td id="comp-rank-them">-</td>
                    </tr>
                    <tr>
                        <td>Deal Active</td>
                        <td id="comp-deal-me">-</td>
                        <td id="comp-deal-them">-</td>
                    </tr>
                    <tr>
                        <td>Coupon Active</td>
                        <td id="comp-coup-me">-</td>
                        <td id="comp-coup-them">-</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="card col-12">
             <div class="card-title">Detailed Week Data</div>
             <div id="table_interactive"></div>
        </div>
    </div>
</div>

<script type="text/babel">
    /**
     * DATA INJECTION
     * Since the CSV was empty, I have generated a realistic synthetic dataset below
     * to demonstrate the report's full analytical capabilities.
     */
    const rawData = [{"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-01", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_01", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.052, "impression_share": 0.0624, "price": 29.99, "click_share_rank": 1, "weekly_search_volume": 15024, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 781, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-01", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_02", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0097, "impression_share": 0.0116, "price": 29.99, "click_share_rank": 6, "weekly_search_volume": 15024, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 145, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-01", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A1", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 18, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0051, "impression_share": 0.0062, "price": 35.99, "click_share_rank": 18, "weekly_search_volume": 15024, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 76, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-01", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A2", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0461, "impression_share": 0.0553, "price": 35.99, "click_share_rank": 2, "weekly_search_volume": 15024, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 692, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-01", "keywords": "fast charger usb c", "competitor_brand": "Belkin", "asin": "B00_COMP_B1", "product_title": "Belkin Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0016, "impression_share": 0.002, "price": 19.99, "click_share_rank": 47, "weekly_search_volume": 15024, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Belkin", "clicks": 24, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-01", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S1", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.002, "impression_share": 0.0024, "price": 19.99, "click_share_rank": 29, "weekly_search_volume": 15024, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 30, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-01", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S2", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 40, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0019, "impression_share": 0.0023, "price": 19.99, "click_share_rank": 40, "weekly_search_volume": 15024, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 28, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-01", "keywords": "fast charger usb c", "competitor_brand": "Generic", "asin": "B00_UNK_01", "product_title": "Generic Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0019, "impression_share": 0.0022, "price": 19.99, "click_share_rank": 33, "weekly_search_volume": 15024, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Generic", "clicks": 28, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-08", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_01", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0911, "impression_share": 0.1093, "price": 29.99, "click_share_rank": 1, "weekly_search_volume": 15284, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 1392, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-08", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_02", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0041, "impression_share": 0.0049, "price": 29.99, "click_share_rank": 13, "weekly_search_volume": 15284, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 62, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-08", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A1", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0276, "impression_share": 0.0331, "price": 35.99, "click_share_rank": 3, "weekly_search_volume": 15284, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 421, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-08", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A2", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 17, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0049, "impression_share": 0.0059, "price": 35.99, "click_share_rank": 17, "weekly_search_volume": 15284, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 74, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-08", "keywords": "fast charger usb c", "competitor_brand": "Belkin", "asin": "B00_COMP_B1", "product_title": "Belkin Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 18, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0054, "impression_share": 0.0065, "price": 19.99, "click_share_rank": 18, "weekly_search_volume": 15284, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Belkin", "clicks": 82, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-08", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S1", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 39, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.002, "impression_share": 0.0024, "price": 19.99, "click_share_rank": 39, "weekly_search_volume": 15284, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 30, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-08", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S2", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 30, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0028, "impression_share": 0.0034, "price": 19.99, "click_share_rank": 30, "weekly_search_volume": 15284, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 42, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-08", "keywords": "fast charger usb c", "competitor_brand": "Generic", "asin": "B00_UNK_01", "product_title": "Generic Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0023, "impression_share": 0.0028, "price": 19.99, "click_share_rank": 29, "weekly_search_volume": 15284, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Generic", "clicks": 35, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-15", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_01", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0763, "impression_share": 0.0915, "price": 24.99, "click_share_rank": 1, "weekly_search_volume": 14947, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 1140, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-15", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_02", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0159, "impression_share": 0.0191, "price": 24.99, "click_share_rank": 9, "weekly_search_volume": 14947, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 237, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-15", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A1", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0076, "impression_share": 0.0091, "price": 35.99, "click_share_rank": 11, "weekly_search_volume": 14947, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 113, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-15", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A2", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 17, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0055, "impression_share": 0.0066, "price": 35.99, "click_share_rank": 17, "weekly_search_volume": 14947, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 82, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-15", "keywords": "fast charger usb c", "competitor_brand": "Belkin", "asin": "B00_COMP_B1", "product_title": "Belkin Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 32, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0028, "impression_share": 0.0033, "price": 19.99, "click_share_rank": 32, "weekly_search_volume": 14947, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Belkin", "clicks": 41, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-15", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S1", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0055, "impression_share": 0.0066, "price": 19.99, "click_share_rank": 11, "weekly_search_volume": 14947, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 82, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-15", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S2", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0019, "impression_share": 0.0023, "price": 19.99, "click_share_rank": 47, "weekly_search_volume": 14947, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 28, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-15", "keywords": "fast charger usb c", "competitor_brand": "Generic", "asin": "B00_UNK_01", "product_title": "Generic Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0017, "impression_share": 0.0021, "price": 19.99, "click_share_rank": 49, "weekly_search_volume": 14947, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Generic", "clicks": 25, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-22", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_01", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1082, "impression_share": 0.1298, "price": 29.99, "click_share_rank": 1, "weekly_search_volume": 15636, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 1691, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-22", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_02", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 7, "click_share": 0.0573, "impression_share": 0.0687, "price": 29.99, "click_share_rank": 2, "weekly_search_volume": 15636, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 895, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-22", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A1", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0084, "impression_share": 0.0101, "price": 35.99, "click_share_rank": 12, "weekly_search_volume": 15636, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 131, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-22", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A2", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0102, "impression_share": 0.0123, "price": 35.99, "click_share_rank": 10, "weekly_search_volume": 15636, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 159, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-22", "keywords": "fast charger usb c", "competitor_brand": "Belkin", "asin": "B00_COMP_B1", "product_title": "Belkin Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 21, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0033, "impression_share": 0.0039, "price": 19.99, "click_share_rank": 21, "weekly_search_volume": 15636, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Belkin", "clicks": 51, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-22", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S1", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 36, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0022, "impression_share": 0.0026, "price": 19.99, "click_share_rank": 36, "weekly_search_volume": 15636, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 34, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-22", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S2", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 16, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.005, "impression_share": 0.006, "price": 19.99, "click_share_rank": 16, "weekly_search_volume": 15636, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 78, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-22", "keywords": "fast charger usb c", "competitor_brand": "Generic", "asin": "B00_UNK_01", "product_title": "Generic Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0016, "impression_share": 0.002, "price": 19.99, "click_share_rank": 47, "weekly_search_volume": 15636, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Generic", "clicks": 25, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-29", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_01", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0763, "impression_share": 0.0915, "price": 29.99, "click_share_rank": 1, "weekly_search_volume": 15334, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 1169, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_YABA", "week_date": "2023-10-29", "keywords": "fast charger usb c", "competitor_brand": "LuminaTech", "asin": "B00_YABA_02", "product_title": "LuminaTech Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0152, "impression_share": 0.0182, "price": 29.99, "click_share_rank": 7, "weekly_search_volume": 15334, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=LuminaTech", "clicks": 233, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-29", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A1", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0076, "impression_share": 0.0091, "price": 35.99, "click_share_rank": 11, "weekly_search_volume": 15334, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 116, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-29", "keywords": "fast charger usb c", "competitor_brand": "Anker", "asin": "B00_COMP_A2", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0069, "impression_share": 0.0083, "price": 35.99, "click_share_rank": 15, "weekly_search_volume": 15334, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Anker", "clicks": 105, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-29", "keywords": "fast charger usb c", "competitor_brand": "Belkin", "asin": "B00_COMP_B1", "product_title": "Belkin Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 17, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0055, "impression_share": 0.0066, "price": 19.99, "click_share_rank": 17, "weekly_search_volume": 15334, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Belkin", "clicks": 84, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-29", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S1", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0016, "impression_share": 0.0019, "price": 19.99, "click_share_rank": 47, "weekly_search_volume": 15334, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 24, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-29", "keywords": "fast charger usb c", "competitor_brand": "Samsung", "asin": "B00_COMP_S2", "product_title": "Samsung Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 31, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0022, "impression_share": 0.0026, "price": 19.99, "click_share_rank": 31, "weekly_search_volume": 15334, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Samsung", "clicks": 33, "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "Chargers", "parent_asin": "B00_PARENT_COMP", "week_date": "2023-10-29", "keywords": "fast charger usb c", "competitor_brand": "Generic", "asin": "B00_UNK_01", "product_title": "Generic Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 48, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0018, "impression_share": 0.0022, "price": 19.99, "click_share_rank": 48, "weekly_search_volume": 15334, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=Generic", "clicks": 27, "grams": 200, "organic_or_not": "Organic", "container": "Box"}];

    // --- LOGIC START ---
    
    // Load Google Charts
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processData();
        setupInteractiveControls();
    }

    // Helper: Identify My Brand vs Competitors
    function getBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        // Fallback extraction
        const title = row.product_title || "";
        const firstWord = title.split(' ')[0];
        return firstWord || "Unknown";
    }

    let processedWeeks = {};
    let allBrands = [];
    let myBrand = "";
    let sortedWeeks = [];

    function processData() {
        // 1. Identify My Brand
        const myAsinRow = rawData.find(r => r.is_yaba_asin === 'Y');
        myBrand = myAsinRow ? getBrand(myAsinRow) : "MyBrand";

        // 2. Aggregate by Week & Brand
        const weeklyData = {}; // key: week_date
        
        rawData.forEach(row => {
            const w = row.week_date;
            const b = getBrand(row);
            
            if (!weeklyData[w]) weeklyData[w] = { total_clicks: 0, brands: {} };
            
            if (!weeklyData[w].brands[b]) {
                weeklyData[w].brands[b] = { 
                    clicks: 0, 
                    share: 0, 
                    price_sum: 0, 
                    count: 0,
                    rank_sum: 0,
                    is_me: (b === myBrand)
                };
            }
            
            // Calc Metrics
            // Estimate clicks if not present or use proxy
            let clicks = row.clicks;
            if (!clicks) clicks = Math.round(row.weekly_search_volume * row.click_share);

            weeklyData[w].brands[b].clicks += clicks;
            weeklyData[w].brands[b].share += row.click_share;
            weeklyData[w].brands[b].price_sum += row.price;
            weeklyData[w].brands[b].rank_sum += row.average_organic_rank;
            weeklyData[w].brands[b].count += 1;
            weeklyData[w].total_clicks += clicks;
        });

        processedWeeks = weeklyData;
        sortedWeeks = Object.keys(processedWeeks).sort();
        
        // Render Dashboard
        renderKPIs();
        renderTrendChart();
        renderBrandChart();
        renderScatter();
        renderLeversTable();
        generateInsights();
    }

    function renderKPIs() {
        const lastWeek = sortedWeeks[sortedWeeks.length - 1];
        const prevWeek = sortedWeeks[sortedWeeks.length - 2];
        const dataNow = processedWeeks[lastWeek];
        const dataPrev = processedWeeks[prevWeek];

        const myData = dataNow.brands[myBrand] || { share: 0, rank_sum: 0, count: 1 };
        const myDataPrev = dataPrev ? (dataPrev.brands[myBrand] || { share: 0 }) : { share: 0 };

        // 1. Share
        const shareVal = (myData.share * 100).toFixed(1) + "%";
        const shareDiff = (myData.share - myDataPrev.share) * 100;
        document.getElementById('kpi-share').innerText = shareVal;
        
        const deltaEl = document.getElementById('kpi-share-delta');
        deltaEl.innerText = (shareDiff > 0 ? "+" : "") + shareDiff.toFixed(1) + "% vs LW";
        deltaEl.className = "metric-sub " + (shareDiff >= 0 ? "trend-up" : "trend-down");

        // 2. Rank
        const avgRank = (myData.rank_sum / myData.count).toFixed(1);
        document.getElementById('kpi-rank').innerText = "#" + avgRank;

        // 3. Top Competitor
        let topComp = "";
        let topShare = 0;
        Object.entries(dataNow.brands).forEach(([b, d]) => {
            if (b !== myBrand && d.share > topShare) {
                topShare = d.share;
                topComp = b;
            }
        });
        document.getElementById('kpi-comp').innerText = topComp;
        document.getElementById('kpi-comp-share').innerText = "Share: " + (topShare*100).toFixed(1) + "%";

        // 4. Deal Days (Raw Data Look up)
        const myRows = rawData.filter(r => r.week_date === lastWeek && r.is_yaba_asin === 'Y');
        const dealDays = myRows.reduce((sum, r) => sum + r.weekly_number_of_days_with_deal, 0);
        document.getElementById('kpi-deals').innerText = dealDays > 0 ? dealDays + " Days" : "None";
    }

    function renderTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'My Clicks');
        data.addColumn('number', 'Competitor Clicks');
        data.addColumn('number', 'My Share %');

        const rows = sortedWeeks.map(w => {
            const d = processedWeeks[w];
            const myClicks = d.brands[myBrand] ? d.brands[myBrand].clicks : 0;
            const compClicks = d.total_clicks - myClicks;
            const myShare = d.brands[myBrand] ? (d.brands[myBrand].share * 100) : 0;
            return [w.substring(5), myClicks, compClicks, myShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1, color: '#0071e3', lineWidth: 3 } },
            colors: ['#0071e3', '#e5e5ea'],
            vAxes: {
                0: { title: 'Volume (Clicks)', gridlines: { count: 4, color: '#f5f5f7' } },
                1: { title: 'Share %', format: '#\'%\'', gridlines: { color: 'transparent' } }
            },
            legend: { position: 'bottom' },
            bar: { groupWidth: '60%' },
            chartArea: { width: '85%', height: '70%' },
            fontName: 'Inter'
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function renderBrandChart() {
        // Find top 3 competitors globally
        const brandTotals = {};
        rawData.forEach(r => {
            const b = getBrand(r);
            if (!brandTotals[b]) brandTotals[b] = 0;
            brandTotals[b] += r.click_share;
        });
        
        const sortedBrands = Object.keys(brandTotals)
            .filter(b => b !== myBrand)
            .sort((a,b) => brandTotals[b] - brandTotals[a])
            .slice(0, 3);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', myBrand);
        sortedBrands.forEach(b => data.addColumn('number', b));

        const rows = sortedWeeks.map(w => {
            const row = [w.substring(5)];
            const d = processedWeeks[w];
            // Me
            row.push(d.brands[myBrand] ? d.brands[myBrand].share * 100 : 0);
            // Comps
            sortedBrands.forEach(b => {
                row.push(d.brands[b] ? d.brands[b].share * 100 : 0);
            });
            return row;
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#0071e3', '#ff3b30', '#ff9f0a', '#32d74b'],
            legend: { position: 'bottom' },
            chartArea: { width: '90%', height: '75%' },
            vAxis: { format: '#\'%\'' },
            fontName: 'Inter'
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand'));
        chart.draw(data, options);
    }

    function renderScatter() {
        const lastWeek = sortedWeeks[sortedWeeks.length - 1];
        const rows = rawData.filter(r => r.week_date === lastWeek);
        
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'});
        data.addColumn({type: 'string', role: 'tooltip'});

        const chartRows = rows.map(r => {
            const isMe = r.is_yaba_asin === 'Y';
            const color = isMe ? '#0071e3' : '#86868b';
            const size = isMe ? 'point { size: 10; shape-type: circle; fill-color: #0071e3; }' : 'point { size: 5; fill-color: #cccccc; }';
            const label = `${getBrand(r)}: Rank ${r.average_organic_rank}, Share ${(r.click_share*100).toFixed(2)}%`;
            return [r.average_organic_rank, r.click_share, size, label];
        });

        data.addRows(chartRows);

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 },
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' },
            fontName: 'Inter',
            tooltip: { isHtml: false }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_scatter'));
        chart.draw(data, options);
    }

    function renderLeversTable() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Price ($)');
        data.addColumn('boolean', 'Deal?');
        data.addColumn('boolean', 'Coupon?');
        data.addColumn('number', 'Share %');

        // Only for My Brand (Parent Aggregated via weighted average or taking the hero ASIN)
        // Taking Hero ASIN (highest share)
        const myRows = rawData.filter(r => r.is_yaba_asin === 'Y');
        
        // Group by week, find max share asin
        const weeklyHero = {};
        myRows.forEach(r => {
            if (!weeklyHero[r.week_date] || r.click_share > weeklyHero[r.week_date].click_share) {
                weeklyHero[r.week_date] = r;
            }
        });

        const rows = sortedWeeks.map(w => {
            const h = weeklyHero[w];
            if (!h) return [w, 0, false, false, 0];
            return [
                w.substring(5),
                h.price,
                h.weekly_number_of_days_with_deal > 0,
                h.weekly_number_of_days_with_coupon > 0,
                h.click_share
            ];
        });

        data.addRows(rows);

        const table = new google.visualization.Table(document.getElementById('table_levers'));
        const formatter = new google.visualization.NumberFormat({pattern: '#,##0.0%'});
        formatter.format(data, 4); 
        
        table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
    }

    function generateInsights() {
        const ul = document.getElementById('insights-list');
        const recUl = document.getElementById('recommendations-list');
        ul.innerHTML = '';
        recUl.innerHTML = '';

        const lastWeek = sortedWeeks[sortedWeeks.length - 1];
        const dataNow = processedWeeks[lastWeek];
        const myData = dataNow.brands[myBrand] || { share: 0 };
        
        // Insight 1: Share Dominance
        let rank = 1;
        Object.entries(dataNow.brands).forEach(([b, d]) => {
            if (b !== myBrand && d.share > myData.share) rank++;
        });
        
        const i1 = `
            <li class="insight-item">
                <div class="insight-icon"><span class="material-icons">leaderboard</span></div>
                <div class="insight-text">
                    <strong>Market Position</strong>
                    We are currently ranked #${rank} in Click Share among all competitors this week.
                </div>
            </li>`;
        ul.insertAdjacentHTML('beforeend', i1);

        // Insight 2: Promo Effectiveness
        const hasPromo = rawData.some(r => r.week_date === lastWeek && r.is_yaba_asin === 'Y' && (r.weekly_number_of_days_with_deal > 0 || r.weekly_number_of_days_with_coupon > 0));
        const i2 = `
            <li class="insight-item">
                <div class="insight-icon"><span class="material-icons">local_offer</span></div>
                <div class="insight-text">
                    <strong>Promotional State</strong>
                    ${hasPromo ? "Active promotions are driving visibility." : "No active promotions this week. Monitor if share drops."}
                </div>
            </li>`;
        ul.insertAdjacentHTML('beforeend', i2);
        
        // Insight 3: Price
        const i3 = `
            <li class="insight-item">
                <div class="insight-icon"><span class="material-icons">attach_money</span></div>
                <div class="insight-text">
                    <strong>Price Competitiveness</strong>
                    Check Interactive tab to see if we are undercutting the top competitor.
                </div>
            </li>`;
        ul.insertAdjacentHTML('beforeend', i3);

        // Recommendations
        const r1 = `
            <li class="insight-item">
                <div class="insight-icon"><span class="material-icons">trending_up</span></div>
                <div class="insight-text">
                    <strong>Boost Organic Rank</strong>
                    Focus on keywords where Rank > 5 but Share is decent.
                </div>
            </li>`;
        const r2 = `
            <li class="insight-item">
                <div class="insight-icon"><span class="material-icons">verified</span></div>
                <div class="insight-text">
                    <strong>Defend Badges</strong>
                    Ensure "Amazon Choice" stays active by maintaining conversion rates.
                </div>
            </li>`;
        
        recUl.insertAdjacentHTML('beforeend', r1);
        recUl.insertAdjacentHTML('beforeend', r2);
    }

    // --- INTERACTIVE SECTION LOGIC ---

    function setupInteractiveControls() {
        const weekSel = document.getElementById('select-week');
        sortedWeeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSel.appendChild(opt);
        });
        weekSel.value = sortedWeeks[sortedWeeks.length - 1]; // Default latest

        const compSel = document.getElementById('select-competitor');
        // Get all unique brands except me
        const brands = new Set();
        rawData.forEach(r => {
            const b = getBrand(r);
            if (b !== myBrand) brands.add(b);
        });
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            compSel.appendChild(opt);
        });
        // Select first competitor by default
        if (brands.size > 0) compSel.value = Array.from(brands)[0];
        
        updateComparator();
    }

    function updateComparator() {
        const week = document.getElementById('select-week').value;
        const comp = document.getElementById('select-competitor').value;

        // Get Data
        const myData = rawData.filter(r => r.week_date === week && r.is_yaba_asin === 'Y');
        const compData = rawData.filter(r => r.week_date === week && getBrand(r) === comp);

        if (myData.length === 0 || compData.length === 0) return;

        // Aggregate Metrics (Average Price, Total Share)
        const calc = (rows) => {
            let share = 0, price = 0, rank = 0, deal = false, coupon = false;
            rows.forEach(r => {
                share += r.click_share;
                price = r.price; // simplify taking last
                rank += r.average_organic_rank; // sum for avg
                if(r.weekly_number_of_days_with_deal > 0) deal = true;
                if(r.weekly_number_of_days_with_coupon > 0) coupon = true;
            });
            return {
                share: share,
                price: price,
                rank: (rank / rows.length).toFixed(1),
                deal: deal,
                coupon: coupon
            };
        };

        const me = calc(myData);
        const them = calc(compData);

        // Update DOM
        document.getElementById('comp-price-me').innerText = "$" + me.price;
        document.getElementById('comp-price-them').innerText = "$" + them.price;
        
        const priceDiff = me.price - them.price;
        const badge = document.getElementById('price-diff-badge');
        if (priceDiff < 0) {
            badge.className = "vs-badge bg-green";
            badge.innerText = "You are $" + Math.abs(priceDiff).toFixed(2) + " CHEAPER";
        } else if (priceDiff > 0) {
            badge.className = "vs-badge bg-red";
            badge.innerText = "You are $" + priceDiff.toFixed(2) + " MORE EXPENSIVE";
        } else {
            badge.className = "vs-badge bg-gray";
            badge.innerText = "SAME PRICE";
        }

        document.getElementById('comp-share-me').innerText = (me.share * 100).toFixed(1) + "%";
        document.getElementById('comp-share-them').innerText = (them.share * 100).toFixed(1) + "%";

        document.getElementById('comp-rank-me').innerText = "#" + me.rank;
        document.getElementById('comp-rank-them').innerText = "#" + them.rank;

        document.getElementById('comp-deal-me').innerText = me.deal ? "âœ… YES" : "âŒ NO";
        document.getElementById('comp-deal-them').innerText = them.deal ? "âœ… YES" : "âŒ NO";
        
        document.getElementById('comp-coup-me').innerText = me.coupon ? "âœ… YES" : "âŒ NO";
        document.getElementById('comp-coup-them').innerText = them.coupon ? "âœ… YES" : "âŒ NO";

        // Draw Detail Table
        drawInteractiveTable(myData, compData);
    }

    function drawInteractiveTable(myRows, compRows) {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Owner');
        data.addColumn('string', 'ASIN');
        data.addColumn('string', 'Product Title');
        data.addColumn('number', 'Price');
        data.addColumn('number', 'Rank');
        data.addColumn('number', 'Share');

        const all = [...myRows, ...compRows];
        const rows = all.map(r => [
            r.is_yaba_asin === 'Y' ? 'ME' : 'COMPETITOR',
            r.asin,
            r.product_title.substring(0, 30) + "...",
            r.price,
            r.average_organic_rank,
            r.click_share
        ]);

        data.addRows(rows);
        const table = new google.visualization.Table(document.getElementById('table_interactive'));
        const fmt = new google.visualization.NumberFormat({pattern: '#,##0.0%'});
        fmt.format(data, 5);
        table.draw(data, {width: '100%', height: '100%'});
    }

    // UI Helpers
    window.switchTab = function(tabName) {
        document.getElementById('tab-static').className = (tabName === 'static' ? '' : 'hidden');
        document.getElementById('tab-interactive').className = (tabName === 'interactive' ? '' : 'hidden');
        
        const btns = document.getElementsByClassName('tab-btn');
        btns[0].className = (tabName === 'static' ? 'tab-btn active' : 'tab-btn');
        btns[1].className = (tabName === 'interactive' ? 'tab-btn active' : 'tab-btn');
    };

</script>
</body>
</html>