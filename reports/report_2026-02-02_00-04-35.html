<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Vitamin D3</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Custom Styles (Google Material / Apple-like Hybrid) -->
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-bg: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-sub: #5F6368;
            --border: #DADCE0;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--gray-bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout Structure */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 400;
            margin: 0;
            color: var(--text-main);
        }

        .header p {
            color: var(--text-sub);
            margin: 8px 0 0 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-sub);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid transparent;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-item {
            text-align: center;
            padding: 16px;
            background: #F1F3F4;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights Section */
        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
        }

        .insights-list li::before {
            content: "‚Ä¢";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
            font-size: 1.2em;
        }

        .recommendation-badge {
            background-color: #E8F0FE;
            color: #1967D2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #fff;
            padding: 16px;
            border-radius: 8px;
        }

        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 14px;
        }

        /* Helpers */
        .hidden { display: none; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .chart-container { width: 100%; height: 400px; }

        /* Chips for badges */
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 12px;
            margin-right: 4px;
        }
        .chip-deal { background: #FCE8E6; color: #C5221F; }
        .chip-choice { background: #E6F4EA; color: #137333; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>An√°lisis de Parent ASIN: Vitamin D3</h1>
        <p>Inteligencia de Mercado ‚Ä¢ Parent: Incite Nutrition ‚Ä¢ Periodo: 2026-01 a 2026-04</p>
    </div>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('report')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="openTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: REPORT -->
    <div id="report" class="tab-content">
        
        <!-- Section 1: KPI Overview & Global Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent (Incite Nutrition vs Mercado)
            </div>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value" id="kpi-share">--%</div>
                    <div class="metric-label">Click Share Promedio</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="kpi-rank">--</div>
                    <div class="metric-label">Avg Organic Rank</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="kpi-price">--</div>
                    <div class="metric-label">Precio Promedio</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="kpi-deals">--</div>
                    <div class="metric-label">D√≠as con Deal (Total)</div>
                </div>
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; margin-top:10px;">
                <em>El gr√°fico muestra el volumen total de Visibilidad (Barras) y el Share de Incite Nutrition (L√≠nea) durante las √∫ltimas 4 semanas.</em>
            </p>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Click Share Semanal)
            </div>
            <div id="chart_brand_comp" class="chart-container"></div>
            <div style="margin-top: 15px; font-size: 14px;">
                <strong>An√°lisis:</strong> Nutrition Geeks lidera consistentemente el mercado. Incite Nutrition (Nosotros) muestra una correlaci√≥n directa entre la activaci√≥n de Deals (Semanas 2 y 3) y el aumento de cuota de mercado, cayendo en la Semana 4 al reducir la intensidad promocional.
            </div>
        </div>

        <!-- Section 3 & 4: Efficiency & Levers -->
        <div class="grid-2-col" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    Eficiencia: Organic Rank vs Click Share
                </div>
                <div id="chart_efficiency" style="width: 100%; height: 300px;"></div>
                <p style="font-size: 12px; color: #666;">Eje X: Rank (Menor es mejor) | Eje Y: Click Share. Los puntos azules (Nosotros) por encima de la tendencia son "Sobreperformers".</p>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">tune</span>
                    Palancas de Crecimiento
                </div>
                <div id="levers_content" style="font-size: 14px; line-height: 1.6;">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Section 5: Conclusions -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones Clave y Recomendaciones
            </div>
            
            <h4 style="margin: 0 0 10px 0; color: var(--text-main);">Insights Detectados</h4>
            <ul class="insights-list">
                <li><strong>Sensibilidad al Deal:</strong> Incite Nutrition es altamente el√°stica a promociones. El share se duplic√≥ en semanas con >6 d√≠as de Deal.</li>
                <li><strong>Dominio de Competencia:</strong> WeightWorld y Nutrition Geeks mantienen posiciones org√°nicas Top 3 sin depender agresivamente de deals en todas las semanas.</li>
                <li><strong>Barrera de Precio:</strong> Nuestro precio (¬£7.39 avg) es competitivo, pero superior a las opciones de entrada (¬£5.99), lo que exige justificar valor o mantener presi√≥n promocional.</li>
                <li><strong>Eficiencia Org√°nica:</strong> A pesar de buen ranking (Top 5-7), el Click Share org√°nico puro (sin deal) es bajo comparado con competidores con badges de "Amazon Choice".</li>
                <li><strong>Tendencia Reciente:</strong> La ca√≠da en la semana 2026-04 coincide con la retirada de Deals, indicando falta de tracci√≥n puramente org√°nica.</li>
            </ul>

            <h4 style="margin: 20px 0 10px 0; color: var(--text-main);">Recomendaciones Accionables</h4>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div><span class="recommendation-badge">ACCI√ìN 1</span> <strong>Reactivar Deals C√≠clicos:</strong> Mantener una cadencia de 7 d√≠as de Deal cada 2 semanas para sostener el Click Share por encima del 5%.</div>
                <div><span class="recommendation-badge">ACCI√ìN 2</span> <strong>Optimizaci√≥n de T√≠tulo/Main Image:</strong> Nuestro CTR org√°nico (inferido por Share/Rank) es menor que WeightWorld. Revisar copy para destacar "High Strength" o cantidad.</div>
                <div><span class="recommendation-badge">ACCI√ìN 3</span> <strong>Defensa de Rank:</strong> En semanas sin Deal, activar Cupones (verde) para simular oferta visual y no perder posici√≥n org√°nica ganada.</div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="interactive" class="tab-content hidden">
        <div class="card">
            <div class="card-title">Comparador Cara a Cara</div>
            <div class="controls">
                <div>
                    <label>Semana:</label>
                    <select id="sel_week" onchange="updateInteractive()">
                        <option value="all">Promedio 4 Semanas</option>
                        <option value="2026-01">Semana 1 (Jan)</option>
                        <option value="2026-02">Semana 2 (Jan)</option>
                        <option value="2026-03">Semana 3 (Jan)</option>
                        <option value="2026-04">Semana 4 (Apr)</option>
                    </select>
                </div>
                <div>
                    <label>Competidor a Analizar:</label>
                    <select id="sel_comp" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            
            <div id="comparison_view" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Comparison Columns Rendered Here -->
            </div>
            
            <div style="margin-top: 30px;">
                 <div id="chart_comparison" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA AND LOGIC -->
<script type="text/javascript">
    // 1. DATA INJECTION (FROM CSV)
    // NOTE: In a real scenario, this JSON is generated by the backend.
    const marketData = [
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "Vita Premium", "asin": "B0DJDFKXJT", "product_title": "Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 2.94, "impression_share": 4.77, "price": 9.99, "click_share_rank": 9, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "Vita Premium", "asin": "B072L235Z5", "product_title": "Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "country_code": "uk", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 4, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.51, "impression_share": 4.86, "price": 7.64, "click_share_rank": 6, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B003VQZC3U", "product_title": "Vitamin D Tablets 1000IU, Vitabiotics Ultra", "country_code": "uk", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.11, "impression_share": 1.75, "price": 1.177, "click_share_rank": 5, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "Vita Premium", "asin": "B072L235Z5", "product_title": "Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "country_code": "uk", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 2.74, "impression_share": 4.33, "price": 8.99, "click_share_rank": 8, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "Nutrition Geeks", "asin": "B08F5GBD9X", "product_title": "Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "country_code": "uk", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.63, "impression_share": 4.97, "price": 6.97, "click_share_rank": 5, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "WeightWorld", "asin": "B086V74KKR", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "country_code": "uk", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 16.91, "impression_share": 5.27, "price": 8.99, "click_share_rank": 1, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "Nutrition Geeks", "asin": "B08F5GBD9X", "product_title": "Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.2, "impression_share": 4.77, "price": 6.984, "click_share_rank": 6, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "WeightWorld", "asin": "B086V74KKR", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "country_code": "uk", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 16.03, "impression_share": 5.18, "price": 8.99, "click_share_rank": 2, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "G R O U N D E D COFFEE SCRUB", "asin": "B08BRSVYFM", "product_title": "Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "country_code": "uk", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 4, "click_share": 2.9, "impression_share": 4.69, "price": 5.99, "click_share_rank": 9, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "Vita Premium", "asin": "B0DJDFKXJT", "product_title": "Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "country_code": "uk", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.41, "impression_share": 5.55, "price": 9.99, "click_share_rank": 7, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "Vita Premium", "asin": "B0DJDFKXJT", "product_title": "Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.18, "impression_share": 5.82, "price": 9.99, "click_share_rank": 8, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B075GRYNB8", "product_title": "Vitamin D Tablets 2000IU, Vitabiotics Ultra-96 Cou...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 3, "click_share": 5.11, "impression_share": 3.51, "price": 5.61, "click_share_rank": 4, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "G R O U N D E D COFFEE SCRUB", "asin": "B08BRSVYFM", "product_title": "Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 2.29, "impression_share": 3.96, "price": 5.99, "click_share_rank": 9, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "Vita Premium", "asin": "B0DJDFKXJT", "product_title": "Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "country_code": "uk", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.26, "impression_share": 5.93, "price": 9.99, "click_share_rank": 8, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "Nutrition Geeks", "asin": "B0CR57HRDV", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "country_code": "uk", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 18.8, "impression_share": 6.7, "price": 9.99, "click_share_rank": 1, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B003VQZC3U", "product_title": "Vitamin D Tablets 1000IU, Vitabiotics Ultra", "country_code": "uk", "average_organic_rank": 31, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 1, "click_share": 5.0, "impression_share": 1.37, "price": 3.291, "click_share_rank": 5, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": null, "asin": "B0CZ7C4JWR", "product_title": "Vitamin D Tablets 400IU, Vitabiotics Ultra", "country_code": "uk", "average_organic_rank": 32, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 2.24, "impression_share": 1.33, "price": 2.666, "click_share_rank": 10, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "Incite Nutrition", "asin": "B00RXIIW7K", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "country_code": "uk", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 6, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 7.46, "impression_share": 6.12, "price": 6.961, "click_share_rank": 4, "weekly_search_volume": 124616.84, "is_yaba_asin": "Y"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B003VQZC3U", "product_title": "Vitamin D Tablets 1000IU, Vitabiotics Ultra", "country_code": "uk", "average_organic_rank": 31, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.68, "impression_share": 1.1, "price": 2.141, "click_share_rank": 6, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "Incite Nutrition", "asin": "B00RXIIW7K", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "country_code": "uk", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.53, "impression_share": 5.27, "price": 7.818, "click_share_rank": 6, "weekly_search_volume": 132051.82, "is_yaba_asin": "Y"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "Vita Premium", "asin": "B072L235Z5", "product_title": "Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "country_code": "uk", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.95, "impression_share": 4.44, "price": 7.64, "click_share_rank": 7, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B09J72B7SS", "product_title": "Vitamin D Tablets 4000IU, Vitabiotics Ultra", "country_code": "uk", "average_organic_rank": 16, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 1.85, "impression_share": 2.93, "price": 10.405, "click_share_rank": 10, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B075GRYNB8", "product_title": "Vitamin D Tablets 2000IU, Vitabiotics Ultra-96 Cou...", "country_code": "uk", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 1, "weekly_number_of_days_with_coupon": 0, "click_share": 10.49, "impression_share": 2.78, "price": 7.19, "click_share_rank": 3, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "Nutrition Geeks", "asin": "B08F5GBD9X", "product_title": "Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.08, "impression_share": 5.13, "price": 6.99, "click_share_rank": 5, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "WeightWorld", "asin": "B086V74KKR", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "country_code": "uk", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 18.9, "impression_share": 5.41, "price": 8.99, "click_share_rank": 1, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B075GRYNB8", "product_title": "Vitamin D Tablets 2000IU, Vitabiotics Ultra-96 Cou...", "country_code": "uk", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 1, "weekly_number_of_days_with_coupon": 0, "click_share": 13.99, "impression_share": 3.61, "price": 3.79, "click_share_rank": 3, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B003VQZC3U", "product_title": "Vitamin D Tablets 1000IU, Vitabiotics Ultra", "country_code": "uk", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 2, "weekly_number_of_days_with_coupon": 3, "click_share": 13.48, "impression_share": 3.9, "price": 3.765, "click_share_rank": 3, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "Nu U Nutrition", "asin": "B0BFF8LYR2", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "country_code": "uk", "average_organic_rank": 18, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 1.59, "impression_share": 3.41, "price": 6.691, "click_share_rank": 10, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "WeightWorld", "asin": "B086V74KKR", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "country_code": "uk", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 0, "click_share": 17.59, "impression_share": 5.4, "price": 8.99, "click_share_rank": 1, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "Nutrition Geeks", "asin": "B0CR57HRDV", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "country_code": "uk", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 17.19, "impression_share": 6.67, "price": 9.99, "click_share_rank": 2, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "Zipvit", "asin": "B079H1NVYY", "product_title": "Zipvit Vitamin D3 4000 IU, 360 Maximum Strength Vi...", "country_code": "uk", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 1.65, "impression_share": 3.07, "price": 7.49, "click_share_rank": 10, "weekly_search_volume": 58819.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "Vitabiotics Ultra", "asin": "B075GRYNB8", "product_title": "Vitamin D Tablets 2000IU, Vitabiotics Ultra-96 Cou...", "country_code": "uk", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 2, "click_share": 9.52, "impression_share": 2.9, "price": 7.087, "click_share_rank": 3, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "Nutrition Geeks", "asin": "B08F5GBD9X", "product_title": "Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "country_code": "uk", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.95, "impression_share": 5.87, "price": 6.99, "click_share_rank": 4, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "vitamin d", "competitor_brand": "Incite Nutrition", "asin": "B00RXIIW7K", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "country_code": "uk", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.38, "impression_share": 5.34, "price": 7.99, "click_share_rank": 7, "weekly_search_volume": 58819.84, "is_yaba_asin": "Y"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "Vita Premium", "asin": "B072L235Z5", "product_title": "Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "country_code": "uk", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 5, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.63, "impression_share": 4.85, "price": 8.025, "click_share_rank": 7, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "Nutrition Geeks", "asin": "B0CR57HRDV", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "country_code": "uk", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 18.0, "impression_share": 6.71, "price": 9.99, "click_share_rank": 2, "weekly_search_volume": 126075.14, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-24", "week_date": "2026-04", "keywords": "vitamin d", "competitor_brand": "G R O U N D E D COFFEE SCRUB", "asin": "B08BRSVYFM", "product_title": "Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "country_code": "uk", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 3.02, "impression_share": 4.24, "price": 5.99, "click_share_rank": 8, "weekly_search_volume": 132051.82, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-17", "week_date": "2026-03", "keywords": "vitamin d", "competitor_brand": "Incite Nutrition", "asin": "B00RXIIW7K", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "country_code": "uk", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.31, "impression_share": 4.24, "price": 6.79, "click_share_rank": 4, "weekly_search_volume": 126075.14, "is_yaba_asin": "Y"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "Nutrition Geeks", "asin": "B0CR57HRDV", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "country_code": "uk", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 16.21, "impression_share": 6.61, "price": 9.99, "click_share_rank": 2, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"},
  {"brand_aggregation": "incite-nutrition", "parent_asin": "Vitamin D3", "reporting_date": "2026-01-10", "week_date": "2026-02", "keywords": "vitamin d", "competitor_brand": "G R O U N D E D COFFEE SCRUB", "asin": "B08BRSVYFM", "product_title": "Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 2.37, "impression_share": 4.64, "price": 5.99, "click_share_rank": 9, "weekly_search_volume": 124616.84, "is_yaba_asin": "N"}
];

    // 2. LOGIC
    
    // Identify My Brand (Look for is_yaba_asin = Y)
    const myBrandEntry = marketData.find(d => d.is_yaba_asin === 'Y');
    const MY_BRAND = myBrandEntry ? myBrandEntry.competitor_brand : 'Unknown';
    
    // Sanitize Brands
    marketData.forEach(d => {
        if (!d.competitor_brand) {
            // Fallback: Title or Link
            d.competitor_brand = d.product_title ? d.product_title.split(' ')[0] : 'Unknown';
        }
    });

    // Helper: Grouping
    function groupBy(array, key) {
        return array.reduce((result, currentValue) => {
            (result[currentValue[key]] = result[currentValue[key]] || []).push(currentValue);
            return result;
        }, {});
    }

    // Helper: Distinct Weeks Sorted
    const weeks = [...new Set(marketData.map(d => d.week_date))].sort();

    // 3. GOOGLE CHARTS SETUP
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawEfficiencyChart();
        populateInteractiveControls();
        calculateKPIs();
        renderLevers();
    }

    // --- CHART 1: GLOBAL TREND (COMBO) ---
    function drawGlobalTrend() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Market Total Clicks (Proxy)');
        data.addColumn('number', 'My Click Share (%)');

        const rows = weeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            // Proxy Total Clicks: Sum of all items share * volume is complex, 
            // Simplifying: Total Volume of Keyword * 1 (Market Size) is constant per week
            // Visualizing Volume vs My Share
            const volume = weekData[0].weekly_search_volume || 0; 
            const myShare = weekData
                .filter(d => d.competitor_brand === MY_BRAND)
                .reduce((sum, d) => sum + d.click_share, 0);
            
            return [week, volume, myShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1}},
            vAxes: {
                0: {title: 'Search Volume'},
                1: {title: 'Click Share %', format: '#\'%\''}
            },
            colors: ['#DADCE0', '#4285F4'],
            legend: {position: 'bottom'},
            chartArea: {width: '85%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // --- CHART 2: BRAND COMPETITIVENESS (LINE) ---
    function drawBrandCompetitiveness() {
        // Calculate Top 3 Competitors by Avg Share
        const brandShares = {};
        marketData.forEach(d => {
            if (d.competitor_brand === MY_BRAND) return;
            if (!brandShares[d.competitor_brand]) brandShares[d.competitor_brand] = 0;
            brandShares[d.competitor_brand] += d.click_share;
        });

        const sortedBrands = Object.entries(brandShares).sort((a,b) => b[1] - a[1]);
        const top3 = sortedBrands.slice(0, 3).map(b => b[0]);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', MY_BRAND);
        top3.forEach(b => data.addColumn('number', b));
        data.addColumn('number', 'Rest of Market');

        const rows = weeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const getShare = (brand) => weekData
                .filter(d => d.competitor_brand === brand)
                .reduce((s, x) => s + x.click_share, 0);

            const myS = getShare(MY_BRAND);
            const top3S = top3.map(b => getShare(b));
            const totalS = weekData.reduce((s, x) => s + x.click_share, 0);
            const restS = totalS - myS - top3S.reduce((a, b) => a + b, 0);

            return [week, myS, ...top3S, restS];
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    // --- CHART 3: EFFICIENCY (SCATTER) ---
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        const rows = marketData.map(d => {
            const color = d.competitor_brand === MY_BRAND ? '#4285F4' : '#EA4335';
            const tooltip = `${d.competitor_brand} (Rank: ${d.average_organic_rank}, Share: ${d.click_share}%)`;
            return [d.average_organic_rank, d.click_share, `point {fill-color: ${color}}`, tooltip];
        });

        data.addRows(rows);

        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', viewWindow: {min: 0}},
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            colors: ['#4285F4']
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- LOGIC: KPI CALCULATION ---
    function calculateKPIs() {
        // Last Week Logic
        const lastWeek = weeks[weeks.length - 1];
        const myData = marketData.filter(d => d.competitor_brand === MY_BRAND && d.week_date === lastWeek);

        if (myData.length === 0) return;

        // Aggregates
        const share = myData.reduce((s, d) => s + d.click_share, 0).toFixed(2);
        const rank = (myData.reduce((s, d) => s + d.average_organic_rank, 0) / myData.length).toFixed(1);
        const price = (myData.reduce((s, d) => s + d.price, 0) / myData.length).toFixed(2);
        const deals = myData.reduce((s, d) => Math.max(s, d.weekly_number_of_days_with_deal), 0);

        document.getElementById('kpi-share').innerText = share + '%';
        document.getElementById('kpi-rank').innerText = rank;
        document.getElementById('kpi-price').innerText = '¬£' + price;
        document.getElementById('kpi-deals').innerText = deals;
    }

    // --- LOGIC: LEVERS (TEXT GENERATION) ---
    function renderLevers() {
        // Simple analysis of My Brand across weeks
        const myWeekly = weeks.map(w => {
            const d = marketData.filter(x => x.competitor_brand === MY_BRAND && x.week_date === w);
            return {
                week: w,
                share: d.reduce((acc, v) => acc + v.click_share, 0),
                dealDays: d.reduce((acc, v) => Math.max(acc, v.weekly_number_of_days_with_deal), 0)
            };
        });

        // Determine Impact
        const weeksWithDeals = myWeekly.filter(w => w.dealDays > 0);
        const weeksNoDeals = myWeekly.filter(w => w.dealDays === 0);
        
        const avgShareDeal = weeksWithDeals.length ? (weeksWithDeals.reduce((s,x)=>s+x.share,0)/weeksWithDeals.length) : 0;
        const avgShareNoDeal = weeksNoDeals.length ? (weeksNoDeals.reduce((s,x)=>s+x.share,0)/weeksNoDeals.length) : 0;
        
        const uplift = avgShareNoDeal > 0 ? ((avgShareDeal - avgShareNoDeal)/avgShareNoDeal * 100).toFixed(1) : 0;

        let html = `
            <div style="margin-bottom: 10px;">
                <strong>‚ö° Impacto de Deals:</strong> 
                <span style="color: ${uplift > 0 ? 'var(--success)' : 'var(--text-sub)'}">
                    ${uplift > 0 ? '+' + uplift + '%' : 'Neutro'} en Click Share
                </span> 
                cuando se activa el Deal.
            </div>
            <div style="margin-bottom: 10px;">
                <strong>üí∞ Elasticidad Precio:</strong> 
                Promedio con Deal (${weeksWithDeals.length} semanas) vs Sin Deal (${weeksNoDeals.length} semanas).
            </div>
            <div>
                <strong>üèÜ Badges:</strong>
                Competidores como WeightWorld mantienen "Amazon Choice" consistentemente, lo que les da estabilidad (16-18% share) sin depender de Price Cuts agresivos.
            </div>
        `;
        document.getElementById('levers_content').innerHTML = html;
    }

    // --- TAB 2: INTERACTIVE LOGIC ---
    function populateInteractiveControls() {
        // Competitor Select
        const brands = [...new Set(marketData.map(d => d.competitor_brand))].sort();
        const sel = document.getElementById('sel_comp');
        brands.forEach(b => {
            if (b === MY_BRAND) return;
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            sel.appendChild(opt);
        });
        // Select first competitor
        if(brands.length > 1) sel.value = brands.find(b => b !== MY_BRAND);
    }

    function updateInteractive() {
        const week = document.getElementById('sel_week').value;
        const comp = document.getElementById('sel_comp').value;

        // Filter Data
        let myData = marketData.filter(d => d.competitor_brand === MY_BRAND);
        let compData = marketData.filter(d => d.competitor_brand === comp);

        if (week !== 'all') {
            myData = myData.filter(d => d.week_date === week);
            compData = compData.filter(d => d.week_date === week);
        }

        // Aggregate Helper
        const agg = (arr) => ({
            share: arr.reduce((s,d)=>s+d.click_share,0).toFixed(2),
            price: arr.length ? (arr.reduce((s,d)=>s+d.price,0)/arr.length).toFixed(2) : '-',
            rank: arr.length ? (arr.reduce((s,d)=>s+d.average_organic_rank,0)/arr.length).toFixed(1) : '-',
            deal: arr.reduce((s,d)=>Math.max(s, d.weekly_number_of_days_with_deal), 0)
        });

        const mStats = agg(myData);
        const cStats = agg(compData);

        // Render HTML Columns
        const html = `
            <div style="background: #E8F0FE; padding: 20px; border-radius: 12px;">
                <h3 style="color: var(--primary); margin-top:0;">${MY_BRAND} (Yo)</h3>
                <div class="metric-item" style="margin-bottom:10px; background: white;">
                    <div class="metric-value">${mStats.share}%</div>
                    <div class="metric-label">Click Share</div>
                </div>
                <div>Price: <strong>¬£${mStats.price}</strong></div>
                <div>Avg Rank: <strong>${mStats.rank}</strong></div>
                <div>Deal Days: <strong>${mStats.deal}</strong></div>
            </div>
            <div style="background: #FCE8E6; padding: 20px; border-radius: 12px;">
                <h3 style="color: var(--danger); margin-top:0;">${comp}</h3>
                <div class="metric-item" style="margin-bottom:10px; background: white;">
                    <div class="metric-value">${cStats.share}%</div>
                    <div class="metric-label">Click Share</div>
                </div>
                <div>Price: <strong>¬£${cStats.price}</strong></div>
                <div>Avg Rank: <strong>${cStats.rank}</strong></div>
                <div>Deal Days: <strong>${cStats.deal}</strong></div>
            </div>
        `;
        document.getElementById('comparison_view').innerHTML = html;

        // Draw Comparison Chart (Bar)
        const data = google.visualization.arrayToDataTable([
            ['Metric', 'Yo', 'Competidor'],
            ['Share (%)', parseFloat(mStats.share), parseFloat(cStats.share)],
            ['Price (¬£)', parseFloat(mStats.price), parseFloat(cStats.price)],
        ]);
        
        const options = {
            title: 'Comparativa Directa',
            colors: ['#4285F4', '#EA4335'],
            vAxis: {minValue: 0}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_comparison'));
        chart.draw(data, options);
    }

    // --- UI HELPERS ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        // Redraw charts if unhidden
        if (tabId === 'interactive') updateInteractive();
    }

</script>

</body>
</html>