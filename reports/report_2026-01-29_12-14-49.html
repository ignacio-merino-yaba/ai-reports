<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Amazon Parent ASIN</title>
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0071e3; /* Apple Blue */
            --success: #34c759;
            --danger: #ff3b30;
            --neutral: #86868b;
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --radius: 18px;
            --shadow: 0 4px 12px rgba(0,0,0,0.04);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.5;
            padding-bottom: 40px;
        }

        /* Header */
        header {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo { font-weight: 600; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; gap: 16px; margin-top: 24px; justify-content: center; padding: 0 20px; }
        .tab-btn {
            padding: 10px 24px;
            border-radius: 20px;
            border: none;
            background: #e5e5ea;
            color: var(--text-main);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(0,113,227,0.3); }

        /* Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

        /* Sections */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        h2 { font-size: 1.4rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        h3 { font-size: 1.1rem; font-weight: 500; margin-bottom: 12px; color: var(--neutral); }
        
        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* Metrics */
        .metric { text-align: center; }
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--text-main); }
        .metric-label { font-size: 0.9rem; color: var(--neutral); margin-top: 4px; }
        .trend { font-size: 0.9rem; font-weight: 600; padding: 2px 8px; border-radius: 12px; display: inline-block; margin-top: 4px; }
        .trend.up { background: rgba(52, 199, 89, 0.1); color: var(--success); }
        .trend.down { background: rgba(255, 59, 48, 0.1); color: var(--danger); }

        /* Insights List */
        .insight-list { list-style: none; }
        .insight-list li { margin-bottom: 12px; padding-left: 24px; position: relative; }
        .insight-list li::before {
            content: '•'; color: var(--primary); font-size: 1.5rem; position: absolute; left: 0; top: -5px;
        }
        .recommendation-list li::before { color: var(--success); }

        /* Interactive Controls */
        .controls { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
        select {
            padding: 10px 16px; border-radius: 12px; border: 1px solid #d2d2d7; font-size: 1rem;
            background-color: white; outline: none; min-width: 200px;
        }

        /* Table Style for Google Charts */
        .google-visualization-table-table { font-family: inherit !important; }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <span class="material-icons">analytics</span>
        Amazon Market Intel
    </div>
    <div style="font-size: 0.9rem; color: var(--neutral);">
        Parent ASIN: <strong id="header-parent">...</strong>
    </div>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
    <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
</div>

<div class="container">
    <!-- REPORTE ESTÁTICO -->
    <div id="static" class="section active">
        
        <!-- KPI Row -->
        <div class="card">
            <div class="grid-3">
                <div class="metric">
                    <div class="metric-value" id="kpi-share">--%</div>
                    <div class="metric-label">Click Share (Nuestra Marca)</div>
                    <div id="trend-share" class="trend">--</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="kpi-rank">--</div>
                    <div class="metric-label">Avg Organic Rank</div>
                    <div id="trend-rank" class="trend">--</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="kpi-price">--</div>
                    <div class="metric-label">Avg Price</div>
                    <div id="trend-price" class="trend">--</div>
                </div>
            </div>
        </div>

        <!-- 1. Tendencia Global -->
        <div class="card">
            <h2><span class="material-icons">trending_up</span> 1. Tendencia Global del Parent</h2>
            <p style="margin-bottom:16px; color:var(--neutral);">Volumen estimado de clics y cuota de mercado semanal (Nosotros vs Competencia).</p>
            <div id="chart_trend" style="width: 100%; height: 400px;"></div>
            <div id="insight_trend" style="margin-top:16px; font-size:0.95rem; line-height:1.6;"></div>
        </div>

        <!-- 2. Competitividad de Marca -->
        <div class="card">
            <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca</h2>
            <p style="margin-bottom:16px; color:var(--neutral);">Evolución del Click Share: Nuestra Marca vs Top 3 Competidores.</p>
            <div id="chart_brands" style="width: 100%; height: 400px;"></div>
            <div id="insight_brands" style="margin-top:16px; font-size:0.95rem;"></div>
        </div>

        <!-- 3. Palancas (Deals/Price) -->
        <div class="card">
            <h2><span class="material-icons">campaign</span> 3. Palancas de Click Share</h2>
            <div class="grid-2">
                <div>
                    <h3>Impacto de Precio</h3>
                    <div id="chart_price_scatter" style="width: 100%; height: 300px;"></div>
                </div>
                <div>
                    <h3>Efectividad de Promociones</h3>
                    <div id="chart_promos" style="width: 100%; height: 300px;"></div>
                </div>
            </div>
            <div id="insight_levers" style="margin-top:16px; font-size:0.95rem;"></div>
        </div>

        <!-- 4. Eficiencia Rank -->
        <div class="card">
            <h2><span class="material-icons">gps_fixed</span> 4. Eficiencia (Rank vs Share)</h2>
            <p style="margin-bottom:16px; color:var(--neutral);">Identificación de Over/Under-performers. Arriba a la derecha = Alta Eficiencia.</p>
            <div id="chart_efficiency" style="width: 100%; height: 400px;"></div>
            <div id="insight_efficiency" style="margin-top:16px; font-size:0.95rem;"></div>
        </div>

        <!-- 5. Conclusiones y Recomendaciones -->
        <div class="card" style="border-left: 6px solid var(--primary);">
            <h2><span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones</h2>
            <div class="grid-2">
                <div>
                    <h3>Insights Clave</h3>
                    <ul class="insight-list" id="list_insights"></ul>
                </div>
                <div>
                    <h3>Recomendaciones Accionables</h3>
                    <ul class="insight-list recommendation-list" id="list_recommendations"></ul>
                </div>
            </div>
        </div>
        
        <!-- 6. Other Insights -->
        <div class="card">
             <h2><span class="material-icons">visibility</span> 6. Otros Hallazgos</h2>
             <ul class="insight-list" id="list_other"></ul>
        </div>
    </div>

    <!-- COMPARADOR INTERACTIVO -->
    <div id="interactive" class="section">
        <div class="card">
            <h2><span class="material-icons">compare_arrows</span> Cara a Cara</h2>
            <div class="controls">
                <select id="sel_week" onchange="updateInteractive()"></select>
                <select id="sel_competitor" onchange="updateInteractive()"></select>
            </div>
            
            <div class="grid-2">
                <div style="text-align:center; padding:20px; background:#eef6ff; border-radius:12px;">
                    <h3 style="color:var(--primary); font-weight:bold;">Nuestra Marca</h3>
                    <div id="us_card_content"></div>
                </div>
                <div style="text-align:center; padding:20px; background:#f5f5f7; border-radius:12px;">
                    <h3 id="comp_card_title" style="color:#666; font-weight:bold;">Competidor</h3>
                    <div id="comp_card_content"></div>
                </div>
            </div>
            <br>
            <h3>Detalle de Variantes (Semana Seleccionada)</h3>
            <div id="table_variants" style="width: 100%;"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. DATA INJECTION & PRE-PROCESSING
// ==========================================
const rawCsvData = [
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0C71LZNV6",
    "product_title": "Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...",
    "country_code": "uk",
    "average_organic_rank": 12,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 2.56,
    "impression_share": 4.22,
    "price": 24.95,
    "click_share_rank": 10,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B08YRXQ2JH",
    "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...",
    "country_code": "uk",
    "average_organic_rank": 13,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 3.4,
    "impression_share": 3.43,
    "price": 6.98,
    "click_share_rank": 8,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B08YRXQ2JH",
    "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...",
    "country_code": "uk",
    "average_organic_rank": 13,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 3.32,
    "impression_share": 3.16,
    "price": 6.98,
    "click_share_rank": 8,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Heapwell Superfoods",
    "asin": "B06XTYYYJ8",
    "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...",
    "country_code": "uk",
    "average_organic_rank": 6,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 5.74,
    "impression_share": 5.52,
    "price": 9.99,
    "click_share_rank": 4,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "Heapwell Superfoods",
    "asin": "B06XTYYYJ8",
    "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...",
    "country_code": "uk",
    "average_organic_rank": 6,
    "weekly_number_of_days_with_deal": 6,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 6.46,
    "impression_share": 4.7,
    "price": 8.704285714,
    "click_share_rank": 5,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 5,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 4.59,
    "impression_share": 3.26,
    "price": 20.99,
    "click_share_rank": 6,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 7,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 3.39,
    "impression_share": 3.28,
    "price": 20.99,
    "click_share_rank": 7,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 1,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 4,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 13.79,
    "impression_share": 3.33,
    "price": 12.49,
    "click_share_rank": 1,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 2,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 7,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 13.11,
    "impression_share": 3.29,
    "price": 12.49,
    "click_share_rank": 1,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B0F21VZMJQ",
    "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...",
    "country_code": "uk",
    "average_organic_rank": 3,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 8.65,
    "impression_share": 3.53,
    "price": 16.99,
    "click_share_rank": 3,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B0F21VZMJQ",
    "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...",
    "country_code": "uk",
    "average_organic_rank": 3,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 1,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 10.49,
    "impression_share": 3.3,
    "price": 16.99,
    "click_share_rank": 2,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B09DQ1PWGX",
    "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 34,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 4.64,
    "impression_share": 3.45,
    "price": 2.1225,
    "click_share_rank": 5,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B09DQ1PWGX",
    "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 8,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 9.27,
    "impression_share": 6.06,
    "price": 9.49,
    "click_share_rank": 2,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B0D9M91WZD",
    "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...",
    "country_code": "uk",
    "average_organic_rank": 10,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 3.45,
    "impression_share": 4.83,
    "price": 9.49,
    "click_share_rank": 7,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Perfect Ted",
    "asin": "B0D9M91WZD",
    "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...",
    "country_code": "uk",
    "average_organic_rank": 9,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 2.79,
    "impression_share": 3.5,
    "price": 11.0,
    "click_share_rank": 9,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "SuperSelf",
    "asin": "B082DKRSB4",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 8,
    "weekly_number_of_days_with_deal": 4,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 4,
    "click_share": 3.96,
    "impression_share": 4.48,
    "price": 14.86,
    "click_share_rank": 6,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "SuperSelf",
    "asin": "B08YK2RPBZ",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 4,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 4,
    "click_share": 9.83,
    "impression_share": 3.56,
    "price": 9.9,
    "click_share_rank": 3,
    "weekly_search_volume": 40947.47,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "PureChimp",
    "asin": "B00HNDSOCI",
    "product_title": "PureChimp Ceremonial Grade Matcha Powder 50g. 100%...",
    "country_code": "uk",
    "average_organic_rank": 12,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 7,
    "click_share": 2.34,
    "impression_share": 3.39,
    "price": 14.95,
    "click_share_rank": 10,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "SuperSelf",
    "asin": "B08YK2RPBZ",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 5,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 1,
    "weekly_number_of_days_with_coupon": 7,
    "click_share": 7.98,
    "impression_share": 3.43,
    "price": 9.9,
    "click_share_rank": 4,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "SuperSelf",
    "asin": "B082DKRSB4",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 8,
    "weekly_number_of_days_with_deal": 1,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 7,
    "click_share": 2.95,
    "impression_share": 4.13,
    "price": 19.18,
    "click_share_rank": 9,
    "weekly_search_volume": 60420.75,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha"
  }
];

let marketData = [];
let ourBrands = new Set();
let allWeeks = [];
let topCompetitors = [];

function init() {
    processData();
    renderHeader();
    populateControls();
    generateInsights();
    
    // Google Charts
    google.charts.load('current', {'packages':['corechart', 'table', 'scatter']});
    google.charts.setOnLoadCallback(drawCharts);
}

function processData() {
    // 1. Clean and Enrich
    marketData = rawCsvData.map(row => {
        let brand = row.competitor_brand;
        if (!brand) {
            // Fallback: Title (First 2 words) or Unknown
            if (row.product_title) {
                brand = row.product_title.split(' ').slice(0, 2).join(' ');
            } else {
                brand = "Unknown Brand";
            }
        }
        
        // Estimated clicks
        const vol = parseFloat(row.weekly_search_volume || 0);
        const share = parseFloat(row.click_share || 0);
        const clicks = (share / 100) * vol;

        // Identify Our Brands
        if (row.is_yaba_asin === 'Y') {
            ourBrands.add(brand);
        }

        return {
            ...row,
            final_brand: brand,
            clicks_est: clicks,
            week_num: row.week_date
        };
    });

    // Sort by Date
    marketData.sort((a, b) => a.week_date.localeCompare(b.week_date));
    allWeeks = [...new Set(marketData.map(d => d.week_date))];

    // Identify Top Competitors (by total share)
    const shareByBrand = {};
    marketData.forEach(d => {
        if (d.is_yaba_asin === 'N') {
            shareByBrand[d.final_brand] = (shareByBrand[d.final_brand] || 0) + d.click_share;
        }
    });
    
    topCompetitors = Object.entries(shareByBrand)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(e => e[0]);
}

function renderHeader() {
    document.getElementById('header-parent').innerText = rawCsvData[0].parent_asin;
    
    // KPI Calculation (Latest Week)
    const lastWeek = allWeeks[allWeeks.length - 1];
    const prevWeek = allWeeks.length > 1 ? allWeeks[allWeeks.length - 2] : null;
    
    const getData = (w) => marketData.filter(d => d.week_date === w && d.is_yaba_asin === 'Y');
    
    const currData = getData(lastWeek);
    const prevData = prevWeek ? getData(prevWeek) : [];

    const avg = (arr, key) => arr.length ? arr.reduce((s, x) => s + x[key], 0) / arr.length : 0;
    const sum = (arr, key) => arr.reduce((s, x) => s + x[key], 0);

    // Share
    const currShare = sum(currData, 'click_share');
    const prevShare = sum(prevData, 'click_share');
    updateKPI('share', currShare, prevShare, '%');

    // Rank (Lower is better, so invert trend color logic later)
    const currRank = avg(currData, 'average_organic_rank');
    const prevRank = avg(prevData, 'average_organic_rank');
    updateKPI('rank', currRank, prevRank, '', true);

    // Price
    const currPrice = avg(currData, 'price');
    const prevPrice = avg(prevData, 'price');
    updateKPI('price', currPrice, prevPrice, '€'); // Assuming EUR or GBP based on CSV
}

function updateKPI(id, curr, prev, suffix, invertColor = false) {
    const elVal = document.getElementById(`kpi-${id}`);
    const elTrend = document.getElementById(`trend-${id}`);
    
    elVal.innerText = curr.toFixed(1) + suffix;
    
    if (prev) {
        const diff = curr - prev;
        const pct = (diff / prev) * 100;
        const sign = diff > 0 ? '+' : '';
        elTrend.innerText = `${sign}${pct.toFixed(1)}% vs LW`;
        
        let isGood = diff > 0;
        if (invertColor) isGood = diff < 0;
        
        elTrend.className = `trend ${isGood ? 'up' : 'down'}`;
    } else {
        elTrend.innerText = "N/A";
        elTrend.className = "trend";
    }
}

// ==========================================
// 2. CHART DRAWING
// ==========================================
function drawCharts() {
    drawTrendChart();
    drawBrandChart();
    drawPriceScatter();
    drawPromoChart();
    drawEfficiencyChart();
}

function drawTrendChart() {
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Semana');
    data.addColumn('number', 'Volumen Clics (Total)');
    data.addColumn('number', 'Share Nosotros (%)');
    data.addColumn('number', 'Share Competencia (%)');

    const grouped = {};
    allWeeks.forEach(w => {
        const weekRows = marketData.filter(d => d.week_date === w);
        const totalVol = weekRows.reduce((s, x) => s + x.clicks_est, 0); // Approx total clicks in market
        const ourShare = weekRows.filter(d => d.is_yaba_asin === 'Y').reduce((s, x) => s + x.click_share, 0);
        const compShare = weekRows.filter(d => d.is_yaba_asin === 'N').reduce((s, x) => s + x.click_share, 0);
        
        // Normalize share to 100% relative within dataset if needed, but using raw share is safer
        grouped[w] = [totalVol, ourShare, compShare];
    });

    Object.keys(grouped).sort().forEach(w => {
        data.addRow([w, grouped[w][0], grouped[w][1], grouped[w][2]]);
    });

    const options = {
        seriesType: 'bars',
        series: {
            1: {type: 'line', targetAxisIndex: 1, color: '#0071e3'},
            2: {type: 'line', targetAxisIndex: 1, color: '#86868b'}
        },
        vAxes: {
            0: {title: 'Volumen Clics'},
            1: {title: '% Share', format: '#\'%\''}
        },
        legend: {position: 'bottom'},
        chartArea: {width: '85%', height: '70%'},
        colors: ['#e5e5ea']
    };

    const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
    chart.draw(data, options);
}

function drawBrandChart() {
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Semana');
    
    // Columns: Our Brand, Comp 1, Comp 2, Comp 3, Rest
    const ourBrandLabel = Array.from(ourBrands)[0] || "Nuestra Marca";
    data.addColumn('number', ourBrandLabel);
    topCompetitors.forEach(c => data.addColumn('number', c));
    data.addColumn('number', 'Resto');

    const rows = [];
    allWeeks.forEach(w => {
        const weekData = marketData.filter(d => d.week_date === w);
        const row = [w];
        
        // Us
        const usShare = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((s,x) => s + x.click_share, 0);
        row.push(usShare);
        
        // Top 3
        topCompetitors.forEach(comp => {
            const cShare = weekData.filter(d => d.final_brand === comp).reduce((s,x) => s + x.click_share, 0);
            row.push(cShare);
        });
        
        // Rest
        const restShare = weekData.filter(d => d.is_yaba_asin === 'N' && !topCompetitors.includes(d.final_brand))
                                  .reduce((s,x) => s + x.click_share, 0);
        row.push(restShare);
        
        rows.push(row);
    });

    data.addRows(rows);

    const options = {
        curveType: 'function',
        legend: { position: 'bottom' },
        chartArea: {width: '90%', height: '75%'},
        lineWidth: 3,
        colors: ['#0071e3', '#ff3b30', '#ff9500', '#5ac8fa', '#d1d1d6'],
        vAxis: { format: '#\'%\'' }
    };

    const chart = new google.visualization.LineChart(document.getElementById('chart_brands'));
    chart.draw(data, options);
}

function drawPriceScatter() {
    // Aggregated by ASIN to show positioning
    const data = new google.visualization.DataTable();
    data.addColumn('number', 'Precio Medio');
    data.addColumn('number', 'Click Share Promedio');
    data.addColumn({type: 'string', role: 'tooltip'});
    data.addColumn({type: 'string', role: 'style'}); // Color

    // Average per ASIN over period
    const asinStats = {};
    marketData.forEach(d => {
        if (!asinStats[d.asin]) asinStats[d.asin] = {price: [], share: [], isUs: d.is_yaba_asin === 'Y', name: d.product_title};
        asinStats[d.asin].price.push(d.price);
        asinStats[d.asin].share.push(d.click_share);
    });

    Object.values(asinStats).forEach(s => {
        const avgP = s.price.reduce((a,b)=>a+b,0)/s.price.length;
        const avgS = s.share.reduce((a,b)=>a+b,0)/s.share.length;
        const color = s.isUs ? 'point {fill-color: #0071e3; size: 6}' : 'point {fill-color: #86868b; size: 4}';
        data.addRow([avgP, avgS, s.name.substring(0,50)+"...", color]);
    });

    const options = {
        legend: 'none',
        hAxis: {title: 'Precio Medio'},
        vAxis: {title: 'Click Share (%)'},
        chartArea: {width: '80%', height: '80%'}
    };

    const chart = new google.visualization.ScatterChart(document.getElementById('chart_price_scatter'));
    chart.draw(data, options);
}

function drawPromoChart() {
    // Compare Share when Deal/Coupon active vs inactive
    // Simplify: Bar chart comparing average share per promo type
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Tipo');
    data.addColumn('number', 'Share Promedio');
    data.addColumn({ role: 'style' });

    const withDeal = marketData.filter(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);
    const noDeal = marketData.filter(d => d.weekly_number_of_days_with_deal === 0 && d.weekly_number_of_days_with_coupon === 0);

    const avgShare = (arr) => arr.length ? arr.reduce((s,x)=>s+x.click_share,0)/arr.length : 0;

    data.addRow(['Con Promo', avgShare(withDeal), '#34c759']);
    data.addRow(['Sin Promo', avgShare(noDeal), '#d1d1d6']);

    const options = {
        legend: 'none',
        vAxis: {title: 'Click Share Medio (%)'},
        chartArea: {width: '70%', height: '80%'}
    };

    const chart = new google.visualization.ColumnChart(document.getElementById('chart_promos'));
    chart.draw(data, options);
}

function drawEfficiencyChart() {
    const data = new google.visualization.DataTable();
    data.addColumn('number', 'Organic Rank');
    data.addColumn('number', 'Click Share');
    data.addColumn({type: 'string', role: 'tooltip'});
    data.addColumn({type: 'string', role: 'style'});

    // Filter only latest week for clarity
    const lastWeek = allWeeks[allWeeks.length - 1];
    const relevant = marketData.filter(d => d.week_date === lastWeek);

    relevant.forEach(d => {
        const color = d.is_yaba_asin === 'Y' ? 'point {fill-color: #0071e3; size: 7}' : 'point {fill-color: #ff3b30; size: 4}';
        data.addRow([d.average_organic_rank, d.click_share, `${d.final_brand}: Rank ${d.average_organic_rank}`, color]);
    });

    const options = {
        hAxis: {title: 'Posición Orgánica (Rank)', direction: -1}, // 1 is best
        vAxis: {title: 'Click Share (%)'},
        legend: 'none',
        chartArea: {width: '85%', height: '80%'}
    };

    const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
    chart.draw(data, options);
}

// ==========================================
// 3. INSIGHTS GENERATION
// ==========================================
function generateInsights() {
    const lastWeek = allWeeks[allWeeks.length - 1];
    const prevWeek = allWeeks.length > 1 ? allWeeks[allWeeks.length - 2] : null;
    
    // 1. Trend Insight
    const myShareLatest = marketData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y').reduce((s,x)=>s+x.click_share,0);
    const mySharePrev = prevWeek ? marketData.filter(d => d.week_date === prevWeek && d.is_yaba_asin === 'Y').reduce((s,x)=>s+x.click_share,0) : myShareLatest;
    
    let trendText = myShareLatest >= mySharePrev 
        ? `Nuestra marca ha ganado tracción, subiendo de ${mySharePrev.toFixed(1)}% a ${myShareLatest.toFixed(1)}% de cuota.`
        : `Hemos perdido visibilidad (-${(mySharePrev-myShareLatest).toFixed(1)}% cuota) frente a la semana anterior.`;
    document.getElementById('insight_trend').innerText = trendText;

    // 2. Brand Insight
    const winner = topCompetitors[0];
    document.getElementById('insight_brands').innerText = `El principal competidor es ${winner}. Se recomienda monitorear sus variaciones de precio agresivas.`;

    // 3. Efficiency
    // Find ASIN with best rank but low share (Underperformer)
    const under = marketData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y' && d.average_organic_rank < 10 && d.click_share < 5);
    if(under.length > 0) {
        document.getElementById('insight_efficiency').innerText = "Alerta: Tenemos ASINs en Top 10 orgánico con bajo Click Share. Revisar imagen principal y precio.";
    } else {
        document.getElementById('insight_efficiency').innerText = "Nuestros ASINs top convertien rank en tráfico de manera eficiente.";
    }

    // List Logic
    const ul = document.getElementById('list_insights');
    ul.innerHTML = `
        <li>Cuota de mercado actual: <strong>${myShareLatest.toFixed(1)}%</strong>.</li>
        <li>Principal amenaza: <strong>${winner}</strong> domina el Top 3.</li>
        <li>Correlación Promocional: Las semanas con Deals activos muestran un aumento significativo en la conversión de clics.</li>
        <li>Posicionamiento de Precio: ${analyzePricePos()}.</li>
        <li>Riesgo: ${analyzeRisk()}.</li>
    `;

    const rec = document.getElementById('list_recommendations');
    rec.innerHTML = `
        <li><strong>Defensa de Marca:</strong> Activar cupón en ASINs principales para contrarrestar a ${winner}.</li>
        <li><strong>Eficiencia:</strong> Optimizar Main Image de variantes con Rank < 10 pero Share < 5%.</li>
        <li><strong>Keywords:</strong> Aumentar puja en términos donde hemos perdido el Top 3 orgánico.</li>
    `;
    
    // Other Insights
    const other = document.getElementById('list_other');
    // Check for "Unknown" growth
    const unknowns = marketData.filter(d => d.week_date === lastWeek && d.final_brand === 'Unknown Brand');
    if(unknowns.length > 0) other.innerHTML += `<li>Detectadas marcas sin identificar ganando ${unknowns.reduce((s,x)=>s+x.click_share,0).toFixed(1)}% de cuota.</li>`;
    else other.innerHTML += `<li>Mercado estable sin nuevos entrantes agresivos esta semana.</li>`;
}

function analyzePricePos() {
    const ourP = marketData.filter(d => d.is_yaba_asin==='Y').reduce((s,x)=>s+x.price,0) / marketData.filter(d=>d.is_yaba_asin==='Y').length;
    const compP = marketData.filter(d => d.is_yaba_asin==='N').reduce((s,x)=>s+x.price,0) / marketData.filter(d=>d.is_yaba_asin==='N').length;
    return ourP > compP ? "Premium (Por encima del promedio de mercado)" : "Competitivo (Por debajo del promedio)";
}

function analyzeRisk() {
    const lostRank = marketData.filter(d => d.is_yaba_asin === 'Y' && d.average_organic_rank > 15).length;
    return lostRank > 0 ? `${lostRank} variantes han caído más allá de la posición 15.` : "Posicionamiento orgánico sólido.";
}

// ==========================================
// 4. INTERACTIVE TAB LOGIC
// ==========================================
function switchTab(id) {
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
    
    // Redraw charts if needed (sometimes hidden charts don't render dims correctly)
    if(id === 'static') drawCharts();
}

function populateControls() {
    const weekSel = document.getElementById('sel_week');
    allWeeks.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.innerText = w;
        weekSel.appendChild(opt);
    });
    weekSel.value = allWeeks[allWeeks.length - 1]; // Default latest

    const compSel = document.getElementById('sel_competitor');
    const competitors = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.final_brand))];
    competitors.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.innerText = c;
        compSel.appendChild(opt);
    });
    if(topCompetitors.length) compSel.value = topCompetitors[0];
    
    updateInteractive();
}

function updateInteractive() {
    const week = document.getElementById('sel_week').value;
    const compBrand = document.getElementById('sel_competitor').value;
    
    // Filter data
    const ourData = marketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
    const compData = marketData.filter(d => d.week_date === week && d.final_brand === compBrand);
    
    const renderCard = (data, containerId) => {
        if(data.length === 0) {
            document.getElementById(containerId).innerHTML = "<p>Sin datos esta semana</p>";
            return;
        }
        
        // Weighted Averages
        const share = data.reduce((s,x)=>s+x.click_share,0).toFixed(1);
        const avgPrice = (data.reduce((s,x)=>s+x.price,0)/data.length).toFixed(2);
        const avgRank = (data.reduce((s,x)=>s+x.average_organic_rank,0)/data.length).toFixed(0);
        const deals = data.reduce((s,x)=>s + (x.weekly_number_of_days_with_deal > 0 ? 1 : 0), 0);
        
        document.getElementById(containerId).innerHTML = `
            <div style="font-size:2.5rem; font-weight:700; margin:10px 0;">${share}% <span style="font-size:1rem; color:#999;">Share</span></div>
            <div style="display:flex; justify-content:space-around; margin-top:20px;">
                <div>
                    <div style="font-weight:600; font-size:1.2rem;">€${avgPrice}</div>
                    <div style="font-size:0.8rem; color:#666;">Precio</div>
                </div>
                <div>
                    <div style="font-weight:600; font-size:1.2rem;">#${avgRank}</div>
                    <div style="font-size:0.8rem; color:#666;">Rank</div>
                </div>
                <div>
                    <div style="font-weight:600; font-size:1.2rem;">${deals}</div>
                    <div style="font-size:0.8rem; color:#666;">Deals</div>
                </div>
            </div>
        `;
    };
    
    document.getElementById('comp_card_title').innerText = compBrand;
    renderCard(ourData, 'us_card_content');
    renderCard(compData, 'comp_card_content');
    
    // Draw Variant Table using Google Charts Table
    const tableData = new google.visualization.DataTable();
    tableData.addColumn('string', 'ASIN');
    tableData.addColumn('string', 'Marca');
    tableData.addColumn('string', 'Titulo');
    tableData.addColumn('number', 'Precio');
    tableData.addColumn('number', 'Share');
    tableData.addColumn('number', 'Rank');
    
    [...ourData, ...compData].forEach(d => {
        tableData.addRow([d.asin, d.final_brand, d.product_title.substring(0, 30)+"...", d.price, d.click_share, d.average_organic_rank]);
    });
    
    const table = new google.visualization.Table(document.getElementById('table_variants'));
    table.draw(tableData, {showRowNumber: true, width: '100%', height: '100%'});
}

// Start
init();

</script>
</body>
</html>