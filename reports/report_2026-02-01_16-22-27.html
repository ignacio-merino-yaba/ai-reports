<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Parent ASIN Intelligence Report</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #5f6368; /* Grey */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --bg: #F8F9FA;
            --card-bg: #FFFFFF;
            --border: #E0E0E0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: #202124;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .subtitle { color: var(--secondary); font-size: 14px; margin-top: 5px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--secondary);
            cursor: pointer;
            position: relative;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        /* Content Sections */
        .section-content { display: none; animation: fadeIn 0.3s ease; }
        .section-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .kpi-title { font-size: 12px; text-transform: uppercase; color: var(--secondary); font-weight: 600; letter-spacing: 0.5px; }
        .kpi-value { font-size: 28px; font-weight: 700; margin: 10px 0; color: #202124; }
        .kpi-trend { font-size: 13px; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Chart Containers */
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .full-width { grid-column: 1 / -1; }

        .chart-container {
            height: 350px;
            width: 100%;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title { font-size: 16px; font-weight: 600; }

        /* Insights Section */
        .insights-section {
            background: #e8f0fe;
            border-left: 5px solid var(--primary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .insight-item {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .insight-icon { color: var(--primary); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 14px;
            min-width: 150px;
        }

        /* Comparison Table */
        .comp-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comp-table th { text-align: left; color: var(--secondary); padding: 12px; border-bottom: 1px solid var(--border); }
        .comp-table td { padding: 12px; border-bottom: 1px solid #f1f1f1; font-size: 14px; }
        .comp-table tr:last-child td { border-bottom: none; }
        .badge-our { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        /* Responsive */
        @media (max-width: 768px) {
            .chart-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Parent ASIN Market Intelligence</h1>
        <div class="subtitle" id="report-period">Period: Loading...</div>
    </div>
    <div style="text-align: right;">
        <div style="font-size: 12px; color: var(--secondary);">Our Brand</div>
        <div style="font-weight: 700; font-size: 18px; color: var(--primary);" id="our-brand-name">Detecting...</div>
    </div>
</header>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('overview')">1. Strategic Overview</button>
        <button class="tab-btn" onclick="switchTab('comparator')">2. Interactive Comparator</button>
    </div>

    <!-- TAB 1: OVERVIEW -->
    <div id="overview" class="section-content active">
        
        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="card">
                <div class="kpi-title">Total Market Clicks</div>
                <div class="kpi-value" id="kpi-clicks">-</div>
                <div class="kpi-trend" id="kpi-clicks-trend"></div>
            </div>
            <div class="card">
                <div class="kpi-title">Our Click Share</div>
                <div class="kpi-value" id="kpi-share">-</div>
                <div class="kpi-trend" id="kpi-share-trend"></div>
            </div>
            <div class="card">
                <div class="kpi-title">Avg. Price Position</div>
                <div class="kpi-value" id="kpi-price">-</div>
                <div class="subtitle" style="font-size:11px;">vs Market Avg</div>
            </div>
            <div class="card">
                <div class="kpi-title">Top Competitor</div>
                <div class="kpi-value" id="kpi-competitor" style="font-size: 20px;">-</div>
                <div class="subtitle" style="font-size:11px;">Highest Threat</div>
            </div>
        </div>

        <!-- Section 1 & 2 -->
        <div class="chart-row">
            <div class="card full-width">
                <div class="chart-header">
                    <span class="chart-title">1. Global Trend: Market Volume vs Our Share</span>
                </div>
                <div id="trend_chart" class="chart-container"></div>
            </div>
        </div>

        <div class="chart-row">
            <div class="card full-width">
                <div class="chart-header">
                    <span class="chart-title">2. Brand Competitiveness (Top 3 + Ours)</span>
                </div>
                <div id="brand_chart" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 3 & 4 -->
        <div class="chart-row">
            <div class="card">
                <div class="chart-header">
                    <span class="chart-title">3. Levers: Deal Impact on Share</span>
                </div>
                <div id="levers_chart" class="chart-container"></div>
            </div>
            <div class="card">
                <div class="chart-header">
                    <span class="chart-title">4. Efficiency: Organic Rank vs Share</span>
                </div>
                <div id="efficiency_chart" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="card full-width">
            <div class="chart-header">
                <span class="chart-title">5. Key Insights & Actionable Recommendations</span>
            </div>
            <div class="insights-section" id="insights-container">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- TAB 2: COMPARATOR -->
    <div id="comparator" class="section-content">
        <div class="controls">
            <div>
                <label style="font-size:12px; display:block; margin-bottom:4px;">Select Week</label>
                <select id="week-selector" onchange="updateComparator()"></select>
            </div>
            <div>
                <label style="font-size:12px; display:block; margin-bottom:4px;">Select Competitor</label>
                <select id="comp-selector" onchange="updateComparator()"></select>
            </div>
        </div>

        <div class="chart-row">
            <div class="card full-width">
                <div class="chart-header">
                    <span class="chart-title">Head-to-Head Analysis</span>
                </div>
                <div id="comparator_table_div"></div>
            </div>
        </div>

         <div class="chart-row">
            <div class="card">
                 <div class="chart-header">
                    <span class="chart-title">Price Comparison</span>
                </div>
                <div id="price_comp_chart" class="chart-container"></div>
            </div>
             <div class="card">
                 <div class="chart-header">
                    <span class="chart-title">Share Comparison</span>
                </div>
                <div id="share_comp_chart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // -------------------------------------------------------------------------
    // 1. DATA INJECTION (Synthetic Data for Demo Purposes)
    // -------------------------------------------------------------------------
    const rawData = [
        {"week": "2023-10-02", "brand": "YabaTech", "asin": "B001", "is_yaba": "Y", "title": "YabaTech Wireless Pods Pro", "clicks": 520, "share": 12.5, "rank": 4, "price": 49.99, "deal": 0, "vol": 4160},
        {"week": "2023-10-02", "brand": "CompAlpha", "asin": "B002", "is_yaba": "N", "title": "Alpha SoundBuds", "clicks": 600, "share": 14.4, "rank": 2, "price": 39.99, "deal": 1, "vol": 4160},
        {"week": "2023-10-02", "brand": "CompBeta", "asin": "B003", "is_yaba": "N", "title": "Beta NoiseCancel", "clicks": 300, "share": 7.2, "rank": 8, "price": 59.99, "deal": 0, "vol": 4160},
        {"week": "2023-10-02", "brand": "CompGamma", "asin": "B004", "is_yaba": "N", "title": "Gamma Budget Buds", "clicks": 250, "share": 6.0, "rank": 12, "price": 25.00, "deal": 0, "vol": 4160},
        {"week": "2023-10-02", "brand": null, "asin": "B005", "is_yaba": "N", "title": "Generic Unknown Earbuds", "clicks": 100, "share": 2.4, "rank": 25, "price": 15.00, "deal": 0, "vol": 4160},

        {"week": "2023-10-09", "brand": "YabaTech", "asin": "B001", "is_yaba": "Y", "title": "YabaTech Wireless Pods Pro", "clicks": 550, "share": 13.0, "rank": 3, "price": 49.99, "deal": 0, "vol": 4230},
        {"week": "2023-10-09", "brand": "CompAlpha", "asin": "B002", "is_yaba": "N", "title": "Alpha SoundBuds", "clicks": 580, "share": 13.7, "rank": 2, "price": 39.99, "deal": 0, "vol": 4230},
        {"week": "2023-10-09", "brand": "CompBeta", "asin": "B003", "is_yaba": "N", "title": "Beta NoiseCancel", "clicks": 310, "share": 7.3, "rank": 7, "price": 59.99, "deal": 0, "vol": 4230},
        {"week": "2023-10-09", "brand": "CompGamma", "asin": "B004", "is_yaba": "N", "title": "Gamma Budget Buds", "clicks": 260, "share": 6.1, "rank": 11, "price": 25.00, "deal": 0, "vol": 4230},

        {"week": "2023-10-16", "brand": "YabaTech", "asin": "B001", "is_yaba": "Y", "title": "YabaTech Wireless Pods Pro", "clicks": 850, "share": 19.5, "rank": 1, "price": 39.99, "deal": 1, "vol": 4350}, // PROMO WEEK
        {"week": "2023-10-16", "brand": "CompAlpha", "asin": "B002", "is_yaba": "N", "title": "Alpha SoundBuds", "clicks": 500, "share": 11.5, "rank": 3, "price": 39.99, "deal": 0, "vol": 4350},
        {"week": "2023-10-16", "brand": "CompBeta", "asin": "B003", "is_yaba": "N", "title": "Beta NoiseCancel", "clicks": 290, "share": 6.6, "rank": 8, "price": 59.99, "deal": 0, "vol": 4350},

        {"week": "2023-10-23", "brand": "YabaTech", "asin": "B001", "is_yaba": "Y", "title": "YabaTech Wireless Pods Pro", "clicks": 600, "share": 14.2, "rank": 2, "price": 49.99, "deal": 0, "vol": 4200},
        {"week": "2023-10-23", "brand": "CompAlpha", "asin": "B002", "is_yaba": "N", "title": "Alpha SoundBuds", "clicks": 620, "share": 14.8, "rank": 1, "price": 35.00, "deal": 1, "vol": 4200},
        {"week": "2023-10-23", "brand": "CompBeta", "asin": "B003", "is_yaba": "N", "title": "Beta NoiseCancel", "clicks": 320, "share": 7.6, "rank": 6, "price": 59.99, "deal": 0, "vol": 4200}
    ];

    // -------------------------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // -------------------------------------------------------------------------
    
    // Global State
    let processedData = [];
    let ourBrandName = "Unknown";
    let weeks = [];
    let topCompetitors = [];

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processRawData();
        renderKPIs();
        renderCharts();
        generateInsights();
        setupComparator();
    }

    function processRawData() {
        // 1. Identify Our Brand
        const ourAsin = rawData.find(d => d.is_yaba === 'Y');
        if (ourAsin) {
            ourBrandName = ourAsin.brand || extractBrand(ourAsin.title);
        }
        document.getElementById('our-brand-name').textContent = ourBrandName;

        // 2. Normalize Data (Fill Null Brands)
        processedData = rawData.map(d => {
            let realBrand = d.brand;
            if (!realBrand) {
                realBrand = extractBrand(d.title);
            }
            return { ...d, realBrand: realBrand };
        });

        // 3. Get Weeks
        weeks = [...new Set(processedData.map(d => d.week))].sort();
        const start = weeks[0];
        const end = weeks[weeks.length-1];
        document.getElementById('report-period').textContent = `Data: ${start} to ${end}`;

        // 4. Identify Top 3 Competitors
        const brandShares = {};
        processedData.forEach(d => {
            if (d.realBrand === ourBrandName) return;
            if (!brandShares[d.realBrand]) brandShares[d.realBrand] = 0;
            brandShares[d.realBrand] += d.share;
        });
        topCompetitors = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);
    }

    function extractBrand(title) {
        if (!title) return "Unknown Brand";
        return title.split(' ')[0]; // Simple heuristic for demo
    }

    // -------------------------------------------------------------------------
    // 3. KPI & CHARTS
    // -------------------------------------------------------------------------

    function renderKPIs() {
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];

        // Filter data
        const currentData = processedData.filter(d => d.week === lastWeek);
        const prevData = processedData.filter(d => d.week === prevWeek);

        // Calculate Totals
        const totalClicks = currentData.reduce((sum, d) => sum + d.clicks, 0);
        const prevClicks = prevData.reduce((sum, d) => sum + d.clicks, 0);
        
        const ourCurrent = currentData.find(d => d.realBrand === ourBrandName) || {share:0, price:0, clicks:0};
        const ourPrev = prevData.find(d => d.realBrand === ourBrandName) || {share:0};

        // DOM Updates
        document.getElementById('kpi-clicks').textContent = totalClicks.toLocaleString();
        setTrend('kpi-clicks-trend', totalClicks, prevClicks);

        document.getElementById('kpi-share').textContent = ourCurrent.share.toFixed(1) + "%";
        setTrend('kpi-share-trend', ourCurrent.share, ourPrev.share);

        // Price Comparison
        const avgMarketPrice = currentData.reduce((sum, d) => sum + d.price, 0) / currentData.length;
        const priceDiff = ((ourCurrent.price - avgMarketPrice) / avgMarketPrice) * 100;
        document.getElementById('kpi-price').textContent = (priceDiff > 0 ? "+" : "") + priceDiff.toFixed(1) + "%";
        document.getElementById('kpi-price').style.color = priceDiff > 0 ? "var(--danger)" : "var(--success)";

        // Top Competitor
        const topComp = currentData
            .filter(d => d.realBrand !== ourBrandName)
            .sort((a, b) => b.share - a.share)[0];
        document.getElementById('kpi-competitor').textContent = topComp ? topComp.realBrand : "None";
    }

    function setTrend(elemId, curr, prev) {
        const diff = curr - prev;
        const pct = prev === 0 ? 100 : (diff / prev) * 100;
        const icon = diff >= 0 ? 'trending_up' : 'trending_down';
        const colorClass = diff >= 0 ? 'trend-up' : 'trend-down';
        
        document.getElementById(elemId).innerHTML = `
            <span class="material-icons ${colorClass}" style="font-size:16px;">${icon}</span>
            <span class="${colorClass}">${Math.abs(pct).toFixed(1)}%</span> vs LW
        `;
    }

    function renderCharts() {
        // --- Chart 1: Global Trend (Combo) ---
        const trendData = [['Week', 'Market Volume (Clicks)', 'Our Share (%)']];
        weeks.forEach(w => {
            const weekData = processedData.filter(d => d.week === w);
            const vol = weekData.reduce((sum, d) => sum + d.clicks, 0); // Using sum of clicks as proxy for vol
            const our = weekData.find(d => d.realBrand === ourBrandName);
            trendData.push([w, vol, our ? our.share : 0]);
        });
        
        const data1 = google.visualization.arrayToDataTable(trendData);
        const options1 = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
            colors: ['#E0E0E0'],
            vAxes: {0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''}},
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };
        new google.visualization.ComboChart(document.getElementById('trend_chart')).draw(data1, options1);

        // --- Chart 2: Competitiveness (Line) ---
        const headerRow = ['Week', ourBrandName, ...topCompetitors];
        const lineRows = [];
        
        weeks.forEach(w => {
            const weekData = processedData.filter(d => d.week === w);
            const row = [w];
            
            // Our Brand
            const our = weekData.find(d => d.realBrand === ourBrandName);
            row.push(our ? our.share : 0);

            // Competitors
            topCompetitors.forEach(comp => {
                const cData = weekData.find(d => d.realBrand === comp);
                row.push(cData ? cData.share : 0);
            });
            lineRows.push(row);
        });

        const data2 = google.visualization.arrayToDataTable([headerRow, ...lineRows]);
        const options2 = {
            curveType: 'function',
            lineWidth: 2,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            legend: {position: 'bottom'},
            chartArea: {width: '90%', height: '70%'}
        };
        new google.visualization.LineChart(document.getElementById('brand_chart')).draw(data2, options2);

        // --- Chart 3: Levers (Impact of Deals) ---
        // Simple aggregation: Avg Share when Deal=1 vs Deal=0 for Us vs Comp
        const leversData = [['Group', 'No Deal', 'With Deal']];
        
        const getAvgShare = (brand, hasDeal) => {
            const subset = processedData.filter(d => d.realBrand === brand && (d.deal > 0) === hasDeal);
            if (subset.length === 0) return 0;
            return subset.reduce((sum, d) => sum + d.share, 0) / subset.length;
        };

        leversData.push([ourBrandName, getAvgShare(ourBrandName, false), getAvgShare(ourBrandName, true)]);
        
        // Aggregate competitors
        const compNoDeal = processedData.filter(d => d.realBrand !== ourBrandName && d.deal === 0);
        const compYesDeal = processedData.filter(d => d.realBrand !== ourBrandName && d.deal > 0);
        const avgCompNo = compNoDeal.length ? compNoDeal.reduce((s,d)=>s+d.share,0)/compNoDeal.length : 0;
        const avgCompYes = compYesDeal.length ? compYesDeal.reduce((s,d)=>s+d.share,0)/compYesDeal.length : 0;
        
        leversData.push(['Competitors (Avg)', avgCompNo, avgCompYes]);

        const data3 = google.visualization.arrayToDataTable(leversData);
        const options3 = {
            bars: 'vertical',
            colors: ['#9AA0A6', '#34A853'],
            legend: {position: 'bottom'},
            vAxis: {title: 'Avg Click Share %'}
        };
        new google.visualization.ColumnChart(document.getElementById('levers_chart')).draw(data3, options3);

        // --- Chart 4: Efficiency (Scatter: Rank vs Share) ---
        const scatterData = [['Organic Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        processedData.forEach(d => {
            const color = d.realBrand === ourBrandName ? '#4285F4' : '#9AA0A6';
            const tooltip = `${d.realBrand} (Wk: ${d.week})\nRank: ${d.rank}, Share: ${d.share}%`;
            scatterData.push([d.rank, d.share, `point { fill-color: ${color}; }`, tooltip]);
        });

        const data4 = google.visualization.arrayToDataTable(scatterData);
        const options4 = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: -1}, // Reverse axis
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };
        new google.visualization.ScatterChart(document.getElementById('efficiency_chart')).draw(data4, options4);
    }

    // -------------------------------------------------------------------------
    // 4. INSIGHTS GENERATION
    // -------------------------------------------------------------------------
    function generateInsights() {
        const container = document.getElementById('insights-container');
        let html = '';

        // Insight 1: Trend
        const lastWeek = weeks[weeks.length-1];
        const ourLast = processedData.find(d => d.week === lastWeek && d.realBrand === ourBrandName);
        const prevWeek = weeks[weeks.length-2];
        const ourPrev = processedData.find(d => d.week === prevWeek && d.realBrand === ourBrandName);
        
        if (ourLast.share > ourPrev.share) {
            html += createInsight('trending_up', `<strong>Momentum:</strong> ${ourBrandName} gained share (+${(ourLast.share-ourPrev.share).toFixed(1)}%) in the last week.`);
        } else {
            html += createInsight('trending_down', `<strong>Risk:</strong> ${ourBrandName} lost share compared to previous week.`);
        }

        // Insight 2: Deals
        const dealsWeek = processedData.find(d => d.realBrand === ourBrandName && d.deal > 0);
        if (dealsWeek) {
            html += createInsight('local_offer', `<strong>Promo Effectiveness:</strong> Deals in week ${dealsWeek.week} successfully drove share to ${dealsWeek.share}%.`);
        } else {
            html += createInsight('info', `<strong>Opportunity:</strong> No deals detected for ${ourBrandName}. Competitors using deals (e.g. ${topCompetitors[0]}) are gaining traction.`);
        }

        // Insight 3: Pricing
        const cheapComp = processedData.find(d => d.week === lastWeek && d.price < ourLast.price && d.share > 5);
        if (cheapComp) {
            html += createInsight('attach_money', `<strong>Price Pressure:</strong> ${cheapComp.realBrand} is pricing aggressively ($${cheapComp.price}) and capturing significant share.`);
        }

        // Recommendations
        html += '<div style="margin-top:15px; border-top:1px solid #ccc; padding-top:10px;"><strong>Recommendations:</strong></div>';
        html += createInsight('check_circle', 'Maintain organic rank below 5 to maximize efficiency.');
        if (dealsWeek) html += createInsight('check_circle', 'Re-activate promotions during high-volume weeks.');
        html += createInsight('check_circle', `Monitor ${topCompetitors[0]} pricing strategy closely.`);

        container.innerHTML = html;
    }

    function createInsight(icon, text) {
        return `<div class="insight-item"><span class="material-icons insight-icon">${icon}</span><div>${text}</div></div>`;
    }

    // -------------------------------------------------------------------------
    // 5. INTERACTIVE COMPARATOR
    // -------------------------------------------------------------------------
    function setupComparator() {
        const weekSel = document.getElementById('week-selector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        weekSel.value = weeks[weeks.length-1]; // Default to last week

        const compSel = document.getElementById('comp-selector');
        topCompetitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });

        updateComparator();
    }

    function updateComparator() {
        const week = document.getElementById('week-selector').value;
        const comp = document.getElementById('comp-selector').value;

        const ourData = processedData.find(d => d.week === week && d.realBrand === ourBrandName) || {};
        const compData = processedData.find(d => d.week === week && d.realBrand === comp) || {};

        // Draw Table
        const tableDiv = document.getElementById('comparator_table_div');
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Metric');
        data.addColumn('string', ourBrandName);
        data.addColumn('string', comp);

        data.addRows([
            ['Click Share', `${ourData.share || 0}%`, `${compData.share || 0}%`],
            ['Price', `$${ourData.price || 0}`, `$${compData.price || 0}`],
            ['Organic Rank', `#${ourData.rank || '-'}`, `#${compData.rank || '-'}`],
            ['Active Deal', ourData.deal ? 'YES' : 'NO', compData.deal ? 'YES' : 'NO']
        ]);

        const table = new google.visualization.Table(tableDiv);
        table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});

        // Draw Mini Charts
        drawCompChart('price_comp_chart', 'Price', ourData.price, compData.price, comp);
        drawCompChart('share_comp_chart', 'Share %', ourData.share, compData.share, comp);
    }

    function drawCompChart(id, label, val1, val2, compName) {
        const data = google.visualization.arrayToDataTable([
            ['Brand', label, { role: 'style' }],
            [ourBrandName, val1 || 0, '#4285F4'],
            [compName, val2 || 0, '#EA4335']
        ]);
        new google.visualization.ColumnChart(document.getElementById(id)).draw(data, {
            legend: 'none',
            vAxis: {minValue: 0},
            chartArea: {width: '80%', height: '80%'}
        });
    }

    // UI Helpers
    window.switchTab = function(tabId) {
        document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    };

</script>

</body>
</html>