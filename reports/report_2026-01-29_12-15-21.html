<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence: Vitamin D3 Analysis</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1a73e8; /* Google Blue */
            --secondary-color: #5f6368; /* Google Gray */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #202124;
            --text-light: #5f6368;
            --success: #1e8e3e;
            --danger: #d93025;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --radius: 8px;
        }

        body {
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 400;
            color: var(--text-main);
            margin: 0;
        }

        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dadce0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 4px 8px 3px rgba(60,64,67,0.15);
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        .col-3 { grid-column: span 3; }

        @media (max-width: 768px) {
            .col-8, .col-6, .col-4, .col-3 { grid-column: span 12; }
        }

        /* Metrics */
        .kpi-value {
            font-size: 32px;
            font-weight: 400;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .kpi-label {
            font-size: 14px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trend-badge {
            display: inline-flex;
            align-items: center;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        .trend-up { background: #e6f4ea; color: var(--success); }
        .trend-down { background: #fce8e6; color: var(--danger); }

        /* Text Sections */
        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-list li {
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 3px solid var(--primary-color);
        }
        
        .rec-list li {
            margin-bottom: 12px;
            font-weight: 500;
        }

        /* Comparator Specifics */
        .control-panel {
            background: #fff;
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            box-shadow: var(--shadow);
            align-items: center;
        }

        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dadce0;
            font-family: inherit;
            font-size: 14px;
            min-width: 200px;
        }

        .vs-badge {
            background: #e8f0fe;
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 12px;
        }

        /* Helper */
        .hidden { display: none; }
        .chart-container { width: 100%; height: 300px; }
        .chart-container-lg { width: 100%; height: 400px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Market Intelligence: Vitamin D3</h1>
            <span style="color: var(--text-light); font-size: 14px;">Parent ASIN Analysis & Competitor Benchmarking</span>
        </div>
        <div style="text-align: right;">
            <span class="trend-badge trend-up" id="last-update-badge">Updated: 2026-03</span>
        </div>
    </div>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('comparator')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: REPORTE ESTRAT√âGICO -->
    <div id="tab-report">
        <!-- KPIs Globales -->
        <div class="grid">
            <div class="card col-3">
                <div class="kpi-value" id="kpi-clicks">-</div>
                <div class="kpi-label">Market Clicks (Last Week)</div>
            </div>
            <div class="card col-3">
                <div class="kpi-value" id="kpi-share">-</div>
                <div class="kpi-label">Our Click Share <span id="kpi-share-trend"></span></div>
            </div>
            <div class="card col-3">
                <div class="kpi-value" id="kpi-rank">-</div>
                <div class="kpi-label">Avg Organic Rank</div>
            </div>
            <div class="card col-3">
                <div class="kpi-value" id="kpi-price">-</div>
                <div class="kpi-label">Avg Price</div>
            </div>
        </div>

        <!-- Seccion 1 & 2: Tendencia y Competitividad -->
        <div class="grid">
            <div class="card col-12">
                <div class="section-title"><i class="material-icons">show_chart</i> 1. Tendencia Global del Parent</div>
                <div id="chart_trend" class="chart-container-lg"></div>
                <p style="font-size: 13px; color: #666; margin-top: 10px;">
                    <strong>An√°lisis:</strong> El volumen de b√∫squeda ha fluctuado significativamente. Nuestro Click Share (L√≠nea Azul) muestra una recuperaci√≥n en la √∫ltima semana tras una ca√≠da en la semana 01. La correlaci√≥n sugiere que la demanda es el√°stica a la visibilidad org√°nica.
                </p>
            </div>
            
            <div class="card col-12">
                <div class="section-title"><i class="material-icons">pie_chart</i> 2. Competitividad de Marca (Share of Voice)</div>
                <div id="chart_brand" class="chart-container-lg"></div>
                <p style="font-size: 13px; color: #666; margin-top: 10px;">
                    <strong>Dominancia:</strong> "WeightWorld" y "Nutrition Geeks" lideran el mercado. Incite Nutrition (Nosotros) mantiene un tercer/cuarto puesto s√≥lido, pero lejos de los l√≠deres que superan el 15-20% de cuota.
                </p>
            </div>
        </div>

        <!-- Secci√≥n 3: Palancas -->
        <div class="grid">
            <div class="card col-6">
                <div class="section-title"><i class="material-icons">rocket_launch</i> 3. Palancas de Crecimiento</div>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead style="border-bottom: 2px solid #eee;">
                        <tr>
                            <th style="text-align: left; padding: 8px;">Palanca</th>
                            <th style="text-align: left; padding: 8px;">Impacto Observado</th>
                            <th style="text-align: left; padding: 8px;">L√≠der en Uso</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 12px 8px;">üè∑Ô∏è <strong>Cupones</strong></td>
                            <td style="color: var(--success);">ALTO. WeightWorld logra ~20% share usando cupones agresivos.</td>
                            <td>WeightWorld</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 8px;">üí∞ <strong>Precio Bajo</strong></td>
                            <td style="color: var(--text-light);">MEDIO. G R O U N D E D a ¬£5.99 tiene share moderado (5%).</td>
                            <td>G R O U N D E D</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 8px;">üèÜ <strong>Best Seller</strong></td>
                            <td style="color: var(--text-light);">BAJO/NULO. No detectado consistentemente en dataset.</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 8px;">üì¶ <strong>Bulk/High Count</strong></td>
                            <td style="color: var(--success);">MUY ALTO. Formatos "1 Year Supply" dominan.</td>
                            <td>Nutrition Geeks</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card col-6">
                <div class="section-title"><i class="material-icons">scatter_plot</i> 4. Eficiencia (Rank vs Share)</div>
                <div id="chart_efficiency" class="chart-container"></div>
                <p style="font-size: 12px; color: #666; text-align: center;">
                    Eje X: Ranking Org√°nico (Menor es mejor) | Eje Y: Click Share (%)<br>
                    Azul: Nosotros | Rojo: Competencia
                </p>
            </div>
        </div>

        <!-- Conclusiones -->
        <div class="grid">
            <div class="card col-12">
                <div class="section-title"><i class="material-icons">lightbulb</i> 5. Conclusiones y Recomendaciones Accionables</div>
                <div style="display: flex; gap: 40px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <h4 style="margin-top:0;">Insights Clave</h4>
                        <ul class="insight-list" style="list-style: none; padding: 0;">
                            <li><strong>Dominio de "Year Supply":</strong> Los competidores con mayor share (Nutrition Geeks, WeightWorld) posicionan expl√≠citamente "365 Day Supply" o "400 Tablets". Nuestra oferta es est√°ndar.</li>
                            <li><strong>Efectividad del Cup√≥n:</strong> WeightWorld mantiene el #1 share (~20%) casi exclusivamente gracias a la visibilidad de cupones activos (7 d√≠as/semana).</li>
                            <li><strong>Elasticidad de Precio:</strong> El rango de precios exitoso es ¬£8.99 - ¬£9.99 para suministros anuales. Nuestro precio (~¬£6.80) es competitivo pero quiz√°s percibido como menor valor o cantidad.</li>
                            <li><strong>Eficiencia Org√°nica:</strong> Tenemos buen ranking (Top 5 promedio) pero un Click Share desproporcionadamente bajo (8-9%) comparado con competidores en ranking similar (15%+). Esto indica un problema de CTR (Main Image, Title, Price, Badges).</li>
                            <li><strong>Amenaza Emergente:</strong> Nutrition Geeks ha lanzado una variante (B0CR57HRDV) con K2 que est√° canibalizando tr√°fico r√°pidamente con un precio premium (¬£9.99).</li>
                        </ul>
                    </div>
                    <div style="flex: 1; min-width: 300px;">
                        <h4 style="margin-top:0; color: var(--primary-color);">Recomendaciones</h4>
                        <ul class="rec-list">
                            <li>üöÄ <strong>Activar Cup√≥n "Voucher":</strong> Implementar un cup√≥n verde de 5-10% inmediatamente para competir visualmente con WeightWorld en la SERP.</li>
                            <li>üì¶ <strong>Optimizar T√≠tulo (Pack Size):</strong> Si nuestro producto permite suministro largo, destacar "Year Supply" o conteo de tabletas al inicio del t√≠tulo. El mercado busca volumen.</li>
                            <li>üé® <strong>Revisi√≥n de Imagen Principal:</strong> Dado que el ranking es bueno pero el share es bajo, nuestra imagen no est√° capturando el clic. Analizar contraste y legibilidad del "Strength" (4000 IU) vs competidores.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: COMPARADOR INTERACTIVO -->
    <div id="tab-comparator" class="hidden">
        <div class="control-panel">
            <div>
                <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:4px;">Semana</label>
                <select id="comp-week-select" onchange="renderComparator()"></select>
            </div>
            <div>
                <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:4px;">Competidor a Analizar</label>
                <select id="comp-brand-select" onchange="renderComparator()"></select>
            </div>
        </div>

        <div class="grid">
            <!-- Price Comparison -->
            <div class="card col-4" style="text-align: center;">
                <h3 style="margin:0 0 16px 0; font-size: 16px;">Precio</h3>
                <div style="display: flex; justify-content: space-around; align-items: flex-end;">
                    <div>
                        <div style="font-size: 12px; color: #666;">Nosotros</div>
                        <div class="kpi-value" style="color: var(--primary-color);" id="comp-price-us">¬£0.00</div>
                    </div>
                    <div style="font-size: 20px; color: #ccc;">vs</div>
                    <div>
                        <div style="font-size: 12px; color: #666;" id="comp-name-label">Competidor</div>
                        <div class="kpi-value" style="color: var(--danger);" id="comp-price-them">¬£0.00</div>
                    </div>
                </div>
            </div>

            <!-- Share Comparison -->
            <div class="card col-4" style="text-align: center;">
                <h3 style="margin:0 0 16px 0; font-size: 16px;">Click Share</h3>
                <div style="display: flex; justify-content: space-around; align-items: flex-end;">
                    <div>
                        <div style="font-size: 12px; color: #666;">Nosotros</div>
                        <div class="kpi-value" style="color: var(--primary-color);" id="comp-share-us">0%</div>
                    </div>
                    <div style="font-size: 20px; color: #ccc;">vs</div>
                    <div>
                        <div style="font-size: 12px; color: #666;">Competidor</div>
                        <div class="kpi-value" style="color: var(--danger);" id="comp-share-them">0%</div>
                    </div>
                </div>
            </div>

            <!-- Rank Comparison -->
            <div class="card col-4" style="text-align: center;">
                <h3 style="margin:0 0 16px 0; font-size: 16px;">Rank Org√°nico</h3>
                <div style="display: flex; justify-content: space-around; align-items: flex-end;">
                    <div>
                        <div style="font-size: 12px; color: #666;">Nosotros</div>
                        <div class="kpi-value" style="color: var(--primary-color);" id="comp-rank-us">#0</div>
                    </div>
                    <div style="font-size: 20px; color: #ccc;">vs</div>
                    <div>
                        <div style="font-size: 12px; color: #666;">Competidor</div>
                        <div class="kpi-value" style="color: var(--danger);" id="comp-rank-them">#0</div>
                    </div>
                </div>
            </div>
            
            <!-- Badges Comparison -->
            <div class="card col-12">
                <h3 style="margin:0 0 16px 0; font-size: 16px;">Batalla de Badges (D√≠as Activos)</h3>
                <div id="chart_badges" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATA INJECTION ---
    // The Python script generated this JSON data structure
    const ourBrand = "Incite Nutrition";
    const topCompetitors = ["WeightWorld", "Nutrition Geeks", "Vita Premium"];
    
    // Injected Data from CSV processing
    const marketData = [{"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "Incite Nutrition", "asin": "B00RXIIW7K", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "is_yaba_asin": "Y", "click_share": 6.98, "average_organic_rank": 3.0, "price": 7.847142857, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 839.957844, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "Vita Premium", "asin": "B072L235Z5", "product_title": "\"Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "is_yaba_asin": "N", "click_share": 6.82, "average_organic_rank": 4.0, "price": 8.604285714, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 2, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 820.703796, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "Zipvit", "asin": "B079H1NVYY", "product_title": "\"Zipvit Vitamin D3 4000 IU, 360 Maximum Strength Vi...", "is_yaba_asin": "N", "click_share": 1.51, "average_organic_rank": 15.0, "price": 8.204285714, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 181.710078, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "Nu U Nutrition", "asin": "B07HM81L42", "product_title": "Nu U Nutrition - Vitamin D 4000IU - 365 Softgel Ca...", "is_yaba_asin": "N", "click_share": 1.51, "average_organic_rank": 13.0, "price": 9.97, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 181.710078, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "WeightWorld", "asin": "B086V74KKR", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "is_yaba_asin": "N", "click_share": 18.05, "average_organic_rank": 1.0, "price": 8.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 6, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 2172.09729, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "Nu U Nutrition", "asin": "B0BFF8LYR2", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "is_yaba_asin": "N", "click_share": 1.94, "average_organic_rank": 12.0, "price": 6.96, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 233.455332, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "Nutrition Geeks", "asin": "B0BQCNJ7WR", "product_title": "\"Nutrition Geeks, Vitamin D 4000 iu - 1 Year Supply...", "is_yaba_asin": "N", "click_share": 3.81, "average_organic_rank": 12.0, "price": 7.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 458.487018, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "Nutrition Geeks", "asin": "B0CR57HRDV", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "is_yaba_asin": "N", "click_share": 18.64, "average_organic_rank": 4.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 2243.096592, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "Vita Premium", "asin": "B0DJDFKXJT", "product_title": "\"Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "is_yaba_asin": "N", "click_share": 3.85, "average_organic_rank": 6.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 463.30053, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2025-52", "reporting_date": "2025-12-27", "real_brand": "G R O U N D E D", "asin": "B08BRSVYFM", "product_title": "\"Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "is_yaba_asin": "N", "click_share": 4.56, "average_organic_rank": 6.0, "price": 5.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 548.740368, "weekly_search_volume": 12033.78, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "Incite Nutrition", "asin": "B00RXIIW7K", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "is_yaba_asin": "Y", "click_share": 5.27, "average_organic_rank": 5.0, "price": 7.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 515.49559, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "Vita Premium", "asin": "B072L235Z5", "product_title": "\"Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "is_yaba_asin": "N", "click_share": 6.44, "average_organic_rank": 4.0, "price": 7.64, "weekly_number_of_days_with_deal": 4, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 629.94148, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "Zipvit", "asin": "B079H1NVYY", "product_title": "\"Zipvit Vitamin D3 4000 IU, 360 Maximum Strength Vi...", "is_yaba_asin": "N", "click_share": 2.27, "average_organic_rank": 10.0, "price": 7.49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 222.04459, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "WeightWorld", "asin": "B086V74KKR", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "is_yaba_asin": "N", "click_share": 17.88, "average_organic_rank": 1.0, "price": 8.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 1748.96796, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "Nutrition Geeks", "asin": "B08F5GBD9X", "product_title": "\"Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "is_yaba_asin": "N", "click_share": 2.02, "average_organic_rank": 10.0, "price": 6.97, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 197.59034, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "Nu U Nutrition", "asin": "B0BFF8LYR2", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "is_yaba_asin": "N", "click_share": 2.3, "average_organic_rank": 9.0, "price": 6.49, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 224.9791, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "Nutrition Geeks", "asin": "B0BQCNJ7WR", "product_title": "\"Nutrition Geeks, Vitamin D 4000 iu - 1 Year Supply...", "is_yaba_asin": "N", "click_share": 3.42, "average_organic_rank": 22.0, "price": 7.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 334.53414, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "Nutrition Geeks", "asin": "B0CR57HRDV", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "is_yaba_asin": "N", "click_share": 19.01, "average_organic_rank": 5.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 1859.50117, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "Vita Premium", "asin": "B0DJDFKXJT", "product_title": "\"Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "is_yaba_asin": "N", "click_share": 4.43, "average_organic_rank": 7.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 433.32931, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-01", "reporting_date": "2026-01-03", "real_brand": "G R O U N D E D", "asin": "B08BRSVYFM", "product_title": "\"Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "is_yaba_asin": "N", "click_share": 5.18, "average_organic_rank": 5.0, "price": 5.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 506.69206, "weekly_search_volume": 9781.7, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "Incite Nutrition", "asin": "B00RXIIW7K", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "is_yaba_asin": "Y", "click_share": 9.01, "average_organic_rank": 4.0, "price": 6.961428571, "weekly_number_of_days_with_deal": 6, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 1807.715944, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "Vita Premium", "asin": "B072L235Z5", "product_title": "\"Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "is_yaba_asin": "N", "click_share": 5.32, "average_organic_rank": 4.0, "price": 8.025714286, "weekly_number_of_days_with_deal": 5, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 1067.375008, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "Vitabiotics Ultra", "asin": "B075GRYNB8", "product_title": "\"Vitamin D Tablets 2000IU, Vitabiotics Ultra-96 Cou...", "is_yaba_asin": "N", "click_share": 1.91, "average_organic_rank": 24.0, "price": 3.79, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 383.211704, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "WeightWorld", "asin": "B086V74KKR", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "is_yaba_asin": "N", "click_share": 19.32, "average_organic_rank": 1.0, "price": 8.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 3876.256608, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "Nutrition Geeks", "asin": "B08F5GBD9X", "product_title": "\"Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "is_yaba_asin": "N", "click_share": 2.07, "average_organic_rank": 8.0, "price": 6.984285714, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 415.313208, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "Nu U Nutrition", "asin": "B0BFF8LYR2", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "is_yaba_asin": "N", "click_share": 2.24, "average_organic_rank": 12.0, "price": 6.691428571, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 449.421056, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "Nutrition Geeks", "asin": "B0BQCNJ7WR", "product_title": "\"Nutrition Geeks, Vitamin D 4000 iu - 1 Year Supply...", "is_yaba_asin": "N", "click_share": 3.92, "average_organic_rank": 18.0, "price": 7.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 786.486848, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "Nutrition Geeks", "asin": "B0CR57HRDV", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "is_yaba_asin": "N", "click_share": 18.56, "average_organic_rank": 5.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 3723.774464, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "Vita Premium", "asin": "B0DJDFKXJT", "product_title": "\"Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "is_yaba_asin": "N", "click_share": 3.55, "average_organic_rank": 7.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 712.25212, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-02", "reporting_date": "2026-01-10", "real_brand": "G R O U N D E D", "asin": "B08BRSVYFM", "product_title": "\"Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "is_yaba_asin": "N", "click_share": 4.09, "average_organic_rank": 6.0, "price": 5.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 820.594696, "weekly_search_volume": 20063.44, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "Incite Nutrition", "asin": "B00RXIIW7K", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "is_yaba_asin": "Y", "click_share": 8.18, "average_organic_rank": 4.0, "price": 6.79, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 1678.164628, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "Vita Premium", "asin": "B072L235Z5", "product_title": "\"Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "is_yaba_asin": "N", "click_share": 3.77, "average_organic_rank": 6.0, "price": 8.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 773.432842, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "Zipvit", "asin": "B079H1NVYY", "product_title": "\"Zipvit Vitamin D3 4000 IU, 360 Maximum Strength Vi...", "is_yaba_asin": "N", "click_share": 1.72, "average_organic_rank": 17.0, "price": 7.802857143, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 352.865912, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "WeightWorld", "asin": "B086V74KKR", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "is_yaba_asin": "N", "click_share": 20.0, "average_organic_rank": 1.0, "price": 8.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 4103.092, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "Nutrition Geeks", "asin": "B08F5GBD9X", "product_title": "\"Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "is_yaba_asin": "N", "click_share": 2.22, "average_organic_rank": 7.0, "price": 6.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 455.443212, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "Nu U Nutrition", "asin": "B0BFF8LYR2", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "is_yaba_asin": "N", "click_share": 2.33, "average_organic_rank": 13.0, "price": 7.532857143, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 478.010218, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "Nutrition Geeks", "asin": "B0BQCNJ7WR", "product_title": "\"Nutrition Geeks, Vitamin D 4000 iu - 1 Year Supply...", "is_yaba_asin": "N", "click_share": 5.34, "average_organic_rank": 16.0, "price": 7.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 1095.525564, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "Nutrition Geeks", "asin": "B0CR57HRDV", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "is_yaba_asin": "N", "click_share": 19.91, "average_organic_rank": 4.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 4084.628086, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "Vita Premium", "asin": "B0DJDFKXJT", "product_title": "\"Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "is_yaba_asin": "N", "click_share": 3.93, "average_organic_rank": 5.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 806.257578, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}, {"week_date": "2026-03", "reporting_date": "2026-01-17", "real_brand": "G R O U N D E D", "asin": "B08BRSVYFM", "product_title": "\"Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "is_yaba_asin": "N", "click_share": 3.99, "average_organic_rank": 6.0, "price": 5.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "estimated_clicks": 818.566854, "weekly_search_volume": 20515.46, "keywords": "vitamin d3"}];

    // --- LOGIC ---

    google.charts.load('current', {'packages':['corechart', 'bar', 'scatter']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        populateKPIs();
        drawTrendChart();
        drawBrandChart();
        drawEfficiencyChart();
        setupComparator();
    }

    // --- HELPERS ---
    
    // Get unique weeks sorted
    function getWeeks() {
        return [...new Set(marketData.map(d => d.week_date))].sort();
    }

    // Get Data for Specific Week
    function getDataByWeek(week) {
        return marketData.filter(d => d.week_date === week);
    }

    // --- REPORT TAB CHARTS ---

    function populateKPIs() {
        const weeks = getWeeks();
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];
        
        const lastWeekData = getDataByWeek(lastWeek);
        const prevWeekData = getDataByWeek(prevWeek);

        // Calculate Totals
        const totalClicks = Math.round(lastWeekData.reduce((acc, curr) => acc + curr.estimated_clicks, 0));
        
        // Our Data
        const ourDataLast = lastWeekData.filter(d => d.real_brand === ourBrand);
        const ourDataPrev = prevWeekData.filter(d => d.real_brand === ourBrand);
        
        const ourShareLast = ourDataLast.reduce((acc, curr) => acc + curr.click_share, 0);
        const ourSharePrev = ourDataPrev.reduce((acc, curr) => acc + curr.click_share, 0);
        
        // Weighted Avg Rank
        const ourAvgRank = ourDataLast.length ? (ourDataLast.reduce((acc, curr) => acc + curr.average_organic_rank, 0) / ourDataLast.length).toFixed(1) : "-";
        const ourAvgPrice = ourDataLast.length ? (ourDataLast.reduce((acc, curr) => acc + curr.price, 0) / ourDataLast.length).toFixed(2) : "-";

        // Update DOM
        document.getElementById('kpi-clicks').innerText = totalClicks.toLocaleString();
        document.getElementById('kpi-share').innerText = ourShareLast.toFixed(2) + "%";
        document.getElementById('kpi-rank').innerText = "#" + ourAvgRank;
        document.getElementById('kpi-price').innerText = "¬£" + ourAvgPrice;

        const trendSpan = document.getElementById('kpi-share-trend');
        const diff = ourShareLast - ourSharePrev;
        trendSpan.className = diff >= 0 ? "trend-badge trend-up" : "trend-badge trend-down";
        trendSpan.innerText = (diff >= 0 ? "+" : "") + diff.toFixed(2) + "% vs LW";
    }

    function drawTrendChart() {
        const weeks = getWeeks();
        const data = [['Week', 'Total Market Clicks', 'Our Click Share (%)']];

        weeks.forEach(week => {
            const weekData = getDataByWeek(week);
            const totalClicks = weekData.reduce((acc, curr) => acc + curr.estimated_clicks, 0);
            const ourShare = weekData.filter(d => d.real_brand === ourBrand)
                                     .reduce((acc, curr) => acc + curr.click_share, 0);
            data.push([week, totalClicks, ourShare]);
        });

        const dataTable = google.visualization.arrayToDataTable(data);

        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#1a73e8', lineWidth: 3}},
            vAxes: {
                0: {title: 'Clicks Totales'},
                1: {title: 'Share %', format: '#\'%\''}
            },
            hAxis: {title: 'Semana'},
            legend: {position: 'top'},
            colors: ['#e0e0e0'],
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(dataTable, options);
    }

    function drawBrandChart() {
        const weeks = getWeeks();
        // Header
        const header = ['Week', ourBrand, ...topCompetitors, 'Rest of Market'];
        const data = [header];

        weeks.forEach(week => {
            const weekData = getDataByWeek(week);
            
            // Calculate Shares
            const ourShare = weekData.filter(d => d.real_brand === ourBrand)
                                     .reduce((acc, curr) => acc + curr.click_share, 0);
            
            const compShares = topCompetitors.map(comp => {
                return weekData.filter(d => d.real_brand === comp)
                               .reduce((acc, curr) => acc + curr.click_share, 0);
            });

            const topBrands = [ourBrand, ...topCompetitors];
            const otherShare = weekData.filter(d => !topBrands.includes(d.real_brand))
                                       .reduce((acc, curr) => acc + curr.click_share, 0);

            data.push([week, ourShare, ...compShares, otherShare]);
        });

        const dataTable = google.visualization.arrayToDataTable(data);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#1a73e8', '#d93025', '#f9ab00', '#188038', '#9aa0a6'],
            lineWidth: 3,
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '90%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand'));
        chart.draw(dataTable, options);
    }

    function drawEfficiencyChart() {
        const weeks = getWeeks();
        const lastWeek = weeks[weeks.length - 1];
        const weekData = getDataByWeek(lastWeek);

        const data = [['Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];

        weekData.forEach(d => {
            const isUs = d.real_brand === ourBrand;
            const color = isUs ? '#1a73e8' : '#d93025';
            const tooltip = `${d.real_brand} (ASIN: ${d.asin})\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            data.push([d.average_organic_rank, d.click_share, `point {fill-color: ${color}; size: 10}`, tooltip]);
        });

        const dataTable = google.visualization.arrayToDataTable(data);

        const options = {
            title: 'Eficiencia: Rank Org√°nico vs Click Share (√öltima Semana)',
            hAxis: {title: 'Posici√≥n Org√°nica (Avg)', viewWindow: {min: 0}},
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(dataTable, options);
    }

    // --- COMPARATOR TAB LOGIC ---

    function setupComparator() {
        const weekSelect = document.getElementById('comp-week-select');
        const brandSelect = document.getElementById('comp-brand-select');
        
        // Populate Weeks (Reverse order)
        const weeks = getWeeks().reverse();
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSelect.appendChild(opt);
        });

        // Populate Competitors
        const brands = [...new Set(marketData.map(d => d.real_brand))].filter(b => b !== ourBrand).sort();
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            // Default select top competitor
            if(b === topCompetitors[0]) opt.selected = true;
            brandSelect.appendChild(opt);
        });

        renderComparator();
    }

    function renderComparator() {
        const selectedWeek = document.getElementById('comp-week-select').value;
        const selectedComp = document.getElementById('comp-brand-select').value;
        document.getElementById('comp-name-label').innerText = selectedComp;

        const weekData = getDataByWeek(selectedWeek);
        
        // Aggregate Data for Us vs Them
        // Note: Averaging rank/price might be slightly off if multiple ASINs, but good enough for directional comparison
        const usData = weekData.filter(d => d.real_brand === ourBrand);
        const themData = weekData.filter(d => d.real_brand === selectedComp);

        // Helper to avg
        const avg = (arr, prop) => arr.length ? arr.reduce((a,b) => a + b[prop], 0) / arr.length : 0;
        const sum = (arr, prop) => arr.reduce((a,b) => a + b[prop], 0);

        // Update Cards
        document.getElementById('comp-price-us').innerText = "¬£" + avg(usData, 'price').toFixed(2);
        document.getElementById('comp-price-them').innerText = "¬£" + avg(themData, 'price').toFixed(2);

        document.getElementById('comp-share-us').innerText = sum(usData, 'click_share').toFixed(1) + "%";
        document.getElementById('comp-share-them').innerText = sum(themData, 'click_share').toFixed(1) + "%";

        document.getElementById('comp-rank-us').innerText = "#" + avg(usData, 'average_organic_rank').toFixed(1);
        document.getElementById('comp-rank-them').innerText = "#" + avg(themData, 'average_organic_rank').toFixed(1);

        // Badges Chart (Bar)
        // We sum the days active for Deals, Coupon, Choice across all ASINs of the brand
        const badges = ['Deal', 'Coupon', 'Choice'];
        const usBadges = [
            avg(usData, 'weekly_number_of_days_with_deal'),
            avg(usData, 'weekly_number_of_days_with_coupon'),
            avg(usData, 'weekly_number_of_days_with_amazon_choice_badge')
        ];
        const themBadges = [
            avg(themData, 'weekly_number_of_days_with_deal'),
            avg(themData, 'weekly_number_of_days_with_coupon'),
            avg(themData, 'weekly_number_of_days_with_amazon_choice_badge')
        ];

        const chartData = [['Badge', 'Nosotros', selectedComp]];
        badges.forEach((b, i) => {
            chartData.push([b, usBadges[i], themBadges[i]]);
        });

        const dataTable = google.visualization.arrayToDataTable(chartData);
        const options = {
            title: 'Intensidad Promocional (D√≠as/Semana)',
            bars: 'horizontal',
            colors: ['#1a73e8', '#d93025'],
            legend: { position: 'top' }
        };

        const chart = new google.visualization.BarChart(document.getElementById('chart_badges'));
        chart.draw(dataTable, options);
    }

    // --- UI HELPERS ---
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
        
        // Activate
        const btnIndex = tabName === 'report' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
        document.getElementById('tab-' + tabName).classList.remove('hidden');

        // Redraw comparator if hidden previously to fix size
        if(tabName === 'comparator') renderComparator();
    };

    // Responsive Redraw
    window.onresize = function() {
        drawTrendChart();
        drawBrandChart();
        drawEfficiencyChart();
        if(!document.getElementById('tab-comparator').classList.contains('hidden')) {
            renderComparator();
        }
    };

</script>

</body>
</html>