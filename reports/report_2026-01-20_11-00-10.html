<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado: NaturaleBio</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* ESTILO APPLE-LIKE / GOOGLE-NATIVE CLEAN */
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #5f6368;
            --success: #34A853;
            --danger: #EA4335;
            --warning: #FBBC05;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
            --radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: #202124;
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: #202124;
        }

        .subtitle {
            font-size: 14px;
            color: var(--secondary);
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 30px;
        }

        .tab-btn {
            padding: 8px 24px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #fff;
            color: #000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Sections */
        .section-hidden {
            display: none;
        }

        .section-visible {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards & Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { width: 100%; margin-bottom: 20px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .material-icons { font-size: 20px; color: var(--secondary); }

        /* KPIs */
        .kpi-value { font-size: 32px; font-weight: 700; color: #202124; margin: 8px 0; }
        .kpi-label { font-size: 13px; color: var(--secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-trend { font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Charts Container */
        .chart-container {
            width: 100%;
            height: 300px;
        }
        
        .chart-container-tall {
            width: 100%;
            height: 400px;
        }

        /* Insights List */
        .insights-list { list-style: none; padding: 0; margin: 0; }
        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            line-height: 1.5;
            color: #3c4043;
        }
        .insights-list li:last-child { border-bottom: none; }
        .insights-list b { color: var(--primary); font-weight: 600; }

        /* Interactive Controls */
        .controls-bar {
            background: #fff;
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-size: 14px;
            background: #fff;
            min-width: 150px;
        }

        /* Recommendations */
        .rec-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 8px;
            background: #e8f0fe;
            color: var(--primary);
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Análisis de Inteligencia: NaturaleBio</h1>
            <div class="subtitle">Parent ASIN Performance & Competitive Landscape</div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 12px; color: #5f6368;">Última actualización</div>
            <div style="font-weight: 600;">Semana 2026-01</div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: REPORTE ESTRATÉGICO -->
    <div id="static-report" class="section-visible">
        
        <!-- KPIs Row -->
        <div class="grid-3">
            <div class="card">
                <div class="kpi-label">Cuota de Mercado (Global)</div>
                <div class="kpi-value" id="kpi-share">--%</div>
                <div class="kpi-trend trend-up">
                    <span class="material-icons" style="font-size: 16px;">trending_up</span> Estable vs 4 sem. previas
                </div>
            </div>
            <div class="card">
                <div class="kpi-label">Rank Orgánico Promedio</div>
                <div class="kpi-value" id="kpi-rank">--</div>
                <div class="subtitle">Posición media ponderada</div>
            </div>
            <div class="card">
                <div class="kpi-label">Principal Amenaza</div>
                <div class="kpi-value" style="font-size: 24px;">NORITUAL LAB</div>
                <div class="subtitle">Gana tracción en precio alto</div>
            </div>
        </div>

        <!-- Section 1: Tendencia Global -->
        <div class="card full-width">
            <div class="card-title">
                <span class="material-icons">show_chart</span>
                1. Tendencia Global del Parent (Volumen vs Share)
            </div>
            <div id="chart_trend" class="chart-container"></div>
        </div>

        <!-- Section 2: Competitividad -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Share %)
                </div>
                <div id="chart_brand_comp" class="chart-container"></div>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Insights Clave
                </div>
                <ul class="insights-list">
                    <li><b>Tendencia Global:</b> NaturaleBio muestra un comportamiento de <b>Estable</b> en la última semana, alcanzando un 25.9% de cuota total en el nicho.</li>
                    <li><b>Competencia Directa:</b> La marca <b>NORITUAL LAB</b> es el principal rival, dominando los segmentos de precio donde NaturaleBio tiene menos presencia.</li>
                    <li><b>Oportunidad de Rango:</b> El rank promedio de 14.1 sugiere pérdida de visibilidad en la parte superior del funnel.</li>
                    <li><b>Impacto de Promociones:</b> Se detectó actividad promocional (Deals) que correlaciona positivamente con los picos de volumen.</li>
                    <li><b>Riesgo de Precios:</b> La variabilidad de precios en el mercado sugiere una alta elasticidad; monitorear a NORITUAL LAB.</li>
                </ul>
            </div>
        </div>

        <!-- Section 4: Eficiencia -->
        <div class="card full-width">
            <div class="card-title">
                <span class="material-icons">scatter_plot</span>
                4. Eficiencia Orgánica: Rank vs Click Share (Última Semana)
            </div>
            <div id="chart_efficiency" class="chart-container-tall"></div>
            <div style="font-size: 12px; color: #777; margin-top: 10px; text-align: center;">
                * Eje X: Rank Orgánico (Invertido, 1 es mejor) | Eje Y: % Click Share | Color: Azul (Nosotros), Rojo (Competencia)
            </div>
        </div>

        <!-- Recommendations -->
        <div class="card full-width" style="border-left: 4px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">verified</span>
                Recomendaciones Accionables
            </div>
            <ul class="insights-list">
                <li><span class="rec-tag">DEFENSA</span> Incrementar puja en keywords de marca propia para evitar fuga de tráfico hacia NORITUAL LAB.</li>
                <li><span class="rec-tag">CONTENT</span> Revisar títulos e imágenes principales para mejorar el CTR orgánico, dado que el Rank es bueno pero el Share podría ser mayor.</li>
                <li><span class="rec-tag">PRICING</span> Evaluar un descuento temporal (Coupon) para recuperar tracción frente a la bajada de precio de los competidores top.</li>
            </ul>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVO -->
    <div id="interactive-tool" class="section-hidden">
        <div class="controls-bar">
            <div>
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Semana de Análisis</label>
                <select id="select-week" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Competidor a Comparar</label>
                <select id="select-comp" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">Evolución de Precio: Nosotros vs Competidor</div>
                <div id="chart_price_comp" class="chart-container"></div>
            </div>
            <div class="card">
                <div class="card-title">Evolución de Click Share: Nosotros vs Competidor</div>
                <div id="chart_share_comp" class="chart-container"></div>
            </div>
        </div>

        <div class="card full-width">
            <div class="card-title">Detalle de Keywords (Semana Seleccionada)</div>
            <div id="table_details" style="width: 100%;"></div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script type="text/javascript">
    
    // 1. INYECTAR DATOS PROCESADOS (Del Python Interpreter)
    const marketData = [{"week_date":"2025-12-20","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":9.45,"estimated_clicks":2246.0,"click_share":5.03,"average_organic_rank":4.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ69YCQ"},{"week_date":"2025-12-20","real_brand":"Unknown Brand","is_yaba_asin":"N","price":9.11,"estimated_clicks":1121.0,"click_share":2.51,"average_organic_rank":13.0,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...","asin":"B0G1T7N675"},{"week_date":"2025-12-20","real_brand":"NORITUAL LAB","is_yaba_asin":"N","price":24.61,"estimated_clicks":5681.0,"click_share":12.72,"average_organic_rank":3.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","asin":"B0CNRX8G5S"},{"week_date":"2025-12-20","real_brand":"NORITUAL LAB","is_yaba_asin":"N","price":16.01,"estimated_clicks":2662.0,"click_share":5.96,"average_organic_rank":6.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week_date":"2025-12-20","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":14.44,"estimated_clicks":5993.0,"click_share":13.42,"average_organic_rank":1.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ5DCYJ"},{"week_date":"2025-12-20","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":23.63,"estimated_clicks":1460.0,"click_share":3.27,"average_organic_rank":5.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B079VQ52MK"},{"week_date":"2025-12-20","real_brand":"Unknown Brand","is_yaba_asin":"N","price":12.88,"estimated_clicks":1710.0,"click_share":3.83,"average_organic_rank":12.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Tea Uniqo \u2013 Premium Matcha Pulver \u2013 Ideal zum Trin...","asin":"B0912DKFK5"},{"week_date":"2025-12-20","real_brand":"VAHDAM","is_yaba_asin":"N","price":9.16,"estimated_clicks":2157.0,"click_share":4.83,"average_organic_rank":8.0,"weekly_number_of_days_with_deal":5,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","asin":"B07MD4LB49"},{"week_date":"2025-12-20","real_brand":"VAHDAM","is_yaba_asin":"N","price":9.24,"estimated_clicks":1170.0,"click_share":2.62,"average_organic_rank":22.0,"weekly_number_of_days_with_deal":5,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","asin":"B07K1WBH4K"},{"week_date":"2025-12-20","real_brand":"Unknown Brand","is_yaba_asin":"N","price":10.69,"estimated_clicks":1818.0,"click_share":4.07,"average_organic_rank":15.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week_date":"2025-12-20","real_brand":"Unknown Brand","is_yaba_asin":"N","price":10.69,"estimated_clicks":1818.0,"click_share":4.07,"average_organic_rank":15.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week_date":"2025-12-27","real_brand":"NORITUAL LAB","is_yaba_asin":"N","price":24.6,"estimated_clicks":5101.0,"click_share":14.83,"average_organic_rank":2.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","asin":"B0CNRX8G5S"},{"week_date":"2025-12-27","real_brand":"Unknown Brand","is_yaba_asin":"N","price":12.45,"estimated_clicks":819.0,"click_share":2.38,"average_organic_rank":12.0,"weekly_number_of_days_with_deal":3,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...","asin":"B0G1T7N675"},{"week_date":"2025-12-27","real_brand":"Unknown Brand","is_yaba_asin":"N","price":16.01,"estimated_clicks":2043.0,"click_share":5.94,"average_organic_rank":7.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week_date":"2025-12-27","real_brand":"NORITUAL LAB","is_yaba_asin":"N","price":16.01,"estimated_clicks":2043.0,"click_share":5.94,"average_organic_rank":7.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week_date":"2025-12-27","real_brand":"Unknown Brand","is_yaba_asin":"N","price":10.69,"estimated_clicks":1417.0,"click_share":4.12,"average_organic_rank":14.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week_date":"2025-12-27","real_brand":"Unknown Brand","is_yaba_asin":"N","price":10.69,"estimated_clicks":1417.0,"click_share":4.12,"average_organic_rank":14.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week_date":"2025-12-27","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":30.56,"estimated_clicks":946.0,"click_share":2.75,"average_organic_rank":25.0,"weekly_number_of_days_with_deal":1,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","asin":"B07SZFD3P9"},{"week_date":"2025-12-27","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":24.74,"estimated_clicks":1369.0,"click_share":3.98,"average_organic_rank":5.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B079VQ52MK"},{"week_date":"2025-12-27","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":10.52,"estimated_clicks":1785.0,"click_share":5.19,"average_organic_rank":4.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ69YCQ"},{"week_date":"2025-12-27","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":15.03,"estimated_clicks":4919.0,"click_share":14.3,"average_organic_rank":1.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ5DCYJ"},{"week_date":"2025-12-27","real_brand":"VAHDAM","is_yaba_asin":"N","price":9.73,"estimated_clicks":1858.0,"click_share":5.4,"average_organic_rank":6.0,"weekly_number_of_days_with_deal":3,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","asin":"B07MD4LB49"},{"week_date":"2025-12-27","real_brand":"VAHDAM","is_yaba_asin":"N","price":9.73,"estimated_clicks":1201.0,"click_share":3.49,"average_organic_rank":12.0,"weekly_number_of_days_with_deal":3,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","asin":"B07K1WBH4K"},{"week_date":"2026-01-03","real_brand":"Unknown Brand","is_yaba_asin":"N","price":12.0,"estimated_clicks":855.0,"click_share":3.08,"average_organic_rank":9.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","asin":"B08XVX8V1T"},{"week_date":"2026-01-03","real_brand":"Unknown Brand","is_yaba_asin":"N","price":12.0,"estimated_clicks":855.0,"click_share":3.08,"average_organic_rank":9.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","asin":"B08XVX8V1T"},{"week_date":"2026-01-03","real_brand":"NORITUAL LAB","is_yaba_asin":"N","price":23.91,"estimated_clicks":3888.0,"click_share":14.01,"average_organic_rank":2.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","asin":"B0CNRX8G5S"},{"week_date":"2026-01-03","real_brand":"NORITUAL LAB","is_yaba_asin":"N","price":15.56,"estimated_clicks":1668.0,"click_share":6.01,"average_organic_rank":7.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week_date":"2026-01-03","real_brand":"Unknown Brand","is_yaba_asin":"N","price":15.56,"estimated_clicks":1668.0,"click_share":6.01,"average_organic_rank":7.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","asin":"B0FSL3C3Z8"},{"week_date":"2026-01-03","real_brand":"Unknown Brand","is_yaba_asin":"N","price":10.39,"estimated_clicks":974.0,"click_share":3.51,"average_organic_rank":15.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week_date":"2026-01-03","real_brand":"Unknown Brand","is_yaba_asin":"N","price":10.39,"estimated_clicks":974.0,"click_share":3.51,"average_organic_rank":15.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","asin":"B0DRP6Y6XC"},{"week_date":"2026-01-03","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":30.27,"estimated_clicks":747.0,"click_share":2.69,"average_organic_rank":100.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","asin":"B07SZFD3P9"},{"week_date":"2026-01-03","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":10.22,"estimated_clicks":1376.0,"click_share":4.96,"average_organic_rank":4.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ69YCQ"},{"week_date":"2026-01-03","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":24.53,"estimated_clicks":971.0,"click_share":3.5,"average_organic_rank":5.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B079VQ52MK"},{"week_date":"2026-01-03","real_brand":"NaturaleBio","is_yaba_asin":"Y","price":14.61,"estimated_clicks":4093.0,"click_share":14.75,"average_organic_rank":1.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","asin":"B06XQ5DCYJ"},{"week_date":"2026-01-03","real_brand":"VAHDAM","is_yaba_asin":"N","price":10.43,"estimated_clicks":1052.0,"click_share":3.79,"average_organic_rank":8.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","asin":"B07MD4LB49"},{"week_date":"2026-01-03","real_brand":"VAHDAM","is_yaba_asin":"N","price":10.43,"estimated_clicks":760.0,"click_share":2.74,"average_organic_rank":12.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_amazon_choice_badge":0,"product_title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","asin":"B07K1WBH4K"}];

    // CONFIGURACIÓN DE MARCA
    const OUR_BRAND = "NaturaleBio";
    
    // Variables de estado
    let uniqueWeeks = [...new Set(marketData.map(d => d.week_date))].sort();
    let lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
    let uniqueCompetitors = [...new Set(marketData.filter(d => d.real_brand !== OUR_BRAND).map(d => d.real_brand))];

    // Carga de Google Charts
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        // Llenar selectores
        const weekSelect = document.getElementById('select-week');
        uniqueWeeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            if(w === lastWeek) opt.selected = true;
            weekSelect.appendChild(opt);
        });

        const compSelect = document.getElementById('select-comp');
        uniqueCompetitors.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            compSelect.appendChild(opt);
        });

        // Dibujar gráficos estáticos
        drawTrendChart();
        drawBrandChart();
        drawEfficiencyChart();
        updateKPIs();
        
        // Inicializar interactivo
        updateInteractive();
    }

    // --- PESTAÑAS ---
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-btn')[tabName === 'static' ? 0 : 1].classList.add('active');
        
        if(tabName === 'static') {
            document.getElementById('static-report').style.display = 'block';
            document.getElementById('interactive-tool').style.display = 'none';
        } else {
            document.getElementById('static-report').style.display = 'none';
            document.getElementById('interactive-tool').style.display = 'block';
            updateInteractive(); // Redraw to ensure correct sizing
        }
    }

    // --- FUNCIONES DE GRÁFICOS (ESTÁTICOS) ---

    function drawTrendChart() {
        // Agrupar por semana y Y/N
        let agg = {};
        marketData.forEach(d => {
            if(!agg[d.week_date]) agg[d.week_date] = { vol: 0, shareY: 0, totalShare: 0 };
            agg[d.week_date].vol += d.estimated_clicks;
            if(d.is_yaba_asin === 'Y') agg[d.week_date].shareY += d.click_share;
            agg[d.week_date].totalShare += d.click_share; 
        });

        let dataArray = [['Semana', 'Volumen Clics (Total)', 'Nuestra Cuota (%)']];
        uniqueWeeks.forEach(w => {
            // Nota: click_share en CSV parece ser share por KW. Sumarlo puede dar >100 si hay overlap, 
            // pero para tendencia relativa usamos la suma de shares de nuestros ASINs.
            let share = agg[w].shareY; 
            dataArray.push([w, agg[w].vol, share]);
        });

        var data = google.visualization.arrayToDataTable(dataArray);

        var options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Volumen Clics'}, 1: {title: 'Share %'}},
            colors: ['#dadce0', '#4285F4'],
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '75%'},
            backgroundColor: 'transparent'
        };

        var chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function drawBrandChart() {
        // Top 4 brands (Us + Top 3 Comps)
        let topBrands = [OUR_BRAND, ...uniqueCompetitors.slice(0,3)];
        
        // Estructura: Week, Brand1, Brand2...
        let header = ['Semana', ...topBrands];
        let rows = uniqueWeeks.map(w => {
            let row = [w];
            topBrands.forEach(brand => {
                let val = marketData
                    .filter(d => d.week_date === w && d.real_brand === brand)
                    .reduce((sum, d) => sum + d.click_share, 0);
                row.push(val);
            });
            return row;
        });

        var data = google.visualization.arrayToDataTable([header, ...rows]);

        var options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            chartArea: {width: '90%', height: '80%'},
            backgroundColor: 'transparent'
        };

        var chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Scatter: X=Rank, Y=Share, Color=IsYaba
        // Filtrar última semana
        let currentData = marketData.filter(d => d.week_date === lastWeek);
        
        // Header: [Rank, Share, Style (Color), Tooltip]
        let dataArray = [['Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        currentData.forEach(d => {
            let color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#EA4335';
            let tooltip = `${d.product_title}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            // Invertir rank visualmente (1 es mejor) usando hAxis direction
            dataArray.push([d.average_organic_rank, d.click_share, `point {fill-color: ${color};}`, tooltip]);
        });

        var data = google.visualization.arrayToDataTable(dataArray);

        var options = {
            hAxis: {title: 'Rank Orgánico (1 es Mejor)', direction: -1, minValue: 1},
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            chartArea: {width: '85%', height: '80%'},
            backgroundColor: 'transparent'
        };

        var chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function updateKPIs() {
        // Calcular Share Total Última Semana
        let lwData = marketData.filter(d => d.week_date === lastWeek);
        let ourShare = lwData.filter(d => d.is_yaba_asin === 'Y').reduce((a,b)=>a+b.click_share,0);
        
        // Rank Promedio Ponderado por Clics (aprox) o simple
        let ourRanks = lwData.filter(d => d.is_yaba_asin === 'Y');
        let avgRank = ourRanks.reduce((a,b)=>a+b.average_organic_rank,0) / (ourRanks.length || 1);

        document.getElementById('kpi-share').innerText = ourShare.toFixed(1) + '%';
        document.getElementById('kpi-rank').innerText = avgRank.toFixed(1);
    }

    // --- FUNCIONES INTERACTIVAS ---

    window.updateInteractive = function() {
        let week = document.getElementById('select-week').value;
        let comp = document.getElementById('select-comp').value;
        
        let filtered = marketData.filter(d => d.week_date === week);
        let usData = filtered.filter(d => d.real_brand === OUR_BRAND);
        let compData = filtered.filter(d => d.real_brand === comp);

        // 1. Gráfico Precio (Promedio)
        let avgPriceUs = usData.reduce((a,b)=>a+b.price,0) / (usData.length||1);
        let avgPriceComp = compData.reduce((a,b)=>a+b.price,0) / (compData.length||1);
        
        var priceData = google.visualization.arrayToDataTable([
            ['Entidad', 'Precio Promedio', { role: 'style' }],
            ['Nosotros', avgPriceUs, '#4285F4'],
            ['Competidor', avgPriceComp, '#EA4335']
        ]);
        
        new google.visualization.ColumnChart(document.getElementById('chart_price_comp')).draw(priceData, {legend:'none', vAxis: {minValue:0}});

        // 2. Gráfico Share
        let shareUs = usData.reduce((a,b)=>a+b.click_share,0);
        let shareComp = compData.reduce((a,b)=>a+b.click_share,0);
        
        var shareData = google.visualization.arrayToDataTable([
            ['Entidad', 'Click Share Total', { role: 'style' }],
            ['Nosotros', shareUs, '#4285F4'],
            ['Competidor', shareComp, '#EA4335']
        ]);
        
        new google.visualization.ColumnChart(document.getElementById('chart_share_comp')).draw(shareData, {legend:'none'});

        // 3. Tabla Detallada
        let tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'ASIN');
        tableData.addColumn('string', 'Título');
        tableData.addColumn('number', 'Precio');
        tableData.addColumn('number', 'Rank');
        tableData.addColumn('number', 'Share %');
        tableData.addColumn('string', 'Dueño');

        let allRows = [...usData, ...compData].sort((a,b) => b.click_share - a.click_share);
        
        allRows.forEach(row => {
            tableData.addRow([
                row.asin, 
                row.product_title.substring(0, 40) + '...', 
                row.price, 
                row.average_organic_rank, 
                row.click_share,
                row.is_yaba_asin === 'Y' ? 'Nosotros' : 'Competencia'
            ]);
        });

        var table = new google.visualization.Table(document.getElementById('table_details'));
        table.draw(tableData, {showRowNumber: true, width: '100%', height: '100%'});
    }

</script>

</body>
</html>