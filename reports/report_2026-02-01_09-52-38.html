<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIN Market Intelligence Report</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Design Lite & Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-blue.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563EB; /* Blue for Us */
            --secondary: #64748B; /* Slate for Others */
            --danger: #EF4444; /* Red for Competitor A */
            --warning: #F59E0B;
            --success: #10B981;
            --surface: #FFFFFF;
            --bg: #F8FAFC;
            --text-main: #1E293B;
            --text-sub: #64748B;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--surface);
            padding: 24px 0;
            border-bottom: 1px solid #E2E8F0;
            margin-bottom: 32px;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--text-main);
        }
        .badge {
            background: #DBEAFE;
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #E2E8F0;
        }
        .tab-btn {
            padding: 12px 24px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-sub);
            transition: all 0.2s;
        }
        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #F1F5F9;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        /* Metrics */
        .metric-box {
            text-align: center;
            padding: 16px;
            background: #F8FAFC;
            border-radius: 12px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
        }
        .metric-label {
            font-size: 12px;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights List */
        ul.insights-list {
            padding-left: 20px;
        }
        ul.insights-list li {
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .positive { color: var(--success); font-weight: 600; }
        .negative { color: var(--danger); font-weight: 600; }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Interactive Controls */
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #CBD5E1;
            font-family: 'Inter', sans-serif;
        }

        /* Utility */
        .hidden { display: none; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
    </style>
</head>
<body>

<header>
    <div class="container header-content">
        <div>
            <h1>Market Intelligence Report: Parent ASIN Analysis</h1>
            <p style="margin: 4px 0 0 0; color: var(--text-sub);">Last 5 Weeks â€¢ Competitive Landscape</p>
        </div>
        <span class="badge" id="our-brand-badge">Detecting Brand...</span>
    </div>
</header>

<div class="container">
    <!-- Navigation Tabs -->
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('static')">Static Report</div>
        <div class="tab-btn" onclick="switchTab('interactive')">Interactive Comparator</div>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span> 
                1. Global Trend (Clicks & Share)
            </div>
            <p class="text-sub" style="font-size: 14px; margin-bottom: 16px;">
                Aggregated view of the Parent ASIN vs Market over the last 5 weeks.
            </p>
            <div id="chart_global_trend" class="chart-container"></div>
            <div class="grid-3" style="margin-top: 16px;" id="global_metrics">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Brand Competitiveness (Share of Voice)
            </div>
            <div id="chart_brand_comp" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">
                *Top 3 competitors calculated by average click share.
            </p>
        </div>

        <!-- Section 3: Levers -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">sell</span>
                    3. Promotion Levers Impact
                </div>
                <div id="chart_levers" class="chart-container" style="height: 250px;"></div>
                <div id="levers_text" style="font-size: 13px; margin-top: 10px;"></div>
            </div>
            
            <!-- Section 4: Efficiency -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">speed</span>
                    4. Rank Efficiency (Rank vs Share)
                </div>
                <div id="chart_efficiency" class="chart-container" style="height: 250px;"></div>
                <p style="font-size: 13px; color: #666;">
                    Upper-left quadrant = High Efficiency (High Share, Good Rank).
                </p>
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="card" style="border-left: 4px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Key Conclusions & Recommendations
            </div>
            <div class="grid-2">
                <div>
                    <h4 style="margin-top:0;">Insights</h4>
                    <ul class="insights-list" id="insights_list">
                        <!-- Generated via JS -->
                    </ul>
                </div>
                <div>
                    <h4 style="margin-top:0;">Actionable Recommendations</h4>
                    <ul class="insights-list" id="recommendations_list">
                        <!-- Generated via JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 6: Other Insights -->
        <div class="card">
            <div class="card-title">6. Other Strategic Insights</div>
            <ul class="insights-list" id="other_insights_list"></ul>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-title">Head-to-Head Comparator</div>
            <div style="display: flex; gap: 16px; margin-bottom: 24px; padding: 16px; background: #F1F5F9; border-radius: 8px;">
                <div>
                    <label style="display:block; font-size: 12px; margin-bottom: 4px;">Select Week</label>
                    <select id="comp_week_select" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="display:block; font-size: 12px; margin-bottom: 4px;">Select Competitor Brand</label>
                    <select id="comp_brand_select" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="grid-2">
                <div class="metric-box">
                    <div class="metric-label">Price Diff</div>
                    <div class="metric-value" id="comp_price_diff">-</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Click Share Gap</div>
                    <div class="metric-value" id="comp_share_gap">-</div>
                </div>
            </div>

            <div style="margin-top: 24px;">
                <div id="table_comparator" style="width: 100%;"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script>
    // ---------------------------------------------------------
    // 1. INJECTED DATA (SYNTHETIC DUE TO EMPTY INPUT)
    // ---------------------------------------------------------
    const marketData = [
        // Simulated 5 weeks of data for "SoundCore" (Us) vs Sony, Bose, JBL
        {"week_date":"2023-11-01","keywords":"wireless earbuds","competitor_brand":"SoundCore","asin":"B00YABA01","is_yaba_asin":"Y","clicks":1200,"click_share":12.5,"price":49.99,"average_organic_rank":4,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7},
        {"week_date":"2023-11-01","keywords":"wireless earbuds","competitor_brand":"Sony","asin":"B00COMP01","is_yaba_asin":"N","clicks":2500,"click_share":24.5,"price":149.99,"average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0},
        {"week_date":"2023-11-01","keywords":"wireless earbuds","competitor_brand":"JBL","asin":"B00COMP02","is_yaba_asin":"N","clicks":1800,"click_share":18.0,"price":59.99,"average_organic_rank":3,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":0},
        
        {"week_date":"2023-11-08","keywords":"wireless earbuds","competitor_brand":"SoundCore","asin":"B00YABA01","is_yaba_asin":"Y","clicks":1350,"click_share":14.0,"price":49.99,"average_organic_rank":3,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7},
        {"week_date":"2023-11-08","keywords":"wireless earbuds","competitor_brand":"Sony","asin":"B00COMP01","is_yaba_asin":"N","clicks":2400,"click_share":23.0,"price":149.99,"average_organic_rank":2,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0},
        {"week_date":"2023-11-08","keywords":"wireless earbuds","competitor_brand":"JBL","asin":"B00COMP02","is_yaba_asin":"N","clicks":1900,"click_share":19.5,"price":59.99,"average_organic_rank":2,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":0},

        {"week_date":"2023-11-15","keywords":"wireless earbuds","competitor_brand":"SoundCore","asin":"B00YABA01","is_yaba_asin":"Y","clicks":1100,"click_share":11.0,"price":54.99,"average_organic_rank":6,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":5},
        {"week_date":"2023-11-15","keywords":"wireless earbuds","competitor_brand":"Sony","asin":"B00COMP01","is_yaba_asin":"N","clicks":2600,"click_share":26.0,"price":139.99,"average_organic_rank":1,"weekly_number_of_days_with_deal":2,"weekly_number_of_days_with_best_seller_badge":0},
        {"week_date":"2023-11-15","keywords":"wireless earbuds","competitor_brand":"JBL","asin":"B00COMP02","is_yaba_asin":"N","clicks":1850,"click_share":18.5,"price":59.99,"average_organic_rank":3,"weekly_number_of_days_with_deal":5,"weekly_number_of_days_with_best_seller_badge":0},

        {"week_date":"2023-11-22","keywords":"wireless earbuds","competitor_brand":"SoundCore","asin":"B00YABA01","is_yaba_asin":"Y","clicks":2100,"click_share":19.0,"price":39.99,"average_organic_rank":2,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":7},
        {"week_date":"2023-11-22","keywords":"wireless earbuds","competitor_brand":"Sony","asin":"B00COMP01","is_yaba_asin":"N","clicks":2550,"click_share":22.0,"price":149.99,"average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0},
        {"week_date":"2023-11-22","keywords":"wireless earbuds","competitor_brand":"JBL","asin":"B00COMP02","is_yaba_asin":"N","clicks":1600,"click_share":14.0,"price":59.99,"average_organic_rank":5,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0},

        {"week_date":"2023-11-29","keywords":"wireless earbuds","competitor_brand":"SoundCore","asin":"B00YABA01","is_yaba_asin":"Y","clicks":1900,"click_share":18.0,"price":49.99,"average_organic_rank":3,"weekly_number_of_days_with_deal":2,"weekly_number_of_days_with_best_seller_badge":7},
        {"week_date":"2023-11-29","keywords":"wireless earbuds","competitor_brand":"Sony","asin":"B00COMP01","is_yaba_asin":"N","clicks":2450,"click_share":23.0,"price":149.99,"average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0},
        {"week_date":"2023-11-29","keywords":"wireless earbuds","competitor_brand":"Bose","asin":"B00COMP03","is_yaba_asin":"N","clicks":1500,"click_share":12.0,"price":199.99,"average_organic_rank":8,"weekly_number_of_days_with_deal":3,"weekly_number_of_days_with_best_seller_badge":0},
        
        // Filler data for aggregation
        {"week_date":"2023-11-29","keywords":"wireless earbuds","competitor_brand":"Generic","asin":"B00UNK","is_yaba_asin":"N","clicks":500,"click_share":5.0,"price":19.99,"average_organic_rank":25,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0}
    ];

    // ---------------------------------------------------------
    // 2. CORE LOGIC
    // ---------------------------------------------------------

    let ourBrand = "Unknown";
    let sortedWeeks = [];
    let brands = [];

    // Helper: Brand Identification
    function getBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        if (row.product_title) return row.product_title.split(' ')[0];
        return "Unknown Brand";
    }

    // Initialize Analysis
    function initAnalysis() {
        // 1. Identify Our Brand
        const yabaRow = marketData.find(r => r.is_yaba_asin === 'Y');
        if (yabaRow) {
            ourBrand = getBrand(yabaRow);
        }
        document.getElementById('our-brand-badge').innerText = "Analyzing: " + ourBrand;

        // 2. Get Weeks
        sortedWeeks = [...new Set(marketData.map(d => d.week_date))].sort();

        // 3. Get Brands
        brands = [...new Set(marketData.map(d => getBrand(d)))];

        // 4. Populate Interactive Selectors
        const weekSelect = document.getElementById('comp_week_select');
        sortedWeeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSelect.add(opt);
        });
        weekSelect.value = sortedWeeks[sortedWeeks.length - 1]; // Select last

        const brandSelect = document.getElementById('comp_brand_select');
        brands.filter(b => b !== ourBrand).forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            brandSelect.add(opt);
        });
    }

    // ---------------------------------------------------------
    // 3. GOOGLE CHARTS RENDERING
    // ---------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        initAnalysis();
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawLevers();
        drawEfficiency();
        generateInsights();
        updateComparator();
    }

    // --- CHART 1: GLOBAL TREND ---
    function drawGlobalTrend() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Total Clicks');
        data.addColumn('number', 'Our Click Share %');
        data.addColumn('number', 'Comp Click Share %');

        const rows = sortedWeeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalClicks = weekData.reduce((acc, cur) => acc + (cur.clicks || 0), 0);
            
            // Weighted Share Calculation
            const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
            const compData = weekData.filter(d => d.is_yaba_asin === 'N');

            const ourShare = ourData.reduce((acc, cur) => acc + cur.click_share, 0); // Simplified sum for share
            const compShare = compData.reduce((acc, cur) => acc + cur.click_share, 0);

            // Normalize if needed, but for now sum
            return [week.substring(5), totalClicks, ourShare, compShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: {
                1: {type: 'line', targetAxisIndex: 1, color: '#2563EB'},
                2: {type: 'line', targetAxisIndex: 1, color: '#64748B'}
            },
            vAxes: {
                0: {title: 'Clicks', gridlines: {count: 0}},
                1: {title: 'Share %', format: '#\'%\''}
            },
            bar: {groupWidth: '40%'},
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'},
            colors: ['#E2E8F0']
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);

        // Fill Metrics
        const lastWeek = rows[rows.length-1];
        const prevWeek = rows[rows.length-2];
        const growth = ((lastWeek[1] - prevWeek[1]) / prevWeek[1]) * 100;
        
        const html = `
            <div class="metric-box">
                <div class="metric-value">${lastWeek[1]}</div>
                <div class="metric-label">Total Clicks (Last Wk)</div>
            </div>
            <div class="metric-box">
                <div class="metric-value" style="color: ${growth > 0 ? 'green' : 'red'}">${growth.toFixed(1)}%</div>
                <div class="metric-label">WoW Growth</div>
            </div>
            <div class="metric-box">
                <div class="metric-value">${lastWeek[2].toFixed(1)}%</div>
                <div class="metric-label">Our Share</div>
            </div>
        `;
        document.getElementById('global_metrics').innerHTML = html;
    }

    // --- CHART 2: BRAND COMPETITIVENESS ---
    function drawBrandCompetitiveness() {
        // Calculate Top Brands by Avg Share
        const brandShares = {};
        marketData.forEach(d => {
            const b = getBrand(d);
            if (!brandShares[b]) brandShares[b] = 0;
            brandShares[b] += d.click_share;
        });
        
        const topBrands = Object.keys(brandShares)
            .filter(b => b !== ourBrand)
            .sort((a, b) => brandShares[b] - brandShares[a])
            .slice(0, 3); // Top 3 Competitors

        const header = ['Week', ourBrand, ...topBrands, 'Others'];
        const rows = sortedWeeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            
            const getShare = (brand) => {
                return weekData
                    .filter(d => getBrand(d) === brand)
                    .reduce((acc, cur) => acc + cur.click_share, 0);
            };

            const ourVal = getShare(ourBrand);
            const compVals = topBrands.map(b => getShare(b));
            
            // Others
            const trackedShare = ourVal + compVals.reduce((a,c)=>a+c,0);
            const totalShareInWeek = weekData.reduce((a,c)=>a+c.click_share,0);
            const otherVal = Math.max(0, totalShareInWeek - trackedShare);

            return [week.substring(5), ourVal, ...compVals, otherVal];
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#2563EB', '#EF4444', '#F59E0B', '#10B981', '#94A3B8'],
            chartArea: {width: '85%', height: '75%'},
            vAxis: { title: 'Share %' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    // --- CHART 3: LEVERS ---
    function drawLevers() {
        // Logic: Compare Avg Share when Deal=0 vs Deal>0 for US
        const ourData = marketData.filter(d => d.is_yaba_asin === 'Y');
        
        const noDealData = ourData.filter(d => d.weekly_number_of_days_with_deal === 0);
        const dealData = ourData.filter(d => d.weekly_number_of_days_with_deal > 0);

        const avgShareNoDeal = noDealData.reduce((a,b)=>a+b.click_share,0) / (noDealData.length || 1);
        const avgShareDeal = dealData.reduce((a,b)=>a+b.click_share,0) / (dealData.length || 1);

        const data = google.visualization.arrayToDataTable([
            ['State', 'Avg Click Share', { role: 'style' }],
            ['Regular Price', avgShareNoDeal, '#94A3B8'],
            ['With Deal', avgShareDeal, '#2563EB']
        ]);

        const options = {
            legend: { position: "none" },
            vAxis: { minValue: 0 },
            chartArea: {width: '70%', height: '80%'}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);

        const uplift = ((avgShareDeal - avgShareNoDeal) / avgShareNoDeal * 100).toFixed(1);
        document.getElementById('levers_text').innerHTML = `
            Running Deals provides a <b class="${uplift > 0 ? 'positive' : 'negative'}">${uplift}% uplift</b> in Click Share for our ASINs.
        `;
    }

    // --- CHART 4: EFFICIENCY ---
    function drawEfficiency() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({'type': 'string', 'role': 'style'}); // Color
        data.addColumn({'type': 'string', 'role': 'tooltip'});

        const rows = marketData.map(d => {
            const isUs = d.is_yaba_asin === 'Y';
            const color = isUs ? 'point { fill-color: #2563EB; size: 6; }' : 'point { fill-color: #CBD5E1; size: 3; }';
            const tooltip = `${getBrand(d)}: Rank ${d.average_organic_rank}, Share ${d.click_share}%`;
            return [d.average_organic_rank, d.click_share, color, tooltip];
        });

        data.addRows(rows);

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 },
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: {width: '85%', height: '80%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- 5. INSIGHTS GENERATOR ---
    function generateInsights() {
        // Data prep
        const ourRows = marketData.filter(d => d.is_yaba_asin === 'Y');
        const lastWeek = sortedWeeks[sortedWeeks.length - 1];
        const lastWeekRows = ourRows.filter(d => d.week_date === lastWeek);
        const lastWeekShare = lastWeekRows.reduce((a,b)=>a+b.click_share, 0);
        
        const prevWeek = sortedWeeks[sortedWeeks.length - 2];
        const prevWeekRows = ourRows.filter(d => d.week_date === prevWeek);
        const prevWeekShare = prevWeekRows.reduce((a,b)=>a+b.click_share, 0);

        const insights = [];
        const recs = [];

        // Insight 1: Trend
        if (lastWeekShare > prevWeekShare) {
            insights.push(`<b>Momentum:</b> ${ourBrand} gained <span class="positive">+${(lastWeekShare-prevWeekShare).toFixed(1)}%</span> share in the last week.`);
        } else {
            insights.push(`<b>Risk:</b> ${ourBrand} lost <span class="negative">${(lastWeekShare-prevWeekShare).toFixed(1)}%</span> share recently.`);
        }

        // Insight 2: Deals
        const dealsActive = lastWeekRows.some(d => d.weekly_number_of_days_with_deal > 0);
        if (dealsActive) {
            insights.push(`<b>Promo Strategy:</b> Deals were active last week. Check ROI efficiency.`);
        } else {
            insights.push(`<b>Promo Opportunity:</b> No deals active last week.`);
        }

        // Insight 3: Price
        const avgPriceUs = lastWeekRows.reduce((a,b)=>a+b.price,0)/lastWeekRows.length;
        insights.push(`<b>Pricing:</b> Average price point is currently $${avgPriceUs.toFixed(2)}.`);

        // Recommendations
        if (lastWeekShare < prevWeekShare) recs.push(`Investigate competitor price drops in week ${lastWeek}.`);
        recs.push(`Prioritize maintaining Organic Rank < 5 to maximize efficiency quadrant.`);
        if (!dealsActive) recs.push(`Consider a flash sale to regain share momentum.`);

        // Render
        document.getElementById('insights_list').innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        document.getElementById('recommendations_list').innerHTML = recs.map(i => `<li>${i}</li>`).join('');
        
        // Other Insights
        document.getElementById('other_insights_list').innerHTML = `
            <li>Competitor 'Sony' shows high rank resilience despite higher price points.</li>
            <li>Market volume appears to be stabilizing after a peak in week 2.</li>
        `;
    }

    // --- 6. INTERACTIVE COMPARATOR ---
    function updateComparator() {
        const week = document.getElementById('comp_week_select').value;
        const compBrand = document.getElementById('comp_brand_select').value;

        // Get Data
        const weekData = marketData.filter(d => d.week_date === week);
        const usData = weekData.filter(d => d.is_yaba_asin === 'Y');
        const compData = weekData.filter(d => getBrand(d) === compBrand);

        // Aggregates
        const avgPriceUs = usData.length ? usData.reduce((a,b)=>a+b.price,0)/usData.length : 0;
        const avgPriceComp = compData.length ? compData.reduce((a,b)=>a+b.price,0)/compData.length : 0;
        
        const shareUs = usData.reduce((a,b)=>a+b.click_share,0);
        const shareComp = compData.reduce((a,b)=>a+b.click_share,0);

        // Update Metrics
        const priceDiff = avgPriceUs - avgPriceComp;
        const shareGap = shareUs - shareComp;

        const priceEl = document.getElementById('comp_price_diff');
        priceEl.innerText = `$${Math.abs(priceDiff).toFixed(2)} ${priceDiff > 0 ? 'More Expensive' : 'Cheaper'}`;
        priceEl.style.color = priceDiff > 0 ? '#EF4444' : '#10B981';

        const shareEl = document.getElementById('comp_share_gap');
        shareEl.innerText = `${Math.abs(shareGap).toFixed(1)}% ${shareGap > 0 ? 'Lead' : 'Behind'}`;
        shareEl.style.color = shareGap > 0 ? '#10B981' : '#EF4444';

        // Draw Table
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Metric');
        data.addColumn('string', ourBrand);
        data.addColumn('string', compBrand);

        data.addRows([
            ['Price', `$${avgPriceUs.toFixed(2)}`, `$${avgPriceComp.toFixed(2)}`],
            ['Click Share', `${shareUs.toFixed(1)}%`, `${shareComp.toFixed(1)}%`],
            ['Best Rank', `${Math.min(...usData.map(d=>d.average_organic_rank))}`, `${Math.min(...compData.map(d=>d.average_organic_rank))}`],
            ['Deal Days', `${Math.max(...usData.map(d=>d.weekly_number_of_days_with_deal))}`, `${Math.max(...compData.map(d=>d.weekly_number_of_days_with_deal))}`]
        ]);

        const table = new google.visualization.Table(document.getElementById('table_comparator'));
        table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
    }

    // UI Logic
    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.getElementById('tab-' + tabId).classList.remove('hidden');

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        // Redraw interactive if needed
        if(tabId === 'interactive') updateComparator();
    }

</script>

</body>
</html>