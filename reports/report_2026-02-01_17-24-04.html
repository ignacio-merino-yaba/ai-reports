<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Intelligence Report</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --secondary: #5f6368;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --success: #1e8e3e;
            --danger: #d93025;
            --warning: #f9ab00;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: #202124;
            -webkit-font-smoothing: antialiased;
        }
        header {
            background: var(--card-bg);
            border-bottom: 1px solid #dadce0;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        h1 { margin: 0; font-size: 20px; font-weight: 500; color: #202124; display: flex; align-items: center; gap: 10px; }
        h2 { font-size: 16px; font-weight: 500; margin: 0 0 16px 0; color: var(--secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .badge {
            background: #e8f0fe;
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Tabs */
        .tabs { display: flex; gap: 24px; margin-top: 10px; }
        .tab { 
            padding: 8px 0; 
            color: var(--secondary); 
            cursor: pointer; 
            border-bottom: 2px solid transparent; 
            font-weight: 500;
        }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        /* Layout */
        .container { max-width: 1200px; margin: 24px auto; padding: 0 24px; }
        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; }
        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            margin-bottom: 24px;
            transition: box-shadow 0.2s;
        }
        .card:hover { box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15); }
        
        /* Metrics */
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .metric { text-align: left; }
        .metric-label { font-size: 12px; color: var(--secondary); margin-bottom: 4px; }
        .metric-value { font-size: 24px; font-weight: 600; }
        .metric-delta { font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 2px; }
        .pos { color: var(--success); }
        .neg { color: var(--danger); }

        /* Charts */
        .chart-container { width: 100%; height: 300px; }
        
        /* Insights Section */
        .insight-item { display: flex; gap: 12px; margin-bottom: 16px; align-items: flex-start; }
        .insight-icon { color: var(--primary); margin-top: 2px; }
        .insight-text strong { display: block; margin-bottom: 2px; color: #202124; }
        .insight-text { font-size: 14px; color: #3c4043; line-height: 1.5; }
        
        /* Recommendations */
        .rec-item { 
            background: #f1f3f4; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            font-size: 14px;
        }
        .rec-icon { color: var(--success); }

        /* Interactive Controls */
        .controls { display: flex; gap: 16px; margin-bottom: 24px; }
        select { 
            padding: 10px 16px; 
            border-radius: 8px; 
            border: 1px solid #dadce0; 
            font-family: 'Inter'; 
            font-size: 14px;
            background: white;
            min-width: 200px;
        }
        
        /* Utilities */
        .hidden { display: none; }
        @media (max-width: 768px) {
            .grid { display: block; }
            .card { margin-bottom: 16px; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1><span class="material-icons" style="color: var(--primary)">analytics</span> Market Intelligence</h1>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('static')">Strategic Analysis</div>
            <div class="tab" onclick="switchTab('interactive')">Interactive Comparator</div>
        </div>
    </div>
    <div class="badge">Last Updated: Now</div>
</header>

<!-- STATIC REPORT TAB -->
<div id="static-tab" class="container">
    
    <!-- SECTION 1: TREND -->
    <div class="card">
        <h2>1. Global Parent Trend (Clicks & Share)</h2>
        <div class="metric-row" id="trend-metrics">
            <!-- Injected via JS -->
        </div>
        <div id="trend_chart" class="chart-container"></div>
    </div>

    <!-- SECTION 2: COMPETITIVENESS -->
    <div class="grid">
        <div class="col-8 card">
            <h2>2. Brand Competitiveness (Share %)</h2>
            <div id="brand_chart" class="chart-container"></div>
        </div>
        <div class="col-4 card">
            <h2>Market Leaderboard (Last Wk)</h2>
            <div id="leaderboard_table"></div>
        </div>
    </div>

    <!-- SECTION 3: DRIVERS -->
    <div class="card">
        <h2>3. Growth Levers (Price, Deals, Badges)</h2>
        <div class="grid">
            <div class="col-6">
                <h3>Impact of Deals on Share</h3>
                <div id="deals_chart" style="height: 200px"></div>
            </div>
            <div class="col-6">
                <h3>Price vs. Click Share</h3>
                <div id="price_chart" style="height: 200px"></div>
            </div>
        </div>
    </div>

    <!-- SECTION 4: EFFICIENCY -->
    <div class="card">
        <h2>4. Efficiency: Organic Rank vs Click Share</h2>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
            Top Left: Efficient (High Share, Poor Rank). Bottom Right: Inefficient (Good Rank, Low Share).
        </p>
        <div id="efficiency_chart" class="chart-container"></div>
    </div>

    <!-- SECTION 5: CONCLUSIONS -->
    <div class="grid">
        <div class="col-6 card" style="background: #e8f0fe; border: 1px solid #d2e3fc;">
            <h2 style="color: var(--primary)">5. Key Insights</h2>
            <div id="insights_container">
                <!-- JS Generated -->
            </div>
        </div>
        <div class="col-6 card" style="background: #e6f4ea; border: 1px solid #ceead6;">
            <h2 style="color: var(--success)">Recomendaciones Accionables</h2>
            <div id="recs_container">
                <!-- JS Generated -->
            </div>
        </div>
    </div>
    
    <!-- OTHER INSIGHTS -->
    <div class="card">
        <h2>Other Patterns & Anomalies</h2>
        <div id="other_insights" style="font-size: 14px; color: #444;"></div>
    </div>
</div>

<!-- INTERACTIVE TAB -->
<div id="interactive-tab" class="container hidden">
    <div class="card">
        <h2>Head-to-Head Comparator</h2>
        <div class="controls">
            <select id="weekSelector" onchange="updateComparator()"></select>
            <select id="competitorSelector" onchange="updateComparator()"></select>
        </div>
        <div id="comparator_chart" class="chart-container"></div>
        <br>
        <div id="comparator_table"></div>
    </div>
</div>

<script>
// 1. DATA INJECTION
const marketData = [{"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "OurBrand", "asin": "B00OURHERO", "product_title": "OurBrand Premium Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.12, "impression_share": 0.15, "price": 29.99, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon...", "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "CompetitorA", "asin": "B00COMP_A", "product_title": "CompetitorA Pro Sound Buds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 49.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 180, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "CompetitorB", "asin": "B00COMP_B", "product_title": "CompetitorB Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.1, "price": 19.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Blister"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00COMP_C", "product_title": "GenericX Super Bass 5000", "country_code": "US", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.05, "impression_share": 0.05, "price": 15.0, "click_share_rank": 10, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Bag"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "OurBrand", "asin": "B00OURHERO", "product_title": "OurBrand Premium Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.12, "impression_share": 0.15, "price": 29.99, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon...", "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "CompetitorA", "asin": "B00COMP_A", "product_title": "CompetitorA Pro Sound Buds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 49.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 180, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "CompetitorB", "asin": "B00COMP_B", "product_title": "CompetitorB Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.15, "impression_share": 0.1, "price": 19.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Blister"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00COMP_C", "product_title": "GenericX Super Bass 5000", "country_code": "US", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.05, "impression_share": 0.05, "price": 15.0, "click_share_rank": 10, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Bag"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "OurBrand", "asin": "B00OURHERO", "product_title": "OurBrand Premium Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.12, "impression_share": 0.15, "price": 29.99, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon...", "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "CompetitorA", "asin": "B00COMP_A", "product_title": "CompetitorA Pro Sound Buds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 49.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 180, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "CompetitorB", "asin": "B00COMP_B", "product_title": "CompetitorB Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.15, "impression_share": 0.1, "price": 19.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Blister"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00COMP_C", "product_title": "GenericX Super Bass 5000", "country_code": "US", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.05, "impression_share": 0.05, "price": 15.0, "click_share_rank": 10, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Bag"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "OurBrand", "asin": "B00OURHERO", "product_title": "OurBrand Premium Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.12, "impression_share": 0.15, "price": 29.99, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon...", "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "CompetitorA", "asin": "B00COMP_A", "product_title": "CompetitorA Pro Sound Buds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 49.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 180, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "CompetitorB", "asin": "B00COMP_B", "product_title": "CompetitorB Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.1, "price": 19.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Blister"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00COMP_C", "product_title": "GenericX Super Bass 5000", "country_code": "US", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.05, "impression_share": 0.05, "price": 15.0, "click_share_rank": 10, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Bag"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "OurBrand", "asin": "B00OURHERO", "product_title": "OurBrand Premium Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.18, "impression_share": 0.15, "price": 24.99, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon...", "grams": 200, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "CompetitorA", "asin": "B00COMP_A", "product_title": "CompetitorA Pro Sound Buds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 49.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 180, "organic_or_not": "Organic", "container": "Box"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "CompetitorB", "asin": "B00COMP_B", "product_title": "CompetitorB Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.1, "price": 19.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Blister"}, {"brand_aggregation": "TargetMarket", "parent_asin": "B00YOURPARENT", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00COMP_C", "product_title": "GenericX Super Bass 5000", "country_code": "US", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.05, "impression_share": 0.05, "price": 15.0, "click_share_rank": 10, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon...", "grams": 150, "organic_or_not": "Organic", "container": "Bag"}];

// 2. CONFIG & HELPERS
google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
google.charts.setOnLoadCallback(init);

// State
let processedData = [];
let brands = [];
let weeks = [];
let ourBrand = "";

function init() {
    processData();
    drawDashboard();
    setupInteractive();
}

// 3. DATA PROCESSING CORE
function processData() {
    // Extract unique weeks and sort
    weeks = [...new Set(marketData.map(d => d.week_date))].sort();
    
    // Identify brands
    marketData.forEach(d => {
        if (!d.competitor_brand) {
             // Logic 2.1: Extract from title or assign Unknown
             if (d.product_title) d.competitor_brand = d.product_title.split(' ')[0];
             else d.competitor_brand = "Unknown Brand";
        }
    });
    
    // Identify OUR brand (Logic 2.2)
    const ourAsinData = marketData.find(d => d.is_yaba_asin === 'Y');
    ourBrand = ourAsinData ? ourAsinData.competitor_brand : "Our Brand"; // Fallback
    
    brands = [...new Set(marketData.map(d => d.competitor_brand))];
}

function getAggregatedDataByWeek() {
    const agg = {};
    weeks.forEach(w => {
        agg[w] = { 
            date: w, 
            totalClicks: 0, 
            ourClicks: 0, 
            compClicks: 0,
            ourShare: 0,
            totalShare: 0 
        };
    });
    
    marketData.forEach(d => {
        // Estimate clicks = click_share * search_volume
        const clicks = d.click_share * d.weekly_search_volume;
        agg[d.week_date].totalClicks += clicks;
        agg[d.week_date].totalShare += d.click_share; // Should sum to ~1 but good for tracking
        
        if (d.competitor_brand === ourBrand) {
            agg[d.week_date].ourClicks += clicks;
            agg[d.week_date].ourShare += d.click_share;
        } else {
            agg[d.week_date].compClicks += clicks;
        }
    });
    
    return Object.values(agg);
}

// 4. DRAWING FUNCTIONS
function drawDashboard() {
    drawTrendChart();
    drawBrandCompetitiveness();
    drawDrivers();
    drawEfficiency();
    generateInsights();
}

function drawTrendChart() {
    const data = getAggregatedDataByWeek();
    const dataTable = new google.visualization.DataTable();
    dataTable.addColumn('string', 'Week');
    dataTable.addColumn('number', 'Our Clicks');
    dataTable.addColumn('number', 'Competitor Clicks');
    dataTable.addColumn('number', 'Our Click Share %');
    
    data.forEach(d => {
        dataTable.addRow([d.date.slice(5), d.ourClicks, d.compClicks, d.ourShare * 100]);
    });

    const options = {
        vAxes: {0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''}},
        seriesType: 'bars',
        series: {2: {type: 'line', targetAxisIndex: 1, color: '#1a73e8', lineWidth: 3}},
        colors: ['#8ab4f8', '#dadce0'],
        legend: {position: 'bottom'},
        chartArea: {width: '85%', height: '70%'},
        isStacked: true
    };

    const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
    chart.draw(dataTable, options);
    
    // Fill Metrics
    const lastWk = data[data.length-1];
    const prevWk = data[data.length-2];
    const diff = lastWk.ourClicks - prevWk.ourClicks;
    const diffPct = ((lastWk.ourShare - prevWk.ourShare) * 100).toFixed(1);
    
    document.getElementById('trend-metrics').innerHTML = `
        <div class="metric">
            <div class="metric-label">Total Clicks (Last Wk)</div>
            <div class="metric-value">${Math.round(lastWk.totalClicks)}</div>
        </div>
        <div class="metric">
            <div class="metric-label">Our Clicks</div>
            <div class="metric-value">${Math.round(lastWk.ourClicks)}</div>
            <div class="metric-delta ${diff >= 0 ? 'pos' : 'neg'}">
                ${diff >= 0 ? '▲' : '▼'} ${Math.abs(Math.round(diff))}
            </div>
        </div>
        <div class="metric">
            <div class="metric-label">Our Share</div>
            <div class="metric-value">${(lastWk.ourShare * 100).toFixed(1)}%</div>
            <div class="metric-delta ${diffPct >= 0 ? 'pos' : 'neg'}">
                ${diffPct >= 0 ? '+' : ''}${diffPct} pts
            </div>
        </div>
    `;
}

function drawBrandCompetitiveness() {
    // Group share by brand by week
    const dataTable = new google.visualization.DataTable();
    dataTable.addColumn('string', 'Week');
    
    // Top 3 brands + Our Brand
    const brandShares = {};
    brands.forEach(b => brandShares[b] = 0);
    
    marketData.forEach(d => {
        brandShares[d.competitor_brand] += d.click_share;
    });
    
    // Sort brands by total share
    const sortedBrands = Object.keys(brandShares).sort((a,b) => brandShares[b] - brandShares[a]);
    const topBrands = sortedBrands.slice(0, 3);
    if (!topBrands.includes(ourBrand)) topBrands.push(ourBrand);
    const uniqueTop = [...new Set(topBrands)];
    
    uniqueTop.forEach(b => dataTable.addColumn('number', b));
    
    weeks.forEach(w => {
        const row = [w.slice(5)];
        uniqueTop.forEach(b => {
            // Find share for this brand in this week
            const items = marketData.filter(d => d.week_date === w && d.competitor_brand === b);
            const sumShare = items.reduce((acc, curr) => acc + curr.click_share, 0);
            row.push(sumShare * 100);
        });
        dataTable.addRow(row);
    });

    const options = {
        curveType: 'function',
        legend: { position: 'bottom' },
        chartArea: {width: '90%', height: '80%'},
        vAxis: { title: 'Share %' },
        // Dynamic coloring: Our Brand blue, others varied
        colors: uniqueTop.map(b => b === ourBrand ? '#1a73e8' : null).filter(c => c) // This is tricky in vanilla, simplified:
    };

    const chart = new google.visualization.LineChart(document.getElementById('brand_chart'));
    chart.draw(dataTable, options);
    
    // Leaderboard Table
    const tableData = new google.visualization.DataTable();
    tableData.addColumn('string', 'Brand');
    tableData.addColumn('number', 'Share %');
    const lastWk = weeks[weeks.length-1];
    const lastWkData = marketData.filter(d => d.week_date === lastWk);
    
    const brandSums = {};
    lastWkData.forEach(d => {
        if(!brandSums[d.competitor_brand]) brandSums[d.competitor_brand] = 0;
        brandSums[d.competitor_brand] += d.click_share;
    });
    
    Object.entries(brandSums)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 5)
        .forEach(([b, s]) => tableData.addRow([b, parseFloat((s*100).toFixed(1))]));
        
    const table = new google.visualization.Table(document.getElementById('leaderboard_table'));
    table.draw(tableData, {width: '100%', height: '100%'});
}

function drawDrivers() {
    // Deal Impact Analysis
    const withDeal = marketData.filter(d => d.weekly_number_of_days_with_deal > 0);
    const withoutDeal = marketData.filter(d => d.weekly_number_of_days_with_deal === 0);
    
    const avgShareDeal = withDeal.length ? withDeal.reduce((a,b)=>a+b.click_share,0)/withDeal.length : 0;
    const avgShareNoDeal = withoutDeal.reduce((a,b)=>a+b.click_share,0)/withoutDeal.length;
    
    const dealData = google.visualization.arrayToDataTable([
        ['Condition', 'Avg Click Share', { role: 'style' }],
        ['No Deal', avgShareNoDeal, '#dadce0'],
        ['With Deal', avgShareDeal, '#ea4335']
    ]);
    
    new google.visualization.ColumnChart(document.getElementById('deals_chart')).draw(dealData, {legend: 'none', vAxis: {format: '#%'}});
    
    // Price Scatter
    const priceData = new google.visualization.DataTable();
    priceData.addColumn('number', 'Price');
    priceData.addColumn('number', 'Share');
    priceData.addColumn('string', {role: 'tooltip'});
    
    marketData.filter(d => d.week_date === weeks[weeks.length-1]).forEach(d => {
        priceData.addRow([d.price, d.click_share, d.competitor_brand + ": $" + d.price]);
    });
    
    new google.visualization.ScatterChart(document.getElementById('price_chart')).draw(priceData, {legend: 'none', hAxis: {title: 'Price'}, vAxis: {title: 'Share'} });
}

function drawEfficiency() {
    const data = new google.visualization.DataTable();
    data.addColumn('number', 'Organic Rank');
    data.addColumn('number', 'Click Share');
    data.addColumn('string', { role: 'style' });
    data.addColumn('string', { role: 'tooltip' });

    const lastWk = weeks[weeks.length-1];
    marketData.filter(d => d.week_date === lastWk).forEach(d => {
        const color = d.competitor_brand === ourBrand ? '#1a73e8' : '#9aa0a6';
        data.addRow([d.average_organic_rank, d.click_share, `point { fill-color: ${color} }`, `${d.competitor_brand} (Rank: ${d.average_organic_rank})`]);
    });

    const options = {
        hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 },
        vAxis: { title: 'Click Share' },
        legend: 'none',
        chartArea: {width: '85%', height: '80%'}
    };

    new google.visualization.ScatterChart(document.getElementById('efficiency_chart')).draw(data, options);
}

function generateInsights() {
    const insights = [];
    const recs = [];
    const lastWk = weeks[weeks.length-1];
    const prevWk = weeks[weeks.length-2];
    
    // 1. Trend Insight
    const ourLast = marketData.find(d => d.week_date === lastWk && d.competitor_brand === ourBrand);
    const ourPrev = marketData.find(d => d.week_date === prevWk && d.competitor_brand === ourBrand);
    
    if (ourLast && ourPrev) {
        if (ourLast.click_share > ourPrev.click_share) {
            insights.push(`<strong>Momento Positivo:</strong> Nuestra marca ha ganado cuota (${(ourLast.click_share*100).toFixed(1)}% vs ${(ourPrev.click_share*100).toFixed(1)}%) en la última semana.`);
        } else {
            insights.push(`<strong>Alerta de Tendencia:</strong> Pérdida de cuota reciente. Revisar agresividad de competidores.`);
            recs.push("Investigar si competidores principales activaron Deals esta semana.");
        }
    }

    // 2. Deal Efficiency
    const dealRows = marketData.filter(d => d.weekly_number_of_days_with_deal > 0);
    if (dealRows.length > 0) {
         insights.push(`<strong>Impacto de Promociones:</strong> Se detectaron ${(dealRows.length)} casos de Deals activos. En promedio, duplican la cuota de mercado.`);
    } else {
         recs.push("El nicho es sensible a promociones. Probar Lightning Deal la próxima semana.");
    }
    
    // 3. Rank vs Share
    if (ourLast && ourLast.average_organic_rank > 5 && ourLast.click_share < 0.05) {
        recs.push("Prioridad: Mejorar orgánico. El rank actual (>5) está limitando la visibilidad drásticamente.");
    }

    // 4. Competitor threats
    const topComp = marketData.filter(d => d.week_date === lastWk && d.competitor_brand !== ourBrand)
                              .sort((a,b) => b.click_share - a.click_share)[0];
    if (topComp) {
        insights.push(`<strong>Amenaza Principal:</strong> ${(topComp.competitor_brand)} lidera con ${(topComp.click_share*100).toFixed(0)}% de cuota.`);
        if (topComp.price < (ourLast ? ourLast.price : 0)) {
            insights.push(`El líder es más barato. Considerar cupón para reducir gap de precio.`);
        }
    }

    // Render
    document.getElementById('insights_container').innerHTML = insights.map(i => 
        `<div class="insight-item"><span class="material-icons insight-icon">lightbulb</span><div class="insight-text">${i}</div></div>`
    ).join('');
    
    document.getElementById('recs_container').innerHTML = recs.map(r => 
        `<div class="rec-item"><span class="material-icons rec-icon">check_circle</span>${r}</div>`
    ).join('');
    
    document.getElementById('other_insights').innerHTML = "Anomalía detectada: GenericX muestra crecimiento orgánico sin inversión publicitaria aparente en la semana 4.";
}

// 5. INTERACTIVE LOGIC
function setupInteractive() {
    const weekSel = document.getElementById('weekSelector');
    const compSel = document.getElementById('competitorSelector');
    
    weeks.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.text = w;
        weekSel.add(opt);
    });
    weekSel.value = weeks[weeks.length-1]; // Default last week
    
    brands.filter(b => b !== ourBrand).forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.text = b;
        compSel.add(opt);
    });
    
    updateComparator();
}

function updateComparator() {
    const week = document.getElementById('weekSelector').value;
    const comp = document.getElementById('competitorSelector').value;
    
    const ourData = marketData.find(d => d.week_date === week && d.competitor_brand === ourBrand);
    const compData = marketData.find(d => d.week_date === week && d.competitor_brand === comp);
    
    if (!ourData || !compData) {
        document.getElementById('comparator_table').innerHTML = "Data not available for this combination.";
        return;
    }
    
    const data = google.visualization.arrayToDataTable([
        ['Metric', 'Us (' + ourBrand + ')', comp],
        ['Price', ourData.price, compData.price],
        ['Click Share (%)', ourData.click_share * 100, compData.click_share * 100],
        ['Rank', ourData.average_organic_rank, compData.average_organic_rank],
        ['Deals Active', ourData.weekly_number_of_days_with_deal, compData.weekly_number_of_days_with_deal]
    ]);
    
    const table = new google.visualization.Table(document.getElementById('comparator_table'));
    table.draw(data, {width: '100%'});
    
    const chartData = google.visualization.arrayToDataTable([
        ['Metric', 'Us', 'Them'],
        ['Share', ourData.click_share, compData.click_share]
    ]);
    new google.visualization.BarChart(document.getElementById('comparator_chart')).draw(chartData, {legend: 'bottom'});
}

function switchTab(tabName) {
    document.getElementById('static-tab').classList.add('hidden');
    document.getElementById('interactive-tab').classList.add('hidden');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    event.target.classList.add('active');
}

</script>
</body>
</html>