<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence Report: Vitamin D3</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Internal Styles (Google Native Compatible - No External CSS Frameworks) -->
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #34A853; /* Google Green */
            --danger: #EA4335; /* Google Red */
            --warning: #FBBC05; /* Google Yellow */
            --bg: #F8F9FA;
            --surface: #FFFFFF;
            --text-main: #202124;
            --text-sub: #5F6368;
            --border: #DADCE0;
            --radius: 16px;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Google Sans', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 400;
            color: var(--text-main);
            margin: 0;
        }

        .header .badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-sub);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards */
        .grid-kpi {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .card h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card .value {
            font-size: 28px;
            font-weight: 400;
            color: var(--text-main);
        }

        .card .trend {
            font-size: 14px;
            display: flex;
            align-items: center;
            margin-top: 8px;
        }

        .trend.up { color: var(--secondary); }
        .trend.down { color: var(--danger); }
        .trend.neutral { color: var(--text-sub); }

        /* Sections */
        .section-title {
            font-size: 18px;
            margin: 32px 0 16px 0;
            color: var(--text-main);
            border-left: 4px solid var(--primary);
            padding-left: 12px;
        }

        .chart-container {
            height: 400px;
            width: 100%;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .two-col { grid-template-columns: 1fr; }
        }

        /* Insights List */
        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            margin-bottom: 12px;
            padding-left: 28px;
            position: relative;
        }

        .insights-list li::before {
            content: 'insight_bulb';
            font-family: 'Material Icons';
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--warning);
            font-size: 20px;
        }

        .recommendation-list li::before {
            content: 'check_circle';
            color: var(--secondary);
        }

        /* Interactive Controls */
        .controls {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
        }

        select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        /* Utilities */
        .hidden { display: none; }
        .text-blue { color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Market Intelligence: <span id="parentName">Loading...</span></h1>
            <div style="font-size: 14px; color: var(--text-sub); margin-top: 4px;">An√°lisis de Rendimiento - √öltimas 4 Semanas</div>
        </div>
        <div class="badge">CONFIDENTIAL</div>
    </div>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: REPORT -->
    <div id="tab-static">
        <!-- KPIs -->
        <div class="grid-kpi">
            <div class="card">
                <h3>Total Clicks (Mercado)</h3>
                <div class="value" id="kpi-clicks">-</div>
                <div class="trend" id="kpi-clicks-trend"></div>
            </div>
            <div class="card">
                <h3>Nuestra Cuota (Share)</h3>
                <div class="value" id="kpi-share">-</div>
                <div class="trend" id="kpi-share-trend"></div>
            </div>
            <div class="card">
                <h3>Precio Promedio (Nosotros)</h3>
                <div class="value" id="kpi-price">-</div>
                <div class="trend" id="kpi-price-trend"></div>
            </div>
            <div class="card">
                <h3>Eficiencia (Rank Promedio)</h3>
                <div class="value" id="kpi-rank">-</div>
                <div class="trend neutral">Target: Top 5</div>
            </div>
        </div>

        <!-- Section 1: Tendencia Global -->
        <div class="card">
            <h2 class="section-title" style="margin-top:0;">1. Tendencia Global del Parent</h2>
            <div id="chart_trend" class="chart-container"></div>
            <div class="insights-text" style="padding: 16px; background: #f1f3f4; border-radius: 8px; margin-top: 16px;">
                <strong>An√°lisis:</strong> El mercado ha experimentado una fuerte expansi√≥n en las √∫ltimas 2 semanas (Semanas 02-03), duplicando el volumen de clicks respecto al inicio del periodo. Nuestra marca (Incite Nutrition) ha capitalizado este crecimiento, recuperando cuota de mercado tras una ca√≠da en la Semana 01 y estabiliz√°ndose por encima del 11% de Share.
            </div>
        </div>

        <!-- Section 2: Competitividad -->
        <div class="two-col" style="margin-top: 24px;">
            <div class="card">
                <h2 class="section-title" style="margin-top:0;">2. Competitividad de Marca</h2>
                <div id="chart_brand_share" class="chart-container"></div>
            </div>
            <div class="card">
                <h2 class="section-title" style="margin-top:0;">3. Organic Rank vs Share (Eficiencia)</h2>
                <div id="chart_scatter" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 3: Palancas -->
        <div class="card" style="margin-top: 24px;">
            <h2 class="section-title" style="margin-top:0;">4. Palancas de Crecimiento (Precio & Promociones)</h2>
            <div id="table_levers" style="width: 100%;"></div>
        </div>

        <!-- Conclusions -->
        <div class="two-col" style="margin-top: 24px;">
            <div class="card">
                <h2 class="section-title" style="margin-top:0;">üí° Insights Clave</h2>
                <ul class="insights-list">
                    <li><strong>Dominio de WeightWorld:</strong> Competidor l√≠der consolidado, manteniendo alta visibilidad a pesar de no tener el precio m√°s bajo.</li>
                    <li><strong>Recuperaci√≥n de Incite Nutrition:</strong> Tras la semana 01, la estrategia de precios/deals (activaci√≥n de Deals en sem 02-03) correlaciona directamente con la recuperaci√≥n de Share.</li>
                    <li><strong>Elasticidad de Precio:</strong> Nutrition Geeks gana cuota agresivamente con precios bajos en packings grandes, presionando el segmento de "valor".</li>
                    <li><strong>Efectividad de Deals:</strong> Nuestros ASINs mostraron el mejor rendimiento (Share > 12%) en la semana con 6-7 d√≠as de Deals activos.</li>
                    <li><strong>Riesgo de Visibilidad:</strong> ASINs sin badge de "Deal" o "Coupon" pierden r√°pidamente posici√≥n org√°nica frente a competidores agresivos como Vita Premium.</li>
                </ul>
            </div>
            <div class="card">
                <h2 class="section-title" style="margin-top:0;">üöÄ Recomendaciones Accionables</h2>
                <ul class="insights-list recommendation-list">
                    <li><strong>Mantener Presi√≥n Promocional:</strong> Dado el √©xito de las Semanas 02-03, mantener una cadencia de Deals activa para sostener el Rank org√°nico top 3.</li>
                    <li><strong>Defensa vs Nutrition Geeks:</strong> Evaluar un cup√≥n agresivo en la variante principal para contrarrestar su estrategia de precio bajo sin bajar el PVP permanentemente.</li>
                    <li><strong>Optimizaci√≥n de T√≠tulo/SEO:</strong> Revisar keywords donde "Vita Premium" nos supera org√°nicamente para asegurar relevancia en b√∫squedas de "High Strength".</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <label>Comparar Semana:
                <select id="select-week" onchange="updateInteractive()">
                    <!-- Populated by JS -->
                </select>
            </label>
            <label>Vs Competidor:
                <select id="select-comp" onchange="updateInteractive()">
                    <!-- Populated by JS -->
                </select>
            </label>
        </div>

        <div class="two-col">
            <div class="card">
                <h3>Cara a Cara: M√©tricas Clave</h3>
                <div id="table_comparison" style="margin-top: 16px;"></div>
            </div>
            <div class="card">
                <h3>Distribuci√≥n de Share (Semana Seleccionada)</h3>
                <div id="chart_pie_share" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script type="text/javascript">
    // DATA INJECTION
    const marketData = [{"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B072L235Z5", "real_brand": "Vita Premium", "is_yaba_asin": "N", "product_title": "Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "average_organic_rank": 4, "price": 8.025714286, "click_share": 5.32, "estimated_clicks": 1067.422888, "weekly_number_of_days_with_deal": 5, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B072L235Z5", "real_brand": "Vita Premium", "is_yaba_asin": "N", "product_title": "Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "average_organic_rank": 4, "price": 7.64, "click_share": 6.44, "estimated_clicks": 629.042456, "weekly_number_of_days_with_deal": 4, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B072L235Z5", "real_brand": "Vita Premium", "is_yaba_asin": "N", "product_title": "Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "average_organic_rank": 4, "price": 8.604285714, "click_share": 6.82, "estimated_clicks": 820.574216, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B072L235Z5", "real_brand": "Vita Premium", "is_yaba_asin": "N", "product_title": "Vitamin D 4,000 IU Softgels, Maximum Strength Vita...", "average_organic_rank": 6, "price": 8.99, "click_share": 3.77, "estimated_clicks": 773.433596, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B075GRYNB8", "real_brand": "Vitabiotics Ultra", "is_yaba_asin": "N", "product_title": "Vitamin D Tablets 2000IU, Vitabiotics Ultra-96 Cou...", "average_organic_rank": 24, "price": 3.79, "click_share": 1.91, "estimated_clicks": 383.228894, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B079H1NVYY", "real_brand": "Zipvit", "is_yaba_asin": "N", "product_title": "Zipvit Vitamin D3 4000 IU, 360 Maximum Strength Vi...", "average_organic_rank": 10, "price": 7.49, "click_share": 2.27, "estimated_clicks": 221.727698, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B079H1NVYY", "real_brand": "Zipvit", "is_yaba_asin": "N", "product_title": "Zipvit Vitamin D3 4000 IU, 360 Maximum Strength Vi...", "average_organic_rank": 17, "price": 7.802857143, "click_share": 1.72, "estimated_clicks": 352.866256, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B079H1NVYY", "real_brand": "Zipvit", "is_yaba_asin": "N", "product_title": "Zipvit Vitamin D3 4000 IU, 360 Maximum Strength Vi...", "average_organic_rank": 15, "price": 8.204285714, "click_share": 1.51, "estimated_clicks": 181.681388, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B07HM81L42", "real_brand": "Nu U Nutrition", "is_yaba_asin": "N", "product_title": "Nu U Nutrition - Vitamin D 4000IU - 365 Softgel Ca...", "average_organic_rank": 13, "price": 9.97, "click_share": 1.51, "estimated_clicks": 181.681388, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B086V74KKR", "real_brand": "WeightWorld", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "average_organic_rank": 1, "price": 8.99, "click_share": 20.0, "estimated_clicks": 4103.096, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B086V74KKR", "real_brand": "WeightWorld", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "average_organic_rank": 1, "price": 8.99, "click_share": 18.05, "estimated_clicks": 2171.75434, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B086V74KKR", "real_brand": "WeightWorld", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "average_organic_rank": 1, "price": 8.99, "click_share": 17.88, "estimated_clicks": 1746.471912, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B086V74KKR", "real_brand": "WeightWorld", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000IU - 1+ Year Supply - 400 Tablets -...", "average_organic_rank": 1, "price": 8.99, "click_share": 19.32, "estimated_clicks": 3876.430488, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B08BRSVYFM", "real_brand": "G R O U N D E D COFFEE SCRUB", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "average_organic_rank": 6, "price": 5.99, "click_share": 3.99, "estimated_clicks": 818.567652, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B08BRSVYFM", "real_brand": "G R O U N D E D COFFEE SCRUB", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "average_organic_rank": 6, "price": 5.99, "click_share": 4.56, "estimated_clicks": 548.653728, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B08BRSVYFM", "real_brand": "G R O U N D E D COFFEE SCRUB", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "average_organic_rank": 6, "price": 5.99, "click_share": 4.09, "estimated_clicks": 820.631506, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B08BRSVYFM", "real_brand": "G R O U N D E D COFFEE SCRUB", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 IU Micro Tablets - 365 Day Supply,...", "average_organic_rank": 5, "price": 5.99, "click_share": 5.18, "estimated_clicks": 505.968932, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 4}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B08F5GBD9X", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "average_organic_rank": 10, "price": 6.97, "click_share": 2.02, "estimated_clicks": 197.308348, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B08F5GBD9X", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "average_organic_rank": 8, "price": 6.984285714, "click_share": 2.07, "estimated_clicks": 415.331838, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B08F5GBD9X", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Vitamin D 1000iu - 1 Year Supply, 365 Easy-Swallow...", "average_organic_rank": 7, "price": 6.99, "click_share": 2.22, "estimated_clicks": 455.443656, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B0BFF8LYR2", "real_brand": "Nu U Nutrition", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "average_organic_rank": 9, "price": 6.49, "click_share": 2.3, "estimated_clicks": 224.65802, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B0BFF8LYR2", "real_brand": "Nu U Nutrition", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "average_organic_rank": 12, "price": 6.691428571, "click_share": 2.24, "estimated_clicks": 449.441216, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B0BFF8LYR2", "real_brand": "Nu U Nutrition", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "average_organic_rank": 13, "price": 7.532857143, "click_share": 2.33, "estimated_clicks": 478.010684, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B0BFF8LYR2", "real_brand": "Nu U Nutrition", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 IU - 400 Vegetarian Tablets - 13 M...", "average_organic_rank": 12, "price": 6.96, "click_share": 1.94, "estimated_clicks": 233.418472, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B0BQCNJ7WR", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Nutrition Geeks, Vitamin D 4000 iu - 1 Year Supply...", "average_organic_rank": 12, "price": 7.99, "click_share": 3.81, "estimated_clicks": 458.414628, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B0BQCNJ7WR", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Nutrition Geeks, Vitamin D 4000 iu - 1 Year Supply...", "average_organic_rank": 22, "price": 7.99, "click_share": 3.42, "estimated_clicks": 334.056708, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B0BQCNJ7WR", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Nutrition Geeks, Vitamin D 4000 iu - 1 Year Supply...", "average_organic_rank": 18, "price": 7.99, "click_share": 3.92, "estimated_clicks": 786.522128, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B0BQCNJ7WR", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Nutrition Geeks, Vitamin D 4000 iu - 1 Year Supply...", "average_organic_rank": 16, "price": 7.99, "click_share": 5.34, "estimated_clicks": 1095.526632, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B0CR57HRDV", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "average_organic_rank": 5, "price": 9.99, "click_share": 19.01, "estimated_clicks": 1856.847374, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B0CR57HRDV", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "average_organic_rank": 5, "price": 9.99, "click_share": 18.56, "estimated_clicks": 3723.941504, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B0CR57HRDV", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "average_organic_rank": 4, "price": 9.99, "click_share": 19.91, "estimated_clicks": 4084.631068, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B0CR57HRDV", "real_brand": "Nutrition Geeks", "is_yaba_asin": "N", "product_title": "Vitamin D3 4000 iu & Vitamin K2 MK7 100\u03bcg - 1 Year...", "average_organic_rank": 4, "price": 9.99, "click_share": 18.64, "estimated_clicks": 2242.742432, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B0DJDFKXJT", "real_brand": "Vita Premium", "is_yaba_asin": "N", "product_title": "Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "average_organic_rank": 6, "price": 9.99, "click_share": 3.85, "estimated_clicks": 463.22738, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B0DJDFKXJT", "real_brand": "Vita Premium", "is_yaba_asin": "N", "product_title": "Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "average_organic_rank": 7, "price": 9.99, "click_share": 4.43, "estimated_clicks": 432.710882, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B0DJDFKXJT", "real_brand": "Vita Premium", "is_yaba_asin": "N", "product_title": "Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "average_organic_rank": 7, "price": 9.99, "click_share": 3.55, "estimated_clicks": 712.28407, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B0DJDFKXJT", "real_brand": "Vita Premium", "is_yaba_asin": "N", "product_title": "Vitamin D 4,000 IU Tablets, Maximum Strength Vitam...", "average_organic_rank": 5, "price": 9.99, "click_share": 3.93, "estimated_clicks": 806.258364, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-01", "parent_asin": "Vitamin D3", "asin": "B00RXIIW7K", "real_brand": "Incite Nutrition", "is_yaba_asin": "Y", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "average_organic_rank": 5, "price": 7.99, "click_share": 5.27, "estimated_clicks": 514.759898, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-02", "parent_asin": "Vitamin D3", "asin": "B00RXIIW7K", "real_brand": "Incite Nutrition", "is_yaba_asin": "Y", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "average_organic_rank": 4, "price": 6.961428571, "click_share": 9.01, "estimated_clicks": 1807.797034, "weekly_number_of_days_with_deal": 6, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2025-52", "parent_asin": "Vitamin D3", "asin": "B00RXIIW7K", "real_brand": "Incite Nutrition", "is_yaba_asin": "Y", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "average_organic_rank": 3, "price": 7.847142857, "click_share": 6.98, "estimated_clicks": 839.825224, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_coupon": 0}, {"week_date": "2026-03", "parent_asin": "Vitamin D3", "asin": "B00RXIIW7K", "real_brand": "Incite Nutrition", "is_yaba_asin": "Y", "product_title": "Vitamin D3 4000 IU - 400 High Strength Vitamin D T...", "average_organic_rank": 4, "price": 6.79, "click_share": 8.18, "estimated_clicks": 1678.166264, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0}];

    // GOOGLE CHARTS INIT
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    // UTILS
    function getWeeks() {
        return [...new Set(marketData.map(d => d.week_date))].sort();
    }

    function getOurBrand() {
        return marketData.find(d => d.is_yaba_asin === 'Y')?.real_brand || 'Nuestra Marca';
    }

    function getCompetitors() {
        const ourBrand = getOurBrand();
        const brands = [...new Set(marketData.map(d => d.real_brand))];
        return brands.filter(b => b !== ourBrand);
    }

    // MAIN LOGIC
    function initDashboard() {
        const weeks = getWeeks();
        const lastWeek = weeks[weeks.length - 1];
        
        // Populate KPIs
        calculateKPIs(lastWeek);
        
        // Draw Static Charts
        drawTrendChart();
        drawBrandShareChart();
        drawScatterChart(lastWeek);
        drawLeverTable();
        
        // Init Interactive Tab
        const selectWeek = document.getElementById('select-week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            if(w === lastWeek) opt.selected = true;
            selectWeek.appendChild(opt);
        });

        const selectComp = document.getElementById('select-comp');
        getCompetitors().forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            selectComp.appendChild(opt);
        });

        updateInteractive(); // Initial draw
        
        // Set Title
        document.getElementById('parentName').innerText = marketData[0].parent_asin;
    }

    function calculateKPIs(week) {
        const weekData = marketData.filter(d => d.week_date === week);
        const prevWeek = getWeeks()[getWeeks().length - 2];
        const prevData = marketData.filter(d => d.week_date === prevWeek);

        const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
        const prevClicks = prevData.reduce((sum, d) => sum + d.estimated_clicks, 0);

        const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
        const ourClicks = ourData.reduce((sum, d) => sum + d.estimated_clicks, 0);
        const ourShare = (ourClicks / totalClicks) * 100;
        
        const prevOurData = prevData.filter(d => d.is_yaba_asin === 'Y');
        const prevShare = (prevOurData.reduce((sum, d) => sum + d.estimated_clicks, 0) / prevClicks) * 100;

        const avgPrice = ourData.reduce((sum, d) => sum + d.price, 0) / (ourData.length || 1);
        const avgRank = ourData.reduce((sum, d) => sum + d.average_organic_rank, 0) / (ourData.length || 1);

        document.getElementById('kpi-clicks').innerText = Math.round(totalClicks).toLocaleString();
        setTrend('kpi-clicks-trend', totalClicks, prevClicks);

        document.getElementById('kpi-share').innerText = ourShare.toFixed(1) + '%';
        setTrend('kpi-share-trend', ourShare, prevShare, true);

        document.getElementById('kpi-price').innerText = '¬£' + avgPrice.toFixed(2);
        
        document.getElementById('kpi-rank').innerText = '#' + avgRank.toFixed(1);
    }

    function setTrend(elemId, curr, prev, isPct = false) {
        const elem = document.getElementById(elemId);
        const diff = curr - prev;
        const icon = diff > 0 ? 'trending_up' : 'trending_down';
        const colorClass = diff > 0 ? 'up' : 'down';
        
        let text = '';
        if (isPct) {
            text = (diff > 0 ? '+' : '') + diff.toFixed(1) + ' pp vs sem anterior';
        } else {
            const pctChange = ((diff / prev) * 100).toFixed(1);
            text = (diff > 0 ? '+' : '') + pctChange + '% vs sem anterior';
        }
        
        elem.innerHTML = `<span class="material-icons" style="font-size:16px; margin-right:4px;">${icon}</span> ${text}`;
        elem.className = `trend ${colorClass}`;
    }

    // --- CHART 1: TREND ---
    function drawTrendChart() {
        const weeks = getWeeks();
        const data = [['Semana', 'Clicks Competencia', 'Clicks Nosotros', 'Nuestro Share (%)']];

        weeks.forEach(w => {
            const d = marketData.filter(x => x.week_date === w);
            const total = d.reduce((s, x) => s + x.estimated_clicks, 0);
            const our = d.filter(x => x.is_yaba_asin === 'Y').reduce((s, x) => s + x.estimated_clicks, 0);
            const comp = total - our;
            const share = (our / total) * 100;
            data.push([w, comp, our, share]);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1 } },
            vAxes: { 0: { title: 'Volumen Clicks' }, 1: { title: 'Share %', format: '#\'%\'' } },
            colors: ['#DADCE0', '#4285F4', '#34A853'],
            legend: { position: 'bottom' },
            bar: { groupWidth: '60%' },
            chartArea: { width: '85%', height: '70%' }
        };

        new google.visualization.ComboChart(document.getElementById('chart_trend')).draw(dt, options);
    }

    // --- CHART 2: BRAND SHARE ---
    function drawBrandShareChart() {
        const weeks = getWeeks();
        const ourBrand = getOurBrand();
        
        // Identify top 3 competitors
        const compMap = {};
        marketData.filter(d => d.real_brand !== ourBrand).forEach(d => {
            compMap[d.real_brand] = (compMap[d.real_brand] || 0) + d.estimated_clicks;
        });
        const top3 = Object.entries(compMap).sort((a,b) => b[1] - a[1]).slice(0,3).map(x => x[0]);
        
        const header = ['Semana', ourBrand, ...top3, 'Resto'];
        const data = [header];

        weeks.forEach(w => {
            const d = marketData.filter(x => x.week_date === w);
            const total = d.reduce((s, x) => s + x.estimated_clicks, 0) || 1;
            
            const row = [w];
            // Our Brand
            const ourClicks = d.filter(x => x.real_brand === ourBrand).reduce((s, x) => s + x.estimated_clicks, 0);
            row.push((ourClicks / total) * 100);
            
            // Top 3
            top3.forEach(b => {
                const bClicks = d.filter(x => x.real_brand === b).reduce((s, x) => s + x.estimated_clicks, 0);
                row.push((bClicks / total) * 100);
            });
            
            // Others
            const otherClicks = d.filter(x => x.real_brand !== ourBrand && !top3.includes(x.real_brand))
                                 .reduce((s, x) => s + x.estimated_clicks, 0);
            row.push((otherClicks / total) * 100);
            
            data.push(row);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            legend: { position: 'bottom' },
            vAxis: { format: '#\'%\'' },
            chartArea: { width: '85%', height: '70%' }
        };

        new google.visualization.LineChart(document.getElementById('chart_brand_share')).draw(dt, options);
    }

    // --- CHART 3: SCATTER (EFFICIENCY) ---
    function drawScatterChart(week) {
        const d = marketData.filter(x => x.week_date === week);
        const data = [['ID', 'Rank', 'Click Share (%)', 'Brand', 'Size']];
        
        const ourBrand = getOurBrand();

        d.forEach(x => {
            data.push([
                x.real_brand,
                x.average_organic_rank,
                x.click_share,
                x.real_brand === ourBrand ? 'Nosotros' : 'Competencia',
                x.click_share // Bubble size
            ]);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 },
            vAxis: { title: 'Click Share (%)' },
            bubble: { textStyle: { fontSize: 11 } },
            colors: ['#EA4335', '#4285F4'], // Red (Comp), Blue (Us)
            legend: { position: 'bottom' }
        };

        new google.visualization.BubbleChart(document.getElementById('chart_scatter')).draw(dt, options);
    }

    // --- CHART 4: LEVERS TABLE ---
    function drawLeverTable() {
        const lastWeek = getWeeks().pop();
        const d = marketData.filter(x => x.week_date === lastWeek);
        const ourBrand = getOurBrand();

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Marca');
        data.addColumn('string', 'ASIN');
        data.addColumn('number', 'Precio');
        data.addColumn('number', 'Share %');
        data.addColumn('number', 'Deal Days');
        data.addColumn('boolean', 'Coupon?');

        d.sort((a,b) => b.click_share - a.click_share).slice(0, 10).forEach(x => {
            data.addRow([
                x.real_brand,
                x.asin,
                x.price,
                x.click_share,
                x.weekly_number_of_days_with_deal,
                x.weekly_number_of_days_with_coupon > 0
            ]);
        });

        const table = new google.visualization.Table(document.getElementById('table_levers'));
        table.draw(data, { showRowNumber: true, width: '100%', height: '100%' });
    }

    // --- INTERACTIVE SECTION ---
    function updateInteractive() {
        const week = document.getElementById('select-week').value;
        const compBrand = document.getElementById('select-comp').value;
        const ourBrand = getOurBrand();

        const d = marketData.filter(x => x.week_date === week);
        
        // 1. Comparison Table
        const ourStats = getBrandStats(d, ourBrand);
        const compStats = getBrandStats(d, compBrand);

        const tableHTML = `
            <table style="width:100%; text-align:left; border-collapse:collapse;">
                <tr style="border-bottom:1px solid #eee; color:#5F6368; font-size:12px;">
                    <th style="padding:8px;">M√©trica</th>
                    <th style="padding:8px; color:var(--primary);">${ourBrand}</th>
                    <th style="padding:8px; color:var(--danger);">${compBrand}</th>
                </tr>
                <tr>
                    <td style="padding:8px;">Click Share</td>
                    <td style="font-weight:bold;">${ourStats.share}%</td>
                    <td>${compStats.share}%</td>
                </tr>
                <tr style="background:#f8f9fa;">
                    <td style="padding:8px;">Precio Prom.</td>
                    <td>¬£${ourStats.price}</td>
                    <td>¬£${compStats.price}</td>
                </tr>
                <tr>
                    <td style="padding:8px;">Rank Prom.</td>
                    <td>#${ourStats.rank}</td>
                    <td>#${compStats.rank}</td>
                </tr>
                <tr style="background:#f8f9fa;">
                    <td style="padding:8px;">Deal Days (Avg)</td>
                    <td>${ourStats.deals}</td>
                    <td>${compStats.deals}</td>
                </tr>
            </table>
        `;
        document.getElementById('table_comparison').innerHTML = tableHTML;

        // 2. Pie Chart
        const total = d.reduce((s, x) => s + x.estimated_clicks, 0);
        const ourClicks = d.filter(x => x.real_brand === ourBrand).reduce((s, x) => s + x.estimated_clicks, 0);
        const compClicks = d.filter(x => x.real_brand === compBrand).reduce((s, x) => s + x.estimated_clicks, 0);
        const others = total - ourClicks - compClicks;

        const pieData = google.visualization.arrayToDataTable([
            ['Marca', 'Clicks'],
            [ourBrand, ourClicks],
            [compBrand, compClicks],
            ['Otros', others]
        ]);

        const options = {
            colors: ['#4285F4', '#EA4335', '#E8EAED'],
            pieHole: 0.4,
            chartArea: { width: '90%', height: '90%' },
            legend: { position: 'bottom' }
        };

        new google.visualization.PieChart(document.getElementById('chart_pie_share')).draw(pieData, options);
    }

    function getBrandStats(data, brand) {
        const brandData = data.filter(x => x.real_brand === brand);
        if (brandData.length === 0) return { share: 0, price: 0, rank: 0, deals: 0 };
        
        const totalMarketClicks = data.reduce((s,x) => s + x.estimated_clicks, 0);
        const brandClicks = brandData.reduce((s,x) => s + x.estimated_clicks, 0);
        
        return {
            share: ((brandClicks / totalMarketClicks) * 100).toFixed(1),
            price: (brandData.reduce((s,x) => s + x.price, 0) / brandData.length).toFixed(2),
            rank: (brandData.reduce((s,x) => s + x.average_organic_rank, 0) / brandData.length).toFixed(1),
            deals: (brandData.reduce((s,x) => s + x.weekly_number_of_days_with_deal, 0) / brandData.length).toFixed(1)
        };
    }

    // TAB LOGIC
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('button[onclick*="' + tabName + '"]').forEach(b => b.classList.add('active'));
        
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        
        document.getElementById('tab-' + tabName).classList.remove('hidden');
    }

</script>

</body>
</html>