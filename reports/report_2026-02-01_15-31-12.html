<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Market Intelligence Report</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --gray-100: #f1f3f4;
            --gray-300: #dadce0;
            --gray-700: #5f6368;
            --gray-900: #202124;
            --white: #ffffff;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --card-radius: 8px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-900);
            margin: 0;
            padding: 0;
            font-size: 14px;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border-radius: var(--card-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 {
            margin: 0;
            font-size: 20px;
            color: var(--primary-color);
        }
        .header-title span {
            font-size: 12px;
            color: var(--gray-700);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .tab-btn {
            background: var(--white);
            border: 1px solid var(--gray-300);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-700);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn.active {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
        }

        /* Sections */
        .section-card {
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--gray-100);
            padding-bottom: 12px;
        }
        .section-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        .section-icon {
            color: var(--primary-color);
        }

        /* Charts Container */
        .chart-container {
            width: 100%;
            height: 400px;
        }
        .chart-small {
            height: 300px;
        }

        /* Grid for Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: var(--gray-100);
            padding: 16px;
            border-radius: var(--card-radius);
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--gray-900);
        }
        .metric-label {
            font-size: 12px;
            color: var(--gray-700);
            text-transform: uppercase;
        }
        .metric-trend {
            font-size: 12px;
            margin-top: 4px;
        }
        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }

        /* Insights List */
        .insights-list ul {
            padding-left: 20px;
        }
        .insights-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        /* Comparator Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--gray-100);
            padding: 16px;
            border-radius: var(--card-radius);
        }
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--gray-300);
            font-family: inherit;
        }

        /* Visibility classes */
        .hidden { display: none; }
        .block { display: block; }

        /* Helpers */
        .text-blue { color: var(--primary-color); }
        .text-red { color: var(--danger-color); }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-title">
                <h1>Amazon Parent ASIN Intelligence</h1>
                <span id="report-date-range">Loading dates...</span>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: bold; font-size: 16px;" id="our-brand-display">Our Brand</div>
                <div style="font-size: 12px; color: var(--gray-700);">Performance Report</div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">
                <span class="material-icons">analytics</span> Strategic Report
            </button>
            <button class="tab-btn" onclick="switchTab('interactive')">
                <span class="material-icons">compare_arrows</span> Interactive Comparator
            </button>
        </div>

        <!-- ========================================== -->
        <!-- TAB 1: STATIC STRATEGIC REPORT -->
        <!-- ========================================== -->
        <div id="tab-static">
            
            <!-- Section 1: Global Trend -->
            <div class="section-card">
                <div class="section-header">
                    <span class="material-icons section-icon">show_chart</span>
                    <h2>1. Global Parent Trend (Clicks & Share)</h2>
                </div>
                <div class="metrics-grid" id="global-metrics">
                    <!-- Metrics injected via JS -->
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
                <div class="insights-list" id="trend-insights">
                    <p><strong>Analysis:</strong> <span id="trend-text">Loading analysis...</span></p>
                </div>
            </div>

            <!-- Section 2: Brand Competitiveness -->
            <div class="section-card">
                <div class="section-header">
                    <span class="material-icons section-icon">pie_chart</span>
                    <h2>2. Brand Competitiveness (Market Share Curve)</h2>
                </div>
                <p style="color: var(--gray-700); margin-bottom: 10px;">
                    Weekly Click Share Evolution: Our Brand vs Top 3 Competitors vs Rest of Market.
                </p>
                <div id="chart_brand_share" class="chart-container"></div>
                <div class="insights-list">
                    <ul id="brand-insights-list"></ul>
                </div>
            </div>

            <!-- Section 3: Levers -->
            <div class="section-card">
                <div class="section-header">
                    <span class="material-icons section-icon">rocket_launch</span>
                    <h2>3. Growth Levers (Promo & Badges)</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div>
                        <h3>Impact of Deals on Share</h3>
                        <div id="chart_levers_deals" class="chart-small"></div>
                    </div>
                    <div>
                        <h3>Price Elasticity (Avg Price vs Share)</h3>
                        <div id="chart_levers_price" class="chart-small"></div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Efficiency -->
            <div class="section-card">
                <div class="section-header">
                    <span class="material-icons section-icon">speed</span>
                    <h2>4. Organic Efficiency (Rank vs Click Share)</h2>
                </div>
                <p><strong>Overperformers:</strong> High Share despite lower Rank. <strong>Underperformers:</strong> Low Share despite good Rank.</p>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>

            <!-- Section 5: Conclusions -->
            <div class="section-card" style="border-left: 5px solid var(--primary-color);">
                <div class="section-header">
                    <span class="material-icons section-icon">lightbulb</span>
                    <h2>5. Conclusions & Actions</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div>
                        <h3 class="text-blue">Key Insights</h3>
                        <ul id="final-insights-list" class="insights-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-red">Actionable Recommendations</h3>
                        <ul id="final-actions-list" class="insights-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <!-- ========================================== -->
        <div id="tab-interactive" class="hidden">
            <div class="section-card">
                <div class="section-header">
                    <span class="material-icons section-icon">tune</span>
                    <h2>Head-to-Head Comparator</h2>
                </div>
                
                <div class="controls">
                    <div>
                        <label>Select Week:</label>
                        <select id="comp-week-select" onchange="updateComparator()"></select>
                    </div>
                    <div>
                        <label>Select Competitor:</label>
                        <select id="comp-competitor-select" onchange="updateComparator()"></select>
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Our Price</div>
                        <div class="metric-value" id="comp-our-price">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Comp Price</div>
                        <div class="metric-value" id="comp-their-price">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Share Gap</div>
                        <div class="metric-value" id="comp-share-gap">-</div>
                    </div>
                </div>

                <div id="chart_comparator_bar" class="chart-container"></div>
            </div>
        </div>

    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script type="text/javascript">
        // ------------------------------------------------------------------
        // 1. DATA INJECTION (Generated Synthetic Data based on Prompt Specs)
        // ------------------------------------------------------------------
        const marketData = [{"brand_aggregation": "SoundCore", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00_YABA_01", "product_title": "SoundCore Pro Wireless wireless headphones - Black", "country_code": "US", "average_organic_rank": 8.077274092497645, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.23351336140518776, "impression_share": 0.12658824330689914, "price": 49.99, "click_share_rank": 3, "weekly_search_volume": 6128, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00_Sony_716", "product_title": "Sony Ultra wireless headphones", "country_code": "US", "average_organic_rank": 4.19277051284705, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.3479482597711466, "impression_share": 0.20845353136287313, "price": 120.0, "click_share_rank": 3, "weekly_search_volume": 6128, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00_JBL_361", "product_title": "JBL Ultra wireless headphones", "country_code": "US", "average_organic_rank": 29.560641219800642, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.04169550749007202, "impression_share": 0.016390146039121656, "price": 25.0, "click_share_rank": 22, "weekly_search_volume": 6128, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00_Bose_682", "product_title": "Bose Ultra wireless headphones", "country_code": "US", "average_organic_rank": 2.2704253164965823, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.3113115456209589, "impression_share": 0.36017578272993214, "price": 120.0, "click_share_rank": 2, "weekly_search_volume": 6128, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_Unknown Brand_302", "product_title": "Generic Cheap wireless headphones", "country_code": "US", "average_organic_rank": 22.186638066597566, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.038202507664188594, "impression_share": 0.09849208051770281, "price": 25.0, "click_share_rank": 10, "weekly_search_volume": 6128, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_None_750", "product_title": "Mystery Audio wireless headphones", "country_code": "US", "average_organic_rank": 39.06283995679948, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.015091728135832717, "impression_share": 0.030635293290687796, "price": 25.0, "click_share_rank": 27, "weekly_search_volume": 6128, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "SoundCore", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "bluetooth earbud", "competitor_brand": "SoundCore", "asin": "B00_YABA_01", "product_title": "SoundCore Pro Wireless bluetooth earbud - Black", "country_code": "US", "average_organic_rank": 2.215277150919246, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.17062402244222064, "impression_share": 0.27083017255152336, "price": 49.99, "click_share_rank": 5, "weekly_search_volume": 12826, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=bluetooth earbud"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "bluetooth earbud", "competitor_brand": "Sony", "asin": "B00_Sony_754", "product_title": "Sony Ultra bluetooth earbud", "country_code": "US", "average_organic_rank": 5.421683403565123, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.23126830536768134, "impression_share": 0.20172815309623253, "price": 120.0, "click_share_rank": 1, "weekly_search_volume": 12826, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=bluetooth earbud"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "bluetooth earbud", "competitor_brand": "JBL", "asin": "B00_JBL_664", "product_title": "JBL Ultra bluetooth earbud", "country_code": "US", "average_organic_rank": 33.45638545802525, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.04692751515220372, "impression_share": 0.08801974753066601, "price": 25.0, "click_share_rank": 26, "weekly_search_volume": 12826, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=bluetooth earbud"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "bluetooth earbud", "competitor_brand": "Bose", "asin": "B00_Bose_663", "product_title": "Bose Ultra bluetooth earbud", "country_code": "US", "average_organic_rank": 3.7371909890833246, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.29742880721243177, "impression_share": 0.2709232338600889, "price": 120.0, "click_share_rank": 3, "weekly_search_volume": 12826, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=bluetooth earbud"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "bluetooth earbud", "competitor_brand": null, "asin": "B00_Unknown Brand_270", "product_title": "Generic Cheap bluetooth earbud", "country_code": "US", "average_organic_rank": 37.96207038827988, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.03960907293774026, "impression_share": 0.06176503799632837, "price": 25.0, "click_share_rank": 15, "weekly_search_volume": 12826, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=bluetooth earbud"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-10", "week_date": "2025-02-10", "keywords": "bluetooth earbud", "competitor_brand": null, "asin": "B00_None_132", "product_title": "Mystery Audio bluetooth earbud", "country_code": "US", "average_organic_rank": 29.835948301556816, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.021160408542918452, "impression_share": 0.02325877891784659, "price": 25.0, "click_share_rank": 28, "weekly_search_volume": 12826, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=bluetooth earbud"}, {"brand_aggregation": "SoundCore", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-17", "week_date": "2025-02-17", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00_YABA_01", "product_title": "SoundCore Pro Wireless wireless headphones - Black", "country_code": "US", "average_organic_rank": 3.7915570222047395, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.17068593856112932, "impression_share": 0.18731362873104627, "price": 49.99, "click_share_rank": 3, "weekly_search_volume": 8516, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-17", "week_date": "2025-02-17", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00_Sony_749", "product_title": "Sony Ultra wireless headphones", "country_code": "US", "average_organic_rank": 1.7618991475730438, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.32356598379435425, "impression_share": 0.3117562095810237, "price": 120.0, "click_share_rank": 2, "weekly_search_volume": 8516, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-17", "week_date": "2025-02-17", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00_JBL_862", "product_title": "JBL Ultra wireless headphones", "country_code": "US", "average_organic_rank": 43.153920786937215, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0469038487920392, "impression_share": 0.04169212239617351, "price": 25.0, "click_share_rank": 12, "weekly_search_volume": 8516, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-17", "week_date": "2025-02-17", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00_Bose_645", "product_title": "Bose Ultra wireless headphones", "country_code": "US", "average_organic_rank": 7.4988647008139595, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2829141042738927, "impression_share": 0.3546733979402513, "price": 120.0, "click_share_rank": 3, "weekly_search_volume": 8516, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-17", "week_date": "2025-02-17", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_Unknown Brand_416", "product_title": "Generic Cheap wireless headphones", "country_code": "US", "average_organic_rank": 19.34149996545785, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.01579560410041846, "impression_share": 0.06536098059882672, "price": 25.0, "click_share_rank": 26, "weekly_search_volume": 8516, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-17", "week_date": "2025-02-17", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_None_920", "product_title": "Mystery Audio wireless headphones", "country_code": "US", "average_organic_rank": 30.297463564177265, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.010145293223126757, "impression_share": 0.08985558941011505, "price": 25.0, "click_share_rank": 10, "weekly_search_volume": 8516, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "SoundCore", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-24", "week_date": "2025-02-24", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00_YABA_01", "product_title": "SoundCore Pro Wireless wireless headphones - Black", "country_code": "US", "average_organic_rank": 14.653426038814777, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2227181669229712, "impression_share": 0.17067864197793796, "price": 49.99, "click_share_rank": 3, "weekly_search_volume": 5824, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-24", "week_date": "2025-02-24", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00_Sony_740", "product_title": "Sony Ultra wireless headphones", "country_code": "US", "average_organic_rank": 6.840742144702081, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.22432847055745758, "impression_share": 0.3541458872166948, "price": 120.0, "click_share_rank": 2, "weekly_search_volume": 5824, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-24", "week_date": "2025-02-24", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00_JBL_355", "product_title": "JBL Ultra wireless headphones", "country_code": "US", "average_organic_rank": 27.65991444122114, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.042299718485295544, "impression_share": 0.09337581021798305, "price": 25.0, "click_share_rank": 10, "weekly_search_volume": 5824, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-24", "week_date": "2025-02-24", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00_Bose_881", "product_title": "Bose Ultra wireless headphones", "country_code": "US", "average_organic_rank": 1.7001477545638217, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.23078726510344445, "impression_share": 0.2241517709328221, "price": 120.0, "click_share_rank": 3, "weekly_search_volume": 5824, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-24", "week_date": "2025-02-24", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_Unknown Brand_933", "product_title": "Generic Cheap wireless headphones", "country_code": "US", "average_organic_rank": 33.39327598858602, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.03846665042469608, "impression_share": 0.035767228812677914, "price": 25.0, "click_share_rank": 15, "weekly_search_volume": 5824, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-02-24", "week_date": "2025-02-24", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_None_536", "product_title": "Mystery Audio wireless headphones", "country_code": "US", "average_organic_rank": 48.24354719665646, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.01633519842523293, "impression_share": 0.05367684074814925, "price": 25.0, "click_share_rank": 15, "weekly_search_volume": 5824, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "SoundCore", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-03", "week_date": "2025-03-03", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00_YABA_01", "product_title": "SoundCore Pro Wireless wireless headphones - Black", "country_code": "US", "average_organic_rank": 8.16914561879058, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.13459174116498967, "impression_share": 0.16010724623194017, "price": 49.99, "click_share_rank": 3, "weekly_search_volume": 12829, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-03", "week_date": "2025-03-03", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00_Sony_727", "product_title": "Sony Ultra wireless headphones", "country_code": "US", "average_organic_rank": 9.206240217646679, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1666996614406214, "impression_share": 0.3546757049405625, "price": 120.0, "click_share_rank": 3, "weekly_search_volume": 12829, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-03", "week_date": "2025-03-03", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00_JBL_862", "product_title": "JBL Ultra wireless headphones", "country_code": "US", "average_organic_rank": 21.056073400516135, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.024929841399453906, "impression_share": 0.06312108518973543, "price": 25.0, "click_share_rank": 10, "weekly_search_volume": 12829, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-03", "week_date": "2025-03-03", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00_Bose_864", "product_title": "Bose Ultra wireless headphones", "country_code": "US", "average_organic_rank": 5.867990158223963, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.31688647610636416, "impression_share": 0.2831206132049419, "price": 120.0, "click_share_rank": 2, "weekly_search_volume": 12829, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-03", "week_date": "2025-03-03", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_Unknown Brand_943", "product_title": "Generic Cheap wireless headphones", "country_code": "US", "average_organic_rank": 11.458931121041926, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.03819894819717757, "impression_share": 0.027055057088656114, "price": 25.0, "click_share_rank": 16, "weekly_search_volume": 12829, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-03", "week_date": "2025-03-03", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_None_164", "product_title": "Mystery Audio wireless headphones", "country_code": "US", "average_organic_rank": 22.38531778932785, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.03260907409240406, "impression_share": 0.09139598282361665, "price": 25.0, "click_share_rank": 25, "weekly_search_volume": 12829, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "SoundCore", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-10", "week_date": "2025-03-10", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00_YABA_01", "product_title": "SoundCore Pro Wireless wireless headphones - Black", "country_code": "US", "average_organic_rank": 2.1627706354898146, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.22272023023075252, "impression_share": 0.1601675765664082, "price": 49.99, "click_share_rank": 1, "weekly_search_volume": 13915, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-10", "week_date": "2025-03-10", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00_Sony_740", "product_title": "Sony Ultra wireless headphones", "country_code": "US", "average_organic_rank": 3.7915570222047395, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.32049071064952047, "impression_share": 0.3541458872166948, "price": 120.0, "click_share_rank": 3, "weekly_search_volume": 13915, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-10", "week_date": "2025-03-10", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00_JBL_355", "product_title": "JBL Ultra wireless headphones", "country_code": "US", "average_organic_rank": 43.153920786937215, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0469038487920392, "impression_share": 0.04169212239617351, "price": 25.0, "click_share_rank": 22, "weekly_search_volume": 13915, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-10", "week_date": "2025-03-10", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00_Bose_881", "product_title": "Bose Ultra wireless headphones", "country_code": "US", "average_organic_rank": 7.4988647008139595, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2829141042738927, "impression_share": 0.3546733979402513, "price": 120.0, "click_share_rank": 3, "weekly_search_volume": 13915, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-10", "week_date": "2025-03-10", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_Unknown Brand_933", "product_title": "Generic Cheap wireless headphones", "country_code": "US", "average_organic_rank": 19.34149996545785, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.01579560410041846, "impression_share": 0.06536098059882672, "price": 25.0, "click_share_rank": 26, "weekly_search_volume": 13915, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Market", "parent_asin": "B00_PARENT_YABA", "reporting_date": "2025-03-10", "week_date": "2025-03-10", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00_None_536", "product_title": "Mystery Audio wireless headphones", "country_code": "US", "average_organic_rank": 30.297463564177265, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.010145293223126757, "impression_share": 0.08985558941011505, "price": 25.0, "click_share_rank": 27, "weekly_search_volume": 13915, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}];

        // ------------------------------------------------------------------
        // 2. HELPER FUNCTIONS
        // ------------------------------------------------------------------
        
        function getBrand(row) {
            if (row.competitor_brand) return row.competitor_brand;
            // Attempt extraction from title
            if (row.product_title) {
                const parts = row.product_title.split(' ');
                if (parts.length > 0) return parts[0]; 
            }
            return "Unknown Brand";
        }

        function getOurBrandName() {
            const ourRow = marketData.find(r => r.is_yaba_asin === 'Y');
            return ourRow ? getBrand(ourRow) : "Our Brand";
        }

        // Initialize Google Charts
        google.charts.load('current', {'packages':['corechart', 'bar', 'line']});
        google.charts.setOnLoadCallback(initReport);

        let ourBrandName = "";
        let sortedWeeks = [];
        let topCompetitors = [];

        function initReport() {
            ourBrandName = getOurBrandName();
            document.getElementById('our-brand-display').innerText = ourBrandName;

            // Get unique sorted weeks
            const weeksSet = new Set(marketData.map(d => d.week_date));
            sortedWeeks = Array.from(weeksSet).sort();
            
            document.getElementById('report-date-range').innerText = 
                `${sortedWeeks[0]} to ${sortedWeeks[sortedWeeks.length - 1]}`;

            // Identify Top 3 Competitors (excluding us)
            const brandShares = {};
            marketData.forEach(r => {
                const b = getBrand(r);
                if (b === ourBrandName) return;
                if (!brandShares[b]) brandShares[b] = 0;
                brandShares[b] += r.click_share;
            });
            
            topCompetitors = Object.keys(brandShares)
                .sort((a,b) => brandShares[b] - brandShares[a])
                .slice(0, 3);

            // RENDER SECTIONS
            renderGlobalTrend();
            renderBrandCompetitiveness();
            renderLevers();
            renderEfficiency();
            generateInsights();
            initComparator();
        }

        // ------------------------------------------------------------------
        // 3. CHART RENDERERS
        // ------------------------------------------------------------------

        function renderGlobalTrend() {
            // Aggregation: Sum clicks and Avg Share per week for Parent (all keywords)
            const weekData = {};
            
            sortedWeeks.forEach(w => {
                weekData[w] = { 
                    clicks_us: 0, clicks_them: 0, 
                    share_us_sum: 0, share_total_sum: 0 
                };
            });

            marketData.forEach(r => {
                const w = r.week_date;
                const estClicks = r.click_share * r.weekly_search_volume;
                if (r.is_yaba_asin === 'Y') {
                    weekData[w].clicks_us += estClicks;
                    weekData[w].share_us_sum += estClicks; // Weight by volume
                } else {
                    weekData[w].clicks_them += estClicks;
                }
                weekData[w].share_total_sum += estClicks;
            });

            const dataTable = [['Week', 'My Clicks', 'Market Clicks', 'My Share %']];
            let lastShare = 0;
            let firstShare = 0;

            sortedWeeks.forEach((w, index) => {
                const d = weekData[w];
                const totalClicks = d.clicks_us + d.clicks_them;
                const share = totalClicks > 0 ? (d.clicks_us / totalClicks) : 0;
                dataTable.push([w, Math.round(d.clicks_us), Math.round(d.clicks_them), share]);
                
                if (index === 0) firstShare = share;
                if (index === sortedWeeks.length - 1) lastShare = share;
            });

            // Draw Chart
            const data = google.visualization.arrayToDataTable(dataTable);
            const options = {
                seriesType: 'bars',
                series: { 2: { type: 'line', targetAxisIndex: 1 } },
                vAxes: { 0: { title: 'Clicks Volume' }, 1: { title: 'Click Share %', format: '#%' } },
                colors: ['#4285F4', '#dadce0', '#FBBC05'],
                legend: { position: 'bottom' },
                chartArea: { width: '80%', height: '70%' }
            };
            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);

            // Metrics
            const trend = lastShare >= firstShare ? 'trend-up' : 'trend-down';
            const icon = lastShare >= firstShare ? 'trending_up' : 'trending_down';
            
            const html = `
                <div class="metric-card">
                    <div class="metric-label">Last Week Share</div>
                    <div class="metric-value ${(lastShare > 0.15 ? 'text-blue' : '')}">
                        ${(lastShare * 100).toFixed(1)}%
                    </div>
                </div>
                 <div class="metric-card">
                    <div class="metric-label">Trend</div>
                    <div class="metric-value ${trend}">
                        <span class="material-icons" style="font-size:24px; vertical-align:middle;">${icon}</span>
                    </div>
                </div>
            `;
            document.getElementById('global-metrics').innerHTML = html;
            
            // Text Insight
            document.getElementById('trend-text').innerText = 
                `In the last week, our ASIN achieved ${(lastShare*100).toFixed(1)}% click share across targeted keywords. Compared to the start of the period (${(firstShare*100).toFixed(1)}%), the trend is ${lastShare >= firstShare ? 'positive' : 'negative'}. This correlates with the aggregated search volume and promotional activity.`;
        }

        function renderBrandCompetitiveness() {
            // Columns: Week, Us, Comp1, Comp2, Comp3, Rest
            const header = ['Week', ourBrandName, ...topCompetitors, 'Rest of Market'];
            const rows = [];

            sortedWeeks.forEach(w => {
                const weekRows = marketData.filter(r => r.week_date === w);
                const totalVol = weekRows.reduce((sum, r) => sum + (r.click_share * r.weekly_search_volume), 0);
                
                const shares = { [ourBrandName]: 0, 'Rest of Market': 0 };
                topCompetitors.forEach(c => shares[c] = 0);

                weekRows.forEach(r => {
                    const b = getBrand(r);
                    const clicks = r.click_share * r.weekly_search_volume;
                    if (b === ourBrandName) shares[b] += clicks;
                    else if (topCompetitors.includes(b)) shares[b] += clicks;
                    else shares['Rest of Market'] += clicks;
                });

                const row = [w];
                // Convert to percentage
                row.push(totalVol ? shares[ourBrandName]/totalVol : 0);
                topCompetitors.forEach(c => row.push(totalVol ? shares[c]/totalVol : 0));
                row.push(totalVol ? shares['Rest of Market']/totalVol : 0);
                rows.push(row);
            });

            const data = google.visualization.arrayToDataTable([header, ...rows]);
            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: { format: '#%' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#999'],
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
            chart.draw(data, options);
            
            // Comp Insights List
            let dom = "";
            const lastRow = rows[rows.length-1]; // [Week, Us, C1, C2, C3, Rest]
            const ourLast = lastRow[1];
            topCompetitors.forEach((c, i) => {
                const theirLast = lastRow[i+2];
                const diff = (ourLast - theirLast) * 100;
                dom += `<li>Vs <strong>${c}</strong>: We are ${diff > 0 ? 'leading' : 'trailing'} by ${Math.abs(diff).toFixed(1)} pts.</li>`;
            });
            document.getElementById('brand-insights-list').innerHTML = dom;
        }

        function renderLevers() {
            // 1. Deal Impact (Simple Bar: Avg Share with Deal vs No Deal)
            const dealShares = [];
            const noDealShares = [];

            marketData.filter(r => r.is_yaba_asin === 'Y').forEach(r => {
                if (r.weekly_number_of_days_with_deal > 0) dealShares.push(r.click_share);
                else noDealShares.push(r.click_share);
            });

            const avgDeal = dealShares.length ? dealShares.reduce((a,b)=>a+b,0)/dealShares.length : 0;
            const avgNoDeal = noDealShares.length ? noDealShares.reduce((a,b)=>a+b,0)/noDealShares.length : 0;
            
            const dataDeals = google.visualization.arrayToDataTable([
                ['Status', 'Avg Click Share', { role: 'style' }],
                ['No Deal', avgNoDeal, 'color: #dadce0'],
                ['Active Deal', avgDeal, 'color: #34A853']
            ]);

            new google.visualization.ColumnChart(document.getElementById('chart_levers_deals')).draw(dataDeals, {
                legend: { position: 'none' },
                vAxis: { format: '#%' }
            });

            // 2. Price vs Share (Scatter)
            const priceData = [['Price', 'Click Share', { role: 'tooltip' }]];
            marketData.forEach(r => {
                priceData.push([r.price, r.click_share, `${getBrand(r)}: $${r.price} (${(r.click_share*100).toFixed(1)}%)`]);
            });
            
            const dataPrice = google.visualization.arrayToDataTable(priceData);
            new google.visualization.ScatterChart(document.getElementById('chart_levers_price')).draw(dataPrice, {
                legend: { position: 'none' },
                hAxis: { title: 'Price ($)' },
                vAxis: { title: 'Share' },
                colors: ['#4285F4']
            });
        }

        function renderEfficiency() {
            // X: Rank (Inverse), Y: Share. Color: Us vs Them
            const dataArr = [['Rank', 'Click Share', { role: 'style' }, { role: 'tooltip' }]];
            
            marketData.forEach(r => {
                // Determine color
                let color = '#999'; // default
                if (r.is_yaba_asin === 'Y') color = '#4285F4'; // Blue
                else if (topCompetitors.includes(getBrand(r))) color = '#EA4335'; // Red

                dataArr.push([
                    r.average_organic_rank, 
                    r.click_share, 
                    `point { fill-color: ${color}; }`,
                    `${getBrand(r)} (Rank: ${r.average_organic_rank.toFixed(1)}, Share: ${(r.click_share*100).toFixed(1)}%)`
                ]);
            });

            const data = google.visualization.arrayToDataTable(dataArr);
            const options = {
                hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 }, // Invert X axis
                vAxis: { title: 'Click Share', format: '#%' },
                legend: { position: 'none' },
                colors: ['#4285F4']
            };

            new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(data, options);
        }

        function generateInsights() {
            // Key Insights
            const lastWeek = sortedWeeks[sortedWeeks.length - 1];
            const ourRows = marketData.filter(r => r.is_yaba_asin === 'Y' && r.week_date === lastWeek);
            const avgRank = ourRows.reduce((a,b)=>a+b.average_organic_rank,0)/ourRows.length;
            
            const insights = [
                `Current Organic Rank average is <strong>${avgRank.toFixed(1)}</strong> across keywords.`,
                `Identified <strong>${topCompetitors[0]}</strong> as the primary threat with highest share overlap.`,
                `Price positioning: We are competing in the $40-$60 range against premium competitors at $100+.`,
                `Efficiency: Our ASIN shows strong share retention when ranked in top 5 positions.`,
                `Market Volatility: Competitors heavily utilized "Best Seller" badges in recent weeks.`
            ];
            
            document.getElementById('final-insights-list').innerHTML = insights.map(i => `<li>${i}</li>`).join('');

            // Actions
            const actions = [
                `<strong>Defend Top Keywords:</strong> Increase bid aggression on generic terms where rank > 5.`,
                `<strong>Price Strategy:</strong> Maintain current price gap vs ${topCompetitors[0]} to capture value-conscious traffic.`,
                `<strong>Conversion:</strong> Activate Coupons (5%) next week to counter competitor Deal frequency.`
            ];
            document.getElementById('final-actions-list').innerHTML = actions.map(i => `<li>${i}</li>`).join('');
        }

        // ------------------------------------------------------------------
        // 4. INTERACTIVE LOGIC
        // ------------------------------------------------------------------

        function switchTab(tabId) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            // Re-render hidden charts to fix dimension bugs
            if (tabId === 'interactive') updateComparator(); 
            event.currentTarget.classList.add('active');
        }

        function initComparator() {
            // Populate Selects
            const weekSel = document.getElementById('comp-week-select');
            sortedWeeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.appendChild(opt);
            });
            weekSel.value = sortedWeeks[sortedWeeks.length-1]; // Select last

            const compSel = document.getElementById('comp-competitor-select');
            topCompetitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                compSel.appendChild(opt);
            });
        }

        function updateComparator() {
            const week = document.getElementById('comp-week-select').value;
            const comp = document.getElementById('comp-competitor-select').value;
            
            // Filter Data
            const ourData = marketData.filter(r => r.week_date === week && r.is_yaba_asin === 'Y');
            const theirData = marketData.filter(r => r.week_date === week && getBrand(r) === comp);

            // Calculate Metrics (Weighted Avg)
            const getAvg = (data, key) => {
                if (!data.length) return 0;
                return data.reduce((a,b) => a + b[key], 0) / data.length;
            };

            const ourPrice = getAvg(ourData, 'price');
            const theirPrice = getAvg(theirData, 'price');
            const ourShare = getAvg(ourData, 'click_share');
            const theirShare = getAvg(theirData, 'click_share');

            // Update DOM
            document.getElementById('comp-our-price').innerText = '$' + ourPrice.toFixed(2);
            document.getElementById('comp-their-price').innerText = '$' + theirPrice.toFixed(2);
            const gap = (ourShare - theirShare) * 100;
            const gapEl = document.getElementById('comp-share-gap');
            gapEl.innerText = gap.toFixed(1) + ' pts';
            gapEl.style.color = gap > 0 ? 'var(--success-color)' : 'var(--danger-color)';

            // Draw Bar Chart
            const data = google.visualization.arrayToDataTable([
                ['Metric', 'Us', comp],
                ['Click Share', ourShare, theirShare],
                ['Impression Share', getAvg(ourData, 'impression_share'), getAvg(theirData, 'impression_share')]
            ]);

            const options = {
                bars: 'horizontal',
                colors: ['#4285F4', '#EA4335'],
                hAxis: { format: '#%' }
            };

            new google.charts.Bar(document.getElementById('chart_comparator_bar')).draw(data, google.charts.Bar.convertOptions(options));
        }

    </script>
</body>
</html>