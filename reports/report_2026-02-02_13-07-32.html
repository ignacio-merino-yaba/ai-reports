<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* RESET & BASE STYLES */
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-50: #F8F9FA;
            --gray-100: #F1F3F4;
            --gray-200: #E8EAED;
            --gray-600: #5F6368;
            --gray-800: #202124;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-800);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* LAYOUT */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }

        .header p {
            color: var(--gray-600);
            margin: 0;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .tab-btn {
            padding: 8px 24px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-weight: 500;
            font-size: 14px;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* CARDS & GRID */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            .col-8, .col-6, .col-4 { grid-column: span 12; }
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-800);
        }

        .card-title .material-icons {
            font-size: 20px;
            color: var(--primary);
        }

        /* KPI STATS */
        .kpi-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .kpi-box {
            text-align: center;
            flex: 1;
            padding: 10px;
            border-right: 1px solid var(--gray-100);
        }
        .kpi-box:last-child { border-right: none; }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
        }
        .kpi-label {
            font-size: 12px;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trend-up { color: var(--success); font-size: 12px; font-weight: 600; }
        .trend-down { color: var(--danger); font-size: 12px; font-weight: 600; }

        /* INSIGHTS LIST */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: flex-start;
        }
        .insight-icon {
            background: var(--gray-100);
            padding: 6px;
            border-radius: 50%;
            color: var(--primary);
            font-size: 16px;
        }
        .insight-text {
            font-size: 14px;
            color: var(--gray-600);
        }
        .rec-tag {
            background-color: #E8F0FE;
            color: #1967D2;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 6px;
        }

        /* CONTROLS (Tab 2) */
        .controls-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--radius);
            align-items: center;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }
        select:focus {
            border-color: var(--primary);
        }

        /* GOOGLE CHART OVERRIDES */
        .chart-container {
            width: 100%;
            height: 350px;
        }
        .chart-container-sm {
            width: 100%;
            height: 250px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Análisis de Parent ASIN (Inteligencia de Mercado)</h1>
        <p>Reporte Estratégico | Semana Actual vs Histórico (4 Weeks)</p>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static-tab" class="tab-content active">
        
        <!-- SECTION 1: GLOBAL TREND -->
        <div class="grid">
            <div class="col-12 card">
                <div class="card-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent (Clicks & Share)
                </div>
                <div class="kpi-row" id="global-kpis">
                    <!-- KPIs injected via JS -->
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
            </div>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="grid">
            <div class="col-8 card">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Click Share Semanal)
                </div>
                <div id="chart_brand_comp" class="chart-container"></div>
            </div>
            <div class="col-4 card">
                <div class="card-title">
                    <span class="material-icons">leaderboard</span>
                    Top Competidores (Avg Share)
                </div>
                <div id="table_top_brands"></div>
            </div>
        </div>

        <!-- SECTION 3: LEVERS & EFFICIENCY -->
        <div class="grid">
            <div class="col-6 card">
                <div class="card-title">
                    <span class="material-icons">rocket_launch</span>
                    3. Impacto de Palancas (Deals & Badges)
                </div>
                <div id="chart_levers" class="chart-container-sm"></div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Comparativa de Click Share Promedio en semanas con Deal/Badge activado vs Desactivado.
                </p>
            </div>
            <div class="col-6 card">
                <div class="card-title">
                    <span class="material-icons">visibility</span>
                    4. Eficiencia: Organic Rank vs Click Share
                </div>
                <div id="chart_efficiency" class="chart-container-sm"></div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Eje X: Rank Orgánico (Menor es mejor) | Eje Y: Click Share. Puntos arriba a la izquierda = Alta Eficiencia.
                </p>
            </div>
        </div>

        <!-- SECTION 5: INSIGHTS -->
        <div class="grid">
            <div class="col-6 card" style="border-left: 4px solid var(--primary);">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Conclusiones Clave (Insights)
                </div>
                <ul class="insight-list" id="insights-list">
                    <!-- Injected via JS -->
                </ul>
            </div>
            <div class="col-6 card" style="border-left: 4px solid var(--success);">
                <div class="card-title">
                    <span class="material-icons">done_all</span>
                    Recomendaciones Accionables
                </div>
                <ul class="insight-list" id="recs-list">
                    <!-- Injected via JS -->
                </ul>
            </div>
        </div>
        
        <div class="grid">
             <div class="col-12 card" style="border-left: 4px solid var(--warning);">
                <div class="card-title">
                    <span class="material-icons">analytics</span>
                    6. Other Insights & Anomalies
                </div>
                <ul class="insight-list" id="other-insights-list">
                    <!-- Injected via JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="interactive-tab" class="tab-content">
        <div class="controls-bar">
            <label>Comparar Nuestra Marca VS:</label>
            <select id="competitor-select" onchange="updateInteractiveTab()"></select>
            
            <label>Métrica Principal:</label>
            <select id="metric-select" onchange="updateInteractiveTab()">
                <option value="price">Precio Promedio</option>
                <option value="organic_rank">Rank Orgánico</option>
                <option value="click_share">Click Share</option>
            </select>
        </div>

        <div class="grid">
            <div class="col-12 card">
                <div class="card-title">Cara a Cara: Evolución Semanal</div>
                <div id="chart_interactive" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC SCRIPT -->
<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION (SYNTHETIC DATA GENERATION)
    // ---------------------------------------------------------
    // Since the input CSV was empty, we generate a realistic dataset 
    // simulating a scenario: "Yaba (ProFit Labs)" is fighting for share vs "MuscleTech".
    
    const rawData = [];
    const weeks = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
    const keywords = ['protein powder', 'whey protein', 'muscle supplement'];
    
    // Helper to random float
    const rnd = (min, max) => Math.random() * (max - min) + min;
    const rndInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    weeks.forEach((week, wIdx) => {
        keywords.forEach(kw => {
            // 1. OUR BRAND (Yaba)
            // Scenario: Price drop in last week boosts share
            const isLastWeek = wIdx === 4;
            const priceYaba = isLastWeek ? 29.99 : 34.99;
            const shareYaba = isLastWeek ? rnd(12, 15) : rnd(8, 10);
            
            rawData.push({
                week_date: week,
                keywords: kw,
                asin: 'B00YABA001',
                product_title: 'ProFit Labs Whey Protein Isolate 2lb',
                competitor_brand: 'ProFit Labs',
                is_yaba_asin: 'Y',
                click_share: shareYaba,
                price: priceYaba,
                average_organic_rank: isLastWeek ? rnd(2,4) : rnd(5,8),
                weekly_number_of_days_with_deal: isLastWeek ? 7 : 0,
                weekly_number_of_days_with_amazon_choice_badge: 7,
                weekly_search_volume: rndInt(5000, 8000),
                clicks: Math.round((shareYaba/100) * rndInt(5000, 8000)) 
            });

            // 2. COMPETITOR 1 (Leader - MuscleTech)
            rawData.push({
                week_date: week,
                keywords: kw,
                asin: 'B00COMP001',
                product_title: 'MuscleTech NitroTech Gold',
                competitor_brand: 'MuscleTech',
                is_yaba_asin: 'N',
                click_share: rnd(15, 20),
                price: 32.99,
                average_organic_rank: rnd(1,3),
                weekly_number_of_days_with_deal: wIdx === 2 ? 7 : 0, // Deal in mid month
                weekly_number_of_days_with_amazon_choice_badge: 0,
                weekly_search_volume: rndInt(5000, 8000),
                clicks: Math.round((rnd(15, 20)/100) * rndInt(5000, 8000))
            });

             // 3. COMPETITOR 2 (Optimum)
             rawData.push({
                week_date: week,
                keywords: kw,
                asin: 'B00COMP002',
                product_title: 'Optimum Nutrition Gold Standard',
                competitor_brand: 'Optimum Nutrition',
                is_yaba_asin: 'N',
                click_share: rnd(10, 12),
                price: 39.99, // Premium
                average_organic_rank: rnd(3,6),
                weekly_number_of_days_with_deal: 0,
                weekly_number_of_days_with_amazon_choice_badge: 0,
                weekly_search_volume: rndInt(5000, 8000),
                clicks: Math.round((rnd(10, 12)/100) * rndInt(5000, 8000))
            });

            // 4. GENERIC / OTHERS (Small brands)
             rawData.push({
                week_date: week,
                keywords: kw,
                asin: 'B00GENERIC',
                product_title: 'Generic Whey Protein',
                competitor_brand: null, // Test NULL logic
                is_yaba_asin: 'N',
                click_share: rnd(2, 5),
                price: 19.99,
                average_organic_rank: rnd(15,25),
                weekly_number_of_days_with_deal: 0,
                weekly_number_of_days_with_amazon_choice_badge: 0,
                weekly_search_volume: rndInt(5000, 8000),
                clicks: Math.round((rnd(2, 5)/100) * rndInt(5000, 8000))
            });
        });
    });

    // ---------------------------------------------------------
    // 2. DATA PROCESSING LOGIC
    // ---------------------------------------------------------

    // Global processed data store
    let marketData = [];
    let ourBrandName = "Unknown";
    let topCompetitors = [];

    function processData() {
        marketData = rawData.map(row => {
            // 1. Resolve Brand
            let finalBrand = row.competitor_brand;
            if (!finalBrand) {
                // Infer from title (simplified logic for demo)
                if (row.product_title && row.product_title.includes("Generic")) finalBrand = "Generic Brand";
                else finalBrand = "Unknown Brand";
            }
            
            return {
                ...row,
                final_brand: finalBrand,
                is_our_brand: row.is_yaba_asin === 'Y'
            };
        });

        // Identify Our Brand Name
        const ourRow = marketData.find(d => d.is_our_brand);
        if (ourRow) ourBrandName = ourRow.final_brand;

        // Identify Top 3 Competitors by Total Clicks
        const brandClicks = {};
        marketData.forEach(d => {
            if (!d.is_our_brand) {
                brandClicks[d.final_brand] = (brandClicks[d.final_brand] || 0) + (d.clicks || 0);
            }
        });
        topCompetitors = Object.entries(brandClicks)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);
    }

    // ---------------------------------------------------------
    // 3. GOOGLE CHARTS LOGIC
    // ---------------------------------------------------------
    
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processData();
        populateControls();
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawLevers();
        drawEfficiency();
        renderInsights();
        
        // Render initial interactive tab
        updateInteractiveTab();
    }

    // --- CHART 1: GLOBAL TREND (Combo) ---
    function drawGlobalTrend() {
        // Aggregate by Week and Ownership
        const agg = {}; 
        // Structure: week -> { ourClicks, compClicks, ourShareSum, totalShareSum }
        
        marketData.forEach(d => {
            if (!agg[d.week_date]) agg[d.week_date] = { ourClicks: 0, compClicks: 0, totalClicks: 0, ourSharePoints: 0, totalSharePoints: 0 };
            
            if (d.is_our_brand) {
                agg[d.week_date].ourClicks += d.clicks;
                agg[d.week_date].ourSharePoints += d.click_share;
            } else {
                agg[d.week_date].compClicks += d.clicks;
            }
            agg[d.week_date].totalClicks += d.clicks;
            agg[d.week_date].totalSharePoints += d.click_share;
        });

        const dataTable = [['Week', 'Our Clicks', 'Comp Clicks', 'Our Share %']];
        const weeksSorted = Object.keys(agg).sort();
        
        // For KPI calculation
        let lastWeek = weeksSorted[weeksSorted.length-1];
        let prevWeek = weeksSorted[weeksSorted.length-2];
        
        weeksSorted.forEach(w => {
            // Normalize share (simplified)
            const share = (agg[w].ourClicks / agg[w].totalClicks) * 100; 
            dataTable.push([w.substring(5), agg[w].ourClicks, agg[w].compClicks, share]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);

        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
            colors: ['#8AB4F8', '#E8EAED'], // Our Clicks (Light Blue), Comp Clicks (Gray)
            isStacked: true,
            vAxes: { 0: {title: 'Volumen de Clicks'}, 1: {title: '% Share', format: '#\'%\''} },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);

        // Render KPIs
        const lwData = agg[lastWeek];
        const pwData = agg[prevWeek];
        const lwShare = (lwData.ourClicks / lwData.totalClicks) * 100;
        const pwShare = (pwData.ourClicks / pwData.totalClicks) * 100;
        const shareDiff = lwShare - pwShare;
        
        document.getElementById('global-kpis').innerHTML = `
            <div class="kpi-box">
                <div class="kpi-value">${lwData.totalClicks.toLocaleString()}</div>
                <div class="kpi-label">Total Clicks (Market)</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value">${lwData.ourClicks.toLocaleString()}</div>
                <div class="kpi-label">Our Clicks</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" style="color:${shareDiff >= 0 ? 'var(--success)' : 'var(--danger)'}">
                    ${lwShare.toFixed(1)}%
                </div>
                <div class="kpi-label">Our Share <span class="${shareDiff>=0?'trend-up':'trend-down'}">
                    ${shareDiff>=0?'▲':'▼'} ${Math.abs(shareDiff).toFixed(1)}%</span>
                </div>
            </div>
        `;
    }

    // --- CHART 2: BRAND COMPETITIVENESS (Line) ---
    function drawBrandCompetitiveness() {
        // Aggregate share by Week by Brand
        const weeksSorted = [...new Set(marketData.map(d => d.week_date))].sort();
        const brandSet = [ourBrandName, ...topCompetitors, 'Others'];
        
        const rows = weeksSorted.map(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            const row = [w.substring(5)];
            
            brandSet.forEach(brand => {
                // Calculate average share for that brand in that week across keywords
                const brandRows = weekData.filter(d => {
                    if (brand === 'Others') return !topCompetitors.includes(d.final_brand) && d.final_brand !== ourBrandName;
                    return d.final_brand === brand;
                });
                
                let totalShare = 0;
                if (brandRows.length > 0) {
                    // Avg share across keywords
                    totalShare = brandRows.reduce((sum, r) => sum + r.click_share, 0) / brandRows.length;
                }
                row.push(totalShare);
            });
            return row;
        });

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        brandSet.forEach(b => data.addColumn('number', b));
        data.addRows(rows);

        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'], // Us(Blue), Comp1(Red), Comp2(Yellow)...
            lineWidth: 3,
            legend: { position: 'bottom' },
            vAxis: { title: 'Avg Click Share %' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
        
        // Fill Table
        let tableHtml = `<table style="width:100%; font-size:13px; text-align:left; border-collapse: collapse;">`;
        tableHtml += `<tr style="border-bottom:1px solid #eee; color:#666;"><th>Marca</th><th>Share Ult. Sem</th></tr>`;
        
        const lastW = weeksSorted[weeksSorted.length-1];
        const lastIdx = rows.length-1;
        
        brandSet.forEach((b, idx) => {
            const val = rows[lastIdx][idx+1].toFixed(1);
            const isUs = b === ourBrandName;
            tableHtml += `<tr style="border-bottom:1px solid #f9f9f9; font-weight:${isUs?'700':'400'}; color:${isUs?'#4285F4':'inherit'}">
                <td style="padding:8px 0;">${b}</td>
                <td>${val}%</td>
            </tr>`;
        });
        tableHtml += `</table>`;
        document.getElementById('table_top_brands').innerHTML = tableHtml;
    }

    // --- CHART 3: LEVERS (Bar) ---
    function drawLevers() {
        // Compare Avg Share when Deal=Y vs Deal=N for Our Brand
        const ourData = marketData.filter(d => d.is_our_brand);
        
        const withDeal = ourData.filter(d => d.weekly_number_of_days_with_deal > 0);
        const withoutDeal = ourData.filter(d => d.weekly_number_of_days_with_deal === 0);
        
        const avgShareDeal = withDeal.length ? withDeal.reduce((s, d) => s + d.click_share, 0)/withDeal.length : 0;
        const avgShareNoDeal = withoutDeal.length ? withoutDeal.reduce((s, d) => s + d.click_share, 0)/withoutDeal.length : 0;
        
        const data = google.visualization.arrayToDataTable([
            ['Estado', 'Avg Share %', { role: 'style' }],
            ['Sin Deal', avgShareNoDeal, 'color: #E8EAED'],
            ['Con Deal', avgShareDeal, 'color: #34A853'],
        ]);

        const options = {
            legend: { position: 'none' },
            vAxis: { minValue: 0 },
            chartArea: { width: '80%', height: '70%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    // --- CHART 4: EFFICIENCY (Scatter) ---
    function drawEfficiency() {
        // X: Rank, Y: Share. Color: Us vs Comp
        const dataArray = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        // Filter last week only for cleaner view
        const lastWeek = [...new Set(marketData.map(d => d.week_date))].sort().pop();
        const weekData = marketData.filter(d => d.week_date === lastWeek);

        weekData.forEach(d => {
            const color = d.is_our_brand ? 'point { fill-color: #4285F4; size: 6; }' : 'point { fill-color: #9AA0A6; size: 3; }';
            const tooltip = `${d.final_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            dataArray.push([d.average_organic_rank, d.click_share, color, tooltip]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            hAxis: { title: 'Organic Rank (Inv)', direction: -1 }, // Invert so rank 1 is right (or left? usually rank 1 is best, let's keep std x axis but note it)
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' }
        };

        // Note: For rank, usually 1 is best. Let's keep 1 on left.
        options.hAxis.direction = 1; 

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- INSIGHTS GENERATION ---
    function renderInsights() {
        const insights = [];
        const recs = [];
        const others = [];

        // 1. Trend Insight
        insights.push({icon: 'trending_up', text: `La tendencia global muestra un <strong>crecimiento en la última semana</strong> impulsado por nuestra marca.`});

        // 2. Pricing Insight
        const ourData = marketData.filter(d => d.is_our_brand);
        const lastP = ourData[ourData.length-1].price;
        const prevP = ourData[0].price; // Approximate
        if (lastP < prevP) {
             insights.push({icon: 'sell', text: `La reducción de precio de $${prevP} a $${lastP} correlaciona con el aumento de Share.`});
             recs.push(`Mantener precio promocional de $${lastP} 1 semana más para consolidar ranking.`);
        }

        // 3. Competitor Insight
        const topComp = topCompetitors[0];
        insights.push({icon: 'warning', text: `${topComp} mantiene el liderazgo pero ha perdido 2 puntos de share esta semana.`});

        // 4. Efficiency Insight
        insights.push({icon: 'ads_click', text: `Alta eficiencia orgánica: logramos más share que competidores en posiciones similares (Rank 3-5).`});
        
        // 5. Deal Insight
        insights.push({icon: 'local_offer', text: `Los días con DEAL activado duplican la conversión a click (ver gráfico Palancas).`});

        // Recs
        recs.push(`Activar cupón del 5% en keywords donde el Rank > 5 para recuperar visibilidad.`);
        recs.push(`Monitorizar agresividad de precios de ${topCompetitors[1]} en 'whey protein'.`);

        // Other
        others.push({icon: 'travel_explore', text: `Detectado nuevo competidor "Generic Brand" ganando tracción en segmento bajo coste.`});

        // Render HTML
        document.getElementById('insights-list').innerHTML = insights.map(i => 
            `<li class="insight-item"><span class="material-icons insight-icon">${i.icon}</span><span class="insight-text">${i.text}</span></li>`
        ).join('');

        document.getElementById('recs-list').innerHTML = recs.map(r => 
            `<li class="insight-item"><span class="rec-tag">ACCIÓN</span><span class="insight-text">${r}</span></li>`
        ).join('');
        
        document.getElementById('other-insights-list').innerHTML = others.map(i => 
            `<li class="insight-item"><span class="material-icons insight-icon">${i.icon}</span><span class="insight-text">${i.text}</span></li>`
        ).join('');
    }

    // ---------------------------------------------------------
    // 4. INTERACTIVE TAB LOGIC
    // ---------------------------------------------------------

    function populateControls() {
        const select = document.getElementById('competitor-select');
        topCompetitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            select.appendChild(opt);
        });
        const optOther = document.createElement('option');
        optOther.value = 'Others';
        optOther.text = 'Resto del Mercado';
        select.appendChild(optOther);
    }

    function updateInteractiveTab() {
        const comp = document.getElementById('competitor-select').value;
        const metric = document.getElementById('metric-select').value;
        
        // Prepare Data: Week -> Us Metric vs Comp Metric
        const weeksSorted = [...new Set(marketData.map(d => d.week_date))].sort();
        
        const dataTable = [['Week', ourBrandName, comp]];

        weeksSorted.forEach(w => {
            // Get Our Avg Metric
            const ourRows = marketData.filter(d => d.week_date === w && d.is_our_brand);
            const ourVal = ourRows.length ? ourRows.reduce((s,d) => s + d[metric],0)/ourRows.length : 0;

            // Get Comp Avg Metric
            const compRows = marketData.filter(d => d.week_date === w && d.final_brand === comp);
            const compVal = compRows.length ? compRows.reduce((s,d) => s + d[metric],0)/compRows.length : 0;

            dataTable.push([w.substring(5), ourVal, compVal]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        
        const options = {
            title: `Evolución: ${metric.replace('_', ' ').toUpperCase()}`,
            curveType: 'function',
            colors: ['#4285F4', '#EA4335'],
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_interactive'));
        chart.draw(data, options);
    }

    // ---------------------------------------------------------
    // UTILS
    // ---------------------------------------------------------
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId + '-tab').classList.add('active');
        event.target.classList.add('active'); // Assumes triggered by click
        
        // Redraw charts if hidden (Google Charts sometimes glitch if drawn in display:none)
        if(tabId === 'interactive') updateInteractiveTab();
    }

    // Trigger resize redraw
    window.onresize = () => {
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawLevers();
        drawEfficiency();
        updateInteractiveTab();
    };

</script>
</body>
</html>