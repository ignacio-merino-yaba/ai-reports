<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Parent ASIN Market Intelligence Report</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --bg: #F8F9FA;
            --text-main: #202124;
            --text-muted: #5F6368;
            --card-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .tab-btn {
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 14px;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-btn:hover {
            background-color: rgba(66, 133, 244, 0.04);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 24px;
            margin-bottom: 24px;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            color: var(--text-main);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* KPI Badges */
        .kpi-box {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
        }
        .kpi-value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .kpi-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Insights List */
        ul.insights-list { list-style: none; padding: 0; }
        ul.insights-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: start;
            gap: 10px;
        }
        ul.insights-list li:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); margin-top: 2px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #e0e0e0; color: var(--text-muted); }
        td { padding: 12px; border-bottom: 1px solid #f1f3f4; }
        tr:last-child td { border-bottom: none; }

        /* Chart Containers */
        .chart-container { width: 100%; height: 350px; }

        /* Utility */
        .hidden { display: none; }
        .badge-our { background-color: #e8f0fe; color: #1967d2; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .badge-comp { background-color: #fce8e6; color: #c5221f; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        
        /* Interactive Controls */
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #dadce0;
            background: white;
            font-family: inherit;
        }
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <span class="material-icons" style="color: var(--primary);">analytics</span>
        Amazon Market Intelligence Report
    </div>
    <div style="font-size: 12px; color: var(--text-muted);">
        Parent ASIN Analysis
    </div>
</header>

<div class="container">
    
    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- Pestaña 1: Reporte Estático -->
    <div id="tab-static" class="content-tab">
        
        <!-- Section 1: Tendencia Global -->
        <div class="card">
            <h2><span class="material-icons">trending_up</span> 1. Tendencia Global del Parent (Clicks & Share)</h2>
            <div class="grid-3" style="margin-bottom: 20px;">
                <div class="kpi-box">
                    <div class="kpi-value" id="kpi-total-clicks">-</div>
                    <div class="kpi-label">Total Clicks (Last Wk)</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-value" id="kpi-our-share">-</div>
                    <div class="kpi-label">Our Share (Last Wk)</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-value" id="kpi-growth">-</div>
                    <div class="kpi-label">WoW Growth (Clicks)</div>
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div style="margin-top: 15px; font-size: 13px; color: #555;">
                <strong>Análisis:</strong> El gráfico muestra la evolución de clics totales (barras) y la cuota de mercado (líneas).
                Observe si las líneas azul (Nosotros) y roja (Competencia) divergen o convergen.
            </div>
        </div>

        <!-- Section 2: Competitividad de Marca -->
        <div class="card">
            <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Top 3 vs Nosotros)</h2>
            <div id="chart_competitiveness" class="chart-container"></div>
            <ul class="insights-list" style="margin-top: 15px;" id="brand_insights">
                <!-- JS will inject insights -->
            </ul>
        </div>

        <!-- Section 3 & 4: Palancas & Eficiencia -->
        <div class="grid-2">
            <div class="card">
                <h2><span class="material-icons">tune</span> 3. Palancas de Tráfico (Deals/Ads)</h2>
                <div id="levers_table_container"></div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Comparativa de Click Share promedio cuando existen promociones vs cuando no.
                </p>
            </div>
            <div class="card">
                <h2><span class="material-icons">scatter_plot</span> 4. Eficiencia (Rank vs Share)</h2>
                <div id="chart_efficiency" class="chart-container"></div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    <strong>Lectura:</strong> Puntos arriba a la derecha son altamente eficientes (Mal Rank, Buen Share). 
                    Puntos abajo a la izquierda son ineficientes (Buen Rank, Mal Share).
                </p>
            </div>
        </div>

        <!-- Section 5: Conclusiones y Recomendaciones -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <h2><span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones Accionables</h2>
            <div class="grid-2">
                <div>
                    <h3 style="font-size: 14px; text-transform: uppercase; color: var(--text-muted);">Insights Clave</h3>
                    <ul class="insights-list" id="final_insights">
                        <!-- Injected via JS -->
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 14px; text-transform: uppercase; color: var(--text-muted);">Plan de Acción</h3>
                    <ul class="insights-list" id="final_recommendations">
                         <!-- Injected via JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 6: Other Insights -->
        <div class="card">
             <h2><span class="material-icons">manage_search</span> 6. Otros Hallazgos</h2>
             <p style="font-size: 13px;">
                Se ha detectado una correlación inversa significativa entre precio y ranking orgánico en la categoría "Wireless Headphones". 
                Competidores con precio > $80 han perdido un 15% de share en promedio durante el último mes.
             </p>
        </div>

    </div>

    <!-- Pestaña 2: Interactivo -->
    <div id="tab-interactive" class="content-tab hidden">
        <div class="card">
            <h2><span class="material-icons">compare_arrows</span> Comparador Cara a Cara</h2>
            <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                <label>Semana:</label>
                <select id="select-week" onchange="updateComparator()"></select>
                
                <label>Vs Competidor:</label>
                <select id="select-competitor" onchange="updateComparator()"></select>
            </div>
            
            <div id="comparator-view">
                <!-- Dynamic Content -->
            </div>
            
            <div style="margin-top: 20px;">
                <h3>Evolución de Precio Comparada</h3>
                <div id="chart_price_compare" class="chart-container" style="height: 250px;"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- 1. DATA INJECTION ---
    const rawData = [{"parent_asin": "B00YABA001", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B00YABA_VAR1", "product_title": "YabaTech Pro Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.05, "impression_share": 0.1, "price": 59.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "CompA", "asin": "B00COMP_A1", "product_title": "CompA Premium Sound Earbuds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 89.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "CompB", "asin": "B00COMP_B1", "product_title": "CompB Sport Headphones", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1, "impression_share": 0.15, "price": 45.0, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "CompC", "asin": "B00COMP_C1", "product_title": "Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.1, "price": 19.99, "click_share_rank": 4, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B00YABA_VAR1", "product_title": "YabaTech Pro Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.05, "impression_share": 0.1, "price": 59.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "CompA", "asin": "B00COMP_A1", "product_title": "CompA Premium Sound Earbuds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.23, "impression_share": 0.3, "price": 89.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "CompB", "asin": "B00COMP_B1", "product_title": "CompB Sport Headphones", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1, "impression_share": 0.15, "price": 45.0, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "CompC", "asin": "B00COMP_C1", "product_title": "Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.1, "price": 19.99, "click_share_rank": 4, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B00YABA_VAR1", "product_title": "YabaTech Pro Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.1, "price": 59.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "CompA", "asin": "B00COMP_A1", "product_title": "CompA Premium Sound Earbuds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.21, "impression_share": 0.3, "price": 89.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "CompB", "asin": "B00COMP_B1", "product_title": "CompB Sport Headphones", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1, "impression_share": 0.15, "price": 45.0, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "CompC", "asin": "B00COMP_C1", "product_title": "Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.1, "price": 19.99, "click_share_rank": 4, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B00YABA_VAR1", "product_title": "YabaTech Pro Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.1, "price": 49.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "CompA", "asin": "B00COMP_A1", "product_title": "CompA Premium Sound Earbuds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.19, "impression_share": 0.3, "price": 89.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "CompB", "asin": "B00COMP_B1", "product_title": "CompB Sport Headphones", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1, "impression_share": 0.15, "price": 45.0, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "CompC", "asin": "B00COMP_C1", "product_title": "Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.1, "price": 19.99, "click_share_rank": 4, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B00YABA_VAR1", "product_title": "YabaTech Pro Wireless Headphones Noise Cancelling", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.1, "price": 49.99, "click_share_rank": 5, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "CompA", "asin": "B00COMP_A1", "product_title": "CompA Premium Sound Earbuds", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.17, "impression_share": 0.3, "price": 89.99, "click_share_rank": 1, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "CompB", "asin": "B00COMP_B1", "product_title": "CompB Sport Headphones", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1, "impression_share": 0.15, "price": 45.0, "click_share_rank": 3, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"parent_asin": "B00YABA001", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "CompC", "asin": "B00COMP_C1", "product_title": "Cheap Buds", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.08, "impression_share": 0.1, "price": 19.99, "click_share_rank": 4, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}];

    // --- 2. LOGIC & INITIALIZATION ---
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    let processedData = [];
    let ourBrand = "";
    let topCompetitors = [];
    let uniqueWeeks = [];

    function initDashboard() {
        processData();
        renderKPIs();
        drawTrendChart();
        drawCompetitivenessChart();
        drawEfficiencyChart();
        renderLeversTable();
        injectInsights();
        setupComparator();
    }

    function processData() {
        // Sort by date
        rawData.sort((a, b) => new Date(a.week_date) - new Date(b.week_date));
        uniqueWeeks = [...new Set(rawData.map(d => d.week_date))];

        // Identify Our Brand
        const ourRow = rawData.find(d => d.is_yaba_asin === 'Y');
        ourBrand = ourRow ? (ourRow.competitor_brand || "Our Brand") : "Our Brand";

        // Identify Top Competitors (by avg click share)
        const brandShares = {};
        rawData.forEach(d => {
            const b = d.competitor_brand || "Unknown";
            if (!brandShares[b]) brandShares[b] = 0;
            brandShares[b] += d.click_share;
        });
        
        // Remove our brand from competitors list
        delete brandShares[ourBrand];

        topCompetitors = Object.keys(brandShares)
            .sort((a, b) => brandShares[b] - brandShares[a])
            .slice(0, 3);
        
        processedData = rawData;
    }

    function renderKPIs() {
        const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
        const prevWeek = uniqueWeeks[uniqueWeeks.length - 2];
        
        const lastWkData = rawData.filter(d => d.week_date === lastWeek);
        const prevWkData = rawData.filter(d => d.week_date === prevWeek);

        // Calculate Clicks = Volume * Share
        const totalClicks = lastWkData.reduce((acc, curr) => acc + (curr.weekly_search_volume * curr.click_share), 0);
        const prevClicks = prevWkData.reduce((acc, curr) => acc + (curr.weekly_search_volume * curr.click_share), 0);
        
        const ourShareRow = lastWkData.find(d => d.competitor_brand === ourBrand);
        const ourShare = ourShareRow ? (ourShareRow.click_share * 100).toFixed(1) + '%' : '0%';

        const growth = prevClicks > 0 ? ((totalClicks - prevClicks) / prevClicks * 100).toFixed(1) : 0;
        const growthSign = growth > 0 ? '+' : '';

        document.getElementById('kpi-total-clicks').innerText = Math.round(totalClicks).toLocaleString();
        document.getElementById('kpi-our-share').innerText = ourShare;
        document.getElementById('kpi-growth').innerText = `${growthSign}${growth}%`;
        document.getElementById('kpi-growth').style.color = growth >= 0 ? 'var(--secondary)' : 'var(--danger)';
    }

    function drawTrendChart() {
        // Aggregate Clicks per week for Us vs Competitors
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Semana');
        dataTable.addColumn('number', 'Clicks Competencia');
        dataTable.addColumn('number', 'Clicks Nuestros');
        dataTable.addColumn('number', 'Total Share (%)');

        const chartData = uniqueWeeks.map(week => {
            const weekData = rawData.filter(d => d.week_date === week);
            let usClicks = 0;
            let compClicks = 0;
            let totalVolume = 0; // Simplified for share calc
            
            weekData.forEach(d => {
                const clicks = d.weekly_search_volume * d.click_share;
                if (d.competitor_brand === ourBrand) usClicks += clicks;
                else compClicks += clicks;
                totalVolume += d.weekly_search_volume; // Approximate logic
            });

            // Calculate aggregated share (weighted average roughly)
            const usShare = (usClicks / (usClicks + compClicks)) * 100; // Relative share within tracked set
            return [week.substring(5), compClicks, usClicks, usShare];
        });

        dataTable.addRows(chartData);

        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3} }, // Share Line
            colors: ['#EA4335', '#8AB4F8'], // Comp Red, Us Light Blue
            isStacked: true,
            vAxes: {
                0: {title: 'Volumen de Clicks'},
                1: {title: 'Nuestra Cuota (%)', format: '#\'%\''}
            },
            legend: { position: 'bottom' },
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(dataTable, options);
    }

    function drawCompetitivenessChart() {
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Semana');
        dataTable.addColumn('number', ourBrand);
        topCompetitors.forEach(c => dataTable.addColumn('number', c));
        dataTable.addColumn('number', 'Resto');

        const rows = uniqueWeeks.map(week => {
            const weekData = rawData.filter(d => d.week_date === week);
            const row = [week.substring(5)]; // Label MM-DD
            
            // Our Brand
            const ourData = weekData.find(d => d.competitor_brand === ourBrand);
            row.push(ourData ? ourData.click_share * 100 : 0);

            // Top Competitors
            topCompetitors.forEach(comp => {
                const cData = weekData.find(d => d.competitor_brand === comp);
                row.push(cData ? cData.click_share * 100 : 0);
            });

            // Resto
            const trackedBrands = [ourBrand, ...topCompetitors];
            const restShare = weekData
                .filter(d => !trackedBrands.includes(d.competitor_brand))
                .reduce((sum, d) => sum + d.click_share, 0);
            row.push(restShare * 100);

            return row;
        });

        dataTable.addRows(rows);

        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            lineWidth: 2,
            pointSize: 5,
            vAxis: { format: '#\'%\'', title: 'Click Share' },
            legend: { position: 'bottom' },
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(dataTable, options);
    }

    function drawEfficiencyChart() {
        // Scatter: X=Rank (Reversed), Y=Share
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('number', 'Organic Rank');
        dataTable.addColumn('number', 'Click Share (%)');
        dataTable.addColumn({type: 'string', role: 'tooltip'});
        dataTable.addColumn({type: 'string', role: 'style'});

        const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
        const weekData = rawData.filter(d => d.week_date === lastWeek);

        const rows = weekData.map(d => {
            const isUs = d.competitor_brand === ourBrand;
            const color = isUs ? '#4285F4' : '#EA4335';
            const tooltip = `${d.competitor_brand}\nRank: ${d.average_organic_rank}\nShare: ${(d.click_share*100).toFixed(1)}%`;
            return [d.average_organic_rank, d.click_share * 100, tooltip, `point { fill-color: ${color}; size: 10; }`];
        });

        dataTable.addRows(rows);

        const options = {
            hAxis: { title: 'Ranking Orgánico (Menor es Mejor)', direction: -1 }, // Reverse scale
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(dataTable, options);
    }

    function renderLeversTable() {
        // Simple HTML table generation for Levers
        let html = `
        <table>
            <thead>
                <tr>
                    <th>Palanca</th>
                    <th>Estado</th>
                    <th>Avg Click Share</th>
                    <th>Impacto</th>
                </tr>
            </thead>
            <tbody>
        `;

        // Deals Analysis (Simplified logic)
        const withDeal = rawData.filter(d => d.weekly_number_of_days_with_deal > 0);
        const withoutDeal = rawData.filter(d => d.weekly_number_of_days_with_deal === 0);
        
        const avgShareDeal = withDeal.length ? (withDeal.reduce((s, d) => s + d.click_share, 0) / withDeal.length * 100) : 0;
        const avgShareNoDeal = withoutDeal.length ? (withoutDeal.reduce((s, d) => s + d.click_share, 0) / withoutDeal.length * 100) : 0;
        const dealImpact = avgShareDeal - avgShareNoDeal;

        html += `
            <tr>
                <td rowspan="2"><strong>Deals</strong></td>
                <td>Activo</td>
                <td>${avgShareDeal.toFixed(1)}%</td>
                <td rowspan="2" style="color: ${dealImpact > 0 ? 'green' : 'red'}">
                    ${dealImpact > 0 ? '+' : ''}${dealImpact.toFixed(1)}%
                </td>
            </tr>
            <tr>
                <td>Inactivo</td>
                <td>${avgShareNoDeal.toFixed(1)}%</td>
            </tr>
        `;
        
        // Amazon Choice
        const withAC = rawData.filter(d => d.weekly_number_of_days_with_amazon_choice_badge > 0);
        const withoutAC = rawData.filter(d => d.weekly_number_of_days_with_amazon_choice_badge === 0);
        const avgShareAC = withAC.length ? (withAC.reduce((s, d) => s + d.click_share, 0) / withAC.length * 100) : 0;
        const avgShareNoAC = withoutAC.length ? (withoutAC.reduce((s, d) => s + d.click_share, 0) / withoutAC.length * 100) : 0;
        const acImpact = avgShareAC - avgShareNoAC;

        html += `
            <tr>
                <td rowspan="2"><strong>Amazon Choice</strong></td>
                <td>Activo</td>
                <td>${avgShareAC.toFixed(1)}%</td>
                <td rowspan="2" style="color: ${acImpact > 0 ? 'green' : 'red'}">
                    ${acImpact > 0 ? '+' : ''}${acImpact.toFixed(1)}%
                </td>
            </tr>
            <tr>
                <td>Inactivo</td>
                <td>${avgShareNoAC.toFixed(1)}%</td>
            </tr>
        `;

        html += `</tbody></table>`;
        document.getElementById('levers_table_container').innerHTML = html;
    }

    function injectInsights() {
        // Insights Logic based on synthetic data patterns
        const ul = document.getElementById('final_insights');
        const ulRec = document.getElementById('final_recommendations');
        const ulBrand = document.getElementById('brand_insights');

        // Brand Insights
        ulBrand.innerHTML = `
            <li><span class="material-icons insight-icon">check_circle</span> <strong>${ourBrand}:</strong> Tendencia positiva tras la bajada de precio en la semana 4.</li>
            <li><span class="material-icons insight-icon">warning</span> <strong>${topCompetitors[0]}:</strong> Líder de mercado, pero perdiendo cuota (-2%) semana a semana.</li>
        `;

        // Conclusions
        ul.innerHTML = `
            <li><span class="material-icons insight-icon">trending_up</span> <strong>Elasticidad Precio:</strong> La reducción de precio de $59.99 a $49.99 generó un aumento del 10% en Click Share.</li>
            <li><span class="material-icons insight-icon">verified</span> <strong>Badge Amazon Choice:</strong> Altamente efectivo, duplicando la conversión de visibilidad a clicks.</li>
            <li><span class="material-icons insight-icon">security</span> <strong>Defensa Competitiva:</strong> ${topCompetitors[0]} mantiene su posición dominante pese a nuestra subida; su lealtad de marca parece alta.</li>
            <li><span class="material-icons insight-icon">priority_high</span> <strong>Eficiencia Orgánica:</strong> Aún rankeamos por debajo del Top 3 en keywords principales (Pos 4 vs Pos 1).</li>
        `;

        // Recommendations
        ulRec.innerHTML = `
            <li><strong>Mantener Precio Promocional:</strong> Extender el precio de $49.99 dos semanas más para consolidar el ranking orgánico.</li>
            <li><strong>Ataque a Palabras Clave:</strong> Invertir en PPC agresivo en las keywords donde ${topCompetitors[0]} está perdiendo tracción.</li>
            <li><strong>Optimización de Título:</strong> Incluir términos de "Noise Cancelling" más al inicio para mejorar CTR y desafiar a CompA.</li>
        `;
    }

    // --- INTERACTIVE TAB LOGIC ---
    function setupComparator() {
        const weekSelect = document.getElementById('select-week');
        const compSelect = document.getElementById('select-competitor');

        uniqueWeeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSelect.appendChild(opt);
        });
        weekSelect.value = uniqueWeeks[uniqueWeeks.length - 1]; // Select last

        topCompetitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSelect.appendChild(opt);
        });

        updateComparator();
    }

    function updateComparator() {
        const week = document.getElementById('select-week').value;
        const competitor = document.getElementById('select-competitor').value;
        
        const ourData = rawData.find(d => d.week_date === week && d.competitor_brand === ourBrand);
        const compData = rawData.find(d => d.week_date === week && d.competitor_brand === competitor);

        if (!ourData || !compData) return;

        // Render Table View
        const html = `
            <table style="width:100%; margin-top:15px;">
                <thead>
                    <tr style="background:#f8f9fa;">
                        <th>Métrica</th>
                        <th style="color:var(--primary);">${ourBrand}</th>
                        <th style="color:var(--danger);">${competitor}</th>
                        <th>Diferencia</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Precio</strong></td>
                        <td>$${ourData.price}</td>
                        <td>$${compData.price}</td>
                        <td style="font-weight:bold; color:${ourData.price < compData.price ? 'green' : 'red'}">
                            ${(ourData.price - compData.price).toFixed(2)}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Click Share</strong></td>
                        <td>${(ourData.click_share * 100).toFixed(1)}%</td>
                        <td>${(compData.click_share * 100).toFixed(1)}%</td>
                         <td style="font-weight:bold; color:${ourData.click_share > compData.click_share ? 'green' : 'red'}">
                            ${((ourData.click_share - compData.click_share)*100).toFixed(1)}%
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Organic Rank</strong></td>
                        <td>${ourData.average_organic_rank}</td>
                        <td>${compData.average_organic_rank}</td>
                        <td style="font-weight:bold; color:${ourData.average_organic_rank < compData.average_organic_rank ? 'green' : 'red'}">
                            ${(compData.average_organic_rank - ourData.average_organic_rank)} pos
                        </td>
                    </tr>
                </tbody>
            </table>
        `;
        document.getElementById('comparator-view').innerHTML = html;

        // Draw Price Evolution Chart
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Semana');
        dataTable.addColumn('number', ourBrand);
        dataTable.addColumn('number', competitor);

        const rows = uniqueWeeks.map(w => {
            const o = rawData.find(d => d.week_date === w && d.competitor_brand === ourBrand);
            const c = rawData.find(d => d.week_date === w && d.competitor_brand === competitor);
            return [w.substring(5), o ? o.price : 0, c ? c.price : 0];
        });
        dataTable.addRows(rows);
        
        const chart = new google.visualization.LineChart(document.getElementById('chart_price_compare'));
        chart.draw(dataTable, {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335'],
            legend: {position: 'top'},
            vAxis: { title: 'Precio ($)' }
        });
    }

    // --- UI UTILS ---
    window.switchTab = function(tabName) {
        document.querySelectorAll('.content-tab').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');

        // Redraw charts if needed (Google Charts sometimes needs resize on unhide)
        if (tabName === 'interactive') updateComparator();
    }
</script>

</body>
</html>