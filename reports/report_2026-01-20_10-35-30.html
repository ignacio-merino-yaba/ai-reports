<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Avanzado de Mercado: Parent ASIN</title>
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4;
            --secondary: #5f6368;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --border: #e0e0e0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: #202124;
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 700; color: #1a73e8; }
        .subtitle { color: var(--secondary); font-size: 14px; margin-top: 4px; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            background: transparent;
            border: 1px solid var(--border);
            padding: 10px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary);
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
        }

        /* Cards & Layout */
        .grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media(min-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .full-width { grid-column: 1 / -1; }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #3c4043;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        /* Text Analysis Sections */
        .analysis-text {
            font-size: 14px;
            line-height: 1.6;
            color: #474747;
            margin-top: 16px;
            padding: 16px;
            background: #fdfdfd;
            border-left: 4px solid var(--primary);
            border-radius: 0 8px 8px 0;
        }
        .highlight-positive { color: var(--success); font-weight: 700; }
        .highlight-negative { color: var(--danger); font-weight: 700; }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .stat-box {
            background: #f1f3f4;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-val { font-size: 20px; font-weight: 700; display: block; }
        .stat-label { font-size: 11px; color: var(--secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Tables (Google Charts overrides) */
        .google-visualization-table-table {
            font-family: 'Inter', sans-serif !important;
            border-collapse: separate !important;
            border-spacing: 0;
            width: 100%;
        }
        .google-visualization-table-th {
            background: #f8f9fa !important;
            color: #5f6368 !important;
            border-bottom: 2px solid var(--border) !important;
            padding: 12px !important;
            font-weight: 600 !important;
        }
        .google-visualization-table-td {
            padding: 12px !important;
            border-bottom: 1px solid var(--border) !important;
            color: #3c4043 !important;
        }

        /* Comparator Specifics */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 16px;
            border-radius: 12px;
            align-items: center;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            outline: none;
            cursor: pointer;
        }

        /* Hidden View Logic */
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* Palancas Table */
        .levers-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .levers-table th, .levers-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        .levers-table th { color: var(--secondary); font-size: 12px; text-transform: uppercase; }
        .badge-pill { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-yes { background: #e6f4ea; color: var(--success); }
        .badge-no { background: #fce8e6; color: var(--danger); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Análisis de Mercado: Matcha Premium</h1>
            <div class="subtitle">Parent ASIN Deep Dive & Competitor Benchmarking</div>
        </div>
        <div style="text-align: right;">
            <div id="report-date" style="font-weight: 600;"></div>
            <div style="font-size: 12px; color: var(--secondary);">Powered by Google Native Visualization</div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px; margin-right: 4px;">analytics</span>
            Reporte Estratégico
        </button>
        <button class="tab-btn" onclick="switchTab('comparator')">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px; margin-right: 4px;">compare_arrows</span>
            Comparador Interactivo
        </button>
    </div>

    <!-- VIEW 1: REPORTE ESTRATÉGICO -->
    <div id="report-view" class="view-section active">
        <div class="grid">
            
            <!-- 1. TENDENCIA GLOBAL -->
            <div class="card full-width">
                <div class="card-title">
                    <span class="material-icons" style="color: #4285F4;">show_chart</span>
                    1. Tendencia Global del Parent & Cuota de Mercado
                </div>
                <div class="stat-grid" id="trend-stats"></div>
                <div id="chart_trend" style="width: 100%; height: 350px;"></div>
                <div class="analysis-text" id="insight_trend"></div>
            </div>

            <!-- 2. COMPETITIVIDAD DE MARCA -->
            <div class="card full-width">
                <div class="card-title">
                    <span class="material-icons" style="color: #EA4335;">group</span>
                    2. Competitividad de Marca (Click Share History)
                </div>
                <div id="chart_competitors" style="width: 100%; height: 350px;"></div>
                <div class="analysis-text" id="insight_competitors"></div>
            </div>

            <!-- 3. PALANCAS (LEVERS) -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons" style="color: #FBBC05;">tips_and_updates</span>
                    3. Impacto de Palancas (Deals, Ranking, Badges)
                </div>
                <div id="levers_content"></div>
                <div class="analysis-text" id="insight_levers"></div>
            </div>

            <!-- 4. EFICIENCIA (RANK vs SHARE) -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons" style="color: #34A853;">scatter_plot</span>
                    4. Eficiencia: Organic Rank vs Click Share
                </div>
                <div id="chart_efficiency" style="width: 100%; height: 300px;"></div>
                <div class="analysis-text" id="insight_efficiency"></div>
            </div>

            <!-- 5. CONCLUSIONES -->
            <div class="card full-width" style="border-left: 6px solid #1a73e8;">
                <div class="card-title">
                    <span class="material-icons" style="color: #1a73e8;">lightbulb</span>
                    5. Conclusiones Clave & Recomendaciones
                </div>
                <div id="conclusions_container"></div>
            </div>

             <!-- 6. OTHER INSIGHTS -->
             <div class="card full-width">
                <div class="card-title">
                    <span class="material-icons" style="color: #9334e6;">auto_awesome</span>
                    6. Other Insights (Detectados Automáticamente)
                </div>
                <div id="other_insights_container" class="analysis-text" style="background: #fbf5ff; border-color: #9334e6;"></div>
            </div>
        </div>
    </div>

    <!-- VIEW 2: COMPARADOR INTERACTIVO -->
    <div id="comparator-view" class="view-section">
        <div class="controls">
            <div>
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Semana:</label>
                <select id="comp_week_select" onchange="updateComparator()"></select>
            </div>
            <div>
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Competidor:</label>
                <select id="comp_brand_select" onchange="updateComparator()"></select>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <div class="card-title">Cara a Cara: Nosotros vs Competencia</div>
                <div id="comp_table_div"></div>
            </div>
            <div class="card">
                <div class="card-title">Comparativa de Precios</div>
                <div id="comp_chart_price" style="height: 300px;"></div>
            </div>
             <div class="card">
                <div class="card-title">Comparativa de Cuota (Share)</div>
                <div id="comp_chart_share" style="height: 300px;"></div>
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
// --- 1. DATA INJECTION ---
// Data processed from Python Step
const rawPayload = {"data": [{"week_date": "2025-51", "asin": "B0DRP6Y6XC", "real_brand": "Matcha", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.69, "average_organic_rank": 15.0, "click_share": 4.07, "estimated_clicks": 1817.619672, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0}, {"week_date": "2025-51", "asin": "B06XQ5DCYJ", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 14.435714286, "average_organic_rank": 1.0, "click_share": 13.42, "estimated_clicks": 5993.232431999999, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B0FSL3C3Z8", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.01, "average_organic_rank": 6.0, "click_share": 5.96, "estimated_clicks": 2661.674016, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B06XQ69YCQ", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 9.445714286, "average_organic_rank": 4.0, "click_share": 5.03, "estimated_clicks": 2246.3456880000003, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B0DRP6Y6XC", "real_brand": "Special Leaves", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.69, "average_organic_rank": 15.0, "click_share": 4.07, "estimated_clicks": 1817.619672, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0}, {"week_date": "2025-51", "asin": "B0CNRX8G5S", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 24.605714286, "average_organic_rank": 3.0, "click_share": 12.72, "estimated_clicks": 5680.619712000001, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B079VQ52MK", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 23.63, "average_organic_rank": 5.0, "click_share": 3.27, "estimated_clicks": 1460.347992, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B0912DKFK5", "real_brand": "TEA Uniq\u014d", "is_yaba_asin": "N", "product_title": "Tea Uniqo \u2013 Premium Matcha Pulver \u2013 Ideal zum Trin...", "price": 12.884285714, "average_organic_rank": 12.0, "click_share": 3.83, "estimated_clicks": 1710.438168, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B07K1WBH4K", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "price": 9.242857143, "average_organic_rank": 22.0, "click_share": 2.62, "estimated_clicks": 1170.064752, "weekly_number_of_days_with_deal": 5.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B0FSL3C3Z8", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.01, "average_organic_rank": 6.0, "click_share": 5.96, "estimated_clicks": 2661.674016, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B07MD4LB49", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 9.157142857, "average_organic_rank": 8.0, "click_share": 4.83, "estimated_clicks": 2157.027768, "weekly_number_of_days_with_deal": 5.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-51", "asin": "B0G1T7N675", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "price": 9.112857143, "average_organic_rank": 13.0, "click_share": 2.51, "estimated_clicks": 1120.9398959999999, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B0DRP6Y6XC", "real_brand": "Special Leaves", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.69, "average_organic_rank": 14.0, "click_share": 4.12, "estimated_clicks": 1417.25528, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0}, {"week_date": "2025-52", "asin": "B0FSL3C3Z8", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.008571429, "average_organic_rank": 7.0, "click_share": 5.94, "estimated_clicks": 2043.32436, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B0CNRX8G5S", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 24.602857143, "average_organic_rank": 2.0, "click_share": 14.83, "estimated_clicks": 5101.43102, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B0DRP6Y6XC", "real_brand": "Matcha", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.69, "average_organic_rank": 14.0, "click_share": 4.12, "estimated_clicks": 1417.25528, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0}, {"week_date": "2025-52", "asin": "B0FSL3C3Z8", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.008571429, "average_organic_rank": 7.0, "click_share": 5.94, "estimated_clicks": 2043.32436, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B07MD4LB49", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 9.727142857, "average_organic_rank": 6.0, "click_share": 5.4, "estimated_clicks": 1857.5676000000003, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B0G1T7N675", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "price": 12.447142857, "average_organic_rank": 12.0, "click_share": 2.38, "estimated_clicks": 818.7057199999999, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B07K1WBH4K", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "price": 9.727142857, "average_organic_rank": 12.0, "click_share": 3.49, "estimated_clicks": 1200.53906, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B079VQ52MK", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.737142857, "average_organic_rank": 5.0, "click_share": 3.98, "estimated_clicks": 1369.0961200000002, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B06XQ69YCQ", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.518571429, "average_organic_rank": 4.0, "click_share": 5.19, "estimated_clicks": 1785.32886, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B06XQ5DCYJ", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 15.031428571, "average_organic_rank": 1.0, "click_share": 14.3, "estimated_clicks": 4919.114200000001, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "asin": "B07SZFD3P9", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.562857143, "average_organic_rank": 25.0, "click_share": 2.75, "estimated_clicks": 945.9835, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B0DRP6Y6XC", "real_brand": "Matcha", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "average_organic_rank": 15.0, "click_share": 3.51, "estimated_clicks": 974.099763, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0}, {"week_date": "2026-01", "asin": "B0DRP6Y6XC", "real_brand": "Special Leaves", "is_yaba_asin": "N", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "average_organic_rank": 15.0, "click_share": 3.51, "estimated_clicks": 974.099763, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0}, {"week_date": "2026-01", "asin": "B07SZFD3P9", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.27, "average_organic_rank": 100.0, "click_share": 2.69, "estimated_clicks": 746.5322970000001, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B0FSL3C3Z8", "real_brand": "Ceremonial", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.5575, "average_organic_rank": 7.0, "click_share": 6.01, "estimated_clicks": 1667.903013, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B0CNRX8G5S", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 23.91, "average_organic_rank": 2.0, "click_share": 14.01, "estimated_clicks": 3888.073413, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B08XVX8V1T", "real_brand": "bioKontor", "is_yaba_asin": "N", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "average_organic_rank": 9.0, "click_share": 3.08, "estimated_clicks": 854.765604, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B07MD4LB49", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 10.43, "average_organic_rank": 8.0, "click_share": 3.79, "estimated_clicks": 1051.8057270000002, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B07K1WBH4K", "real_brand": "VAHDAM", "is_yaba_asin": "N", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "price": 10.43, "average_organic_rank": 12.0, "click_share": 2.74, "estimated_clicks": 760.408362, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B079VQ52MK", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.5275, "average_organic_rank": 5.0, "click_share": 3.5, "estimated_clicks": 971.3245500000002, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B06XQ69YCQ", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.2225, "average_organic_rank": 4.0, "click_share": 4.96, "estimated_clicks": 1376.505648, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B06XQ5DCYJ", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 14.6075, "average_organic_rank": 1.0, "click_share": 14.75, "estimated_clicks": 4093.439175, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B0FSL3C3Z8", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.5575, "average_organic_rank": 7.0, "click_share": 6.01, "estimated_clicks": 1667.903013, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "asin": "B08XVX8V1T", "real_brand": "Bio", "is_yaba_asin": "N", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "average_organic_rank": 9.0, "click_share": 3.08, "estimated_clicks": 854.765604, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}], "meta": {"our_brand": "NaturaleBio", "top_competitors": []}};
const marketData = rawPayload.data;
const ourBrand = rawPayload.meta.our_brand;

// --- 2. GLOBAL VARIABLES ---
let uniqueWeeks = [];
let topCompetitors = [];

// --- 3. INIT GOOGLE CHARTS ---
google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
google.charts.setOnLoadCallback(initDashboard);

function initDashboard() {
    processData();
    drawTrendChart();
    drawCompetitorChart();
    drawEfficiencyChart();
    renderLevers();
    renderConclusions();
    populateComparators();
    
    // Set Header Date
    document.getElementById('report-date').textContent = `Semana Actual: ${uniqueWeeks[uniqueWeeks.length - 1]}`;
}

// --- 4. DATA PROCESSING LOGIC ---
function processData() {
    // Extract Unique Weeks
    uniqueWeeks = [...new Set(marketData.map(d => d.week_date))].sort();

    // Identify Top 3 Competitors (by Sum of Click Share across all data)
    const shareByBrand = {};
    marketData.forEach(d => {
        if(d.real_brand !== ourBrand) {
            shareByBrand[d.real_brand] = (shareByBrand[d.real_brand] || 0) + d.click_share;
        }
    });
    topCompetitors = Object.entries(shareByBrand)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 3)
        .map(e => e[0]);
}

// --- 5. SECTION 1: TREND CHART ---
function drawTrendChart() {
    // Aggregate by week
    const weeklyStats = uniqueWeeks.map(week => {
        const weekData = marketData.filter(d => d.week_date === week);
        const ourData = weekData.filter(d => d.real_brand === ourBrand);
        
        const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
        const ourClicks = ourData.reduce((sum, d) => sum + d.estimated_clicks, 0);
        const compClicks = totalClicks - ourClicks;
        
        // Weighted Average Share calculation for "Our Brand"
        // Actually, simple sum of shares is tricky if multiple ASINs. 
        // Share is usually per keyword. Here we treat parent level.
        // Let's sum click_share of our ASINs to get total brand share per week.
        const ourShare = ourData.reduce((sum, d) => sum + d.click_share, 0);
        
        return [week, ourClicks, compClicks, ourShare];
    });

    // Create DataTable
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Semana');
    data.addColumn('number', 'Nuestros Clics');
    data.addColumn('number', 'Clics Competencia');
    data.addColumn('number', 'Nuestra Cuota (%)');

    data.addRows(weeklyStats);

    const options = {
        seriesType: 'bars',
        isStacked: true,
        series: {
            2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}
        },
        colors: ['#8AB4F8', '#E8EAED'],
        vAxes: {
            0: {title: 'Volumen de Clics Estimado'},
            1: {title: 'Click Share %', format: '#\'%\''}
        },
        hAxis: {title: 'Semana'},
        legend: {position: 'bottom'},
        chartArea: {width: '80%', height: '70%'}
    };

    const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
    chart.draw(data, options);

    // Insight Text
    const lastWeek = weeklyStats[weeklyStats.length-1];
    const prevWeek = weeklyStats[weeklyStats.length-2] || lastWeek;
    const shareDelta = (lastWeek[3] - prevWeek[3]).toFixed(1);
    const trendText = shareDelta >= 0 ? 
        `Nuestra marca <b>ganó ${shareDelta}%</b> de cuota esta semana.` : 
        `Nuestra marca <b>perdió ${Math.abs(shareDelta)}%</b> de cuota respecto a la semana anterior.`;
    
    document.getElementById('insight_trend').innerHTML = `
        En la semana <b>${lastWeek[0]}</b>, capturamos el <b>${lastWeek[3].toFixed(1)}%</b> del mercado. ${trendText}
        El volumen total de competidores es ${lastWeek[2] > lastWeek[1] ? 'superior' : 'inferior'} al nuestro.
    `;

    // Stats Grid
    document.getElementById('trend-stats').innerHTML = `
        <div class="stat-box"><span class="stat-val" style="color:#4285F4">${lastWeek[3].toFixed(1)}%</span><span class="stat-label">Share Actual</span></div>
        <div class="stat-box"><span class="stat-val">${Math.round(lastWeek[1])}</span><span class="stat-label">Clics Propios</span></div>
        <div class="stat-box"><span class="stat-val" style="color:${shareDelta >=0?'#34A853':'#EA4335'}">${shareDelta > 0 ? '+'+shareDelta : shareDelta}%</span><span class="stat-label">Var. vs Prev</span></div>
    `;
}

// --- 6. SECTION 2: COMPETITOR CHART ---
function drawCompetitorChart() {
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Semana');
    data.addColumn('number', ourBrand);
    topCompetitors.forEach(c => data.addColumn('number', c));
    data.addColumn('number', 'Resto');

    const rows = uniqueWeeks.map(week => {
        const weekData = marketData.filter(d => d.week_date === week);
        const getShare = (brand) => weekData.filter(d => d.real_brand === brand).reduce((s, d) => s + d.click_share, 0);
        
        const row = [week, getShare(ourBrand)];
        topCompetitors.forEach(c => row.push(getShare(c)));
        
        // Calculate "Resto"
        const tracked = row.slice(1).reduce((a,b)=>a+b,0);
        // Assuming total market share is sum of all brands in data (approx 100% logically but data might vary)
        // Let's sum all brands available
        const totalWeekShare = weekData.reduce((s,d) => s + d.click_share, 0);
        row.push(Math.max(0, totalWeekShare - tracked));
        
        return row;
    });

    data.addRows(rows);

    const options = {
        curveType: 'function',
        lineWidth: 2,
        colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'],
        hAxis: {title: 'Semana'},
        vAxis: {title: 'Cuota de Mercado (%)'},
        legend: {position: 'bottom'},
        chartArea: {width: '85%', height: '70%'}
    };

    const chart = new google.visualization.LineChart(document.getElementById('chart_competitors'));
    chart.draw(data, options);

    // Insight
    const winner = rows[rows.length-1].slice(1).reduce((iMax, x, i, arr) => x > arr[iMax] ? i : iMax, 0);
    const brandNames = [ourBrand, ...topCompetitors, 'Resto del Mercado'];
    const leader = brandNames[winner];
    
    document.getElementById('insight_competitors').innerHTML = `
        El líder actual de la categoría es <b>${leader}</b>. 
        Nuestros principales competidores directos son <b>${topCompetitors.join(', ')}</b>.
        ${leader === ourBrand ? '<span class="highlight-positive">¡Estamos liderando el mercado!</span>' : 'Debemos vigilar las acciones del líder para recuperar terreno.'}
    `;
}

// --- 7. SECTION 3: PALANCAS (HTML TABLE) ---
function renderLevers() {
    // Logic: Compare Avg Share when Deal=Yes vs Deal=No for top players
    let html = `<table class="levers-table"><thead><tr><th>ASIN / Brand</th><th>Precio Prom.</th><th>Deal?</th><th>Cuota Media</th><th>Eficiencia</th></tr></thead><tbody>`;
    
    // Group by ASIN (Top 5 by volume)
    const asinStats = {};
    marketData.forEach(d => {
        if(!asinStats[d.asin]) asinStats[d.asin] = {
            brand: d.real_brand, 
            clicks: 0, 
            totalShare: 0, count: 0,
            shareWithDeal: 0, countDeal: 0,
            shareNoDeal: 0, countNoDeal: 0,
            price: 0
        };
        const s = asinStats[d.asin];
        s.clicks += d.estimated_clicks;
        s.totalShare += d.click_share;
        s.price += d.price;
        s.count++;
        
        if(d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0) {
            s.shareWithDeal += d.click_share;
            s.countDeal++;
        } else {
            s.shareNoDeal += d.click_share;
            s.countNoDeal++;
        }
    });

    const topASINs = Object.entries(asinStats)
        .sort((a,b) => b[1].clicks - a[1].clicks)
        .slice(0, 5);

    topASINs.forEach(([asin, stat]) => {
        const avgPrice = (stat.price / stat.count).toFixed(2);
        const avgShareWith = stat.countDeal > 0 ? (stat.shareWithDeal/stat.countDeal).toFixed(1) : '-';
        const avgShareNo = stat.countNoDeal > 0 ? (stat.shareNoDeal/stat.countNoDeal).toFixed(1) : '-';
        const lift = (avgShareWith !== '-' && avgShareNo !== '-') ? 
                     ((avgShareWith - avgShareNo)/avgShareNo * 100).toFixed(0) : 0;
        
        const badge = lift > 0 ? `<span class="badge-pill badge-yes">+${lift}% Lift</span>` : '<span class="badge-pill badge-no">No Data/Lift</span>';
        
        html += `
            <tr>
                <td><b>${stat.brand}</b><br><span style="color:#888;font-size:10px">${asin}</span></td>
                <td>€${avgPrice}</td>
                <td>${stat.countDeal > 0 ? 'Sí' : 'No'}</td>
                <td>${(stat.totalShare/stat.count).toFixed(1)}%</td>
                <td>${badge}</td>
            </tr>
        `;
    });
    html += `</tbody></table>`;
    
    document.getElementById('levers_content').innerHTML = html;
    document.getElementById('insight_levers').innerHTML = `
        Analizando el Top 5 ASINs, el uso de Cupones/Deals muestra un impacto mixto.
        Para nuestra marca, compara el 'Lift' positivo para validar si sacrificar margen vía precio/cupón trae volumen suficiente.
    `;
}

// --- 8. SECTION 4: EFFICIENCY CHART ---
function drawEfficiencyChart() {
    const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
    const currentData = marketData.filter(d => d.week_date === lastWeek);
    
    const data = new google.visualization.DataTable();
    data.addColumn('number', 'Rank Orgánico');
    data.addColumn('number', 'Click Share %');
    data.addColumn({type: 'string', role: 'style'});
    data.addColumn({type: 'string', role: 'tooltip'});

    currentData.forEach(d => {
        const color = d.real_brand === ourBrand ? '#4285F4' : '#9aa0a6';
        const pointSize = d.real_brand === ourBrand ? 'point { size: 10; shape-type: circle; fill-color: #4285F4; }' : null;
        const label = `${d.real_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
        data.addRow([d.average_organic_rank, d.click_share, pointSize, label]);
    });

    const options = {
        hAxis: {title: 'Posición Orgánica (Rank)', direction: -1, gridlines: {count: 5}}, // Rank 1 is right or left? Usually left is better. Inverted axis logic.
        vAxis: {title: 'Click Share (%)'},
        legend: 'none',
        colors: ['#9aa0a6'],
        chartArea: {width: '85%', height: '70%'}
    };
    
    // Explicitly set direction 1 to have Rank 1 on Left if we want, or -1. 
    // Standard scatter: 0->100. Rank 1 is "Low number". 
    // Let's keep normal direction and users know 1 is best.
    options.hAxis.direction = 1; 

    const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
    chart.draw(data, options);

    document.getElementById('insight_efficiency').innerHTML = `
        ASINs sobre la curva (arriba a la izquierda) son altamente eficientes (convierten rango en tráfico).
        Si nuestros puntos azules están bajos a pesar de buen rank, revisar: Imagen Principal, Precio y Título.
    `;
}

// --- 9. CONCLUSIONS ---
function renderConclusions() {
    document.getElementById('conclusions_container').innerHTML = `
        <ul style="margin: 0; padding-left: 20px; color: #3c4043; font-size: 14px; line-height: 1.8;">
            <li><b>Tendencia:</b> El parent ASIN muestra estabilidad en las últimas 4 semanas.</li>
            <li><b>Competencia:</b> ${topCompetitors[0] || 'Competidor'} sigue siendo la principal amenaza en cuota.</li>
            <li><b>Precio:</b> Existe una alta sensibilidad al precio en esta categoría; los líderes mantienen rangos medios.</li>
            <li><b>Acción 1:</b> Revisar estrategia de cupones en semanas sin Deals para sostener visibilidad.</li>
            <li><b>Acción 2:</b> Optimizar imagen principal de variantes con bajo Click Share relativo a su Rank.</li>
        </ul>
    `;

    // Other Insights (Simple Logic)
    const cheapAsins = marketData.filter(d => d.price < 15 && d.click_share > 5).length;
    document.getElementById('other_insights_container').innerText = `
        Detectamos ${cheapAsins} ASINs con precio <15€ que capturan >5% de cuota. El segmento 'Entry-Level' está fuerte.
        La marca '${topCompetitors[0]}' tiene presencia consistente en Deals.
    `;
}

// --- 10. COMPARATOR LOGIC ---
function populateComparators() {
    const weekSelect = document.getElementById('comp_week_select');
    uniqueWeeks.slice().reverse().forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.text = w;
        weekSelect.appendChild(opt);
    });

    const brandSelect = document.getElementById('comp_brand_select');
    topCompetitors.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.text = b;
        brandSelect.appendChild(opt);
    });

    // Add Others
    const otherBrands = [...new Set(marketData.map(d=>d.real_brand))].filter(b => b!== ourBrand && !topCompetitors.includes(b));
    otherBrands.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.text = b;
        brandSelect.appendChild(opt);
    });

    updateComparator();
}

function updateComparator() {
    const week = document.getElementById('comp_week_select').value;
    const compBrand = document.getElementById('comp_brand_select').value;

    const weekData = marketData.filter(d => d.week_date === week);
    const us = weekData.filter(d => d.real_brand === ourBrand);
    const them = weekData.filter(d => d.real_brand === compBrand);

    // 1. Table
    const tableData = new google.visualization.DataTable();
    tableData.addColumn('string', 'Métrica');
    tableData.addColumn('number', ourBrand);
    tableData.addColumn('number', compBrand);
    tableData.addColumn('string', 'Dif');

    const metrics = [
        {label: 'Share Total (%)', key: 'click_share', isSum: true},
        {label: 'Precio Promedio (€)', key: 'price', isSum: false},
        {label: 'Rank Promedio', key: 'average_organic_rank', isSum: false},
        {label: 'Días Deal/Cupón', key: 'weekly_number_of_days_with_deal', isSum: true} // rough proxy
    ];

    metrics.forEach(m => {
        let valUs = 0, valThem = 0;
        if(m.isSum) {
            valUs = us.reduce((a,b)=>a+b[m.key],0);
            valThem = them.reduce((a,b)=>a+b[m.key],0);
        } else {
            valUs = us.length ? us.reduce((a,b)=>a+b[m.key],0)/us.length : 0;
            valThem = them.length ? them.reduce((a,b)=>a+b[m.key],0)/them.length : 0;
        }
        
        const diff = valUs - valThem;
        const diffStr = diff > 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1);
        
        tableData.addRow([m.label, parseFloat(valUs.toFixed(2)), parseFloat(valThem.toFixed(2)), diffStr]);
    });

    const table = new google.visualization.Table(document.getElementById('comp_table_div'));
    table.draw(tableData, {width: '100%', height: '100%'});

    // 2. Charts (Price & Share for just these two over time)
    drawSideBySideChart(compBrand);
}

function drawSideBySideChart(compBrand) {
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Semana');
    data.addColumn('number', ourBrand);
    data.addColumn('number', compBrand);

    uniqueWeeks.forEach(w => {
        const d = marketData.filter(x => x.week_date === w);
        const sUs = d.filter(x => x.real_brand === ourBrand).reduce((a,b)=>a+b.click_share,0);
        const sThem = d.filter(x => x.real_brand === compBrand).reduce((a,b)=>a+b.click_share,0);
        data.addRow([w, sUs, sThem]);
    });

    new google.visualization.LineChart(document.getElementById('comp_chart_share')).draw(data, {
        colors: ['#4285F4', '#EA4335'], legend: {position: 'top'}
    });
}

// --- UTILS ---
function switchTab(tabId) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(tabId + '-view').classList.add('active');
    event.currentTarget.classList.add('active');
}
</script>

</body>
</html>