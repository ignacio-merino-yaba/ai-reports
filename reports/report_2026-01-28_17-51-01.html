<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Rendimiento ASIN: Matcha Premium</title>
    
    <!-- Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Charts (Visualización) -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Icons (Iconografía Google-Style) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* Custom Styles for Apple/Google Hybrid Look */
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #F8FAFC; color: #1E293B; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .tab-active { border-bottom: 2px solid #2563EB; color: #2563EB; font-weight: 600; }
        .tab-inactive { color: #64748B; font-weight: 500; }
        .metric-value { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Google Charts Tooltip styling */
        .google-visualization-tooltip { border-radius: 8px !important; border: none !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header / Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <span class="material-icons text-blue-600 text-3xl">analytics</span>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 tracking-tight">Parent ASIN Intelligence</h1>
                        <p class="text-xs text-gray-500">Brand: NaturaleBio | Keyword: Matcha</p>
                    </div>
                </div>
                <div class="flex space-x-8 items-end pb-0">
                    <button onclick="switchTab('static')" id="tab-static" class="tab-active pb-4 px-2 text-sm flex items-center gap-2">
                        <span class="material-icons text-sm">dashboard</span> Reporte Estratégico
                    </button>
                    <button onclick="switchTab('interactive')" id="tab-interactive" class="tab-inactive pb-4 px-2 text-sm flex items-center gap-2">
                        <span class="material-icons text-sm">compare_arrows</span> Comparador Interactivo
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- TAB 1: REPORTE ESTRATÉGICO -->
        <div id="view-static" class="space-y-8 animate-fade-in">
            
            <!-- Executive Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Click Share (NaturaleBio)</p>
                            <h3 class="text-3xl font-bold mt-2 text-gray-900 metric-value">22.6%</h3>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded flex items-center">
                            <span class="material-icons text-xs mr-1">trending_up</span> +0.8%
                        </span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">vs. semana anterior</p>
                </div>

                <div class="card p-6 border-l-4 border-red-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Market Clicks</p>
                            <h3 class="text-3xl font-bold mt-2 text-gray-900 metric-value">16.1k</h3>
                        </div>
                        <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded flex items-center">
                            <span class="material-icons text-xs mr-1">trending_down</span> -43%
                        </span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Caída estacional post-navidad</p>
                </div>

                <div class="card p-6 border-l-4 border-indigo-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Avg. Organic Rank</p>
                            <h3 class="text-3xl font-bold mt-2 text-gray-900 metric-value">#3.8</h3>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded flex items-center">
                            <span class="material-icons text-xs mr-1">arrow_upward</span> +2 Pos
                        </span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Mejora clave en ASIN Ceremonial</p>
                </div>

                <div class="card p-6 border-l-4 border-gray-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Price Premium</p>
                            <h3 class="text-3xl font-bold mt-2 text-gray-900 metric-value">+28%</h3>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">vs. Avg Competidores Top 3</p>
                </div>
            </div>

            <!-- Sección 1: Tendencia Global -->
            <section class="card p-6">
                <div class="mb-4 border-b pb-4">
                    <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <span class="material-icons text-blue-600">show_chart</span> 1. Tendencia Global del Parent (Volumen & Share)
                    </h2>
                    <p class="text-sm text-gray-600">Comparativa de Clics Totales vs Cuota de Mercado (NaturaleBio vs Competencia)</p>
                </div>
                <div id="chart_global_trend" class="w-full h-80"></div>
                <div class="mt-4 bg-blue-50 p-4 rounded-lg text-sm text-blue-800 border border-blue-100">
                    <strong>Insight de Tendencia:</strong> El mercado ha sufrido una contracción severa del volumen de búsqueda (-43%) tras la semana de Navidad (S52). A pesar de esto, 
                    <strong>NaturaleBio ha aumentado su Click Share del 21.8% al 22.6%</strong>, demostrando mayor resiliencia que la competencia agregada, que cayó del 38.7% al 36.8%.
                </div>
            </section>

            <!-- Sección 2: Competitividad de Marca -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 card p-6">
                    <div class="mb-4 border-b pb-4">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <span class="material-icons text-red-600">people_outline</span> 2. Competitividad de Marca
                        </h2>
                        <p class="text-sm text-gray-600">Evolución del Click Share: NaturaleBio vs Top 3 Competidores</p>
                    </div>
                    <div id="chart_brand_comp" class="w-full h-80"></div>
                </div>
                <div class="card p-6 bg-gray-50">
                    <h3 class="font-bold text-gray-900 mb-4">Top Competidores</h3>
                    <ul class="space-y-4">
                        <li class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                <span class="text-sm font-medium">NORITUAL LAB</span>
                            </div>
                            <span class="text-sm font-bold">19.1% Share</span>
                        </li>
                        <li class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-orange-400"></span>
                                <span class="text-sm font-medium">Special Leaves</span>
                            </div>
                            <span class="text-sm font-bold">3.2% Share</span>
                        </li>
                        <li class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-yellow-400"></span>
                                <span class="text-sm font-medium">VAHDAM</span>
                            </div>
                            <span class="text-sm font-bold">3.7% Share</span>
                        </li>
                    </ul>
                    <hr class="my-4 border-gray-200">
                    <p class="text-xs text-gray-600 leading-relaxed">
                        <strong>Análisis:</strong> NORITUAL LAB domina el segmento medio. Sin embargo, su share se ha estancado. 
                        VAHDAM y Special Leaves muestran volatilidad. NaturaleBio (Nosotros) mantiene una tendencia sólida al alza en la S01.
                    </p>
                </div>
            </section>

            <!-- Sección 4: Eficiencia -->
            <section class="card p-6">
                <div class="mb-4 border-b pb-4">
                    <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <span class="material-icons text-purple-600">scatter_plot</span> 4. Eficiencia: Organic Rank vs Click Share
                    </h2>
                    <p class="text-sm text-gray-600">Identificación de ASINs eficientes (Alto Share con Peor Rank) vs Ineficientes.</p>
                </div>
                <div id="chart_efficiency" class="w-full h-96"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="p-3 bg-green-50 rounded border border-green-100 text-xs text-green-900">
                        <strong>Sobreperformer (Nosotros):</strong> ASIN <em>B07SZFD3P9</em> (Matcha Premium). Ha saltado del Rank 23 al Top 3, capturando un share desproporcionado pese a ser el producto más caro (30€).
                    </div>
                    <div class="p-3 bg-red-50 rounded border border-red-100 text-xs text-red-900">
                        <strong>Amenaza:</strong> ASIN <em>B0CNRX8G5S</em> (NORITUAL). Mantiene Rank 2 consistente y domina el volumen puro gracias a un precio inferior (~24€ vs nuestros 30€).
                    </div>
                </div>
            </section>

            <!-- Sección 5: Conclusiones y Recomendaciones -->
            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span class="material-icons text-amber-500">lightbulb</span> 5. Insights Clave
                    </h2>
                    <ul class="space-y-3">
                        <li class="flex gap-3 text-sm text-gray-700">
                            <span class="material-icons text-blue-500 text-sm mt-0.5">check_circle</span>
                            <span><strong>Resiliencia ante la caída:</strong> El mercado de Matcha se desplomó un 43% en volumen (S01 vs S52), pero NaturaleBio ganó cuota (+0.8pp), indicando clientes leales o mejor posicionamiento orgánico.</span>
                        </li>
                        <li class="flex gap-3 text-sm text-gray-700">
                            <span class="material-icons text-blue-500 text-sm mt-0.5">check_circle</span>
                            <span><strong>El 'Joya de la Corona':</strong> El ASIN B07SZFD3P9 (Ceremonial Grade) es el motor del crecimiento, mejorando su Rank orgánico drásticamente (23 → 2.6).</span>
                        </li>
                        <li class="flex gap-3 text-sm text-gray-700">
                            <span class="material-icons text-blue-500 text-sm mt-0.5">check_circle</span>
                            <span><strong>Premium Price Power:</strong> Operamos con un precio medio de ~20€ frente a ~15.5€ de la competencia. El consumidor de enero prefiere calidad sobre precio.</span>
                        </li>
                        <li class="flex gap-3 text-sm text-gray-700">
                            <span class="material-icons text-blue-500 text-sm mt-0.5">check_circle</span>
                            <span><strong>Amenaza de Rango Medio:</strong> NORITUAL LAB (Rank 2 estable) bloquea el crecimiento de nuestro ASIN B06XQ5DCYJ en el segmento de precio medio.</span>
                        </li>
                        <li class="flex gap-3 text-sm text-gray-700">
                            <span class="material-icons text-blue-500 text-sm mt-0.5">check_circle</span>
                            <span><strong>Oportunidad en Long Tail:</strong> Competidores como Special Leaves están perdiendo relevancia (Rank 13 → 16). Es momento de atacar sus keywords.</span>
                        </li>
                    </ul>
                </div>

                <div class="card p-6 bg-gradient-to-br from-blue-900 to-slate-900 text-white">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-white">
                        <span class="material-icons text-green-400">rocket_launch</span> Recomendaciones Accionables
                    </h2>
                    <div class="space-y-4">
                        <div class="bg-white/10 p-4 rounded-lg backdrop-blur-sm">
                            <h4 class="font-bold text-green-400 text-sm mb-1">1. Capitalizar el Rank del ASIN Ceremonial</h4>
                            <p class="text-xs text-gray-300">El ASIN B07SZFD3P9 ha entrado en el Top 3. <strong>NO tocar título ni precio</strong> esta semana. Asegurar stock al 100% para consolidar la posición orgánica ganada.</p>
                        </div>
                        <div class="bg-white/10 p-4 rounded-lg backdrop-blur-sm">
                            <h4 class="font-bold text-yellow-400 text-sm mb-1">2. Defensa Activa en Gama Media</h4>
                            <p class="text-xs text-gray-300">Para el ASIN B06XQ5DCYJ, activar un <strong>Cupón del 5%</strong> (marcar casilla verde) para romper la paridad de Rank con NORITUAL LAB y ganar el clic visual.</p>
                        </div>
                        <div class="bg-white/10 p-4 rounded-lg backdrop-blur-sm">
                            <h4 class="font-bold text-blue-400 text-sm mb-1">3. Eficiencia vs Volumen</h4>
                            <p class="text-xs text-gray-300">Dado que el volumen del mercado es bajo en enero, no invertir agresivamente en PPC de tráfico frío. Enfocar el budget en <strong>Retargeting</strong> y defensa de marca.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- TAB 2: INTERACTIVO -->
        <div id="view-interactive" class="hidden space-y-6 animate-fade-in">
            <div class="card p-6">
                <div class="flex flex-col md:flex-row gap-4 items-end mb-6 border-b pb-6">
                    <div class="w-full md:w-1/3">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Seleccionar Semana</label>
                        <select id="select-week" class="block w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="w-full md:w-1/3">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Competidor a Comparar</label>
                        <select id="select-competitor" class="block w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="w-full md:w-1/3">
                        <button onclick="updateComparator()" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none flex items-center justify-center gap-2">
                            <span class="material-icons text-sm">refresh</span> Actualizar Comparativa
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Metrics Table -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Cara a Cara: Métricas</h3>
                        <div id="comparator-table"></div>
                    </div>
                    <!-- Mini Chart -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Distribución de Share</h3>
                        <div id="chart_comparator_share" class="w-full h-64"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="max-w-7xl mx-auto px-4 py-6 text-center text-gray-400 text-xs">
        <p>Generado automáticamente por AI Market Intelligence System. Datos basados en input CSV.</p>
    </footer>

    <!-- LOGIC SCRIPT (Vanilla JS) -->
    <script type="text/javascript">
        // 1. INYECTAR DATOS (Procesados del CSV)
        // Estructura: [brand, parent, date, week, kw, comp_brand, asin, title, country, rank, deals, bestseller, choice, coupon, share, imp_share, price, share_rank, vol, is_yaba, link]
        const rawData = [
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","NaturaleBio","B07SZFD3P9","NaturaleBio Matcha Ceremonial Grade...","de",2.68,0,0,0,0,30.27,2.06,30.27,8,27054.32,"Y"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","NORITUAL LAB","B0CNRX8G5S","Ceremonial Matcha - Reines Matcha...","de",2,0,0,4,0,19.34,3.36,23.91,1,27054.32,"N"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","NORITUAL LAB","B0CNRX8G5S","Ceremonial Matcha - Reines Matcha...","de",2,0,0,7,0,18.77,3.35,24.64,1,47712.44,"N"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","NaturaleBio","B06XQ5DCYJ","NaturaleBio Matcha Tee Pulver Bio...","de",2,0,0,0,0,11.66,3.37,15.05,2,47712.44,"Y"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","NaturaleBio","B06XQ5DCYJ","NaturaleBio Matcha Tee Pulver Bio...","de",2,0,0,0,0,12.9,3.37,14.60,2,27054.32,"Y"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","NaturaleBio","B06XQ69YCQ","NaturaleBio Matcha Tee Pulver Bio...","de",4,0,0,0,0,3.75,3.25,10.53,5,47712.44,"Y"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","NaturaleBio","B06XQ69YCQ","NaturaleBio Matcha Tee Pulver Bio...","de",5,0,0,0,0,3.35,3.02,10.22,5,27054.32,"Y"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","NaturaleBio","B079VQ52MK","NaturaleBio Matcha Tee Pulver Bio...","de",5,0,0,0,0,3.49,3.36,24.85,6,47712.44,"Y"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","NaturaleBio","B079VQ52MK","NaturaleBio Matcha Tee Pulver Bio...","de",5,0,0,0,0,3.66,3.36,24.52,4,27054.32,"Y"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","NORITUAL LAB","B0FSL3C3Z8","Ceremonial Matcha Ryoku...","de",6,0,0,0,0,7.38,4.54,15.55,3,27054.32,"N"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","NORITUAL LAB","B0FSL3C3Z8","Ceremonial Matcha Ryoku...","de",6,0,0,0,0,8.42,4.24,16.03,3,47712.44,"N"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","VAHDAM","B07MD4LB49","VAHDAM, Matcha Grüntee Pulver...","de",7,3,0,0,0,4.19,5.29,9.89,4,47712.44,"N"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","VAHDAM","B07MD4LB49","VAHDAM, Matcha Grüntee Pulver...","de",9,0,0,0,0,3.15,5.19,10.43,6,27054.32,"N"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","bioKontor","B08XVX8V1T","Bio Matcha Pulver 100 g...","de",10,0,0,0,0,2.39,3.91,11.99,9,27054.32,"N"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","bioKontor","B08XVX8V1T","Bio Matcha Pulver 100 g...","de",10,0,0,0,0,2.44,3.4,12.36,9,47712.44,"N"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","Special Leaves","B0DRP6Y6XC","Matcha Pulver - 90g...","de",13,0,0,0,7,3.4,4.7,10.71,7,47712.44,"N"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","Special Leaves","B0DRP6Y6XC","Matcha Pulver - 90g...","de",16,0,0,0,4,3,4.47,10.39,7,27054.32,"N"],
            ["naturalebio","Matcha Premium","2026-01-03","2026-01","matcha","Unknown","B0F9B1LWQQ","UNREAL® 100g Ceremonial...","de",19,0,0,0,0,1.57,1.96,31.27,10,27054.32,"N"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","VAHDAM","B07K1WBH4K","VAHDAM, Vanille Matcha...","de",20,3,0,0,0,1.47,2.29,9.89,10,47712.44,"N"],
            ["naturalebio","Matcha Premium","2025-12-27","2025-52","matcha","NaturaleBio","B07SZFD3P9","NaturaleBio Matcha Ceremonial...","de",23,1,0,0,0,2.93,2.43,30.70,8,47712.44,"Y"]
        ];

        // 2. HELPER FUNCTIONS & PROCESSING
        // Map raw array to objects for easier handling
        const marketData = rawData.map(r => ({
            week: r[3],
            brand: r[5],
            asin: r[6],
            title: r[7],
            rank: r[9],
            click_share: r[14],
            price: r[16],
            volume: r[18],
            is_yaba: r[19],
            est_clicks: (r[14]/100) * r[18]
        })).sort((a,b) => a.week.localeCompare(b.week));

        const weeks = [...new Set(marketData.map(d => d.week))];
        const brands = [...new Set(marketData.filter(d => d.is_yaba === 'N').map(d => d.brand))];

        // Load Google Charts
        google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
        google.charts.setOnLoadCallback(initCharts);

        function initCharts() {
            drawGlobalTrend();
            drawCompetitiveness();
            drawEfficiency();
            populateInteractiveControls();
        }

        // --- CHART 1: GLOBAL TREND (Combo Chart) ---
        function drawGlobalTrend() {
            // Aggregate by Week and Ownership
            const agg = {};
            weeks.forEach(w => {
                agg[w] = { vol_us: 0, vol_comp: 0, share_us: 0, share_comp: 0, total_vol: 0 };
            });

            marketData.forEach(d => {
                if(d.is_yaba === 'Y') {
                    agg[d.week].vol_us += d.est_clicks;
                    agg[d.week].share_us += d.click_share;
                } else {
                    agg[d.week].vol_comp += d.est_clicks;
                    agg[d.week].share_comp += d.click_share;
                }
                // Approximate total volume based on a single ASIN row typically carries the full volume, 
                // but since we have segments, we assume 'volume' column is the total market volume for that keyword.
                // We'll take the max volume found for that week to represent "Market Volume".
                agg[d.week].total_vol = Math.max(agg[d.week].total_vol, d.volume); 
            });

            // Convert share sum to actual relative share in our dataset context if needed, 
            // but the input 'click_share' is already % of total.
            // Let's plot: Total Clicks (Bar) and Share % (Line)
            
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', 'Clicks Competencia');
            dataTable.addColumn('number', 'Clicks NaturaleBio');
            dataTable.addColumn('number', 'Share NaturaleBio %');
            dataTable.addColumn('number', 'Share Competencia %');

            weeks.forEach(w => {
                dataTable.addRow([
                    w, 
                    agg[w].vol_comp, 
                    agg[w].vol_us, 
                    agg[w].share_us, 
                    agg[w].share_comp
                ]);
            });

            const options = {
                seriesType: 'bars',
                series: {
                    2: {type: 'line', targetAxisIndex: 1, color: '#2563EB', lineWidth: 3},
                    3: {type: 'line', targetAxisIndex: 1, color: '#EF4444', lineDashStyle: [4, 4]}
                },
                colors: ['#CBD5E1', '#93C5FD'], // Light Grey (Comp), Light Blue (Us)
                isStacked: true,
                vAxes: {
                    0: {title: 'Volumen Estimado de Clics'},
                    1: {title: 'Click Share %', format: '#\'%\''}
                },
                legend: { position: 'bottom' },
                chartArea: { width: '80%', height: '70%' },
                fontName: 'Inter'
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(dataTable, options);
        }

        // --- CHART 2: BRAND COMPETITIVENESS (Line Chart) ---
        function drawCompetitiveness() {
            // Get Top 3 Competitors by Avg Share
            const compShare = {};
            marketData.filter(d => d.is_yaba === 'N').forEach(d => {
                if(!compShare[d.brand]) compShare[d.brand] = 0;
                compShare[d.brand] += d.click_share;
            });
            // Sort
            const topComps = Object.keys(compShare).sort((a,b) => compShare[b] - compShare[a]).slice(0, 3);

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', 'NaturaleBio');
            topComps.forEach(c => dataTable.addColumn('number', c));

            weeks.forEach(w => {
                const row = [w];
                // Us
                const shareUs = marketData.filter(d => d.week === w && d.is_yaba === 'Y')
                                          .reduce((sum, d) => sum + d.click_share, 0);
                row.push(shareUs);
                // Comps
                topComps.forEach(c => {
                    const shareComp = marketData.filter(d => d.week === w && d.brand === c)
                                                .reduce((sum, d) => sum + d.click_share, 0);
                    row.push(shareComp);
                });
                dataTable.addRow(row);
            });

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#2563EB', '#EF4444', '#F59E0B', '#FCD34D'], // Blue, Red, Orange, Yellow
                vAxis: { title: 'Click Share %' },
                chartArea: { width: '85%', height: '70%' },
                pointSize: 5,
                lineWidth: 3,
                fontName: 'Inter'
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(dataTable, options);
        }

        // --- CHART 4: EFFICIENCY (Scatter) ---
        function drawEfficiency() {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('number', 'Organic Rank');
            dataTable.addColumn('number', 'Click Share %');
            dataTable.addColumn({type: 'string', role: 'style'}); // Color
            dataTable.addColumn({type: 'string', role: 'tooltip'});

            // Filter for latest week only for this snapshot
            const latestWeek = weeks[weeks.length - 1];
            
            marketData.filter(d => d.week === latestWeek).forEach(d => {
                const color = d.is_yaba === 'Y' ? 'point { fill-color: #2563EB; size: 6; }' : 'point { fill-color: #EF4444; size: 4; }';
                const label = `${d.brand} \nASIN: ${d.asin} \nRank: ${d.rank} \nShare: ${d.click_share}%`;
                // Invert X axis logic visually later, but data is rank number
                dataTable.addRow([d.rank, d.click_share, color, label]);
            });

            const options = {
                hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 }, // Invert axis so Rank 1 is right or left? Usually Rank 1 is best. Let's keep standard 1->100 but maybe left is better. Direction 1 is standard. Let's use direction 1.
                vAxis: { title: 'Click Share %' },
                legend: 'none',
                chartArea: { width: '85%', height: '80%' },
                fontName: 'Inter'
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(dataTable, options);
        }

        // --- INTERACTIVE SECTION ---
        function populateInteractiveControls() {
            const weekSelect = document.getElementById('select-week');
            const compSelect = document.getElementById('select-competitor');

            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSelect.appendChild(opt);
            });
            // Set latest
            weekSelect.value = weeks[weeks.length - 1];

            brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                compSelect.appendChild(opt);
            });
            // Set top competitor
            compSelect.value = "NORITUAL LAB"; 
        }

        function updateComparator() {
            const week = document.getElementById('select-week').value;
            const competitor = document.getElementById('select-competitor').value;
            
            // Get Data
            const ourData = marketData.filter(d => d.week === week && d.is_yaba === 'Y');
            const compData = marketData.filter(d => d.week === week && d.brand === competitor);

            // Calculate Aggregates
            const avgPriceUs = ourData.reduce((s, c) => s + c.price, 0) / (ourData.length || 1);
            const avgPriceComp = compData.reduce((s, c) => s + c.price, 0) / (compData.length || 1);
            const totalShareUs = ourData.reduce((s, c) => s + c.click_share, 0);
            const totalShareComp = compData.reduce((s, c) => s + c.click_share, 0);
            const bestRankUs = Math.min(...ourData.map(d => d.rank));
            const bestRankComp = Math.min(...compData.map(d => d.rank));

            // Draw Table
            const container = document.getElementById('comparator-table');
            let html = `
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">Métrica</th>
                            <th class="px-6 py-3 text-blue-600">NaturaleBio</th>
                            <th class="px-6 py-3 text-red-600">${competitor}</th>
                            <th class="px-6 py-3">Delta</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">Avg Price</td>
                            <td class="px-6 py-4">${avgPriceUs.toFixed(2)}€</td>
                            <td class="px-6 py-4">${avgPriceComp.toFixed(2)}€</td>
                            <td class="px-6 py-4 font-bold ${avgPriceUs > avgPriceComp ? 'text-red-500' : 'text-green-500'}">
                                ${((avgPriceUs/avgPriceComp - 1)*100).toFixed(1)}%
                            </td>
                        </tr>
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">Total Share</td>
                            <td class="px-6 py-4">${totalShareUs.toFixed(2)}%</td>
                            <td class="px-6 py-4">${totalShareComp.toFixed(2)}%</td>
                            <td class="px-6 py-4 font-bold ${totalShareUs > totalShareComp ? 'text-green-500' : 'text-red-500'}">
                                ${(totalShareUs - totalShareComp).toFixed(2)} pp
                            </td>
                        </tr>
                         <tr class="bg-white">
                            <td class="px-6 py-4 font-medium text-gray-900">Best Rank</td>
                            <td class="px-6 py-4">#${bestRankUs.toFixed(1)}</td>
                            <td class="px-6 py-4">#${bestRankComp.toFixed(1)}</td>
                            <td class="px-6 py-4 text-xs text-gray-400">Lower is better</td>
                        </tr>
                    </tbody>
                </table>
            `;
            container.innerHTML = html;

            // Draw Mini Chart (Share Comparison)
            const dataTable = google.visualization.arrayToDataTable([
                ['Brand', 'Share'],
                ['NaturaleBio', totalShareUs],
                [competitor, totalShareComp],
                ['Resto Mercado', 100 - totalShareUs - totalShareComp]
            ]);

            const options = {
                pieHole: 0.4,
                colors: ['#2563EB', '#EF4444', '#E2E8F0'],
                chartArea: { width: '90%', height: '90%' },
                legend: { position: 'bottom' },
                fontName: 'Inter'
            };

            const chart = new google.visualization.PieChart(document.getElementById('chart_comparator_share'));
            chart.draw(dataTable, options);
        }


        // 3. UI LOGIC
        function switchTab(tabName) {
            document.getElementById('view-static').classList.add('hidden');
            document.getElementById('view-interactive').classList.add('hidden');
            document.getElementById('tab-static').className = "tab-inactive pb-4 px-2 text-sm flex items-center gap-2";
            document.getElementById('tab-interactive').className = "tab-inactive pb-4 px-2 text-sm flex items-center gap-2";

            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).className = "tab-active pb-4 px-2 text-sm flex items-center gap-2";
            
            // Redraw charts if switching to interactive to ensure proper sizing
            if(tabName === 'interactive') {
                updateComparator();
            }
        }
    </script>
</body>
</html>