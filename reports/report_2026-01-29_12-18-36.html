<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4285F4;
            --secondary-color: #34A853;
            --danger-color: #EA4335;
            --warning-color: #FBBC05;
            --text-dark: #202124;
            --text-gray: #5f6368;
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --border-radius: 16px;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout & Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px 0;
            margin-bottom: 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: var(--text-dark);
        }

        .subtitle {
            font-size: 14px;
            color: var(--text-gray);
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-gray);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid #f0f0f0;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-box {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
        }

        /* Insights Section */
        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            color: var(--primary-color);
        }

        .insight-text strong {
            display: block;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .insight-text {
            font-size: 14px;
            color: var(--text-gray);
        }

        /* Recommendation Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
        }
        .badge-urgent { background: #fee2e2; color: #991b1b; }
        .badge-opportunity { background: #dcfce7; color: #166534; }
        .badge-info { background: #e0f2fe; color: #075985; }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .select-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: 'Inter', sans-serif;
            min-width: 200px;
        }

        /* Table Styles for Google Charts */
        .google-visualization-table-table {
            font-family: 'Inter', sans-serif !important;
        }

        /* Utility */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 16px; }
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .flex-1 { flex: 1; }

    </style>
</head>
<body>

    <header>
        <div class="container header-content">
            <div>
                <h1>Análisis de Parent ASIN</h1>
                <div class="subtitle" id="reportSubtitle">Cargando datos...</div>
            </div>
            <div style="text-align: right;">
                <span class="badge badge-info" id="ourBrandBadge">Nuestra Marca: Detectando...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Navegación -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- ================= PESTAÑA 1: REPORTE ESTÁTICO ================= -->
        <div id="static-tab">
            
            <!-- Sección 1: Tendencia Global -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">trending_up</span>
                        Tendencia Global del Parent
                    </div>
                </div>
                <div class="chart-container" id="trend_chart_div"></div>
                <p class="insight-text mt-4" id="trend_summary"></p>
            </div>

            <!-- Sección 2: Competitividad de Marca -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">pie_chart</span>
                        Competitividad de Marca (Share of Voice)
                    </div>
                </div>
                <div class="chart-container" id="competitiveness_chart_div"></div>
                <div class="metrics-grid mt-4" id="competitor_metrics"></div>
            </div>

            <!-- Sección 3: Palancas (Drivers) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">tune</span>
                        Palancas de Rendimiento (Drivers)
                    </div>
                </div>
                <div class="flex-row">
                    <div class="flex-1" style="min-width: 300px;">
                        <div id="drivers_chart_div" style="height: 300px;"></div>
                    </div>
                    <div class="flex-1" style="min-width: 300px;">
                        <h4>Impacto Promocional</h4>
                        <div id="promo_impact_table_div"></div>
                    </div>
                </div>
            </div>

            <!-- Sección 4: Eficiencia (Rank vs Share) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">scatter_plot</span>
                        Eficiencia: Organic Rank vs Click Share
                    </div>
                </div>
                <div class="chart-container" id="efficiency_chart_div"></div>
                <p class="insight-text mt-4">
                    <small>Cuadrante Superior Izq: Alta Eficiencia (Mal rank, buen share). Cuadrante Inferior Der: Baja Eficiencia (Buen rank, mal share).</small>
                </p>
            </div>

            <!-- Sección 5: Conclusiones y Recomendaciones -->
            <div class="flex-row">
                <div class="flex-1 card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="material-icons">lightbulb</span>
                            Insights Clave
                        </div>
                    </div>
                    <ul class="insights-list" id="key_insights_list">
                        <!-- JS Injected -->
                    </ul>
                </div>
                <div class="flex-1 card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="material-icons">assignment_turned_in</span>
                            Recomendaciones Accionables
                        </div>
                    </div>
                    <ul class="insights-list" id="recommendations_list">
                        <!-- JS Injected -->
                    </ul>
                </div>
            </div>
            
             <!-- Sección 6: Other Insights -->
             <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">analytics</span>
                        Otros Hallazgos
                    </div>
                </div>
                <ul class="insights-list" id="other_insights_list">
                    <!-- JS Injected -->
                </ul>
            </div>
        </div>

        <!-- ================= PESTAÑA 2: INTERACTIVO ================= -->
        <div id="interactive-tab" class="hidden">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">compare_arrows</span>
                        Cara a Cara: Nosotros vs Competencia
                    </div>
                </div>
                
                <div class="controls">
                    <div class="select-group">
                        <label>Seleccionar Competidor</label>
                        <select id="competitorSelect" onchange="updateInteractiveView()"></select>
                    </div>
                    <div class="select-group">
                        <label>Métrica Principal</label>
                        <select id="metricSelect" onchange="updateInteractiveView()">
                            <option value="price">Precio</option>
                            <option value="click_share">Click Share</option>
                            <option value="average_organic_rank">Rank Orgánico</option>
                        </select>
                    </div>
                </div>

                <div class="chart-container" id="interactive_chart_div"></div>
                <div class="mt-4" id="interactive_table_div"></div>
            </div>
        </div>
    </div>

    <!-- DATA INJECTION -->
    <script>
        // DATA PROCESSING: The const marketData contains the raw CSV data converted to JSON.
        const marketData = [
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": "Chaism",
    "asin": "B0BPXQ2PR5",
    "product_title": "Chaism Ceremonial Grade Matcha Green Tea Powder - ...",
    "country_code": "us",
    "average_organic_rank": 9,
    "weekly_number_of_days_with_deal": 4,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 5.66,
    "impression_share": 3.66,
    "price": 17.847142857,
    "click_share_rank": 3,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": "Crafti",
    "asin": "B0CXT6L9H5",
    "product_title": "Crafti Ceremonial Grade Matcha Powder (Organic) - ...",
    "country_code": "us",
    "average_organic_rank": 21,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 1.97,
    "impression_share": 3.32,
    "price": 20.95,
    "click_share_rank": 10,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": "Jade Leaf Matcha",
    "asin": "B089Q9XD2T",
    "product_title": "Jade Leaf Matcha Organic Premium Ceremonial Grade ...",
    "country_code": "us",
    "average_organic_rank": 7,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 3,
    "click_share": 4.47,
    "impression_share": 3.63,
    "price": 30.984285714,
    "click_share_rank": 6,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": "Jade Leaf Matcha",
    "asin": "B00PFDH0IC",
    "product_title": "Jade Leaf Matcha Organic Premium Ceremonial Grade ...",
    "country_code": "us",
    "average_organic_rank": 1,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 7,
    "click_share": 13.99,
    "impression_share": 4.45,
    "price": 10.99,
    "click_share_rank": 1,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": "Jade Leaf Matcha",
    "asin": "B01DTQD7VA",
    "product_title": "Jade Leaf Matcha Organic Premium Ceremonial Grade ...",
    "country_code": "us",
    "average_organic_rank": 6,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 7,
    "click_share": 4.83,
    "impression_share": 3.32,
    "price": 10.99,
    "click_share_rank": 5,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": null,
    "asin": "B097Z6ZH1S",
    "product_title": "Jade Leaf Matcha Premium Ceremonial Grade Matcha G...",
    "country_code": "us",
    "average_organic_rank": 10,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 7,
    "click_share": 2.78,
    "impression_share": 2.64,
    "price": 17.99,
    "click_share_rank": 8,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": "Micro Ingredients",
    "asin": "B08PY3Q8XS",
    "product_title": "Micro Ingredients Organic Matcha Green Tea Powder,...",
    "country_code": "us",
    "average_organic_rank": 3,
    "weekly_number_of_days_with_deal": 7,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 5,
    "weekly_number_of_days_with_coupon": 7,
    "click_share": 5.16,
    "impression_share": 3.71,
    "price": 23.19,
    "click_share_rank": 4,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": "Naoki Matcha",
    "asin": "B01L2GW7SI",
    "product_title": "Naoki Matcha Superior Ceremonial Blend \u2013 Authentic...",
    "country_code": "us",
    "average_organic_rank": 3,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 4,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 8.35,
    "impression_share": 5.1,
    "price": 24.99,
    "click_share_rank": 2,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": null,
    "asin": "B0DV6Z5MYZ",
    "product_title": "Soeos Organic Matcha Powder, Matcha Green Tea Powd...",
    "country_code": "us",
    "average_organic_rank": 12,
    "weekly_number_of_days_with_deal": 4,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 2.47,
    "impression_share": 1.83,
    "price": 6.69,
    "click_share_rank": 9,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  },
  {
    "brand_aggregation": "purechimp",
    "parent_asin": "Matcha Powder Jar",
    "reporting_date": "2026-01-17",
    "week_date": "2026-03",
    "keywords": "matcha powder",
    "competitor_brand": "MATCHA DNA",
    "asin": "B077572GG8",
    "product_title": "MATCHA DNA Certified Organic Matcha Green Tea Powd...",
    "country_code": "us",
    "average_organic_rank": 8,
    "weekly_number_of_days_with_deal": 7,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 3.93,
    "impression_share": 4.82,
    "price": 19.99,
    "click_share_rank": 7,
    "weekly_search_volume": 110647.87,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.com/s?k=matcha+powder"
  }
];

        // LOGIC & APP
        google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
        google.charts.setOnLoadCallback(initApp);

        // Global State
        let processedData = [];
        let ourBrandName = "";
        let topCompetitors = [];
        let weeks = [];
        
        function initApp() {
            processData();
            updateHeader();
            renderStaticReport();
            setupInteractiveControls();
        }

        // --- Data Processing Engine ---
        function processData() {
            // 1. Clean Brands
            processedData = marketData.map(item => {
                let brand = item.competitor_brand;
                if (!brand) {
                    // Fallback to extraction
                    if (item.product_title) {
                        brand = item.product_title.split(' ').slice(0, 2).join(' ');
                    } else if (item.keywords_link) {
                        // Very rough fallback
                        brand = "Unknown Brand"; 
                    } else {
                        brand = "Unknown Brand";
                    }
                }
                
                // Calculate Estimated Clicks
                const estClicks = (item.click_share / 100) * item.weekly_search_volume;

                return {
                    ...item,
                    real_brand: brand,
                    est_clicks: estClicks
                };
            });

            // 2. Identify Our Brand
            const ourAsinData = processedData.find(d => d.is_yaba_asin === 'Y');
            ourBrandName = ourAsinData ? ourAsinData.real_brand : "Nuestra Marca (No ID)";

            // 3. Identify Top 3 Competitors (by Total Click Share Volume)
            const brandShares = {};
            processedData.forEach(d => {
                if (d.real_brand === ourBrandName) return;
                if (!brandShares[d.real_brand]) brandShares[d.real_brand] = 0;
                brandShares[d.real_brand] += d.click_share;
            });

            topCompetitors = Object.keys(brandShares)
                .sort((a, b) => brandShares[b] - brandShares[a])
                .slice(0, 3);

            // 4. Get Unique Weeks
            weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        }

        function updateHeader() {
            document.getElementById('reportSubtitle').textContent = 
                `Parent: ${marketData[0].parent_asin} | Weeks: ${weeks.length} | Last: ${weeks[weeks.length-1]}`;
            
            const badge = document.getElementById('ourBrandBadge');
            badge.textContent = `Nuestra Marca: ${ourBrandName}`;
            badge.className = "badge badge-info";
        }

        // --- Section 1: Trend Analysis ---
        function renderStaticReport() {
            drawTrendChart();
            drawCompetitivenessChart();
            drawDriversAnalysis();
            drawEfficiencyChart();
            generateInsights();
        }

        function drawTrendChart() {
            // Aggregate by week for Us vs Competitors
            const weekMap = {};
            
            weeks.forEach(week => {
                weekMap[week] = { 
                    us_clicks: 0, comp_clicks: 0, 
                    us_share_sum: 0, us_count: 0,
                    total_search_vol: 0 
                };
            });

            processedData.forEach(d => {
                const w = d.week_date;
                if (d.is_yaba_asin === 'Y') {
                    weekMap[w].us_clicks += d.est_clicks;
                    weekMap[w].us_share_sum += d.click_share;
                    weekMap[w].us_count++;
                } else {
                    weekMap[w].comp_clicks += d.est_clicks;
                }
                // Naive volume summation (assumes rows are unique ASINs per keyword, need to be careful not to double count volume if multiple keywords exist. 
                // However, prompt implies "All keywords unified". Let's use search volume of one entry per week or sum? 
                // To be safe, let's track clicks (absolute) and share (relative).
            });

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', 'Clicks Nuestros');
            dataTable.addColumn('number', 'Clicks Competencia');
            dataTable.addColumn('number', 'Nuestra Cuota (%)');

            const rows = weeks.map(w => {
                const d = weekMap[w];
                const avgShare = d.us_count > 0 ? (d.us_share_sum / d.us_count) : 0; // Or total share? Usually share is additive within search results. Let's use sum of share for our ASINs.
                return [w, d.us_clicks, d.comp_clicks, d.us_share_sum];
            });

            dataTable.addRows(rows);

            const options = {
                title: 'Evolución de Clicks y Cuota de Mercado',
                vAxes: {
                    0: {title: 'Clicks Estimados'},
                    1: {title: 'Click Share (%)', format: '#\'%\''}
                },
                hAxis: {title: 'Semana'},
                seriesType: 'bars',
                series: {
                    0: {targetAxisIndex: 0, color: '#4285F4'}, // Us Clicks
                    1: {targetAxisIndex: 0, color: '#E0E0E0'}, // Comp Clicks
                    2: {targetAxisIndex: 1, type: 'line', color: '#34A853', lineWidth: 3} // Our Share
                },
                isStacked: true,
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('trend_chart_div'));
            chart.draw(dataTable, options);

            // Text Summary
            const lastWeek = rows[rows.length-1];
            const prevWeek = rows.length > 1 ? rows[rows.length-2] : null;
            let trendText = `En la última semana (${lastWeek[0]}), obtuvimos ${Math.round(lastWeek[1])} clics con una cuota del ${lastWeek[3].toFixed(2)}%.`;
            
            if (prevWeek) {
                const deltaShare = lastWeek[3] - prevWeek[3];
                trendText += deltaShare > 0 ? 
                    ` La cuota creció un ${deltaShare.toFixed(2)}% vs la semana anterior.` : 
                    ` La cuota cayó un ${Math.abs(deltaShare).toFixed(2)}% vs la semana anterior.`;
            } else {
                trendText += " Datos históricos limitados a una semana.";
            }
            document.getElementById('trend_summary').innerText = trendText;
        }

        // --- Section 2: Competitiveness ---
        function drawCompetitivenessChart() {
            // Columns: Week, Our Brand, Comp 1, Comp 2, Comp 3, Rest
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', ourBrandName);
            topCompetitors.forEach(c => dataTable.addColumn('number', c));
            dataTable.addColumn('number', 'Resto');

            const rows = weeks.map(w => {
                const weekData = processedData.filter(d => d.week_date === w);
                
                // Sum shares by brand
                let ourShare = 0;
                let compShares = [0, 0, 0];
                let restShare = 0;

                weekData.forEach(d => {
                    if (d.real_brand === ourBrandName) ourShare += d.click_share;
                    else {
                        const idx = topCompetitors.indexOf(d.real_brand);
                        if (idx > -1) compShares[idx] += d.click_share;
                        else restShare += d.click_share;
                    }
                });

                return [w, ourShare, ...compShares, restShare];
            });

            dataTable.addRows(rows);

            const options = {
                title: 'Click Share: Nosotros vs Top 3 Competidores',
                curveType: 'function',
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
                vAxis: { title: 'Click Share (%)' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('competitiveness_chart_div'));
            chart.draw(dataTable, options);

            // Metrics Box
            const metricsHtml = [ourBrandName, ...topCompetitors].map((brand, idx) => {
                // Get latest share
                const lastRow = rows[rows.length-1];
                const share = lastRow[idx+1]; // +1 because index 0 is week
                return `
                    <div class="metric-box">
                        <div class="metric-value">${share.toFixed(1)}%</div>
                        <div class="metric-label">${brand}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('competitor_metrics').innerHTML = metricsHtml;
        }

        // --- Section 3: Drivers ---
        function drawDriversAnalysis() {
            // Analyze Price vs Share correlation (Scatter)
            // But prompt asks for "Drivers" generally. Let's do a simple Bar chart for Promo Impact
            
            // Calculate Avg Share when Deal vs No Deal
            let dealShare = 0, dealCount = 0;
            let noDealShare = 0, noDealCount = 0;
            
            processedData.forEach(d => {
                if (d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0) {
                    dealShare += d.click_share;
                    dealCount++;
                } else {
                    noDealShare += d.click_share;
                    noDealCount++;
                }
            });

            const avgDealShare = dealCount ? dealShare/dealCount : 0;
            const avgNoDealShare = noDealCount ? noDealShare/noDealCount : 0;

            // Draw Chart: Price vs Share Scatter for latest week
            const latestWeekData = processedData.filter(d => d.week_date === weeks[weeks.length-1]);
            const scatterData = [['Price', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
            
            latestWeekData.forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#999';
                scatterData.push([d.price, d.click_share, `point { fill-color: ${color} }`, `${d.real_brand}: $${d.price} (${d.click_share}%)`]);
            });

            const dataTable = google.visualization.arrayToDataTable(scatterData);
            const options = {
                title: 'Elasticidad: Precio vs Click Share (Última Semana)',
                hAxis: { title: 'Precio ($)' },
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                chartArea: { width: '80%', height: '70%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('drivers_chart_div'));
            chart.draw(dataTable, options);

            // Table for Promo Impact
            const tableData = new google.visualization.DataTable();
            tableData.addColumn('string', 'Estado');
            tableData.addColumn('number', 'Avg Share');
            tableData.addRows([
                ['Con Promo/Deal', avgDealShare],
                ['Precio Full', avgNoDealShare]
            ]);

            const table = new google.visualization.Table(document.getElementById('promo_impact_table_div'));
            table.draw(tableData, {width: '100%', height: '100%'});
        }

        // --- Section 4: Efficiency ---
        function drawEfficiencyChart() {
            // X: Rank, Y: Share
            const latestWeekData = processedData.filter(d => d.week_date === weeks[weeks.length-1]);
            
            const data = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
            latestWeekData.forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? '#4285F4' : (topCompetitors.includes(d.real_brand) ? '#EA4335' : '#ccc');
                const label = `${d.real_brand} (Rank ${d.average_organic_rank})`;
                data.push([d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: 5; }`, label]);
            });

            const dataTable = google.visualization.arrayToDataTable(data);
            const options = {
                title: 'Eficiencia Orgánica: Rank vs Conversión a Clics',
                hAxis: { title: 'Rank Orgánico (Invertido)', direction: -1 }, // Rank 1 is better
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                chartArea: { width: '80%', height: '70%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart_div'));
            chart.draw(dataTable, options);
        }

        // --- Insights Generator ---
        function generateInsights() {
            const insightsList = document.getElementById('key_insights_list');
            const recList = document.getElementById('recommendations_list');
            const otherList = document.getElementById('other_insights_list');
            
            const latestData = processedData.filter(d => d.week_date === weeks[weeks.length-1]);
            const ourData = latestData.find(d => d.is_yaba_asin === 'Y');
            
            // Insight 1: Share vs Leader
            if (ourData) {
                const leader = latestData.reduce((prev, current) => (prev.click_share > current.click_share) ? prev : current);
                const gap = (leader.click_share - ourData.click_share).toFixed(1);
                
                addInsight(insightsList, 'trending_up', 'Posición Competitiva', 
                    leader.asin === ourData.asin ? 
                    `¡Lideramos la categoría con un ${ourData.click_share}% de cuota!` : 
                    `Estamos a ${gap} puntos de cuota del líder (${leader.real_brand}).`);

                // Insight 2: Pricing
                const avgMarketPrice = latestData.reduce((sum, d) => sum + (d.price || 0), 0) / latestData.length;
                const priceDiff = ((ourData.price - avgMarketPrice) / avgMarketPrice) * 100;
                
                addInsight(insightsList, 'attach_money', 'Estrategia de Precio', 
                    `Nuestro precio ($${ourData.price}) es un ${Math.abs(priceDiff).toFixed(0)}% ${priceDiff > 0 ? 'más alto' : 'más bajo'} que el promedio del mercado ($${avgMarketPrice.toFixed(2)}).`);

                // Recommendation 1
                if (ourData.average_organic_rank > 5) {
                    addInsight(recList, 'arrow_upward', 'Mejorar Visibilidad Orgánica', 
                        `Tu rank promedio es ${ourData.average_organic_rank}. Revisa títulos y backend keywords para subir al Top 5.`);
                } else {
                    addInsight(recList, 'verified', 'Mantener Defensa de Top Rank', 
                        `Excelente posicionamiento (Rank ${ourData.average_organic_rank}). Considera defensa con PPC defensivo.`);
                }

                // Recommendation 2: Deals
                if (ourData.weekly_number_of_days_with_deal === 0 && ourData.click_share < 10) {
                     addInsight(recList, 'local_offer', 'Activar Promociones', 
                        `Baja cuota sin deals activos. Prueba cupones para aumentar CTR.`);
                }

            } else {
                addInsight(insightsList, 'warning', 'Alerta de Datos', 'No se encontraron datos de "Nuestra Marca" (is_yaba_asin=Y) en la última semana.');
            }

            // Other Insights: Emerging Competitors
            const emerging = latestData.filter(d => d.click_share > 5 && !topCompetitors.includes(d.real_brand) && d.real_brand !== ourBrandName);
            if (emerging.length > 0) {
                addInsight(otherList, 'new_releases', 'Competidor Emergente', 
                    `${emerging[0].real_brand} está capturando ${emerging[0].click_share}% de cuota fuera del radar habitual.`);
            } else {
                addInsight(otherList, 'check', 'Mercado Estable', 'No se detectan nuevos entrantes agresivos esta semana.');
            }
        }

        function addInsight(container, icon, title, text) {
            const li = document.createElement('li');
            li.className = 'insight-item';
            li.innerHTML = `
                <div class="insight-icon"><span class="material-icons">${icon}</span></div>
                <div class="insight-text"><strong>${title}</strong>${text}</div>
            `;
            container.appendChild(li);
        }

        // --- Interactive Tab Logic ---
        function setupInteractiveControls() {
            const compSelect = document.getElementById('competitorSelect');
            const allCompetitors = [...new Set(processedData.map(d => d.real_brand).filter(b => b !== ourBrandName))];
            
            allCompetitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                compSelect.appendChild(opt);
            });
            
            updateInteractiveView();
        }

        function updateInteractiveView() {
            const competitor = document.getElementById('competitorSelect').value;
            const metric = document.getElementById('metricSelect').value;
            if(!competitor) return;

            // Prepare Data for Chart
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', 'Nosotros');
            dataTable.addColumn('number', competitor);

            const rows = weeks.map(w => {
                const usData = processedData.find(d => d.week_date === w && d.real_brand === ourBrandName);
                const compData = processedData.find(d => d.week_date === w && d.real_brand === competitor);
                return [
                    w, 
                    usData ? usData[metric] : 0, 
                    compData ? compData[metric] : 0
                ];
            });

            dataTable.addRows(rows);

            const options = {
                title: `Comparativa: ${metric.replace('_', ' ').toUpperCase()}`,
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335'],
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('interactive_chart_div'));
            chart.draw(dataTable, options);

            // Table View
            const table = new google.visualization.Table(document.getElementById('interactive_table_div'));
            table.draw(dataTable, {width: '100%', height: '200px'});
        }

        // --- Utility ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#static-tab, #interactive-tab').forEach(d => d.classList.add('hidden'));
            
            if(tabName === 'static') {
                document.getElementById('static-tab').classList.remove('hidden');
                document.querySelector('.tab-btn:first-child').classList.add('active');
                renderStaticReport(); // Redraw to fix chart widths
            } else {
                document.getElementById('interactive-tab').classList.remove('hidden');
                document.querySelector('.tab-btn:last-child').classList.add('active');
                updateInteractiveView();
            }
        }
        
        // Window Resize Handler
        window.addEventListener('resize', () => {
            if(!document.getElementById('static-tab').classList.contains('hidden')) renderStaticReport();
            else updateInteractiveView();
        });

    </script>
</body>
</html>