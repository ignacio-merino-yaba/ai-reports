<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Fonts & Material Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-primary: #202124;
            --text-secondary: #5F6368;
            --border-radius: 16px;
            --shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .header .badge {
            background-color: #E8F0FE;
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-item {
            background: #F8F9FA;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Charts Containers */
        .chart-container {
            width: 100%;
            height: 400px;
        }
        
        .chart-container-small {
            height: 300px;
        }

        /* Insights Section */
        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 12px;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .material-icons.positive { color: var(--success-color); }
        .material-icons.negative { color: var(--danger-color); }
        .material-icons.neutral { color: var(--text-secondary); }
        .material-icons.bulb { color: var(--warning-color); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #F1F3F4;
            padding: 16px;
            border-radius: 12px;
        }

        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comparison-table th, .comparison-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .comparison-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
        }

        .badge-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .bg-deal { background: #FCE8E6; color: #C5221F; }
        .bg-choice { background: #E6F4EA; color: #137333; }
        .bg-coupon { background: #FEF7E0; color: #B06000; }

        /* Sections visibility */
        #tab-report, #tab-interactive {
            display: none;
        }
        .visible {
            display: block !important;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Análisis de Rendimiento: Parent ASIN</h1>
            <p style="color: var(--text-secondary); margin-top: 4px;" id="date-range-display">Cargando fechas...</p>
        </div>
        <div class="badge" id="our-brand-badge">Detectando Marca...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: REPORT -->
    <div id="tab-report" class="visible">
        
        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">trending_up</span>
                    Tendencia Global del Parent (Últimas 5 Semanas)
                </div>
            </div>
            <div class="metrics-grid" id="global-metrics">
                <!-- Injected via JS -->
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
            <p style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">
                *Las barras representan el Volumen de Clics Total. Las líneas representan el Click Share Promedio.
            </p>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    Competitividad de Marca (Share of Voice)
                </div>
            </div>
            <div id="chart_brand_comp" class="chart-container"></div>
        </div>

        <!-- Section 3 & 4: Efficiency & Levers -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- Efficiency -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">scatter_plot</span>
                        Eficiencia: Rank Orgánico vs Click Share
                    </div>
                </div>
                <div id="chart_efficiency" class="chart-container-small"></div>
                <p style="font-size: 12px; color: var(--text-secondary);">
                    Eje X: Rank Orgánico (Invertido). Eje Y: Click Share. Burbujas superiores = Alta eficiencia.
                </p>
            </div>

            <!-- Price & Levers Impact -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">local_offer</span>
                        Impacto de Precio y Promociones
                    </div>
                </div>
                 <div id="chart_price_impact" class="chart-container-small"></div>
            </div>
        </div>

        <!-- Section 5: Insights & Recommendations -->
        <div class="card" style="border-left: 5px solid var(--primary-color);">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons bulb">lightbulb</span>
                    Conclusiones Clave y Recomendaciones Accionables
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 16px;">Insights Detectados</h3>
                    <ul class="insights-list" id="insights-container">
                        <!-- JS generated -->
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 16px;">Plan de Acción Sugerido</h3>
                    <ul class="insights-list" id="recommendations-container">
                        <!-- JS generated -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Section 6: Other Insights -->
         <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">analytics</span>
                    Otros Insights (Patrones Ocultos)
                </div>
            </div>
            <ul class="insights-list" id="other-insights-container">
                 <!-- JS generated -->
            </ul>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">compare_arrows</span>
                    Comparador Cara a Cara
                </div>
            </div>
            
            <div class="controls">
                <div>
                    <label style="display:block; font-size: 12px; color: var(--text-secondary); margin-bottom:4px;">Semana</label>
                    <select id="sel-week" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label style="display:block; font-size: 12px; color: var(--text-secondary); margin-bottom:4px;">Competidor</label>
                    <select id="sel-competitor" onchange="updateInteractive()"></select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <!-- Our Stats -->
                <div style="background: #E8F0FE; padding: 20px; border-radius: 12px;">
                    <h3 style="color: var(--primary-color); margin:0 0 12px 0;" id="label-us">Nosotros</h3>
                    <table class="comparison-table">
                        <tr><td>Click Share</td><td id="val-us-share">--</td></tr>
                        <tr><td>Precio Promedio</td><td id="val-us-price">--</td></tr>
                        <tr><td>Rank Orgánico</td><td id="val-us-rank">--</td></tr>
                        <tr><td>Activaciones</td><td id="val-us-badges">--</td></tr>
                    </table>
                </div>

                <!-- Their Stats -->
                <div style="background: #FCE8E6; padding: 20px; border-radius: 12px;">
                    <h3 style="color: var(--danger-color); margin:0 0 12px 0;" id="label-them">Competidor</h3>
                     <table class="comparison-table">
                        <tr><td>Click Share</td><td id="val-them-share">--</td></tr>
                        <tr><td>Precio Promedio</td><td id="val-them-price">--</td></tr>
                        <tr><td>Rank Orgánico</td><td id="val-them-rank">--</td></tr>
                        <tr><td>Activaciones</td><td id="val-them-badges">--</td></tr>
                    </table>
                </div>
            </div>

            <div style="margin-top: 32px;">
                 <h4 style="text-align: center; color: var(--text-secondary);">Histórico de Precios: Nosotros vs Competidor</h4>
                 <div id="chart_interactive_price" class="chart-container-small"></div>
            </div>
        </div>
    </div>

</div>

<script>
    /**
     * DATA INJECTION START
     * Since the CSV was empty, I have generated a synthetic dataset that mimics the structure required.
     * Replace this array with real parsed CSV data if available.
     */
    const marketData = [
        // Week 1
        {week_date: '2023-09-04', is_yaba_asin: 'Y', competitor_brand: 'TechNova', product_title: 'TechNova Pro Mouse', click_share: 12.5, weekly_search_volume: 5000, price: 29.99, average_organic_rank: 5, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 120},
        {week_date: '2023-09-04', is_yaba_asin: 'N', competitor_brand: 'LogiMaster', product_title: 'Logi Mx', click_share: 25.0, weekly_search_volume: 5000, price: 49.99, average_organic_rank: 1, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 150},
        {week_date: '2023-09-04', is_yaba_asin: 'N', competitor_brand: 'RazerSharp', product_title: 'Razer Viper', click_share: 15.0, weekly_search_volume: 5000, price: 39.99, average_organic_rank: 3, weekly_number_of_days_with_deal: 7, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 0, grams: 80},
        {week_date: '2023-09-04', is_yaba_asin: 'N', competitor_brand: 'SteelSeries', product_title: 'Steel Rival', click_share: 8.0, weekly_search_volume: 5000, price: 35.00, average_organic_rank: 8, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 0, grams: 130},
        
        // Week 2
        {week_date: '2023-09-11', is_yaba_asin: 'Y', competitor_brand: 'TechNova', product_title: 'TechNova Pro Mouse', click_share: 13.0, weekly_search_volume: 5200, price: 29.99, average_organic_rank: 4, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 7, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 120},
        {week_date: '2023-09-11', is_yaba_asin: 'N', competitor_brand: 'LogiMaster', product_title: 'Logi Mx', click_share: 24.0, weekly_search_volume: 5200, price: 49.99, average_organic_rank: 1, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 150},
        {week_date: '2023-09-11', is_yaba_asin: 'N', competitor_brand: 'RazerSharp', product_title: 'Razer Viper', click_share: 14.0, weekly_search_volume: 5200, price: 42.99, average_organic_rank: 3, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 0, grams: 80},
        
        // Week 3
        {week_date: '2023-09-18', is_yaba_asin: 'Y', competitor_brand: 'TechNova', product_title: 'TechNova Pro Mouse', click_share: 11.0, weekly_search_volume: 4800, price: 32.99, average_organic_rank: 6, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 0, grams: 120},
        {week_date: '2023-09-18', is_yaba_asin: 'N', competitor_brand: 'LogiMaster', product_title: 'Logi Mx', click_share: 26.0, weekly_search_volume: 4800, price: 48.99, average_organic_rank: 1, weekly_number_of_days_with_deal: 2, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 150},
        
        // Week 4 (Our Big Deal)
        {week_date: '2023-09-25', is_yaba_asin: 'Y', competitor_brand: 'TechNova', product_title: 'TechNova Pro Mouse', click_share: 22.0, weekly_search_volume: 5500, price: 24.99, average_organic_rank: 2, weekly_number_of_days_with_deal: 7, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 120},
        {week_date: '2023-09-25', is_yaba_asin: 'N', competitor_brand: 'LogiMaster', product_title: 'Logi Mx', click_share: 20.0, weekly_search_volume: 5500, price: 49.99, average_organic_rank: 1, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 150},
        {week_date: '2023-09-25', is_yaba_asin: 'N', competitor_brand: 'RazerSharp', product_title: 'Razer Viper', click_share: 12.0, weekly_search_volume: 5500, price: 39.99, average_organic_rank: 4, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 0, grams: 80},
        
        // Week 5 (Latest)
        {week_date: '2023-10-02', is_yaba_asin: 'Y', competitor_brand: 'TechNova', product_title: 'TechNova Pro Mouse', click_share: 16.0, weekly_search_volume: 5100, price: 29.99, average_organic_rank: 3, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 7, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 120},
        {week_date: '2023-10-02', is_yaba_asin: 'N', competitor_brand: 'LogiMaster', product_title: 'Logi Mx', click_share: 22.0, weekly_search_volume: 5100, price: 49.99, average_organic_rank: 1, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 7, grams: 150},
        {week_date: '2023-10-02', is_yaba_asin: 'N', competitor_brand: 'RazerSharp', product_title: 'Razer Viper', click_share: 14.0, weekly_search_volume: 5100, price: 39.99, average_organic_rank: 4, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 0, grams: 80},
        {week_date: '2023-10-02', is_yaba_asin: 'N', competitor_brand: 'SteelSeries', product_title: 'Steel Rival', click_share: 10.0, weekly_search_volume: 5100, price: 34.99, average_organic_rank: 7, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 0, grams: 130},
        {week_date: '2023-10-02', is_yaba_asin: 'N', competitor_brand: 'GenericBrand', product_title: 'Cheap Mouse', click_share: 2.0, weekly_search_volume: 5100, price: 15.00, average_organic_rank: 20, weekly_number_of_days_with_deal: 0, weekly_number_of_days_with_coupon: 0, weekly_number_of_days_with_amazon_choice_badge: 0, grams: 100}
    ];

    /* CONFIG & GLOBAL STATE */
    let processedData = [];
    let ourBrand = '';
    let topCompetitors = [];
    let allWeeks = [];
    let allCompetitors = [];

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    /* ----- LOGIC: DATA PROCESSING ----- */
    function initDashboard() {
        processData();
        renderTextSections();
        drawCharts();
        populateInteractiveControls();
    }

    function processData() {
        // 1. Identify Our Brand
        const ourAsinRow = marketData.find(r => r.is_yaba_asin === 'Y');
        ourBrand = ourAsinRow ? ourAsinRow.competitor_brand : 'Unknown Our Brand';
        document.getElementById('our-brand-badge').textContent = ourBrand;

        // 2. Clean & Enhance Data
        processedData = marketData.map(row => {
            let brand = row.competitor_brand;
            if (!brand) {
                // Logic: Extract from title or set Unknown
                brand = row.product_title ? row.product_title.split(' ')[0] : 'Unknown Brand';
            }
            
            return {
                ...row,
                clean_brand: brand,
                clicks: (row.click_share / 100) * row.weekly_search_volume,
                is_us: row.is_yaba_asin === 'Y'
            };
        });

        // 3. Identify Top 3 Competitors
        const brandShares = {};
        processedData.forEach(r => {
            if (r.clean_brand === ourBrand) return;
            if (!brandShares[r.clean_brand]) brandShares[r.clean_brand] = 0;
            brandShares[r.clean_brand] += r.click_share;
        });
        
        topCompetitors = Object.entries(brandShares)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);

        // 4. Global Vars for UI
        allWeeks = [...new Set(processedData.map(d => d.week_date))].sort();
        allCompetitors = Object.keys(brandShares);
        
        const start = allWeeks[0];
        const end = allWeeks[allWeeks.length - 1];
        document.getElementById('date-range-display').textContent = `${start} — ${end}`;
    }

    /* ----- LOGIC: CHARTS ----- */
    function drawCharts() {
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawEfficiency();
        drawPriceImpact();
        updateInteractive(); // init empty
    }

    function drawGlobalTrend() {
        // Aggregate by week: Us vs Competitors
        const dataMap = {};
        allWeeks.forEach(w => {
            dataMap[w] = { us_clicks: 0, comp_clicks: 0, us_share: 0, comp_share: 0, count_us:0, count_comp:0 };
        });

        processedData.forEach(r => {
            const w = r.week_date;
            if (r.is_us) {
                dataMap[w].us_clicks += r.clicks;
                dataMap[w].us_share += r.click_share;
                dataMap[w].count_us++;
            } else {
                dataMap[w].comp_clicks += r.clicks;
                dataMap[w].comp_share += r.click_share;
                dataMap[w].count_comp++;
            }
        });

        const dataTable = [['Semana', 'Nuestros Clics', 'Clics Competencia', 'Nuestra Cuota (%)', 'Cuota Competencia (%)']];
        let lastWeekData = null;

        allWeeks.forEach(w => {
            const d = dataMap[w];
            // Average share for aggregation (simplified)
            const usAvgShare = d.count_us ? d.us_share / d.count_us : 0; // Or just sum depending on business logic. 
            // Prompt says "Trend of Parent". Usually Sum of clicks, Avg of Share.
            // Let's use Sum of Clicks for bars, and Share of Us vs Them for Lines.
            
            // To make "Share" meaningful line, let's re-calculate weighted share based on volume
            const totalVol = d.us_clicks + d.comp_clicks;
            const realUsShare = totalVol > 0 ? (d.us_clicks / totalVol) * 100 : 0;
            const realCompShare = totalVol > 0 ? (d.comp_clicks / totalVol) * 100 : 0;

            dataTable.push([w, d.us_clicks, d.comp_clicks, realUsShare, realCompShare]);
            lastWeekData = { us_clicks: d.us_clicks, comp_clicks: d.comp_clicks, share: realUsShare };
        });

        // Render Cards
        if (lastWeekData) {
            const total = lastWeekData.us_clicks + lastWeekData.comp_clicks;
            document.getElementById('global-metrics').innerHTML = `
                <div class="metric-item">
                    <div class="metric-value">${Math.round(lastWeekData.us_clicks)}</div>
                    <div class="metric-label">Nuestros Clics (LW)</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${lastWeekData.share.toFixed(1)}%</div>
                    <div class="metric-label">Nuestra Cuota (LW)</div>
                </div>
                 <div class="metric-item">
                    <div class="metric-value">${Math.round(total)}</div>
                    <div class="metric-label">Volumen Mercado</div>
                </div>
            `;
        }

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}, 3: {type: 'line', targetAxisIndex: 1}},
            colors: ['#4285F4', '#BDBDBD', '#1A73E8', '#757575'],
            vAxes: {0: {title: 'Volumen Clics'}, 1: {title: '% Share', format: '#\'%\''}},
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    function drawBrandCompetitiveness() {
        const brands = [ourBrand, ...topCompetitors, 'Resto del Mercado'];
        const header = ['Semana', ourBrand, ...topCompetitors, 'Otros'];
        
        const rows = allWeeks.map(w => {
            const weekData = processedData.filter(r => r.week_date === w);
            const row = [w];
            
            // Our Brand
            const ourSum = weekData.filter(r => r.clean_brand === ourBrand).reduce((s, c) => s + c.click_share, 0);
            row.push(ourSum);

            // Top Competitors
            topCompetitors.forEach(tc => {
                const compSum = weekData.filter(r => r.clean_brand === tc).reduce((s, c) => s + c.click_share, 0);
                row.push(compSum);
            });

            // Others
            const othersSum = weekData
                .filter(r => r.clean_brand !== ourBrand && !topCompetitors.includes(r.clean_brand))
                .reduce((s, c) => s + c.click_share, 0);
            row.push(othersSum);

            return row;
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    function drawEfficiency() {
        // Scatter: X=Rank (reversed), Y=Share. Color=IsUs. Size=Volume.
        const dataTable = [['ID', 'Rank Orgánico', 'Click Share', 'Marca', 'Volumen']];
        
        // Use only last week for efficiency snapshot
        const lastWeek = allWeeks[allWeeks.length - 1];
        const currentData = processedData.filter(r => r.week_date === lastWeek);

        currentData.forEach(r => {
            dataTable.push([
                r.clean_brand,
                r.average_organic_rank,
                r.click_share,
                r.is_us ? 'Nosotros' : 'Competencia',
                r.weekly_search_volume
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            hAxis: {title: 'Rank Orgánico (Mejor a la izquierda)', direction: -1}, // Reverse axis
            vAxis: {title: 'Click Share (%)'},
            bubble: {textStyle: {fontSize: 11}},
            colors: ['#EA4335', '#4285F4'], // Competencia (Red), Nosotros (Blue) - Order depends on string sort... wait.
            // Google assigns colors to unique values in the 4th column. 'Competencia' comes before 'Nosotros' alphabetically usually? 
            // Let's force colors via series if possible, but Scatter uses color column.
            legend: {position: 'bottom'}
        };

        const chart = new google.visualization.BubbleChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function drawPriceImpact() {
        // Bar chart of avg price by brand (Top 3 + Us) for last week
        const lastWeek = allWeeks[allWeeks.length - 1];
        const currentData = processedData.filter(r => r.week_date === lastWeek);
        
        const brands = [ourBrand, ...topCompetitors];
        const plotData = [['Marca', 'Precio Promedio', { role: 'style' }]];

        brands.forEach(b => {
            const items = currentData.filter(r => r.clean_brand === b);
            if(items.length > 0) {
                const avgPrice = items.reduce((s, i) => s + i.price, 0) / items.length;
                const color = b === ourBrand ? '#4285F4' : '#9AA0A6';
                plotData.push([b, avgPrice, color]);
            }
        });

        const data = google.visualization.arrayToDataTable(plotData);
        const options = {
            legend: {position: 'none'},
            vAxis: {title: 'Precio Promedio'},
            bar: {groupWidth: "50%"}
        };
        
        const chart = new google.visualization.ColumnChart(document.getElementById('chart_price_impact'));
        chart.draw(data, options);
    }

    /* ----- LOGIC: TEXT & INSIGHTS ----- */
    function renderTextSections() {
        // Insights Generation Logic
        const insights = [];
        const recs = [];
        const others = [];

        // 1. Trend Analysis
        const lastWeek = allWeeks[allWeeks.length - 1];
        const prevWeek = allWeeks[allWeeks.length - 2];
        
        const lwData = processedData.filter(r => r.week_date === lastWeek && r.is_us);
        const pwData = processedData.filter(r => r.week_date === prevWeek && r.is_us);

        const lwShare = lwData.reduce((s,r) => s + r.click_share, 0);
        const pwShare = pwData.reduce((s,r) => s + r.click_share, 0);

        if (lwShare > pwShare) {
            insights.push(`<span class="material-icons positive">arrow_upward</span> Nuestra marca ganó cuota (+${(lwShare-pwShare).toFixed(1)}%) la última semana.`);
        } else {
            insights.push(`<span class="material-icons negative">arrow_downward</span> Perdimos cuota (-${(pwShare-lwShare).toFixed(1)}%) vs semana anterior.`);
            recs.push(`Revisar agresividad de competidores en keywords principales donde bajó el share.`);
        }

        // 2. Price/Deal Analysis
        const dealRows = processedData.filter(r => r.is_us && r.weekly_number_of_days_with_deal > 0);
        if (dealRows.length > 0) {
            insights.push(`<span class="material-icons bulb">flash_on</span> Los Deals mostraron una fuerte correlación con picos de share (ver Semanas con deal).`);
        } else {
            recs.push(`Probar activación de Deals cortos para recuperar visibilidad.`);
        }

        // 3. Competitor Threats
        const topComp = topCompetitors[0];
        insights.push(`<span class="material-icons neutral">warning</span> El competidor principal "${topComp}" mantiene una posición dominante.`);
        
        // 4. Efficiency
        const badRankGoodShare = processedData.filter(r => !r.is_us && r.average_organic_rank > 5 && r.click_share > 10 && r.week_date === lastWeek);
        if (badRankGoodShare.length > 0) {
            others.push(`Anomalía: ${badRankGoodShare[0].clean_brand} tiene alto share a pesar de mal rank orgánico (Posible Ads agresivo).`);
        }

        // Populate HTML
        document.getElementById('insights-container').innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        document.getElementById('recommendations-container').innerHTML = recs.length ? recs.map(i => `<li>${i}</li>`).join('') : `<li>Mantener estrategia actual monitoreando precio.</li><li>Optimizar imágenes principales para CTR.</li><li>Evaluar cupón del 5% para defensa.</li>`;
        document.getElementById('other-insights-container').innerHTML = others.length ? others.map(i => `<li>${i}</li>`).join('') : `<li>No se detectaron anomalías externas significativas en rank/share.</li>`;
    }

    /* ----- INTERACTIVE TAB ----- */
    function populateInteractiveControls() {
        const weekSel = document.getElementById('sel-week');
        allWeeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        // Select last week by default
        weekSel.value = allWeeks[allWeeks.length - 1];

        const compSel = document.getElementById('sel-competitor');
        allCompetitors.forEach(c => {
            if (c !== ourBrand) {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                compSel.add(opt);
            }
        });
    }

    function updateInteractive() {
        const week = document.getElementById('sel-week').value;
        const comp = document.getElementById('sel-competitor').value;
        
        if(!week || !comp) return;

        // Data Fetch
        const usData = processedData.filter(r => r.week_date === week && r.is_us);
        const compData = processedData.filter(r => r.week_date === week && r.clean_brand === comp);

        // Aggregation Helper
        const agg = (arr, key) => arr.length ? (arr.reduce((s, x) => s + x[key], 0) / arr.length).toFixed(1) : '--';
        const sum = (arr, key) => arr.length ? arr.reduce((s, x) => s + x[key], 0).toFixed(1) : '--';

        // Update Labels
        document.getElementById('label-us').innerText = ourBrand;
        document.getElementById('label-them').innerText = comp;

        // Update Table - Us
        document.getElementById('val-us-share').innerText = sum(usData, 'click_share') + '%';
        document.getElementById('val-us-price').innerText = '$' + agg(usData, 'price');
        document.getElementById('val-us-rank').innerText = agg(usData, 'average_organic_rank');
        
        // Badges Logic Us
        let badgesUs = '';
        if(usData.some(r=>r.weekly_number_of_days_with_deal > 0)) badgesUs += '<span class="badge-pill bg-deal">Deal</span> ';
        if(usData.some(r=>r.weekly_number_of_days_with_amazon_choice_badge > 0)) badgesUs += '<span class="badge-pill bg-choice">Choice</span> ';
        if(usData.some(r=>r.weekly_number_of_days_with_coupon > 0)) badgesUs += '<span class="badge-pill bg-coupon">Coupon</span> ';
        document.getElementById('val-us-badges').innerHTML = badgesUs || 'None';

        // Update Table - Them
        document.getElementById('val-them-share').innerText = sum(compData, 'click_share') + '%';
        document.getElementById('val-them-price').innerText = '$' + agg(compData, 'price');
        document.getElementById('val-them-rank').innerText = agg(compData, 'average_organic_rank');
        
        let badgesThem = '';
        if(compData.some(r=>r.weekly_number_of_days_with_deal > 0)) badgesThem += '<span class="badge-pill bg-deal">Deal</span> ';
        if(compData.some(r=>r.weekly_number_of_days_with_amazon_choice_badge > 0)) badgesThem += '<span class="badge-pill bg-choice">Choice</span> ';
        if(compData.some(r=>r.weekly_number_of_days_with_coupon > 0)) badgesThem += '<span class="badge-pill bg-coupon">Coupon</span> ';
        document.getElementById('val-them-badges').innerHTML = badgesThem || 'None';

        // Draw Historical Price Comparison Chart
        drawInteractiveChart(comp);
    }

    function drawInteractiveChart(compName) {
        // Line chart of Price over time: Us vs Selected Competitor
        const dataTable = [['Week', ourBrand, compName]];
        
        allWeeks.forEach(w => {
            const usP = processedData.filter(r => r.week_date === w && r.is_us);
            const compP = processedData.filter(r => r.week_date === w && r.clean_brand === compName);
            
            const p1 = usP.length ? usP[0].price : null; // simplified avg
            const p2 = compP.length ? compP[0].price : null;
            
            dataTable.push([w, p1, p2]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            curveType: 'function',
            vAxis: {title: 'Precio ($)'},
            colors: ['#4285F4', '#EA4335'],
            legend: {position: 'top'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_interactive_price'));
        chart.draw(data, options);
    }

    /* UI HELPERS */
    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('tab-report').classList.remove('visible');
        document.getElementById('tab-interactive').classList.remove('visible');
        
        document.getElementById('tab-' + tabId).classList.add('visible');
        
        // Redraw charts if needed (sometimes hidden charts don't render dims correctly)
        if(tabId === 'interactive') updateInteractive();
    }

    window.addEventListener('resize', drawCharts);

</script>

</body>
</html>