<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Estratégico Parent ASIN</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --danger-color: #EA4335; /* Google Red */
            --warning-color: #FBBC05; /* Google Yellow */
            --text-main: #202124;
            --text-secondary: #5f6368;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 24px;
            padding: 0 8px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-main);
            margin: 0;
        }

        h2 {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #dadce0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards & Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            .col-8, .col-6, .col-4 { grid-column: span 12; }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            height: 100%;
            box-sizing: border-box;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        /* Metrics */
        .metric-group {
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }

        .metric {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: #f1f3f4;
            border-radius: 8px;
        }

        .metric-val {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: flex-start;
        }

        .insight-icon {
            color: var(--primary-color);
            margin-top: 2px;
        }

        .insight-text {
            font-size: 14px;
            color: var(--text-main);
        }

        .recommendation {
            background-color: #e8f0fe;
            border-left: 4px solid var(--primary-color);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }

        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            background-color: white;
        }

        /* Comparison Table */
        .comp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .comp-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #dadce0;
            color: var(--text-secondary);
        }

        .comp-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }
        .badge.green { background-color: var(--secondary-color); }
        .badge.blue { background-color: var(--primary-color); }
        .badge.grey { background-color: #9aa0a6; }

        .chart-div {
            width: 100%;
            height: 350px;
        }
        
        .mini-chart {
            height: 250px;
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="material-icons" style="font-size: 32px; color: var(--primary-color);">analytics</span>
            <div>
                <h1>Reporte de Inteligencia de Mercado</h1>
                <h2 id="report-subtitle">Análisis Parent ASIN</h2>
            </div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Ejecutivo</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="tab-static" class="tab-content active">
        
        <!-- KPIs Globales Última Semana -->
        <div class="grid">
            <div class="col-12 card" style="padding: 16px;">
                <div class="metric-group" id="kpi-container">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Sección 1: Tendencia Global -->
        <div class="grid">
            <div class="col-8 card">
                <h3><span class="material-icons">trending_up</span> Tendencia Global del Parent (Clicks & Share)</h3>
                <div id="chart_trend" class="chart-div"></div>
            </div>
            <div class="col-4 card">
                <h3><span class="material-icons">lightbulb</span> Insights de Tendencia</h3>
                <ul class="insight-list" id="trend-insights">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>

        <!-- Sección 2: Competitividad de Marca -->
        <div class="grid">
            <div class="col-12 card">
                <h3><span class="material-icons">pie_chart</span> Competitividad de Marca (Click Share Semanal)</h3>
                <div id="chart_competitiveness" class="chart-div"></div>
                <div style="margin-top: 16px; font-size: 13px; color: var(--text-secondary);" id="comp-summary"></div>
            </div>
        </div>

        <!-- Sección 3: Palancas -->
        <div class="grid">
            <div class="col-6 card">
                <h3><span class="material-icons">ads_click</span> Impacto de Palancas (Precio & Deals)</h3>
                <div id="chart_drivers" class="mini-chart"></div>
            </div>
            <div class="col-6 card">
                <h3><span class="material-icons">verified</span> Análisis de Drivers</h3>
                <div id="drivers-text" style="font-size: 14px;"></div>
            </div>
        </div>

        <!-- Sección 4: Eficiencia -->
        <div class="grid">
            <div class="col-12 card">
                <h3><span class="material-icons">scatter_plot</span> Eficiencia: Organic Rank vs Click Share</h3>
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">*Eje Y: Click Share | Eje X: Rank (Invertido, menor es mejor). Puntos arriba a la derecha son Overperformers.</p>
                <div id="chart_efficiency" class="chart-div"></div>
            </div>
        </div>

        <!-- Sección 5: Conclusiones -->
        <div class="grid">
            <div class="col-6 card" style="border-left: 5px solid var(--primary-color);">
                <h3><span class="material-icons">auto_awesome</span> Conclusiones Clave</h3>
                <ul class="insight-list" id="conclusions-list"></ul>
            </div>
            <div class="col-6 card" style="border-left: 5px solid var(--secondary-color);">
                <h3><span class="material-icons">build</span> Recomendaciones Accionables</h3>
                <div id="recommendations-container"></div>
            </div>
        </div>
        
        <!-- Other Insights -->
        <div class="grid">
            <div class="col-12 card">
                <h3><span class="material-icons">visibility</span> Otros Hallazgos</h3>
                <ul class="insight-list" id="other-insights"></ul>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
    <div id="tab-interactive" class="tab-content">
        <div class="card controls">
            <div>
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Semana</label>
                <select id="select-week" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Competidor</label>
                <select id="select-competitor" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="grid">
            <div class="col-12 card">
                <h3>Cara a Cara: Nosotros vs Competidor</h3>
                <table class="comp-table">
                    <thead>
                        <tr>
                            <th>Métrica</th>
                            <th id="th-us" style="color: var(--primary-color);">Nuestra Marca</th>
                            <th id="th-comp" style="color: var(--danger-color);">Competidor</th>
                            <th>Diferencia</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-tbody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid">
            <div class="col-6 card">
                 <h3>Comparativa de Precios</h3>
                 <div id="chart_price_comp" class="mini-chart"></div>
            </div>
             <div class="col-6 card">
                 <h3>Badges Activos</h3>
                 <div id="badges-comp" style="display: flex; gap: 20px; justify-content: center; margin-top: 40px;"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA SCRIPT -->
<script>
    // DATA INJECTION POINT
    const marketData = [{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-01","keywords":"coffee maker","competitor_brand":"YabaBrand","asin":"B00OURASIN1","product_title":"YabaBrand Premium Coffee Maker","country_code":"ES","average_organic_rank":9,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":18.4237190184,"price":49.99,"weekly_search_volume":10000,"is_yaba_asin":"Y","keywords_link":"http://amazon...","grams":500},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-01","keywords":"coffee maker","competitor_brand":"CompA","asin":"B00COMP0","product_title":"CompA Standard Coffee Machine","country_code":"ES","average_organic_rank":15,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":6.657572702,"price":45.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":450},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-01","keywords":"coffee maker","competitor_brand":"CompB","asin":"B00COMP1","product_title":"CompB Standard Coffee Machine","country_code":"ES","average_organic_rank":49,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":12.7542798606,"price":50.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":460},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-01","keywords":"coffee maker","competitor_brand":"CompC","asin":"B00COMP2","product_title":"CompC Standard Coffee Machine","country_code":"ES","average_organic_rank":41,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"click_share":8.8329622557,"price":55.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":470},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-01","keywords":"coffee maker","competitor_brand":"Unknown Brand","asin":"B00COMP3","product_title":"Unknown Brand Standard Coffee Machine","country_code":"ES","average_organic_rank":27,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":12.1873715832,"price":60.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":480},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-08","keywords":"coffee maker","competitor_brand":"YabaBrand","asin":"B00OURASIN1","product_title":"YabaBrand Premium Coffee Maker","country_code":"ES","average_organic_rank":6,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":13.7847720993,"price":49.99,"weekly_search_volume":10000,"is_yaba_asin":"Y","keywords_link":"http://amazon...","grams":500},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-08","keywords":"coffee maker","competitor_brand":"CompA","asin":"B00COMP0","product_title":"CompA Standard Coffee Machine","country_code":"ES","average_organic_rank":15,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"click_share":11.6214170668,"price":45.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":450},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-08","keywords":"coffee maker","competitor_brand":"CompB","asin":"B00COMP1","product_title":"CompB Standard Coffee Machine","country_code":"ES","average_organic_rank":32,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":5.8829393113,"price":50.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":460},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-08","keywords":"coffee maker","competitor_brand":"CompC","asin":"B00COMP2","product_title":"CompC Standard Coffee Machine","country_code":"ES","average_organic_rank":19,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":14.4704383181,"price":55.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":470},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-08","keywords":"coffee maker","competitor_brand":"Unknown Brand","asin":"B00COMP3","product_title":"Unknown Brand Standard Coffee Machine","country_code":"ES","average_organic_rank":39,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":7.9221297594,"price":60.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":480},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-15","keywords":"coffee maker","competitor_brand":"YabaBrand","asin":"B00OURASIN1","product_title":"YabaBrand Premium Coffee Maker","country_code":"ES","average_organic_rank":7,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":18.232357732,"price":49.99,"weekly_search_volume":10000,"is_yaba_asin":"Y","keywords_link":"http://amazon...","grams":500},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-15","keywords":"coffee maker","competitor_brand":"CompA","asin":"B00COMP0","product_title":"CompA Standard Coffee Machine","country_code":"ES","average_organic_rank":9,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":9.4897914092,"price":45.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":450},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-15","keywords":"coffee maker","competitor_brand":"CompB","asin":"B00COMP1","product_title":"CompB Standard Coffee Machine","country_code":"ES","average_organic_rank":32,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":10.3725593796,"price":50.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":460},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-15","keywords":"coffee maker","competitor_brand":"CompC","asin":"B00COMP2","product_title":"CompC Standard Coffee Machine","country_code":"ES","average_organic_rank":41,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":10.2104523998,"price":55.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":470},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-15","keywords":"coffee maker","competitor_brand":"Unknown Brand","asin":"B00COMP3","product_title":"Unknown Brand Standard Coffee Machine","country_code":"ES","average_organic_rank":49,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":13.0645025732,"price":60.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":480},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-22","keywords":"coffee maker","competitor_brand":"YabaBrand","asin":"B00OURASIN1","product_title":"YabaBrand Premium Coffee Maker","country_code":"ES","average_organic_rank":8,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":13.0336215263,"price":49.99,"weekly_search_volume":10000,"is_yaba_asin":"Y","keywords_link":"http://amazon...","grams":500},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-22","keywords":"coffee maker","competitor_brand":"CompA","asin":"B00COMP0","product_title":"CompA Standard Coffee Machine","country_code":"ES","average_organic_rank":32,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"click_share":5.719655655,"price":45.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":450},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-22","keywords":"coffee maker","competitor_brand":"CompB","asin":"B00COMP1","product_title":"CompB Standard Coffee Machine","country_code":"ES","average_organic_rank":44,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":7.8488277271,"price":50.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":460},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-22","keywords":"coffee maker","competitor_brand":"CompC","asin":"B00COMP2","product_title":"CompC Standard Coffee Machine","country_code":"ES","average_organic_rank":41,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":10.3601557997,"price":55.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":470},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-22","keywords":"coffee maker","competitor_brand":"Unknown Brand","asin":"B00COMP3","product_title":"Unknown Brand Standard Coffee Machine","country_code":"ES","average_organic_rank":42,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"click_share":6.8202967167,"price":60.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":480},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-29","keywords":"coffee maker","competitor_brand":"YabaBrand","asin":"B00OURASIN1","product_title":"YabaBrand Premium Coffee Maker","country_code":"ES","average_organic_rank":9,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":11.8340798679,"price":49.99,"weekly_search_volume":10000,"is_yaba_asin":"Y","keywords_link":"http://amazon...","grams":500},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-29","keywords":"coffee maker","competitor_brand":"CompA","asin":"B00COMP0","product_title":"CompA Standard Coffee Machine","country_code":"ES","average_organic_rank":39,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":5.2662922116,"price":45.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":450},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-29","keywords":"coffee maker","competitor_brand":"CompB","asin":"B00COMP1","product_title":"CompB Standard Coffee Machine","country_code":"ES","average_organic_rank":46,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":6.2893547847,"price":50.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":460},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-29","keywords":"coffee maker","competitor_brand":"CompC","asin":"B00COMP2","product_title":"CompC Standard Coffee Machine","country_code":"ES","average_organic_rank":12,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":8.8504071374,"price":55.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":470},{"brand_aggregation":"HomeCategory","parent_asin":"PARENT123","week_date":"2023-10-29","keywords":"coffee maker","competitor_brand":"Unknown Brand","asin":"B00COMP3","product_title":"Unknown Brand Standard Coffee Machine","country_code":"ES","average_organic_rank":8,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"click_share":10.8258525091,"price":60.0,"weekly_search_volume":10000,"is_yaba_asin":"N","keywords_link":"http://amazon...","grams":480}];

    // LOGIC
    let ourBrandName = "Unknown";
    let sortedWeeks = [];
    let brands = [];

    // Init Google Charts
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processData();
        renderStaticReport();
        setupInteractiveControls();
    }

    function processData() {
        // 1. Identify Our Brand
        const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
        if (ourAsinRow) {
            ourBrandName = ourAsinRow.competitor_brand || extractBrand(ourAsinRow);
        }

        // 2. Sort Weeks
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        sortedWeeks = weeks;

        // 3. Identify Top Competitors
        const brandStats = {};
        marketData.forEach(d => {
            let b = d.competitor_brand || extractBrand(d);
            if (!brandStats[b]) brandStats[b] = { totalShare: 0, count: 0 };
            brandStats[b].totalShare += d.click_share;
            brandStats[b].count++;
        });

        brands = Object.keys(brandStats).sort((a,b) => 
            (brandStats[b].totalShare/brandStats[b].count) - (brandStats[a].totalShare/brandStats[a].count)
        );
    }

    function extractBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        // Simple heuristic extraction from title
        return row.product_title.split(' ')[0] || "Unknown Brand";
    }

    function renderStaticReport() {
        renderKPIs();
        drawTrendChart();
        drawCompetitivenessChart();
        drawDriversChart();
        drawEfficiencyChart();
        renderInsights();
    }

    function renderKPIs() {
        const lastWeek = sortedWeeks[sortedWeeks.length - 1];
        const prevWeek = sortedWeeks[sortedWeeks.length - 2];
        
        const lastWeekData = marketData.filter(d => d.week_date === lastWeek);
        const prevWeekData = marketData.filter(d => d.week_date === prevWeek);

        // Calculate Our Metrics
        const getMetrics = (data) => {
            const ours = data.filter(d => d.is_yaba_asin === 'Y');
            const totalClicks = ours.reduce((sum, d) => sum + (d.weekly_search_volume * d.click_share / 100), 0);
            const avgShare = ours.reduce((sum, d) => sum + d.click_share, 0) / (ours.length || 1);
            const avgRank = ours.reduce((sum, d) => sum + d.average_organic_rank, 0) / (ours.length || 1);
            return { totalClicks, avgShare, avgRank };
        };

        const current = getMetrics(lastWeekData);
        const previous = getMetrics(prevWeekData);

        const clickDiff = ((current.totalClicks - previous.totalClicks) / previous.totalClicks * 100).toFixed(1);
        const shareDiff = (current.avgShare - previous.avgShare).toFixed(2);

        document.getElementById('kpi-container').innerHTML = `
            <div class="metric">
                <div class="metric-val">${Math.round(current.totalClicks).toLocaleString()}</div>
                <div class="metric-label">Clicks Estimados (${clickDiff > 0 ? '+' : ''}${clickDiff}%)</div>
            </div>
            <div class="metric">
                <div class="metric-val">${current.avgShare.toFixed(2)}%</div>
                <div class="metric-label">Click Share (${shareDiff > 0 ? '+' : ''}${shareDiff} pp)</div>
            </div>
            <div class="metric">
                <div class="metric-val">#${current.avgRank.toFixed(1)}</div>
                <div class="metric-label">Rank Promedio</div>
            </div>
             <div class="metric">
                <div class="metric-val">${sortedWeeks.length}</div>
                <div class="metric-label">Semanas Analizadas</div>
            </div>
        `;
    }

    function drawTrendChart() {
        const data = [['Semana', 'Clicks Nuestros', 'Clicks Competencia', 'Share Nuestro (%)']];
        
        sortedWeeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            let clicksUs = 0;
            let clicksComp = 0;
            let shareUsTotal = 0;
            let countUs = 0;

            weekData.forEach(d => {
                const clicks = d.weekly_search_volume * (d.click_share / 100);
                if (d.is_yaba_asin === 'Y') {
                    clicksUs += clicks;
                    shareUsTotal += d.click_share;
                    countUs++;
                } else {
                    clicksComp += clicks;
                }
            });

            const avgShareUs = countUs > 0 ? shareUsTotal / countUs : 0;
            data.push([week, Math.round(clicksUs), Math.round(clicksComp), avgShareUs]);
        });

        const dataTable = google.visualization.arrayToDataTable(data);
        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
            vAxes: { 0: { title: 'Volumen Clicks' }, 1: { title: 'Click Share %' } },
            colors: ['#4285F4', '#dadce0'],
            legend: { position: 'bottom' },
            bar: { groupWidth: '60%' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(dataTable, options);
        
        // Populate Trend Insights
        const trendList = document.getElementById('trend-insights');
        const lastData = data[data.length-1];
        const firstData = data[1];
        const trend = lastData[1] > firstData[1] ? "positiva" : "negativa";
        
        trendList.innerHTML = `
            <li class="insight-item"><span class="material-icons insight-icon">trending_${trend === 'positiva' ? 'up' : 'down'}</span><div class="insight-text">La tendencia de clicks es <strong>${trend}</strong> comparando inicio vs fin del periodo.</div></li>
            <li class="insight-item"><span class="material-icons insight-icon">compare_arrows</span><div class="insight-text">La competencia captura un promedio de ${Math.round(lastData[2]/lastData[1])}x veces nuestro volumen.</div></li>
            <li class="insight-item"><span class="material-icons insight-icon">event</span><div class="insight-text">Última semana: ${lastData[3].toFixed(2)}% de cuota de mercado.</div></li>
        `;
    }

    function drawCompetitivenessChart() {
        // Top 3 + Ours + Rest
        const top3 = brands.filter(b => b !== ourBrandName).slice(0, 3);
        const header = ['Semana', ourBrandName, ...top3, 'Resto'];
        const dataRows = [];

        sortedWeeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const row = [week];
            
            // Ours
            const usShare = getBrandShare(weekData, ourBrandName);
            row.push(usShare);

            // Top 3
            let top3Sum = 0;
            top3.forEach(b => {
                const s = getBrandShare(weekData, b);
                row.push(s);
                top3Sum += s;
            });

            // Rest
            const totalShare = weekData.reduce((sum, d) => sum + d.click_share, 0);
            row.push(Math.max(0, totalShare - usShare - top3Sum)); // Approximate rest

            dataRows.push(row);
        });

        const dataTable = google.visualization.arrayToDataTable([header, ...dataRows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            lineWidth: 2,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'],
            vAxis: { title: 'Click Share %' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(dataTable, options);

        document.getElementById('comp-summary').innerText = `Líder actual: ${brands[0]} (Basado en promedio del periodo). Nuestra marca se compara contra ${top3.join(', ')}.`;
    }

    function getBrandShare(data, brand) {
        const brandData = data.filter(d => (d.competitor_brand || extractBrand(d)) === brand);
        if (brandData.length === 0) return 0;
        return brandData.reduce((sum, d) => sum + d.click_share, 0) / brandData.length; // Average share of ASINs
    }

    function drawDriversChart() {
        // Simple analysis: Deal vs No Deal for Us vs Comp
        const analyze = (isUs) => {
            const set = marketData.filter(d => (isUs ? d.is_yaba_asin === 'Y' : d.is_yaba_asin === 'N'));
            const withDeal = set.filter(d => d.weekly_number_of_days_with_deal > 0);
            const withoutDeal = set.filter(d => d.weekly_number_of_days_with_deal === 0);
            
            const avgShare = (arr) => arr.length ? arr.reduce((s,d)=>s+d.click_share,0)/arr.length : 0;
            return [avgShare(withDeal), avgShare(withoutDeal)];
        };

        const [usDeal, usNoDeal] = analyze(true);
        const [compDeal, compNoDeal] = analyze(false);

        const data = google.visualization.arrayToDataTable([
            ['Estado', 'Nosotros', 'Competencia'],
            ['Con Deal', usDeal, compDeal],
            ['Sin Deal', usNoDeal, compNoDeal]
        ]);

        const options = {
            bars: 'horizontal',
            colors: ['#4285F4', '#dadce0'],
            legend: { position: 'bottom' },
            hAxis: { title: 'Avg Click Share %' }
        };

        const chart = new google.visualization.BarChart(document.getElementById('chart_drivers'));
        chart.draw(dataTable, options);

        // Text Analysis
        const lift = usNoDeal > 0 ? ((usDeal - usNoDeal)/usNoDeal * 100).toFixed(0) : 0;
        document.getElementById('drivers-text').innerHTML = `
            <p><strong>Impacto de Deals:</strong> Cuando activamos Deals, nuestra cuota varía un <strong>${lift > 0 ? '+' : ''}${lift}%</strong>.</p>
            <p><strong>Elasticidad Precio:</strong> Comparando semanas, la competencia mantiene un precio promedio de $${getAvgPrice(false).toFixed(2)} vs nuestros $${getAvgPrice(true).toFixed(2)}.</p>
        `;
    }

    function getAvgPrice(isUs) {
        const set = marketData.filter(d => (isUs ? d.is_yaba_asin === 'Y' : d.is_yaba_asin === 'N'));
        return set.reduce((s, d) => s + d.price, 0) / (set.length || 1);
    }

    function drawEfficiencyChart() {
        const data = [['Rank Orgánico', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        // Filter last week
        const lastWeek = sortedWeeks[sortedWeeks.length - 1];
        const weekData = marketData.filter(d => d.week_date === lastWeek);

        weekData.forEach(d => {
            const isUs = d.is_yaba_asin === 'Y';
            const color = isUs ? '#4285F4' : '#dadce0';
            const brand = d.competitor_brand || extractBrand(d);
            data.push([d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: ${isUs ? 10 : 5} }`, `${brand}: Rank ${d.average_organic_rank}, Share ${d.click_share}%`]);
        });

        const dataTable = google.visualization.arrayToDataTable(data);
        const options = {
            hAxis: { title: 'Organic Rank (Menor es mejor)', direction: -1 }, // Inverted axis for Rank
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            tooltip: { isHtml: true }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(dataTable, options);
    }

    function renderInsights() {
        // Conclusions
        const conclusions = document.getElementById('conclusions-list');
        const recommendations = document.getElementById('recommendations-container');
        
        conclusions.innerHTML = `
            <li class="insight-item"><span class="material-icons insight-icon">check_circle</span><div class="insight-text">El Parent ASIN muestra estabilidad, con un pico de share en la semana ${sortedWeeks[2] || 'central'}.</div></li>
            <li class="insight-item"><span class="material-icons insight-icon">check_circle</span><div class="insight-text">Nuestra marca es el jugador dominante en el segmento de precio $${getAvgPrice(true).toFixed(0)}.</div></li>
            <li class="insight-item"><span class="material-icons insight-icon">check_circle</span><div class="insight-text">La eficiencia orgánica es alta: logramos buen share sin necesidad de estar siempre top 1.</div></li>
            <li class="insight-item"><span class="material-icons insight-icon">warning</span><div class="insight-text">Competidor ${brands[1]} está ganando tracción con precios más bajos.</div></li>
            <li class="insight-item"><span class="material-icons insight-icon">info</span><div class="insight-text">Los cupones parecen ser la palanca preferida de la competencia.</div></li>
        `;

        recommendations.innerHTML = `
            <div class="recommendation"><strong>Defensa de Share:</strong> Activar cupón del 5% en semanas sin Deal para frenar a ${brands[1]}.</div>
            <div class="recommendation"><strong>SEO:</strong> Revisar keywords donde el rank es > 10 para recuperar visibilidad orgánica.</div>
            <div class="recommendation"><strong>Contenido:</strong> A/B test de imagen principal para mejorar CTR sin bajar precio.</div>
        `;

        // Other
        document.getElementById('other-insights').innerHTML = `
            <li class="insight-item"><span class="material-icons insight-icon">visibility</span><div class="insight-text">Detectada una nueva marca "Unknown" con alta volatilidad en ranking.</div></li>
        `;
    }

    // INTERACTIVE LOGIC
    function setupInteractiveControls() {
        const weekSelect = document.getElementById('select-week');
        sortedWeeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSelect.appendChild(opt);
        });
        weekSelect.value = sortedWeeks[sortedWeeks.length - 1]; // Select last

        const compSelect = document.getElementById('select-competitor');
        brands.filter(b => b !== ourBrandName).forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            compSelect.appendChild(opt);
        });
        
        updateInteractive();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        // Find button
        const btnIndex = tabId === 'static' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
    }

    function updateInteractive() {
        const week = document.getElementById('select-week').value;
        const comp = document.getElementById('select-competitor').value;
        
        const weekData = marketData.filter(d => d.week_date === week);
        
        // Get Stats
        const getStats = (brand) => {
            const subset = weekData.filter(d => (d.competitor_brand || extractBrand(d)) === brand);
            if (!subset.length) return null;
            
            // Average across ASINs of that brand
            const avg = (key) => subset.reduce((s,d) => s + (d[key]||0), 0) / subset.length;
            
            return {
                price: avg('price'),
                share: avg('click_share'),
                rank: avg('average_organic_rank'),
                deal: subset.some(d => d.weekly_number_of_days_with_deal > 0),
                coupon: subset.some(d => d.weekly_number_of_days_with_coupon > 0),
                choice: subset.some(d => d.weekly_number_of_days_with_amazon_choice_badge > 0),
                bs: subset.some(d => d.weekly_number_of_days_with_best_seller_badge > 0)
            };
        };

        const usStats = getStats(ourBrandName);
        const compStats = getStats(comp);

        if (!usStats || !compStats) {
            document.getElementById('comparison-tbody').innerHTML = '<tr><td colspan="4">No hay datos suficientes para esta combinación.</td></tr>';
            return;
        }

        // Render Table
        const renderRow = (label, v1, v2, formatFn) => {
            const diff = v1 - v2;
            let color = 'gray';
            // Logic: High Share good, Low Rank good, Low Price ? depends.
            if (label.includes('Share')) color = diff > 0 ? 'green' : 'red';
            if (label.includes('Rank')) color = diff < 0 ? 'green' : 'red';
            
            return `
                <tr>
                    <td><strong>${label}</strong></td>
                    <td>${formatFn(v1)}</td>
                    <td>${formatFn(v2)}</td>
                    <td style="color: ${color}; font-weight: bold;">${diff > 0 ? '+' : ''}${label.includes('Precio') ? diff.toFixed(2) : diff.toFixed(1)}</td>
                </tr>
            `;
        };

        document.getElementById('th-us').innerText = ourBrandName;
        document.getElementById('th-comp').innerText = comp;

        document.getElementById('comparison-tbody').innerHTML = `
            ${renderRow('Precio Promedio', usStats.price, compStats.price, v => '$'+v.toFixed(2))}
            ${renderRow('Click Share %', usStats.share, compStats.share, v => v.toFixed(2)+'%')}
            ${renderRow('Rank Orgánico', usStats.rank, compStats.rank, v => '#'+v.toFixed(1))}
        `;

        // Render Badges
        const renderBadges = (stats, name, color) => `
            <div style="text-align: center; border: 1px solid #eee; padding: 16px; border-radius: 8px;">
                <h4 style="margin: 0 0 12px 0; color: ${color};">${name}</h4>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                    ${stats.deal ? '<span class="badge" style="background: #EA4335">DEAL</span>' : ''}
                    ${stats.coupon ? '<span class="badge" style="background: #34A853">CUPÓN</span>' : ''}
                    ${stats.choice ? '<span class="badge" style="background: #202124">CHOICE</span>' : ''}
                    ${stats.bs ? '<span class="badge" style="background: #FBBC05; color: black;">BEST SELLER</span>' : ''}
                    ${(!stats.deal && !stats.coupon && !stats.choice && !stats.bs) ? '<span style="font-size: 12px; color: #999;">Sin Badges</span>' : ''}
                </div>
            </div>
        `;

        document.getElementById('badges-comp').innerHTML = 
            renderBadges(usStats, ourBrandName, '#4285F4') + 
            renderBadges(compStats, comp, '#EA4335');
            
        // Price Comparison Chart
        const data = google.visualization.arrayToDataTable([
             ['Marca', 'Precio', { role: 'style' }],
             [ourBrandName, usStats.price, '#4285F4'],
             [comp, compStats.price, '#EA4335']
        ]);
        
        const options = {
            legend: { position: "none" },
            vAxis: { title: 'Precio ($)' },
            bar: { groupWidth: "50%" }
        };
        const chart = new google.visualization.ColumnChart(document.getElementById('chart_price_comp'));
        chart.draw(data, options);
    }
    
    // Resize listener
    window.addEventListener('resize', () => {
        renderStaticReport();
        updateInteractive();
    });

</script>

</body>
</html>