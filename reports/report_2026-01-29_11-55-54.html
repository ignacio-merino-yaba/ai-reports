<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado: Matcha Premium</title>
    
    <!-- Google Charts & Icons -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* Google Material / Apple-like Design System */
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #5f6368; /* Google Gray */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --bg: #F0F2F5;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-sub: #5f6368;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 400;
            margin: 0;
            color: var(--text-main);
        }
        .header span {
            font-size: 14px;
            color: var(--text-sub);
            background: #E8F0FE;
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 16px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid #dadce0;
            padding-bottom: 0;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-sub);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-btn:hover {
            background-color: rgba(66, 133, 244, 0.04);
        }

        /* Content Sections */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px; /* Rounded corners */
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            margin-bottom: 24px;
        }
        .card-title {
            font-size: 18px;
            color: var(--text-main);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* Metrics */
        .kpi-row {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 20px;
        }
        .kpi-box h3 { margin: 0; font-size: 32px; color: var(--primary); }
        .kpi-box p { margin: 0; font-size: 12px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-up { color: var(--success); font-size: 14px; font-weight: bold; }
        .trend-down { color: var(--danger); font-size: 14px; font-weight: bold; }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Insights Text */
        .insight-list { list-style: none; padding: 0; }
        .insight-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            gap: 12px;
            font-size: 14px;
        }
        .insight-list li:last-child { border-bottom: none; }
        .icon-box { color: var(--primary); }
        
        /* Recommendations */
        .reco-card {
            background: #FCE8E6; /* Light Red/Orange tint for action */
            border-left: 4px solid var(--danger);
        }
        .reco-card h4 { margin: 0 0 8px 0; color: #C5221F; }
        
        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        select {
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            flex: 1;
            background: #fff;
        }

        /* Dynamic Table */
        table.comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        table.comparison-table th { text-align: left; padding: 12px; border-bottom: 2px solid #dadce0; color: var(--text-sub); }
        table.comparison-table td { padding: 12px; border-bottom: 1px solid #f1f3f4; }
        table.comparison-table tr:last-child td { border-bottom: none; }
        .winner { color: var(--success); font-weight: bold; }
        .loser { color: var(--danger); }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>An√°lisis de Parent ASIN: Matcha Premium <span id="currentDateRange">2026-01</span></h1>
        <p style="color: var(--text-sub); margin-top: 4px;">An√°lisis estrat√©gico de visibilidad, cuota y precios en Amazon.</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: REPORTE EST√ÅTICO -->
    <div id="static" class="tab-content active">
        
        <!-- Section 1: Tendencia Global -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span> 1. Tendencia Global del Parent (√öltimas 5 Semanas)
            </div>
            <div class="kpi-row">
                <div class="kpi-box">
                    <h3 id="totalMarketClicks">-</h3>
                    <p>Volumen Mercado (Clics)</p>
                </div>
                <div class="kpi-box">
                    <h3 id="ourShare">-</h3>
                    <p>Nuestra Cuota (Click Share)</p>
                </div>
                <div class="kpi-box">
                    <h3 id="growthMetric">-</h3>
                    <p>Crecimiento WoW (Clics)</p>
                </div>
            </div>
            <div id="trend_chart" class="chart-container"></div>
            <div class="insight-list" style="margin-top: 16px; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                <li style="border:none"><span class="material-icons icon-box">info</span> <span id="trend_insight_text">Cargando an√°lisis...</span></li>
            </div>
        </div>

        <!-- Section 2: Competitividad -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span> 2. Competitividad de Marca
                </div>
                <div id="brand_chart" class="chart-container" style="height: 300px;"></div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">*Top 3 competidores identificados por cuota media.</p>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span> Insights de Competitividad
                </div>
                <ul class="insight-list">
                    <li><span class="material-icons icon-box">check_circle</span> <span id="comp_insight_1">Ostentamos un 31.3% del Click Share total en la categor√≠a Matcha.</span></li>
                    <li><span class="material-icons icon-box">storefront</span> Top 3 Competidores: NORITUAL LAB, Ceremonial, VAHDAM.</li>
                    <li><span class="material-icons icon-box">euro</span> <span id="price_insight">Nuestro precio promedio (19.91‚Ç¨) es superior al de la competencia (15.72‚Ç¨).</span></li>
                </ul>
            </div>
        </div>

        <!-- Section 3 & 4: Efficiency & Levers -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span> 4. Eficiencia: Organic Rank vs Share
                </div>
                <div id="efficiency_chart" class="chart-container" style="height: 300px;"></div>
                <p style="font-size:12px; color:#666;">Eje X: Rank Org√°nico (Menor es mejor). Eje Y: Click Share.</p>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">tune</span> 3. Palancas de Clics
                </div>
                <div id="levers_chart" class="chart-container" style="height: 300px;"></div>
            </div>
        </div>

        <!-- Section 5: Conclusions & Recommendations -->
        <div class="card" style="border-top: 4px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">assignment</span> 5. Conclusiones y Recomendaciones Accionables
            </div>
            <div class="grid-2">
                <div>
                    <h4 style="color: var(--primary);">Insights Clave</h4>
                    <ul class="insight-list" id="final_insights_list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
                <div class="reco-card" style="padding: 16px; border-radius: 8px;">
                    <h4>üöÄ Recomendaciones</h4>
                    <ul class="insight-list" id="final_recos_list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVO -->
    <div id="interactive" class="tab-content">
        <div class="card">
            <div class="card-title">Cara a Cara: Nosotros vs Competencia</div>
            <div class="controls">
                <select id="weekSelect" onchange="updateComparison()">
                    <!-- Populated by JS -->
                </select>
                <select id="compSelect" onchange="updateComparison()">
                    <!-- Populated by JS -->
                </select>
            </div>
            
            <div class="grid-2">
                <div style="background: #F8F9FA; padding: 20px; border-radius: 8px;">
                    <h3 style="color: var(--primary); margin-top:0;">NaturaleBio (Nosotros)</h3>
                    <table class="comparison-table" id="usTable">
                        <!-- Data -->
                    </table>
                </div>
                <div style="background: #FFF; border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                    <h3 style="color: var(--text-sub); margin-top:0;" id="compTitle">Competidor</h3>
                    <table class="comparison-table" id="compTable">
                        <!-- Data -->
                    </table>
                </div>
            </div>
            <div id="comp_history_chart" class="chart-container" style="margin-top: 24px;"></div>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // 1. DATA INJECTION & CONFIG
    // ==========================================
    
    // Dataset injected directly into the HTML to ensure standalone functionality
    const marketData = [
  {"week_date": "2026-01", "resolved_brand": "Unknown Brand", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "click_share": 2.39, "average_organic_rank": 10.0, "price": 11.9975, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 647.520788, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2026-01", "resolved_brand": "bioKontor", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "click_share": 2.39, "average_organic_rank": 10.0, "price": 11.9975, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 647.520788, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "bioKontor", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "click_share": 2.44, "average_organic_rank": 10.0, "price": 12.367142857, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 1164.330424, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "Unknown Brand", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "click_share": 2.44, "average_organic_rank": 10.0, "price": 12.367142857, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 1164.330424, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "NORITUAL LAB", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "click_share": 18.77, "average_organic_rank": 2.0, "price": 24.648571429, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 8956.754942, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2026-01", "resolved_brand": "NORITUAL LAB", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "click_share": 19.34, "average_organic_rank": 2.0, "price": 23.91, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 4, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 5239.770728, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2026-01", "resolved_brand": "Ceremonial", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 7.38, "average_organic_rank": 6.0, "price": 15.5575, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 1999.457496, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2026-01", "resolved_brand": "NORITUAL LAB", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 7.38, "average_organic_rank": 6.0, "price": 15.5575, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 1999.457496, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "NORITUAL LAB", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 8.42, "average_organic_rank": 6.0, "price": 16.037142857, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 4017.894332, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "Ceremonial", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "click_share": 8.42, "average_organic_rank": 6.0, "price": 16.037142857, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 4017.894332, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2026-01", "resolved_brand": "Matcha", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "click_share": 3.0, "average_organic_rank": 16.0, "price": 10.39, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 4, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 812.7876, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2026-01", "resolved_brand": "Special Leaves", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "click_share": 3.0, "average_organic_rank": 16.0, "price": 10.39, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 4, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 812.7876, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "Special Leaves", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "click_share": 3.4, "average_organic_rank": 13.0, "price": 10.71, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 1622.42764, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "Matcha", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "click_share": 3.4, "average_organic_rank": 13.0, "price": 10.71, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 1622.42764, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2026-01", "resolved_brand": "NaturaleBio", "is_yaba_asin": "Y", "parent_asin": "Matcha Premium", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "click_share": 2.68, "average_organic_rank": NaN, "price": 30.27, "weekly_number_of_days_with_deal": null, "weekly_number_of_days_with_coupon": null, "weekly_number_of_days_with_best_seller_badge": null, "weekly_number_of_days_with_amazon_choice_badge": null, "estimated_clicks": 726.090256, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Our Brand"},
  {"week_date": "2025-52", "resolved_brand": "NaturaleBio", "is_yaba_asin": "Y", "parent_asin": "Matcha Premium", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "click_share": 2.93, "average_organic_rank": 23.0, "price": 30.704285714, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "estimated_clicks": 1398.150878, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Our Brand"},
  {"week_date": "2026-01", "resolved_brand": "NaturaleBio", "is_yaba_asin": "Y", "parent_asin": "Matcha Premium", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 3.35, "average_organic_rank": 5.0, "price": 10.2225, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "estimated_clicks": 907.61282, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Our Brand"},
  {"week_date": "2025-52", "resolved_brand": "NaturaleBio", "is_yaba_asin": "Y", "parent_asin": "Matcha Premium", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 3.49, "average_organic_rank": 5.0, "price": 24.855714286, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "estimated_clicks": 1665.374254, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Our Brand"},
  {"week_date": "2026-01", "resolved_brand": "NaturaleBio", "is_yaba_asin": "Y", "parent_asin": "Matcha Premium", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 3.66, "average_organic_rank": 5.0, "price": 24.5275, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "estimated_clicks": 991.600872, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Our Brand"},
  {"week_date": "2025-52", "resolved_brand": "NaturaleBio", "is_yaba_asin": "Y", "parent_asin": "Matcha Premium", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 3.75, "average_organic_rank": 4.0, "price": 10.538571429, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "estimated_clicks": 1789.44225, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Our Brand"},
  {"week_date": "2025-52", "resolved_brand": "NaturaleBio", "is_yaba_asin": "Y", "parent_asin": "Matcha Premium", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 11.66, "average_organic_rank": 2.0, "price": 15.058571429, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "estimated_clicks": 5563.972436, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Our Brand"},
  {"week_date": "2026-01", "resolved_brand": "NaturaleBio", "is_yaba_asin": "Y", "parent_asin": "Matcha Premium", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "click_share": 12.9, "average_organic_rank": 2.0, "price": 14.6075, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "estimated_clicks": 3494.98668, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Our Brand"},
  {"week_date": "2026-01", "resolved_brand": "UNREAL\u00ae", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "click_share": 1.57, "average_organic_rank": 19.0, "price": 31.2725, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 425.358844, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2026-01", "resolved_brand": "VAHDAM", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "click_share": 3.15, "average_organic_rank": 9.0, "price": 10.43, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 853.42698, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "VAHDAM", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "click_share": 4.19, "average_organic_rank": 7.0, "price": 9.895714286, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 1999.403474, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"},
  {"week_date": "2025-52", "resolved_brand": "VAHDAM", "is_yaba_asin": "N", "parent_asin": "Matcha Premium", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "click_share": 1.47, "average_organic_rank": 20.0, "price": 9.895714286, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "estimated_clicks": 701.461362, "keywords_link": "https://www.amazon.de/s?k=matcha", "keywords": "matcha", "brand_type": "Competitor"}
];

    const topCompetitors = ['NORITUAL LAB', 'Ceremonial', 'VAHDAM'];
    const ourBrand = "NaturaleBio";
    
    // Insights hardcoded from Python analysis to meet report requirements
    const insightsList = [
        "Tendencia Global: Nuestra marca (NaturaleBio) cae un -41.2% en clics la √∫ltima semana (2026-01).",
        "Competitividad: Ostentamos un 31.3% del Click Share total en la categor√≠a Matcha.",
        "Posicionamiento de Precio: Nuestro precio promedio (19.91‚Ç¨) es superior al de la competencia (15.72‚Ç¨).",
        "Eficiencia Org√°nica: Posici√≥n org√°nica promedio de 4.0 en la √∫ltima semana.",
        "Promociones: Se detectaron 0.0 d√≠as con deals activos en nuestras variantes esta semana."
    ];
    
    const recosList = [
        "Acci√≥n Cr√≠tica: Investigar ca√≠da de clics. Revisar si competidores activaron cupones agresivos (ver gr√°fico de palancas).",
        "Precio: Evaluar elasticidad. Estamos significativamente m√°s caros que el promedio. Considerar cup√≥n temporal.",
        "SEO: Revisar keywords donde el organic rank es > 10 pero tenemos variantes relevantes."
    ];

    // ==========================================
    // 2. LOGIC & RENDERERS
    // ==========================================

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        populateInsights();
        drawTrendChart();
        drawBrandChart();
        drawEfficiencyChart();
        drawLeversChart(); // Simple implementation
        
        // Calculate Metrics for Header
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;

        const lastWeekData = marketData.filter(d => d.week_date === lastWeek);
        const lastWeekClicks = lastWeekData.reduce((acc, d) => acc + d.estimated_clicks, 0);
        const lastWeekOurClicks = lastWeekData.filter(d => d.is_yaba_asin === 'Y').reduce((acc, d) => acc + d.estimated_clicks, 0);
        const share = (lastWeekOurClicks / lastWeekClicks * 100).toFixed(1) + '%';
        
        document.getElementById('totalMarketClicks').innerText = Math.round(lastWeekClicks).toLocaleString();
        document.getElementById('ourShare').innerText = share;
        
        // Growth
        if(prevWeek) {
            const prevWeekData = marketData.filter(d => d.week_date === prevWeek);
            const prevOurClicks = prevWeekData.filter(d => d.is_yaba_asin === 'Y').reduce((acc, d) => acc + d.estimated_clicks, 0);
            const growth = ((lastWeekOurClicks - prevOurClicks) / prevOurClicks * 100).toFixed(1);
            const el = document.getElementById('growthMetric');
            el.innerText = (growth > 0 ? "+" : "") + growth + "%";
            el.className = growth > 0 ? "trend-up" : "trend-down";
            
            document.getElementById('trend_insight_text').innerText = 
                `El volumen de clics de nuestra marca ha variado un ${growth}% respecto a la semana anterior.`;
        }

        initInteractive();
    }

    function populateInsights() {
        const ul = document.getElementById('final_insights_list');
        insightsList.forEach(txt => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="material-icons icon-box">insights</span> ${txt}`;
            ul.appendChild(li);
        });
        
        const ulRec = document.getElementById('final_recos_list');
        recosList.forEach(txt => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="material-icons icon-box" style="color:#d93025">bolt</span> ${txt}`;
            ulRec.appendChild(li);
        });
    }

    function drawTrendChart() {
        // Aggregate by week: Our Clicks vs Comp Clicks + Share
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const chartData = [['Semana', 'Clics Competencia', 'Clics Nuestros', 'Nuestra Cuota (%)']];
        
        weeks.forEach(w => {
            const weekRows = marketData.filter(d => d.week_date === w);
            const total = weekRows.reduce((a,b) => a + b.estimated_clicks, 0);
            const ours = weekRows.filter(d => d.is_yaba_asin === 'Y').reduce((a,b) => a + b.estimated_clicks, 0);
            const comps = total - ours;
            const share = total > 0 ? (ours / total * 100) : 0;
            chartData.push([w, comps, ours, share]);
        });

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
            seriesType: 'bars',
            isStacked: true,
            series: { 2: {type: 'line', targetAxisIndex: 1} },
            colors: ['#dadce0', '#4285F4', '#EA4335'],
            vAxes: { 0: {title: 'Volumen Clics'}, 1: {title: 'Click Share %', format: '#\'%\''} },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
        chart.draw(data, options);
    }

    function drawBrandChart() {
        // Line chart of share per brand over time
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        // Columns: Week, Our Brand, Comp 1, Comp 2, Comp 3
        const header = ['Semana', ourBrand, ...topCompetitors];
        const rows = [];
        
        weeks.forEach(w => {
            const weekRows = marketData.filter(d => d.week_date === w);
            const totalClicks = weekRows.reduce((a,b) => a + b.estimated_clicks, 0);
            
            const row = [w];
            // Ours
            const ourClicks = weekRows.filter(d => d.resolved_brand === ourBrand).reduce((a,b) => a + b.estimated_clicks, 0);
            row.push(totalClicks ? (ourClicks/totalClicks*100) : 0);
            
            // Comps
            topCompetitors.forEach(tc => {
                const cClicks = weekRows.filter(d => d.resolved_brand === tc).reduce((a,b) => a + b.estimated_clicks, 0);
                row.push(totalClicks ? (cClicks/totalClicks*100) : 0);
            });
            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            legend: { position: 'bottom' },
            vAxis: { title: 'Share (%)' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('brand_chart'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Scatter: Rank (X) vs Share (Y), Color by Us/Them
        // Filter only latest week for clarity
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const latest = weeks[weeks.length-1];
        const dset = marketData.filter(d => d.week_date === latest);
        
        const chartData = [['Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        dset.forEach(d => {
            if(d.average_organic_rank > 0) {
                const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#dadce0';
                const label = `${d.resolved_brand}: ${d.product_title.substring(0,30)}... (Rank: ${d.average_organic_rank})`;
                chartData.push([d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: 10; }`, label]);
            }
        });

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
            hAxis: { title: 'Organic Rank (Inv)', direction: -1 }, // Invert so 1 is right or let 1 be left? Usually Rank 1 is good (left)
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' }
        };
        // Re-invert X to make Rank 1 appear on left? No, standard scatter. 
        // Let's keep 0 -> 100. Lower is better.
        options.hAxis.direction = 1; // 0 on left.

        const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
        chart.draw(data, options);
    }

    function drawLeversChart() {
        // Simple analysis: Share of products WITH deals vs WITHOUT in the market
        // Just for visualization, let's show "Avg Share with Deal" vs "Avg Share without Deal"
        const withDeal = marketData.filter(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);
        const withoutDeal = marketData.filter(d => (!d.weekly_number_of_days_with_deal) && (!d.weekly_number_of_days_with_coupon));
        
        const avgShareWith = withDeal.length ? (withDeal.reduce((a,b)=>a+b.click_share,0)/withDeal.length) : 0;
        const avgShareWithout = withoutDeal.length ? (withoutDeal.reduce((a,b)=>a+b.click_share,0)/withoutDeal.length) : 0;
        
        const data = google.visualization.arrayToDataTable([
            ['Estado', 'Click Share Promedio', { role: 'style' }],
            ['Con Promo/Cup√≥n', avgShareWith, '#34A853'],
            ['Precio Normal', avgShareWithout, '#dadce0']
        ]);
        
        const options = {
            legend: { position: "none" },
            vAxis: { title: 'Avg Click Share %' },
            chartArea: { width: '70%', height: '70%' }
        };
        const chart = new google.visualization.ColumnChart(document.getElementById('levers_chart'));
        chart.draw(data, options);
    }

    // ==========================================
    // 3. INTERACTIVE LOGIC
    // ==========================================

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        if(tabId === 'interactive') updateComparison();
    }

    function initInteractive() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort().reverse();
        const brands = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.resolved_brand))].sort();
        
        const wSelect = document.getElementById('weekSelect');
        const cSelect = document.getElementById('compSelect');
        
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            wSelect.appendChild(opt);
        });
        
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            cSelect.appendChild(opt);
        });
        
        // Set default comp to top 1
        if(topCompetitors.length > 0) cSelect.value = topCompetitors[0];
    }

    function updateComparison() {
        const week = document.getElementById('weekSelect').value;
        const comp = document.getElementById('compSelect').value;
        document.getElementById('compTitle').innerText = comp;

        // Filter Data
        const usData = marketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
        const compData = marketData.filter(d => d.week_date === week && d.resolved_brand === comp);

        // Calculate Metrics
        function getMetrics(rows) {
            if(!rows.length) return { price: 0, share: 0, rank: 0, deals: 0 };
            const price = rows.reduce((a,b) => a + b.price, 0) / rows.length;
            const share = rows.reduce((a,b) => a + b.click_share, 0); // Sum share of all variants
            const rank = rows.reduce((a,b) => a + (b.average_organic_rank||100), 0) / rows.length;
            const deals = rows.reduce((a,b) => a + (b.weekly_number_of_days_with_deal||0) + (b.weekly_number_of_days_with_coupon||0), 0);
            return { price, share, rank, deals };
        }

        const usM = getMetrics(usData);
        const compM = getMetrics(compData);

        // Render Tables
        function renderRow(label, valUs, valComp, format, inverse=false) {
            const usWin = inverse ? valUs < valComp : valUs > valComp;
            // For boolean metrics like Rank (lower is better)
            
            return `<tr>
                <td>${label}</td>
                <td class="${usWin ? 'winner' : ''}">${format(valUs)}</td>
            </tr>`;
        }
        
        // Helper for Comp Table
        function renderRowComp(label, valUs, valComp, format, inverse=false) {
            const compWin = inverse ? valComp < valUs : valComp > valUs;
            return `<tr>
                <td>${label}</td>
                <td class="${compWin ? 'winner' : ''}">${format(valComp)}</td>
            </tr>`;
        }

        const fmtPrice = v => v.toFixed(2) + ' ‚Ç¨';
        const fmtPct = v => v.toFixed(2) + '%';
        const fmtInt = v => Math.round(v);

        document.getElementById('usTable').innerHTML = `
            ${renderRow('Precio Promedio', usM.price, compM.price, fmtPrice, true)}
            ${renderRow('Click Share Total', usM.share, compM.share, fmtPct)}
            ${renderRow('Avg Organic Rank', usM.rank, compM.rank, fmtInt, true)}
            ${renderRow('D√≠as Promo (Suma)', usM.deals, compM.deals, fmtInt)}
        `;

        document.getElementById('compTable').innerHTML = `
            ${renderRowComp('Precio Promedio', usM.price, compM.price, fmtPrice, true)}
            ${renderRowComp('Click Share Total', usM.share, compM.share, fmtPct)}
            ${renderRowComp('Avg Organic Rank', usM.rank, compM.rank, fmtInt, true)}
            ${renderRowComp('D√≠as Promo (Suma)', usM.deals, compM.deals, fmtInt)}
        `;
        
        // Draw History Chart (Us vs Selected Comp)
        drawCompHistory(comp);
    }
    
    function drawCompHistory(compName) {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const dataArr = [['Semana', 'Nosotros (Share)', compName + ' (Share)']];
        
        weeks.forEach(w => {
            const weekRows = marketData.filter(d => d.week_date === w);
            const total = weekRows.reduce((a,b)=>a+b.estimated_clicks,0);
            
            const usShare = weekRows.filter(d => d.is_yaba_asin === 'Y').reduce((a,b)=>a+b.click_share,0);
            const compShare = weekRows.filter(d => d.resolved_brand === compName).reduce((a,b)=>a+b.click_share,0);
            
            dataArr.push([w, usShare, compShare]);
        });
        
        const data = google.visualization.arrayToDataTable(dataArr);
        const options = {
            title: 'Hist√≥rico: Nosotros vs ' + compName,
            curveType: 'function',
            colors: ['#4285F4', '#EA4335'],
            vAxis: { title: 'Click Share %' },
            legend: { position: 'bottom' }
        };
        const chart = new google.visualization.LineChart(document.getElementById('comp_history_chart'));
        chart.draw(data, options);
    }

</script>
</body>
</html>