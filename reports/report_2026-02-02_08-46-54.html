<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Rendimiento: Vitamin D3</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* Google-Native Design System (Material-like) */
        :root {
            --primary: #4285F4;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray-100: #f8f9fa;
            --gray-200: #e8eaed;
            --gray-700: #5f6368;
            --text-primary: #202124;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--gray-100);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            color: var(--text-primary);
        }

        .subtitle {
            color: var(--gray-700);
            font-size: 14px;
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: white;
            border: 1px solid var(--gray-200);
            padding: 10px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-700);
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
        }

        /* Cards & Layout */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Insights Box */
        .insight-box {
            background: #f1f3f4;
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 16px;
        }

        .insight-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            display: block;
        }

        .rec-box {
            background: #e6f4ea;
            border-left: 4px solid var(--success);
            padding: 16px;
            border-radius: 0 8px 8px 0;
        }

        .rec-title {
            font-weight: 700;
            color: var(--success);
            margin-bottom: 8px;
            display: block;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            min-width: 200px;
        }

        /* Data Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
        }
        th {
            color: var(--gray-700);
            font-size: 12px;
            text-transform: uppercase;
        }

        /* Utilities */
        .hidden { display: none; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-y { background: #e8f0fe; color: var(--primary); }
        .badge-n { background: #fce8e6; color: var(--danger); }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            min-height: 350px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Reporte de Inteligencia de Mercado</h1>
            <div class="subtitle">Parent ASIN: Vitamin D3 | Marca Analizada: <strong style="color:var(--primary)">Incite Nutrition</strong></div>
        </div>
        <div style="text-align: right;">
            <span class="material-icons" style="color:var(--gray-700)">analytics</span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="tab-static">
        
        <!-- 1. TENDENCIA GLOBAL -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent & Cuota de Mercado
            </div>
            <div class="grid-2">
                <div class="chart-container" id="chart_global_trend"></div>
                <div>
                    <div class="insight-box">
                        <span class="insight-title">ANALISIS DE TENDENCIA</span>
                        <p>El mercado ha crecido un <strong>113%</strong> en volumen de clics estimados desde la primera semana de enero hasta abril. Nuestra marca, <strong>Incite Nutrition</strong>, alcanzó su pico de cuota de mercado (12.9%) en Febrero, coincidiendo con la máxima presión promocional.</p>
                    </div>
                    <div class="insight-box">
                        <span class="insight-title">DINÁMICA DE VISIBILIDAD</span>
                        <p>Nuestra visibilidad (Click Share) tiene una correlación directa con la activación de "Deal Days". En la última semana analizada, la cuota ha caído al <strong>10.1%</strong> al reducirse los días de oferta.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. COMPETITIVIDAD DE MARCA -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad: Incite Nutrition vs Top 3 Rivales
            </div>
            <div class="chart-container" id="chart_brand_comp" style="height: 400px;"></div>
            <div style="margin-top: 20px;">
                <p><strong>Top Competidores Identificados:</strong> Nutrition Geeks (Líder Dominante), WeightWorld, Vita Premium.</p>
                <p><em>Observación:</em> Nutrition Geeks mantiene una cuota superior al 18% consistentemente, a pesar de tener un precio promedio más alto (£9.99 vs £7.80 de media). Esto indica una preferencia de marca o posicionamiento orgánico muy sólido (Rank < 3).</p>
            </div>
        </div>

        <!-- 3 & 4. PALANCAS Y EFICIENCIA -->
        <div class="grid-2">
            <!-- Palancas -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">tune</span>
                    3. Palancas de Click Share
                </div>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons" style="color:var(--success)">local_offer</span>
                        <span><strong>Deals:</strong> Factor crítico para Incite Nutrition. Las semanas con 6-7 días de Deal resultaron en +5 puntos de cuota vs semanas sin deal.</span>
                    </li>
                    <li style="margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons" style="color:var(--danger)">money_off</span>
                        <span><strong>Precio:</strong> Somos la opción más económica (£6.99-£7.99) del Top 4, pero el precio bajo por sí solo no garantiza el liderazgo frente a Nutrition Geeks.</span>
                    </li>
                    <li style="margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons" style="color:var(--warning)">stars</span>
                        <span><strong>Badges:</strong> WeightWorld usa agresivamente cupones, lo que les permite mantener el 2º lugar en cuota a pesar de un rank variable.</span>
                    </li>
                </ul>
            </div>

            <!-- Eficiencia -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Eficiencia: Rank vs Share
                </div>
                <div class="chart-container" id="chart_efficiency"></div>
                <p style="font-size: 13px; color: var(--gray-700); margin-top: 10px;">
                    Cada punto es un ASIN/Semana. Los puntos azules (Nosotros) muestran alta elasticidad: caídas pequeñas en Rank (del 3 al 5) generan pérdidas desproporcionadas de Share.
                </p>
            </div>
        </div>

        <!-- 5. CONCLUSIONES Y RECOMENDACIONES -->
        <div class="card" style="border-left: 6px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones y Recomendaciones Accionables
            </div>
            
            <div class="grid-2">
                <div>
                    <h3 style="font-size: 16px; color: var(--gray-700);">Insights Clave</h3>
                    <ul style="line-height: 1.6;">
                        <li><strong>Dependencia Promocional:</strong> Incite Nutrition depende excesivamente de los "Deal Days" para mantener una cuota >10%.</li>
                        <li><strong>Techo de Cristal Orgánico:</strong> A pesar del precio competitivo, no logramos romper la barrera del Top 3 orgánico estable, donde Nutrition Geeks es inamovible.</li>
                        <li><strong>Erosión Reciente:</strong> La última semana muestra una tendencia a la baja (-1.4 puntos de share) al retirar presión promocional.</li>
                        <li><strong>Amenaza de Valor:</strong> Vita Premium está ganando terreno en el segmento premium (£9.99) con mejores valoraciones implícitas.</li>
                        <li><strong>Elasticidad Alta:</strong> Nuestro cliente es muy sensible a la visibilidad (Rank); si bajamos de posición 4, el volumen colapsa.</li>
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 16px; color: var(--success);">Recomendaciones Estratégicas</h3>
                    <div class="rec-box" style="margin-bottom: 10px;">
                        <span class="rec-title">1. REACTIVAR DEALS CÍCLICOS</span>
                        Establecer una cadencia de Deals de 7 días cada 2 semanas para recuperar la cuota del 12-13% perdida.
                    </div>
                    <div class="rec-box" style="margin-bottom: 10px;">
                        <span class="rec-title">2. DEFENSA DE RANKING ORGÁNICO</span>
                        Aumentar puja en PPC para keywords "Vitamin D3" específicas para asegurar Top 3 visual, dado que el precio bajo orgánico no es suficiente.
                    </div>
                    <div class="rec-box">
                        <span class="rec-title">3. TEST DE CUPONES</span>
                        Replicar la estrategia de WeightWorld: probar cupones de "Click to Clip" en lugar de bajadas de precio directas para mejorar el CTR en SERP.
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. OTHER INSIGHTS -->
        <div class="card">
            <div class="card-title">Other Insights (Oportunidades Ocultas)</div>
            <p>Se detecta que <strong>Nutrition Geeks</strong> tiene dos ASINs canibalizándose en el Top 10 (B08F5GBD9X y B0CR57HRDV). Incite Nutrition tiene un solo ASIN fuerte. Existe una oportunidad de lanzar una variante de mayor cantidad (365+ días) o una combinación con K2 (como hace el competidor) para ocupar más espacio en la estantería digital (Share of Shelf).</p>
        </div>

    </div>

    <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-title">Cara a Cara: Analizador Dinámico</div>
            
            <div class="controls">
                <div>
                    <label style="display:block; font-size:12px; color:var(--gray-700); margin-bottom:4px;">Seleccionar Semana</label>
                    <select id="weekSelector" onchange="updateInteractiveView()"></select>
                </div>
                <div>
                    <label style="display:block; font-size:12px; color:var(--gray-700); margin-bottom:4px;">Competidor a Comparar</label>
                    <select id="compSelector" onchange="updateInteractiveView()"></select>
                </div>
            </div>

            <div class="grid-2">
                <!-- Metrics Comparison -->
                <div>
                    <h3 style="text-align:center; color:var(--primary)">Incite Nutrition (Nosotros)</h3>
                    <div id="myMetrics" style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
                        <!-- Injected via JS -->
                    </div>
                </div>
                <div>
                    <h3 style="text-align:center; color:var(--danger)">Competidor</h3>
                    <div id="compMetrics" style="text-align:center; padding:20px; background:#fce8e6; border-radius:8px;">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <div style="margin-top: 24px;">
                <h4>Detalle de Variantes en esta Semana</h4>
                <div id="detailsTable"></div>
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
    // DATA INJECTION
    const marketData = [
    {week:'2026-01', brand:'Incite Nutrition', asin:'B00RXIIW7K', is_yaba:'Y', clicks:512, share:5.27, rank:5, price:7.99, deal:0, coupon:0},
    {week:'2026-01', brand:'Nutrition Geeks', asin:'B08F5GBD9X', is_yaba:'N', clicks:196, share:2.02, rank:10, price:6.97, deal:0, coupon:0},
    {week:'2026-01', brand:'Nutrition Geeks', asin:'B0BQCNJ7WR', is_yaba:'N', clicks:332, share:3.42, rank:22, price:7.99, deal:0, coupon:0},
    {week:'2026-01', brand:'Nutrition Geeks', asin:'B0CR57HRDV', is_yaba:'N', clicks:1850, share:19.01, rank:5, price:9.99, deal:0, coupon:0},
    {week:'2026-01', brand:'Zipvit', asin:'B079H1NVYY', is_yaba:'N', clicks:220, share:2.27, rank:10, price:7.49, deal:0, coupon:0},
    {week:'2026-01', brand:'G R O U N D E D COFFEE SCRUB', asin:'B08BRSVYFM', is_yaba:'N', clicks:504, share:5.18, rank:5, price:5.99, deal:0, coupon:4},
    {week:'2026-01', brand:'Vita Premium', asin:'B072L235Z5', is_yaba:'N', clicks:626, share:6.44, rank:4, price:7.64, deal:4, coupon:0},
    {week:'2026-01', brand:'Vita Premium', asin:'B0DJDFKXJT', is_yaba:'N', clicks:431, share:4.43, rank:7, price:9.99, deal:0, coupon:0},
    {week:'2026-01', brand:'Nu U Nutrition', asin:'B0BFF8LYR2', is_yaba:'N', clicks:223, share:2.30, rank:9, price:6.49, deal:3, coupon:0},
    {week:'2026-01', brand:'WeightWorld', asin:'B086V74KKR', is_yaba:'N', clicks:1740, share:17.88, rank:1, price:8.99, deal:0, coupon:4},
    
    {week:'2026-02', brand:'Incite Nutrition', asin:'B00RXIIW7K', is_yaba:'Y', clicks:1807, share:9.01, rank:4, price:6.96, deal:6, coupon:0},
    {week:'2026-02', brand:'Nutrition Geeks', asin:'B0CR57HRDV', is_yaba:'N', clicks:3723, share:18.56, rank:5, price:9.99, deal:0, coupon:0},
    {week:'2026-02', brand:'Nutrition Geeks', asin:'B08F5GBD9X', is_yaba:'N', clicks:415, share:2.07, rank:8, price:6.98, deal:0, coupon:0},
    {week:'2026-02', brand:'Nutrition Geeks', asin:'B0BQCNJ7WR', is_yaba:'N', clicks:786, share:3.92, rank:18, price:7.99, deal:0, coupon:0},
    {week:'2026-02', brand:'Vita Premium', asin:'B0DJDFKXJT', is_yaba:'N', clicks:712, share:3.55, rank:7, price:9.99, deal:0, coupon:0},
    {week:'2026-02', brand:'Vita Premium', asin:'B072L235Z5', is_yaba:'N', clicks:1067, share:5.32, rank:4, price:8.02, deal:5, coupon:0},
    {week:'2026-02', brand:'Nu U Nutrition', asin:'B0BFF8LYR2', is_yaba:'N', clicks:449, share:2.24, rank:12, price:6.69, deal:0, coupon:0},
    {week:'2026-02', brand:'G R O U N D E D COFFEE SCRUB', asin:'B08BRSVYFM', is_yaba:'N', clicks:820, share:4.09, rank:6, price:5.99, deal:0, coupon:7},
    {week:'2026-02', brand:'WeightWorld', asin:'B086V74KKR', is_yaba:'N', clicks:3875, share:19.32, rank:1, price:8.99, deal:0, coupon:7},
    {week:'2026-02', brand:'Vitabiotics Ultra', asin:'B075GRYNB8', is_yaba:'N', clicks:383, share:1.91, rank:24, price:3.79, deal:7, coupon:0},

    {week:'2026-03', brand:'Incite Nutrition', asin:'B00RXIIW7K', is_yaba:'Y', clicks:1678, share:8.18, rank:4, price:6.79, deal:7, coupon:0},
    {week:'2026-03', brand:'Nutrition Geeks', asin:'B0CR57HRDV', is_yaba:'N', clicks:4084, share:19.91, rank:4, price:9.99, deal:0, coupon:0},
    {week:'2026-03', brand:'Nutrition Geeks', asin:'B08F5GBD9X', is_yaba:'N', clicks:455, share:2.22, rank:7, price:6.99, deal:0, coupon:0},
    {week:'2026-03', brand:'Nutrition Geeks', asin:'B0BQCNJ7WR', is_yaba:'N', clicks:1095, share:5.34, rank:16, price:7.99, deal:0, coupon:0},
    {week:'2026-03', brand:'Zipvit', asin:'B079H1NVYY', is_yaba:'N', clicks:352, share:1.72, rank:17, price:7.80, deal:3, coupon:0},
    {week:'2026-03', brand:'Vita Premium', asin:'B0DJDFKXJT', is_yaba:'N', clicks:806, share:3.93, rank:5, price:9.99, deal:0, coupon:0},
    {week:'2026-03', brand:'Vita Premium', asin:'B072L235Z5', is_yaba:'N', clicks:773, share:3.77, rank:6, price:8.99, deal:0, coupon:0},
    {week:'2026-03', brand:'Nu U Nutrition', asin:'B0BFF8LYR2', is_yaba:'N', clicks:478, share:2.33, rank:13, price:7.53, deal:0, coupon:0},
    {week:'2026-03', brand:'G R O U N D E D COFFEE SCRUB', asin:'B08BRSVYFM', is_yaba:'N', clicks:818, share:3.99, rank:6, price:5.99, deal:0, coupon:7},
    {week:'2026-03', brand:'WeightWorld', asin:'B086V74KKR', is_yaba:'N', clicks:4103, share:20.00, rank:1, price:8.99, deal:0, coupon:7},

    {week:'2026-04', brand:'Incite Nutrition', asin:'B00RXIIW7K', is_yaba:'Y', clicks:1426, share:7.10, rank:3, price:7.81, deal:1, coupon:0},
    {week:'2026-04', brand:'Nutrition Geeks', asin:'B08F5GBD9X', is_yaba:'N', clicks:659, share:3.28, rank:7, price:6.99, deal:0, coupon:0},
    {week:'2026-04', brand:'Nutrition Geeks', asin:'B0CR57HRDV', is_yaba:'N', clicks:3815, share:18.99, rank:4, price:9.99, deal:0, coupon:0},
    {week:'2026-04', brand:'Nutrition Geeks', asin:'B0BQCNJ7WR', is_yaba:'N', clicks:900, share:4.48, rank:14, price:7.99, deal:0, coupon:0},
    {week:'2026-04', brand:'Vita Premium', asin:'B0DJDFKXJT', is_yaba:'N', clicks:777, share:3.87, rank:6, price:9.99, deal:0, coupon:0},
    {week:'2026-04', brand:'Vita Premium', asin:'B072L235Z5', is_yaba:'N', clicks:1018, share:5.07, rank:7, price:7.64, deal:7, coupon:0},
    {week:'2026-04', brand:'Zipvit', asin:'B079H1NVYY', is_yaba:'N', clicks:391, share:1.95, rank:16, price:7.76, deal:4, coupon:0},
    {week:'2026-04', brand:'Nu U Nutrition', asin:'B0BFF8LYR2', is_yaba:'N', clicks:440, share:2.19, rank:18, price:9.25, deal:0, coupon:0},
    {week:'2026-04', brand:'WeightWorld', asin:'B086V74KKR', is_yaba:'N', clicks:3821, share:19.02, rank:1, price:8.99, deal:0, coupon:7},
    {week:'2026-04', brand:'G R O U N D E D COFFEE SCRUB', asin:'B08BRSVYFM', is_yaba:'N', clicks:940, share:4.68, rank:5, price:5.99, deal:0, coupon:7}
    ];

    // GOOGLE CHARTS LOGIC
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        drawGlobalTrend();
        drawBrandComp();
        drawEfficiency();
        populateInteractiveControls();
        updateInteractiveView();
    }

    // UTILS
    function groupBy(list, keyGetter) {
        const map = new Map();
        list.forEach((item) => {
             const key = keyGetter(item);
             const collection = map.get(key);
             if (!collection) {
                 map.set(key, [item]);
             } else {
                 collection.push(item);
             }
        });
        return map;
    }

    // CHART 1: GLOBAL TREND (COMBO)
    function drawGlobalTrend() {
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const dataArray = [['Semana', 'Total Clicks Mercado', 'Incite Nutrition Share (%)']];

        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week === w);
            const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
            const myData = weekData.find(d => d.is_yaba === 'Y');
            const myShare = myData ? myData.share : 0;
            dataArray.push([w, totalClicks, myShare]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            vAxes: {0: {title: 'Volumen Clics'}, 1: {title: 'Share %', format: '#\'%\''}},
            hAxis: {title: 'Semana'},
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
            colors: ['#e0e0e0'],
            legend: {position: 'bottom'},
            chartArea: {width: '80%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // CHART 2: BRAND COMPETITIVENESS (LINE)
    function drawBrandComp() {
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const brands = ['Incite Nutrition', 'Nutrition Geeks', 'WeightWorld', 'Vita Premium'];
        
        // Header
        const header = ['Semana', ...brands];
        const dataArray = [header];

        weeks.forEach(w => {
            const row = [w];
            brands.forEach(b => {
                const brandData = marketData.filter(d => d.week === w && d.brand === b);
                // Sum share if multiple ASINs
                const shareSum = brandData.reduce((sum, d) => sum + d.share, 0);
                row.push(shareSum);
            });
            dataArray.push(row);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '85%', height: '70%'},
            lineWidth: 3
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    // CHART 3: EFFICIENCY (SCATTER)
    function drawEfficiency() {
        const dataArray = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        marketData.forEach(d => {
            const color = d.is_yaba === 'Y' ? '#4285F4' : '#bdc1c6';
            const tooltip = `${d.brand} (${d.week})\nRank: ${d.rank}\nShare: ${d.share}%`;
            dataArray.push([d.rank, d.share, `point { fill-color: ${color}; size: 6; }`, tooltip]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            title: 'Correlación Rank Orgánico vs Cuota de Clics',
            hAxis: {title: 'Organic Rank (Menor es mejor)', direction: 1},
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // INTERACTIVE LOGIC
    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        if (tabId === 'static') {
            document.getElementById('tab-static').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            // Redraw charts to fix width issues if hidden
            drawGlobalTrend();
            drawBrandComp();
            drawEfficiency();
        } else {
            document.getElementById('tab-interactive').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
        }
    }

    function populateInteractiveControls() {
        // Weeks
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const weekSel = document.getElementById('weekSelector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        // Select last week by default
        weekSel.value = weeks[weeks.length-1];

        // Competitors
        const comps = [...new Set(marketData.filter(d => d.is_yaba === 'N').map(d => d.brand))].sort();
        const compSel = document.getElementById('compSelector');
        comps.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });
        // Select main competitor
        compSel.value = 'Nutrition Geeks';
    }

    function updateInteractiveView() {
        const week = document.getElementById('weekSelector').value;
        const comp = document.getElementById('compSelector').value;

        // Filter Data
        const myData = marketData.filter(d => d.week === week && d.is_yaba === 'Y');
        const compData = marketData.filter(d => d.week === week && d.brand === comp);

        // Aggregates
        const myAgg = aggregateMetrics(myData);
        const compAgg = aggregateMetrics(compData);

        // Render Cards
        renderMetricCard('myMetrics', myAgg);
        renderMetricCard('compMetrics', compAgg);

        // Render Table
        renderDetailsTable(week, comp);
    }

    function aggregateMetrics(data) {
        if (data.length === 0) return {share: 0, price: 0, rank: 0, deal: 0};
        const totalShare = data.reduce((s, d) => s + d.share, 0);
        const avgPrice = data.reduce((s, d) => s + d.price, 0) / data.length;
        const avgRank = data.reduce((s, d) => s + d.rank, 0) / data.length;
        const maxDeal = Math.max(...data.map(d => d.deal));
        return {share: totalShare.toFixed(2), price: avgPrice.toFixed(2), rank: avgRank.toFixed(1), deal: maxDeal};
    }

    function renderMetricCard(elementId, metrics) {
        const html = `
            <div style="font-size:32px; font-weight:bold; margin-bottom:8px;">${metrics.share}%</div>
            <div style="font-size:14px; color:var(--gray-700);">Click Share</div>
            <div style="margin-top:16px; display:flex; justify-content:space-around; text-align:left;">
                <div>
                    <div style="font-weight:bold;">£${metrics.price}</div>
                    <div style="font-size:11px; color:var(--gray-700);">Precio Avg</div>
                </div>
                <div>
                    <div style="font-weight:bold;">#${metrics.rank}</div>
                    <div style="font-size:11px; color:var(--gray-700);">Org Rank</div>
                </div>
                <div>
                    <div style="font-weight:bold;">${metrics.deal}</div>
                    <div style="font-size:11px; color:var(--gray-700);">Días Deal</div>
                </div>
            </div>
        `;
        document.getElementById(elementId).innerHTML = html;
    }

    function renderDetailsTable(week, compBrand) {
        // Get all rows for Me and Competitor
        const relevantData = marketData.filter(d => d.week === week && (d.is_yaba === 'Y' || d.brand === compBrand));
        
        const rows = relevantData.map(d => `
            <tr>
                <td><span class="badge ${d.is_yaba === 'Y' ? 'badge-y' : 'badge-n'}">${d.is_yaba === 'Y' ? 'NOSOTROS' : 'RIVAL'}</span></td>
                <td>${d.asin}</td>
                <td>£${d.price.toFixed(2)}</td>
                <td>${d.share}%</td>
                <td>${d.rank}</td>
                <td>${d.deal > 0 ? '✅' : '-'}</td>
                <td>${d.coupon > 0 ? '✅' : '-'}</td>
            </tr>
        `).join('');

        const tableHtml = `
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>ASIN</th>
                        <th>Precio</th>
                        <th>Share</th>
                        <th>Rank</th>
                        <th>Deal</th>
                        <th>Coupon</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
        document.getElementById('detailsTable').innerHTML = tableHtml;
    }

    // Window resize handler
    window.addEventListener('resize', function() {
        if(!document.getElementById('tab-static').classList.contains('hidden')){
            drawGlobalTrend();
            drawBrandComp();
            drawEfficiency();
        }
    });

</script>

</body>
</html>