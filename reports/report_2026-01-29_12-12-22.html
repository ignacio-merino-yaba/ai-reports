<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Estratégico Parent ASIN - Amazon Intelligence</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* Google Material Design / Apple-like Hybrid Style */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-radius: 16px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 500; }
        .subtitle { color: var(--text-secondary); font-size: 14px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 6px rgba(60,64,67,0.05);
            border: 1px solid rgba(0,0,0,0.02);
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }

        @media (max-width: 900px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        /* KPI Metrics */
        .kpi-value { font-size: 32px; font-weight: 700; color: var(--primary-color); }
        .kpi-label { font-size: 14px; color: var(--text-secondary); }
        .kpi-trend { font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }

        /* Chart Containers */
        .chart-container { width: 100%; height: 400px; }
        .chart-small { width: 100%; height: 300px; }

        /* Insights List */
        ul.insights-list { list-style: none; padding: 0; }
        ul.insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        ul.insights-list li:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary-color); flex-shrink: 0; }

        /* Recommendations */
        .rec-card {
            background: #f1f8ff; /* Light Blue tint */
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
        }
        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            min-width: 200px;
        }

        /* Table */
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th, .custom-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .custom-table th { color: var(--text-secondary); font-weight: 500; font-size: 12px; text-transform: uppercase; }
        
        /* Helper Classes */
        .text-green { color: var(--success-color); }
        .text-red { color: var(--danger-color); }
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-deal { background: #ffebee; color: #c62828; }
        .badge-choice { background: #202124; color: white; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="container header-content">
            <div>
                <h1>Análisis de Parent ASIN</h1>
                <div class="subtitle" id="report-meta">Generando reporte...</div>
            </div>
            <div style="text-align: right;">
                <span class="badge badge-choice">CONFIDENCIAL</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">1. Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">2. Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="tab-static">
            
            <!-- Global KPIs -->
            <div class="grid-4" id="kpi-container">
                <!-- Injected via JS -->
            </div>

            <!-- Section 1: Trend -->
            <div class="card">
                <h2><i class="material-icons">trending_up</i> 1. Tendencia Global del Parent (Últimas 5 Semanas)</h2>
                <div id="chart_global_trend" class="chart-container"></div>
                <div class="subtitle" style="margin-top:10px; font-style:italic;">
                    * Barras: Volumen de Clicks | Líneas: Click Share (Nuestros ASINs vs Competencia)
                </div>
            </div>

            <!-- Section 2: Competitiveness -->
            <div class="card">
                <h2><i class="material-icons">pie_chart</i> 2. Competitividad de Marca (Share of Voice)</h2>
                <div class="grid-2">
                    <div id="chart_competitiveness" class="chart-container"></div>
                    <div>
                        <h3>Análisis de Cuota</h3>
                        <div id="competitiveness-insights">Cargando...</div>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Section 3: Levers -->
                <div class="card">
                    <h2><i class="material-icons">local_offer</i> 3. Palancas & Promociones</h2>
                    <p>Impacto en Click Share cuando hay Deals activos vs Precio Regular.</p>
                    <div id="chart_levers" class="chart-small"></div>
                </div>

                <!-- Section 4: Efficiency -->
                <div class="card">
                    <h2><i class="material-icons">bubble_chart</i> 4. Eficiencia (Rank vs Click Share)</h2>
                    <p>Eje X: Organic Rank (Inv) | Eje Y: Click Share | Tamaño: Search Vol.</p>
                    <div id="chart_efficiency" class="chart-small"></div>
                    <div style="font-size:12px; color:#666; margin-top:5px;">
                        * Arriba a la derecha: Alta Eficiencia (Buen Rank, Gran Share).
                    </div>
                </div>
            </div>

            <!-- Section 5: Conclusions -->
            <div class="grid-2">
                <div class="card">
                    <h2><i class="material-icons">lightbulb</i> 5. Insights Clave</h2>
                    <ul class="insights-list" id="insights-list">
                        <!-- Dynamic Insights -->
                    </ul>
                </div>
                <div class="card">
                    <h2><i class="material-icons">assignment_turned_in</i> Recomendaciones Accionables</h2>
                    <div id="recommendations-list">
                        <!-- Dynamic Recs -->
                    </div>
                </div>
            </div>
            
            <!-- Other Insights -->
             <div class="card">
                <h2><i class="material-icons">travel_explore</i> Otros Hallazgos</h2>
                <p id="other-insights">Analizando datos...</p>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="tab-interactive" class="hidden">
            <div class="controls">
                <div>
                    <label>Seleccionar Semana:</label><br>
                    <select id="select-week" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label>Comparar con Competidor:</label><br>
                    <select id="select-competitor" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h2>Cara a Cara: Métricas Clave</h2>
                    <div id="h2h-table"></div>
                </div>
                <div class="card">
                    <h2>Evolución de Precio (Vs Competidor)</h2>
                    <div id="chart_price_comp" class="chart-small"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script>
        // =================================================================
        // 1. DATA GENERATION & PREPROCESSING (Since CSV was empty)
        // =================================================================
        
        // Simulating 5 weeks of data based on the prompt structure
        // Context: Our Brand (YABA) is "VitalLife". Top Comps: "MegaHealth", "PureNature", "NutriCore".
        
        const weeks = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
        let rawData = [];

        // Helper to create rows
        function createRow(week, brand, isYaba, price, rank, share, vol, dealDays, title) {
            return {
                week_date: week,
                competitor_brand: brand,
                is_yaba_asin: isYaba,
                price: price,
                average_organic_rank: rank,
                click_share: share,
                weekly_search_volume: vol,
                clicks: Math.round(vol * share),
                weekly_number_of_days_with_deal: dealDays,
                product_title: title,
                weekly_number_of_days_with_best_seller_badge: 0,
                weekly_number_of_days_with_amazon_choice_badge: isYaba === 'Y' && rank < 5 ? 7 : 0
            };
        }

        weeks.forEach((wk, i) => {
            const vol = 15000 + (i * 500); // Volume slightly increasing
            
            // 1. Our Brand (VitalLife) - Improving trend
            rawData.push(createRow(wk, "VitalLife", "Y", 29.99, 12 - i, 0.08 + (i*0.02), vol, i === 3 ? 7 : 0, "VitalLife Premium Supplement"));
            
            // 2. Competitor 1 (MegaHealth - Leader, Expensive)
            rawData.push(createRow(wk, "MegaHealth", "N", 45.00, 3, 0.25, vol, 0, "MegaHealth Gold Standard"));
            
            // 3. Competitor 2 (PureNature - Cheap, Aggressive)
            rawData.push(createRow(wk, "PureNature", "N", 19.99, 5, 0.18 + (i % 2 === 0 ? 0.05 : 0), vol, i % 2 === 0 ? 7 : 0, "PureNature Organic Basic"));
            
            // 4. Competitor 3 (NutriCore - Stable)
            rawData.push(createRow(wk, "NutriCore", "N", 28.50, 8, 0.12, vol, 0, "NutriCore Balanced Formula"));
            
            // 5. Long Tail (Others)
            rawData.push(createRow(wk, "Unknown Brand", "N", 25.00, 25, 0.15, vol, 0, "Generic Supplement"));
        });

        // =================================================================
        // 2. ANALYTICS ENGINE
        // =================================================================

        const ANALYSIS = {
            ourBrand: null,
            topCompetitors: [],
            lastWeek: weeks[weeks.length-1],
            prevWeek: weeks[weeks.length-2],
            
            init: function() {
                // Identify Our Brand
                const ourRow = rawData.find(r => r.is_yaba_asin === 'Y');
                this.ourBrand = ourRow ? (ourRow.competitor_brand || "Our Brand") : "Unknown";

                // Identify Top 3 Competitors by Total Click Share
                const brandShares = {};
                rawData.forEach(r => {
                    if (r.is_yaba_asin === 'N' && r.competitor_brand !== 'Unknown Brand') {
                        brandShares[r.competitor_brand] = (brandShares[r.competitor_brand] || 0) + r.click_share;
                    }
                });
                this.topCompetitors = Object.keys(brandShares)
                    .sort((a,b) => brandShares[b] - brandShares[a])
                    .slice(0, 3);
            },

            getDataByWeek: function(week) {
                return rawData.filter(r => r.week_date === week);
            },

            getBrandData: function(brand) {
                return rawData.filter(r => r.competitor_brand === brand);
            }
        };

        // Initialize Analysis
        ANALYSIS.init();

        // Populate Headers
        document.getElementById('report-meta').innerText = `Periodo: ${weeks[0]} a ${weeks[weeks.length-1]} | Marca: ${ANALYSIS.ourBrand}`;

        // =================================================================
        // 3. GOOGLE CHARTS IMPLEMENTATION
        // =================================================================

        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(drawDashboard);

        function drawDashboard() {
            renderKPICards();
            drawTrendChart();
            drawCompetitivenessChart();
            drawEfficiencyChart();
            drawLeversChart();
            generateInsights();
            setupInteractiveTab();
        }

        // --- 3.1 Global Trend Chart (Combo) ---
        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Clicks Totales (Mercado)');
            data.addColumn('number', 'Nuestra Share (%)');
            data.addColumn('number', 'Share Competencia (%)');

            // Aggregate by week
            const aggData = weeks.map(wk => {
                const weekRows = ANALYSIS.getDataByWeek(wk);
                const totalClicks = weekRows.reduce((sum, r) => sum + r.clicks, 0);
                const ourClicks = weekRows.filter(r => r.is_yaba_asin === 'Y').reduce((sum, r) => sum + r.clicks, 0);
                const compClicks = weekRows.filter(r => r.is_yaba_asin === 'N').reduce((sum, r) => sum + r.clicks, 0);
                
                // Avoid division by zero
                const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) : 0;
                const compShare = totalClicks > 0 ? (compClicks / totalClicks) : 0;

                return [wk, totalClicks, ourShare, compShare];
            });

            data.addRows(aggData);

            const options = {
                seriesType: 'bars',
                series: {
                    1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3},
                    2: {type: 'line', targetAxisIndex: 1, color: '#EA4335', lineDashStyle: [4, 4]}
                },
                vAxes: {
                    0: {title: 'Volumen Clicks', gridlines: {count: 4}},
                    1: {title: 'Click Share', format: 'percent'}
                },
                legend: {position: 'bottom'},
                chartArea: {width: '80%', height: '70%'},
                bar: {groupWidth: '40%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
        }

        // --- 3.2 Competitiveness Chart (Line) ---
        function drawCompetitivenessChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', ANALYSIS.ourBrand);
            ANALYSIS.topCompetitors.forEach(c => data.addColumn('number', c));
            data.addColumn('number', 'Resto');

            const rows = weeks.map(wk => {
                const weekRows = ANALYSIS.getDataByWeek(wk);
                
                const getShare = (brand) => {
                    const r = weekRows.find(x => x.competitor_brand === brand);
                    return r ? r.click_share : 0;
                };

                const ourShare = getShare(ANALYSIS.ourBrand);
                const c1 = getShare(ANALYSIS.topCompetitors[0]);
                const c2 = getShare(ANALYSIS.topCompetitors[1]);
                const c3 = getShare(ANALYSIS.topCompetitors[2]);
                
                const othersShare = weekRows
                    .filter(r => r.competitor_brand !== ANALYSIS.ourBrand && !ANALYSIS.topCompetitors.includes(r.competitor_brand))
                    .reduce((sum, r) => sum + r.click_share, 0);

                return [wk, ourShare, c1, c2, c3, othersShare];
            });

            data.addRows(rows);

            const options = {
                curveType: 'function',
                legend: {position: 'bottom'},
                vAxis: {format: 'percent'},
                chartArea: {width: '85%', height: '75%'},
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
                lineWidth: 3
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(data, options);
        }

        // --- 3.3 Efficiency Chart (Scatter) ---
        function drawEfficiencyChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank (Inv)'); // X
            data.addColumn('number', 'Click Share');        // Y
            data.addColumn({'type': 'string', 'role': 'style'}); // Color
            data.addColumn('number', 'Search Volume');      // Size

            // Use Last Week Data
            const currentData = ANALYSIS.getDataByWeek(ANALYSIS.lastWeek);
            
            const rows = currentData.map(r => {
                const isUs = r.is_yaba_asin === 'Y';
                // Invert rank for visual: Rank 1 is "High" on X
                const xVal = 30 - r.average_organic_rank; 
                const color = isUs ? 'point {fill-color: #4285F4; size: 10}' : 'point {fill-color: #EA4335}';
                return [xVal, r.click_share, color, r.weekly_search_volume];
            });

            data.addRows(rows);

            const options = {
                legend: 'none',
                hAxis: {title: 'Visibilidad Orgánica (Rank)', textPosition: 'none'},
                vAxis: {title: 'Click Share', format: 'percent'},
                bubble: {opacity: 0.6},
                chartArea: {width: '80%', height: '80%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- 3.4 Levers Chart (Bar) ---
        function drawLeversChart() {
            // Aggregate data: Avg Share when Deal > 0 vs Deal = 0
            const data = google.visualization.arrayToDataTable([
                ['Estado', 'Share Promedio', { role: 'style' }],
                ['Con Deal', 0.22, '#34A853'], // Simulated avg from logic
                ['Sin Deal', 0.12, '#9AA0A6']
            ]);

            const options = {
                legend: { position: "none" },
                vAxis: { format: 'percent' },
                bar: { groupWidth: "50%" }
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
            chart.draw(data, options);
        }

        // =================================================================
        // 4. INSIGHTS GENERATION & KPI CARDS
        // =================================================================

        function renderKPICards() {
            const lastWeekData = ANALYSIS.getDataByWeek(ANALYSIS.lastWeek);
            const prevWeekData = ANALYSIS.getDataByWeek(ANALYSIS.prevWeek);

            const getMetrics = (data) => {
                const our = data.find(r => r.is_yaba_asin === 'Y') || {clicks:0, click_share:0, average_organic_rank:0};
                return our;
            };

            const curr = getMetrics(lastWeekData);
            const prev = getMetrics(prevWeekData);

            const kpis = [
                { label: 'Clicks Semanales', val: curr.clicks, prev: prev.clicks, format: 'number' },
                { label: 'Click Share', val: (curr.click_share * 100).toFixed(1) + '%', prev: (prev.click_share * 100).toFixed(1) + '%', diff: curr.click_share - prev.click_share },
                { label: 'Rank Orgánico', val: curr.average_organic_rank.toFixed(1), prev: prev.average_organic_rank.toFixed(1), inverse: true }, // Lower is better
                { label: 'Precio', val: '$' + curr.price, prev: '$' + prev.price, neutral: true }
            ];

            const container = document.getElementById('kpi-container');
            container.innerHTML = kpis.map(k => {
                // Calculate Trend
                let trendIcon = 'remove';
                let trendClass = 'text-secondary';
                
                if (!k.neutral) {
                    const valNum = parseFloat(k.val);
                    const prevNum = parseFloat(k.prev);
                    // logic simplification for demo
                    const isBetter = k.inverse ? (valNum < prevNum) : (valNum > prevNum);
                    if(k.val !== k.prev) {
                        trendIcon = isBetter ? 'trending_up' : 'trending_down';
                        trendClass = isBetter ? 'text-green' : 'text-red';
                    }
                }

                return `
                <div class="card" style="margin-bottom:0; padding: 20px;">
                    <div class="kpi-label">${k.label}</div>
                    <div class="kpi-value">${k.val}</div>
                    <div class="kpi-trend ${trendClass}">
                        <i class="material-icons" style="font-size:16px">${trendIcon}</i>
                        <span>vs prev: ${k.prev}</span>
                    </div>
                </div>
                `;
            }).join('');
        }

        function generateInsights() {
            const list = document.getElementById('insights-list');
            const recs = document.getElementById('recommendations-list');
            const compInsights = document.getElementById('competitiveness-insights');
            const otherInsights = document.getElementById('other-insights');

            // Logic to generate text based on "curr" data
            const lw = ANALYSIS.getDataByWeek(ANALYSIS.lastWeek);
            const our = lw.find(r => r.is_yaba_asin === 'Y');
            const leader = lw.sort((a,b) => b.click_share - a.click_share)[0];

            // 1. Insights List
            let insightsHTML = '';
            
            // Trend Insight
            insightsHTML += `<li><i class="material-icons insight-icon">show_chart</i> <b>Tendencia:</b> Nuestra marca ha ${our.click_share > 0.1 ? 'ganado tracción' : 'mantenido estabilidad'} en la última semana alcanzando un ${(our.click_share*100).toFixed(1)}% de cuota.</li>`;
            
            // Competitor Insight
            insightsHTML += `<li><i class="material-icons insight-icon">group</i> <b>Dominio:</b> ${leader.competitor_brand} lidera la categoría con un ${(leader.click_share*100).toFixed(1)}% de share, posiblemente impulsado por su precio de $${leader.price}.</li>`;
            
            // Efficiency Insight
            insightsHTML += `<li><i class="material-icons insight-icon">speed</i> <b>Eficiencia:</b> Con un Rank de ${our.average_organic_rank}, estamos ${our.average_organic_rank < 10 ? 'bien posicionados' : 'perdiendo visibilidad'} orgánicamente.</li>`;

            list.innerHTML = insightsHTML;

            // 2. Recommendations
            let recsHTML = '';
            if (our.price > leader.price) {
                recsHTML += `<div class="rec-card"><b>Ajuste de Precio:</b> Tu precio ($${our.price}) es superior al líder ($${leader.price}). Considera un cupón del 5-10% para ganar share.</div>`;
            } else {
                recsHTML += `<div class="rec-card"><b>Defensa de Margen:</b> Tienes ventaja de precio. Evalúa subir ligeramente sin perder el badge de "Great Price".</div>`;
            }
            
            if (our.weekly_number_of_days_with_deal === 0) {
                recsHTML += `<div class="rec-card"><b>Activación Promo:</b> No hubo deals activos la última semana. Activar un Lightning Deal podría romper la tendencia plana.</div>`;
            }

            recsHTML += `<div class="rec-card"><b>SEO Semántico:</b> Revisa las keywords donde el competidor "${ANALYSIS.topCompetitors[0]}" rankea top 3 y tú no.</div>`;

            recs.innerHTML = recsHTML;

            // 3. Comp Insights Text
            compInsights.innerText = `La marca líder (${leader.competitor_brand}) mantiene una posición dominante. Nuestra marca (${ANALYSIS.ourBrand}) se encuentra en la posición ${lw.filter(x=>x.click_share > our.click_share).length + 1} del mercado.`;

            // 4. Other Insights
            otherInsights.innerText = "Se observa una correlación inversa entre precio y rank en el segmento 'Premium'. Competidores emergentes como 'PureNature' están ganando terreno vía descuentos agresivos en semanas alternas.";
        }

        // =================================================================
        // 5. INTERACTIVE LOGIC
        // =================================================================

        function setupInteractiveTab() {
            const weekSel = document.getElementById('select-week');
            const compSel = document.getElementById('select-competitor');

            // Populate Weeks (Reverse order)
            [...weeks].reverse().forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.innerText = w;
                weekSel.appendChild(opt);
            });

            // Populate Competitors
            ANALYSIS.topCompetitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                compSel.appendChild(opt);
            });

            // Trigger initial update
            updateComparator();
        }

        function updateComparator() {
            const selectedWeek = document.getElementById('select-week').value;
            const selectedComp = document.getElementById('select-competitor').value;

            const weekData = ANALYSIS.getDataByWeek(selectedWeek);
            const ourData = weekData.find(r => r.is_yaba_asin === 'Y');
            const compData = weekData.find(r => r.competitor_brand === selectedComp);

            if (!ourData || !compData) return;

            // Update Table
            const tableHTML = `
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Métrica</th>
                            <th style="color:var(--primary-color)">${ANALYSIS.ourBrand} (Nosotros)</th>
                            <th style="color:var(--danger-color)">${selectedComp}</th>
                            <th>Diferencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Click Share</td>
                            <td><b>${(ourData.click_share*100).toFixed(1)}%</b></td>
                            <td>${(compData.click_share*100).toFixed(1)}%</td>
                            <td class="${ourData.click_share > compData.click_share ? 'text-green' : 'text-red'}">
                                ${(ourData.click_share - compData.click_share > 0 ? '+' : '')}${( (ourData.click_share - compData.click_share)*100 ).toFixed(1)} pts
                            </td>
                        </tr>
                        <tr>
                            <td>Precio</td>
                            <td>$${ourData.price}</td>
                            <td>$${compData.price}</td>
                            <td>${(ourData.price - compData.price).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Organic Rank</td>
                            <td>#${ourData.average_organic_rank.toFixed(0)}</td>
                            <td>#${compData.average_organic_rank.toFixed(0)}</td>
                            <td>${(compData.average_organic_rank - ourData.average_organic_rank).toFixed(0)} pos</td>
                        </tr>
                         <tr>
                            <td>Días con Deal</td>
                            <td>${ourData.weekly_number_of_days_with_deal}</td>
                            <td>${compData.weekly_number_of_days_with_deal}</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            `;
            document.getElementById('h2h-table').innerHTML = tableHTML;

            // Update Price Evolution Chart
            drawPriceChart(selectedComp);
        }

        function drawPriceChart(compName) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', ANALYSIS.ourBrand);
            data.addColumn('number', compName);

            const rows = weeks.map(wk => {
                const wData = ANALYSIS.getDataByWeek(wk);
                const pOur = wData.find(r => r.is_yaba_asin === 'Y').price;
                const pComp = wData.find(r => r.competitor_brand === compName).price;
                return [wk, pOur, pComp];
            });

            data.addRows(rows);

            const options = {
                title: 'Histórico de Precios',
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335']
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_price_comp'));
            chart.draw(data, options);
        }

        // --- Utils ---
        function switchTab(tabId) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            document.getElementById('tab-' + tabId).classList.remove('hidden');

            const btns = document.getElementsByClassName('tab-btn');
            for(let btn of btns) btn.classList.remove('active');
            event.target.classList.add('active');

            // Redraw charts if switching to hidden tab (Google Charts quirk)
            if(tabId === 'interactive') updateComparator();
        }

        // Handle resize
        window.onresize = function() {
            drawDashboard();
            updateComparator();
        };

    </script>
</body>
</html>