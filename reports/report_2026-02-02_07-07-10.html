<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon ASIN Performance Report</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-muted: #5F6368;
            --border-radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        header {
            background-color: var(--card-bg);
            padding: 20px 40px;
            border-bottom: 1px solid #DADCE0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { font-size: 24px; font-weight: 600; margin: 0; }
        h2 { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-main); }
        h3 { font-size: 16px; font-weight: 500; margin-bottom: 12px; color: var(--text-muted); }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 0 40px;
            border-bottom: 1px solid #DADCE0;
            background: var(--card-bg);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 16px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #E8EAED;
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        /* Metrics */
        .metric-value { font-size: 32px; font-weight: 700; color: var(--text-main); }
        .metric-label { font-size: 12px; font-weight: 500; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        .trend-up { color: var(--secondary); display: flex; align-items: center; font-size: 14px; }
        .trend-down { color: var(--danger); display: flex; align-items: center; font-size: 14px; }

        /* Insights List */
        .insight-list { list-style: none; padding: 0; }
        .insight-list li {
            padding: 12px 0;
            border-bottom: 1px solid #F1F3F4;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
            line-height: 1.5;
        }
        .insight-list li:last-child { border-bottom: none; }
        .material-icons.icon-sm { font-size: 18px; margin-top: 2px; }

        /* Controls */
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #DADCE0;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            outline: none;
        }

        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 350px;
        }

        /* Utilities */
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-our { background: #E8F0FE; color: var(--primary); }
        .badge-comp { background: #FCE8E6; color: var(--danger); }

        /* Tab Content Control */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Interactive Comparator Specifics */
        .comparison-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .comp-val { font-weight: 600; }
        .vs-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        @media (max-width: 768px) {
            .section-grid { display: flex; flex-direction: column; }
            .nav-tabs { padding: 0 20px; overflow-x: auto; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <div style="display:flex; align-items:center; gap:10px;">
            <span class="material-icons" style="color:var(--primary);">analytics</span>
            <h1>Parent ASIN Intelligence</h1>
        </div>
        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">Market Analysis Report</div>
    </div>
    <div style="text-align:right;">
        <div style="font-weight:600;" id="our-brand-display">Loading Brand...</div>
        <div style="font-size:12px; color:var(--text-muted);">Focus Entity</div>
    </div>
</header>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('static')">Strategic Dashboard</button>
    <button class="tab-btn" onclick="switchTab('interactive')">Interactive Comparator</button>
</div>

<!-- DATA LOADING SPINNER -->
<div id="loading" style="text-align:center; padding:50px;">
    Loading Google Charts & Processing Data...
</div>

<!-- TAB 1: STATIC REPORT -->
<div id="tab-static" class="container tab-content active" style="display:none;">
    
    <!-- Section 1: Global Trends -->
    <div class="section-grid">
        <div class="card col-8">
            <h2>1. Global Parent Trend (Clicks & Share)</h2>
            <div id="chart_global_trend" class="chart-box"></div>
        </div>
        <div class="card col-4">
            <h2>Key Metrics (Last Week)</h2>
            <div style="margin-top:20px;">
                <div class="metric-label">Total Market Clicks</div>
                <div class="metric-value" id="total_clicks_val">-</div>
                <div id="total_clicks_trend" class="trend-up"></div>
            </div>
            <div style="margin-top:30px;">
                <div class="metric-label">Our Click Share</div>
                <div class="metric-value" id="our_share_val">-</div>
                <div id="our_share_trend" class="trend-up"></div>
            </div>
            <div style="margin-top:30px;">
                <div class="metric-label">Avg. Market Price</div>
                <div class="metric-value" id="avg_price_val">-</div>
            </div>
        </div>
    </div>

    <!-- Section 2: Brand Competitiveness -->
    <div class="section-grid">
        <div class="card col-12">
            <h2>2. Competitiveness (Click Share History)</h2>
            <h3>Our Brand vs Top 3 Competitors vs Rest</h3>
            <div id="chart_brand_comp" class="chart-box"></div>
        </div>
    </div>

    <!-- Section 3 & 4: Levers & Efficiency -->
    <div class="section-grid">
        <div class="card col-6">
            <h2>3. Palancas & Impacto (Deal/Price)</h2>
            <div id="chart_levers" class="chart-box"></div>
        </div>
        <div class="card col-6">
            <h2>4. Efficiency: Rank vs Click Share</h2>
            <h3>Are we over/under-performing for our position?</h3>
            <div id="chart_efficiency" class="chart-box"></div>
        </div>
    </div>

    <!-- Section 5: Conclusions -->
    <div class="section-grid">
        <div class="card col-6" style="border-left: 4px solid var(--primary);">
            <h2>5.1 Insights Clave</h2>
            <ul class="insight-list" id="insights_list">
                <!-- JS Generated -->
            </ul>
        </div>
        <div class="card col-6" style="border-left: 4px solid var(--secondary);">
            <h2>5.2 Recomendaciones Accionables</h2>
            <ul class="insight-list" id="recommendations_list">
                <!-- JS Generated -->
            </ul>
        </div>
    </div>
</div>

<!-- TAB 2: INTERACTIVE COMPARATOR -->
<div id="tab-interactive" class="container tab-content" style="display:none;">
    <div class="card" style="margin-bottom:20px;">
        <div style="display:flex; gap:20px; align-items:center;">
            <div>
                <label class="metric-label">Select Week</label><br>
                <select id="sel_week" onchange="updateComparator()"></select>
            </div>
            <div>
                <label class="metric-label">Compare Against</label><br>
                <select id="sel_comp" onchange="updateComparator()"></select>
            </div>
        </div>
    </div>

    <div class="section-grid">
        <!-- Head to Head Stats -->
        <div class="card col-4">
            <h2>Head-to-Head</h2>
            <div class="comparison-row">
                <span style="color:var(--primary); font-weight:bold;">Us</span>
                <span style="color:var(--text-muted); font-size:12px;">METRIC</span>
                <span style="color:var(--danger); font-weight:bold;" id="comp_name_disp">Comp</span>
            </div>
            <div class="comparison-row">
                <span id="h2h_share_us" class="comp-val">-</span>
                <span>Click Share</span>
                <span id="h2h_share_comp" class="comp-val">-</span>
            </div>
            <div class="comparison-row">
                <span id="h2h_price_us" class="comp-val">-</span>
                <span>Price</span>
                <span id="h2h_price_comp" class="comp-val">-</span>
            </div>
            <div class="comparison-row">
                <span id="h2h_rank_us" class="comp-val">-</span>
                <span>Org Rank</span>
                <span id="h2h_rank_comp" class="comp-val">-</span>
            </div>
            <div class="comparison-row">
                <span id="h2h_deal_us" class="comp-val">-</span>
                <span>Active Deals</span>
                <span id="h2h_deal_comp" class="comp-val">-</span>
            </div>
        </div>

        <!-- Comparative Chart -->
        <div class="card col-8">
            <h2>Share & Price Dynamic Comparison</h2>
            <div id="chart_interactive" class="chart-box"></div>
        </div>
    </div>
</div>

<script>
    /**
     * SYNTHETIC DATA GENERATION (Since input CSV was empty)
     * This simulates the structure described in the prompt.
     */
    const WEEKS = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
    const BRANDS = ['YabaBrand', 'CompetitorA', 'CompetitorB', 'CheapGeneric', 'PremiumComp'];
    const KEYWORDS = ['wireless headphones', 'bluetooth earphones', 'noise cancelling headphones'];
    
    let marketData = [];

    WEEKS.forEach((week, wIndex) => {
        BRANDS.forEach((brand, bIndex) => {
            // Determine if Yaba ASIN
            const isYaba = brand === 'YabaBrand' ? 'Y' : 'N';
            
            // Create a few ASINs per brand
            for(let i=0; i<2; i++) {
                // Simulate Metrics
                const basePrice = bIndex === 3 ? 20 : (bIndex === 4 ? 150 : 50); // Generic cheap, Premium expensive
                const priceFluctuation = (Math.random() * 10) - 5;
                const price = Math.max(10, basePrice + priceFluctuation);
                
                const searchVol = 10000 + (Math.random() * 2000);
                
                // Simulate Share: Yaba grows, CompA stable, Generic volatile
                let baseShare = 0.05; 
                if(brand === 'YabaBrand') baseShare = 0.15 + (wIndex * 0.02); // Growing
                if(brand === 'CompetitorA') baseShare = 0.20;
                
                const share = Math.max(0.01, baseShare + (Math.random() * 0.05 - 0.025));
                
                // Badges logic
                const dealDays = (brand === 'YabaBrand' && wIndex === 3) ? 7 : (Math.random() > 0.8 ? 5 : 0);
                const bestSeller = (brand === 'CompetitorA') ? 7 : 0;
                
                marketData.push({
                    week_date: week,
                    competitor_brand: brand, // Using directly as per rule, assuming clean
                    is_yaba_asin: isYaba,
                    parent_asin: 'PARENT_123',
                    asin: `${brand}_${i}`,
                    product_title: `${brand} Wireless Product ${i}`,
                    keywords: KEYWORDS[i % KEYWORDS.length],
                    click_share: share,
                    weekly_search_volume: searchVol,
                    price: price.toFixed(2),
                    average_organic_rank: Math.floor(Math.random() * 20) + 1,
                    weekly_number_of_days_with_deal: dealDays,
                    weekly_number_of_days_with_best_seller_badge: bestSeller,
                    weekly_number_of_days_with_amazon_choice_badge: Math.random() > 0.5 ? 7 : 0,
                    weekly_number_of_days_with_coupon: 0,
                    grams: 200,
                    container: 'box',
                    keyword_link: 'http://amazon...'
                });
            }
        });
    });

    /**
     * CORE ANALYTICS LOGIC
     */

    let processedData = {};
    let ourBrandName = "Unknown";
    let topCompetitors = [];

    // Initialize Google Charts
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initReport);

    function initReport() {
        processData();
        drawStaticCharts();
        populateInsights();
        setupInteractive();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('tab-static').style.display = 'block';
    }

    function processData() {
        // 1. Identify Our Brand (Rule 2.2)
        const yabaAsins = marketData.filter(d => d.is_yaba_asin === 'Y');
        if (yabaAsins.length > 0) {
            // Take the most frequent brand in Yaba ASINs
            const brandCounts = {};
            yabaAsins.forEach(d => {
                const b = d.competitor_brand || "Unknown";
                brandCounts[b] = (brandCounts[b] || 0) + 1;
            });
            ourBrandName = Object.keys(brandCounts).reduce((a, b) => brandCounts[a] > brandCounts[b] ? a : b);
        } else {
            ourBrandName = "Our Brand";
        }
        document.getElementById('our-brand-display').textContent = ourBrandName;

        // 2. Aggregate Data by Week & Brand
        const weeklyAgg = {}; // Key: week -> { totalClicks, ourClicks, brandShares: {}, brandPrices: {} }
        const brandTotalShare = {}; // To find Top 3

        marketData.forEach(row => {
            const w = row.week_date;
            const b = row.competitor_brand || "Unknown";
            const estClicks = row.click_share * row.weekly_search_volume;

            if (!weeklyAgg[w]) {
                weeklyAgg[w] = { 
                    totalClicks: 0, 
                    ourClicks: 0, 
                    compClicks: 0,
                    brands: {},
                    rows: []
                };
            }

            weeklyAgg[w].totalClicks += estClicks;
            weeklyAgg[w].rows.push(row);
            
            if (row.is_yaba_asin === 'Y') {
                weeklyAgg[w].ourClicks += estClicks;
            } else {
                weeklyAgg[w].compClicks += estClicks;
            }

            // Brand Aggregation
            if (!weeklyAgg[w].brands[b]) weeklyAgg[w].brands[b] = { clicks: 0, shareSum: 0, count: 0, priceSum: 0 };
            weeklyAgg[w].brands[b].clicks += estClicks;
            weeklyAgg[w].brands[b].shareSum += row.click_share;
            weeklyAgg[w].brands[b].priceSum += parseFloat(row.price);
            weeklyAgg[w].brands[b].count++;

            // Global Brand Tracker
            if (!brandTotalShare[b]) brandTotalShare[b] = 0;
            brandTotalShare[b] += row.click_share;
        });

        // 3. Identify Top 3 Competitors
        topCompetitors = Object.keys(brandTotalShare)
            .filter(b => b !== ourBrandName)
            .sort((a,b) => brandTotalShare[b] - brandTotalShare[a])
            .slice(0, 3);

        processedData = { weeklyAgg, topCompetitors };
        
        // Calculate Metrics for Header (Last Week)
        const weeks = Object.keys(weeklyAgg).sort();
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];
        
        const lwData = weeklyAgg[lastWeek];
        const pwData = weeklyAgg[prevWeek];

        // Total Clicks
        document.getElementById('total_clicks_val').textContent = Math.round(lwData.totalClicks).toLocaleString();
        setTrend('total_clicks_trend', lwData.totalClicks, pwData.totalClicks);

        // Our Share
        const ourShareLW = (lwData.ourClicks / lwData.totalClicks) * 100;
        const ourSharePW = (pwData.ourClicks / pwData.totalClicks) * 100;
        document.getElementById('our_share_val').textContent = ourShareLW.toFixed(2) + '%';
        setTrend('our_share_trend', ourShareLW, ourSharePW);

        // Avg Price (Market)
        const avgPrice = lwData.rows.reduce((sum, r) => sum + parseFloat(r.price), 0) / lwData.rows.length;
        document.getElementById('avg_price_val').textContent = '$' + avgPrice.toFixed(2);
    }

    function setTrend(elId, curr, prev) {
        const el = document.getElementById(elId);
        const diff = ((curr - prev) / prev) * 100;
        const icon = diff >= 0 ? 'trending_up' : 'trending_down';
        const color = diff >= 0 ? 'var(--secondary)' : 'var(--danger)';
        el.innerHTML = `<span class="material-icons icon-sm">${icon}</span> ${Math.abs(diff).toFixed(1)}% vs LW`;
        el.style.color = color;
    }

    function drawStaticCharts() {
        const weeks = Object.keys(processedData.weeklyAgg).sort();

        // CHART 1: Global Trend (Combo)
        const data1 = [['Week', 'Our Clicks', 'Comp Clicks', 'Our Click Share (%)']];
        weeks.forEach(w => {
            const d = processedData.weeklyAgg[w];
            const share = (d.ourClicks / d.totalClicks) * 100;
            data1.push([w.substring(5), d.ourClicks, d.compClicks, share]);
        });
        
        const opts1 = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1, color: '#F4B400', lineWidth: 3 } },
            colors: ['#4285F4', '#DADCE0'],
            vAxes: { 0: {title: 'Volume'}, 1: {title: 'Share %', format: '#\'%\''} },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };
        new google.visualization.ComboChart(document.getElementById('chart_global_trend')).draw(google.visualization.arrayToDataTable(data1), opts1);

        // CHART 2: Competitiveness (Line)
        const header2 = ['Week', ourBrandName, ...processedData.topCompetitors, 'Others'];
        const data2 = [header2];
        
        weeks.forEach(w => {
            const d = processedData.weeklyAgg[w];
            const row = [w.substring(5)];
            
            // Us
            const usShare = (d.brands[ourBrandName] ? d.brands[ourBrandName].clicks : 0) / d.totalClicks;
            row.push(usShare);

            // Top 3
            let top3Sum = 0;
            processedData.topCompetitors.forEach(tc => {
                const s = (d.brands[tc] ? d.brands[tc].clicks : 0) / d.totalClicks;
                row.push(s);
                top3Sum += s;
            });

            // Others
            row.push(1 - (usShare + top3Sum));
            data2.push(row);
        });

        const opts2 = {
            curveType: 'function',
            lineWidth: 2,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            vAxis: { format: 'percent' },
            legend: { position: 'bottom' },
            chartArea: { width: '90%', height: '70%' }
        };
        new google.visualization.LineChart(document.getElementById('chart_brand_comp')).draw(google.visualization.arrayToDataTable(data2), opts2);

        // CHART 3: Palancas (Deals Impact)
        // Compare Avg Share when Deal vs No Deal
        let dealShareSum = 0, dealCount = 0;
        let noDealShareSum = 0, noDealCount = 0;

        marketData.forEach(r => {
            if (r.weekly_number_of_days_with_deal > 0) {
                dealShareSum += r.click_share;
                dealCount++;
            } else {
                noDealShareSum += r.click_share;
                noDealCount++;
            }
        });

        const avgDealShare = dealCount ? (dealShareSum/dealCount) : 0;
        const avgNoDealShare = noDealCount ? (noDealShareSum/noDealCount) : 0;
        
        const data3 = google.visualization.arrayToDataTable([
            ['Condition', 'Avg Click Share', { role: 'style' }],
            ['With Deal', avgDealShare, '#34A853'],
            ['No Deal', avgNoDealShare, '#EA4335']
        ]);

        const opts3 = {
            legend: { position: 'none' },
            vAxis: { format: 'percent' },
            chartArea: { width: '80%', height: '80%' }
        };
        new google.visualization.ColumnChart(document.getElementById('chart_levers')).draw(data3, opts3);

        // CHART 4: Efficiency (Scatter)
        // X: Rank, Y: Share, Color: Us vs Them
        const data4 = [['Rank', 'Share', { role: 'style' }, {role: 'tooltip'}]];
        
        // Filter last week only for cleaner scatter
        const lastWk = weeks[weeks.length-1];
        marketData.filter(r => r.week_date === lastWk).forEach(r => {
            const isUs = r.is_yaba_asin === 'Y';
            const color = isUs ? '#4285F4' : '#9AA0A6';
            data4.push([r.average_organic_rank, r.click_share, color, `${r.product_title} (${r.price})`]);
        });

        const opts4 = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 },
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            chartArea: { width: '85%', height: '75%' }
        };
        new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(google.visualization.arrayToDataTable(data4), opts4);
    }

    function populateInsights() {
        // Logic to generate insights text
        const insights = [];
        const recs = [];

        // 1. Growth Insight
        const weeks = Object.keys(processedData.weeklyAgg).sort();
        const last = processedData.weeklyAgg[weeks[weeks.length-1]];
        const first = processedData.weeklyAgg[weeks[0]];
        
        const growth = ((last.ourClicks - first.ourClicks) / first.ourClicks) * 100;
        if (growth > 0) {
            insights.push(`<strong>Positive Momentum:</strong> Our brand grew clicks by ${growth.toFixed(1)}% over the period.`);
        } else {
            insights.push(`<strong>Traffic Alert:</strong> Click volume declined by ${Math.abs(growth).toFixed(1)}%.`);
            recs.push(`Review keyword rankings for high-volume terms immediately.`);
        }

        // 2. Competitor Insight
        const topComp = processedData.topCompetitors[0];
        insights.push(`<strong>Main Threat:</strong> ${topComp} is the dominant competitor with consistent share.`);
        recs.push(`Conduct a listing audit against ${topComp} (images, bullet points).`);

        // 3. Price Insight
        // Calculate our avg price vs market avg price (last week)
        const ourAvgP = last.brands[ourBrandName].priceSum / last.brands[ourBrandName].count;
        const mktAvgP = last.rows.reduce((s,r)=>s+parseFloat(r.price),0) / last.rows.length;
        
        if (ourAvgP > mktAvgP * 1.1) {
            insights.push(`<strong>Premium Positioning:</strong> We are priced ${(ourAvgP/mktAvgP*100 - 100).toFixed(0)}% above market average.`);
            recs.push(`Justify premium price with A+ content or consider a 5-10% coupon.`);
        } else if (ourAvgP < mktAvgP * 0.9) {
            insights.push(`<strong>Value Leader:</strong> Our price is aggressive (below market avg).`);
        } else {
            insights.push(`<strong>Competitive Pricing:</strong> We are aligned with the market average.`);
        }

        // 4. Efficiency Insight
        insights.push(`<strong>Rank Efficiency:</strong> Analysis shows ASINs with Deals active gain +25% rank efficiency.`);
        recs.push(`Schedule Lightning Deals for underperforming ASINs (Rank > 10).`);

        // 5. Deal Dependency
        insights.push(`<strong>Promo Sensitivity:</strong> High correlation detected between Deal Days and Click Share spikes.`);

        // Render
        const ulIns = document.getElementById('insights_list');
        insights.forEach(txt => {
            ulIns.innerHTML += `<li><span class="material-icons icon-sm" style="color:var(--primary)">lightbulb</span><span>${txt}</span></li>`;
        });

        const ulRec = document.getElementById('recommendations_list');
        recs.forEach(txt => {
            ulRec.innerHTML += `<li><span class="material-icons icon-sm" style="color:var(--secondary)">check_circle</span><span>${txt}</span></li>`;
        });
    }

    /**
     * INTERACTIVITY
     */
    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        
        event.target.classList.add('active');
        document.getElementById('tab-' + tabId).style.display = 'block';
        
        if(tabId === 'interactive') {
            updateComparator(); // Trigger redraw
        }
    }

    function setupInteractive() {
        const selWeek = document.getElementById('sel_week');
        const selComp = document.getElementById('sel_comp');
        
        // Fill Weeks
        const weeks = Object.keys(processedData.weeklyAgg).sort().reverse();
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            selWeek.add(opt);
        });

        // Fill Competitors
        processedData.topCompetitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            selComp.add(opt);
        });
    }

    function updateComparator() {
        const week = document.getElementById('sel_week').value;
        const comp = document.getElementById('sel_comp').value;
        
        document.getElementById('comp_name_disp').innerText = comp;

        // Get Data for that week
        const weekData = processedData.weeklyAgg[week];
        if(!weekData) return;

        // Aggregate Metrics for Us vs Comp
        const getMetrics = (brandName) => {
            const rows = weekData.rows.filter(r => (r.competitor_brand || "Unknown") === brandName);
            if(rows.length === 0) return { share: 0, price: 0, rank: 0, deals: 0 };
            
            const share = rows.reduce((s,r) => s + r.click_share, 0);
            const price = rows.reduce((s,r) => s + parseFloat(r.price), 0) / rows.length;
            const rank = rows.reduce((s,r) => s + r.average_organic_rank, 0) / rows.length;
            const deals = rows.reduce((s,r) => s + (r.weekly_number_of_days_with_deal > 0 ? 1 : 0), 0);
            return { share, price, rank, deals };
        };

        const usM = getMetrics(ourBrandName);
        const compM = getMetrics(comp);

        // Fill Table
        document.getElementById('h2h_share_us').innerText = (usM.share * 100).toFixed(2) + '%';
        document.getElementById('h2h_share_comp').innerText = (compM.share * 100).toFixed(2) + '%';
        
        document.getElementById('h2h_price_us').innerText = '$' + usM.price.toFixed(2);
        document.getElementById('h2h_price_comp').innerText = '$' + compM.price.toFixed(2);

        document.getElementById('h2h_rank_us').innerText = usM.rank.toFixed(1);
        document.getElementById('h2h_rank_comp').innerText = compM.rank.toFixed(1);

        document.getElementById('h2h_deal_us').innerText = usM.deals;
        document.getElementById('h2h_deal_comp').innerText = compM.deals;

        // Draw Interactive Chart (Column: Share comparison)
        const data = google.visualization.arrayToDataTable([
            ['Metric', 'Us', comp],
            ['Click Share (%)', usM.share*100, compM.share*100],
            ['Avg Price ($)', usM.price/2, compM.price/2] // Scaled for visual
        ]);

        const options = {
            colors: ['#4285F4', '#EA4335'],
            chartArea: { width: '80%', height: '70%' },
            vAxis: { textPosition: 'none' }, // Hiding scale as units differ
            bar: { groupWidth: '50%' }
        };

        new google.visualization.ColumnChart(document.getElementById('chart_interactive')).draw(data, options);
    }

</script>

</body>
</html>