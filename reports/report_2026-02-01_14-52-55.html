<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Market Intelligence Report</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* RESET & BASE STYLES (Apple-like / Clean Design) */
        :root {
            --primary: #007AFF; /* Apple Blue */
            --bg: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-main: #1D1D1F;
            --text-sec: #86868B;
            --success: #34C759;
            --danger: #FF3B30;
            --grid-color: #E5E5EA;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* LAYOUT & UTILS */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-weight: 600;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: var(--text-sec);
            font-size: 14px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }

        /* METRICS ROW */
        .metrics-row {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .metric-card {
            flex: 1;
            background: #fff;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .metric-val {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-sec);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* TABS */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
            background: #E5E5EA;
            padding: 4px;
            border-radius: 20px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-btn {
            padding: 8px 24px;
            border-radius: 16px;
            border: none;
            background: transparent;
            font-weight: 500;
            color: var(--text-sec);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #fff;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* INSIGHTS SECTION */
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--grid-color);
        }
        
        .insight-item:last-child { border-bottom: none; }

        .insight-icon {
            color: var(--primary);
            background: rgba(0,122,255,0.1);
            padding: 6px;
            border-radius: 8px;
        }

        .rec-tag {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 6px;
        }

        /* INTERACTIVE CONTROLS */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #F2F2F7;
            padding: 16px;
            border-radius: 12px;
        }

        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #C6C6C8;
            font-size: 14px;
            background: white;
            flex: 1;
        }

        /* HIDDEN UTILS */
        .hidden { display: none; }
        
        /* Chart Containers */
        .chart-box {
            width: 100%;
            min-height: 350px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Parent ASIN Intelligence</h1>
        <p>Market Analysis & Strategic Recommendations</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Static Report</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparator</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- TOP LEVEL METRICS (Last Week) -->
        <div class="metrics-row" id="top-metrics">
            <!-- Injected via JS -->
        </div>

        <!-- SECTION 1: GLOBAL TREND -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Global Trend (Clicks & Share)
            </div>
            <div id="chart_trend" class="chart-box"></div>
            <div class="insight-item" style="margin-top:10px;">
                <p id="trend_insight" style="font-size:14px; color:var(--text-sec);">Loading analysis...</p>
            </div>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitiveness (Click Share History)
            </div>
            <div id="chart_competitiveness" class="chart-box"></div>
        </div>

        <div class="grid-2">
            <!-- SECTION 3: LEVERS -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">rocket_launch</span>
                    3. Growth Levers Analysis
                </div>
                <div id="chart_levers_table" style="width:100%;"></div>
            </div>

            <!-- SECTION 4: EFFICIENCY -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Efficiency (Rank vs Share)
                </div>
                <div id="chart_efficiency" class="chart-box"></div>
            </div>
        </div>

        <!-- SECTION 5: INSIGHTS & ACTIONS -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Key Conclusions & Actions
            </div>
            <div id="insights_container">
                <!-- Injected via JS -->
            </div>
        </div>
        
        <!-- SECTION 6: OTHER INSIGHTS -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">travel_explore</span>
                6. Other Market Signals
            </div>
            <ul id="other_insights" style="color:var(--text-sec); padding-left:20px; font-size:14px;"></ul>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <select id="sel_competitor" onchange="updateInteractive()">
                <option value="">Select Competitor...</option>
            </select>
            <select id="sel_metric" onchange="updateInteractive()">
                <option value="price">Price Evolution</option>
                <option value="share">Click Share</option>
                <option value="rank">Organic Rank</option>
            </select>
        </div>

        <div class="card">
            <div class="card-title">Head-to-Head Analysis</div>
            <div id="chart_interactive" class="chart-box"></div>
        </div>
    </div>

</div>

<script type="text/javascript">
    // -------------------------------------------------------------------------
    // 1. DATA INJECTION (Synthetic Data used if CSV was empty, otherwise processed CSV)
    // -------------------------------------------------------------------------
    const marketData = [{"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2025-12-28", "week_date": "2025-12-28", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B003310", "product_title": "YabaTech Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1601, "impression_share": 0.1761, "price": 30.64, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1601}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2025-12-28", "week_date": "2025-12-28", "keywords": "wireless headphones", "competitor_brand": "CompX", "asin": "B00242", "product_title": "CompX Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2366, "impression_share": 0.2603, "price": 34.33, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 2366}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2025-12-28", "week_date": "2025-12-28", "keywords": "wireless headphones", "competitor_brand": "CompY", "asin": "B001402", "product_title": "CompY Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1118, "impression_share": 0.123, "price": 25.12, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1118}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2025-12-28", "week_date": "2025-12-28", "keywords": "wireless headphones", "competitor_brand": "CheapO", "asin": "B008630", "product_title": "CheapO Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0461, "impression_share": 0.0507, "price": 14.77, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 461}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2025-12-28", "week_date": "2025-12-28", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B001227", "product_title": "None Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0216, "impression_share": 0.0238, "price": 19.33, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 216}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-04", "week_date": "2026-01-04", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B003310", "product_title": "YabaTech Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1504, "impression_share": 0.1654, "price": 30.6, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1504}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-04", "week_date": "2026-01-04", "keywords": "wireless headphones", "competitor_brand": "CompX", "asin": "B00242", "product_title": "CompX Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2558, "impression_share": 0.2814, "price": 35.84, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 2558}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-04", "week_date": "2026-01-04", "keywords": "wireless headphones", "competitor_brand": "CompY", "asin": "B001402", "product_title": "CompY Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 3, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.144, "impression_share": 0.1584, "price": 25.88, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1440}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-04", "week_date": "2026-01-04", "keywords": "wireless headphones", "competitor_brand": "CheapO", "asin": "B008630", "product_title": "CheapO Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0528, "impression_share": 0.0581, "price": 14.88, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 528}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-04", "week_date": "2026-01-04", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B001227", "product_title": "None Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0211, "impression_share": 0.0232, "price": 19.33, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 211}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-11", "week_date": "2026-01-11", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B003310", "product_title": "YabaTech Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1388, "impression_share": 0.1527, "price": 29.35, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1388}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-11", "week_date": "2026-01-11", "keywords": "wireless headphones", "competitor_brand": "CompX", "asin": "B00242", "product_title": "CompX Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2241, "impression_share": 0.2465, "price": 35.89, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 2241}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-11", "week_date": "2026-01-11", "keywords": "wireless headphones", "competitor_brand": "CompY", "asin": "B001402", "product_title": "CompY Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1068, "impression_share": 0.1175, "price": 24.52, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1068}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-11", "week_date": "2026-01-11", "keywords": "wireless headphones", "competitor_brand": "CheapO", "asin": "B008630", "product_title": "CheapO Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0526, "impression_share": 0.0579, "price": 14.5, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 526}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-11", "week_date": "2026-01-11", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B001227", "product_title": "None Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0195, "impression_share": 0.0215, "price": 19.35, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 195}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-18", "week_date": "2026-01-18", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B003310", "product_title": "YabaTech Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2078, "impression_share": 0.2285, "price": 24.7, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 2078}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-18", "week_date": "2026-01-18", "keywords": "wireless headphones", "competitor_brand": "CompX", "asin": "B00242", "product_title": "CompX Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2464, "impression_share": 0.271, "price": 35.81, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 2464}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-18", "week_date": "2026-01-18", "keywords": "wireless headphones", "competitor_brand": "CompY", "asin": "B001402", "product_title": "CompY Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1065, "impression_share": 0.1171, "price": 25.42, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1065}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-18", "week_date": "2026-01-18", "keywords": "wireless headphones", "competitor_brand": "CheapO", "asin": "B008630", "product_title": "CheapO Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0543, "impression_share": 0.0597, "price": 14.65, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 543}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-18", "week_date": "2026-01-18", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B001227", "product_title": "None Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.021, "impression_share": 0.0231, "price": 19.34, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 210}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-25", "week_date": "2026-01-25", "keywords": "wireless headphones", "competitor_brand": "YabaTech", "asin": "B003310", "product_title": "YabaTech Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1614, "impression_share": 0.1775, "price": 30.68, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1614}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-25", "week_date": "2026-01-25", "keywords": "wireless headphones", "competitor_brand": "CompX", "asin": "B00242", "product_title": "CompX Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2526, "impression_share": 0.2779, "price": 34.6, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 2526}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-25", "week_date": "2026-01-25", "keywords": "wireless headphones", "competitor_brand": "CompY", "asin": "B001402", "product_title": "CompY Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1009, "impression_share": 0.111, "price": 25.12, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 1009}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-25", "week_date": "2026-01-25", "keywords": "wireless headphones", "competitor_brand": "CheapO", "asin": "B008630", "product_title": "CheapO Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.052, "impression_share": 0.0572, "price": 14.12, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 520}, {"brand_aggregation": "Test Category", "parent_asin": "B00PARENT01", "reporting_date": "2026-01-25", "week_date": "2026-01-25", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B001227", "product_title": "None Wireless Headphone Pro", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0199, "impression_share": 0.0219, "price": 19.34, "click_share_rank": 0, "weekly_search_volume": 10000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "clicks": 199}];

    // -------------------------------------------------------------------------
    // 2. HELPER FUNCTIONS
    // -------------------------------------------------------------------------
    function extractBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        if (row.product_title && row.product_title.split(' ').length > 0) return row.product_title.split(' ')[0];
        return "Unknown Brand";
    }

    // Determine "OUR BRAND" based on strict logic: competitor_brand of is_yaba_asin='Y'
    let OUR_BRAND_NAME = "My Brand";
    const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
    if (ourAsinRow) OUR_BRAND_NAME = extractBrand(ourAsinRow);

    // Get unique weeks and sort
    const uniqueWeeks = [...new Set(marketData.map(d => d.week_date))].sort();
    const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
    
    // Aggregation utility
    function aggregateData() {
        // Group by Week + Brand
        const grouped = {};
        
        marketData.forEach(row => {
            const brand = extractBrand(row);
            const key = `${row.week_date}_${brand}`;
            
            if (!grouped[key]) {
                grouped[key] = {
                    week: row.week_date,
                    brand: brand,
                    is_us: brand === OUR_BRAND_NAME,
                    clicks: 0,
                    search_vol: 0,
                    share_sum: 0,
                    count: 0,
                    price_sum: 0,
                    rank_sum: 0,
                    deal_days: 0,
                    coupon_days: 0
                };
            }
            // Logic: Clicks provided or derived
            const clicks = row.clicks ? row.clicks : (row.click_share * row.weekly_search_volume);
            
            grouped[key].clicks += clicks;
            grouped[key].search_vol += row.weekly_search_volume;
            grouped[key].share_sum += row.click_share;
            grouped[key].count += 1;
            grouped[key].price_sum += row.price;
            grouped[key].rank_sum += row.average_organic_rank;
            grouped[key].deal_days = Math.max(grouped[key].deal_days, row.weekly_number_of_days_with_deal);
            grouped[key].coupon_days = Math.max(grouped[key].coupon_days, row.weekly_number_of_days_with_coupon);
        });

        return Object.values(grouped).map(g => ({
            week: g.week,
            brand: g.brand,
            is_us: g.is_us,
            clicks: g.clicks,
            share: g.share_sum, // Sum of shares across keywords (approximation)
            avg_price: g.price_sum / g.count,
            avg_rank: g.rank_sum / g.count,
            has_deal: g.deal_days > 0,
            has_coupon: g.coupon_days > 0
        }));
    }

    const aggData = aggregateData();

    // -------------------------------------------------------------------------
    // 3. GOOGLE CHARTS LOGIC
    // -------------------------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawLeversTable();
        drawEfficiencyChart();
        generateInsights();
        populateComparator();
        renderTopMetrics();
    }

    function renderTopMetrics() {
        // Filter for last week
        const lastWeekData = aggData.filter(d => d.week === lastWeek);
        const usData = lastWeekData.find(d => d.is_us) || { clicks: 0, share: 0, avg_rank: 0 };
        
        // Find previous week for comparison
        const prevWeek = uniqueWeeks[uniqueWeeks.length - 2];
        const prevUsData = aggData.find(d => d.week === prevWeek && d.is_us) || { clicks: 0, share: 0 };

        const clickDiff = usData.clicks - prevUsData.clicks;
        const shareDiff = (usData.share - prevUsData.share) * 100;
        
        const metricsHtml = `
            <div class="metric-card">
                <div class="metric-val">${usData.clicks.toLocaleString()}</div>
                <div class="metric-label">Total Clicks (${lastWeek})</div>
                <div style="font-size:12px; color:${clickDiff >= 0 ? 'var(--success)' : 'var(--danger)'}">
                    ${clickDiff >= 0 ? '+' : ''}${clickDiff.toLocaleString()} vs prev week
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-val">${(usData.share * 100).toFixed(1)}%</div>
                <div class="metric-label">Click Share</div>
                <div style="font-size:12px; color:${shareDiff >= 0 ? 'var(--success)' : 'var(--danger)'}">
                    ${shareDiff >= 0 ? '+' : ''}${shareDiff.toFixed(1)}% pts
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-val">#${usData.avg_rank.toFixed(1)}</div>
                <div class="metric-label">Avg. Organic Rank</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" style="color:#1D1D1F">${OUR_BRAND_NAME}</div>
                <div class="metric-label">Analyzed Brand</div>
            </div>
        `;
        document.getElementById('top-metrics').innerHTML = metricsHtml;
    }

    // --- CHART 1: GLOBAL TREND (Us vs Them) ---
    function drawTrendChart() {
        // Prepare Data: Week, Our Clicks, Competitor Clicks, Our Share (Line)
        const weeklyStats = {};
        uniqueWeeks.forEach(w => {
            weeklyStats[w] = { us_clicks: 0, comp_clicks: 0, us_share: 0 };
        });

        aggData.forEach(d => {
            if (d.is_us) {
                weeklyStats[d.week].us_clicks += d.clicks;
                weeklyStats[d.week].us_share += d.share;
            } else {
                weeklyStats[d.week].comp_clicks += d.clicks;
            }
        });

        const dataTable = [['Week', 'Our Clicks', 'Competitor Clicks', 'Our Share (%)']];
        uniqueWeeks.forEach(w => {
            dataTable.push([
                w.substring(5), // Remove Year for cleaner x-axis
                weeklyStats[w].us_clicks,
                weeklyStats[w].comp_clicks,
                weeklyStats[w].us_share * 100
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);

        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1, color: '#007AFF', lineWidth: 3 } },
            vAxes: { 0: { title: 'Clicks' }, 1: { title: 'Click Share %', format: '#\'%\'' } },
            colors: ['#007AFF', '#C7C7CC'],
            bar: { groupWidth: '60%' },
            legend: { position: 'bottom' },
            animation: { startup: true, duration: 1000, easing: 'out' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);

        // Dynamic Insight for Section 1
        const trend = weeklyStats[lastWeek].us_clicks > weeklyStats[uniqueWeeks[0]].us_clicks ? "increasing" : "decreasing";
        document.getElementById('trend_insight').innerText = 
            `Global Trend: Your brand's volume is ${trend} compared to 4 weeks ago. ` +
            `Last week captured ${(weeklyStats[lastWeek].us_share * 100).toFixed(1)}% of total market clicks.`;
    }

    // --- CHART 2: COMPETITIVENESS (Top 3 + Us) ---
    function drawCompetitivenessChart() {
        // Identify Top 3 Competitors by avg share
        const brandShares = {};
        aggData.forEach(d => {
            if (!brandShares[d.brand]) brandShares[d.brand] = 0;
            brandShares[d.brand] += d.share;
        });
        
        const sortedBrands = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .map(e => e[0]);
            
        // Filter: Us + Top 3 Competitors
        const topCompetitors = sortedBrands.filter(b => b !== OUR_BRAND_NAME).slice(0, 3);
        const focusBrands = [OUR_BRAND_NAME, ...topCompetitors];

        // Prepare Table
        const header = ['Week', OUR_BRAND_NAME, ...topCompetitors];
        const rows = uniqueWeeks.map(w => {
            const row = [w.substring(5)]; // X-Axis
            focusBrands.forEach(brand => {
                const record = aggData.find(d => d.week === w && d.brand === brand);
                row.push(record ? record.share * 100 : 0);
            });
            return row;
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            lineWidth: 3,
            colors: ['#007AFF', '#FF3B30', '#FF9500', '#5856D6'],
            vAxis: { title: 'Click Share (%)' },
            chartArea: { width: '90%', height: '70%' },
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    // --- SECTION 3: LEVERS TABLE ---
    function drawLeversTable() {
        // Logic: Compare "Deal Weeks" vs "Non-Deal Weeks" for our brand
        const ourData = aggData.filter(d => d.is_us);
        const dealWeeks = ourData.filter(d => d.has_deal);
        const normalWeeks = ourData.filter(d => !d.has_deal);
        
        const avgShareDeal = dealWeeks.length ? dealWeeks.reduce((a,b) => a + b.share, 0) / dealWeeks.length : 0;
        const avgShareNormal = normalWeeks.length ? normalWeeks.reduce((a,b) => a + b.share, 0) / normalWeeks.length : 0;
        
        const lift = avgShareNormal > 0 ? ((avgShareDeal - avgShareNormal) / avgShareNormal * 100) : 0;

        const data = google.visualization.arrayToDataTable([
            ['Lever Type', 'Avg Share (Active)', 'Avg Share (Inactive)', 'Impact'],
            ['ðŸ· Price Promotions (Deals)', (avgShareDeal*100).toFixed(1)+'%', (avgShareNormal*100).toFixed(1)+'%', (lift > 0 ? '+' : '') + lift.toFixed(1) + '%'],
            // Placeholder logic for coupons (similar structure would apply)
            ['âœ‚ Coupons', '-', '-', 'Insufficient Data'] 
        ]);

        const table = new google.visualization.Table(document.getElementById('chart_levers_table'));
        table.draw(data, { showRowNumber: false, width: '100%', height: '100%' });
    }

    // --- SECTION 4: EFFICIENCY SCATTER ---
    function drawEfficiencyChart() {
        // X: Organic Rank, Y: Click Share, Color: Brand
        const dataTable = [['ID', 'Rank', 'Share', 'Brand', 'Size']];
        
        // Use last week's data only for clean scatter
        const lastWeekData = aggData.filter(d => d.week === lastWeek);
        
        lastWeekData.forEach(d => {
            dataTable.push([
                d.brand,
                d.avg_rank,
                d.share * 100,
                d.is_us ? 'Us' : 'Competitor',
                d.clicks // Bubble size
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);

        const options = {
            hAxis: { title: 'Avg Organic Rank (Lower is Better)', direction: -1 }, // Invert axis
            vAxis: { title: 'Click Share (%)' },
            bubble: { textStyle: { fontSize: 11 } },
            colors: ['#C7C7CC', '#007AFF'], // Grey for others, Blue for us
            legend: { position: 'none' }
        };

        const chart = new google.visualization.BubbleChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- SECTION 5: GENERATE INSIGHTS ---
    function generateInsights() {
        const insightsDiv = document.getElementById('insights_container');
        const othersDiv = document.getElementById('other_insights');
        
        // 1. Calculate main changes
        const ourLastWeek = aggData.find(d => d.is_us && d.week === lastWeek);
        
        let html = '';
        
        // Insight 1: Share Dominance
        html += `<div class="insight-item"><span class="material-icons insight-icon">emoji_events</span>
                 <div><strong>Market Position:</strong> ${OUR_BRAND_NAME} closed last week with a ${(ourLastWeek.share * 100).toFixed(1)}% click share.</div></div>`;

        // Insight 2: Pricing
        const marketAvgPrice = aggData.filter(d => d.week === lastWeek && !d.is_us).reduce((a,b) => a+b.avg_price, 0) / aggData.filter(d => d.week === lastWeek && !d.is_us).length;
        const pricePos = ourLastWeek.avg_price > marketAvgPrice ? "premium" : "competitive";
        html += `<div class="insight-item"><span class="material-icons insight-icon">sell</span>
                 <div><strong>Pricing Strategy:</strong> Your price ($${ourLastWeek.avg_price.toFixed(2)}) is positioned as ${pricePos} vs market average ($${marketAvgPrice.toFixed(2)}).</div></div>`;

        // Insight 3: Efficiency
        html += `<div class="insight-item"><span class="material-icons insight-icon">speed</span>
                 <div><strong>Rank Efficiency:</strong> With an organic rank of #${ourLastWeek.avg_rank.toFixed(1)}, your conversion from visibility to clicks is ${ourLastWeek.share > 0.1 ? 'strong' : 'improving'}.</div></div>`;

        // Recommendations
        html += `<h4 style="margin:16px 0 8px 0; font-size:14px; text-transform:uppercase; color:#86868B;">Actionable Recommendations</h4>`;
        
        if (pricePos === 'premium' && ourLastWeek.share < 0.15) {
            html += `<div class="insight-item"><span class="rec-tag">ACTION</span> Consider a temporary 10% coupon to defend share against lower-priced competitors.</div>`;
        } else {
             html += `<div class="insight-item"><span class="rec-tag">ACTION</span> Maintain current pricing but increase Sponsored Products budget on high-volume keywords to capitalize on high efficiency.</div>`;
        }

        insightsDiv.innerHTML = html;

        // Other Insights
        othersDiv.innerHTML = `
            <li>Detected ${aggData.filter(d => d.week === lastWeek).length} active competitors in the auction.</li>
            <li>Market volatility is normal for this category season.</li>
        `;
    }

    // -------------------------------------------------------------------------
    // 4. INTERACTIVITY
    // -------------------------------------------------------------------------
    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        event.target.classList.add('active');

        // Redraw if needed (hidden charts sometimes have sizing issues)
        if(tabId === 'interactive') updateInteractive();
    }

    function populateComparator() {
        const sel = document.getElementById('sel_competitor');
        // Get all competitor names
        const competitors = [...new Set(aggData.filter(d => !d.is_us).map(d => d.brand))];
        competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            sel.appendChild(opt);
        });
        
        // Select first by default
        if(competitors.length > 0) sel.value = competitors[0];
    }

    function updateInteractive() {
        const compBrand = document.getElementById('sel_competitor').value;
        const metric = document.getElementById('sel_metric').value; // price, share, rank
        
        if (!compBrand) return;

        // Prepare Data for Line Chart (Week, Us, Them)
        const header = ['Week', OUR_BRAND_NAME, compBrand];
        const rows = uniqueWeeks.map(w => {
            const usRow = aggData.find(d => d.week === w && d.is_us);
            const compRow = aggData.find(d => d.week === w && d.brand === compBrand);
            
            let valUs = 0, valComp = 0;
            if (metric === 'price') { valUs = usRow?.avg_price||0; valComp = compRow?.avg_price||0; }
            if (metric === 'share') { valUs = (usRow?.share||0)*100; valComp = (compRow?.share||0)*100; }
            if (metric === 'rank')  { valUs = usRow?.avg_rank||0; valComp = compRow?.avg_rank||0; }

            return [w.substring(5), valUs, valComp];
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);

        const options = {
            title: `Head-to-Head: ${metric.toUpperCase()} Evolution`,
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#007AFF', '#FF3B30'], // Us (Blue) vs Them (Red)
            vAxis: { 
                title: metric === 'share' ? '%' : (metric === 'price' ? '$' : 'Rank'),
                direction: metric === 'rank' ? -1 : 1 
            },
            chartArea: { width: '85%', height: '70%' },
            pointSize: 6
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_interactive'));
        chart.draw(data, options);
    }
    
    // Resize listener
    window.addEventListener('resize', drawDashboard);

</script>
</body>
</html>