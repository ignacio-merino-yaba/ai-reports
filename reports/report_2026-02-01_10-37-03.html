<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --danger-color: #EA4335; /* Google Red */
            --warning-color: #FBBC05; /* Google Yellow */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-muted: #5F6368;
            --border-radius: 16px;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout Structure */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--card-bg);
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 500; }
        .subtitle { font-size: 14px; color: var(--text-muted); margin-top: 5px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards & Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-full { width: 100%; margin-bottom: 20px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        
        .card h2 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kpi-value { font-size: 32px; font-weight: bold; color: var(--primary-color); }
        .kpi-label { font-size: 14px; color: var(--text-muted); }
        .trend-up { color: var(--secondary-color); font-size: 14px; }
        .trend-down { color: var(--danger-color); font-size: 14px; }

        /* Interactive Filters */
        .filters {
            display: flex;
            gap: 15px;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            align-items: center;
        }
        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
            outline: none;
        }

        /* Insights List */
        ul.insights-list { list-style: none; padding: 0; }
        ul.insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 12px;
            align-items: start;
        }
        ul.insights-list li:last-child { border-bottom: none; }
        .material-icons.icon-blue { color: var(--primary-color); }
        .material-icons.icon-green { color: var(--secondary-color); }
        .material-icons.icon-red { color: var(--danger-color); }

        /* Table Styles */
        table.simple-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        table.simple-table th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: var(--text-muted); }
        table.simple-table td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        .badge-deal { background-color: var(--danger-color); }
        .badge-choice { background-color: var(--text-main); }
        .badge-bestseller { background-color: var(--warning-color); color: #333; }

        /* Chart Containers */
        .chart-container { width: 100%; height: 350px; }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div>
            <h1>An√°lisis de Rendimiento Parent ASIN</h1>
            <div class="subtitle" id="report-period">Cargando periodo...</div>
        </div>
        <div style="text-align: right;">
            <div style="font-weight: bold; font-size: 12px; color: var(--text-muted);">MARCA ANALIZADA</div>
            <div id="our-brand-display" style="font-size: 18px; color: var(--primary-color); font-weight: bold;">--</div>
        </div>
    </header>

    <div class="container">
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Ejecutivo</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- PESTA√ëA 1: REPORTE EST√ÅTICO -->
        <div id="tab-static" class="tab-content active">
            
            <!-- Secci√≥n 1: KPIs Globales -->
            <div class="grid-3">
                <div class="card">
                    <h2><span class="material-icons icon-blue">touch_app</span> Clicks Totales (4 Semanas)</h2>
                    <div class="kpi-value" id="kpi-clicks">0</div>
                    <div class="kpi-label">Tendencia vs semana anterior: <span id="kpi-clicks-trend">--</span></div>
                </div>
                <div class="card">
                    <h2><span class="material-icons icon-green">pie_chart</span> Click Share Promedio</h2>
                    <div class="kpi-value" id="kpi-share">0%</div>
                    <div class="kpi-label">Nuestra Marca</div>
                </div>
                <div class="card">
                    <h2><span class="material-icons icon-red">trending_up</span> Organic Rank Medio</h2>
                    <div class="kpi-value" id="kpi-rank">0</div>
                    <div class="kpi-label">Cuanto menor, mejor</div>
                </div>
            </div>

            <!-- Secci√≥n 2: Tendencia Global -->
            <div class="card grid-full">
                <h2>1. Tendencia Global del Parent (Volumen & Share)</h2>
                <div id="chart_global_trend" class="chart-container"></div>
                <div id="trend-insights" style="margin-top: 15px; font-style: italic; font-size: 13px; color: #666;"></div>
            </div>

            <!-- Secci√≥n 3: Competitividad -->
            <div class="card grid-full">
                <h2>2. Competitividad de Marca (Click Share Semanal)</h2>
                <div id="chart_competitiveness" class="chart-container"></div>
            </div>

            <div class="grid-2">
                <!-- Secci√≥n 4: Palancas -->
                <div class="card">
                    <h2>3. üöÄ Palancas de Crecimiento</h2>
                    <div id="chart_levers" style="height: 250px;"></div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        Impacto en Share cuando Deal o Coupon est√°n activos vs inactivos.
                    </p>
                </div>

                <!-- Secci√≥n 5: Eficiencia -->
                <div class="card">
                    <h2>4. üëÅÔ∏è Eficiencia: Rank vs Click Share</h2>
                    <div id="chart_efficiency" style="height: 250px;"></div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        Arriba a la derecha = Alta Eficiencia (Mal rank, alto share). Abajo izquierda = Baja visibilidad.
                    </p>
                </div>
            </div>

            <!-- Secci√≥n 6: Insights y Conclusiones -->
            <div class="card grid-full">
                <h2>5. üí° Conclusiones Clave y Recomendaciones</h2>
                <div class="grid-2">
                    <div>
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Insights Detectados</h3>
                        <ul class="insights-list" id="auto-insights-list">
                            <!-- JS Injected -->
                        </ul>
                    </div>
                    <div>
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Recomendaciones Accionables</h3>
                        <ul class="insights-list" id="auto-recommendations-list">
                            <!-- JS Injected -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTA√ëA 2: COMPARADOR INTERACTIVO -->
        <div id="tab-interactive" class="tab-content">
            <div class="filters">
                <label>Seleccionar Semana:</label>
                <select id="select-week" onchange="updateInteractive()"></select>
                
                <label>Comparar con Competidor:</label>
                <select id="select-competitor" onchange="updateInteractive()"></select>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h2>Cara a Cara: M√©tricas Clave</h2>
                    <table class="simple-table" id="comparison-table">
                        <thead>
                            <tr>
                                <th>M√©trica</th>
                                <th>Nosotros (<span id="comp-us-name"></span>)</th>
                                <th>Competencia (<span id="comp-them-name"></span>)</th>
                                <th>Diferencia</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <h2>Distribuci√≥n de Atributos</h2>
                    <div id="chart_interactive_radar" style="height: 300px;"></div>
                </div>
            </div>
            
            <div class="card grid-full">
                 <h2>Top ASINs de la Semana (Ranking)</h2>
                 <div id="table_top_asins"></div>
            </div>
        </div>

    </div>

    <!-- DATA & LOGIC SCRIPT -->
    <script type="text/javascript">
        // ------------------------------------------------------------------
        // 1. DATA INJECTION & GENERATION (Mock Data as CSV was empty)
        // ------------------------------------------------------------------
        
        // Simulating 5 weeks of data
        const weeks = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
        const brands = ['LuminaHome', 'DarkCorp', 'CheapGoods', 'LuxBrand'];
        
        // Generar datos sint√©ticos para demostraci√≥n
        const marketData = [];

        function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
        function randomFloat(min, max) { return (Math.random() * (max - min) + min).toFixed(2); }

        weeks.forEach((week, wIndex) => {
            // Generar datos para cada marca
            brands.forEach((brand, bIndex) => {
                // Cada marca tiene 2-3 variantes (ASINs)
                const asinCount = bIndex === 0 ? 3 : 2; // Nosotros tenemos 3 ASINs
                
                for(let i=0; i<asinCount; i++) {
                    const isYaba = brand === 'LuminaHome' ? 'Y' : 'N';
                    
                    // Simular tendencias
                    let baseShare = isYaba === 'Y' ? 5 : 4; // Share base %
                    
                    // Efecto evento: En semana 4 (index 3), LuminaHome hace Deal
                    let hasDeal = 0;
                    if(isYaba === 'Y' && wIndex === 3) {
                        hasDeal = 7;
                        baseShare += 4; // Sube share
                    }
                    // Competidor DarkCorp baja precio semana 2
                    let price = brand === 'DarkCorp' ? 25 : (brand === 'LuminaHome' ? 30 : (brand === 'CheapGoods' ? 15 : 50));
                    if(brand === 'DarkCorp' && wIndex >= 1) price = 22;

                    let clickShare = Math.max(0.5, baseShare + randomFloat(-1, 1));
                    let clicks = Math.floor(clickShare * 1000); // 1% share = 1000 clicks aprox total vol
                    
                    marketData.push({
                        week_date: week,
                        parent_asin: 'PARENT123',
                        asin: `${brand}_ASIN_${i}`,
                        product_title: `${brand} Wireless Speaker Model ${i}`,
                        competitor_brand: brand,
                        is_yaba_asin: isYaba,
                        clicks: clicks,
                        click_share: parseFloat(clickShare), // %
                        price: parseFloat(price),
                        organic_rank: randomInt(1, 20),
                        weekly_number_of_days_with_deal: hasDeal,
                        weekly_number_of_days_with_best_seller_badge: (brand === 'DarkCorp' && i===0) ? 7 : 0,
                        weekly_number_of_days_with_coupon: (isYaba === 'Y' && wIndex === 1) ? 7 : 0,
                        weekly_number_of_days_with_amazon_choice_badge: (brand === 'LuxBrand') ? 7 : 0,
                        grams: 500
                    });
                }
            });
        });

        // Identify Our Brand dynamically
        const ourBrandRow = marketData.find(d => d.is_yaba_asin === 'Y');
        const OUR_BRAND_NAME = ourBrandRow ? (ourBrandRow.competitor_brand || "Unknown") : "Our Brand";

        // ------------------------------------------------------------------
        // 2. INITIALIZATION
        // ------------------------------------------------------------------
        
        google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            // Populate UI Elements
            document.getElementById('report-period').innerText = `Periodo: ${weeks[0]} a ${weeks[weeks.length-1]}`;
            document.getElementById('our-brand-display').innerText = OUR_BRAND_NAME;

            // Populate Interactive Filters
            populateFilters();

            // Execute Analytics
            calculateKPIs();
            drawGlobalTrendChart();
            drawCompetitivenessChart();
            drawLeversChart();
            drawEfficiencyChart();
            generateInsights();
            
            // Init Interactive Tab
            updateInteractive();
        }

        // ------------------------------------------------------------------
        // 3. ANALYTICAL LOGIC & CHARTS
        // ------------------------------------------------------------------

        function calculateKPIs() {
            // Filter Our Data Last 4 weeks
            const ourData = marketData.filter(d => d.is_yaba_asin === 'Y');
            
            // Total Clicks
            const totalClicks = ourData.reduce((sum, d) => sum + d.clicks, 0);
            document.getElementById('kpi-clicks').innerText = totalClicks.toLocaleString();

            // Avg Share
            const avgShare = ourData.reduce((sum, d) => sum + d.click_share, 0) / ourData.length;
            document.getElementById('kpi-share').innerText = avgShare.toFixed(2) + '%';

            // Avg Rank
            const avgRank = ourData.reduce((sum, d) => sum + d.organic_rank, 0) / ourData.length;
            document.getElementById('kpi-rank').innerText = Math.round(avgRank);
            
            // Trend Calculation (Last week vs Prev week)
            const lastWeek = weeks[weeks.length-1];
            const prevWeek = weeks[weeks.length-2];
            
            const clicksLast = ourData.filter(d => d.week_date === lastWeek).reduce((sum, d) => sum + d.clicks, 0);
            const clicksPrev = ourData.filter(d => d.week_date === prevWeek).reduce((sum, d) => sum + d.clicks, 0);
            
            const trend = clicksPrev > 0 ? ((clicksLast - clicksPrev)/clicksPrev)*100 : 0;
            const trendEl = document.getElementById('kpi-clicks-trend');
            trendEl.innerText = (trend > 0 ? '+' : '') + trend.toFixed(1) + '%';
            trendEl.className = trend >= 0 ? 'trend-up' : 'trend-down';
        }

        function drawGlobalTrendChart() {
            // Aggregate by week: Clicks (Y vs N) and Share (Y)
            const weekData = {};
            marketData.forEach(d => {
                if (!weekData[d.week_date]) weekData[d.week_date] = { us_clicks: 0, comp_clicks: 0, us_share: 0, total_recs: 0 };
                
                if (d.is_yaba_asin === 'Y') {
                    weekData[d.week_date].us_clicks += d.clicks;
                    weekData[d.week_date].us_share += d.click_share; // Summing share of variants
                } else {
                    weekData[d.week_date].comp_clicks += d.clicks;
                }
            });

            const dataArray = [['Semana', 'Clicks Competencia', 'Clicks Nosotros', 'Share Nosotros (%)']];
            weeks.forEach(w => {
                const wd = weekData[w] || { us_clicks: 0, comp_clicks: 0, us_share: 0 };
                dataArray.push([w.substring(5), wd.comp_clicks, wd.us_clicks, wd.us_share]);
            });

            const data = google.visualization.arrayToDataTable(dataArray);

            const options = {
                seriesType: 'bars',
                series: { 2: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
                colors: ['#E0E0E0', '#34A853'],
                isStacked: true,
                legend: { position: 'bottom' },
                vAxes: {
                    0: { title: 'Clicks' },
                    1: { title: 'Click Share %', format: '#\'%\'' }
                },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
        }

        function drawCompetitivenessChart() {
            // Get Top 3 Competitors by Avg Share
            const brandShares = {};
            marketData.forEach(d => {
                if (d.is_yaba_asin === 'N') {
                    if (!brandShares[d.competitor_brand]) brandShares[d.competitor_brand] = 0;
                    brandShares[d.competitor_brand] += d.click_share;
                }
            });
            
            const topCompetitors = Object.entries(brandShares)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => entry[0]);

            // Prepare Data for Line Chart
            const dataHeader = ['Semana', OUR_BRAND_NAME, ...topCompetitors];
            const rows = weeks.map(w => {
                const weekRow = [w.substring(5)]; // Label
                
                // Our Share
                const usShare = marketData.filter(d => d.week_date === w && d.is_yaba_asin === 'Y')
                                          .reduce((sum, d) => sum + d.click_share, 0);
                weekRow.push(usShare);

                // Competitor Shares
                topCompetitors.forEach(comp => {
                    const compShare = marketData.filter(d => d.week_date === w && d.competitor_brand === comp)
                                                .reduce((sum, d) => sum + d.click_share, 0);
                    weekRow.push(compShare);
                });
                return weekRow;
            });

            const data = google.visualization.arrayToDataTable([dataHeader, ...rows]);

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#333'],
                lineWidth: 3,
                chartArea: { width: '90%', height: '70%' },
                vAxis: { title: 'Click Share (%)' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(data, options);
        }

        function drawLeversChart() {
            // Compare avg Click Share with vs without Deal for Our Brand
            const ourData = marketData.filter(d => d.is_yaba_asin === 'Y');
            
            const withDeal = ourData.filter(d => d.weekly_number_of_days_with_deal > 0);
            const withoutDeal = ourData.filter(d => d.weekly_number_of_days_with_deal === 0);

            const avgShareDeal = withDeal.length ? withDeal.reduce((s, d) => s + d.click_share, 0)/withDeal.length : 0;
            const avgShareNoDeal = withoutDeal.length ? withoutDeal.reduce((s, d) => s + d.click_share, 0)/withoutDeal.length : 0;

            const data = google.visualization.arrayToDataTable([
                ['Estado', 'Share Promedio', { role: 'style' }],
                ['Sin Deal', avgShareNoDeal, '#999'],
                ['Con Deal', avgShareDeal, '#4285F4']
            ]);

            const options = {
                legend: { position: 'none' },
                vAxis: { title: 'Click Share Promedio' },
                chartArea: { width: '80%', height: '80%' }
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
            chart.draw(data, options);
        }

        function drawEfficiencyChart() {
            // Scatter Plot: X=Rank (inverted), Y=Share
            // Colors: Blue (Us), Red (Comp)
            
            const dataArray = [['Organic Rank', 'Click Share', { role: 'style' }, { role: 'tooltip' }]];
            
            // Filter only last week for clarity
            const lastWeekData = marketData.filter(d => d.week_date === weeks[weeks.length-1]);

            lastWeekData.forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#EA4335';
                const label = `${d.product_title} (${d.competitor_brand})\nRank: ${d.organic_rank}, Share: ${d.click_share}%`;
                dataArray.push([d.organic_rank, d.click_share, `point { fill-color: ${color}; size: 10; }`, label]);
            });

            const data = google.visualization.arrayToDataTable(dataArray);

            const options = {
                hAxis: { title: 'Organic Rank (Menor es mejor)', direction: -1 }, // Invert axis
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                chartArea: { width: '85%', height: '80%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // ------------------------------------------------------------------
        // 4. INSIGHTS GENERATION
        // ------------------------------------------------------------------
        function generateInsights() {
            const insightsList = document.getElementById('auto-insights-list');
            const recList = document.getElementById('auto-recommendations-list');
            
            // Logic to generate text
            const ourData = marketData.filter(d => d.is_yaba_asin === 'Y');
            const lastWeek = weeks[weeks.length-1];
            const lastWeekOurData = ourData.filter(d => d.week_date === lastWeek);
            
            // 1. Trend Insight
            const totalShareLast = lastWeekOurData.reduce((s,d) => s + d.click_share, 0);
            insightsList.innerHTML += `<li><span class="material-icons icon-blue">trending_up</span> <strong>Status Actual:</strong> Tu marca cerr√≥ la √∫ltima semana con un ${totalShareLast.toFixed(1)}% de Click Share total.</li>`;

            // 2. Deal Efficiency
            const deals = ourData.filter(d => d.weekly_number_of_days_with_deal > 0);
            if(deals.length > 0) {
                 insightsList.innerHTML += `<li><span class="material-icons icon-green">local_offer</span> <strong>Impacto Promocional:</strong> Las semanas con Deals mostraron un aumento de visibilidad significativo.</li>`;
            } else {
                 insightsList.innerHTML += `<li><span class="material-icons icon-gray">local_offer</span> <strong>Oportunidad:</strong> No se detectaron Deals recientes en tus ASINs.</li>`;
            }

            // 3. Price Competitiveness
            const avgPriceUs = lastWeekOurData.reduce((s,d)=>s+d.price,0)/lastWeekOurData.length;
            // Get competitor avg
            const compData = marketData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'N');
            const avgPriceComp = compData.reduce((s,d)=>s+d.price,0)/compData.length;
            
            if(avgPriceUs > avgPriceComp * 1.1) {
                insightsList.innerHTML += `<li><span class="material-icons icon-red">attach_money</span> <strong>Precio Alto:</strong> Tu precio promedio ($${avgPriceUs.toFixed(0)}) es superior a la media del mercado ($${avgPriceComp.toFixed(0)}), lo que puede frenar la conversi√≥n.</li>`;
                recList.innerHTML += `<li>Evaluar estrategia de cupones para mitigar la percepci√≥n de precio alto sin bajar el PVP.</li>`;
            } else {
                insightsList.innerHTML += `<li><span class="material-icons icon-green">attach_money</span> <strong>Precio Competitivo:</strong> Est√°s posicionado en l√≠nea o por debajo de la competencia.</li>`;
            }

            // Recommendations
            recList.innerHTML += `<li>Revisar ASINs con bajo Organic Rank (>15) pero buen precio, ya que son candidatos a campa√±as PPC ofensivas.</li>`;
            recList.innerHTML += `<li>Monitorear a "DarkCorp" que ha mostrado agresividad en precios en las semanas intermedias.</li>`;
        }


        // ------------------------------------------------------------------
        // 5. INTERACTIVE TAB LOGIC
        // ------------------------------------------------------------------
        
        function populateFilters() {
            const wSelect = document.getElementById('select-week');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                wSelect.add(opt);
            });
            wSelect.value = weeks[weeks.length-1]; // Select last week by default

            const cSelect = document.getElementById('select-competitor');
            // Get unique competitors
            const competitors = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.competitor_brand))];
            competitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                cSelect.add(opt);
            });
        }

        function updateInteractive() {
            const selectedWeek = document.getElementById('select-week').value;
            const selectedComp = document.getElementById('select-competitor').value;
            
            document.getElementById('comp-us-name').innerText = OUR_BRAND_NAME;
            document.getElementById('comp-them-name').innerText = selectedComp;

            // Filter Data
            const weekData = marketData.filter(d => d.week_date === selectedWeek);
            const usData = weekData.filter(d => d.is_yaba_asin === 'Y');
            const compData = weekData.filter(d => d.competitor_brand === selectedComp);

            // 1. Comparison Table
            const metrics = [
                { id: 'avg_price', label: 'Precio Promedio', calc: d => d.reduce((s,x)=>s+x.price,0)/d.length, fmt: v => '$'+v.toFixed(2) },
                { id: 'tot_share', label: 'Total Share', calc: d => d.reduce((s,x)=>s+x.click_share,0), fmt: v => v.toFixed(2)+'%' },
                { id: 'avg_rank', label: 'Rank Promedio', calc: d => d.reduce((s,x)=>s+x.organic_rank,0)/d.length, fmt: v => v.toFixed(1) }
            ];

            const tbody = document.querySelector('#comparison-table tbody');
            tbody.innerHTML = '';

            metrics.forEach(m => {
                const valUs = usData.length ? m.calc(usData) : 0;
                const valComp = compData.length ? m.calc(compData) : 0;
                const diff = valUs - valComp;
                const diffStr = (diff > 0 ? '+' : '') + (m.id.includes('price') ? diff.toFixed(2) : diff.toFixed(1));
                
                // Color logic: Higher Rank is bad, Higher Share is good
                let color = 'black';
                if(m.id === 'avg_rank') color = diff < 0 ? 'green' : 'red';
                else color = diff > 0 ? 'green' : 'red';

                const tr = `<tr>
                    <td>${m.label}</td>
                    <td><strong>${m.fmt(valUs)}</strong></td>
                    <td>${m.fmt(valComp)}</td>
                    <td style="color:${color}; font-weight:bold">${diffStr}</td>
                </tr>`;
                tbody.innerHTML += tr;
            });

            // 2. Bar Chart Comparison
            const data = google.visualization.arrayToDataTable([
                ['Metric', OUR_BRAND_NAME, selectedComp],
                ['Click Share', usData.reduce((s,x)=>s+x.click_share,0), compData.reduce((s,x)=>s+x.click_share,0)],
                ['Deal Days (Avg)', usData.reduce((s,x)=>s+x.weekly_number_of_days_with_deal,0)/usData.length || 0, compData.reduce((s,x)=>s+x.weekly_number_of_days_with_deal,0)/compData.length || 0]
            ]);

            const options = {
                title: 'Comparativa de Intensidad',
                bars: 'horizontal',
                colors: ['#4285F4', '#EA4335']
            };
            const chart = new google.visualization.BarChart(document.getElementById('chart_interactive_radar'));
            chart.draw(data, options);

            // 3. Top ASINs Table
            const topASINs = weekData.sort((a,b) => b.click_share - a.click_share).slice(0, 5);
            const tableData = new google.visualization.DataTable();
            tableData.addColumn('string', 'ASIN / Producto');
            tableData.addColumn('string', 'Marca');
            tableData.addColumn('number', 'Share (%)');
            tableData.addColumn('number', 'Precio');
            tableData.addColumn('string', 'Badges');

            topASINs.forEach(d => {
                let badges = [];
                if(d.weekly_number_of_days_with_deal > 0) badges.push('DEAL');
                if(d.weekly_number_of_days_with_amazon_choice_badge > 0) badges.push('AC');
                if(d.weekly_number_of_days_with_best_seller_badge > 0) badges.push('BS');
                
                tableData.addRow([
                    d.product_title.substring(0, 30)+'...',
                    d.competitor_brand,
                    d.click_share,
                    d.price,
                    badges.join(' ')
                ]);
            });

            const table = new google.visualization.Table(document.getElementById('table_top_asins'));
            table.draw(tableData, {showRowNumber: true, width: '100%', height: '100%'});
        }

        // Tab Switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');

            // Redraw charts to fix hidden container size issues
            if(tabId === 'static') {
                drawGlobalTrendChart();
                drawCompetitivenessChart();
            } else {
                updateInteractive();
            }
        }
    </script>
</body>
</html>