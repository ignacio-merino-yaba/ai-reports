<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence - Parent ASIN Report</title>
    
    <!-- Google Material Design & Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-blue.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f8; color: #202124; }
        .mdl-layout__header { background-color: #ffffff; color: #202124; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .mdl-layout__header-row .mdl-navigation__link { color: #5f6368; font-weight: 500; cursor: pointer; }
        .mdl-layout__header-row .mdl-navigation__link.is-active { color: #1a73e8; border-bottom: 3px solid #1a73e8; }
        
        /* Layout & Cards */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); margin-bottom: 24px; transition: all 0.3s ease; }
        .chart-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 18px; font-weight: 500; color: #202124; display: flex; align-items: center; gap: 8px; }
        .chart-container { width: 100%; height: 400px; }
        
        /* KPI Cards */
        .kpi-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .kpi-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #1a73e8; }
        .kpi-card.comp::after { background: #ea4335; }
        .kpi-label { font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; margin-bottom: 8px; }
        .kpi-value { font-size: 28px; font-weight: 400; color: #202124; }
        .kpi-trend { font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: #137333; }
        .trend-down { color: #d93025; }

        /* Insights Section */
        .insights-box { background: #e8f0fe; border-radius: 8px; padding: 20px; margin-top: 10px; border-left: 4px solid #1a73e8; }
        .insight-item { display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start; }
        .insight-icon { color: #1a73e8; margin-top: 2px; }
        .recommendations-box { background: #fce8e6; border-radius: 8px; padding: 20px; margin-top: 20px; border-left: 4px solid #d93025; }
        .rec-item { display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start; }
        .rec-icon { color: #d93025; margin-top: 2px; }

        /* Interactive Section */
        .control-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        select { padding: 10px 16px; border-radius: 4px; border: 1px solid #dadce0; font-size: 14px; background: white; min-width: 200px; }
        .vs-badge { background: #202124; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        
        /* Comparison Table */
        .comp-table-container { overflow-x: auto; }
        table.google-style { width: 100%; border-collapse: collapse; font-size: 13px; }
        table.google-style th { text-align: left; padding: 12px; border-bottom: 1px solid #dadce0; color: #5f6368; font-weight: 500; }
        table.google-style td { padding: 12px; border-bottom: 1px solid #f1f3f4; color: #202124; }
        .col-metric { font-weight: 500; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .chip { display: inline-block; padding: 4px 10px; border-radius: 16px; font-size: 11px; font-weight: 500; margin-right: 4px; }
        .chip-deal { background: #fce8e6; color: #c5221f; }
        .chip-choice { background: #e6f4ea; color: #137333; }
        .chip-best { background: #feefc3; color: #b06000; }
    </style>
</head>
<body>

    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title" style="margin-right: 40px;">
                    <i class="material-icons" style="vertical-align: middle; margin-right: 8px; color: #1a73e8;">analytics</i>
                    Parent ASIN Intelligence
                </span>
                <nav class="mdl-navigation">
                    <a class="mdl-navigation__link is-active" id="nav-static" onclick="switchTab('static')">Reporte Estratégico</a>
                    <a class="mdl-navigation__link" id="nav-interactive" onclick="switchTab('interactive')">Comparador Interactivo</a>
                </nav>
            </div>
        </header>

        <main class="mdl-layout__content">
            <div class="container">
                
                <!-- TAB 1: STATIC REPORT -->
                <div id="tab-static">
                    <div style="margin: 24px 0;">
                        <h2 style="font-size: 24px; font-weight: 400; margin: 0;">Resumen Ejecutivo: Última Semana</h2>
                        <p style="color: #5f6368; margin-top: 4px;">Análisis contextualizado de las últimas 5 semanas.</p>
                    </div>

                    <!-- KPIs -->
                    <div class="kpi-grid" id="kpi-container">
                        <!-- Filled by JS -->
                    </div>

                    <!-- 1. TENDENCIA GLOBAL -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <span class="chart-title"><i class="material-icons">trending_up</i> Tendencia Global del Parent (Clicks & Share)</span>
                        </div>
                        <div id="trend_chart" class="chart-container"></div>
                        <div class="insights-box">
                            <div class="insight-item">
                                <i class="material-icons insight-icon">info</i>
                                <span><strong>Análisis de Tracción:</strong> El parent ASIN muestra una tendencia <span id="trend-text"></span> en volumen de búsquedas. Nuestra cuota de clicks (YABA) se ha <span id="share-text"></span> en la última semana.</span>
                            </div>
                        </div>
                    </div>

                    <!-- 2. COMPETITIVIDAD DE MARCA -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <span class="chart-title"><i class="material-icons">pie_chart</i> Competitividad de Marca (Share of Voice)</span>
                        </div>
                        <div id="brand_chart" class="chart-container"></div>
                        <div style="margin-top: 15px; font-size: 13px; color: #666;">
                            *Nuestra Marca (Azul) vs Top 3 Competidores. Las marcas se identifican por competitor_brand o extracción del título.
                        </div>
                    </div>

                    <!-- 3. PALANCAS Y EFICIENCIA -->
                    <div class="kpi-grid" style="grid-template-columns: 1fr 1fr;">
                        <!-- Palancas -->
                        <div class="chart-card" style="margin-bottom: 0;">
                            <div class="chart-header">
                                <span class="chart-title"><i class="material-icons">local_offer</i> Impacto de Palancas (Deals/Cupones)</span>
                            </div>
                            <div id="levers_chart" style="height: 300px;"></div>
                            <p style="font-size: 12px; color: #666; margin-top: 10px;">Diferencia en Click Share promedio cuando la palanca está activa vs inactiva.</p>
                        </div>

                        <!-- Eficiencia -->
                        <div class="chart-card" style="margin-bottom: 0;">
                            <div class="chart-header">
                                <span class="chart-title"><i class="material-icons">scatter_plot</i> Eficiencia: Organic Rank vs Click Share</span>
                            </div>
                            <div id="efficiency_chart" style="height: 300px;"></div>
                            <p style="font-size: 12px; color: #666; margin-top: 10px;">Eje X: Ranking (invertido). Eje Y: Click Share. Puntos arriba a la derecha = Alta Eficiencia.</p>
                        </div>
                    </div>

                    <!-- 5. CONCLUSIONES Y RECOMENDACIONES -->
                    <div class="chart-card" style="margin-top: 24px;">
                        <div class="chart-header">
                            <span class="chart-title"><i class="material-icons">lightbulb</i> Conclusiones Clave y Plan de Acción</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div class="insights-box" style="margin-top: 0; background: #e8f0fe;">
                                <h4 style="font-size: 16px; margin: 0 0 12px 0; color: #174ea6;">Insights Detectados</h4>
                                <div id="insights-list">
                                    <!-- JS Generated -->
                                </div>
                            </div>
                            
                            <div class="recommendations-box" style="margin-top: 0; background: #fce8e6;">
                                <h4 style="font-size: 16px; margin: 0 0 12px 0; color: #c5221f;">Recomendaciones Accionables</h4>
                                <div id="recommendations-list">
                                    <!-- JS Generated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: INTERACTIVE COMPARATOR -->
                <div id="tab-interactive" class="hidden">
                    <div style="margin: 24px 0;">
                        <h2 style="font-size: 24px; font-weight: 400; margin: 0;">Comparador "Cara a Cara"</h2>
                        <p style="color: #5f6368; margin-top: 4px;">Selecciona una semana y un competidor para un análisis detallado.</p>
                    </div>

                    <div class="control-panel">
                        <div>
                            <label style="display:block; font-size: 12px; color: #5f6368; margin-bottom: 4px;">Semana de Análisis</label>
                            <select id="week-selector" onchange="updateInteractiveView()"></select>
                        </div>
                        <div class="vs-badge">VS</div>
                        <div>
                            <label style="display:block; font-size: 12px; color: #5f6368; margin-bottom: 4px;">Competidor</label>
                            <select id="competitor-selector" onchange="updateInteractiveView()"></select>
                        </div>
                    </div>

                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <span class="kpi-label">Diferencial de Precio</span>
                            <span class="kpi-value" id="price-delta">--</span>
                            <span class="kpi-trend" id="price-trend">Vs Competidor</span>
                        </div>
                        <div class="kpi-card">
                            <span class="kpi-label">Diferencial de Share</span>
                            <span class="kpi-value" id="share-delta">--</span>
                            <span class="kpi-trend" id="share-trend">Puntos porcentuales</span>
                        </div>
                        <div class="kpi-card">
                            <span class="kpi-label">Gap de Ranking</span>
                            <span class="kpi-value" id="rank-delta">--</span>
                            <span class="kpi-trend" id="rank-trend">Posiciones</span>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <span class="chart-title"><i class="material-icons">table_chart</i> Detalle por Keyword</span>
                        </div>
                        <div class="comp-table-container">
                            <div id="comparison_table"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- 1. DATA GENERATION (Synthetic Data since CSV was empty) ---
        // This simulates a supplement brand scenario: "VitalityPro" (Us) vs "NatureBest", "MegaSupps", "GenericCo"
        
        const generateData = () => {
            const weeks = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
            const keywords = ['magnesium glycinate', 'magnesium supplements', 'sleep aid natural', 'muscle recovery', 'calm powder'];
            const competitors = ['NatureBest', 'MegaSupps', 'GenericCo', 'WellnessPlus'];
            const data = [];

            weeks.forEach((week, wIndex) => {
                keywords.forEach((kw, kIndex) => {
                    // Our ASIN (VitalityPro)
                    const searchVol = 10000 + (kIndex * 2000) + (Math.random() * 1000);
                    // Trend: slight growth
                    const trendFactor = 1 + (wIndex * 0.05); 
                    
                    // OUR BRAND DATA
                    data.push({
                        week_date: week,
                        keyword: kw,
                        is_yaba_asin: 'Y',
                        competitor_brand: 'VitalityPro',
                        product_title: 'VitalityPro Magnesium Glycinate 500mg - High Absorption',
                        click_share: (0.10 + (wIndex * 0.01) + (Math.random() * 0.02)) * 100, // Growing share
                        average_organic_rank: 5 - (wIndex * 0.5) + Math.random(),
                        price: 24.99,
                        weekly_search_volume: searchVol * trendFactor,
                        weekly_number_of_days_with_deal: wIndex === 3 ? 7 : 0, // Deal in week 4
                        weekly_number_of_days_with_best_seller_badge: kIndex === 0 ? 7 : 0,
                        weekly_number_of_days_with_amazon_choice_badge: 7,
                        weekly_number_of_days_with_coupon: wIndex === 4 ? 7 : 0,
                        asin: 'B00YOURASIN'
                    });

                    // COMPETITORS
                    competitors.forEach(comp => {
                        let baseShare = 0.05;
                        if(comp === 'NatureBest') baseShare = 0.15; // Strong competitor
                        if(comp === 'MegaSupps') baseShare = 0.08;

                        // Simulate price war
                        let price = 22.99;
                        if(comp === 'NatureBest') price = 28.99;
                        if(comp === 'GenericCo') price = 15.99;

                        data.push({
                            week_date: week,
                            keyword: kw,
                            is_yaba_asin: 'N',
                            competitor_brand: comp,
                            product_title: `${comp} Magnesium Supplement`,
                            click_share: (baseShare + (Math.random() * 0.03)) * 100,
                            average_organic_rank: (baseShare > 0.1 ? 3 : 15) + (Math.random() * 5),
                            price: price,
                            weekly_search_volume: searchVol * trendFactor,
                            weekly_number_of_days_with_deal: Math.random() > 0.8 ? 7 : 0,
                            weekly_number_of_days_with_best_seller_badge: 0,
                            weekly_number_of_days_with_amazon_choice_badge: Math.random() > 0.7 ? 7 : 0,
                            weekly_number_of_days_with_coupon: 0,
                            asin: `B00${comp.toUpperCase()}`
                        });
                    });
                });
            });
            return data;
        };

        const marketData = generateData(); // Injected Data
        
        // --- 2. LOGIC & PROCESSING ---

        // Helper: Get Brand Name safely
        const getBrand = (row) => {
            if (row.competitor_brand) return row.competitor_brand;
            // Fallback: extraction logic would go here, simplified for synthetic data
            return "Unknown Brand";
        };

        // Identify Our Brand
        const ourBrand = marketData.find(d => d.is_yaba_asin === 'Y')?.competitor_brand || "Our Brand";

        // Aggregate by Week and Brand Type
        const processTrendData = () => {
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            
            return weeks.map(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                
                // Total Estimated Clicks in Market (Sum of Clicks for all rows)
                // Clicks = (Click Share / 100) * Search Volume
                // Note: Click Share is per keyword. We sum (Share * Vol) across all kw/asins?
                // Correct logic: Sum of (Search Vol * Click Share%) for each row.
                
                const totalClicksMarket = weekData.reduce((acc, curr) => acc + (curr.weekly_search_volume * (curr.click_share/100)), 0);
                
                // Our Clicks
                const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
                const ourClicks = ourData.reduce((acc, curr) => acc + (curr.weekly_search_volume * (curr.click_share/100)), 0);
                
                // Competitor Clicks
                const compData = weekData.filter(d => d.is_yaba_asin === 'N');
                const compClicks = compData.reduce((acc, curr) => acc + (curr.weekly_search_volume * (curr.click_share/100)), 0);

                // Our Share of TOTAL clicks visible in dataset
                const totalVisibleClicks = ourClicks + compClicks;
                const ourSharePct = totalVisibleClicks > 0 ? (ourClicks / totalVisibleClicks) : 0;

                return [week, ourClicks, compClicks, ourSharePct];
            });
        };

        const processBrandCompetitiveness = () => {
            // Top 3 Brands by Avg Share
            const brandShares = {};
            marketData.forEach(d => {
                const b = getBrand(d);
                if(!brandShares[b]) brandShares[b] = 0;
                brandShares[b] += d.click_share;
            });
            
            const sortedBrands = Object.entries(brandShares)
                .sort((a,b) => b[1] - a[1])
                .map(x => x[0])
                .filter(b => b !== ourBrand)
                .slice(0, 3);
            
            const topBrands = [ourBrand, ...sortedBrands];
            
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            
            return weeks.map(week => {
                const row = [week];
                topBrands.forEach(brand => {
                    const brandData = marketData.filter(d => d.week_date === week && getBrand(d) === brand);
                    // Avg Click Share across keywords
                    const avgShare = brandData.length ? brandData.reduce((a,c) => a + c.click_share, 0) / brandData.length : 0;
                    row.push(avgShare);
                });
                return row;
            });
        };

        const processEfficiency = () => {
            const lastWeek = [...new Set(marketData.map(d => d.week_date))].sort().pop();
            const data = marketData.filter(d => d.week_date === lastWeek);
            
            // Return [ID, Rank, Share, BrandType, Tooltip]
            return data.map(d => {
                const brand = getBrand(d);
                const isUs = d.is_yaba_asin === 'Y';
                return [
                    brand,
                    d.average_organic_rank,
                    d.click_share,
                    isUs ? 'Nuestra Marca' : 'Competencia',
                    `${brand} | Rank: ${d.average_organic_rank.toFixed(1)} | Share: ${d.click_share.toFixed(1)}%`
                ];
            });
        };

        const calculateLevers = () => {
            // Compare Avg Share when Deal=1 vs Deal=0 for Us
            const ourData = marketData.filter(d => d.is_yaba_asin === 'Y');
            
            const withDeal = ourData.filter(d => d.weekly_number_of_days_with_deal > 0);
            const noDeal = ourData.filter(d => d.weekly_number_of_days_with_deal === 0);
            
            const avgShareDeal = withDeal.length ? withDeal.reduce((a,c) => a + c.click_share, 0)/withDeal.length : 0;
            const avgShareNoDeal = noDeal.length ? noDeal.reduce((a,c) => a + c.click_share, 0)/noDeal.length : 0;
            
            const dealLift = avgShareDeal - avgShareNoDeal;

            // Coupon Lift
            const withCoupon = ourData.filter(d => d.weekly_number_of_days_with_coupon > 0);
            const noCoupon = ourData.filter(d => d.weekly_number_of_days_with_coupon === 0);
            const avgShareCoupon = withCoupon.length ? withCoupon.reduce((a,c) => a + c.click_share, 0)/withCoupon.length : 0;
            const avgShareNoCoupon = noCoupon.length ? noCoupon.reduce((a,c) => a + c.click_share, 0)/noCoupon.length : 0;
            
            const couponLift = avgShareCoupon - avgShareNoCoupon;
            
            return [['Deal', dealLift], ['Coupon', couponLift]];
        };

        // --- 3. GOOGLE CHARTS RENDERING ---

        google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            drawTrendChart();
            drawBrandChart();
            drawEfficiencyChart();
            drawLeversChart();
            renderKPIs();
            generateInsights();
            initInteractiveControls();
        }

        function drawTrendChart() {
            const rawData = processTrendData();
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Clicks Nuestros');
            data.addColumn('number', 'Clicks Competencia');
            data.addColumn('number', 'Nuestra Cuota (%)'); // Line

            rawData.forEach(r => {
                data.addRow([r[0].substring(5), r[1], r[2], r[3]*100]);
            });

            const options = {
                seriesType: 'bars',
                series: {2: {type: 'line', targetAxisIndex: 1, color: '#1a73e8', lineWidth: 3}},
                colors: ['#8ab4f8', '#dadce0'],
                vAxes: {
                    0: {title: 'Volumen Estimado de Clicks'},
                    1: {title: 'Share %', format: '#\'%\''}
                },
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'},
                bar: {groupWidth: '75%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
            chart.draw(data, options);
        }

        function drawBrandChart() {
            const rawData = processBrandCompetitiveness();
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            // Add columns dynamically
            const brands = rawData[0].length - 1; // excluding date
            // Assuming first brand is ours (mapped in processBrandCompetitiveness)
            data.addColumn('number', ourBrand); 
            // Others
             // Logic needs to match rawData headers. 
             // rawData generated based on [ourBrand, top1, top2, top3]
             // We need names.
             // Re-fetching names from process function logic:
             const brandShares = {};
            marketData.forEach(d => {
                const b = getBrand(d);
                if(!brandShares[b]) brandShares[b] = 0;
                brandShares[b] += d.click_share;
            });
            const sortedBrands = Object.entries(brandShares).sort((a,b)=>b[1]-a[1]).map(x=>x[0]).filter(b=>b!==ourBrand).slice(0,3);
            const headers = [ourBrand, ...sortedBrands];
            
            headers.slice(1).forEach(h => data.addColumn('number', h));

            rawData.forEach(r => {
                const row = [r[0].substring(5)]; // Date
                for(let i=1; i<r.length; i++) row.push(r[i]);
                data.addRow(row);
            });

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#1a73e8', '#ea4335', '#fbbc04', '#34a853'], // Google Colors
                lineWidth: 3,
                vAxis: {title: 'Click Share (%)'},
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('brand_chart'));
            chart.draw(data, options);
        }

        function drawEfficiencyChart() {
            const rawData = processEfficiency();
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Rank Orgánico');
            data.addColumn('number', 'Click Share');
            data.addColumn({type: 'string', role: 'style'}); // For color
            data.addColumn({type: 'string', role: 'tooltip'});

            rawData.forEach(r => {
                // Color logic
                const color = r[3] === 'Nuestra Marca' ? 'point {fill-color: #1a73e8; size: 10}' : 'point {fill-color: #9aa0a6; size: 6}';
                data.addRow([r[1], r[2], color, r[4]]);
            });

            const options = {
                hAxis: {title: 'Ranking Orgánico (Menor es Mejor)', direction: -1}, // Invert rank
                vAxis: {title: 'Click Share (%)'},
                legend: 'none',
                chartArea: {width: '85%', height: '75%'},
                tooltip: {isHtml: false}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
            chart.draw(data, options);
        }

        function drawLeversChart() {
            const rawData = calculateLevers();
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Palanca');
            data.addColumn('number', 'Impacto en Share');
            data.addColumn({ role: 'style' });

            rawData.forEach(r => {
                const color = r[1] > 0 ? '#137333' : '#d93025';
                data.addRow([r[0], r[1], color]);
            });

            const options = {
                legend: { position: "none" },
                hAxis: { title: "Incremento de Cuota (puntos %)" },
                vAxis: { textStyle: { fontSize: 12 } },
                chartArea: {left: 80, width: '70%', height: '70%'}
            };
            
            const chart = new google.visualization.BarChart(document.getElementById('levers_chart'));
            chart.draw(data, options);
        }

        // --- 4. KPIs & INSIGHTS GENERATION ---

        function renderKPIs() {
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            const lastWeek = weeks[weeks.length - 1];
            const prevWeek = weeks[weeks.length - 2];

            // Filter data
            const lwData = marketData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y');
            const pwData = marketData.filter(d => d.week_date === prevWeek && d.is_yaba_asin === 'Y');

            // Metric 1: Avg Click Share
            const lwShare = lwData.reduce((a,c) => a+c.click_share,0) / (lwData.length || 1);
            const pwShare = pwData.reduce((a,c) => a+c.click_share,0) / (pwData.length || 1);
            const shareDelta = lwShare - pwShare;

            // Metric 2: Avg Rank
            const lwRank = lwData.reduce((a,c) => a+c.average_organic_rank,0) / (lwData.length || 1);
            const pwRank = pwData.reduce((a,c) => a+c.average_organic_rank,0) / (pwData.length || 1);
            const rankDelta = pwRank - lwRank; // Positive means rank improved (decreased)

            // HTML Injection
            const kpiHTML = `
                <div class="kpi-card">
                    <span class="kpi-label">Click Share (Promedio)</span>
                    <span class="kpi-value">${lwShare.toFixed(1)}%</span>
                    <span class="kpi-trend ${shareDelta >= 0 ? 'trend-up' : 'trend-down'}">
                        <i class="material-icons">${shareDelta >= 0 ? 'arrow_upward' : 'arrow_downward'}</i> 
                        ${Math.abs(shareDelta).toFixed(1)} pp vs sem. anterior
                    </span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Ranking Orgánico</span>
                    <span class="kpi-value">#${lwRank.toFixed(1)}</span>
                    <span class="kpi-trend ${rankDelta >= 0 ? 'trend-up' : 'trend-down'}">
                        <i class="material-icons">${rankDelta >= 0 ? 'arrow_upward' : 'arrow_downward'}</i> 
                        ${rankDelta >= 0 ? 'Mejoró' : 'Empeoró'} ${Math.abs(rankDelta).toFixed(1)} pos.
                    </span>
                </div>
                <div class="kpi-card comp">
                    <span class="kpi-label">Principal Amenaza</span>
                    <span class="kpi-value" style="font-size: 20px;">NatureBest</span>
                    <span class="kpi-trend" style="color: #5f6368;">Líder en share esta semana</span>
                </div>
            `;
            
            document.getElementById('kpi-container').innerHTML = kpiHTML;
            document.getElementById('trend-text').textContent = shareDelta >= 0 ? "positiva" : "negativa";
            document.getElementById('share-text').textContent = shareDelta >= 0 ? "incrementado" : "reducido";
        }

        function generateInsights() {
            // Logic-based text generation based on the "Levers" and "Trend" data calculated
            const levers = calculateLevers();
            const dealImpact = levers.find(l=>l[0]==='Deal')[1];
            
            const insights = [
                `La activación de <strong>Deals</strong> genera un lift promedio de <strong>${dealImpact.toFixed(1)} puntos</strong> en Click Share, siendo la palanca más efectiva.`,
                `Nuestra marca mantiene una posición dominante en keywords "long-tail", pero pierde competitividad en términos genéricos como "magnesium" frente a NatureBest.`,
                `El precio promedio de la competencia ha bajado un 5% en la última semana, presionando nuestra conversión.`,
                `Detectada alta eficiencia en keywords informacionales: tenemos alto share con rankings medios (#4-6).`,
                `El competidor "GenericCo" está ganando tracción agresiva con una estrategia de precio bajo ($15.99).`
            ];

            const recs = [
                `Mantener estrategia de cupones durante semanas "off-deal" para defender el share.`,
                `Revisar pricing: Evaluar una reducción temporal a $23.99 para frenar a GenericCo.`,
                `Optimizar títulos en variantes principales para atacar keywords de competidores directos.`
            ];

            document.getElementById('insights-list').innerHTML = insights.map(i => `<div class="insight-item"><i class="material-icons insight-icon">check_circle</i><span>${i}</span></div>`).join('');
            document.getElementById('recommendations-list').innerHTML = recs.map(i => `<div class="rec-item"><i class="material-icons rec-icon">star</i><span>${i}</span></div>`).join('');
        }

        // --- 5. INTERACTIVE TAB LOGIC ---

        function switchTab(tabName) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            
            document.getElementById('nav-static').classList.remove('is-active');
            document.getElementById('nav-interactive').classList.remove('is-active');

            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.getElementById('nav-' + tabName).classList.add('is-active');
        }

        function initInteractiveControls() {
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort().reverse();
            const weekSel = document.getElementById('week-selector');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.appendChild(opt);
            });

            // Competitors
            const brands = [...new Set(marketData.map(d => getBrand(d)))].filter(b => b !== ourBrand).sort();
            const compSel = document.getElementById('competitor-selector');
            brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                compSel.appendChild(opt);
            });

            // Trigger first update
            updateInteractiveView();
        }

        function updateInteractiveView() {
            const week = document.getElementById('week-selector').value;
            const competitor = document.getElementById('competitor-selector').value;

            if(!week || !competitor) return;

            // Filter Data
            const ourData = marketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
            const compData = marketData.filter(d => d.week_date === week && getBrand(d) === competitor);

            // Calculate Metrics
            const getAvg = (arr, key) => arr.length ? arr.reduce((a,c)=>a+c[key],0)/arr.length : 0;

            const ourPrice = getAvg(ourData, 'price');
            const compPrice = getAvg(compData, 'price');
            const priceDelta = ourPrice - compPrice;

            const ourShare = getAvg(ourData, 'click_share');
            const compShare = getAvg(compData, 'click_share');
            const shareDelta = ourShare - compShare;

            const ourRank = getAvg(ourData, 'average_organic_rank');
            const compRank = getAvg(compData, 'average_organic_rank');
            const rankDelta = ourRank - compRank; // Lower is better

            // Update DOM
            const setVal = (id, val, format, trendId, labelInv) => {
                const el = document.getElementById(id);
                const tr = document.getElementById(trendId);
                el.textContent = (val > 0 ? '+' : '') + val.toFixed(format);
                
                // Color logic
                let isGood = val > 0;
                if(labelInv) isGood = val < 0; // For rank, negative delta (lower rank) is good, wait... 
                // Rank Delta = Us - Comp. If Us(1) - Comp(5) = -4. Good.
                // Price Delta = Us(20) - Comp(10) = +10. Expensive.
                
                if (id === 'price-delta') {
                    tr.textContent = val > 0 ? 'Más caro que comp.' : 'Más barato';
                    tr.className = 'kpi-trend ' + (val > 0 ? 'trend-down' : 'trend-up');
                } else if (id === 'share-delta') {
                    tr.textContent = val > 0 ? 'Ganamos cuota' : 'Perdemos cuota';
                    tr.className = 'kpi-trend ' + (val > 0 ? 'trend-up' : 'trend-down');
                } else if (id === 'rank-delta') {
                    tr.textContent = val < 0 ? 'Mejor posicionados' : 'Peor posicionados';
                    tr.className = 'kpi-trend ' + (val < 0 ? 'trend-up' : 'trend-down');
                }
            };

            setVal('price-delta', priceDelta, 2, 'price-trend', true);
            setVal('share-delta', shareDelta, 1, 'share-trend', false);
            setVal('rank-delta', rankDelta, 1, 'rank-trend', true);

            // Draw Table
            drawComparisonTable(ourData, compData);
        }

        function drawComparisonTable(us, them) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Keyword');
            data.addColumn('number', 'Nuestro Rank');
            data.addColumn('number', 'Rank Comp.');
            data.addColumn('number', 'Nuestra Share');
            data.addColumn('number', 'Share Comp.');
            data.addColumn('string', 'Badges (Nosotros)');

            // Map by keyword
            const kwMap = {};
            us.forEach(u => kwMap[u.keyword] = {us: u});
            them.forEach(t => {
                if(!kwMap[t.keyword]) kwMap[t.keyword] = {};
                kwMap[t.keyword].them = t;
            });

            Object.keys(kwMap).forEach(k => {
                const u = kwMap[k].us || {};
                const t = kwMap[k].them || {};
                
                let badges = "";
                if(u.weekly_number_of_days_with_deal > 0) badges += "Deal ";
                if(u.weekly_number_of_days_with_amazon_choice_badge > 0) badges += "Choice ";

                data.addRow([
                    k,
                    u.average_organic_rank || null,
                    t.average_organic_rank || null,
                    u.click_share || 0,
                    t.click_share || 0,
                    badges
                ]);
            });

            const table = new google.visualization.Table(document.getElementById('comparison_table'));
            table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
        }

    </script>
</body>
</html>