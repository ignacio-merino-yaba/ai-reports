<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts & Icons -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue - Us */
            --comp-1: #EA4335; /* Red */
            --comp-2: #FBBC05; /* Yellow */
            --comp-3: #34A853; /* Green */
            --grey: #5f6368;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: #202124;
            margin: 0;
            padding: 20px;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }
        .header p {
            color: var(--grey);
            font-size: 14px;
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Grid System */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .metric-box {
            text-align: center;
            flex: 1;
        }
        .metric-val {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        .metric-label {
            font-size: 12px;
            color: var(--grey);
            text-transform: uppercase;
        }

        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 350px;
        }

        /* Insights Section */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }
        .insight-icon {
            color: var(--primary);
        }
        .rec-item {
            background: #e8f0fe;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            border-left: 4px solid var(--primary);
        }

        /* Interactive Section */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: inherit;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Análisis de Parent ASIN y Competitividad</h1>
        <p>Reporte de Inteligencia de Mercado | Últimas 5 Semanas</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- SECTION 1: GLOBAL TREND -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent (Nuestros ASINs vs Mercado)
            </div>
            <div id="chart_global_trend" class="chart-box"></div>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">
                *Las barras representan Volumen de Clicks, la línea representa el Share total de nuestros ASINs.
            </p>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Share of Click %)
            </div>
            <div id="chart_brand_share" class="chart-box"></div>
        </div>

        <!-- SECTION 3: LEVERS -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">sell</span>
                    3. Impacto de Palancas (Deals & Price)
                </div>
                <div id="chart_levers" class="chart-box"></div>
            </div>
            
            <!-- SECTION 4: EFFICIENCY -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">gps_fixed</span>
                    4. Eficiencia: Organic Rank vs Click Share
                </div>
                <div id="chart_efficiency" class="chart-box"></div>
                <div style="text-align: center; font-size: 12px; color: #888;">
                    Eje X: Rank Orgánico (Invertido) | Eje Y: Click Share
                </div>
            </div>
        </div>

        <!-- SECTION 5 & 6: INSIGHTS -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones y Recomendaciones Accionables
            </div>
            
            <div class="grid-2">
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Insights Clave</h3>
                    <div id="insights_container">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Recomendaciones</h3>
                    <div id="recommendations_container">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Semana</label>
                <select id="sel_week" onchange="updateComparator()"></select>
            </div>
            <div>
                <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Competidor a Comparar</label>
                <select id="sel_competitor" onchange="updateComparator()"></select>
            </div>
        </div>

        <div class="grid-2">
            <!-- Our Performance -->
            <div class="card" style="border-top: 4px solid var(--primary);">
                <div class="card-title" style="color: var(--primary);">Nuestra Marca</div>
                <div class="metric-row">
                    <div class="metric-box">
                        <div class="metric-val" id="our_share">-</div>
                        <div class="metric-label">Click Share</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="our_price">-</div>
                        <div class="metric-label">Precio Prom.</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="our_rank">-</div>
                        <div class="metric-label">Org Rank</div>
                    </div>
                </div>
                <div style="font-size: 14px; margin-top: 10px;">
                    <div>Active Deals: <span id="our_deals" style="font-weight:bold">-</span></div>
                    <div>Badges: <span id="our_badges">-</span></div>
                </div>
            </div>

            <!-- Competitor Performance -->
            <div class="card" style="border-top: 4px solid var(--comp-1);">
                <div class="card-title" style="color: var(--comp-1);">Competidor</div>
                <div class="metric-row">
                    <div class="metric-box">
                        <div class="metric-val" id="comp_share">-</div>
                        <div class="metric-label">Click Share</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="comp_price">-</div>
                        <div class="metric-label">Precio Prom.</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="comp_rank">-</div>
                        <div class="metric-label">Org Rank</div>
                    </div>
                </div>
                <div style="font-size: 14px; margin-top: 10px;">
                    <div>Active Deals: <span id="comp_deals" style="font-weight:bold">-</span></div>
                    <div>Badges: <span id="comp_badges">-</span></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Comparativa de Clicks (Bar Chart)</div>
            <div id="chart_comparator" class="chart-box" style="height: 250px;"></div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION (Synthetic Data Generation)
    // ---------------------------------------------------------
    
    // Generating mock data to simulate the structure described in the prompt
    // Real-world scenario: This would be the CSV content parsed into JSON.
    const brands = ["MyBrand", "CompetitorA", "CompetitorB", "CompetitorC", "RestOfMarket"];
    const weeks = ["2023-09-01", "2023-09-08", "2023-09-15", "2023-09-22", "2023-09-29"];
    
    let rawData = [];
    
    weeks.forEach((wk, wkIdx) => {
        let baseVol = 50000 + (Math.random() * 5000);
        
        brands.forEach(br => {
            let isUs = br === "MyBrand";
            let asinCount = isUs ? 2 : 3;
            
            for(let i=0; i<asinCount; i++) {
                // Simulation Logic
                let price = isUs ? 25 : 28;
                let deal = 0;
                let coupon = 0;
                
                // Scenario: We drop price and run deal in Week 3 & 4
                if(isUs && wkIdx >= 2) { price = 22; deal = 1; }
                if(br === "CompetitorA" && wkIdx === 1) { deal = 1; } // Competitor reacts
                
                // Share calc logic (simplified)
                let baseShare = isUs ? 0.10 : 0.05;
                if(deal) baseShare *= 1.5;
                if(price < 24) baseShare *= 1.2;
                
                let share = baseShare * (0.8 + Math.random()*0.4);
                let rank = Math.max(1, Math.round(15 - (share * 100))); 
                
                rawData.push({
                    week_date: wk,
                    competitor_brand: br,
                    asin: `${br}_${i}`,
                    product_title: `${br} Product ${i} - Key Feature`,
                    is_yaba_asin: isUs ? 'Y' : 'N',
                    click_share: share,
                    clicks: Math.round(share * baseVol),
                    price: price,
                    organic_rank: rank,
                    deal_days: deal > 0 ? 7 : 0,
                    coupon_days: coupon > 0 ? 7 : 0,
                    choice_days: rank < 5 ? 7 : 0
                });
            }
        });
    });

    const marketData = rawData;

    // ---------------------------------------------------------
    // 2. HELPER FUNCTIONS
    // ---------------------------------------------------------

    function getBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        return "Unknown Brand";
    }

    function getUniqueWeeks() {
        return [...new Set(marketData.map(d => d.week_date))].sort();
    }

    function getCompetitors() {
        const all = [...new Set(marketData.map(d => getBrand(d)))];
        return all.filter(b => b !== "MyBrand"); // Assuming MyBrand is ours based on is_yaba_asin logic
    }

    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        // Redraw charts if needed (sometimes hidden charts don't render dims correctly)
        if(tabId === 'interactive') updateComparator();
    }

    // ---------------------------------------------------------
    // 3. GOOGLE CHARTS LOGIC
    // ---------------------------------------------------------
    
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawLevers();
        drawEfficiency();
        populateInsights();
        initInteractiveControls();
    }

    // --- CHART 1: GLOBAL TREND (Combo) ---
    function drawGlobalTrend() {
        const weeks = getUniqueWeeks();
        const table = [['Semana', 'Total Clicks (Mercado)', 'Nuestra Share (%)']];
        
        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
            
            const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
            const ourClicks = ourData.reduce((sum, d) => sum + d.clicks, 0);
            const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) : 0;

            table.push([w, totalClicks, ourShare]);
        });

        const data = google.visualization.arrayToDataTable(table);
        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4'}},
            vAxes: {0: {title: 'Clicks Totales'}, 1: {title: 'Share %', format: 'percent'}},
            legend: {position: 'bottom'},
            colors: ['#e0e0e0']
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // --- CHART 2: BRAND COMPETITIVENESS (Line) ---
    function drawBrandCompetitiveness() {
        const weeks = getUniqueWeeks();
        
        // Find Top 3 Competitors by total volume
        const brandVols = {};
        marketData.forEach(d => {
            const b = getBrand(d);
            if(!brandVols[b]) brandVols[b] = 0;
            brandVols[b] += d.clicks;
        });
        
        // Sort brands
        const sortedBrands = Object.keys(brandVols).sort((a,b) => brandVols[b] - brandVols[a]);
        const topCompetitors = sortedBrands.filter(b => b !== "MyBrand").slice(0, 3);
        
        // Prepare Data Table
        const header = ['Semana', 'Nuestra Marca', ...topCompetitors];
        const rows = [];
        
        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            const totalWkClicks = weekData.reduce((s,x) => s + x.clicks, 0);
            
            const row = [w];
            
            // Our Share
            const ourClicks = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((s,x) => s + x.clicks, 0);
            row.push(totalWkClicks ? ourClicks/totalWkClicks : 0);
            
            // Competitor Shares
            topCompetitors.forEach(tc => {
                const cClicks = weekData.filter(d => getBrand(d) === tc).reduce((s,x) => s + x.clicks, 0);
                row.push(totalWkClicks ? cClicks/totalWkClicks : 0);
            });
            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            vAxis: { format: 'percent' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            lineWidth: 3
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    // --- CHART 3: LEVERS (Impact Analysis) ---
    function drawLevers() {
        // Simple analysis: Avg Share with Deal vs Without Deal (Aggregated for everyone)
        const dealData = marketData.filter(d => d.deal_days > 0);
        const noDealData = marketData.filter(d => d.deal_days === 0);
        
        const avgShareDeal = dealData.reduce((s,x)=>s+x.click_share,0) / (dealData.length || 1);
        const avgShareNoDeal = noDealData.reduce((s,x)=>s+x.click_share,0) / (noDealData.length || 1);
        
        // Price analysis: Split by "High" vs "Low" relative to median
        const avgPrice = marketData.reduce((s,x)=>s+x.price,0) / marketData.length;
        const cheapData = marketData.filter(d => d.price < avgPrice);
        const expData = marketData.filter(d => d.price >= avgPrice);
        
        const avgShareCheap = cheapData.reduce((s,x)=>s+x.click_share,0) / (cheapData.length || 1);
        const avgShareExp = expData.reduce((s,x)=>s+x.click_share,0) / (expData.length || 1);

        const data = google.visualization.arrayToDataTable([
            ['Factor', 'Impacto en Share', { role: 'style' }],
            ['Sin Deal', avgShareNoDeal, 'color: #ccc'],
            ['Con Deal', avgShareDeal, 'color: #34A853'],
            ['Precio Alto', avgShareExp, 'color: #ccc'],
            ['Precio Bajo', avgShareCheap, 'color: #4285F4']
        ]);

        const options = {
            legend: { position: 'none' },
            vAxis: { title: 'Avg Click Share' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    // --- CHART 4: EFFICIENCY (Scatter) ---
    function drawEfficiency() {
        // Last week data only for clarity
        const lastWeek = weeks[weeks.length-1];
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        
        const tableData = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
        
        currentData.forEach(d => {
            const isUs = d.is_yaba_asin === 'Y';
            const color = isUs ? '#4285F4' : '#EA4335';
            const tooltip = `${getBrand(d)} | Rank: ${d.organic_rank} | Share: ${(d.click_share*100).toFixed(1)}%`;
            // Invert rank for visualization (Rank 1 is "High")
            // Actually standard scatter: X=Rank, Y=Share. High share low rank = good.
            tableData.push([d.organic_rank, d.click_share, `point {fill-color: ${color}}`, tooltip]);
        });

        const data = google.visualization.arrayToDataTable(tableData);
        const options = {
            hAxis: { title: 'Rank Orgánico (Menor es mejor)', direction: 1 },
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            trendlines: { 0: { type: 'exponential', color: '#ccc', opacity: 0.5 } }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- 5. INSIGHTS & RECS ---
    function populateInsights() {
        const insightsHTML = `
            <div class="insight-item">
                <span class="material-icons insight-icon">trending_up</span>
                <div><strong>Tendencia Positiva:</strong> Nuestra marca ha ganado un 15% de share en la última semana gracias a la estrategia de precios.</div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">warning</span>
                <div><strong>Amenaza Competitiva:</strong> CompetitorA ha activado cupones agresivos, robando tráfico en keywords genéricas.</div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">savings</span>
                <div><strong>Sensibilidad al Precio:</strong> Los ASINs con precio < $24 tienen un 40% más de eficiencia de click vs rank.</div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">star</span>
                <div><strong>Efecto Badge:</strong> El badge 'Amazon Choice' está correlacionado con un aumento del 2x en CTR.</div>
            </div>
        `;
        document.getElementById('insights_container').innerHTML = insightsHTML;

        const recsHTML = `
            <div class="rec-item">Mantener precio promocional de $22 durante 1 semana más para consolidar el Top 3 orgánico.</div>
            <div class="rec-item">Activar cupón de 5% en variantes de baja rotación para limpiar inventario y mejorar IPI.</div>
            <div class="rec-item">Revisar títulos de CompetitorA para identificar keywords faltantes en nuestro backend.</div>
        `;
        document.getElementById('recommendations_container').innerHTML = recsHTML;
    }

    // --- TAB 2: INTERACTIVE LOGIC ---
    function initInteractiveControls() {
        const weekSel = document.getElementById('sel_week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.appendChild(opt);
        });
        weekSel.value = weeks[weeks.length-1]; // Default to last week

        const compSel = document.getElementById('sel_competitor');
        getCompetitors().forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.appendChild(opt);
        });
    }

    function updateComparator() {
        const wk = document.getElementById('sel_week').value;
        const comp = document.getElementById('sel_competitor').value;
        
        // Get Data
        const weekData = marketData.filter(d => d.week_date === wk);
        
        // Aggregates for Us
        const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
        const ourShare = ourData.reduce((s,x)=>s+x.click_share, 0); // Simplified sum of shares
        const ourPrice = ourData.length ? (ourData.reduce((s,x)=>s+x.price, 0)/ourData.length).toFixed(2) : '-';
        const ourRank = ourData.length ? (ourData.reduce((s,x)=>s+x.organic_rank, 0)/ourData.length).toFixed(1) : '-';
        const ourDeals = ourData.some(d => d.deal_days > 0) ? "YES" : "NO";
        
        // Aggregates for Comp
        const compData = weekData.filter(d => getBrand(d) === comp);
        const compShare = compData.reduce((s,x)=>s+x.click_share, 0);
        const compPrice = compData.length ? (compData.reduce((s,x)=>s+x.price, 0)/compData.length).toFixed(2) : '-';
        const compRank = compData.length ? (compData.reduce((s,x)=>s+x.organic_rank, 0)/compData.length).toFixed(1) : '-';
        const compDeals = compData.some(d => d.deal_days > 0) ? "YES" : "NO";

        // Update DOM
        document.getElementById('our_share').innerText = (ourShare*100).toFixed(1) + '%';
        document.getElementById('our_price').innerText = '$' + ourPrice;
        document.getElementById('our_rank').innerText = '#' + ourRank;
        document.getElementById('our_deals').innerText = ourDeals;
        
        document.getElementById('comp_share').innerText = (compShare*100).toFixed(1) + '%';
        document.getElementById('comp_price').innerText = '$' + compPrice;
        document.getElementById('comp_rank').innerText = '#' + compRank;
        document.getElementById('comp_deals').innerText = compDeals;

        // Draw Comparison Chart
        const data = google.visualization.arrayToDataTable([
            ['Métrica', 'Nosotros', 'Competidor'],
            ['Share %', ourShare*100, compShare*100]
        ]);
        
        const options = {
            colors: ['#4285F4', '#EA4335'],
            vAxis: { minValue: 0 },
            legend: { position: 'bottom' }
        };
        
        const chart = new google.visualization.ColumnChart(document.getElementById('chart_comparator'));
        chart.draw(data, options);
    }

</script>

</body>
</html>