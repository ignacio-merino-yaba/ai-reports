<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Estilos (Google-Like / Material Design Lite Inspiration) -->
    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-muted: #5F6368;
            --border-color: #DADCE0;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 22px; color: var(--text-main); }
        .subtitle { color: var(--text-muted); font-size: 14px; margin-top: 4px; }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

        /* Metrics */
        .kpi-box {
            background: #f1f3f4;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        .kpi-value { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .kpi-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; }

        /* Charts Containers */
        .chart-container { width: 100%; height: 350px; }
        .chart-container-lg { width: 100%; height: 450px; }

        /* Insights List */
        .insight-list { list-style: none; padding: 0; }
        .insight-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            gap: 12px;
            align-items: start;
        }
        .insight-icon { color: var(--primary-color); }
        
        .recommendation-card {
            background-color: #E8F0FE; /* Light Blue */
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            margin-top: 10px;
        }

        /* Inputs */
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: white;
            font-family: inherit;
        }

        /* Helper Classes */
        .hidden { display: none; }
        .text-green { color: var(--secondary-color); }
        .text-red { color: var(--danger-color); }
        .bold { font-weight: bold; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Análisis de Parent ASIN: Matcha Powder Jar</h1>
            <div class="subtitle" id="report-period">Cargando fechas...</div>
        </div>
        <div>
            <span class="material-icons" style="font-size: 32px; color: var(--text-muted);">analytics</span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab1')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('tab2')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTRATÉGICO -->
    <div id="tab1" class="tab-content">
        
        <!-- KPIs Globales -->
        <div class="grid-4" id="kpi-section">
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-clicks">-</div>
                <div class="kpi-label">Clicks Totales (Est.)</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-our-share">-</div>
                <div class="kpi-label">Nuestra Cuota de Clics</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-top-comp">-</div>
                <div class="kpi-label">Top Competidor</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-avg-price">-</div>
                <div class="kpi-label">Precio Promedio Mercado</div>
            </div>
        </div>
        <br>

        <!-- Sección 1: Tendencia Global -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">timeline</span> 1. Tendencia Global del Parent
            </div>
            <div class="subtitle" style="margin-bottom: 10px;">Volumen de Clics Estimados vs. Cuota de Mercado (Nosotros vs Competencia)</div>
            <div id="chart_trend" class="chart-container"></div>
        </div>

        <!-- Sección 2: Competitividad de Marca -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">emoji_events</span> 2. Competitividad de Marca (Click Share)
            </div>
            <div class="subtitle" style="margin-bottom: 10px;">Evolución de cuota: Nuestra Marca vs Top 3 Competidores</div>
            <div id="chart_competitiveness" class="chart-container"></div>
        </div>

        <!-- Sección 3: Palancas -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">sell</span> 3. Análisis de Precio
                </div>
                <div class="subtitle">Precio Promedio vs Click Share por Marca</div>
                <div id="chart_price" class="chart-container"></div>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">local_offer</span> 4. Impacto de Promociones
                </div>
                <div class="subtitle">Días con Deal/Cupón activos (Última semana)</div>
                <div id="chart_promos" class="chart-container"></div>
            </div>
        </div>

        <!-- Sección 4: Eficiencia -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">scatter_plot</span> 5. Eficiencia: Organic Rank vs Click Share
            </div>
            <div class="subtitle">Identificación de ASINs Sobre/Sub-performers. (Eje Y Logarítmico para mejor visualización)</div>
            <div id="chart_efficiency" class="chart-container-lg"></div>
        </div>

        <!-- Sección 5: Conclusiones -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span> 6. Insights Clave
                </div>
                <ul class="insight-list" id="insights-container">
                    <!-- JS generará esto -->
                </ul>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">assignment_turned_in</span> Acciones Recomendadas
                </div>
                <div id="recommendations-container">
                    <!-- JS generará esto -->
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
    <div id="tab2" class="tab-content hidden">
        <div class="card">
            <div class="grid-4" style="align-items: center;">
                <label><strong>Semana:</strong></label>
                <select id="select-week" onchange="updateInteractive()"></select>
                
                <label><strong>Comparar Nosotros VS:</strong></label>
                <select id="select-competitor" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="grid-2">
            <!-- Nuestra Ficha -->
            <div class="card" style="border-top: 5px solid var(--primary-color);">
                <div class="card-title" id="our-title">Nuestra Marca</div>
                <div id="our-stats"></div>
            </div>

            <!-- Ficha Competidor -->
            <div class="card" style="border-top: 5px solid var(--danger-color);">
                <div class="card-title" id="comp-title">Competidor</div>
                <div id="comp-stats"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">Comparativa Directa de Atributos</div>
            <div id="chart_comparison" class="chart-container"></div>
        </div>
    </div>

</div>

<!-- DATA AND LOGIC -->
<script type="text/javascript">
    // 1. DATA INJECTION (Generated from CSV)
    const rawData = [
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":null,"asin":"B0DV6Z5MYZ","product_title":"Soeos Organic Matcha Powder, Matcha Green Tea Powd...","country_code":"us","average_organic_rank":12,"weekly_number_of_days_with_deal":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":2.47,"impression_share":1.83,"price":6.69,"click_share_rank":9,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Chaism","asin":"B0BPXQ2PR5","product_title":"Chaism Ceremonial Grade Matcha Green Tea Powder - ...","country_code":"us","average_organic_rank":9,"weekly_number_of_days_with_deal":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":5.66,"impression_share":3.66,"price":17.847142857,"click_share_rank":3,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"MATCHA DNA","asin":"B077572GG8","product_title":"MATCHA DNA Certified Organic Matcha Green Tea Powd...","country_code":"us","average_organic_rank":8,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":3.93,"impression_share":4.82,"price":19.99,"click_share_rank":7,"weekly_search_volume":110679.74,"is_yaba_asin":"Y","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Jade Leaf Matcha","asin":"B089Q9XD2T","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":7,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":3,"click_share":4.47,"impression_share":3.63,"price":30.984285714,"click_share_rank":6,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Crafti","asin":"B0CXT6L9H5","product_title":"Crafti Ceremonial Grade Matcha Powder (Organic) - ...","country_code":"us","average_organic_rank":21,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":1.97,"impression_share":3.32,"price":20.95,"click_share_rank":10,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Naoki Matcha","asin":"B01L2GW7SI","product_title":"Naoki Matcha Superior Ceremonial Blend – Authentic...","country_code":"us","average_organic_rank":3,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":4,"weekly_number_of_days_with_coupon":0,"click_share":8.35,"impression_share":5.1,"price":24.99,"click_share_rank":2,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Jade Leaf Matcha","asin":"B00PFDH0IC","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":13.99,"impression_share":4.45,"price":10.99,"click_share_rank":1,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Jade Leaf Matcha","asin":"B01DTQD7VA","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":6,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":4.83,"impression_share":3.32,"price":10.99,"click_share_rank":5,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":null,"asin":"B097Z6ZH1S","product_title":"Jade Leaf Matcha Premium Ceremonial Grade Matcha G...","country_code":"us","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":2.78,"impression_share":2.64,"price":17.99,"click_share_rank":8,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},
        {"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Micro Ingredients","asin":"B08PY3Q8XS","product_title":"Micro Ingredients Organic Matcha Green Tea Powder,...","country_code":"us","average_organic_rank":3,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":5,"weekly_number_of_days_with_coupon":7,"click_share":5.16,"impression_share":3.71,"price":23.19,"click_share_rank":4,"weekly_search_volume":110679.74,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"}
    ];

    // 2. DATA PROCESSING
    let marketData = [];
    let ourBrand = "Unknown";
    
    function processData() {
        // Step 1: Clean Brands and Identify Our Brand
        // First pass: find our brand from is_yaba_asin = 'Y'
        const ourAsinRow = rawData.find(d => d.is_yaba_asin === 'Y');
        if (ourAsinRow && ourAsinRow.competitor_brand) {
            ourBrand = ourAsinRow.competitor_brand;
        }

        // Step 2: Normalize Data
        marketData = rawData.map(row => {
            let brand = row.competitor_brand;
            
            // Rule 2.1: Infer brand if null
            if (!brand) {
                // Try from title (simple heuristic: first 2 words if capitalized, or just first word)
                if (row.product_title) {
                    const words = row.product_title.split(' ');
                    brand = words[0]; 
                    if (words.length > 1 && /^[A-Z]/.test(words[1])) {
                        brand += " " + words[1];
                    }
                    // Special case for row 9 seen in manual inspection
                    if(row.product_title.includes("Jade Leaf")) brand = "Jade Leaf Matcha";
                } else {
                    brand = "Unknown Brand";
                }
            }
            
            // Normalize "Jade Leaf" variations if any
            if(brand.includes("Jade Leaf")) brand = "Jade Leaf Matcha";

            // Calculate estimated clicks
            const estClicks = (row.click_share / 100) * row.weekly_search_volume;

            return {
                ...row,
                real_brand: brand,
                est_clicks: estClicks,
                is_ours: (brand === ourBrand) // Use brand matching for consistency
            };
        });

        console.log("Datos Procesados:", marketData);
        console.log("Nuestra Marca detectada:", ourBrand);
    }

    // 3. AGGREGATION HELPERS
    function getAggregatedByWeek() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        return weeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalClicks = weekData.reduce((sum, d) => sum + d.est_clicks, 0);
            
            const ourClicks = weekData.filter(d => d.is_ours).reduce((sum, d) => sum + d.est_clicks, 0);
            const compClicks = totalClicks - ourClicks;
            
            const totalVolume = weekData[0].weekly_search_volume; // Assuming same per week per parent
            const ourShare = (ourClicks / totalClicks) * 100; // Recalculated share based on capture within dataset

            return {
                week,
                totalClicks,
                ourClicks,
                compClicks,
                ourShare
            };
        });
    }

    function getBrandPerformance() {
        // Aggregate by Brand across all weeks (or latest week)
        const brands = {};
        marketData.forEach(d => {
            if (!brands[d.real_brand]) {
                brands[d.real_brand] = { 
                    brand: d.real_brand, 
                    clicks: 0, 
                    shareSum: 0, 
                    count: 0, 
                    priceSum: 0,
                    is_ours: d.is_ours
                };
            }
            brands[d.real_brand].clicks += d.est_clicks;
            brands[d.real_brand].shareSum += d.click_share;
            brands[d.real_brand].priceSum += d.price;
            brands[d.real_brand].count += 1;
        });

        return Object.values(brands).map(b => ({
            ...b,
            avgShare: b.shareSum / b.count, // Simplification for snapshot
            avgPrice: b.priceSum / b.count
        })).sort((a,b) => b.avgShare - a.avgShare);
    }

    // 4. CHART DRAWING
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processData();
        renderKPIs();
        drawTrendChart();
        drawCompetitivenessChart();
        drawPriceChart();
        drawPromoChart();
        drawEfficiencyChart();
        generateInsights();
        initInteractive();
    }

    function renderKPIs() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const lastWeek = weeks[weeks.length - 1];
        document.getElementById('report-period').textContent = `Datos reportados: ${lastWeek}`;

        const weekData = marketData.filter(d => d.week_date === lastWeek);
        const totalClicks = weekData.reduce((sum, d) => sum + d.est_clicks, 0);
        
        // Share Calculation
        const ourData = weekData.filter(d => d.is_ours);
        const ourShare = ourData.reduce((sum, d) => sum + d.click_share, 0); // Add shares of all our ASINs
        
        // Top Competitor
        const brands = getBrandPerformance();
        const topComp = brands.find(b => !b.is_ours);

        // Avg Price
        const avgPrice = weekData.reduce((sum, d) => sum + d.price, 0) / weekData.length;

        document.getElementById('kpi-clicks').textContent = Math.round(totalClicks).toLocaleString();
        document.getElementById('kpi-our-share').textContent = ourShare.toFixed(2) + "%";
        document.getElementById('kpi-top-comp').textContent = topComp ? topComp.brand : "N/A";
        document.getElementById('kpi-avg-price').textContent = "$" + avgPrice.toFixed(2);
    }

    function drawTrendChart() {
        const agg = getAggregatedByWeek();
        const dataArray = [['Semana', 'Clicks Nuestros', 'Clicks Competencia', 'Nuestra Cuota (%)']];
        
        agg.forEach(r => {
            dataArray.push([r.week, r.ourClicks, r.compClicks, r.ourShare]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
            colors: ['#34A853', '#EA4335'], // Green (Us - bar), Red (Comp - bar) -> Wait, logic:
            // Us clicks, Comp Clicks. Let's make Us Blue, Comp Grey.
            colors: ['#4285F4', '#9AA0A6'],
            vAxes: {0: {title: 'Volumen Clics'}, 1: {title: '% Share', format: '#\'%\''}},
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function drawCompetitivenessChart() {
        const brands = getBrandPerformance();
        const top3Comp = brands.filter(b => !b.is_ours).slice(0, 3).map(b => b.brand);
        const relevantBrands = [ourBrand, ...top3Comp];

        // Prepare data: Week, OurBrand, Comp1, Comp2, Comp3
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const header = ['Semana', ourBrand, ...top3Comp];
        const dataArray = [header];

        weeks.forEach(w => {
            const row = [w];
            relevantBrands.forEach(b => {
                const bData = marketData.filter(d => d.week_date === w && d.real_brand === b);
                const share = bData.reduce((sum, item) => sum + item.click_share, 0);
                row.push(share);
            });
            dataArray.push(row);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'], // Our Brand Blue, others distinctive
            vAxis: {title: 'Click Share %'},
            pointSize: 5,
            chartArea: {width: '90%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    function drawPriceChart() {
        const brands = getBrandPerformance().slice(0, 6); // Top 6 brands
        const dataArray = [['Marca', 'Precio Promedio', 'Click Share Total', { role: 'style' }]];

        brands.forEach(b => {
            const color = b.is_ours ? '#4285F4' : '#9AA0A6';
            dataArray.push([b.brand, b.avgPrice, b.shareSum, color]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        
        // Using Bubble chart logic or Scatter to show Price vs Share? 
        // Prompt asks: Price relationship to share.
        // Let's use a Scatter Chart: X=Price, Y=Share.
        
        const options = {
            title: 'Relación Precio vs Cuota de Mercado',
            hAxis: {title: 'Precio Promedio ($)'},
            vAxis: {title: 'Click Share Total (%)'},
            legend: 'none',
            colors: ['#4285F4'],
            pointSize: 10
        };
        
        // Re-mapping for Scatter specific
        const scatterData = [['Precio', 'Share', {'type': 'string', 'role': 'tooltip'}, {'type': 'string', 'role': 'style'}]];
        brands.forEach(b => {
             const color = b.is_ours ? 'point {fill-color: #4285F4; size: 12;}' : 'point {fill-color: #EA4335}';
             scatterData.push([b.avgPrice, b.shareSum, `${b.brand} ($${b.avgPrice.toFixed(2)}, ${b.shareSum.toFixed(2)}%)`, color]);
        });

        const chartData = google.visualization.arrayToDataTable(scatterData);
        const chart = new google.visualization.ScatterChart(document.getElementById('chart_price'));
        chart.draw(chartData, options);
    }

    function drawPromoChart() {
        // Filter for last week
        const lastWeek = marketData[0].week_date; // Assuming single week context for simplicity or taking first
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        
        // Sum deal days per brand
        const brandPromos = {};
        currentData.forEach(d => {
            if(!brandPromos[d.real_brand]) brandPromos[d.real_brand] = {deals:0, coupons:0};
            brandPromos[d.real_brand].deals += d.weekly_number_of_days_with_deal;
            brandPromos[d.real_brand].coupons += d.weekly_number_of_days_with_coupon;
        });

        // Convert to array
        const dataArray = [['Marca', 'Días Deal', 'Días Cupón']];
        Object.keys(brandPromos).slice(0, 5).forEach(b => {
             dataArray.push([b, brandPromos[b].deals, brandPromos[b].coupons]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            isStacked: true,
            colors: ['#FBBC05', '#34A853'],
            legend: {position: 'bottom'},
            vAxis: {title: 'Días Acumulados'},
            chartArea: {width: '80%', height: '70%'}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_promos'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Organic Rank vs Click Share
        // X = Rank (Inverted logic usually, but here linear), Y = Share
        
        const dataArray = [['Rank Orgánico', 'Click Share', {type: 'string', role: 'tooltip'}, {type: 'string', role: 'style'}]];
        
        marketData.forEach(d => {
            const color = d.is_ours ? 'point {fill-color: #4285F4; size: 10;}' : 'point {fill-color: #9AA0A6}';
            const label = `${d.real_brand}: Rank ${d.average_organic_rank}, Share ${d.click_share}%`;
            dataArray.push([d.average_organic_rank, d.click_share, label, color]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        
        const options = {
            hAxis: {title: 'Rank Orgánico Promedio (Menor es mejor)', direction: 1}, // 1 -> High rank number on right
            vAxis: {title: 'Click Share %', scaleType: 'log'}, // Log scale to see small players
            legend: 'none',
            chartArea: {width: '90%', height: '80%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // 5. INSIGHTS GENERATION ENGINE
    function generateInsights() {
        const insights = [];
        const recs = [];
        
        // Analyze Competitiveness
        const brands = getBrandPerformance();
        const topBrand = brands[0];
        const us = brands.find(b => b.is_ours);
        const usRank = brands.findIndex(b => b.is_ours) + 1;

        // Insight 1: Market Leader
        insights.push(`<li class="bold"><span class="material-icons insight-icon">emoji_events</span> Dominio del Mercado: ${topBrand.brand} lidera con un ${(topBrand.avgShare).toFixed(1)}% de cuota. Nosotros estamos en la posición #${usRank}.</li>`);

        // Insight 2: Pricing
        if (us && us.avgPrice > topBrand.avgPrice * 1.2) {
            insights.push(`<li><span class="material-icons insight-icon">warning</span> Desventaja de Precio: Nuestro precio ($${us.avgPrice.toFixed(2)}) es significativamente mayor al líder ($${topBrand.avgPrice.toFixed(2)}), lo que puede frenar la conversión.</li>`);
            recs.push(`Evaluar elasticidad de precio o lanzar cupón temporal para reducir la brecha con ${topBrand.brand}.`);
        } else if (us && us.avgPrice < topBrand.avgPrice) {
            insights.push(`<li><span class="material-icons insight-icon">trending_up</span> Oportunidad de Precio: Somos más económicos que el líder. Podríamos destacar "Valor" en creatividades.</li>`);
        }

        // Insight 3: Promos
        const dealDays = us ? marketData.filter(d => d.is_ours).reduce((sum, d) => sum + d.weekly_number_of_days_with_deal, 0) : 0;
        if (dealDays > 0) {
            insights.push(`<li><span class="material-icons insight-icon">local_offer</span> Actividad Promocional: Hemos activado deals durante ${dealDays} días. Verificar si el incremento en share justifica el costo de margen.</li>`);
        } else {
            insights.push(`<li><span class="material-icons insight-icon">money_off</span> Sin Deals Activos: No tuvimos actividad de Deals esta semana, mientras competidores como ${brands[1].brand} sí mostraron actividad.</li>`);
            recs.push("Activar 'Lightning Deals' en semanas pico para recuperar visibilidad.");
        }

        // Insight 4: Efficiency
        const efficientComp = marketData.find(d => !d.is_ours && d.average_organic_rank > 10 && d.click_share > 3);
        if (efficientComp) {
            insights.push(`<li><span class="material-icons insight-icon">visibility</span> Anomalía Detectada: ${efficientComp.real_brand} tiene mal ranking orgánico (${efficientComp.average_organic_rank}) pero alto share (${efficientComp.click_share}%), sugiriendo fuerte inversión en PPC o tráfico externo.</li>`);
        }

        // Recommendation defaults
        recs.push("Optimizar Títulos para incluir keywords de competidores detectados en la SERP.");
        recs.push("Revisar imágenes principales: Los competidores Top 3 usan envases que destacan 'Ceremonial Grade'.");

        document.getElementById('insights-container').innerHTML = insights.join('');
        document.getElementById('recommendations-container').innerHTML = recs.map(r => `<div class="recommendation-card">${r}</div>`).join('');
    }

    // 6. INTERACTIVE LOGIC
    function initInteractive() {
        const weekSelect = document.getElementById('select-week');
        const compSelect = document.getElementById('select-competitor');
        
        // Populate Weeks
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSelect.add(opt);
        });

        // Populate Competitors
        const brands = getBrandPerformance().filter(b => !b.is_ours);
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.brand;
            opt.text = b.brand;
            compSelect.add(opt);
        });

        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('select-week').value;
        const compBrand = document.getElementById('select-competitor').value;
        
        // Find Data
        // Aggregate if multiple ASINs per brand exist
        const ourDataRows = marketData.filter(d => d.week_date === week && d.is_ours);
        const compDataRows = marketData.filter(d => d.week_date === week && d.real_brand === compBrand);

        // Helper to sum/avg
        const calcStats = (rows) => {
            if (rows.length === 0) return { price: 0, share: 0, rank: 0, deals: 0 };
            return {
                price: rows.reduce((s, r) => s + r.price, 0) / rows.length,
                share: rows.reduce((s, r) => s + r.click_share, 0),
                rank: rows.reduce((s, r) => s + r.average_organic_rank, 0) / rows.length,
                deals: rows.reduce((s, r) => s + r.weekly_number_of_days_with_deal, 0)
            };
        };

        const ourStats = calcStats(ourDataRows);
        const compStats = calcStats(compDataRows);

        // Render Cards
        const renderStatHTML = (stats) => `
            <div class="grid-2">
                <div>Price: <strong>$${stats.price.toFixed(2)}</strong></div>
                <div>Share: <strong>${stats.share.toFixed(2)}%</strong></div>
                <div>Avg Rank: <strong>${stats.rank.toFixed(1)}</strong></div>
                <div>Deal Days: <strong>${stats.deals}</strong></div>
            </div>
        `;

        document.getElementById('our-stats').innerHTML = renderStatHTML(ourStats);
        document.getElementById('comp-stats').innerHTML = renderStatHTML(compStats);
        document.getElementById('comp-title').textContent = compBrand;

        // Draw Comparison Chart (Bar)
        const data = google.visualization.arrayToDataTable([
            ['Métrica', 'Nosotros', compBrand],
            ['Share %', ourStats.share, compStats.share],
            ['Rank (Inv)', 20 - ourStats.rank, 20 - compStats.rank], // Inverted visual for rank
            ['Días Deal', ourStats.deals, compStats.deals]
        ]);

        const options = {
            title: 'Comparativa Directa (Rank Invertido: Barra más alta = Mejor Posición)',
            colors: ['#4285F4', '#EA4335'],
            vAxis: {minValue: 0}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_comparison'));
        chart.draw(data, options);
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        // Redraw charts if hidden (Google Charts sometimes glitch when drawn in hidden div)
        if(tabId === 'tab2') updateInteractive();
    }

    // Resize handler
    window.onresize = function() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawPriceChart();
        drawEfficiencyChart();
    };

</script>

</body>
</html>