<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de AnÃ¡lisis Parent ASIN - NaturaleBio</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Custom CSS for Apple-like Design within Google constraints -->
    <style>
        :root {
            --primary-color: #007AFF; /* Apple Blue */
            --success-color: #34C759; /* Apple Green */
            --danger-color: #FF3B30; /* Apple Red */
            --bg-color: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --border-radius: 20px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }
        .header p {
            color: var(--text-secondary);
            margin: 5px 0 0 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(118, 118, 128, 0.12);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 24px;
        }
        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Content Sections */
        .section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: none; /* Hidden by default, toggled by JS */
        }
        .section.active {
            display: block;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .metric-card {
            background: var(--bg-color);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 400px;
        }

        /* Insights List */
        .insights-list {
            list-style: none;
            padding: 0;
        }
        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #E5E5E5;
            display: flex;
            gap: 12px;
            align-items: start;
        }
        .insights-list li:last-child {
            border-bottom: none;
        }
        .icon-box {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
            padding: 4px;
            border-radius: 6px;
            display: flex;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--bg-color);
            padding: 16px;
            border-radius: 12px;
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #D1D1D6;
            background: white;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>AnÃ¡lisis de Mercado Parent ASIN</h1>
            <p>Parent: Matcha Premium | Market: DE</p>
        </div>
        <div style="text-align: right;">
            <p id="date-range">Cargando fechas...</p>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte EstratÃ©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÃ‘A 1: REPORTE ESTRATÃ‰GICO -->
    <div id="tab-static" class="tab-content">
        
        <!-- 1. Tendencia Global -->
        <div class="section active">
            <div class="section-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                AnÃ¡lisis de volumen de clics y cuota de mercado (Click Share) de las Ãºltimas semanas.
            </p>
            <div id="chart_global_trend" class="chart-box"></div>
            <div class="grid-2" style="margin-top: 20px;">
                <div class="metric-card">
                    <div id="metric-total-share" class="metric-value">-</div>
                    <div class="metric-label">Nuestro Share (Ãšltima Sem)</div>
                </div>
                <div class="metric-card">
                    <div id="metric-growth" class="metric-value">-</div>
                    <div class="metric-label">Tendencia vs Sem Anterior</div>
                </div>
            </div>
        </div>

        <!-- 2. Competitividad de Marca -->
        <div class="section active">
            <div class="section-title">
                <span class="material-icons">emoji_events</span>
                2. Competitividad de Marca
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                EvoluciÃ³n del Click Share: Nuestra Marca vs Top 3 Competidores.
            </p>
            <div id="chart_brand_comp" class="chart-box"></div>
        </div>

        <!-- 3. Palancas -->
        <div class="section active">
            <div class="section-title">
                <span class="material-icons">tune</span>
                3. Palancas de Click Share
            </div>
            <div class="grid-2">
                <div id="chart_price_impact" class="chart-box" style="height: 300px;"></div>
                <div>
                    <h4>Impacto de Badges (Share Promedio)</h4>
                    <div id="table_badges" style="width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- 4. Eficiencia -->
        <div class="section active">
            <div class="section-title">
                <span class="material-icons">radar</span>
                4. Eficiencia (Rank vs Click Share)
            </div>
            <p style="color: var(--text-secondary);">
                Eje X: Ranking OrgÃ¡nico (Menos es mejor) | Eje Y: Click Share.
                <br>Bubbles arriba a la izquierda = Alta Eficiencia.
            </p>
            <div id="chart_efficiency" class="chart-box"></div>
        </div>

        <!-- 5. Insights y Recomendaciones -->
        <div class="section active" style="border-left: 4px solid var(--primary-color);">
            <div class="section-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones y Recomendaciones
            </div>
            <div class="grid-2">
                <div>
                    <h3><span class="material-icons" style="font-size:16px; vertical-align:middle;">analytics</span> Insights Clave</h3>
                    <ul class="insights-list" id="insights-container">
                        <!-- Filled by JS -->
                    </ul>
                </div>
                <div>
                    <h3><span class="material-icons" style="font-size:16px; vertical-align:middle;">rocket_launch</span> Recomendaciones</h3>
                    <ul class="insights-list" id="recommendations-container">
                        <!-- Filled by JS -->
                    </ul>
                </div>
            </div>
        </div>
        
         <!-- 6. Other Insights -->
        <div class="section active">
            <div class="section-title">
                <span class="material-icons">travel_explore</span>
                6. Other Insights (Observaciones Adicionales)
            </div>
            <ul class="insights-list" id="other-insights-container">
                <!-- Filled by JS -->
            </ul>
        </div>

    </div>

    <!-- PESTAÃ‘A 2: INTERACTIVO -->
    <div id="tab-interactive" class="tab-content" style="display: none;">
        <div class="section active">
            <div class="section-title">Comparador Cara a Cara</div>
            
            <div class="controls">
                <div>
                    <label>Semana:</label>
                    <select id="sel-week" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label>Competidor:</label>
                    <select id="sel-comp" onchange="updateInteractive()"></select>
                </div>
            </div>

            <div class="grid-2">
                <div class="metric-card">
                    <div id="int-our-price" class="metric-value">-</div>
                    <div class="metric-label">Nuestro Precio Medio</div>
                </div>
                <div class="metric-card">
                    <div id="int-comp-price" class="metric-value">-</div>
                    <div class="metric-label">Precio Competidor</div>
                </div>
            </div>

            <br>
            <div id="table_interactive" style="width: 100%;"></div>
        </div>
    </div>

</div>

<script>
// ============================================================================
// 1. DATA INJECTION & INITIALIZATION
// ============================================================================
const rawData = [{"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.08, "impression_share": 3.95, "price": 11.9975, "click_share_rank": 8, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.08, "impression_share": 3.95, "price": 11.9975, "click_share_rank": 8, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 3.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 12.72, "impression_share": 3.41, "price": 24.605714286, "click_share_rank": 2, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 14.01, "impression_share": 3.49, "price": 23.91, "click_share_rank": 2, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 14.83, "impression_share": 3.52, "price": 24.602857143, "click_share_rank": 1, "weekly_search_volume": 34399.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B0G1T7N675", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "country_code": "de", "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.51, "impression_share": 3.67, "price": 9.112857143, "click_share_rank": 10, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B0G1T7N675", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "country_code": "de", "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.38, "impression_share": 4.47, "price": 12.447142857, "click_share_rank": 10, "weekly_search_volume": 34399.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 5.96, "impression_share": 4.35, "price": 16.01, "click_share_rank": 3, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 5.96, "impression_share": 4.35, "price": 16.01, "click_share_rank": 3, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 6.01, "impression_share": 4.41, "price": 15.5575, "click_share_rank": 3, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 6.01, "impression_share": 4.41, "price": 15.5575, "click_share_rank": 3, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 5.94, "impression_share": 4.43, "price": 16.008571429, "click_share_rank": 3, "weekly_search_volume": 34399.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 5.94, "impression_share": 4.43, "price": 16.008571429, "click_share_rank": 3, "weekly_search_volume": 34399.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 15.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "click_share": 3.51, "impression_share": 4.76, "price": 10.39, "click_share_rank": 6, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 15.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "click_share": 3.51, "impression_share": 4.76, "price": 10.39, "click_share_rank": 6, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 15.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 4.07, "impression_share": 5.02, "price": 10.69, "click_share_rank": 6, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 15.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 4.07, "impression_share": 5.02, "price": 10.69, "click_share_rank": 6, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 4.12, "impression_share": 5.51, "price": 10.69, "click_share_rank": 6, "weekly_search_volume": 34399.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 4.12, "impression_share": 5.51, "price": 10.69, "click_share_rank": 6, "weekly_search_volume": 34399.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 0.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.69, "impression_share": 2.28, "price": 30.27, "click_share_rank": 10, "weekly_search_volume": 27752.13, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 25.0, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.75, "impression_share": 2.58, "price": 30.562857143, "click_share_rank": 9, "weekly_search_volume": 34399.4, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.27, "impression_share": 3.29, "price": 23.63, "click_share_rank": 8, "weekly_search_volume": 44658.96, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 1.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 13.42, "impression_share": 3.43, "price": 14.435714286, "click_share_rank": 1, "weekly_search_volume": 44658.96, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 5.03, "impression_share": 3.44, "price": 9.445714286, "click_share_rank": 4, "weekly_search_volume": 44658.96, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.96, "impression_share": 3.45, "price": 10.2225, "click_share_rank": 4, "weekly_search_volume": 27752.13, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.5, "impression_share": 3.48, "price": 24.5275, "click_share_rank": 7, "weekly_search_volume": 27752.13, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 1.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 14.75, "impression_share": 3.5, "price": 14.6075, "click_share_rank": 1, "weekly_search_volume": 27752.13, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.98, "impression_share": 3.51, "price": 24.737142857, "click_share_rank": 7, "weekly_search_volume": 34399.4, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 5.19, "impression_share": 3.53, "price": 10.518571429, "click_share_rank": 5, "weekly_search_volume": 34399.4, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 1.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 14.3, "impression_share": 3.54, "price": 15.031428571, "click_share_rank": 2, "weekly_search_volume": 34399.4, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "TEA Uniq\u014d", "asin": "B0912DKFK5", "product_title": "Tea Uniqo \u2013 Premium Matcha Pulver \u2013 Ideal zum Trin...", "country_code": "de", "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.83, "impression_share": 4.82, "price": 12.884285714, "click_share_rank": 7, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 8.0, "weekly_number_of_days_with_deal": 5.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.83, "impression_share": 5.5, "price": 9.157142857, "click_share_rank": 5, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 8.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.79, "impression_share": 5.94, "price": 10.43, "click_share_rank": 5, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 5.4, "impression_share": 5.97, "price": 9.727142857, "click_share_rank": 4, "weekly_search_volume": 34399.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha pulver", "competitor_brand": "VAHDAM", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "country_code": "de", "average_organic_rank": 22.0, "weekly_number_of_days_with_deal": 5.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.62, "impression_share": 2.67, "price": 9.242857143, "click_share_rank": 9, "weekly_search_volume": 44658.96, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha pulver", "competitor_brand": "VAHDAM", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "country_code": "de", "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.49, "impression_share": 4.67, "price": 9.727142857, "click_share_rank": 8, "weekly_search_volume": 34399.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha pulver", "competitor_brand": "VAHDAM", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "country_code": "de", "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.74, "impression_share": 4.94, "price": 10.43, "click_share_rank": 9, "weekly_search_volume": 27752.13, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha+pulver"}];

// Configuration
google.charts.load('current', {'packages':['corechart', 'table']});
google.charts.setOnLoadCallback(initDashboard);

// Global state
let processedData = [];
let ourBrand = "";
let topCompetitors = [];
let allWeeks = [];

function initDashboard() {
    processData();
    updateDateRange();
    drawGlobalTrend();
    drawBrandComp();
    drawEfficiency();
    drawPriceImpact();
    renderBadgesTable();
    generateInsights();
    
    // Setup Interactive Tab
    setupInteractiveControls();
}

function processData() {
    // 1. Determine Our Brand (is_yaba_asin = 'Y')
    const ourBrandRow = rawData.find(r => r.is_yaba_asin === 'Y');
    ourBrand = ourBrandRow ? ourBrandRow.competitor_brand : "Our Brand";

    // 2. Clean & Augment
    processedData = rawData.map(r => {
        let brand = r.competitor_brand;
        if (!brand || brand.trim() === "") {
            // Fallback to title
            brand = r.product_title.split(' ')[0] || "Unknown Brand";
        }
        
        return {
            ...r,
            real_brand: brand,
            estimated_clicks: r.weekly_search_volume * (r.click_share / 100),
            is_us: r.is_yaba_asin === 'Y'
        };
    });

    // 3. Identify Top Competitors (by total estimated clicks)
    const brandClicks = {};
    processedData.forEach(r => {
        if (r.real_brand === ourBrand) return;
        brandClicks[r.real_brand] = (brandClicks[r.real_brand] || 0) + r.estimated_clicks;
    });
    
    topCompetitors = Object.entries(brandClicks)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 3)
        .map(e => e[0]);

    // 4. Extract Unique Weeks
    allWeeks = [...new Set(processedData.map(r => r.week_date))].sort();
}

function updateDateRange() {
    if(allWeeks.length > 0) {
        document.getElementById('date-range').innerText = `Periodo: ${allWeeks[0]} - ${allWeeks[allWeeks.length-1]}`;
    }
}

// ============================================================================
// 2. CHARTS LOGIC
// ============================================================================

function drawGlobalTrend() {
    const dataTable = new google.visualization.DataTable();
    dataTable.addColumn('string', 'Semana');
    dataTable.addColumn('number', 'Clicks Competencia');
    dataTable.addColumn('number', 'Clicks Nuestros');
    dataTable.addColumn('number', 'Nuestro Share (%)');

    allWeeks.forEach(week => {
        const weekData = processedData.filter(d => d.week_date === week);
        const ourClicks = weekData.filter(d => d.is_us).reduce((acc, c) => acc + c.estimated_clicks, 0);
        const compClicks = weekData.filter(d => !d.is_us).reduce((acc, c) => acc + c.estimated_clicks, 0);
        
        const totalClicks = ourClicks + compClicks;
        const share = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
        
        dataTable.addRow([week, compClicks, ourClicks, share]);
    });

    const options = {
        title: 'EvoluciÃ³n de Clicks Totales y Cuota de Mercado',
        vAxes: {
            0: {title: 'Volumen de Clicks', format: 'short'},
            1: {title: 'Click Share (%)', format: '#\'%\'', minValue: 0}
        },
        hAxis: {title: 'Semana'},
        seriesType: 'bars',
        series: {
            0: {color: '#86868B'}, // Gray for competitors
            1: {color: '#007AFF'}, // Blue for us
            2: {type: 'line', targetAxisIndex: 1, color: '#34C759', lineWidth: 3} // Green line for share
        },
        legend: {position: 'bottom'},
        animation: { startup: true, duration: 1000, easing: 'out' }
    };

    const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
    chart.draw(dataTable, options);

    // Update Metrics
    const lastRow = dataTable.getNumberOfRows() - 1;
    if (lastRow >= 0) {
        document.getElementById('metric-total-share').innerText = dataTable.getValue(lastRow, 3).toFixed(2) + '%';
        
        if (lastRow > 0) {
            const prevShare = dataTable.getValue(lastRow-1, 3);
            const currShare = dataTable.getValue(lastRow, 3);
            const diff = currShare - prevShare;
            const el = document.getElementById('metric-growth');
            el.innerText = (diff > 0 ? "+" : "") + diff.toFixed(2) + " pp";
            el.style.color = diff >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        }
    }
}

function drawBrandComp() {
    const dataTable = new google.visualization.DataTable();
    dataTable.addColumn('string', 'Semana');
    dataTable.addColumn('number', ourBrand);
    topCompetitors.forEach(comp => dataTable.addColumn('number', comp));
    dataTable.addColumn('number', 'Resto');

    allWeeks.forEach(week => {
        const weekData = processedData.filter(d => d.week_date === week);
        const totalVol = weekData.reduce((sum, d) => sum + d.weekly_search_volume, 0); // Approx total volume base
        // Note: Click Share is per keyword, we need to weight it. 
        // Aggregated Share = Sum(clicks) / Sum(Volume of Keywords) is tricky if keywords overlap.
        // Simplified: Sum of Click Share weighted by Volume? 
        // Better: Sum(Estimated Clicks) / Total Estimated Clicks of the group * 100?
        // Let's use Sum(Estimated Clicks) relative to Week Total Clicks.
        
        const totalClicks = weekData.reduce((acc, c) => acc + c.estimated_clicks, 0);
        
        const row = [week];
        
        // Us
        const ourClicks = weekData.filter(d => d.real_brand === ourBrand)
                                  .reduce((acc, c) => acc + c.estimated_clicks, 0);
        row.push(totalClicks ? (ourClicks/totalClicks)*100 : 0);
        
        // Top Comps
        topCompetitors.forEach(comp => {
            const cClicks = weekData.filter(d => d.real_brand === comp)
                                    .reduce((acc, c) => acc + c.estimated_clicks, 0);
            row.push(totalClicks ? (cClicks/totalClicks)*100 : 0);
        });
        
        // Rest
        const restClicks = weekData.filter(d => d.real_brand !== ourBrand && !topCompetitors.includes(d.real_brand))
                                   .reduce((acc, c) => acc + c.estimated_clicks, 0);
        row.push(totalClicks ? (restClicks/totalClicks)*100 : 0);
        
        dataTable.addRow(row);
    });

    const options = {
        curveType: 'function',
        legend: { position: 'bottom' },
        vAxis: { title: 'Click Share Real (%)' },
        lineWidth: 3,
        colors: ['#007AFF', '#FF3B30', '#FF9500', '#AF52DE', '#8E8E93'] // Our Blue, then Comps
    };

    const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
    chart.draw(dataTable, options);
}

function drawPriceImpact() {
    // Scatter plot: Price (X) vs Share (Y)
    const dataTable = new google.visualization.DataTable();
    dataTable.addColumn('number', 'Precio (â‚¬)');
    dataTable.addColumn('number', 'Click Share (%)');
    dataTable.addColumn({type: 'string', role: 'tooltip'});
    dataTable.addColumn({type: 'string', role: 'style'}); // Color

    const lastWeek = allWeeks[allWeeks.length - 1];
    const weekData = processedData.filter(d => d.week_date === lastWeek);

    weekData.forEach(d => {
        const color = d.real_brand === ourBrand ? '#007AFF' : '#C7C7CC';
        const tooltip = `${d.real_brand}\nâ‚¬${d.price.toFixed(2)} | ${d.click_share.toFixed(2)}%`;
        dataTable.addRow([d.price, d.click_share, tooltip, `point { fill-color: ${color}; }`]);
    });

    const options = {
        title: `RelaciÃ³n Precio vs Click Share (${lastWeek})`,
        hAxis: {title: 'Precio (â‚¬)'},
        vAxis: {title: 'Click Share (%)'},
        legend: 'none',
        pointSize: 10
    };

    const chart = new google.visualization.ScatterChart(document.getElementById('chart_price_impact'));
    chart.draw(dataTable, options);
}

function renderBadgesTable() {
    // Calculate avg share with and without deals for US vs Competitors
    const stats = {
        us: { deal: [], noDeal: [] },
        comp: { deal: [], noDeal: [] }
    };

    processedData.forEach(d => {
        const target = d.is_us ? stats.us : stats.comp;
        if (d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0) {
            target.deal.push(d.click_share);
        } else {
            target.noDeal.push(d.click_share);
        }
    });

    const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : '-';

    const html = `
        <table style="width:100%; text-align: left; border-collapse: collapse; font-size: 14px;">
            <tr style="border-bottom: 1px solid #eee; color: #888;">
                <th style="padding: 8px;">Grupo</th>
                <th>Sin PromociÃ³n</th>
                <th>Con Deal/CupÃ³n</th>
                <th>Impacto</th>
            </tr>
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px; font-weight: bold; color: var(--primary-color);">Nuestra Marca</td>
                <td>${avg(stats.us.noDeal)}%</td>
                <td>${avg(stats.us.deal)}%</td>
                <td>${ stats.us.deal.length && stats.us.noDeal.length ? 
                     ((avg(stats.us.deal) - avg(stats.us.noDeal)) > 0 ? 'ðŸŸ¢ Positivo' : 'ðŸ”´ Neutro') : 'N/A' }</td>
            </tr>
            <tr>
                <td style="padding: 12px; font-weight: bold; color: #666;">Competencia</td>
                <td>${avg(stats.comp.noDeal)}%</td>
                <td>${avg(stats.comp.deal)}%</td>
                <td>${ stats.comp.deal.length && stats.comp.noDeal.length ? 
                     ((avg(stats.comp.deal) - avg(stats.comp.noDeal)) > 0 ? 'ðŸŸ¢ Positivo' : 'ðŸ”´ Neutro') : 'N/A' }</td>
            </tr>
        </table>
    `;
    document.getElementById('table_badges').innerHTML = html;
}

function drawEfficiency() {
    const dataTable = new google.visualization.DataTable();
    dataTable.addColumn('number', 'Organic Rank');
    dataTable.addColumn('number', 'Click Share (%)');
    dataTable.addColumn({type: 'string', role: 'tooltip'});
    dataTable.addColumn({type: 'string', role: 'style'});

    processedData.forEach(d => {
        if(d.week_date === allWeeks[allWeeks.length-1]) {
            const color = d.is_us ? '#007AFF' : (topCompetitors.includes(d.real_brand) ? '#FF3B30' : '#E5E5EA');
            const stroke = d.is_us ? 'stroke-width: 2; stroke-color: #0040DD' : '';
            dataTable.addRow([d.average_organic_rank, d.click_share, `${d.real_brand}: Rank ${d.average_organic_rank}`, `point { fill-color: ${color}; ${stroke} }`]);
        }
    });

    const options = {
        title: 'Eficiencia: Organic Rank vs Click Share',
        hAxis: {title: 'Rank OrgÃ¡nico (Invertido)', direction: -1}, // Better rank left
        vAxis: {title: 'Click Share (%)'},
        legend: 'none',
        pointSize: 12,
        chartArea: {left: 50, top: 50, width: '80%', height: '70%'}
    };

    const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
    chart.draw(dataTable, options);
}

// ============================================================================
// 3. INSIGHTS GENERATION (Basic Rule-Based)
// ============================================================================
function generateInsights() {
    // Simple logic to generate text based on aggregated data
    const lastWeek = allWeeks[allWeeks.length-1];
    const prevWeek = allWeeks[allWeeks.length-2];
    
    // Get Shares
    const getShare = (w, brand) => {
        const weekData = processedData.filter(d => d.week_date === w);
        const total = weekData.reduce((a,c)=>a+c.estimated_clicks,0);
        const brandClicks = weekData.filter(d=>d.real_brand===brand).reduce((a,c)=>a+c.estimated_clicks,0);
        return total ? (brandClicks/total)*100 : 0;
    };

    const ourLastShare = getShare(lastWeek, ourBrand);
    const ourPrevShare = getShare(prevWeek, ourBrand);
    const topCompName = topCompetitors[0];
    const topCompShare = getShare(lastWeek, topCompName);

    const insights = [
        `Tendencia: Nuestra marca ${ourLastShare > ourPrevShare ? "ganÃ³" : "perdiÃ³"} tracciÃ³n en la Ãºltima semana (${ourPrevShare.toFixed(1)}% â†’ ${ourLastShare.toFixed(1)}%).`,
        `Liderazgo: El principal competidor es ${topCompName} con un ${topCompShare.toFixed(1)}% de share.`,
        `Precio: Nuestros productos oscilan entre 10-25â‚¬, compitiendo en el segmento medio.`,
        `Eficiencia: ${ourLastShare > 10 ? "Tenemos ASINs muy eficientes (Top Share)." : "Nuestra eficiencia es moderada, dependiendo de rankings medios."}`,
        `Visibilidad: La presencia de Deals en competidores como VAHDAM impacta fuertemente la categorÃ­a.`
    ];

    const recs = [
        "Revisar precios en ASINs donde el competidor directo tiene ofertas activas.",
        "Potenciar cupones en semanas sin Deals para recuperar Share perdido.",
        "Analizar keywords donde tenemos buen rank orgÃ¡nico pero bajo share (baja conversiÃ³n)."
    ];
    
    const others = [
        "Se observa una caÃ­da estacional general post-Navidad (W01).",
        "Competidores emergentes como 'Special Leaves' estÃ¡n ganando terreno en el segmento bajo precio."
    ];

    document.getElementById('insights-container').innerHTML = insights.map(i => `<li><div class="icon-box"><span class="material-icons" style="font-size: 18px">info</span></div><div>${i}</div></li>`).join('');
    document.getElementById('recommendations-container').innerHTML = recs.map(i => `<li><div class="icon-box" style="background: rgba(52, 199, 89, 0.1); color: var(--success-color);"><span class="material-icons" style="font-size: 18px">check_circle</span></div><div>${i}</div></li>`).join('');
    document.getElementById('other-insights-container').innerHTML = others.map(i => `<li><div class="icon-box" style="background: rgba(255, 149, 0, 0.1); color: #FF9500;"><span class="material-icons" style="font-size: 18px">visibility</span></div><div>${i}</div></li>`).join('');
}

// ============================================================================
// 4. INTERACTIVE TAB
// ============================================================================

function setupInteractiveControls() {
    // Populate Weeks
    const selWeek = document.getElementById('sel-week');
    allWeeks.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.text = w;
        selWeek.add(opt);
    });
    // Set last week default
    selWeek.value = allWeeks[allWeeks.length-1];

    // Populate Competitors
    const selComp = document.getElementById('sel-comp');
    topCompetitors.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.text = c;
        selComp.add(opt);
    });

    updateInteractive();
}

function updateInteractive() {
    const week = document.getElementById('sel-week').value;
    const comp = document.getElementById('sel-comp').value;

    // Filter Data
    const weekData = processedData.filter(d => d.week_date === week);
    const ourData = weekData.filter(d => d.is_us);
    const compData = weekData.filter(d => d.real_brand === comp);

    // Metrics
    const avgPrice = arr => arr.length ? (arr.reduce((a,b)=>a+b.price,0)/arr.length).toFixed(2) : '-';
    document.getElementById('int-our-price').innerText = 'â‚¬' + avgPrice(ourData);
    document.getElementById('int-comp-price').innerText = 'â‚¬' + avgPrice(compData);

    // Table
    const dataTable = new google.visualization.DataTable();
    dataTable.addColumn('string', 'MÃ©trica');
    dataTable.addColumn('number', ourBrand);
    dataTable.addColumn('number', comp);
    dataTable.addColumn('string', 'Dif');

    // Aggregate key metrics
    const getMetric = (arr, key) => arr.reduce((a,b)=>a+b[key],0); // Sum
    const getAvg = (arr, key) => arr.length ? arr.reduce((a,b)=>a+b[key],0)/arr.length : 0; // Avg

    const metrics = [
        {label: 'Share Total (%)', key: 'click_share', type: 'sum'},
        {label: 'Rank Promedio', key: 'average_organic_rank', type: 'avg'},
        {label: 'DÃ­as con Deal', key: 'weekly_number_of_days_with_deal', type: 'max'}
    ];

    metrics.forEach(m => {
        let valUs = 0, valComp = 0;
        if (m.type === 'sum') {
            // Recalculate share relative to total is tricky here, just sum click share points for now as proxy
            valUs = getMetric(ourData, m.key);
            valComp = getMetric(compData, m.key);
        } else if (m.type === 'avg') {
            valUs = getAvg(ourData, m.key);
            valComp = getAvg(compData, m.key);
        } else {
             valUs = Math.max(...ourData.map(d=>d[m.key] || 0), 0);
             valComp = Math.max(...compData.map(d=>d[m.key] || 0), 0);
        }

        const diff = valUs - valComp;
        dataTable.addRow([m.label, valUs, valComp, diff.toFixed(1)]);
    });

    const table = new google.visualization.Table(document.getElementById('table_interactive'));
    table.draw(dataTable, {showRowNumber: false, width: '100%', height: '100%'});
}

// Helpers
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(`tab-${tabName}`).style.display = 'block';
    event.target.classList.add('active');
    
    // Redraw charts if hidden previously to fix size
    if(tabName === 'static') {
        drawGlobalTrend();
        drawBrandComp();
    } else {
        updateInteractive();
    }
}
</script>

</body>
</html>