<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Rendimiento ASIN - NaturaleBio</title>
    
    <!-- External Dependencies (Google Native) -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Reset & Variables */
        :root {
            --primary: #4285F4;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray-50: #F8F9FA;
            --gray-100: #F1F3F4;
            --gray-200: #E8EAED;
            --gray-800: #202124;
            --text-main: #3C4043;
            --text-light: #5F6368;
            --shadow-card: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        h2 {
            font-size: 18px;
            color: var(--text-main);
            margin-bottom: 16px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 12px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 1px 2px rgba(66, 133, 244, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-card);
        }

        .kpi-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .kpi-label {
            font-size: 13px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights Section */
        .insights-container {
            background-color: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-card);
            border-left: 5px solid var(--primary);
        }

        .insight-item {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .recommendation-container {
            background-color: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-card);
            border-left: 5px solid var(--success);
            margin-top: 20px;
        }

        .material-icons {
            font-size: 20px;
            vertical-align: text-bottom;
        }

        .icon-primary { color: var(--primary); }
        .icon-success { color: var(--success); }

        /* Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-card);
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            outline: none;
        }

        /* Comparison Table */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-100); }
        th { font-weight: 600; color: var(--text-light); font-size: 12px; }
        
        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 300px;
        }

        .badge-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-our { background-color: #E8F0FE; color: var(--primary); }
        .badge-comp { background-color: #FCE8E6; color: var(--danger); }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Análisis de Parent ASIN</h1>
            <span style="color: var(--text-light); font-size: 14px;">Market Intelligence Report &bull; NaturaleBio</span>
        </div>
        <div>
            <span class="badge-pill badge-our">Última Actualización: 2026-01-03</span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: DASHBOARD ESTRATÉGICO -->
    <div id="dashboard" class="tab-content active">
        
        <!-- KPIs Globales -->
        <div class="grid-3">
            <div class="card kpi-card">
                <div>
                    <div class="kpi-label">Click Share (Nosotros)</div>
                    <div class="kpi-value" id="kpi-share">23.3%</div>
                </div>
                <span class="material-icons icon-primary" style="font-size: 36px;">pie_chart</span>
            </div>
            <div class="card kpi-card">
                <div>
                    <div class="kpi-label">Posición Orgánica Media</div>
                    <div class="kpi-value" id="kpi-rank">2.0</div>
                </div>
                <span class="material-icons icon-success" style="font-size: 36px;">leaderboard</span>
            </div>
            <div class="card kpi-card">
                <div>
                    <div class="kpi-label">Competitividad Precio</div>
                    <div class="kpi-value" style="color: var(--success);">-18.8%</div>
                    <div style="font-size: 12px; color: var(--text-light);">vs. Promedio Mercado</div>
                </div>
                <span class="material-icons icon-success" style="font-size: 36px;">sell</span>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid-2">
            <div class="card">
                <h2>Tendencia Global: Clicks & Share</h2>
                <div id="chart_trend" class="chart-box"></div>
                <p style="font-size: 12px; color: var(--text-light); margin-top: 10px;">
                    Comparativa de volumen total (barras) vs nuestra cuota de mercado (línea).
                </p>
            </div>
            <div class="card">
                <h2>Competitividad de Marca (Click Share)</h2>
                <div id="chart_competitiveness" class="chart-box"></div>
                <p style="font-size: 12px; color: var(--text-light); margin-top: 10px;">
                    Evolución de cuota frente a Top 3 competidores.
                </p>
            </div>
        </div>

        <!-- Efficiency Chart -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>Matriz de Eficiencia: Rank Orgánico vs Click Share</h2>
            <div id="chart_efficiency" class="chart-box" style="height: 400px;"></div>
            <p style="font-size: 12px; color: var(--text-light); margin-top: 10px;">
                <strong>Eje X:</strong> Ranking Orgánico (Invertido, mejor rank a la derecha). <strong>Eje Y:</strong> % Click Share.
                <br>Las burbujas superiores derecha son los "High Performers".
            </p>
        </div>

        <!-- Insights Text Section -->
        <div class="grid-2">
            <div class="insights-container">
                <h3 style="margin-top: 0; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons">lightbulb</span> Conclusiones Clave
                </h3>
                <div id="insights-list">
                    <!-- Dynamic Injection -->
                </div>
            </div>
            <div class="recommendation-container">
                <h3 style="margin-top: 0; color: var(--success); display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons">task_alt</span> Recomendaciones Accionables
                </h3>
                <div id="recommendations-list">
                    <!-- Dynamic Injection -->
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
            <h2>Other Insights & Oportunidades</h2>
            <ul style="font-size: 14px; color: var(--text-main); list-style-type: circle; padding-left: 20px;">
                <li style="margin-bottom: 8px;">El ASIN de <strong>Natural Health 4 Life</strong> mantiene una cuota alta a pesar de tener el precio más alto (£17.62), lo que sugiere un cliente inelástico o una propuesta de valor diferente (formato, pureza percibida).</li>
                <li style="margin-bottom: 8px;">Existe una correlación directa entre el badge <strong>Amazon Choice</strong> y nuestro liderazgo en Click Share esta semana.</li>
                <li>Nuestra variante es la única con etiqueta "Organic" explícita entre los top performers, lo cual es un diferenciador clave en la categoría de suplementos.</li>
            </ul>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVO -->
    <div id="interactive" class="tab-content">
        <div class="controls">
            <div>
                <label style="font-size: 12px; font-weight: 600; color: var(--text-light); display: block; margin-bottom: 4px;">Seleccionar Semana</label>
                <select id="weekSelector" onchange="updateComparison()">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div>
                <label style="font-size: 12px; font-weight: 600; color: var(--text-light); display: block; margin-bottom: 4px;">Comparar vs Competidor</label>
                <select id="compSelector" onchange="updateComparison()">
                    <!-- Populated by JS -->
                </select>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h2 style="text-align: center; color: var(--primary);">NaturaleBio (Nosotros)</h2>
                <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;" id="my-price">£8.89</div>
                        <div style="font-size: 12px; color: var(--text-light);">Precio</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;" id="my-share">23.3%</div>
                        <div style="font-size: 12px; color: var(--text-light);">Share</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;" id="my-rank">2.0</div>
                        <div style="font-size: 12px; color: var(--text-light);">Rank</div>
                    </div>
                </div>
            </div>
            <div class="card" style="border-top: 4px solid var(--danger);">
                <h2 style="text-align: center; color: var(--danger);" id="comp-name-display">Competidor</h2>
                <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;" id="comp-price">-</div>
                        <div style="font-size: 12px; color: var(--text-light);">Precio</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;" id="comp-share">-</div>
                        <div style="font-size: 12px; color: var(--text-light);">Share</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;" id="comp-rank">-</div>
                        <div style="font-size: 12px; color: var(--text-light);">Rank</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Detalle de Variantes (Semana Seleccionada)</h2>
            <div id="table_div" style="width: 100%;"></div>
        </div>
    </div>

</div>

<!-- DATA INJECTION -->
<script>
    // Injected Data from Python Analysis
    const marketData = [{"week_date":"2026-01-03","real_brand":"Horb\u00e4ach","is_yaba_asin":"N","clicks":80.483746,"click_share":1.19,"average_organic_rank":12.0,"price":7.99,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"Psyllium Husk Capsules 5000mg with Acidophilus | N...","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false},{"week_date":"2026-01-03","real_brand":"NKD Living","is_yaba_asin":"N","clicks":397.684392,"click_share":5.88,"average_organic_rank":5.0,"price":9.99,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"NKD Living Psyllium Husk Powder (500g) | Tested fo...","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false},{"week_date":"2026-01-03","real_brand":"NKD Living","is_yaba_asin":"N","clicks":392.27372,"click_share":5.8,"average_organic_rank":3.0,"price":9.99,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"NKD Living Whole Psyllium husks (500g)","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false},{"week_date":"2026-01-03","real_brand":"NEW LEAF PRODUCTS","is_yaba_asin":"N","clicks":656.720314,"click_share":9.71,"average_organic_rank":3.0,"price":13.29,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"Fibre Supplement 4000mg Psyllium Husk with Acidoph...","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false},{"week_date":"2026-01-03","real_brand":"Solgar","is_yaba_asin":"N","clicks":286.765616,"click_share":4.24,"average_organic_rank":13.0,"price":12.29,"weekly_number_of_days_with_deal":4.0,"weekly_number_of_days_with_coupon":2.0,"product_title":"Solgar Psyllium Husks Fibre 500 Mg Vegetable Capsu...","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false},{"week_date":"2026-01-03","real_brand":"Natural Health 4 Life","is_yaba_asin":"N","clicks":868.412856,"click_share":12.84,"average_organic_rank":7.0,"price":17.62,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"Natural Health 4 Life Vegetable Fibre Psyllium Hus...","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false},{"week_date":"2026-01-03","real_brand":"The Worldwide Mint","is_yaba_asin":"N","clicks":477.491804,"click_share":7.06,"average_organic_rank":9.0,"price":5.45,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"Psyllium Husk Powder 200g | 100% Pure & Natural | ...","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false},{"week_date":"2026-01-03","real_brand":"NaturaleBio","is_yaba_asin":"Y","clicks":1578.563556,"click_share":23.34,"average_organic_rank":2.0,"price":8.89,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"NaturaleBio Organic Psyllium Husk - 99% Purity - 2...","weekly_number_of_days_with_amazon_choice_badge":4.0,"is_our_brand":true},{"week_date":"2026-01-03","real_brand":"Unknown Brand","is_yaba_asin":"N","clicks":121.74012,"click_share":1.8,"average_organic_rank":21.0,"price":9.99,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"Vinco Fibre Supplement 5000mg Psyllium Husk with A...","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false},{"week_date":"2026-01-03","real_brand":"WeightWorld","is_yaba_asin":"N","clicks":595.850254,"click_share":8.81,"average_organic_rank":5.0,"price":11.96,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_coupon":0.0,"product_title":"WeightWorld Organic Psyllium Husk Capsules | 1400m...","weekly_number_of_days_with_amazon_choice_badge":0.0,"is_our_brand":false}];
    
    // Injected Insights
    const textInsights = ["<strong>Tendencia Global:</strong> El volumen de clics del parent ASIN se muestra estable. Nuestra marca (NaturaleBio) mantiene una posici\u00f3n dominante con un 23.3% de Click Share.", "<strong>Competencia:</strong> Los principales rivales son Natural Health 4 Life, NKD Living, NEW LEAF PRODUCTS. NaturaleBio lidera el mercado, superando al seguidor m\u00e1s cercano por un margen significativo.", "<strong>Estrategia de Precio:</strong> NaturaleBio se posiciona un 18.8% m\u00e1s barato que el promedio del mercado (8.89 vs 10.95), lo cual act\u00faa como un driver principal de conversi\u00f3n.", "<strong>Palancas:</strong> Sin actividad promocional agresiva esta semana. El badge de 'Amazon Choice' (presente 4 d\u00edas) refuerza la confianza del consumidor.", "<strong>Eficiencia Org\u00e1nica:</strong> Alta eficiencia. Con un rank promedio de 2.0, capturamos una cuota desproporcionadamente alta (23.3%), sugiriendo un listing altamente optimizado."];
    const textRecos = ["<strong>Defensa de Posici\u00f3n:</strong> Mantener el precio actual ya que la elasticidad parece favorecer el volumen actual frente a competidores m\u00e1s caros.", "<strong>Monitoreo de Competencia:</strong> Vigilar a 'Natural Health 4 Life' que, a pesar de un precio alto, mantiene una cuota relevante (posible nicho premium).", "<strong>Optimizaci\u00f3n de Badges:</strong> Asegurar la retenci\u00f3n del badge 'Amazon Choice' ya que correlaciona fuertemente con la alta conversi\u00f3n actual."];
    const ourBrandName = "NaturaleBio";

    // Initialize UI
    window.onload = function() {
        renderTextLists();
        populateSelects();
        
        // Load Google Charts
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(drawCharts);
    };

    // UI Helpers
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');
    }

    function renderTextLists() {
        const insightsDiv = document.getElementById('insights-list');
        insightsDiv.innerHTML = textInsights.map(t => `<div class="insight-item"><span class="material-icons icon-primary">analytics</span><div>${t}</div></div>`).join('');

        const recosDiv = document.getElementById('recommendations-list');
        recosDiv.innerHTML = textRecos.map(t => `<div class="insight-item"><span class="material-icons icon-success">check_circle</span><div>${t}</div></div>`).join('');
    }

    function populateSelects() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const competitors = [...new Set(marketData.filter(d => !d.is_our_brand).map(d => d.real_brand))].sort();

        const wSel = document.getElementById('weekSelector');
        weeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w; opt.text = w;
            wSel.add(opt);
        });
        wSel.value = weeks[weeks.length - 1]; // Default to latest

        const cSel = document.getElementById('compSelector');
        competitors.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c; opt.text = c;
            cSel.add(opt);
        });
    }

    // Chart Logic
    function drawCharts() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawEfficiencyChart();
        updateComparison(); // Interactive tab init
    }

    function drawTrendChart() {
        // Prepare Data: Group by week, sum clicks for Our Brand vs Competitors
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const dataArr = [['Semana', 'Clicks Competencia', 'Clicks Nosotros', 'Nuestra Cuota (%)']];
        
        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            const ourClicks = weekData.filter(d => d.is_our_brand).reduce((sum, d) => sum + d.clicks, 0);
            const compClicks = weekData.filter(d => !d.is_our_brand).reduce((sum, d) => sum + d.clicks, 0);
            const total = ourClicks + compClicks;
            const share = total > 0 ? (ourClicks / total) * 100 : 0;
            dataArr.push([w, compClicks, ourClicks, share]);
        });

        var data = google.visualization.arrayToDataTable(dataArr);

        var options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
            colors: ['#E0E0E0', '#1967D2'],
            isStacked: true,
            vAxes: {
                0: {title: 'Volumen de Clicks'},
                1: {title: 'Click Share %', format: '#\'%\''}
            },
            legend: {position: 'bottom'},
            chartArea: {width: '80%', height: '70%'}
        };

        var chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function drawCompetitivenessChart() {
        // Determine Top 3 Competitors based on total share
        const brandStats = {};
        marketData.filter(d => !d.is_our_brand).forEach(d => {
            if(!brandStats[d.real_brand]) brandStats[d.real_brand] = 0;
            brandStats[d.real_brand] += d.click_share;
        });
        
        const top3 = Object.entries(brandStats)
            .sort((a,b) => b[1] - a[1])
            .slice(0,3)
            .map(e => e[0]);

        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        // Headers
        const headers = ['Semana', ourBrandName, ...top3];
        const rows = [];

        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            const row = [w];
            
            // Our Share
            const ourShare = weekData.filter(d => d.is_our_brand).reduce((s, d) => s + d.click_share, 0);
            row.push(ourShare);

            // Competitor Shares
            top3.forEach(comp => {
                const compShare = weekData.filter(d => d.real_brand === comp).reduce((s, d) => s + d.click_share, 0);
                row.push(compShare);
            });
            rows.push(row);
        });

        var data = google.visualization.arrayToDataTable([headers, ...rows]);

        var options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '85%', height: '70%'},
            lineWidth: 2
        };

        var chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Scatter: X=Rank (reversed), Y=Share, Bubble=Clicks?
        const latestWeek = document.getElementById('weekSelector').value; // Use logic or default
        const weekData = marketData.filter(d => d.week_date === latestWeek);

        // Group by Brand/ASIN for scatter
        // Format: [ID, Rank, Share, BrandCategory(Color), Tooltip]
        const dataArr = [['ID', 'Rank Orgánico', 'Click Share', 'Tipo', 'Tooltip']];
        
        weekData.forEach(d => {
            const type = d.is_our_brand ? 'Nosotros' : 'Competencia';
            const tooltip = `${d.real_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            dataArr.push([
                d.real_brand.substring(0, 10), 
                d.average_organic_rank, 
                d.click_share, 
                type, 
                tooltip
            ]);
        });

        var data = google.visualization.arrayToDataTable(dataArr);

        var options = {
            hAxis: {title: 'Ranking Orgánico (Menor es Mejor)', direction: -1}, // Reverse axis
            vAxis: {title: 'Click Share (%)'},
            bubble: {textStyle: {fontSize: 11}},
            colors: ['#999', '#4285F4'], // Competitor=Grey, Us=Blue
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        var chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // Interactive Logic
    function updateComparison() {
        const week = document.getElementById('weekSelector').value;
        const compName = document.getElementById('compSelector').value;
        document.getElementById('comp-name-display').innerText = compName;

        const weekData = marketData.filter(d => d.week_date === week);
        
        // Calculate Metrics for "Us"
        const ourData = weekData.filter(d => d.is_our_brand);
        const ourAvgPrice = ourData.length ? (ourData.reduce((s,d) => s+d.price,0)/ourData.length).toFixed(2) : '-';
        const ourTotalShare = ourData.reduce((s,d) => s+d.click_share,0).toFixed(1);
        const ourAvgRank = ourData.length ? (ourData.reduce((s,d) => s+d.average_organic_rank,0)/ourData.length).toFixed(1) : '-';

        document.getElementById('my-price').innerText = '£' + ourAvgPrice;
        document.getElementById('my-share').innerText = ourTotalShare + '%';
        document.getElementById('my-rank').innerText = ourAvgRank;

        // Calculate Metrics for "Competitor"
        const compData = weekData.filter(d => d.real_brand === compName);
        const compAvgPrice = compData.length ? (compData.reduce((s,d) => s+d.price,0)/compData.length).toFixed(2) : '-';
        const compTotalShare = compData.reduce((s,d) => s+d.click_share,0).toFixed(1);
        const compAvgRank = compData.length ? (compData.reduce((s,d) => s+d.average_organic_rank,0)/compData.length).toFixed(1) : '-';

        document.getElementById('comp-price').innerText = '£' + compAvgPrice;
        document.getElementById('comp-share').innerText = compTotalShare + '%';
        document.getElementById('comp-rank').innerText = compAvgRank;

        // Update Table
        const filteredForTable = weekData.filter(d => d.is_our_brand || d.real_brand === compName);
        drawTable(filteredForTable);
    }

    function drawTable(dataList) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Marca');
        data.addColumn('string', 'Título Producto');
        data.addColumn('number', 'Precio');
        data.addColumn('number', 'Share (%)');
        data.addColumn('number', 'Rank');
        
        dataList.forEach(d => {
            data.addRow([
                d.real_brand,
                d.product_title.substring(0, 40) + '...',
                d.price,
                d.click_share,
                d.average_organic_rank
            ]);
        });

        var table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
    }

</script>

</body>
</html>