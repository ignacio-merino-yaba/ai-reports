<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Fonts & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* RESET & BASE STYLES (Apple-like + Google Clean) */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --text-main: #202124;
            --text-secondary: #5f6368;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-radius: 16px;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* LAYOUT */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        header {
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: var(--text-main);
        }
        .header-title p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 4px 0 0 0;
        }
        .badge {
            background-color: #e8f0fe;
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .tab-btn {
            background: transparent;
            border: none;
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .tab-content.active {
            display: block;
        }

        /* CARDS */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            padding: 24px;
            margin-bottom: 24px;
            transition: box-shadow 0.3s;
        }
        .card:hover {
            box-shadow: var(--shadow-hover);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .metric-card {
            background: #fff;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #eee;
        }
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            margin: 8px 0;
            color: var(--text-main);
        }
        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trend-up { color: var(--success-color); font-size: 14px; }
        .trend-down { color: var(--danger-color); font-size: 14px; }

        /* CHARTS CONTAINER */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* INSIGHTS SECTION */
        .insights-list {
            list-style: none;
            padding: 0;
        }
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .insight-icon {
            color: var(--primary-color);
            background: #e8f0fe;
            padding: 8px;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .insight-content h4 {
            margin: 0 0 4px 0;
            font-size: 15px;
            font-weight: 600;
        }
        .insight-content p {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* INTERACTIVE CONTROLS */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #eee;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            background-color: #fff;
        }
        select:focus {
            border-color: var(--primary-color);
        }

        /* TABLE */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .data-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #eee;
            color: var(--text-secondary);
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f5f5f5;
        }
        .data-table tr:last-child td { border-bottom: none; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-title">
            <h1 id="report-title">Análisis de Parent ASIN</h1>
            <p id="report-subtitle">Inteligencia de Mercado - Última actualización: Cálculo dinámico...</p>
        </div>
        <div class="badge" id="our-brand-badge">Detectando Marca...</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="tab-static" class="tab-content active">
        
        <!-- KPI SUMMARY -->
        <div class="metrics-grid" id="kpi-container">
            <!-- KPIs Injected via JS -->
        </div>

        <!-- SECCIÓN 1: TENDENCIA GLOBAL -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent (Tráfico & Cuota)
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <p class="text-secondary" style="margin-top:15px; font-size:13px;">*Barras: Volumen de Clics estimados. Líneas: % Click Share.</p>
        </div>

        <!-- SECCIÓN 2: COMPETITIVIDAD DE MARCA -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Share of Voice)
                </div>
            </div>
            <div id="chart_brand_comp" class="chart-container"></div>
        </div>

        <!-- GRID 2 COLUMNAS -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            
            <!-- SECCIÓN 3: PALANCAS -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">tune</span>
                        3. Palancas vs Click Share
                    </div>
                </div>
                <div id="chart_levers" class="chart-container"></div>
            </div>

            <!-- SECCIÓN 4: EFICIENCIA -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">scatter_plot</span>
                        4. Eficiencia (Rank vs Share)
                    </div>
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>
        </div>

        <!-- SECCIÓN 5: CONCLUSIONES Y RECOMENDACIONES -->
        <div class="card" style="border-left: 5px solid var(--primary-color);">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Insights Clave & Recomendaciones
                </div>
            </div>
            <ul class="insights-list" id="insights-container">
                <!-- Insights generated dynamically -->
            </ul>
        </div>
        
         <!-- SECCIÓN 6: OTHER INSIGHTS -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">analytics</span>
                    6. Other Insights (Detección de Anomalías)
                </div>
            </div>
            <ul class="insights-list" id="other-insights-container">
                <!-- Other Insights generated dynamically -->
            </ul>
        </div>

    </div>

    <!-- PESTAÑA 2: INTERACTIVO -->
    <div id="tab-interactive" class="tab-content">
        <div class="controls">
            <div>
                <label style="font-size:12px; font-weight:600; color:#555; display:block; margin-bottom:4px;">Semana</label>
                <select id="select-week" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label style="font-size:12px; font-weight:600; color:#555; display:block; margin-bottom:4px;">Competidor</label>
                <select id="select-competitor" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Cara a Cara: Nosotros vs Competidor</div>
            </div>
            <div id="table_interactive"></div>
        </div>
        
        <div class="card">
            <div class="card-header">
                 <div class="card-title">Distribución de Precios (Semana Seleccionada)</div>
            </div>
             <div id="chart_interactive_price" class="chart-container"></div>
        </div>
    </div>

</div>

<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION (Processed from CSV)
    // ---------------------------------------------------------
    const marketData = [{"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba_asin": "N", "real_brand": "NORITUAL LAB", "click_share": 14.2, "estimated_clicks": 269.53588, "price": 15.28, "average_organic_rank": 2.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "is_yaba_asin": "N", "real_brand": "NORITUAL LAB", "click_share": 17.63, "estimated_clicks": 334.642082, "price": 23.484285714, "average_organic_rank": 1.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0882ZCHMW", "product_title": "T\u00e9 Matcha Ceremonial Premium 80 Gr", "is_yaba_asin": "N", "real_brand": "Matcha & CO", "click_share": 1.78, "estimated_clicks": 33.786892, "price": 31.344285714, "average_organic_rank": 14.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "is_yaba_asin": "Y", "real_brand": "NaturaleBio", "click_share": 6.75, "estimated_clicks": 128.12445, "price": 29.228571429, "average_organic_rank": 7.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0FJM1MBLM", "product_title": "Ceremonial Matcha Kiri - Reines Gr\u00fcntee-Pulver aus...", "is_yaba_asin": "N", "real_brand": "Ceremonial", "click_share": 2.84, "estimated_clicks": 53.907176, "price": 39.492857143, "average_organic_rank": 10.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0DPJ4Z5WS", "product_title": "Bio Matcha Pulver - 100 g Japanischer Matcha Tee -...", "is_yaba_asin": "N", "real_brand": "WeightWorld", "click_share": 1.18, "estimated_clicks": 22.398052, "price": 13.321428571, "average_organic_rank": 42.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "is_yaba_asin": "N", "real_brand": "UNREAL\u00ae", "click_share": 2.49, "estimated_clicks": 47.263686, "price": 30.714285714, "average_organic_rank": 11.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0F99ZP2TX", "product_title": "UNREAL\u00ae Ceremonial Bio Matcha \u2013 100% Japanischer Z...", "is_yaba_asin": "N", "real_brand": "UNREAL\u00ae", "click_share": 3.55, "estimated_clicks": 67.38397, "price": 9.178571429, "average_organic_rank": 4.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0F99ZP2TX", "product_title": "UNREAL\u00ae Ceremonial Bio Matcha \u2013 100% Japanischer Z...", "is_yaba_asin": "N", "real_brand": "Kuro Matcha", "click_share": 3.55, "estimated_clicks": 67.38397, "price": 9.178571429, "average_organic_rank": 4.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba_asin": "Y", "real_brand": "NaturaleBio", "click_share": 5.8, "estimated_clicks": 110.09212, "price": 14.347142857, "average_organic_rank": 4.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2025-52", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0G3XBLNKN", "product_title": "Jibix Ceremonial Matcha \u2013 100% Japanischer zeremon...", "is_yaba_asin": "N", "real_brand": "Jibix", "click_share": 3.67, "estimated_clicks": 69.661738, "price": 23.575714286, "average_organic_rank": 12.0, "weekly_search_volume": 1898.14, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "is_yaba_asin": "N", "real_brand": "NORITUAL LAB", "click_share": 17.86, "estimated_clicks": 172.02752, "price": 22.9, "average_organic_rank": 1.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba_asin": "N", "real_brand": "NORITUAL LAB", "click_share": 14.08, "estimated_clicks": 135.61856, "price": 14.9, "average_organic_rank": 2.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0FK5VGD2H", "product_title": "M'atelier Reines Matcha Pulver aus Japan \u2013 Ceremon...", "is_yaba_asin": "N", "real_brand": "M'atelier", "click_share": 4.17, "estimated_clicks": 40.16544, "price": 19.99, "average_organic_rank": 6.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0FC2XRLV5", "product_title": "Matcha Pulver Ceremonial Grade BIO-Qualit\u00e4t 100g i...", "is_yaba_asin": "N", "real_brand": "Matcha", "click_share": 1.96, "estimated_clicks": 18.87872, "price": 14.99, "average_organic_rank": 9.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "is_yaba_asin": "Y", "real_brand": "NaturaleBio", "click_share": 5.74, "estimated_clicks": 55.28768, "price": 28.99, "average_organic_rank": 10.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba_asin": "Y", "real_brand": "NaturaleBio", "click_share": 5.08, "estimated_clicks": 48.93056, "price": 13.99, "average_organic_rank": 4.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0G3XBLNKN", "product_title": "Jibix Ceremonial Matcha \u2013 100% Japanischer zeremon...", "is_yaba_asin": "N", "real_brand": "Jibix", "click_share": 3.91, "estimated_clicks": 37.66112, "price": 22.99, "average_organic_rank": 12.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "is_yaba_asin": "N", "real_brand": "UNREAL\u00ae", "click_share": 3.39, "estimated_clicks": 32.65248, "price": 29.95, "average_organic_rank": 10.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0G1T7N675", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "is_yaba_asin": "N", "real_brand": "Ceremonial", "click_share": 2.87, "estimated_clicks": 27.64384, "price": 8.47, "average_organic_rank": 13.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 4.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}, {"week_date": "2026-01", "parent_asin": "Matcha Ceremonial", "keywords": "matcha ceremonial grade", "asin": "B0FJ917BGC", "product_title": "ORIGEENS BIO MATCHA CEREMONIAL GRADE HINOTORI - Ja...", "is_yaba_asin": "N", "real_brand": "ORIGEENS", "click_share": 2.74, "estimated_clicks": 26.39168, "price": 24.97, "average_organic_rank": 15.0, "weekly_search_volume": 963.2, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0}];

    // ---------------------------------------------------------
    // 2. CONFIG & HELPERS
    // ---------------------------------------------------------
    
    // Identificar nuestra marca (is_yaba_asin = 'Y')
    const ourBrandRow = marketData.find(d => d.is_yaba_asin === 'Y');
    const OUR_BRAND = ourBrandRow ? ourBrandRow.real_brand : "Nuestra Marca";
    document.getElementById('our-brand-badge').innerText = OUR_BRAND;

    // Obtener semanas únicas ordenadas
    const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
    const currentWeek = weeks[weeks.length - 1];
    const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;

    // Colores
    const COLOR_US = '#4285F4';
    const COLOR_COMP = ['#EA4335', '#FBBC05', '#34A853', '#673AB7', '#FF6D01'];

    // Inicializar Google Charts
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
    }

    // ---------------------------------------------------------
    // 3. MAIN DASHBOARD LOGIC
    // ---------------------------------------------------------
    function initDashboard() {
        document.getElementById('report-subtitle').innerText = `Reporte generado para el periodo: ${weeks[0]} - ${currentWeek}`;
        
        renderKPIs();
        drawTrendChart();
        drawCompetitivenessChart();
        drawLeversChart();
        drawEfficiencyChart();
        generateInsights();
        setupInteractiveControls();
    }

    function renderKPIs() {
        // Datos última semana
        const currentData = marketData.filter(d => d.week_date === currentWeek);
        const prevData = prevWeek ? marketData.filter(d => d.week_date === prevWeek) : [];

        // Helper para sumar
        const sum = (arr, key) => arr.reduce((a, b) => a + (b[key] || 0), 0);
        
        // Clicks Totales (Mercado)
        const totalClicks = sum(currentData, 'estimated_clicks');
        const prevTotalClicks = prevWeek ? sum(prevData, 'estimated_clicks') : totalClicks;
        const clicksTrend = ((totalClicks - prevTotalClicks) / prevTotalClicks) * 100;

        // Nuestro Click Share Total
        // Nota: Click Share en la tabla es por ASIN. Para el parent global, sumamos click share de nuestros ASINs.
        // Ojo: Si hay duplicidad de keywords, esto es una suma ponderada. 
        // Simplificación para el reporte: Suma de shares de nuestros ASINs en todas las keywords (asumiendo 1 keyword principal o agregación previa).
        const myASINs = currentData.filter(d => d.is_yaba_asin === 'Y');
        const myShare = sum(myASINs, 'click_share');
        
        const prevMyASINs = prevData.filter(d => d.is_yaba_asin === 'Y');
        const prevMyShare = prevWeek ? sum(prevMyASINs, 'click_share') : 0;
        const shareTrend = myShare - prevMyShare; // Puntos porcentuales

        // Rank Promedio (Ponderado por clicks idealmente, aquí promedio simple de nuestros ASINs)
        const myRank = myASINs.length ? myASINs.reduce((a,b) => a + b.average_organic_rank, 0) / myASINs.length : 0;
        const prevMyRank = prevMyASINs.length ? prevMyASINs.reduce((a,b) => a + b.average_organic_rank, 0) / prevMyASINs.length : 0;
        const rankDiff = prevMyRank - myRank; // Positivo es mejora (bajar rank)

        const kpis = [
            { label: 'Volumen Mercado (Clics Est.)', value: Math.round(totalClicks).toLocaleString(), change: clicksTrend, format: '%' },
            { label: 'Nuestra Cuota de Clics', value: myShare.toFixed(2) + '%', change: shareTrend, format: 'pp' },
            { label: 'Posición Orgánica Promedio', value: myRank.toFixed(1), change: rankDiff, format: 'pos', inverse: true }
        ];

        const container = document.getElementById('kpi-container');
        container.innerHTML = kpis.map(k => {
            const isGood = k.inverse ? k.change > 0 : k.change >= 0;
            const colorClass = isGood ? 'trend-up' : 'trend-down';
            const icon = isGood ? '▲' : '▼';
            return `
                <div class="metric-card">
                    <div class="metric-label">${k.label}</div>
                    <div class="metric-value">${k.value}</div>
                    <div class="${colorClass}">
                        ${icon} ${Math.abs(k.change).toFixed(1)}${k.format} vs semana anterior
                    </div>
                </div>
            `;
        }).join('');
    }

    // ---------------------------------------------------------
    // 4. CHART DRAWING FUNCTIONS
    // ---------------------------------------------------------

    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Clics Nosotros');
        data.addColumn('number', 'Clics Competencia');
        data.addColumn('number', 'Share Nosotros (%)');
        data.addColumn('number', 'Share Competencia (%)');

        const rows = weeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const myData = weekData.filter(d => d.is_yaba_asin === 'Y');
            const compData = weekData.filter(d => d.is_yaba_asin === 'N');

            const myClicks = myData.reduce((a,b) => a + b.estimated_clicks, 0);
            const compClicks = compData.reduce((a,b) => a + b.estimated_clicks, 0);
            
            // Share recalcula para el gráfico
            const totalShare = weekData.reduce((a,b) => a + b.click_share, 0); // Debería ser ~100
            const myShare = myData.reduce((a,b) => a + b.click_share, 0);
            const compShare = compData.reduce((a,b) => a + b.click_share, 0);

            return [week, myClicks, compClicks, myShare, compShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: {
                2: {type: 'line', targetAxisIndex: 1, color: COLOR_US, lineWidth: 3},
                3: {type: 'line', targetAxisIndex: 1, color: '#EA4335', lineDashStyle: [4, 4]}
            },
            colors: [COLOR_US, '#E0E0E0'],
            vAxes: {
                0: {title: 'Volumen Clics'},
                1: {title: '% Share', format: '#\'%\''}
            },
            bar: { groupWidth: '60%' },
            legend: { position: 'bottom' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function drawCompetitivenessChart() {
        // 1. Identificar Top 3 Competidores (basado en share total histórico)
        const brandShares = {};
        marketData.forEach(d => {
            if (d.real_brand === OUR_BRAND) return;
            brandShares[d.real_brand] = (brandShares[d.real_brand] || 0) + d.click_share;
        });
        
        const topCompetitors = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', OUR_BRAND);
        topCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Resto');

        const rows = weeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const myShare = weekData.filter(d => d.real_brand === OUR_BRAND).reduce((a,b) => a + b.click_share, 0);
            
            const compShares = topCompetitors.map(c => {
                return weekData.filter(d => d.real_brand === c).reduce((a,b) => a + b.click_share, 0);
            });

            const topCompSum = compShares.reduce((a,b) => a+b, 0);
            const allShare = weekData.reduce((a,b) => a + b.click_share, 0);
            const restShare = Math.max(0, allShare - myShare - topCompSum);

            return [week, myShare, ...compShares, restShare];
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: [COLOR_US, ...COLOR_COMP], // Usamos paleta definida
            vAxis: { title: 'Click Share (%)' },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    function drawLeversChart() {
        // Analizar impacto de Promociones vs No Promociones para el Mercado
        // Simplificado: Promedio de Share cuando hay Deal vs No Deal
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Tipo');
        data.addColumn('number', 'Con Deal');
        data.addColumn('number', 'Sin Deal');

        // Agrupar por marca (Top 5)
        const brands = [OUR_BRAND, ...Object.keys(marketData.reduce((acc, curr) => {
             if(curr.real_brand !== OUR_BRAND) acc[curr.real_brand] = true; 
             return acc; 
        }, {})).slice(0,4)];

        const rows = brands.map(brand => {
            const brandData = marketData.filter(d => d.real_brand === brand);
            const withDeal = brandData.filter(d => d.weekly_number_of_days_with_deal > 0);
            const withoutDeal = brandData.filter(d => d.weekly_number_of_days_with_deal === 0);

            const avgShareDeal = withDeal.length ? withDeal.reduce((a,b) => a+b.click_share,0)/withDeal.length : 0;
            const avgShareNoDeal = withoutDeal.length ? withoutDeal.reduce((a,b) => a+b.click_share,0)/withoutDeal.length : 0;

            return [brand, avgShareDeal, avgShareNoDeal];
        });

        data.addRows(rows);

        const options = {
            title: 'Impacto de Deals en Click Share Promedio',
            vAxis: {title: 'Avg Click Share (%)'},
            hAxis: {title: 'Marca'},
            seriesType: 'bars',
            colors: ['#EF5350', '#BDBDBD'] // Rojo para Deal, Gris sin deal
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Scatter: X=Rank, Y=Share (Última semana)
        const currentData = marketData.filter(d => d.week_date === currentWeek);
        
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Orgánico');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        const rows = currentData.map(d => {
            const color = d.is_yaba_asin === 'Y' ? `point {fill-color: ${COLOR_US}; size: 10}` : `point {fill-color: #9E9E9E}`;
            const tooltip = `${d.real_brand} \nASIN: ${d.asin} \nRank: ${d.average_organic_rank} \nShare: ${d.click_share}% \nPrecio: ${d.price}`;
            return [d.average_organic_rank, d.click_share, color, tooltip];
        });

        data.addRows(rows);

        const options = {
            hAxis: {title: 'Rank Orgánico (Menor es mejor)', direction: 1}, // 1 normal, ranks bajos izquierda
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
            chartArea: {width: '85%', height: '80%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // ---------------------------------------------------------
    // 5. AUTOMATED INSIGHTS GENERATOR
    // ---------------------------------------------------------
    function generateInsights() {
        const insights = [];
        const others = [];

        // Datos
        const currentData = marketData.filter(d => d.week_date === currentWeek);
        const myASINs = currentData.filter(d => d.is_yaba_asin === 'Y');
        const myTotalShare = myASINs.reduce((a,b) => a+b.click_share, 0);
        
        // --- Insight 1: Tendencia Global ---
        // Comparar con el mercado
        const volumeChange = ((marketData.filter(d => d.week_date === currentWeek).reduce((a,b)=>a+b.estimated_clicks,0) - 
                             (prevWeek ? marketData.filter(d => d.week_date === prevWeek).reduce((a,b)=>a+b.estimated_clicks,0) : 0)) > 0);
        
        insights.push({
            title: "Dinámica del Mercado",
            text: `El volumen de búsquedas y clics del parent ${volumeChange ? 'ha aumentado' : 'ha disminuido'} esta semana. Nuestra marca ${myTotalShare > 10 ? 'mantiene una posición sólida' : 'tiene oportunidad de crecimiento'} con un ${myTotalShare.toFixed(1)}% de cuota.`
        });

        // --- Insight 2: Competidor Dominante ---
        const brandShares = {};
        currentData.forEach(d => brandShares[d.real_brand] = (brandShares[d.real_brand] || 0) + d.click_share);
        const topBrand = Object.keys(brandShares).reduce((a, b) => brandShares[a] > brandShares[b] ? a : b);
        
        if (topBrand !== OUR_BRAND) {
            insights.push({
                title: "Amenaza Competitiva",
                text: `La marca <strong>${topBrand}</strong> lidera la categoría esta semana con un ${brandShares[topBrand].toFixed(1)}% de share. Se recomienda analizar sus precios y keywords.`
            });
        } else {
            insights.push({
                title: "Liderazgo de Categoría",
                text: `¡Buen trabajo! <strong>${OUR_BRAND}</strong> es la marca líder esta semana con un ${brandShares[topBrand].toFixed(1)}% de share.`
            });
        }

        // --- Insight 3: Anomalía de Precio ---
        const myAvgPrice = myASINs.length ? myASINs.reduce((a,b)=>a+b.price,0)/myASINs.length : 0;
        const marketAvgPrice = currentData.reduce((a,b)=>a+b.price,0)/currentData.length;
        
        if (myAvgPrice > marketAvgPrice * 1.2) {
             insights.push({
                title: "Sensibilidad al Precio",
                text: `Nuestros productos están un ${((myAvgPrice/marketAvgPrice -1)*100).toFixed(0)}% más caros que el promedio. Verificar si esto está afectando la conversión.`
            });
        }

        // --- Insight 4: Eficiencia ---
        const efficientASIN = myASINs.find(d => d.average_organic_rank <= 5 && d.click_share < 5);
        if (efficientASIN) {
            others.push({
                title: "Oportunidad de CTR",
                text: `El ASIN ${efficientASIN.asin} tiene buen rank (${efficientASIN.average_organic_rank}) pero bajo share (${efficientASIN.click_share}%). Revisar imagen principal y título.`
            });
        }

        // --- Insight 5: Nuevos Entrantes ---
        if (prevWeek) {
            const prevBrands = new Set(marketData.filter(d => d.week_date === prevWeek).map(d => d.real_brand));
            const newBrands = Object.keys(brandShares).filter(b => !prevBrands.has(b));
            if (newBrands.length > 0) {
                others.push({
                    title: "Nuevos Competidores",
                    text: `Marcas detectadas esta semana: ${newBrands.join(', ')}.`
                });
            }
        }

        // Recomendaciones Genéricas pero accionables
        insights.push({
            title: "Acción Recomendada: Defensa",
            text: "Monitorear ASINs competidores con badge 'Amazon Choice' que estén ganando tracción en keywords principales."
        });

        // Render Insights
        const container = document.getElementById('insights-container');
        container.innerHTML = insights.map(i => `
            <li class="insight-item">
                <div class="insight-icon"><span class="material-icons">info</span></div>
                <div class="insight-content">
                    <h4>${i.title}</h4>
                    <p>${i.text}</p>
                </div>
            </li>
        `).join('');

        const othersContainer = document.getElementById('other-insights-container');
        othersContainer.innerHTML = others.length ? others.map(i => `
             <li class="insight-item">
                <div class="insight-icon"><span class="material-icons">warning</span></div>
                <div class="insight-content">
                    <h4>${i.title}</h4>
                    <p>${i.text}</p>
                </div>
            </li>
        `).join('') : '<p style="color:#777; font-style:italic;">No se detectaron anomalías críticas adicionales esta semana.</p>';
    }

    // ---------------------------------------------------------
    // 6. INTERACTIVE TAB LOGIC
    // ---------------------------------------------------------
    function setupInteractiveControls() {
        // Populate Selects
        const weekSelect = document.getElementById('select-week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            if (w === currentWeek) opt.selected = true;
            weekSelect.appendChild(opt);
        });

        const brands = [...new Set(marketData.map(d => d.real_brand))].filter(b => b !== OUR_BRAND).sort();
        const compSelect = document.getElementById('select-competitor');
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            compSelect.appendChild(opt);
        });

        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('select-week').value;
        const competitor = document.getElementById('select-competitor').value;
        
        const weekData = marketData.filter(d => d.week_date === week);
        const myData = weekData.filter(d => d.real_brand === OUR_BRAND);
        const compData = weekData.filter(d => d.real_brand === competitor);

        // Render Table
        const tableDiv = document.getElementById('table_interactive');
        
        // Metricas Promedio
        const getAvg = (arr, key) => arr.length ? (arr.reduce((a,b)=>a+b[key],0)/arr.length).toFixed(2) : '-';
        const getSum = (arr, key) => arr.length ? (arr.reduce((a,b)=>a+b[key],0)).toFixed(2) : '-';

        let html = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Métrica</th>
                        <th style="color:${COLOR_US}">${OUR_BRAND}</th>
                        <th style="color:#EA4335">${competitor}</th>
                        <th>Diferencia</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Precio Promedio</td>
                        <td>€${getAvg(myData, 'price')}</td>
                        <td>€${getAvg(compData, 'price')}</td>
                        <td>${(getAvg(myData, 'price') - getAvg(compData, 'price')).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Click Share Total (%)</td>
                        <td>${getSum(myData, 'click_share')}%</td>
                        <td>${getSum(compData, 'click_share')}%</td>
                        <td>${(getSum(myData, 'click_share') - getSum(compData, 'click_share')).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <td>Rank Orgánico Prom.</td>
                        <td>${getAvg(myData, 'average_organic_rank')}</td>
                        <td>${getAvg(compData, 'average_organic_rank')}</td>
                        <td>${(getAvg(myData, 'average_organic_rank') - getAvg(compData, 'average_organic_rank')).toFixed(1)}</td>
                    </tr>
                     <tr>
                        <td>ASINs Posicionados</td>
                        <td>${myData.length}</td>
                        <td>${compData.length}</td>
                        <td>${myData.length - compData.length}</td>
                    </tr>
                </tbody>
            </table>
        `;
        tableDiv.innerHTML = html;

        // Render Price Distribution Chart
        const priceData = new google.visualization.DataTable();
        priceData.addColumn('string', 'ASIN');
        priceData.addColumn('number', 'Precio');
        priceData.addColumn({type: 'string', role: 'style'}); // Color

        const combined = [...myData, ...compData];
        combined.forEach(d => {
            const color = d.real_brand === OUR_BRAND ? COLOR_US : '#EA4335';
            priceData.addRow([d.asin, d.price, color]);
        });

        const options = {
            title: 'Comparativa de Precios por ASIN',
            legend: 'none',
            vAxis: {title: 'Precio (€)'},
            hAxis: {title: 'ASIN'},
            bar: {groupWidth: '50%'}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_interactive_price'));
        chart.draw(priceData, options);
    }

</script>

</body>
</html>