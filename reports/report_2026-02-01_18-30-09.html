<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence Report: Parent ASIN Analysis</title>
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #007AFF; /* Apple Blue */
            --success: #34C759;
            --danger: #FF3B30;
            --neutral: #8E8E93;
            --bg: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-main: #1D1D1F;
            --text-sec: #86868B;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        h1 { font-size: 24px; font-weight: 600; margin: 0; }
        .subtitle { color: var(--text-sec); font-size: 14px; }

        /* Tabs */
        .tabs { display: flex; gap: 12px; margin-bottom: 24px; }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-sec);
            border-radius: 20px;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--card-bg);
            color: var(--text-main);
            box-shadow: var(--shadow);
            font-weight: 600;
        }

        /* Grid System */
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        .card h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPIs */
        .kpi-value { font-size: 28px; font-weight: 700; color: var(--text-main); }
        .kpi-label { font-size: 12px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-up { color: var(--success); font-size: 14px; display: flex; align-items: center; }
        .trend-down { color: var(--danger); font-size: 14px; display: flex; align-items: center; }

        /* Insights List */
        ul.insights-list { list-style: none; padding: 0; margin: 0; }
        ul.insights-list li {
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
            font-size: 14px;
            line-height: 1.5;
            color: #424245;
        }
        ul.insights-list li::before {
            content: "•";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
            font-size: 18px;
            top: -2px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        select {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid #E5E5E5;
            font-family: inherit;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* Utilities */
        .hidden { display: none; }
        .chart-container { width: 100%; height: 300px; }
        .tag {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        .tag-blue { background: #E3F2FD; color: #1565C0; }
        .tag-gray { background: #F5F5F5; color: #616161; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Parent ASIN Analysis</h1>
            <div class="subtitle">Last 5 Weeks • Market Intelligence Report</div>
        </div>
        <div style="text-align: right;">
            <span class="tag tag-blue" id="ourBrandLabel">Our Brand: Loading...</span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Static Report</button>
        <button class="tab-btn" onclick="switchTab('comparator')">Interactive Comparator</button>
    </div>

    <!-- TAB 1: REPORT -->
    <div id="report-view">
        <!-- KPI Row -->
        <div class="grid grid-4" style="margin-bottom: 20px;">
            <div class="card">
                <div class="kpi-label">Total Clicks (Last Week)</div>
                <div class="kpi-value" id="kpi-clicks">-</div>
                <div id="kpi-clicks-trend">-</div>
            </div>
            <div class="card">
                <div class="kpi-label">Our Share of Voice</div>
                <div class="kpi-value" id="kpi-share">-</div>
                <div id="kpi-share-trend">-</div>
            </div>
            <div class="card">
                <div class="kpi-label">Avg. Organic Rank</div>
                <div class="kpi-value" id="kpi-rank">-</div>
                <div class="subtitle">Lower is better</div>
            </div>
            <div class="card">
                <div class="kpi-label">Active Promotions</div>
                <div class="kpi-value" id="kpi-promos">-</div>
                <div class="subtitle">Deals/Coupons active</div>
            </div>
        </div>

        <!-- Section 1 & 2 -->
        <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="card">
                <h3><span class="material-icons">trending_up</span> Global Trend (Clicks & Share)</h3>
                <div id="chart_global_trend" class="chart-container"></div>
            </div>
            <div class="card">
                <h3><span class="material-icons">pie_chart</span> Competitiveness (Share History)</h3>
                <div id="chart_competitiveness" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 3 & 4 -->
        <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="card">
                <h3><span class="material-icons">ads_click</span> Efficiency (Rank vs. Share)</h3>
                <div id="chart_efficiency" class="chart-container"></div>
                <div class="subtitle" style="margin-top: 10px; text-align: center;">Size = Search Volume</div>
            </div>
            <div class="card">
                <h3><span class="material-icons">tune</span> Levers Impact (Last Week)</h3>
                <div id="chart_levers" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="card" style="border-left: 6px solid var(--primary);">
            <h3><span class="material-icons">lightbulb</span> Strategic Insights & Recommendations</h3>
            <div class="grid grid-2">
                <div>
                    <h4 style="margin-top:0;">Key Findings</h4>
                    <ul class="insights-list" id="insights-findings"></ul>
                </div>
                <div>
                    <h4 style="margin-top:0;">Actionable Recommendations</h4>
                    <ul class="insights-list" id="insights-actions"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: COMPARATOR -->
    <div id="comparator-view" class="hidden">
        <div class="controls">
            <select id="comp-week-select" onchange="updateComparator()"></select>
            <select id="comp-brand-select" onchange="updateComparator()"></select>
        </div>

        <div class="grid grid-3">
            <!-- Us -->
            <div class="card" style="border-top: 4px solid var(--primary);">
                <h3 id="comp-us-title">Our Brand</h3>
                <div class="grid grid-2">
                    <div>
                        <div class="kpi-label">Share</div>
                        <div class="kpi-value" style="font-size: 20px;" id="comp-us-share">-</div>
                    </div>
                    <div>
                        <div class="kpi-label">Price</div>
                        <div class="kpi-value" style="font-size: 20px;" id="comp-us-price">-</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <div class="tag tag-blue" id="comp-us-badges">-</div>
                </div>
            </div>

            <!-- VS -->
            <div style="display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; color: var(--text-sec);">
                VS
            </div>

            <!-- Them -->
            <div class="card" style="border-top: 4px solid var(--danger);">
                <h3 id="comp-them-title">Competitor</h3>
                <div class="grid grid-2">
                    <div>
                        <div class="kpi-label">Share</div>
                        <div class="kpi-value" style="font-size: 20px;" id="comp-them-share">-</div>
                    </div>
                    <div>
                        <div class="kpi-label">Price</div>
                        <div class="kpi-value" style="font-size: 20px;" id="comp-them-price">-</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <div class="tag tag-gray" id="comp-them-badges">-</div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>Direct Comparison: Rank vs Share (Selected Week)</h3>
            <div id="chart_comparison_scatter" class="chart-container"></div>
        </div>
    </div>
</div>

<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION (Synthetic Data used as placeholder)
    // ---------------------------------------------------------
    // In a real scenario, Python would print the JSON string here.
    const rawData = [{"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "AudioTech (Us)", "asin": "B00YABA001", "product_title": "AudioTech (Us) Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1604, "price": 50.99, "weekly_search_volume": 12896, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00COMP001", "product_title": "Sony Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2312, "price": 89.99, "weekly_search_volume": 12896, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00COMP002", "product_title": "JBL Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2036, "price": 49.99, "weekly_search_volume": 12896, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00COMP003", "product_title": "Bose Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1265, "price": 120.0, "weekly_search_volume": 12896, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00COMP004", "product_title": "Generic Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0537, "price": 25.0, "weekly_search_volume": 12896, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-01", "keywords": "bluetooth earphones", "competitor_brand": "AudioTech (Us)", "asin": "B00YABA001", "product_title": "AudioTech (Us) Wireless Headphone bluetooth earphones", "country_code": "US", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.174, "price": 50.99, "weekly_search_volume": 8109, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "AudioTech (Us)", "asin": "B00YABA001", "product_title": "AudioTech (Us) Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.178, "price": 59.99, "weekly_search_volume": 14000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00COMP001", "product_title": "Sony Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.28, "price": 76.49, "weekly_search_volume": 14000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "AudioTech (Us)", "asin": "B00YABA001", "product_title": "AudioTech (Us) Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.19, "price": 50.99, "weekly_search_volume": 17500, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/..."}, {"brand_aggregation": "Headphones Category", "parent_asin": "PARENT123", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00COMP001", "product_title": "Sony Wireless Headphone wireless headphones", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.24, "price": 89.99, "weekly_search_volume": 17500, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/..."}];
    
    // Add more synthetic data if rawData is sparse for better visualization in this demo
    // (In final version, rawData comes fully from Python).
    
    // ---------------------------------------------------------
    // 2. DATA PROCESSING
    // ---------------------------------------------------------
    let processedData = [];
    let ourBrand = "Unknown";
    let weeks = [];
    let allBrands = new Set();

    function processData() {
        // 1. Determine Our Brand
        const ourAsinRow = rawData.find(r => r.is_yaba_asin === 'Y');
        if (ourAsinRow) {
            ourBrand = ourAsinRow.competitor_brand || extractBrand(ourAsinRow);
        }
        document.getElementById('ourBrandLabel').innerText = "Our Brand: " + ourBrand;

        // 2. Normalize and Enhance
        processedData = rawData.map(row => {
            let brand = row.competitor_brand;
            if (!brand) brand = extractBrand(row);
            
            // Calculate Estimated Clicks (Volume * Share)
            const clicks = Math.round(row.weekly_search_volume * row.click_share);

            allBrands.add(brand);
            if (!weeks.includes(row.week_date)) weeks.push(row.week_date);

            return {
                ...row,
                brand_normalized: brand,
                clicks: clicks,
                is_us: (brand === ourBrand)
            };
        });

        weeks.sort();
        
        // Update Selectors
        const weekSelect = document.getElementById('comp-week-select');
        weekSelect.innerHTML = weeks.map(w => `<option value="${w}">${w}</option>`).join('');
        weekSelect.value = weeks[weeks.length - 1]; // Default to last week

        const brandSelect = document.getElementById('comp-brand-select');
        const competitors = Array.from(allBrands).filter(b => b !== ourBrand);
        brandSelect.innerHTML = competitors.map(b => `<option value="${b}">${b}</option>`).join('');
    }

    function extractBrand(row) {
        // Fallback logic
        if (row.product_title) return row.product_title.split(' ')[0];
        return "Unknown Brand";
    }

    // ---------------------------------------------------------
    // 3. GOOGLE CHARTS SETUP
    // ---------------------------------------------------------
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processData();
        calculateKPIs();
        drawGlobalTrend();
        drawCompetitiveness();
        drawEfficiency();
        drawLevers();
        generateInsights();
        updateComparator(); // Init tab 2
    }

    function calculateKPIs() {
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2] || lastWeek;
        
        // Filter Data
        const lastWeekData = processedData.filter(d => d.week_date === lastWeek);
        const prevWeekData = processedData.filter(d => d.week_date === prevWeek);

        // Metrics for US
        const getMetrics = (data) => {
            const ourData = data.filter(d => d.brand_normalized === ourBrand);
            const totalClicks = ourData.reduce((sum, r) => sum + r.clicks, 0);
            
            // Weighted Share
            const totalMarketVol = data.reduce((sum, r) => sum + r.weekly_search_volume, 0); // Rough approx
            const ourVol = ourData.reduce((sum, r) => sum + r.weekly_search_volume, 0);
             // Avg Share weighted by volume
            let weightedShareNum = 0;
            let totalVolForShare = 0;
            ourData.forEach(r => {
                weightedShareNum += (r.click_share * r.weekly_search_volume);
                totalVolForShare += r.weekly_search_volume;
            });
            const avgShare = totalVolForShare ? (weightedShareNum / totalVolForShare) : 0;
            
            const avgRank = ourData.reduce((sum, r) => sum + r.average_organic_rank, 0) / (ourData.length || 1);
            
            const promoCount = ourData.filter(r => r.weekly_number_of_days_with_deal > 0 || r.weekly_number_of_days_with_coupon > 0).length;

            return { totalClicks, avgShare, avgRank, promoCount };
        };

        const current = getMetrics(lastWeekData);
        const previous = getMetrics(prevWeekData);

        // Render
        document.getElementById('kpi-clicks').innerText = current.totalClicks.toLocaleString();
        renderTrend('kpi-clicks-trend', current.totalClicks, previous.totalClicks, false);

        document.getElementById('kpi-share').innerText = (current.avgShare * 100).toFixed(1) + '%';
        renderTrend('kpi-share-trend', current.avgShare, previous.avgShare, false); // Higher is better

        document.getElementById('kpi-rank').innerText = current.avgRank.toFixed(1);
        
        document.getElementById('kpi-promos').innerText = current.promoCount > 0 ? "Yes" : "No";
    }

    function renderTrend(elementId, curr, prev, lowerIsBetter) {
        const el = document.getElementById(elementId);
        if (prev === 0) { el.innerText = "-"; return; }
        
        const change = ((curr - prev) / prev) * 100;
        const icon = change >= 0 ? 'trending_up' : 'trending_down';
        const isGood = lowerIsBetter ? change < 0 : change > 0;
        const colorClass = isGood ? 'trend-up' : 'trend-down';
        
        el.className = colorClass;
        el.innerHTML = `<span class="material-icons" style="font-size:16px; margin-right:4px;">${icon}</span> ${Math.abs(change).toFixed(1)}%`;
    }

    // ---------------------------------------------------------
    // 4. CHART DRAWING FUNCTIONS
    // ---------------------------------------------------------

    function drawGlobalTrend() {
        // Aggregate by week: Total Clicks (Bar) and Our Share (Line)
        const dataTable = [['Week', 'Total Market Clicks', 'Our Share (%)']];
        
        weeks.forEach(week => {
            const weekData = processedData.filter(d => d.week_date === week);
            const totalClicks = weekData.reduce((sum, r) => sum + r.clicks, 0);
            
            const ourData = weekData.filter(d => d.brand_normalized === ourBrand);
            let shareNum = 0, shareDenom = 0;
            ourData.forEach(r => {
                shareNum += (r.click_share * r.weekly_search_volume);
                shareDenom += r.weekly_search_volume;
            });
            const ourShare = shareDenom ? (shareNum / shareDenom) * 100 : 0;
            
            dataTable.push([week.substring(5), totalClicks, ourShare]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            seriesType: 'bars',
            series: { 1: {type: 'line', targetAxisIndex: 1, color: '#007AFF', lineWidth: 3} },
            colors: ['#E5E5EA'],
            vAxes: { 0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''} },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            bar: { groupWidth: '50%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    function drawCompetitiveness() {
        // Line chart of Top 3 + Us
        // Find Top 3 Competitors by Share in last week
        const lastWeek = weeks[weeks.length - 1];
        const lastWeekData = processedData.filter(d => d.week_date === lastWeek);
        
        const brandShares = {};
        lastWeekData.forEach(r => {
            if (!brandShares[r.brand_normalized]) brandShares[r.brand_normalized] = 0;
            brandShares[r.brand_normalized] += (r.click_share * r.weekly_search_volume); // Use weighted sum proxy
        });
        
        const sortedBrands = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .map(e => e[0])
            .filter(b => b !== ourBrand)
            .slice(0, 3); // Top 3
            
        const brandsToChart = [ourBrand, ...sortedBrands];
        
        // Prepare Data Table
        const header = ['Week', ...brandsToChart];
        const rows = [];
        
        weeks.forEach(week => {
            const row = [week.substring(5)];
            const weekData = processedData.filter(d => d.week_date === week);
            
            brandsToChart.forEach(brand => {
                const bData = weekData.filter(d => d.brand_normalized === brand);
                // Simple avg share for chart across keywords
                const avgShare = bData.length ? (bData.reduce((s, r) => s + r.click_share, 0) / bData.length) : 0;
                row.push(avgShare);
            });
            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#007AFF', '#FF3B30', '#FF9500', '#34C759'], // Blue for us, then colors
            lineWidth: 2,
            chartArea: { width: '90%', height: '70%' },
            vAxis: { format: 'percent' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    function drawEfficiency() {
        // Scatter: X=Rank, Y=Share. Color by Us vs Them. Size = Volume.
        const lastWeek = weeks[weeks.length - 1];
        const weekData = processedData.filter(d => d.week_date === lastWeek);
        
        const dataTable = [['ID', 'Rank', 'Share', 'Brand', 'Volume']];
        
        weekData.forEach(r => {
            dataTable.push([
                r.brand_normalized,
                r.average_organic_rank,
                r.click_share,
                (r.brand_normalized === ourBrand ? 'Our Brand' : 'Competitor'),
                r.weekly_search_volume
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 }, // Invert axis
            vAxis: { title: 'Click Share', format: 'percent' },
            bubble: { textStyle: { fontSize: 11 } },
            colors: ['#8E8E93', '#007AFF'], // Competitor (Grey), Us (Blue) - Order depends on string sort
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.BubbleChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function drawLevers() {
        // Bar Chart: Share when Deal vs No Deal (Aggregated Last 4 weeks)
        const withDeal = processedData.filter(d => d.weekly_number_of_days_with_deal > 0);
        const withoutDeal = processedData.filter(d => d.weekly_number_of_days_with_deal === 0);
        
        const avgShareDeal = withDeal.length ? (withDeal.reduce((s,r) => s + r.click_share, 0) / withDeal.length) : 0;
        const avgShareNoDeal = withoutDeal.length ? (withoutDeal.reduce((s,r) => s + r.click_share, 0) / withoutDeal.length) : 0;

        const data = google.visualization.arrayToDataTable([
            ['Condition', 'Avg Click Share', { role: 'style' }],
            ['No Deal', avgShareNoDeal, 'color: #8E8E93'],
            ['With Deal', avgShareDeal, 'color: #34C759']
        ]);

        const options = {
            legend: { position: 'none' },
            vAxis: { format: 'percent' },
            title: 'Impact of Deals on Click Share (Avg)'
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    // ---------------------------------------------------------
    // 5. INSIGHTS GENERATION
    // ---------------------------------------------------------
    function generateInsights() {
        const findings = document.getElementById('insights-findings');
        const actions = document.getElementById('insights-actions');
        
        // Simple logic based on data
        const lastWeek = weeks[weeks.length - 1];
        const data = processedData.filter(d => d.week_date === lastWeek && d.brand_normalized === ourBrand);
        
        const avgRank = data.reduce((s,r)=>s+r.average_organic_rank,0)/(data.length||1);
        const hasDeal = data.some(r => r.weekly_number_of_days_with_deal > 0);
        
        let fHTML = "";
        fHTML += `<li><strong>Trend:</strong> Analyzed ${weeks.length} weeks of data for ${ourBrand}.</li>`;
        if (avgRank > 10) {
            fHTML += `<li><strong>Visibility Risk:</strong> Average rank is ${avgRank.toFixed(1)}, limiting organic traffic.</li>`;
        } else {
            fHTML += `<li><strong>Strong Visibility:</strong> Maintaining top page presence (Rank ${avgRank.toFixed(1)}).</li>`;
        }
        
        findings.innerHTML = fHTML;

        let aHTML = "";
        if (avgRank > 10) aHTML += `<li><strong>SEO Focus:</strong> Invest in keywords ranking 10-20 to push to Page 1.</li>`;
        if (!hasDeal) aHTML += `<li><strong>Promotion:</strong> Test a coupon to boost Click Share in the upcoming week.</li>`;
        aHTML += `<li><strong>Defense:</strong> Monitor competitors with aggressive pricing in the interactive tab.</li>`;
        
        actions.innerHTML = aHTML;
    }

    // ---------------------------------------------------------
    // 6. INTERACTIVE TAB
    // ---------------------------------------------------------
    function switchTab(tabId) {
        document.getElementById('report-view').className = 'hidden';
        document.getElementById('comparator-view').className = 'hidden';
        document.querySelector('.tabs button.active').classList.remove('active');
        
        if (tabId === 'report') {
            document.getElementById('report-view').className = '';
            event.target.classList.add('active');
        } else {
            document.getElementById('comparator-view').className = '';
            event.target.classList.add('active');
            updateComparator(); // Refresh chart size
        }
    }

    function updateComparator() {
        const week = document.getElementById('comp-week-select').value;
        const compBrand = document.getElementById('comp-brand-select').value;
        
        if (!week || !compBrand) return;

        // Update Text Cards
        const updateCard = (prefix, brand) => {
            const d = processedData.filter(r => r.week_date === week && r.brand_normalized === brand);
            if (!d.length) return;
            
            // Avg metrics across keywords
            const share = d.reduce((s,r)=>s+r.click_share,0) / d.length;
            const price = d.reduce((s,r)=>s+r.price,0) / d.length;
            const deals = d.some(r => r.weekly_number_of_days_with_deal > 0);
            
            document.getElementById(`${prefix}-title`).innerText = brand;
            document.getElementById(`${prefix}-share`).innerText = (share*100).toFixed(1) + '%';
            document.getElementById(`${prefix}-price`).innerText = '$' + price.toFixed(2);
            document.getElementById(`${prefix}-badges`).innerText = deals ? 'Active Deal' : 'No Deal';
        };

        updateCard('comp-us', ourBrand);
        updateCard('comp-them', compBrand);

        // Update Scatter Chart
        const weekData = processedData.filter(r => r.week_date === week && (r.brand_normalized === ourBrand || r.brand_normalized === compBrand));
        
        const dataTable = [['ID', 'Rank', 'Share', 'Brand']];
        weekData.forEach(r => {
            dataTable.push([
                r.keywords,
                r.average_organic_rank,
                r.click_share,
                r.brand_normalized
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            title: `Head-to-Head: ${ourBrand} vs ${compBrand}`,
            hAxis: { title: 'Rank', direction: -1 },
            vAxis: { title: 'Share', format: 'percent' },
            colors: ['#007AFF', '#FF3B30'],
            legend: { position: 'bottom' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_comparison_scatter'));
        chart.draw(data, options);
    }
    
    // Resize handler
    window.onresize = function() {
        drawGlobalTrend();
        drawCompetitiveness();
        drawEfficiency();
        drawLevers();
        if(!document.getElementById('comparator-view').classList.contains('hidden')) updateComparator();
    };

</script>

</body>
</html>