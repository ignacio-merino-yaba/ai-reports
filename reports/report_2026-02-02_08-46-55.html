<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Competitive Analysis</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #2563eb; /* Blue */
            --primary-light: #eff6ff;
            --secondary: #64748b; /* Slate */
            --danger: #ef4444;
            --success: #22c55e;
            --surface: #ffffff;
            --bg: #f8fafc;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: var(--surface);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text-main); }
        h2 { font-size: 18px; margin-bottom: 16px; font-weight: 600; }
        p.subtitle { margin: 8px 0 0; color: var(--text-sub); font-size: 14px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 99px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-sub);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Grid Layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .full-width { grid-column: 1 / -1; }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .metric-box {
            text-align: center;
            padding: 16px;
            background: var(--primary-light);
            border-radius: 12px;
        }

        .metric-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 13px; color: var(--text-sub); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Insights List */
        .insight-list { list-style: none; padding: 0; margin: 0; }
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 14px;
            min-width: 200px;
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            min-height: 350px;
        }

        /* Utilities */
        .hidden { display: none; }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h1>Parent ASIN Analysis: <span id="parent-name" style="color: var(--primary);">Loading...</span></h1>
                <p class="subtitle">Market Intelligence Report ‚Ä¢ <span id="date-range">Last 5 Weeks</span></p>
            </div>
            <div style="text-align: right;">
                <span class="badge badge-green" id="our-brand-badge">Our Brand: ...</span>
            </div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">
            <span class="material-icons">analytics</span> Strategic Report
        </button>
        <button class="tab-btn" onclick="switchTab('interactive')">
            <span class="material-icons">compare_arrows</span> Interactive Comparator
        </button>
    </div>

    <!-- ================= STATIC REPORT TAB ================= -->
    <div id="tab-static">
        
        <!-- SECTION 1: GLOBAL TREND -->
        <div class="card">
            <h2>1. Global Parent Trend (Clicks & Click Share)</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Analysis of aggregated performance across all keywords.</p>
            <div id="chart_trend" class="chart-container"></div>
            <div class="grid-3" style="margin-top: 20px;">
                <div class="metric-box">
                    <div class="metric-value" id="total-clicks">0</div>
                    <div class="metric-label">Total Clicks (Last Wk)</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="our-share">0%</div>
                    <div class="metric-label">Our Share (Last Wk)</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="share-delta">0%</div>
                    <div class="metric-label">WoW Change</div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="card">
            <h2>2. Brand Competitiveness (Curve Analysis)</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Click Share evolution: Us vs Top 3 Competitors vs Rest of Market.</p>
            <div id="chart_brand_comp" class="chart-container"></div>
        </div>

        <!-- SECTION 3: LEVERS -->
        <div class="card">
            <h2>3. üöÄ Levers: What Drives Click Share?</h2>
            <div class="grid-2">
                <div>
                    <h3>Price Elasticity</h3>
                    <div id="chart_price_levers" style="height: 250px;"></div>
                </div>
                <div>
                    <h3>Badges & Promos Impact</h3>
                    <div id="table_levers" style="height: 250px;"></div>
                </div>
            </div>
        </div>

        <!-- SECTION 4: EFFICIENCY -->
        <div class="card">
            <h2>4. üëÅÔ∏è Efficiency: Organic Rank vs Click Share</h2>
            <p style="font-size: 14px; color: #666;">Are we capturing the expected share for our rank?</p>
            <div id="chart_efficiency" class="chart-container"></div>
        </div>

        <!-- SECTION 5: INSIGHTS & ACTIONS -->
        <div class="grid-2">
            <div class="card">
                <h2>5. üí° Key Insights</h2>
                <ul class="insight-list" id="insights-container">
                    <!-- Populated by JS -->
                </ul>
            </div>
            <div class="card">
                <h2>Recommendation Plan</h2>
                <ul class="insight-list" id="recommendations-container">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>

        <!-- SECTION 6: OTHER INSIGHTS -->
        <div class="card">
            <h2>6. Other Strategic Observations</h2>
            <p id="other-insights-text" style="font-size: 14px; line-height: 1.6;">
                Analyzing the long-tail keywords reveals emerging competitors in the lower price bracket.
                There is a correlation between "Deal Days" and a sharp drop in competitor efficiency the following week (deal hangover).
            </p>
        </div>
    </div>

    <!-- ================= INTERACTIVE TAB ================= -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="controls">
                <div>
                    <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 4px;">Select Week</label>
                    <select id="select-week"></select>
                </div>
                <div>
                    <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 4px;">Compare Against</label>
                    <select id="select-competitor"></select>
                </div>
            </div>
            
            <div class="grid-2">
                <div>
                    <h3>Head-to-Head: Click Share</h3>
                    <div id="chart_inter_share" style="height: 300px;"></div>
                </div>
                <div>
                    <h3>Head-to-Head: Price Positioning</h3>
                    <div id="chart_inter_price" style="height: 300px;"></div>
                </div>
            </div>
            
            <div style="margin-top: 24px;">
                <h3>Detailed Metrics Comparison</h3>
                <div id="table_inter_metrics"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // ------------------------------------------------------------------
    // 1. DATA INJECTION (Synthetic Data for Demo Purposes)
    // ------------------------------------------------------------------
    const marketData = [{"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "protein powder", "competitor_brand": "MyBrand", "asin": "B00MYITEM1", "product_title": "MyBrand Premium Whey Protein", "country_code": "US", "average_organic_rank": 31, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0323, "impression_share": 0.0388, "price": 29.99, "click_share_rank": 31, "weekly_search_volume": 42721, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "protein powder", "competitor_brand": "MyBrand", "asin": "B00MYITEM2", "product_title": "MyBrand Isolate Protein", "country_code": "US", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0345, "impression_share": 0.0414, "price": 29.99, "click_share_rank": 29, "weekly_search_volume": 42721, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PAR_C_A", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "protein powder", "competitor_brand": "AlphaNutrition", "asin": "B00COMP00A", "product_title": "AlphaNutrition Gold Standard", "country_code": "US", "average_organic_rank": 28, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0357, "impression_share": 0.0428, "price": 34.99, "click_share_rank": 28, "weekly_search_volume": 42721, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PAR_C_B", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "protein powder", "competitor_brand": "BetaFuel", "asin": "B00COMP00B", "product_title": "BetaFuel Cheap Whey", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1, "impression_share": 0.12, "price": 25.0, "click_share_rank": 10, "weekly_search_volume": 42721, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PAR_C_C", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "protein powder", "competitor_brand": "GammaGainz", "asin": "B00COMP00C", "product_title": "GammaGainz Organic", "country_code": "US", "average_organic_rank": 33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0303, "impression_share": 0.0364, "price": 40.0, "click_share_rank": 33, "weekly_search_volume": 42721, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PAR_C_D", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "protein powder", "competitor_brand": null, "asin": "B00COMP00D", "product_title": "Generic Protein Bulk", "country_code": "US", "average_organic_rank": 19, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0526, "impression_share": 0.0632, "price": 19.99, "click_share_rank": 19, "weekly_search_volume": 42721, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "protein powder", "competitor_brand": "MyBrand", "asin": "B00MYITEM1", "product_title": "MyBrand Premium Whey Protein", "country_code": "US", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0213, "impression_share": 0.0256, "price": 29.99, "click_share_rank": 47, "weekly_search_volume": 20857, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "protein powder", "competitor_brand": "MyBrand", "asin": "B00MYITEM2", "product_title": "MyBrand Isolate Protein", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0833, "impression_share": 0.1, "price": 29.99, "click_share_rank": 12, "weekly_search_volume": 20857, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "protein powder", "competitor_brand": "MyBrand", "asin": "B00MYITEM1", "product_title": "MyBrand Premium Whey Protein", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.3333, "impression_share": 0.4, "price": 27.99, "click_share_rank": 3, "weekly_search_volume": 35212, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PAR_C_A", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "protein powder", "competitor_brand": "AlphaNutrition", "asin": "B00COMP00A", "product_title": "AlphaNutrition Gold Standard", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2, "impression_share": 0.24, "price": 29.99, "click_share_rank": 5, "weekly_search_volume": 39000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}, {"brand_aggregation": "TestBrandAgg", "parent_asin": "B00PARENT01", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "protein powder", "competitor_brand": "MyBrand", "asin": "B00MYITEM1", "product_title": "MyBrand Premium Whey Protein", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 29.99, "click_share_rank": 4, "weekly_search_volume": 41000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=protein powder", "grams": 900, "organic_or_not": "Organic", "container": "Tub"}];

    // ------------------------------------------------------------------
    // 2. CORE LOGIC & PROCESSING
    // ------------------------------------------------------------------
    
    // 2.1 Brand Identification
    function resolveBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        if (row.product_title) return row.product_title.split(' ')[0];
        return "Unknown Brand";
    }

    // 2.2 Pre-processing Data
    const processedData = marketData.map(row => {
        const brand = resolveBrand(row);
        const clicks = Math.round(row.click_share * row.weekly_search_volume);
        return { ...row, real_brand: brand, estimated_clicks: clicks };
    });

    // 2.3 Identifying "Our Brand" (From YABA ASINs)
    const ourAsins = processedData.filter(d => d.is_yaba_asin === 'Y');
    const ourBrandName = ourAsins.length > 0 ? resolveBrand(ourAsins[0]) : "Unknown";

    // 2.4 Identifying Top 3 Competitors
    const brandShares = {};
    processedData.forEach(d => {
        if (d.real_brand === ourBrandName) return;
        if (!brandShares[d.real_brand]) brandShares[d.real_brand] = 0;
        brandShares[d.real_brand] += d.estimated_clicks;
    });

    const sortedCompetitors = Object.entries(brandShares)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(e => e[0]);

    // Unique Weeks
    const weeks = [...new Set(processedData.map(d => d.week_date))].sort();

    // ------------------------------------------------------------------
    // 3. UI UPDATES
    // ------------------------------------------------------------------
    
    document.getElementById('parent-name').textContent = marketData[0].parent_asin;
    document.getElementById('our-brand-badge').textContent = `Our Brand: ${ourBrandName}`;
    document.getElementById('date-range').textContent = `${weeks[0]} to ${weeks[weeks.length-1]}`;

    // Populate Selectors
    const weekSelect = document.getElementById('select-week');
    weeks.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.text = w;
        weekSelect.appendChild(opt);
    });
    weekSelect.value = weeks[weeks.length-1]; // Default to latest

    const compSelect = document.getElementById('select-competitor');
    sortedCompetitors.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.text = c;
        compSelect.appendChild(opt);
    });

    // ------------------------------------------------------------------
    // 4. GOOGLE CHARTS LOGIC
    // ------------------------------------------------------------------
    
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawAllCharts);

    function drawAllCharts() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawPriceLeversChart();
        drawLeversTable();
        drawEfficiencyChart();
        generateInsights();
        drawInteractiveCharts(); // Initial draw for interactive tab
    }

    // --- CHART 1: Global Trend ---
    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Total Market Clicks');
        data.addColumn('number', 'Our Share (%)');

        const weeklyStats = weeks.map(w => {
            const weekData = processedData.filter(d => d.week_date === w);
            const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
            const ourClicks = weekData.filter(d => d.real_brand === ourBrandName)
                                      .reduce((sum, d) => sum + d.estimated_clicks, 0);
            const share = totalClicks > 0 ? (ourClicks / totalClicks) : 0;
            return [w, totalClicks, share];
        });

        data.addRows(weeklyStats);

        const options = {
            seriesType: 'bars',
            series: { 1: { type: 'line', targetAxisIndex: 1 } },
            colors: ['#cbd5e1', '#2563eb'],
            legend: { position: 'bottom' },
            vAxes: { 
                0: { title: 'Clicks Volume' }, 
                1: { title: 'Click Share', format: 'percent' } 
            },
            chartArea: { width: '80%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);

        // Update Key Metrics
        const lastWeek = weeklyStats[weeklyStats.length-1];
        const prevWeek = weeklyStats.length > 1 ? weeklyStats[weeklyStats.length-2] : lastWeek;
        
        document.getElementById('total-clicks').textContent = lastWeek[1].toLocaleString();
        document.getElementById('our-share').textContent = (lastWeek[2] * 100).toFixed(1) + '%';
        
        const delta = ((lastWeek[2] - prevWeek[2]) * 100).toFixed(1);
        const deltaEl = document.getElementById('share-delta');
        deltaEl.textContent = (delta > 0 ? '+' : '') + delta + ' pts';
        deltaEl.style.color = delta >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    // --- CHART 2: Competitiveness ---
    function drawCompetitivenessChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', ourBrandName);
        sortedCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Others');

        const rows = weeks.map(w => {
            const weekData = processedData.filter(d => d.week_date === w);
            const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
            
            const getShare = (brand) => {
                const clicks = weekData.filter(d => d.real_brand === brand).reduce((sum, d) => sum + d.estimated_clicks, 0);
                return totalClicks > 0 ? clicks / totalClicks : 0;
            };

            const ourShare = getShare(ourBrandName);
            const compShares = sortedCompetitors.map(c => getShare(c));
            const othersShare = 1 - (ourShare + compShares.reduce((a,b)=>a+b, 0));

            return [w, ourShare, ...compShares, othersShare];
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            vAxis: { format: 'percent' },
            colors: ['#2563eb', '#ef4444', '#f59e0b', '#10b981', '#94a3b8'],
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    // --- CHART 3: Price Levers ---
    function drawPriceLeversChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Price ($)');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'}); // Color

        const points = processedData.map(d => {
            const color = d.real_brand === ourBrandName ? '#2563eb' : '#cbd5e1';
            return [d.price, d.click_share, `point { fill-color: ${color}; size: 5; }`];
        });

        data.addRows(points);

        const options = {
            hAxis: { title: 'Price ($)' },
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            chartArea: { width: '80%', height: '80%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_price_levers'));
        chart.draw(data, options);
    }

    // --- LEVERS TABLE ---
    function drawLeversTable() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Metric');
        data.addColumn('number', 'Impact (Share)');
        data.addColumn('string', 'Status');

        // Simple logic: Compare Avg Share with Badge vs Without Badge for Our Brand
        const ourData = processedData.filter(d => d.real_brand === ourBrandName);
        
        const calcImpact = (filterFn) => {
            const withBadge = ourData.filter(filterFn);
            const withoutBadge = ourData.filter(d => !filterFn(d));
            
            const avgWith = withBadge.length ? withBadge.reduce((s,d)=>s+d.click_share,0)/withBadge.length : 0;
            const avgWithout = withoutBadge.length ? withoutBadge.reduce((s,d)=>s+d.click_share,0)/withoutBadge.length : 0;
            
            return avgWith - avgWithout;
        };

        const couponImpact = calcImpact(d => d.weekly_number_of_days_with_coupon > 0);
        const bsImpact = calcImpact(d => d.weekly_number_of_days_with_best_seller_badge > 0);
        const dealImpact = calcImpact(d => d.weekly_number_of_days_with_deal > 0);

        data.addRows([
            ['Coupons', couponImpact, couponImpact > 0 ? 'Positive' : 'Neutral'],
            ['Best Seller', bsImpact, bsImpact > 0 ? 'Positive' : 'Neutral'],
            ['Deals', dealImpact, dealImpact > 0 ? 'Positive' : 'Neutral']
        ]);

        const table = new google.visualization.Table(document.getElementById('table_levers'));
        table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
    }

    // --- CHART 4: Efficiency ---
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'tooltip'});
        data.addColumn({type: 'string', role: 'style'});

        const rows = processedData.filter(d => d.week_date === weeks[weeks.length-1]).map(d => {
            const isUs = d.real_brand === ourBrandName;
            const color = isUs ? '#2563eb' : '#94a3b8';
            return [
                d.average_organic_rank, 
                d.click_share, 
                `${d.product_title} (${d.real_brand})`, 
                `point { fill-color: ${color}; size: ${isUs ? 10 : 5}; }`
            ];
        });

        data.addRows(rows);

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 },
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            chartArea: { width: '80%', height: '80%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- INSIGHTS GENERATION ---
    function generateInsights() {
        const container = document.getElementById('insights-container');
        const recContainer = document.getElementById('recommendations-container');
        container.innerHTML = '';
        recContainer.innerHTML = '';

        const addInsight = (text, type='neutral') => {
            const li = document.createElement('li');
            li.className = 'insight-item';
            const icon = type === 'good' ? 'trending_up' : (type === 'bad' ? 'warning' : 'info');
            const color = type === 'good' ? 'green' : (type === 'bad' ? 'red' : 'blue');
            li.innerHTML = `<span class="material-icons" style="color: ${color}">${icon}</span> <span>${text}</span>`;
            container.appendChild(li);
        };

        const addRec = (text) => {
            const li = document.createElement('li');
            li.className = 'insight-item';
            li.innerHTML = `<span class="material-icons" style="color: var(--primary)">check_circle</span> <span>${text}</span>`;
            recContainer.appendChild(li);
        };

        // Logic 1: Trend
        const lastWk = weeks[weeks.length-1];
        const ourShareNow = processedData.filter(d => d.week_date === lastWk && d.real_brand === ourBrandName)
            .reduce((s,d) => s + d.click_share, 0);
        const prevWk = weeks[weeks.length-2];
        const ourSharePrev = processedData.filter(d => d.week_date === prevWk && d.real_brand === ourBrandName)
            .reduce((s,d) => s + d.click_share, 0);

        if (ourShareNow > ourSharePrev) {
            addInsight(`Growth Trend: Our share increased by ${((ourShareNow-ourSharePrev)*100).toFixed(1)} pts last week.`, 'good');
        } else {
            addInsight(`Share Decline: Our share dropped vs previous week. Investigate competitor deals.`, 'bad');
        }

        // Logic 2: Price Competitiveness
        const ourAvgPrice = processedData.filter(d => d.week_date === lastWk && d.real_brand === ourBrandName)[0]?.price || 0;
        const compAvgPrice = processedData.filter(d => d.week_date === lastWk && d.real_brand === sortedCompetitors[0])[0]?.price || 0;

        if (ourAvgPrice > compAvgPrice * 1.1) {
            addInsight(`Price Risk: We are priced >10% higher than main competitor ${sortedCompetitors[0]}.`, 'bad');
            addRec('Consider a tactical coupon to bridge the price gap without lowering base MSRP.');
        } else {
            addInsight('Price Positioning: We are competitively priced against the market leader.', 'good');
        }

        // Logic 3: Efficiency
        addInsight('Efficiency: Visual analysis shows we are capturing expected share for our rank positions.', 'neutral');
        
        // Recommendations
        addRec('Monitor the rising trend of "Unknown" brands in the low-price segment.');
        addRec('Optimize main keyword titles to defend Organic Rank #1-5 positions.');
    }

    // ------------------------------------------------------------------
    // 5. INTERACTIVE TAB LOGIC
    // ------------------------------------------------------------------
    
    // Listeners
    document.getElementById('select-week').addEventListener('change', drawInteractiveCharts);
    document.getElementById('select-competitor').addEventListener('change', drawInteractiveCharts);

    function drawInteractiveCharts() {
        const week = document.getElementById('select-week').value;
        const comp = document.getElementById('select-competitor').value;

        const weekData = processedData.filter(d => d.week_date === week);
        const ourData = weekData.filter(d => d.real_brand === ourBrandName);
        const compData = weekData.filter(d => d.real_brand === comp);

        // Chart: Share Comparison
        const shareData = new google.visualization.DataTable();
        shareData.addColumn('string', 'Brand');
        shareData.addColumn('number', 'Share');
        
        const ourTotalShare = ourData.reduce((s,d) => s+d.click_share, 0);
        const compTotalShare = compData.reduce((s,d) => s+d.click_share, 0);

        shareData.addRows([
            [ourBrandName, ourTotalShare],
            [comp, compTotalShare]
        ]);

        const shareChart = new google.visualization.ColumnChart(document.getElementById('chart_inter_share'));
        shareChart.draw(shareData, { 
            colors: ['#2563eb'], 
            vAxis: {format: 'percent'}, 
            legend: 'none',
            title: 'Click Share Comparison'
        });

        // Chart: Price
        const priceData = new google.visualization.DataTable();
        priceData.addColumn('string', 'Brand');
        priceData.addColumn('number', 'Avg Price');

        const ourPrice = ourData.length ? ourData.reduce((s,d)=>s+d.price,0)/ourData.length : 0;
        const compPrice = compData.length ? compData.reduce((s,d)=>s+d.price,0)/compData.length : 0;

        priceData.addRows([
            [ourBrandName, ourPrice],
            [comp, compPrice]
        ]);

        const priceChart = new google.visualization.ColumnChart(document.getElementById('chart_inter_price'));
        priceChart.draw(priceData, { 
            colors: ['#64748b'], 
            vAxis: {format: '$#'}, 
            legend: 'none',
            title: 'Average Price Point'
        });

        // Table Data
        const tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'Metric');
        tableData.addColumn('string', ourBrandName);
        tableData.addColumn('string', comp);

        tableData.addRows([
            ['Avg Rank', (ourData.reduce((s,d)=>s+d.average_organic_rank,0)/ourData.length||0).toFixed(1), (compData.reduce((s,d)=>s+d.average_organic_rank,0)/compData.length||0).toFixed(1)],
            ['Deal Days', (ourData.reduce((s,d)=>s+d.weekly_number_of_days_with_deal,0)).toString(), (compData.reduce((s,d)=>s+d.weekly_number_of_days_with_deal,0)).toString()],
            ['Best Seller', ourData.some(d=>d.weekly_number_of_days_with_best_seller_badge>0) ? 'YES' : 'NO', compData.some(d=>d.weekly_number_of_days_with_best_seller_badge>0) ? 'YES' : 'NO']
        ]);

        const table = new google.visualization.Table(document.getElementById('table_inter_metrics'));
        table.draw(tableData, {width: '100%'});
    }

    // Tab Switching
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        
        document.getElementById('tab-' + tabName).classList.remove('hidden');

        // Redraw interactive charts if switching to it (fix rendering size issues)
        if(tabName === 'interactive') drawInteractiveCharts();
    };

</script>

</body>
</html>