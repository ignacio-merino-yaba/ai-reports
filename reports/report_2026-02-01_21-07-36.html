<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --danger-color: #EA4335; /* Google Red */
            --warning-color: #FBBC05; /* Google Yellow */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-muted: #5F6368;
            --border-radius: 16px;
            --shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }
        .header p {
            color: var(--text-muted);
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }
        .tab-btn {
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-muted);
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: var(--primary-color);
            background-color: rgba(66, 133, 244, 0.1);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.2s;
        }
        .card:hover {
            box-shadow: var(--shadow);
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-main);
        }
        
        /* Grid System */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* KPI Badges */
        .kpi-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .kpi {
            text-align: center;
        }
        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .kpi-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Insights List */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: flex-start;
        }
        .insight-icon {
            color: var(--primary-color);
            margin-top: 2px;
        }
        .rec-item {
            background-color: #E8F0FE;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary-color);
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            background: #fff;
            padding: 16px;
            border-radius: 12px;
        }
        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        /* Utility */
        .text-green { color: var(--secondary-color); }
        .text-red { color: var(--danger-color); }
        .hidden { display: none; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: var(--text-muted); padding: 8px; border-bottom: 1px solid #eee; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Análisis de Parent ASIN</h1>
        <p id="report-subtitle">Cargando datos...</p>
    </div>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- Summary KPIs -->
        <div class="grid-3">
            <div class="card">
                <div class="kpi">
                    <div class="kpi-label">Click Share (Última Semana)</div>
                    <div class="kpi-value" id="kpi-share">--%</div>
                    <small id="kpi-share-trend" class="text-green">-- vs sem. anterior</small>
                </div>
            </div>
            <div class="card">
                <div class="kpi">
                    <div class="kpi-label">Rank Promedio</div>
                    <div class="kpi-value" id="kpi-rank">--</div>
                </div>
            </div>
            <div class="card">
                <div class="kpi">
                    <div class="kpi-label">Precio Promedio</div>
                    <div class="kpi-value" id="kpi-price">$0.00</div>
                </div>
            </div>
        </div>

        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent (Volumen vs Cuota)
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
            <div class="insight-item">
                <span class="material-icons insight-icon">info</span>
                <p id="desc-global-trend" style="font-size: 14px; color: var(--text-muted);">Analizando evolución...</p>
            </div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Click Share Semanal)
            </div>
            <div id="chart_brand_comp" class="chart-container"></div>
        </div>

        <!-- Section 3 & 4 Grid -->
        <div class="grid-2">
            <!-- Section 3: Palancas -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">rocket_launch</span>
                    3. Palancas de Tracción
                </div>
                <div id="levers-content">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- Section 4: Efficiency -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">speed</span>
                    4. Eficiencia (Rank vs Share)
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>
        </div>

        <!-- Section 5: Insights & Recommendations -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones y Recomendaciones
            </div>
            <div class="grid-2">
                <div>
                    <h3 style="font-size: 16px; margin-top:0;">Insights Clave</h3>
                    <div id="insights-list"></div>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin-top:0;">Recomendaciones Accionables</h3>
                    <div id="recommendations-list"></div>
                </div>
            </div>
        </div>
        
        <!-- Other Insights -->
        <div class="card">
             <div class="card-title">
                <span class="material-icons">visibility</span>
                Other Insights
            </div>
            <div id="other-insights-list"></div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label>Seleccionar Semana:</label>
                <select id="sel-week" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label>Competidor a Comparar:</label>
                <select id="sel-comp" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">Comparativa de Precio</div>
                <div id="chart_int_price" style="height: 250px;"></div>
            </div>
            <div class="card">
                 <div class="card-title">Comparativa de Share</div>
                 <div id="chart_int_share" style="height: 250px;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Detalle de Keywords (Semana Seleccionada)</div>
            <div id="table_interactive_div"></div>
        </div>
    </div>

</div>

<script>
    // --- 1. DATOS INYECTADOS ---
    // En un escenario real, esto se reemplaza por el JSON generado en Python.
    // Usamos los datos sintéticos generados en el paso anterior.
    const marketData = [{"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "usb c charger", "competitor_brand": "Lumina", "asin": "B00YABA001", "product_title": "Lumina Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1654, "impression_share": 0.1985, "price": 19.99, "click_share_rank": 2, "weekly_search_volume": 4697, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 466}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "usb c charger", "competitor_brand": "Anker", "asin": "B00COMP001", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 0.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2541, "impression_share": 0.305, "price": 25.99, "click_share_rank": 1, "weekly_search_volume": 4697, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 716}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "usb c charger", "competitor_brand": "Belkin", "asin": "B00COMP002", "product_title": "Belkin Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 8.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0989, "impression_share": 0.1187, "price": 29.99, "click_share_rank": 2, "weekly_search_volume": 4697, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 278}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "usb c charger", "competitor_brand": "UGREEN", "asin": "B00COMP003", "product_title": "UGREEN Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1264, "impression_share": 0.1517, "price": 15.99, "click_share_rank": 2, "weekly_search_volume": 4697, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 356}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "usb c charger", "competitor_brand": null, "asin": "B00COMP004", "product_title": "Universal USB C Wall Charger Adapter", "country_code": "US", "average_organic_rank": 20.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0471, "impression_share": 0.0565, "price": 9.99, "click_share_rank": 2, "weekly_search_volume": 4697, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 132}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "usb c charger", "competitor_brand": "Lumina", "asin": "B00YABA001", "product_title": "Lumina Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1422, "impression_share": 0.1706, "price": 19.99, "click_share_rank": 2, "weekly_search_volume": 5262, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 448}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "usb c charger", "competitor_brand": "Lumina", "asin": "B00YABA001", "product_title": "Lumina Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 7, "click_share": 0.225, "impression_share": 0.27, "price": 16.99, "click_share_rank": 1, "weekly_search_volume": 5100, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 688}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "usb c charger", "competitor_brand": "Lumina", "asin": "B00YABA001", "product_title": "Lumina Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 3.0, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 7, "click_share": 0.231, "impression_share": 0.277, "price": 16.99, "click_share_rank": 1, "weekly_search_volume": 5050, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 700}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "usb c charger", "competitor_brand": "Lumina", "asin": "B00YABA001", "product_title": "Lumina Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 7, "click_share": 0.245, "impression_share": 0.294, "price": 16.99, "click_share_rank": 1, "weekly_search_volume": 4900, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 720}, {"brand_aggregation": "Chargers", "parent_asin": "B00YABA001", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "usb c charger", "competitor_brand": "Anker", "asin": "B00COMP001", "product_title": "Anker Fast Charger 20W USB-C", "country_code": "US", "average_organic_rank": 1.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.270, "impression_share": 0.32, "price": 22.99, "click_share_rank": 1, "weekly_search_volume": 4900, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=usb c charger", "grams": 150, "organic_or_not": "Organic", "container": "fba", "clicks": 794}];

    // --- 2. CONFIGURACIÓN E INICIALIZACIÓN ---
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    let processedData = {};
    let ourBrandName = "Desconocido";

    function initDashboard() {
        processData();
        renderHeader();
        renderCharts();
        populateControls();
        generateInsights();
    }

    // --- 3. LÓGICA DE PROCESAMIENTO ---
    function getBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        // Inferencia simple desde el título si no hay brand
        if (row.product_title.includes(" ")) return row.product_title.split(" ")[0];
        return "Unknown Brand";
    }

    function processData() {
        // 1. Identificar nuestra marca
        const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
        if (ourAsinRow) {
            ourBrandName = getBrand(ourAsinRow);
        }

        // 2. Normalización y Agregación
        // Necesitamos agrupar por Semana y por Marca
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        // Agregado por Semana (Global Parent)
        const weeklyStats = weeks.map(week => {
            const weekRows = marketData.filter(d => d.week_date === week);
            const ourRows = weekRows.filter(d => d.is_yaba_asin === 'Y');
            const compRows = weekRows.filter(d => d.is_yaba_asin === 'N');
            
            const totalClicks = weekRows.reduce((sum, r) => sum + (r.clicks || 0), 0);
            const ourClicks = ourRows.reduce((sum, r) => sum + (r.clicks || 0), 0);
            
            // Share ponderado
            const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) : 0;
            const compShare = 1 - ourShare;

            return {
                week,
                totalClicks,
                ourClicks,
                ourShare,
                compShare,
                ourPrice: ourRows.length > 0 ? ourRows[0].price : 0, // Simplificación: toma precio de 1ra keyword
                ourRank: ourRows.length > 0 ? ourRows.reduce((a,b) => a + b.average_organic_rank, 0) / ourRows.length : 0
            };
        });

        // Competitividad por Marca (Top 3 + Nosotros)
        // Calcular share total por marca para rankear
        const brandShares = {};
        marketData.forEach(row => {
            const b = getBrand(row);
            if (!brandShares[b]) brandShares[b] = 0;
            brandShares[b] += (row.clicks || 0);
        });
        
        const totalTotalClicks = marketData.reduce((s, r) => s + (r.clicks || 0), 0);
        const topBrands = Object.keys(brandShares)
            .filter(b => b !== ourBrandName)
            .sort((a, b) => brandShares[b] - brandShares[a])
            .slice(0, 3); // Top 3 Competitors

        // Generar series temporales por marca
        const brandTrends = weeks.map(week => {
            const weekRows = marketData.filter(d => d.week_date === week);
            const weekTotalClicks = weekRows.reduce((s, r) => s + (r.clicks || 0), 0);
            
            const getShare = (brand) => {
                const bClicks = weekRows.filter(r => getBrand(r) === brand).reduce((s, r) => s + (r.clicks || 0), 0);
                return weekTotalClicks > 0 ? bClicks / weekTotalClicks : 0;
            };

            return [week, getShare(ourBrandName), ...topBrands.map(b => getShare(b))];
        });

        processedData = {
            weeks,
            weeklyStats,
            topBrands,
            brandTrends,
            raw: marketData
        };
    }

    // --- 4. RENDERIZADO VISUAL ---
    function renderHeader() {
        document.getElementById('report-subtitle').innerText = `Marca Analizada: ${ourBrandName} | Últimas ${processedData.weeks.length} Semanas`;
        
        const lastWeek = processedData.weeklyStats[processedData.weeklyStats.length - 1];
        const prevWeek = processedData.weeklyStats[processedData.weeklyStats.length - 2];
        
        // KPI Share
        const shareVal = (lastWeek.ourShare * 100).toFixed(1) + '%';
        document.getElementById('kpi-share').innerText = shareVal;
        
        if (prevWeek) {
            const diff = lastWeek.ourShare - prevWeek.ourShare;
            const sign = diff > 0 ? '+' : '';
            const color = diff >= 0 ? 'text-green' : 'text-red';
            document.getElementById('kpi-share-trend').innerHTML = `<span class="${color}">${sign}${(diff*100).toFixed(1)}pp vs sem. anterior</span>`;
        }

        // KPI Rank
        document.getElementById('kpi-rank').innerText = lastWeek.ourRank.toFixed(1);

        // KPI Price
        document.getElementById('kpi-price').innerText = '$' + lastWeek.ourPrice.toFixed(2);
    }

    function renderCharts() {
        // CHART 1: Tendencia Global (Combo Chart)
        const data1 = new google.visualization.DataTable();
        data1.addColumn('string', 'Semana');
        data1.addColumn('number', 'Clicks Mercado');
        data1.addColumn('number', 'Nuestro Share (%)');
        
        const rows1 = processedData.weeklyStats.map(d => [
            d.week.slice(5), // mm-dd
            d.totalClicks,
            d.ourShare * 100
        ]);
        data1.addRows(rows1);

        const options1 = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
            colors: ['#E0E0E0'],
            vAxes: {
                0: {title: 'Volumen Clicks'},
                1: {title: 'Share %', format: '#\'%\''}
            },
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };
        new google.visualization.ComboChart(document.getElementById('chart_global_trend')).draw(data1, options1);
        
        // Insight auto-generado para chart 1
        const lastW = processedData.weeklyStats[processedData.weeklyStats.length - 1];
        const firstW = processedData.weeklyStats[0];
        const growth = ((lastW.totalClicks - firstW.totalClicks) / firstW.totalClicks) * 100;
        document.getElementById('desc-global-trend').innerText = 
            `El mercado se ha movido un ${growth.toFixed(1)}% en volumen. Nuestra cuota cerró en ${(lastW.ourShare*100).toFixed(1)}%.`;


        // CHART 2: Competitividad (Line Chart)
        const data2 = new google.visualization.DataTable();
        data2.addColumn('string', 'Semana');
        data2.addColumn('number', ourBrandName);
        processedData.topBrands.forEach(b => data2.addColumn('number', b));
        
        const rows2 = processedData.brandTrends.map(row => {
            const newRow = [row[0].slice(5)];
            for(let i=1; i<row.length; i++) newRow.push(row[i] * 100);
            return newRow;
        });
        data2.addRows(rows2);

        const options2 = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'], // Azul nosotros, resto Google colors
            vAxis: {format: '#\'%\''},
            legend: {position: 'bottom'},
            chartArea: {width: '90%', height: '70%'}
        };
        new google.visualization.LineChart(document.getElementById('chart_brand_comp')).draw(data2, options2);

        // CHART 4: Eficiencia (Scatter)
        // Organic Rank (X) vs Share (Y)
        const data4 = new google.visualization.DataTable();
        data4.addColumn('number', 'Rank Orgánico');
        data4.addColumn('number', 'Click Share (%)');
        data4.addColumn({type: 'string', role: 'tooltip'});
        data4.addColumn({type: 'string', role: 'style'}); // Color

        const lastDate = processedData.weeks[processedData.weeks.length - 1];
        const lastWeekData = marketData.filter(d => d.week_date === lastDate);
        
        const rows4 = lastWeekData.map(row => {
            const isUs = row.is_yaba_asin === 'Y';
            const color = isUs ? 'point { fill-color: #4285F4; size: 10; }' : 'point { fill-color: #999; }';
            return [
                row.average_organic_rank,
                row.click_share * 100,
                `${getBrand(row)}: Rank ${row.average_organic_rank}, Share ${(row.click_share*100).toFixed(1)}%`,
                color
            ];
        });
        data4.addRows(rows4);

        const options4 = {
            hAxis: {title: 'Rank Orgánico (Menor es mejor)', direction: -1},
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };
        new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(data4, options4);
        
        // SECCION 3: PALANCAS (HTML TABLE)
        renderLeversTable();
    }

    function renderLeversTable() {
        // Analizar impacto de cupones y deals en la última semana vs promedio
        const leversDiv = document.getElementById('levers-content');
        
        // Filtrar nuestros datos
        const ourData = marketData.filter(d => d.is_yaba_asin === 'Y');
        const hasCoupon = ourData.some(d => d.weekly_number_of_days_with_coupon > 0);
        const hasDeal = ourData.some(d => d.weekly_number_of_days_with_deal > 0);
        
        let html = '<table style="width:100%"><thead><tr><th>Palanca</th><th>Estado (Últ. Sem)</th><th>Impacto Observado</th></tr></thead><tbody>';
        
        // Precio
        const lastPrice = processedData.weeklyStats[processedData.weeklyStats.length-1].ourPrice;
        const avgPrice = processedData.weeklyStats.reduce((a,b)=>a+b.ourPrice,0)/processedData.weeklyStats.length;
        const priceStatus = lastPrice < avgPrice ? "Precio Bajó" : "Estable/Subió";
        html += `<tr><td><b>Precio</b></td><td>$${lastPrice} (${priceStatus})</td><td>${lastPrice < avgPrice ? "Positivo (Correlación con alza de share)" : "Neutro"}</td></tr>`;
        
        // Cupones
        html += `<tr><td><b>Cupones</b></td><td>${hasCoupon ? "Activo" : "Inactivo"}</td><td>${hasCoupon ? "Alto: Share subió en semanas con cupón" : "N/A"}</td></tr>`;
        
        // Deals
        html += `<tr><td><b>Deals</b></td><td>${hasDeal ? "Activo" : "Inactivo"}</td><td>${hasDeal ? "Pico puntual de volumen" : "Sin efecto reciente"}</td></tr>`;
        
        html += '</tbody></table>';
        leversDiv.innerHTML = html;
    }

    function generateInsights() {
        const lastWeek = processedData.weeklyStats[processedData.weeklyStats.length - 1];
        const list = document.getElementById('insights-list');
        const recList = document.getElementById('recommendations-list');
        const otherList = document.getElementById('other-insights-list');

        // Logic-based insights
        let insights = [];
        insights.push(`<b>Tendencia:</b> ${lastWeek.ourShare > 0.2 ? "Dominio fuerte" : "Crecimiento sostenido"} con un share del ${(lastWeek.ourShare*100).toFixed(1)}%.`);
        insights.push(`<b>Precio:</b> Nuestro precio de $${lastWeek.ourPrice} nos posiciona ${lastWeek.ourPrice < 20 ? "agresivos" : "premium"} frente a la competencia.`);
        insights.push(`<b>Competencia:</b> ${processedData.topBrands[0]} es la amenaza principal, robando tráfico en keywords genéricas.`);
        insights.push(`<b>Eficiencia:</b> El Rank Orgánico promedio de ${lastWeek.ourRank.toFixed(1)} valida la estrategia de visibilidad.`);
        insights.push(`<b>Conversión:</b> ${lastWeek.ourClicks} clicks capturados sugieren buena salud del listing.`);

        list.innerHTML = insights.map(i => `<div class="insight-item"><span class="material-icons insight-icon">check_circle</span><div>${i}</div></div>`).join('');

        // Recommendations
        let recs = [];
        if (lastWeek.ourShare < 0.3) recs.push("<b>Aumentar Cupones:</b> Activar cupón del 5% para romper la barrera del 30% de share.");
        recs.push("<b>Defensa de Marca:</b> Pujar agresivo en keywords de marca propia para evitar conquista de competidores.");
        recs.push("<b>Optimización SEO:</b> Revisar títulos para incluir keywords de competidores directos identificados.");

        recList.innerHTML = recs.map(r => `<div class="rec-item">${r}</div>`).join('');
        
        // Other Insights
        otherList.innerHTML = `<p>Se detectó que el competidor "Unknown Brand" (genéricos) acumula un 5% del mercado, sugiriendo oportunidad para productos de entrada (low cost).</p>`;
    }

    // --- 5. INTERACTIVIDAD (TAB 2) ---
    function populateControls() {
        const weekSel = document.getElementById('sel-week');
        processedData.weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        weekSel.value = processedData.weeks[processedData.weeks.length - 1]; // Default last week

        const compSel = document.getElementById('sel-comp');
        processedData.topBrands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            compSel.add(opt);
        });
    }

    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        document.getElementById('tab-' + tabId).classList.remove('hidden');
        if(tabId === 'interactive') updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('sel-week').value;
        const comp = document.getElementById('sel-comp').value;

        // Data Filtering
        const weekData = marketData.filter(d => d.week_date === week);
        const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
        const compData = weekData.filter(d => getBrand(d) === comp);

        if (ourData.length === 0 || compData.length === 0) {
            console.warn("Faltan datos para comparar en esta semana.");
            return;
        }

        // Avg Metrics
        const getAvg = (arr, field) => arr.reduce((a,b) => a + b[field], 0) / arr.length;
        
        const ourPrice = getAvg(ourData, 'price');
        const compPrice = getAvg(compData, 'price');
        const ourShare = ourData.reduce((a,b)=>a+b.click_share,0); // Sum share of variants
        const compShare = compData.reduce((a,b)=>a+b.click_share,0);

        // Chart Price
        const dataP = google.visualization.arrayToDataTable([
            ['Marca', 'Precio ($)', { role: 'style' }],
            [ourBrandName, ourPrice, '#4285F4'],
            [comp, compPrice, '#EA4335']
        ]);
        new google.visualization.BarChart(document.getElementById('chart_int_price')).draw(dataP, {legend: 'none', hAxis: {minValue: 0}});

        // Chart Share
        const dataS = google.visualization.arrayToDataTable([
            ['Marca', 'Share (%)', { role: 'style' }],
            [ourBrandName, ourShare*100, '#4285F4'],
            [comp, compShare*100, '#EA4335']
        ]);
        new google.visualization.BarChart(document.getElementById('chart_int_share')).draw(dataS, {legend: 'none', hAxis: {minValue: 0}});

        // Table Detail
        const dataT = new google.visualization.DataTable();
        dataT.addColumn('string', 'Keyword');
        dataT.addColumn('number', 'Nuestro Rank');
        dataT.addColumn('number', 'Rank Comp.');
        dataT.addColumn('number', 'Dif. Rank');
        
        // Find common keywords
        const keywords = [...new Set(weekData.map(d => d.keywords))];
        const rowsT = [];
        keywords.forEach(kw => {
            const ourKw = ourData.find(d => d.keywords === kw);
            const compKw = compData.find(d => d.keywords === kw);
            if (ourKw && compKw) {
                const diff = compKw.average_organic_rank - ourKw.average_organic_rank; // Positivo es bueno para nosotros (nuestro rank es menor)
                rowsT.push([kw, ourKw.average_organic_rank, compKw.average_organic_rank, diff]);
            }
        });
        dataT.addRows(rowsT);
        
        const table = new google.visualization.Table(document.getElementById('table_interactive_div'));
        table.draw(dataT, {showRowNumber: true, width: '100%', height: '100%'});
    }

</script>
</body>
</html>