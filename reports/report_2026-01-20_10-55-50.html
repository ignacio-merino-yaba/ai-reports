<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Performance Report</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #0071e3;
            --secondary: #1d1d1f;
            --bg-body: #f5f5f7;
            --bg-card: #ffffff;
            --text-main: #1d1d1f;
            --text-muted: #86868b;
            --danger: #ff3b30;
            --success: #34c759;
            --warning: #ffcc00;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }
        .header p {
            color: var(--text-muted);
            margin: 5px 0 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 25px;
        }
        .tab-btn {
            border: none;
            background: none;
            padding: 8px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--bg-card);
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .kpi-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
            letter-spacing: -1px;
        }
        .kpi-trend {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        
        /* Sections */
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-container {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            min-height: 400px;
        }

        /* Insights Box */
        .insights-box {
            background: linear-gradient(135deg, #0071e3 0%, #4285f4 100%);
            border-radius: 18px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
        }
        .insights-box h3 { margin-top: 0; }
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 12px;
        }
        .insight-icon { font-size: 24px; }
        .rec-list li { margin-bottom: 8px; }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        select {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid #d2d2d7;
            background-color: var(--bg-card);
            font-size: 14px;
            font-weight: 500;
        }

        /* Utility */
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Market Intelligence: Parent ASIN Report</h1>
            <p>Strategic Analysis & Competitor Benchmarking</p>
        </div>
        <div style="text-align: right;">
            <p id="date-range">Analysed Period: Last 4 Weeks</p>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Strategic Overview</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Head-to-Head Lab</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- KPI Row -->
        <div class="kpi-grid">
            <div class="card">
                <div class="kpi-label">Total Parent Clicks (Est.)</div>
                <div class="kpi-value" id="kpi-clicks">-</div>
                <div class="kpi-trend" id="kpi-clicks-trend"></div>
            </div>
            <div class="card">
                <div class="kpi-label">Our Click Share</div>
                <div class="kpi-value" id="kpi-share">-</div>
                <div class="kpi-trend" id="kpi-share-trend"></div>
            </div>
            <div class="card">
                <div class="kpi-label">Avg. Organic Rank</div>
                <div class="kpi-value" id="kpi-rank">-</div>
                <div class="kpi-trend" id="kpi-rank-trend"></div>
            </div>
            <div class="card">
                <div class="kpi-label">Price Premium</div>
                <div class="kpi-value" id="kpi-price">-</div>
                <div class="kpi-trend">vs Market Avg</div>
            </div>
        </div>

        <!-- Section 1: Global Trend -->
        <div class="section-title">
            <span class="material-icons">trending_up</span> 1. Global Parent Trend (Volume vs Share)
        </div>
        <div class="chart-container" id="chart_global_trend"></div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="section-title">
            <span class="material-icons">storefront</span> 2. Brand Competitiveness (Share of Voice)
        </div>
        <div class="chart-container" id="chart_brand_share"></div>

        <!-- Section 3 & 4: Efficiency & Levers -->
        <div class="section-title">
            <span class="material-icons">bolt</span> 3. Organic Efficiency (Rank vs Click Share)
        </div>
        <div class="chart-container" id="chart_efficiency"></div>

        <!-- Section 5: Insights & Recommendations -->
        <div class="section-title">
            <span class="material-icons">lightbulb</span> 4. Key Conclusions & Actions
        </div>
        <div class="insights-box">
            <h3>Strategic Insights</h3>
            <div class="insight-item">
                <span class="material-icons insight-icon">analytics</span>
                <div>
                    <strong>Resilient Share in Shrinking Market:</strong> 
                    While total search volume dropped significantly (>50%) post-holiday, 
                    <strong>NaturaleBio</strong> increased its Click Share (approx. 21.6% to 22.6%), 
                    proving high customer loyalty or effective ranking despite lower traffic.
                </div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">warning</span>
                <div>
                    <strong>Primary Threat: NORITUAL LAB:</strong> 
                    This competitor consistently dominates with ~18-19% share on specific ASINs. 
                    Their strength correlates with holding the "Amazon Choice" badge for 7 days/week in key periods.
                </div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">monetization_on</span>
                <div>
                    <strong>Premium Positioning Success:</strong> 
                    We maintain a top 3 market position despite a higher price point (~19.90€) 
                    compared to the competitor average (~15.70€). Our "Efficiency" (Share per Rank unit) is high.
                </div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">stars</span>
                <div>
                    <strong>Badge & Rank Stability:</strong> 
                    Our ASINs maintain stable Organic Ranks (mostly Top 5). 
                    Unlike "Special Leaves" which relies on coupons, our performance is organic-driven.
                </div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">trending_down</span>
                <div>
                    <strong>Volume Alert:</strong> 
                    The sharp decline in Category Search Volume requires a shift from "Growth" to "Retention" 
                    strategies to maximize value from the fewer remaining shoppers.
                </div>
            </div>

            <h3 style="margin-top: 25px;">Actionable Recommendations</h3>
            <ul class="rec-list">
                <li><strong>1. Defend the Premium:</strong> Do not lower price to chase volume. The data shows customers are choosing NaturaleBio despite the premium. Focus on listing conversion optimization (images/bullets) to justify the price.</li>
                <li><strong>2. Target NORITUAL LAB's Keywords:</strong> Analyze the specific keywords where NORITUAL LAB has "Amazon Choice". Consider a small Coupon (5%) to disrupt their click-through rate and try to steal the badge.</li>
                <li><strong>3. Bundle for AOV:</strong> Since traffic is low, increase the value of each cart. Push multi-pack variants if available, as loyal customers are the ones currently buying.</li>
            </ul>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <select id="select-week" onchange="drawInteractiveCharts()">
                <option value="all">All Weeks</option>
            </select>
            <select id="select-metric" onchange="drawInteractiveCharts()">
                <option value="click_share">Click Share</option>
                <option value="price">Price</option>
                <option value="rank">Organic Rank</option>
            </select>
        </div>

        <div class="chart-container" id="chart_interactive"></div>
        
        <div class="kpi-grid">
            <div class="card">
                <div class="kpi-label">Our Avg Metric</div>
                <div class="kpi-value" id="int-val-us">-</div>
            </div>
            <div class="card">
                <div class="kpi-label">Competitor Avg Metric</div>
                <div class="kpi-value" id="int-val-comp">-</div>
            </div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script>
    // 1. INJECTED DATA (From Python Processing)
    const rawData = [{"week":"2025-51","is_our_asin":"N","brand":"NORITUAL LAB","asin":"B0CNRX8G5S","title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","click_share":16.66,"rank":2,"price":24.03,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":7,"search_volume":60855.1,"est_clicks":10138.45966,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"NORITUAL LAB","asin":"B0CNRX8G5S","title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","click_share":18.77,"rank":2,"price":24.648571429,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":7,"search_volume":47708.06,"est_clicks":8954.802862,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"NORITUAL LAB","asin":"B0CNRX8G5S","title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","click_share":19.34,"rank":2,"price":23.91,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":4,"search_volume":27011.1,"est_clicks":5223.94674,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"N","brand":"NORITUAL LAB","asin":"B0FSL3C3Z8","title":"Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...","click_share":8.85,"rank":5,"price":15.635714286,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":5385.67635,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"N","brand":"Unknown Brand","asin":"B0FSL3C3Z8","title":"Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...","click_share":8.85,"rank":5,"price":15.635714286,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":5385.67635,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"Unknown Brand","asin":"B0FSL3C3Z8","title":"Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...","click_share":7.38,"rank":6,"price":15.5575,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":1993.41918,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"NORITUAL LAB","asin":"B0FSL3C3Z8","title":"Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...","click_share":7.38,"rank":6,"price":15.5575,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":1993.41918,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"NORITUAL LAB","asin":"B0FSL3C3Z8","title":"Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...","click_share":8.42,"rank":6,"price":16.037142857,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":4017.018652,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"Unknown Brand","asin":"B0FSL3C3Z8","title":"Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...","click_share":8.42,"rank":6,"price":16.037142857,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":4017.018652,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"VAHDAM","asin":"B07MD4LB49","title":"VAHDAM, Matcha Grüntee Pulver (100g, 50+ Tassen) A...","click_share":4.19,"rank":7,"price":9.895714286,"deal_days":3,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":1998.967714,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"N","brand":"VAHDAM","asin":"B07MD4LB49","title":"VAHDAM, Matcha Grüntee Pulver (100g, 50+ Tassen) A...","click_share":3.49,"rank":8,"price":9.005714286,"deal_days":5,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":2123.84299,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"VAHDAM","asin":"B07MD4LB49","title":"VAHDAM, Matcha Grüntee Pulver (100g, 50+ Tassen) A...","click_share":3.15,"rank":9,"price":10.43,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":850.84965,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"Unknown Brand","asin":"B08XVX8V1T","title":"Bio Matcha Pulver 100 g – Japan Matcha Tee, 100% n...","click_share":2.39,"rank":10,"price":11.9975,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":645.56529,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"bioKontor","asin":"B08XVX8V1T","title":"Bio Matcha Pulver 100 g – Japan Matcha Tee, 100% n...","click_share":2.39,"rank":10,"price":11.9975,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":645.56529,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"bioKontor","asin":"B08XVX8V1T","title":"Bio Matcha Pulver 100 g – Japan Matcha Tee, 100% n...","click_share":2.44,"rank":10,"price":12.367142857,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":1164.076664,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"Unknown Brand","asin":"B08XVX8V1T","title":"Bio Matcha Pulver 100 g – Japan Matcha Tee, 100% n...","click_share":2.44,"rank":10,"price":12.367142857,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":1164.076664,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"N","brand":"Unknown Brand","asin":"B0G1T7N675","title":"Ceremonial Matcha Pulver BIO-Qualität 50g ideal zu...","click_share":2.56,"rank":12,"price":8.898571429,"deal_days":7,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":1557.89056,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"N","brand":"Unknown Brand","asin":"B0F5BVFRC1","title":"Jean & Len Handcreme I Love You So Matcha, für nor...","click_share":1.92,"rank":12,"price":3.095714286,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":1168.41792,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"Unknown Brand","asin":"B0DRP6Y6XC","title":"Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...","click_share":3.4,"rank":13,"price":10.71,"deal_days":0,"coupon_days":7,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":1622.07404,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"Special Leaves","asin":"B0DRP6Y6XC","title":"Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...","click_share":3.4,"rank":13,"price":10.71,"deal_days":0,"coupon_days":7,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":1622.07404,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"N","brand":"Unknown Brand","asin":"B0DRP6Y6XC","title":"Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...","click_share":3.48,"rank":14,"price":10.44,"deal_days":0,"coupon_days":7,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":2117.75748,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"N","brand":"Special Leaves","asin":"B0DRP6Y6XC","title":"Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...","click_share":3.48,"rank":14,"price":10.44,"deal_days":0,"coupon_days":7,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":2117.75748,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"Special Leaves","asin":"B0DRP6Y6XC","title":"Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...","click_share":3,"rank":16,"price":10.39,"deal_days":0,"coupon_days":4,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":810.333,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"Unknown Brand","asin":"B0DRP6Y6XC","title":"Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...","click_share":3,"rank":16,"price":10.39,"deal_days":0,"coupon_days":4,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":810.333,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"N","brand":"Unknown Brand","asin":"B0F9B1LWQQ","title":"UNREAL® 100g Ceremonial Bio Matcha – 100% Japanisc...","click_share":1.57,"rank":19,"price":31.2725,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":424.07427,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"N","brand":"VAHDAM","asin":"B07K1WBH4K","title":"VAHDAM, Vanille Matcha Grüner Tee Pulver (100g, 50...","click_share":1.47,"rank":20,"price":9.895714286,"deal_days":3,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":701.308482,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"Y","brand":"NaturaleBio","asin":"B07SZFD3P9","title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","click_share":2.68,"rank":null,"price":30.27,"deal_days":null,"coupon_days":null,"bs_days":null,"ac_days":null,"search_volume":27011.1,"est_clicks":723.89748,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"Y","brand":"NaturaleBio","asin":"B06XQ5DCYJ","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":11.18,"rank":2,"price":14.084285714,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":6803.60018,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"Y","brand":"NaturaleBio","asin":"B06XQ5DCYJ","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":11.66,"rank":2,"price":15.058571429,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":5562.759796,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"Y","brand":"NaturaleBio","asin":"B06XQ5DCYJ","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":12.9,"rank":2,"price":14.6075,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":3484.4319,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"Y","brand":"NaturaleBio","asin":"B06XQ69YCQ","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":3.75,"rank":4,"price":10.538571429,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":1789.05225,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"Y","brand":"NaturaleBio","asin":"B079VQ52MK","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":3.69,"rank":5,"price":23.075714286,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":2245.55319,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"Y","brand":"NaturaleBio","asin":"B06XQ69YCQ","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":3.35,"rank":5,"price":10.2225,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":904.87185,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"Y","brand":"NaturaleBio","asin":"B079VQ52MK","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":3.49,"rank":5,"price":24.855714286,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":1665.011294,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"Y","brand":"NaturaleBio","asin":"B06XQ69YCQ","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":3.85,"rank":5,"price":9.2,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":2342.92135,"keyword":"matcha"},{"week":"2026-01","is_our_asin":"Y","brand":"NaturaleBio","asin":"B079VQ52MK","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":3.66,"rank":5,"price":24.5275,"deal_days":0,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":27011.1,"est_clicks":988.60626,"keyword":"matcha"},{"week":"2025-51","is_our_asin":"Y","brand":"NaturaleBio","asin":"B07SZFD3P9","title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","click_share":2.95,"rank":22,"price":26.748571429,"deal_days":7,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":60855.1,"est_clicks":1795.22545,"keyword":"matcha"},{"week":"2025-52","is_our_asin":"Y","brand":"NaturaleBio","asin":"B07SZFD3P9","title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","click_share":2.93,"rank":23,"price":30.704285714,"deal_days":1,"coupon_days":0,"bs_days":0,"ac_days":0,"search_volume":47708.06,"est_clicks":1397.846158,"keyword":"matcha"}];

    // 2. DATA PROCESSING HELPERS
    
    // Identify Our Brand & Top Competitors dynamically
    const OUR_BRAND_ID = rawData.find(r => r.is_our_asin === 'Y')?.brand || "Our Brand";
    
    // Fix "Unknown Brand" if possible
    const cleanData = rawData.map(r => {
        let b = r.brand;
        if (!b || b === "Unknown Brand") {
            // Try 1st word of title
            const firstWord = r.title.split(' ')[0];
            // Blacklist generic words
            if (["Matcha", "Ceremonial", "Bio", "Organic"].includes(firstWord)) {
                b = "Generic/Other";
            } else {
                b = firstWord;
            }
        }
        return { ...r, brand: b };
    });

    // Unique Weeks Sorted
    const weeks = [...new Set(cleanData.map(d => d.week))].sort();
    
    // Identify Top 3 Competitors by Share
    const compShare = {};
    cleanData.filter(d => d.is_our_asin === 'N').forEach(d => {
        if (!compShare[d.brand]) compShare[d.brand] = 0;
        compShare[d.brand] += d.click_share;
    });
    const topCompetitors = Object.entries(compShare)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 3)
        .map(x => x[0]);

    // Populate Selectors
    const weekSelect = document.getElementById('select-week');
    weeks.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.text = w;
        weekSelect.appendChild(opt);
    });

    // 3. GOOGLE CHARTS SETUP
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        calculateKPIs();
        drawGlobalTrend();
        drawBrandCompetitiveness();
        drawEfficiency();
    }

    // ------------------------------------------
    // CHART 1: GLOBAL PARENT TREND (Combo)
    // ------------------------------------------
    function drawGlobalTrend() {
        // Aggregate by Week
        const agg = {};
        weeks.forEach(w => {
            agg[w] = { total_clicks: 0, our_share: 0, comp_share: 0, total_vol: 0 };
        });

        cleanData.forEach(r => {
            if (agg[r.week]) {
                agg[r.week].total_clicks += r.est_clicks;
                agg[r.week].total_vol += r.search_volume; // Note: this sums per ASIN, need max per week/keyword usually. 
                // Better approach: Sum Click Share per group
                if (r.is_our_asin === 'Y') agg[r.week].our_share += r.click_share;
                else agg[r.week].comp_share += r.click_share;
            }
        });

        // Convert to DataTable
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Total Market Clicks');
        data.addColumn('number', 'Our Share (%)');
        data.addColumn('number', 'Comp. Share (%)');

        weeks.forEach(w => {
            // deduplicate search volume issue: assuming 'search_volume' is constant per week/keyword. 
            // We'll use the pre-calc est_clicks sum which is safer.
            data.addRow([
                w, 
                agg[w].total_clicks, 
                agg[w].our_share, 
                agg[w].comp_share
            ]);
        });

        const options = {
            seriesType: 'bars',
            series: {
                1: {type: 'line', targetAxisIndex: 1, color: '#0071e3', lineWidth: 3},
                2: {type: 'line', targetAxisIndex: 1, color: '#86868b', lineDashStyle: [4, 4]}
            },
            vAxes: {
                0: {title: 'Est. Clicks (Volume)'},
                1: {title: 'Click Share %', format: '#\'%\''}
            },
            colors: ['#e5e5ea'],
            legend: { position: 'top' },
            animation: { startup: true, duration: 1000, easing: 'out' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    // ------------------------------------------
    // CHART 2: BRAND COMPETITIVENESS (Line)
    // ------------------------------------------
    function drawBrandCompetitiveness() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', OUR_BRAND_ID);
        topCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Others');

        weeks.forEach(w => {
            const row = [w];
            // Ours
            const us = cleanData.filter(d => d.week === w && d.is_our_asin === 'Y')
                                .reduce((s, d) => s + d.click_share, 0);
            row.push(us);

            // Top Competitors
            let others = 0;
            const weekData = cleanData.filter(d => d.week === w && d.is_our_asin === 'N');
            
            topCompetitors.forEach(tc => {
                const share = weekData.filter(d => d.brand === tc)
                                      .reduce((s, d) => s + d.click_share, 0);
                row.push(share);
            });

            // Others
            others = weekData.filter(d => !topCompetitors.includes(d.brand))
                             .reduce((s, d) => s + d.click_share, 0);
            row.push(others);

            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#0071e3', '#ff3b30', '#ff9500', '#34c759', '#d1d1d6'],
            vAxis: { title: 'Click Share (%)' },
            legend: { position: 'top' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    // ------------------------------------------
    // CHART 3: EFFICIENCY (Scatter)
    // ------------------------------------------
    function drawEfficiency() {
        // Last week only for clarity
        const latestWeek = weeks[weeks.length - 1];
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        const currentData = cleanData.filter(d => d.week === latestWeek && d.rank > 0);

        currentData.forEach(d => {
            const color = d.is_our_asin === 'Y' ? 'point { fill-color: #0071e3; size: 10; }' : 'point { fill-color: #86868b; }';
            const label = `${d.brand} \nRank: ${d.rank} \nShare: ${d.click_share}% \nPrice: ${d.price.toFixed(2)}`;
            data.addRow([d.rank, d.click_share, color, label]);
        });

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // Rank 1 is left
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            chartArea: { width: '85%', height: '80%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // ------------------------------------------
    // TAB MANAGEMENT & KPIs
    // ------------------------------------------
    function switchTab(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        event.target.classList.add('active');

        if(tabId === 'interactive') drawInteractiveCharts();
    }

    function calculateKPIs() {
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];
        
        const lwData = cleanData.filter(d => d.week === lastWeek);
        const pwData = cleanData.filter(d => d.week === prevWeek);

        // Function to sum metrics
        const sumMetric = (arr, key) => arr.reduce((a,b) => a + (b[key] || 0), 0);
        const getShare = (arr) => arr.filter(d => d.is_our_asin === 'Y').reduce((a,b) => a + b.click_share, 0);

        // Clicks
        const clicksNow = sumMetric(lwData, 'est_clicks');
        const clicksPrev = sumMetric(pwData, 'est_clicks');
        setKPI('kpi-clicks', Math.round(clicksNow).toLocaleString(), clicksNow, clicksPrev);

        // Share
        const shareNow = getShare(lwData);
        const sharePrev = getShare(pwData);
        setKPI('kpi-share', shareNow.toFixed(1) + '%', shareNow, sharePrev);

        // Rank (Weighted Avg for Us)
        const getAvgRank = (arr) => {
            const our = arr.filter(d => d.is_our_asin === 'Y' && d.rank > 0);
            if(our.length === 0) return 0;
            return our.reduce((a,b) => a + b.rank, 0) / our.length;
        };
        const rankNow = getAvgRank(lwData);
        const rankPrev = getAvgRank(pwData);
        setKPI('kpi-rank', rankNow.toFixed(1), rankPrev, rankNow); // Inverted logic for rank

        // Price
        const ourPrice = lwData.filter(d => d.is_our_asin === 'Y').reduce((a,b) => a + b.price, 0) / lwData.filter(d => d.is_our_asin === 'Y').length;
        const mktPrice = lwData.filter(d => d.is_our_asin === 'N').reduce((a,b) => a + b.price, 0) / lwData.filter(d => d.is_our_asin === 'N').length;
        const diff = ((ourPrice - mktPrice) / mktPrice) * 100;
        document.getElementById('kpi-price').innerText = (diff > 0 ? '+' : '') + diff.toFixed(1) + '%';
        document.getElementById('date-range').innerText = `Data Period: ${weeks[0]} to ${lastWeek}`;
    }

    function setKPI(id, text, curr, prev) {
        const el = document.getElementById(id);
        el.innerText = text;
        const trendEl = document.getElementById(id + '-trend');
        
        if(curr > prev) {
            trendEl.innerHTML = `<span class="material-icons trend-up">trending_up</span> vs last week`;
        } else if (curr < prev) {
            trendEl.innerHTML = `<span class="material-icons trend-down">trending_down</span> vs last week`;
        } else {
             trendEl.innerHTML = `Stable`;
        }
    }

    // ------------------------------------------
    // INTERACTIVE SECTION
    // ------------------------------------------
    function drawInteractiveCharts() {
        const week = document.getElementById('select-week').value;
        const metric = document.getElementById('select-metric').value;

        let filtered = cleanData;
        if(week !== 'all') {
            filtered = cleanData.filter(d => d.week === week);
        }

        // Prepare data: Brand vs Metric
        // Group by Brand
        const brands = {};
        filtered.forEach(d => {
            if(!brands[d.brand]) brands[d.brand] = [];
            brands[d.brand].push(d[metric]);
        });

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Brand');
        data.addColumn('number', metric === 'click_share' ? 'Avg Share %' : (metric === 'price' ? 'Avg Price €' : 'Avg Rank'));
        data.addColumn({type: 'string', role: 'style'});

        Object.keys(brands).forEach(b => {
            const sum = brands[b].reduce((x,y) => x+y, 0);
            const avg = sum / brands[b].length;
            const color = (b === OUR_BRAND_ID) ? '#0071e3' : '#86868b';
            data.addRow([b, avg, color]);
        });

        data.sort([{column: 1, desc: metric === 'click_share'}]);

        const options = {
            title: `Comparison: ${metric}`,
            legend: 'none',
            bar: {groupWidth: "70%"},
            chartArea: { width: '80%', height: '70%' },
            hAxis: { title: metric }
        };

        const chart = new google.visualization.BarChart(document.getElementById('chart_interactive'));
        chart.draw(data, options);

        // Update Comparison Cards
        const usVals = brands[OUR_BRAND_ID] || [0];
        const usAvg = usVals.reduce((a,b)=>a+b,0)/usVals.length;
        
        // Competitor Avg (excluding us)
        let compSum = 0, compCount = 0;
        Object.keys(brands).forEach(b => {
            if(b !== OUR_BRAND_ID) {
                brands[b].forEach(v => { compSum += v; compCount++; });
            }
        });
        const compAvg = compCount ? compSum/compCount : 0;

        document.getElementById('int-val-us').innerText = usAvg.toFixed(2);
        document.getElementById('int-val-comp').innerText = compAvg.toFixed(2);
    }

</script>
</body>
</html>