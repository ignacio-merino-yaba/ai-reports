<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Styles -->
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-100: #f1f3f4;
            --gray-300: #dadce0;
            --gray-800: #202124;
            --card-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            color: var(--gray-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background-color: white;
            padding: 24px 0;
            border-bottom: 1px solid var(--gray-300);
            margin-bottom: 24px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 400;
        }

        .header-meta {
            font-size: 14px;
            color: #5f6368;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-300);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 18px;
            color: var(--gray-800);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--gray-100);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-val {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .metric-label {
            font-size: 12px;
            color: #5f6368;
            text-transform: uppercase;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Insights List */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .insight-icon {
            color: var(--warning);
        }

        .rec-icon {
            color: var(--success);
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--gray-300);
            font-size: 14px;
        }

        /* Comparison Table */
        .comp-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comp-table th, .comp-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--gray-300);
        }
        
        .comp-table th {
            color: #5f6368;
            font-weight: 500;
        }

        /* Utility */
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-our { background: #e8f0fe; color: var(--primary); }
        .badge-comp { background: #fce8e6; color: var(--danger); }

    </style>
</head>
<body>

<header>
    <div class="container header-content">
        <div class="header-title">
            <h1>Análisis de Rendimiento: Parent ASIN</h1>
            <div class="header-meta">Reporte Semanal • NaturaleBio vs Competencia • Mercado DE</div>
        </div>
        <div>
            <span class="material-icons" style="color: var(--primary);">analytics</span>
        </div>
    </div>
</header>

<div class="container">
    
    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static" class="tab-content active">
        
        <!-- Section 5: Key Conclusions (Moved Top as Executive Summary) -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                Insights Clave & Recomendaciones (Semana 01-2026)
            </div>
            <div id="insights-container">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Section 1: Global Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent (Tracción y Cuota)
            </div>
            <div class="metrics-grid" id="global-metrics">
                <!-- Metrics injected here -->
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                *Las barras representan el volumen total de clics estimados. La línea muestra el % de Click Share Total.
            </p>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">group</span>
                2. Competitividad de Marca (Click Share Semanal)
            </div>
            <div id="chart_brand_comp" class="chart-container"></div>
            <div style="margin-top: 15px; font-size: 14px;">
                <strong>Análisis:</strong> <span id="brand-analysis-text">Calculando...</span>
            </div>
        </div>

        <!-- Section 3: Palancas -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">rocket_launch</span>
                3. Palancas de Crecimiento (Precio & Deals)
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                <div style="flex: 1; min-width: 300px;">
                    <h4>Impacto de Deals en Click Share</h4>
                    <div id="table_deals_div"></div>
                </div>
                <div style="flex: 1; min-width: 300px;">
                     <h4>Correlación Precio vs Share (Top ASINs)</h4>
                     <div id="chart_price_scatter" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Section 4: Efficiency -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">speed</span>
                4. Eficiencia: Organic Rank vs Click Share
            </div>
            <div id="chart_efficiency" class="chart-container"></div>
            <p style="font-size: 12px; color: #666;">
                *Cuadrante superior izquierdo: Alta eficiencia (Mal rank, alto share).
                *Cuadrante inferior derecho: Baja eficiencia (Buen rank, bajo share).
            </p>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="interactive" class="tab-content">
        <div class="controls">
            <div>
                <label>Semana:</label>
                <select id="week-selector" onchange="updateInteractive()">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div>
                <label>Comparar NaturaleBio contra:</label>
                <select id="comp-selector" onchange="updateInteractive()">
                    <!-- Populated by JS -->
                </select>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Precio Promedio (Ellos)</div>
                <div class="metric-val" id="comp-price">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Gap de Precio</div>
                <div class="metric-val" id="price-gap">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Diferencia Share</div>
                <div class="metric-val" id="share-gap">-</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Cara a Cara: Atributos y Rendimiento</div>
            <div id="table_interactive_div"></div>
        </div>
    </div>

</div>

<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION
    // ---------------------------------------------------------
    const marketData = [
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "bioKontor",
    "asin": "B08XVX8V1T",
    "product_title": "Bio Matcha Pulver 100 g – Japan Matcha Tee, 100% n...",
    "country_code": "de",
    "average_organic_rank": 10.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 2.39,
    "impression_share": 3.91,
    "price": 11.9975,
    "click_share_rank": 9,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B08XVX8V1T",
    "product_title": "Bio Matcha Pulver 100 g – Japan Matcha Tee, 100% n...",
    "country_code": "de",
    "average_organic_rank": 10.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 2.39,
    "impression_share": 3.91,
    "price": 11.9975,
    "click_share_rank": 9,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B08XVX8V1T",
    "product_title": "Bio Matcha Pulver 100 g – Japan Matcha Tee, 100% n...",
    "country_code": "de",
    "average_organic_rank": 10.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 2.44,
    "impression_share": 3.4,
    "price": 12.367142857,
    "click_share_rank": 9,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "bioKontor",
    "asin": "B08XVX8V1T",
    "product_title": "Bio Matcha Pulver 100 g – Japan Matcha Tee, 100% n...",
    "country_code": "de",
    "average_organic_rank": 10.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 2.44,
    "impression_share": 3.4,
    "price": 12.367142857,
    "click_share_rank": 9,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": "NORITUAL LAB",
    "asin": "B0CNRX8G5S",
    "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...",
    "country_code": "de",
    "average_organic_rank": 2.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 7.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 16.66,
    "impression_share": 3.14,
    "price": 24.03,
    "click_share_rank": 1,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "NORITUAL LAB",
    "asin": "B0CNRX8G5S",
    "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...",
    "country_code": "de",
    "average_organic_rank": 2.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 7.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 18.77,
    "impression_share": 3.35,
    "price": 24.648571429,
    "click_share_rank": 1,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NORITUAL LAB",
    "asin": "B0CNRX8G5S",
    "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...",
    "country_code": "de",
    "average_organic_rank": 2.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 4.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 19.34,
    "impression_share": 3.36,
    "price": 23.91,
    "click_share_rank": 1,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0G1T7N675",
    "product_title": "Ceremonial Matcha Pulver BIO-Qualität 50g ideal zu...",
    "country_code": "de",
    "average_organic_rank": 12.0,
    "weekly_number_of_days_with_deal": 7.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 2.56,
    "impression_share": 3.71,
    "price": 8.898571429,
    "click_share_rank": 9,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NORITUAL LAB",
    "asin": "B0FSL3C3Z8",
    "product_title": "Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...",
    "country_code": "de",
    "average_organic_rank": 6.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 7.38,
    "impression_share": 4.54,
    "price": 15.5575,
    "click_share_rank": 3,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0FSL3C3Z8",
    "product_title": "Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...",
    "country_code": "de",
    "average_organic_rank": 6.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 7.38,
    "impression_share": 4.54,
    "price": 15.5575,
    "click_share_rank": 3,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0FSL3C3Z8",
    "product_title": "Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...",
    "country_code": "de",
    "average_organic_rank": 6.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 8.42,
    "impression_share": 4.24,
    "price": 16.037142857,
    "click_share_rank": 3,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "NORITUAL LAB",
    "asin": "B0FSL3C3Z8",
    "product_title": "Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...",
    "country_code": "de",
    "average_organic_rank": 6.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 8.42,
    "impression_share": 4.24,
    "price": 16.037142857,
    "click_share_rank": 3,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0FSL3C3Z8",
    "product_title": "Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...",
    "country_code": "de",
    "average_organic_rank": 5.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 8.85,
    "impression_share": 4.22,
    "price": 15.635714286,
    "click_share_rank": 3,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": "NORITUAL LAB",
    "asin": "B0FSL3C3Z8",
    "product_title": "Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...",
    "country_code": "de",
    "average_organic_rank": 5.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 8.85,
    "impression_share": 4.22,
    "price": 15.635714286,
    "click_share_rank": 3,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0F5BVFRC1",
    "product_title": "Jean & Len Handcreme I Love You So Matcha, für nor...",
    "country_code": "de",
    "average_organic_rank": 12.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 1.92,
    "impression_share": 2.66,
    "price": 3.095714286,
    "click_share_rank": 10,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0DRP6Y6XC",
    "product_title": "Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...",
    "country_code": "de",
    "average_organic_rank": 16.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 4.0,
    "click_share": 3.0,
    "impression_share": 4.47,
    "price": 10.39,
    "click_share_rank": 7,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "Special Leaves",
    "asin": "B0DRP6Y6XC",
    "product_title": "Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...",
    "country_code": "de",
    "average_organic_rank": 16.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 4.0,
    "click_share": 3.0,
    "impression_share": 4.47,
    "price": 10.39,
    "click_share_rank": 7,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "Special Leaves",
    "asin": "B0DRP6Y6XC",
    "product_title": "Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...",
    "country_code": "de",
    "average_organic_rank": 13.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 7.0,
    "click_share": 3.4,
    "impression_share": 4.7,
    "price": 10.71,
    "click_share_rank": 7,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0DRP6Y6XC",
    "product_title": "Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...",
    "country_code": "de",
    "average_organic_rank": 13.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 7.0,
    "click_share": 3.4,
    "impression_share": 4.7,
    "price": 10.71,
    "click_share_rank": 7,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": "Special Leaves",
    "asin": "B0DRP6Y6XC",
    "product_title": "Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...",
    "country_code": "de",
    "average_organic_rank": 14.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 7.0,
    "click_share": 3.48,
    "impression_share": 4.53,
    "price": 10.44,
    "click_share_rank": 7,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0DRP6Y6XC",
    "product_title": "Matcha Pulver - 90g - 100% Natürlich & Fein Gemahl...",
    "country_code": "de",
    "average_organic_rank": 14.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 7.0,
    "click_share": 3.48,
    "impression_share": 4.53,
    "price": 10.44,
    "click_share_rank": 7,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B07SZFD3P9",
    "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...",
    "country_code": "de",
    "average_organic_rank": null,
    "weekly_number_of_days_with_deal": null,
    "weekly_number_of_days_with_best_seller_badge": null,
    "weekly_number_of_days_with_amazon_choice_badge": null,
    "weekly_number_of_days_with_coupon": null,
    "click_share": 2.68,
    "impression_share": 2.06,
    "price": 30.27,
    "click_share_rank": 8,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B07SZFD3P9",
    "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...",
    "country_code": "de",
    "average_organic_rank": 23.0,
    "weekly_number_of_days_with_deal": 1.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 2.93,
    "impression_share": 2.43,
    "price": 30.704285714,
    "click_share_rank": 8,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B07SZFD3P9",
    "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...",
    "country_code": "de",
    "average_organic_rank": 22.0,
    "weekly_number_of_days_with_deal": 7.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 2.95,
    "impression_share": 2.57,
    "price": 26.748571429,
    "click_share_rank": 8,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ69YCQ",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 5.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 3.35,
    "impression_share": 3.02,
    "price": 10.2225,
    "click_share_rank": 5,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 5.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 3.49,
    "impression_share": 3.36,
    "price": 24.855714286,
    "click_share_rank": 6,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 5.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 3.66,
    "impression_share": 3.36,
    "price": 24.5275,
    "click_share_rank": 4,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 5.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 3.69,
    "impression_share": 3.13,
    "price": 23.075714286,
    "click_share_rank": 5,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ69YCQ",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 4.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 3.75,
    "impression_share": 3.25,
    "price": 10.538571429,
    "click_share_rank": 5,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ69YCQ",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 5.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 3.85,
    "impression_share": 3.15,
    "price": 9.2,
    "click_share_rank": 4,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 2.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 11.18,
    "impression_share": 3.15,
    "price": 14.084285714,
    "click_share_rank": 2,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 2.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 11.66,
    "impression_share": 3.37,
    "price": 15.058571429,
    "click_share_rank": 2,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...",
    "country_code": "de",
    "average_organic_rank": 2.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 12.9,
    "impression_share": 3.37,
    "price": 14.6075,
    "click_share_rank": 2,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": null,
    "asin": "B0F9B1LWQQ",
    "product_title": "UNREAL® 100g Ceremonial Bio Matcha – 100% Japanisc...",
    "country_code": "de",
    "average_organic_rank": 19.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 1.57,
    "impression_share": 1.96,
    "price": 31.2725,
    "click_share_rank": 10,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha",
    "competitor_brand": "VAHDAM",
    "asin": "B07MD4LB49",
    "product_title": "VAHDAM, Matcha Grüntee Pulver (100g, 50+ Tassen) A...",
    "country_code": "de",
    "average_organic_rank": 9.0,
    "weekly_number_of_days_with_deal": 0.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 3.15,
    "impression_share": 5.19,
    "price": 10.43,
    "click_share_rank": 6,
    "weekly_search_volume": 26944.6,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-20",
    "week_date": "2025-51",
    "keywords": "matcha",
    "competitor_brand": "VAHDAM",
    "asin": "B07MD4LB49",
    "product_title": "VAHDAM, Matcha Grüntee Pulver (100g, 50+ Tassen) A...",
    "country_code": "de",
    "average_organic_rank": 8.0,
    "weekly_number_of_days_with_deal": 5.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 3.49,
    "impression_share": 4.25,
    "price": 9.005714286,
    "click_share_rank": 6,
    "weekly_search_volume": 60848.28,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "VAHDAM",
    "asin": "B07MD4LB49",
    "product_title": "VAHDAM, Matcha Grüntee Pulver (100g, 50+ Tassen) A...",
    "country_code": "de",
    "average_organic_rank": 7.0,
    "weekly_number_of_days_with_deal": 3.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 4.19,
    "impression_share": 5.29,
    "price": 9.895714286,
    "click_share_rank": 4,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2025-12-27",
    "week_date": "2025-52",
    "keywords": "matcha",
    "competitor_brand": "VAHDAM",
    "asin": "B07K1WBH4K",
    "product_title": "VAHDAM, Vanille Matcha Grüner Tee Pulver (100g, 50...",
    "country_code": "de",
    "average_organic_rank": 20.0,
    "weekly_number_of_days_with_deal": 3.0,
    "weekly_number_of_days_with_best_seller_badge": 0.0,
    "weekly_number_of_days_with_amazon_choice_badge": 0.0,
    "weekly_number_of_days_with_coupon": 0.0,
    "click_share": 1.47,
    "impression_share": 2.29,
    "price": 9.895714286,
    "click_share_rank": 10,
    "weekly_search_volume": 47736.8,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.de/s?k=matcha"
  }
];

    // ---------------------------------------------------------
    // 2. DATA PROCESSING
    // ---------------------------------------------------------

    // Helper: Identify real brand
    function getRealBrand(item) {
        if (item.competitor_brand && item.competitor_brand.trim() !== "") return item.competitor_brand;
        if (item.product_title) return item.product_title.split(' ')[0].replace(/[^a-zA-Z0-9]/g, '');
        return "Unknown Brand";
    }

    // Identify OUR Brand (from is_yaba_asin = 'Y')
    const ourAsins = marketData.filter(d => d.is_yaba_asin === 'Y');
    const ourBrand = ourAsins.length > 0 ? getRealBrand(ourAsins[0]) : "NaturaleBio";

    // Add estimated clicks and real_brand to data
    const processedData = marketData.map(d => {
        return {
            ...d,
            real_brand: getRealBrand(d),
            est_clicks: (d.click_share / 100) * d.weekly_search_volume
        };
    });

    // ---------------------------------------------------------
    // 3. INSIGHTS GENERATION (Hardcoded based on Analyst Logic)
    // ---------------------------------------------------------
    function generateInsights() {
        // These are derived from the pre-analysis phase
        const insightsHTML = `
            <div class="insight-item">
                <span class="material-icons insight-icon">trending_down</span>
                <div>
                    <strong>Contracción del Mercado:</strong> El volumen de clics totales cayó un <strong>50%</strong> (43k a 19k) desde la semana 51 a la 01, impulsado por la estacionalidad post-navideña, aunque la cuota de click share promedio se mantuvo estable.
                </div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">emoji_events</span>
                <div>
                    <strong>Liderazgo Competitivo:</strong> <strong>NORITUAL LAB</strong> mantiene el liderazgo en cuota (26.7%), pero <strong>NaturaleBio</strong> (22.6%) le sigue de cerca. La brecha se ha cerrado ligeramente en la última semana.
                </div>
            </div>
             <div class="insight-item">
                <span class="material-icons insight-icon">sell</span>
                <div>
                    <strong>Eficiencia de Deals (Anomalía):</strong> Para NaturaleBio, los días con Deals activos mostraron, contraintuitivamente, un menor Click Share promedio (2.9%) que los días sin deals (6.4%). Esto sugiere que los deals se están aplicando en variantes de menor rotación o en momentos de baja demanda.
                </div>
            </div>
             <div class="insight-item">
                <span class="material-icons insight-icon">warning</span>
                <div>
                    <strong>Riesgo de Visibilidad:</strong> ASINs clave como el B07SZFD3P9 cayeron en ranking orgánico (Rank 22 -> Null/Bajo) en la última semana, afectando la captación de tráfico nuevo.
                </div>
            </div>
            
            <h4 style="margin-top: 20px;">Recomendaciones Accionables</h4>
            <div class="insight-item">
                <span class="material-icons rec-icon">check_circle</span>
                <div>
                    <strong>Revisar Estrategia de Deals:</strong> Suspender deals en variantes de bajo rendimiento y concentrar presupuesto en recuperar el ranking orgánico de los Top Sellers mediante PPC agresivo.
                </div>
            </div>
            <div class="insight-item">
                <span class="material-icons rec-icon">check_circle</span>
                <div>
                    <strong>Defensa de Marca:</strong> NORITUAL LAB está ganando con un precio premium (~24€ vs ~15€ nuestro). Existe espacio para subir precio en el B06XQ5DCYJ si se mejora el contenido A+ para justificar valor.
                </div>
            </div>
        `;
        document.getElementById('insights-container').innerHTML = insightsHTML;
    }

    // ---------------------------------------------------------
    // 4. CHART FUNCTIONS
    // ---------------------------------------------------------
    
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        generateInsights();
        drawGlobalTrend();
        drawBrandComp();
        drawEfficiency();
        drawDealsTable();
        drawPriceScatter();
        
        // Setup Interactive Tab
        setupInteractiveControls();
    }

    function drawGlobalTrend() {
        // Aggregate by week
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        const dataTable = [['Semana', 'Clics Totales (Mercado)', 'NaturaleBio Share (%)']];

        let latestClicks = 0;
        let prevClicks = 0;
        let latestShare = 0;

        weeks.forEach((week, index) => {
            const weekData = processedData.filter(d => d.week_date === week);
            const totalClicks = weekData.reduce((sum, d) => sum + d.est_clicks, 0);
            
            // Calculate NaturaleBio Share
            const ourData = weekData.filter(d => d.real_brand === ourBrand);
            const ourShareSum = ourData.reduce((sum, d) => sum + d.click_share, 0); // Sum of share percentages
            
            dataTable.push([week, totalClicks, ourShareSum]);

            if (index === weeks.length - 1) {
                latestClicks = totalClicks;
                latestShare = ourShareSum;
            } else if (index === weeks.length - 2) {
                prevClicks = totalClicks;
            }
        });

        // Update metrics HTML
        const growth = ((latestClicks - prevClicks) / prevClicks * 100).toFixed(1);
        document.getElementById('global-metrics').innerHTML = `
            <div class="metric-card">
                <div class="metric-label">Clics Totales (Wk)</div>
                <div class="metric-val">${Math.round(latestClicks).toLocaleString()}</div>
                <div style="color: ${growth > 0 ? 'green' : 'red'}">${growth}% vs prev</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">NaturaleBio Share</div>
                <div class="metric-val">${latestShare.toFixed(1)}%</div>
            </div>
        `;

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Volumen Clics'}, 1: {title: '% Share', format: '#\'%\''}},
            colors: ['#dadce0', '#4285F4'],
            legend: {position: 'bottom'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    function drawBrandComp() {
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        
        // Find Top 3 Competitors by total share
        const brandShares = {};
        processedData.forEach(d => {
            if (d.real_brand === ourBrand) return;
            brandShares[d.real_brand] = (brandShares[d.real_brand] || 0) + d.click_share;
        });
        
        const topCompetitors = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);

        // Build Table
        const header = ['Semana', ourBrand, ...topCompetitors];
        const rows = weeks.map(week => {
            const weekData = processedData.filter(d => d.week_date === week);
            const row = [week];
            
            // Our Brand
            const ourSum = weekData.filter(d => d.real_brand === ourBrand)
                                   .reduce((sum, d) => sum + d.click_share, 0);
            row.push(ourSum);

            // Competitors
            topCompetitors.forEach(comp => {
                const compSum = weekData.filter(d => d.real_brand === comp)
                                        .reduce((sum, d) => sum + d.click_share, 0);
                row.push(compSum);
            });
            return row;
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            vAxis: {title: '% Click Share'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);

        // Dynamic Text
        const lastWeek = rows[rows.length-1];
        const leaderIndex = lastWeek.slice(1).reduce((iMax, x, i, arr) => x > arr[iMax] ? i : iMax, 0);
        const leaderName = header[leaderIndex + 1];
        document.getElementById('brand-analysis-text').innerText = 
            `En la última semana, ${leaderName} lidera con un ${lastWeek[leaderIndex+1].toFixed(1)}% de share.`;
    }

    function drawEfficiency() {
        const latestWeek = processedData.reduce((max, d) => d.week_date > max ? d.week_date : max, '');
        const currentData = processedData.filter(d => d.week_date === latestWeek);
        
        // Header: [ID, Rank, Share, Brand (Color), Size]
        const dataArr = [['ID', 'Organic Rank', 'Click Share', 'Marca', 'Volumen']];
        
        currentData.forEach(d => {
            if (d.average_organic_rank > 0) { // Filter unranked
                dataArr.push([
                    d.real_brand, 
                    d.average_organic_rank, 
                    d.click_share, 
                    d.real_brand === ourBrand ? 'NaturaleBio' : 'Competencia',
                    d.weekly_search_volume
                ]);
            }
        });

        const data = google.visualization.arrayToDataTable(dataArr);
        const options = {
            hAxis: {title: 'Rank Orgánico (Menor es mejor)', direction: -1}, // Reverse axis
            vAxis: {title: 'Click Share (%)'},
            bubble: {textStyle: {fontSize: 11}},
            colors: ['#EA4335', '#4285F4'], // Competencia (Red), Us (Blue)
            legend: {position: 'bottom'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function drawDealsTable() {
        // Simple aggregation: Our Brand vs Competitors -> Deal Days vs Share
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Tipo');
        data.addColumn('string', 'Días con Deal');
        data.addColumn('number', 'Share Promedio');

        const groups = {};
        
        processedData.forEach(d => {
            const type = d.real_brand === ourBrand ? 'NaturaleBio' : 'Competencia';
            const dealDays = d.weekly_number_of_days_with_deal > 0 ? '> 0 días' : '0 días';
            const key = type + '|' + dealDays;
            
            if (!groups[key]) groups[key] = {sum:0, count:0};
            groups[key].sum += d.click_share;
            groups[key].count += 1;
        });

        Object.keys(groups).sort().forEach(key => {
            const [type, days] = key.split('|');
            const avg = groups[key].sum / groups[key].count;
            data.addRow([type, days, parseFloat(avg.toFixed(2))]);
        });

        const table = new google.visualization.Table(document.getElementById('table_deals_div'));
        table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
    }

    function drawPriceScatter() {
        const latestWeek = processedData.reduce((max, d) => d.week_date > max ? d.week_date : max, '');
        const currentData = processedData.filter(d => d.week_date === latestWeek && d.click_share > 1); // Filter noise

        const arr = [['Precio', 'Share', { role: 'style' }]];
        currentData.forEach(d => {
            const color = d.real_brand === ourBrand ? '#4285F4' : '#EA4335';
            arr.push([d.price, d.click_share, color]);
        });

        const data = google.visualization.arrayToDataTable(arr);
        const options = {
            hAxis: {title: 'Precio (€)'},
            vAxis: {title: 'Click Share (%)'},
            legend: 'none'
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_price_scatter'));
        chart.draw(data, options);
    }

    // ---------------------------------------------------------
    // 5. INTERACTIVE LOGIC
    // ---------------------------------------------------------
    function setupInteractiveControls() {
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort().reverse();
        const brands = [...new Set(processedData.map(d => d.real_brand))].filter(b => b !== ourBrand).sort();

        const weekSel = document.getElementById('week-selector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w; opt.text = w;
            weekSel.add(opt);
        });

        const compSel = document.getElementById('comp-selector');
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b; opt.text = b;
            compSel.add(opt);
        });

        // Set Defaults (Top competitor)
        compSel.value = "NORITUAL LAB"; 
        
        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('week-selector').value;
        const comp = document.getElementById('comp-selector').value;

        const weekData = processedData.filter(d => d.week_date === week);
        
        // Get Aggregates
        const ourItems = weekData.filter(d => d.real_brand === ourBrand);
        const compItems = weekData.filter(d => d.real_brand === comp);

        const calcAvgPrice = (items) => {
            if (items.length === 0) return 0;
            const sum = items.reduce((acc, i) => acc + i.price, 0);
            return sum / items.length;
        };

        const calcTotalShare = (items) => items.reduce((acc, i) => acc + i.click_share, 0);

        const ourPrice = calcAvgPrice(ourItems);
        const compPrice = calcAvgPrice(compItems);
        const ourShare = calcTotalShare(ourItems);
        const compShare = calcTotalShare(compItems);

        // Update Cards
        document.getElementById('comp-price').innerText = '€' + compPrice.toFixed(2);
        
        const priceGap = ourPrice - compPrice;
        const priceGapEl = document.getElementById('price-gap');
        priceGapEl.innerText = (priceGap > 0 ? '+' : '') + '€' + priceGap.toFixed(2);
        priceGapEl.style.color = priceGap > 0 ? '#EA4335' : '#34A853'; // Red if we are more expensive

        const shareGap = ourShare - compShare;
        const shareGapEl = document.getElementById('share-gap');
        shareGapEl.innerText = (shareGap > 0 ? '+' : '') + shareGap.toFixed(1) + '%';
        shareGapEl.style.color = shareGap > 0 ? '#34A853' : '#EA4335';

        // Draw Table
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'ASIN');
        data.addColumn('string', 'Marca');
        data.addColumn('number', 'Precio');
        data.addColumn('number', 'Share (%)');
        data.addColumn('number', 'Rank');

        [...ourItems, ...compItems].forEach(d => {
            data.addRow([
                d.asin,
                d.real_brand === ourBrand ? 'NOSOTROS' : d.real_brand,
                d.price,
                d.click_share,
                d.average_organic_rank || 99
            ]);
        });

        const table = new google.visualization.Table(document.getElementById('table_interactive_div'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '300px'});
    }

    // Tab Switching
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        // Find the button that calls this function with this ID (hacky but works)
        event.target.classList.add('active');
    }

</script>

</body>
</html>