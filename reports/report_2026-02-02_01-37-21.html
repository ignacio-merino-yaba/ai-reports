<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Avanzado de Parent ASIN - Amazon Market Intelligence</title>
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-color: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-blue: #007AFF;
            --accent-green: #34C759;
            --accent-red: #FF3B30;
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.04);
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { font-size: 28px; font-weight: 700; margin: 0; }
        .subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            background: rgba(118, 118, 128, 0.12);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 24px;
        }
        .tab-btn {
            padding: 8px 24px;
            border-radius: 8px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .tab-btn.active {
            background: var(--card-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }
        .card:hover { transform: translateY(-2px); }
        .card h2 { font-size: 18px; margin-top: 0; margin-bottom: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .card h2 .material-icons { color: var(--accent-blue); font-size: 20px; }

        /* Charts */
        .chart-container { width: 100%; height: 350px; }
        .chart-mini { width: 100%; height: 250px; }

        /* Insights List */
        .insights-list li { margin-bottom: 10px; font-size: 14px; color: #333; }
        .insights-list strong { color: var(--accent-blue); }
        .recommendation-card { border-left: 4px solid var(--accent-green); background: #F2FBF4; }
        .risk-card { border-left: 4px solid var(--accent-red); background: #FFF5F5; }

        /* Metric Grid */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .metric-box {
            background: #F9F9F9;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        .metric-val { font-size: 24px; font-weight: 700; display: block; margin: 4px 0; }
        .metric-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Tab Content Control */
        .tab-content { display: none; }
        .tab-content.active { display: block; animate: fadein 0.3s; }
        @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }

        /* Interactive Controls */
        .controls { display: flex; gap: 16px; margin-bottom: 20px; }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #d2d2d7;
            background: #fff;
            font-size: 14px;
            min-width: 200px;
        }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .comparison-table th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: var(--text-secondary); }
        .comparison-table td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .comparison-table td.brand-col { font-weight: 600; color: var(--accent-blue); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Reporte Estratégico Parent ASIN</h1>
            <div class="subtitle" id="date-range">Analizando últimas 4 semanas</div>
        </div>
        <div style="text-align: right;">
            <div class="subtitle">Parent ASIN</div>
            <strong id="parent-asin-display">LOADING...</strong>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Ejecutivo</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="static" class="tab-content active">
        
        <!-- Sección 1: Tendencia Global -->
        <div class="card">
            <h2><span class="material-icons">show_chart</span> 1. Tendencia Global del Parent (Tracción)</h2>
            <div class="metric-grid" id="global-metrics">
                <!-- Injected via JS -->
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="insights-list" id="trend-insights"></div>
        </div>

        <!-- Sección 2: Competitividad -->
        <div class="card">
            <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Share of Voice)</h2>
            <div id="chart_competitiveness" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">*Comparativa semanal de Click Share: Nuestra Marca vs Top 3 Competidores.</p>
        </div>

        <!-- Sección 3: Palancas -->
        <div class="card">
            <h2><span class="material-icons">tune</span> 3. Análisis de Palancas (Precio & Promociones)</h2>
            <div class="metric-grid" id="levers-metrics"></div>
            <div id="chart_levers_price" class="chart-mini"></div>
        </div>

        <!-- Sección 4: Eficiencia -->
        <div class="card">
            <h2><span class="material-icons">scatter_plot</span> 4. Eficiencia: Organic Rank vs Click Share</h2>
            <div id="chart_efficiency" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; text-align: center;">Eje X: Rank Orgánico (Menos es mejor) | Eje Y: Click Share (Más es mejor). <br>Puntos arriba a la izquierda = Alta Eficiencia.</p>
        </div>

        <!-- Sección 5: Conclusiones -->
        <div class="card">
            <h2><span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="recommendation-card" style="padding: 16px; border-radius: 8px;">
                    <h3 style="margin-top:0; color: var(--accent-green);">Recomendaciones Accionables</h3>
                    <ul class="insights-list" id="final-recommendations"></ul>
                </div>
                <div class="risk-card" style="padding: 16px; border-radius: 8px;">
                    <h3 style="margin-top:0; color: var(--accent-red);">Riesgos & Anomalías</h3>
                    <ul class="insights-list" id="final-risks"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
    <div id="interactive" class="tab-content">
        <div class="card">
            <h2><span class="material-icons">compare_arrows</span> Cara a Cara: Nosotros vs Competencia</h2>
            
            <div class="controls">
                <div>
                    <label class="subtitle" style="display:block; margin-bottom:4px;">Semana</label>
                    <select id="week-selector" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label class="subtitle" style="display:block; margin-bottom:4px;">Competidor a comparar</label>
                    <select id="competitor-selector" onchange="updateComparator()"></select>
                </div>
            </div>

            <div id="comparator-view">
                <!-- Injected Table -->
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
    // =========================================================================
    // 1. DATA INJECTION (SYNTHETIC DATA FOR DEMONSTRATION)
    // =========================================================================
    // NOTE: In production, this variable is replaced by the CSV parsing logic.
    // For this standalone file, we inject the synthetic data generated in the thought process.
    const marketData = JSON.parse('[{"week_date": "2023-10-01", "is_yaba_asin": "Y", "competitor_brand": "MyBrand", "asin": "ASIN_MY_0", "product_title": "MyBrand Premium Widget Var 0", "click_share": 0.1385, "clicks": 166, "average_organic_rank": 2, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "grams": 500}, {"week_date": "2023-10-01", "is_yaba_asin": "Y", "competitor_brand": "MyBrand", "asin": "ASIN_MY_1", "product_title": "MyBrand Premium Widget Var 1", "click_share": 0.0821, "clicks": 312, "average_organic_rank": 8, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500}, {"week_date": "2023-10-01", "is_yaba_asin": "N", "competitor_brand": "AlphaComp", "asin": "ASIN_AlphaComp_0", "product_title": "AlphaComp Standard Widget 0", "click_share": 0.2345, "clicks": 415, "average_organic_rank": 22, "price": 35.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450}, {"week_date": "2023-10-01", "is_yaba_asin": "N", "competitor_brand": "AlphaComp", "asin": "ASIN_AlphaComp_1", "product_title": "AlphaComp Standard Widget 1", "click_share": 0.1852, "clicks": 550, "average_organic_rank": 14, "price": 35.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450}, {"week_date": "2023-10-08", "is_yaba_asin": "Y", "competitor_brand": "MyBrand", "asin": "ASIN_MY_0", "product_title": "MyBrand Premium Widget Var 0", "click_share": 0.1450, "clicks": 180, "average_organic_rank": 2, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "grams": 500}, {"week_date": "2023-10-15", "is_yaba_asin": "N", "competitor_brand": "AlphaComp", "asin": "ASIN_AlphaComp_0", "product_title": "AlphaComp Standard Widget 0", "click_share": 0.35, "clicks": 800, "average_organic_rank": 5, "price": 28.00, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450}, {"week_date": "2023-10-22", "is_yaba_asin": "Y", "competitor_brand": "MyBrand", "asin": "ASIN_MY_0", "product_title": "MyBrand Premium Widget Var 0", "click_share": 0.1600, "clicks": 250, "average_organic_rank": 1, "price": 29.99, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "grams": 500}, {"week_date": "2023-10-22", "is_yaba_asin": "N", "competitor_brand": "BetaBest", "asin": "ASIN_BetaBest_0", "product_title": "BetaBest Cheap", "click_share": 0.05, "clicks": 100, "average_organic_rank": 40, "price": 35.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450}]');

    // =========================================================================
    // 2. LOGIC ENGINE
    // =========================================================================
    
    // Config
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    let processedData = [];
    let myBrandName = "";
    let weeksList = [];
    let competitorsList = [];

    function initDashboard() {
        processRawData();
        setupSelectors();
        drawAllCharts();
        generateTextInsights();
        document.getElementById("parent-asin-display").innerText = "SYNTHETIC-PARENT-ID"; // Placeholder logic
    }

    function getBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        if (row.product_title) return row.product_title.split(" ")[0];
        if (row.keywords_link) return "Unknown from Link"; 
        return "Unknown Brand";
    }

    function processRawData() {
        // 1. Identify "My Brand"
        const myAsinRow = marketData.find(r => r.is_yaba_asin === 'Y');
        myBrandName = myAsinRow ? getBrand(myAsinRow) : "Nuestra Marca";

        // 2. Enhance Data
        processedData = marketData.map(row => {
            const brand = getBrand(row);
            return {
                ...row,
                final_brand: brand,
                is_me: (row.is_yaba_asin === 'Y')
            };
        });

        // 3. Extract Weeks (sorted)
        weeksList = [...new Set(processedData.map(d => d.week_date))].sort();
        document.getElementById('date-range').innerText = `Rango: ${weeksList[0]} a ${weeksList[weeksList.length-1]}`;

        // 4. Extract Competitors
        competitorsList = [...new Set(processedData.filter(d => !d.is_me).map(d => d.final_brand))];
    }

    // =========================================================================
    // 3. CHART DRAWING FUNCTIONS
    // =========================================================================

    function drawAllCharts() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawLeversPriceChart();
        drawEfficiencyChart();
    }

    // --- CHART 1: TREND (Clicks vs Share) ---
    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Clicks Nosotros');
        data.addColumn('number', 'Clicks Competencia');
        data.addColumn('number', 'Nuestro Share %');

        const aggregated = weeksList.map(week => {
            const weekData = processedData.filter(d => d.week_date === week);
            const myClicks = weekData.filter(d => d.is_me).reduce((sum, r) => sum + (r.clicks || 0), 0);
            const compClicks = weekData.filter(d => !d.is_me).reduce((sum, r) => sum + (r.clicks || 0), 0);
            
            // Calculate Weighted Share
            const totalClicks = myClicks + compClicks;
            const myShare = totalClicks > 0 ? (myClicks / totalClicks) * 100 : 0; // Simplified share calc

            return [week, myClicks, compClicks, myShare];
        });

        data.addRows(aggregated);

        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1, color: '#007AFF', lineWidth: 3} },
            colors: ['#007AFF', '#E5E5EA'], // Blue for us, Gray for them
            vAxes: {
                0: {title: 'Volumen Clicks'},
                1: {title: 'Share %', format: '#\'%\''}
            },
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'},
            fontName: '-apple-system'
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);

        // Update Text Metrics
        const lastWeek = aggregated[aggregated.length-1];
        const prevWeek = aggregated.length > 1 ? aggregated[aggregated.length-2] : lastWeek;
        
        const trendHTML = `
            <div class="metric-box"><span class="metric-val" style="color:${lastWeek[1] > prevWeek[1] ? '#34C759':'#FF3B30'}">${lastWeek[1]}</span><span class="metric-label">Clicks (Última Sem)</span></div>
            <div class="metric-box"><span class="metric-val">${lastWeek[3].toFixed(1)}%</span><span class="metric-label">Click Share Actual</span></div>
            <div class="metric-box"><span class="metric-val" style="color:${lastWeek[3] > prevWeek[3] ? '#34C759':'#FF3B30'}">${(lastWeek[3]-prevWeek[3]).toFixed(1)}%</span><span class="metric-label">Var vs Prev.</span></div>
        `;
        document.getElementById('global-metrics').innerHTML = trendHTML;
    }

    // --- CHART 2: COMPETITIVENESS (Line Chart) ---
    function drawCompetitivenessChart() {
        // Find Top 3 Competitors by Total Volume
        const brandVols = {};
        processedData.filter(d => !d.is_me).forEach(d => {
            brandVols[d.final_brand] = (brandVols[d.final_brand] || 0) + d.clicks;
        });
        const top3 = Object.keys(brandVols).sort((a,b) => brandVols[b] - brandVols[a]).slice(0,3);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', myBrandName);
        top3.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Resto');

        const rows = weeksList.map(week => {
            const weekData = processedData.filter(d => d.week_date === week);
            const getShare = (brand) => {
                const subset = weekData.filter(d => d.final_brand === brand);
                return subset.reduce((sum, r) => sum + (r.click_share || 0), 0) * 100; // Sum of shares approximation
            };

            const myShare = weekData.filter(d => d.is_me).reduce((sum, r) => sum + (r.click_share || 0), 0) * 100;
            const compShares = top3.map(c => getShare(c));
            
            // Calculate Rest
            const knownShare = myShare + compShares.reduce((a,b)=>a+b, 0);
            const restShare = Math.max(0, 100 - knownShare); // Rough proxy if shares are normalized

            return [week, myShare, ...compShares, restShare];
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#007AFF', '#FF3B30', '#FF9500', '#AF52DE', '#8E8E93'],
            legend: {position: 'bottom'},
            chartArea: {width: '90%', height: '70%'},
            vAxis: {title: 'Share Estimado %'},
            fontName: '-apple-system'
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    // --- CHART 3: LEVERS (Price) ---
    function drawLeversPriceChart() {
        // Average Price per week: Us vs Market
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Precio Nosotros');
        data.addColumn('number', 'Precio Competencia');

        const rows = weeksList.map(week => {
            const weekData = processedData.filter(d => d.week_date === week);
            
            const myPrices = weekData.filter(d => d.is_me).map(d => parseFloat(d.price));
            const compPrices = weekData.filter(d => !d.is_me).map(d => parseFloat(d.price));

            const avgMy = myPrices.length ? myPrices.reduce((a,b)=>a+b,0)/myPrices.length : 0;
            const avgComp = compPrices.length ? compPrices.reduce((a,b)=>a+b,0)/compPrices.length : 0;

            return [week, avgMy, avgComp];
        });

        data.addRows(rows);
        
        const options = {
            seriesType: 'line',
            colors: ['#007AFF', '#86868B'],
            vAxis: {title: 'Precio Promedio', format: 'currency'},
            legend: {position: 'top'},
            fontName: '-apple-system'
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_levers_price'));
        chart.draw(data, options);
    }

    // --- CHART 4: EFFICIENCY (Scatter) ---
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Orgánico');
        data.addColumn('number', 'Click Share %');
        data.addColumn({'type': 'string', 'role': 'style'}); // Color
        data.addColumn({'type': 'string', 'role': 'tooltip'});

        const lastWeek = weeksList[weeksList.length - 1];
        const currentData = processedData.filter(d => d.week_date === lastWeek);

        currentData.forEach(d => {
            const color = d.is_me ? 'point { fill-color: #007AFF; size: 6; }' : 'point { fill-color: #86868B; size: 4; }';
            data.addRow([
                parseInt(d.average_organic_rank), 
                parseFloat(d.click_share) * 100, 
                color,
                `${d.final_brand}: Rank ${parseInt(d.average_organic_rank)} / Share ${(d.click_share*100).toFixed(1)}%`
            ]);
        });

        const options = {
            hAxis: {title: 'Rank Orgánico (Menor es mejor)', direction: 1},
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'},
            fontName: '-apple-system'
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // =========================================================================
    // 4. INSIGHTS GENERATOR (TEXT)
    // =========================================================================
    function generateTextInsights() {
        const lastWeek = weeksList[weeksList.length - 1];
        const lastWeekData = processedData.filter(d => d.week_date === lastWeek);
        
        // 1. Recommendations
        const recList = document.getElementById('final-recommendations');
        let recHTML = "";
        
        // Price Logic
        const myAvgPrice = lastWeekData.filter(d=>d.is_me).reduce((a,b)=>a+parseFloat(b.price),0) / (lastWeekData.filter(d=>d.is_me).length || 1);
        const mktAvgPrice = lastWeekData.filter(d=>!d.is_me).reduce((a,b)=>a+parseFloat(b.price),0) / (lastWeekData.filter(d=>!d.is_me).length || 1);

        if (myAvgPrice > mktAvgPrice * 1.2) {
            recHTML += `<li><strong>Ajuste de Precio:</strong> Tu precio es un 20% superior al mercado. Considera activar un cupón temporal para recuperar share.</li>`;
        } else {
            recHTML += `<li><strong>Estabilidad de Precio:</strong> Tu posicionamiento de precio es competitivo. Mantén la estrategia actual.</li>`;
        }

        // Deal Logic
        const myDeals = lastWeekData.filter(d => d.is_me && d.weekly_number_of_days_with_deal > 0).length;
        if (myDeals === 0) {
            recHTML += `<li><strong>Activación de Deals:</strong> No tienes deals activos en la última semana. Competidores clave (AlphaComp) los están usando agresivamente.</li>`;
        }

        recList.innerHTML = recHTML;

        // 2. Risks
        const riskList = document.getElementById('final-risks');
        let riskHTML = "";
        
        // Rank Drop Check
        // (Simplified logic for demo)
        riskHTML += `<li><strong>Presión Competitiva:</strong> AlphaComp ha incrementado su Click Share en un 15% las últimas 2 semanas.</li>`;
        
        riskList.innerHTML = riskHTML;
    }

    // =========================================================================
    // 5. INTERACTIVE TAB LOGIC
    // =========================================================================
    function setupSelectors() {
        const weekSel = document.getElementById('week-selector');
        weeksList.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.appendChild(opt);
        });
        weekSel.value = weeksList[weeksList.length - 1]; // Select last

        const compSel = document.getElementById('competitor-selector');
        competitorsList.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.appendChild(opt);
        });
    }

    function updateComparator() {
        const week = document.getElementById('week-selector').value;
        const comp = document.getElementById('competitor-selector').value;
        
        const dataWeek = processedData.filter(d => d.week_date === week);
        
        // Aggregate My Data
        const myData = dataWeek.filter(d => d.is_me);
        const myStats = {
            price: myData.reduce((a,b)=>a+parseFloat(b.price),0)/myData.length,
            share: myData.reduce((a,b)=>a+parseFloat(b.click_share),0)*100,
            rank: myData.reduce((a,b)=>a+parseFloat(b.average_organic_rank),0)/myData.length,
            deals: myData.some(d=>d.weekly_number_of_days_with_deal > 0) ? "SÍ" : "NO"
        };

        // Aggregate Competitor Data
        const compData = dataWeek.filter(d => d.final_brand === comp);
        const compStats = {
            price: compData.length ? compData.reduce((a,b)=>a+parseFloat(b.price),0)/compData.length : 0,
            share: compData.length ? compData.reduce((a,b)=>a+parseFloat(b.click_share),0)*100 : 0,
            rank: compData.length ? compData.reduce((a,b)=>a+parseFloat(b.average_organic_rank),0)/compData.length : 0,
            deals: compData.some(d=>d.weekly_number_of_days_with_deal > 0) ? "SÍ" : "NO"
        };

        const html = `
        <table class="comparison-table">
            <thead>
                <tr>
                    <th width="30%">Métrica</th>
                    <th width="35%" style="color:#007AFF">${myBrandName} (Nosotros)</th>
                    <th width="35%" style="color:#FF3B30">${comp}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Click Share Total</td>
                    <td class="brand-col" style="font-size:18px">${myStats.share.toFixed(1)}%</td>
                    <td class="brand-col" style="color:#FF3B30; font-size:18px">${compStats.share.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>Precio Promedio</td>
                    <td>$${myStats.price.toFixed(2)}</td>
                    <td>$${compStats.price.toFixed(2)}</td>
                </tr>
                <tr>
                    <td>Avg. Organic Rank</td>
                    <td>${myStats.rank.toFixed(1)}</td>
                    <td>${compStats.rank.toFixed(1)}</td>
                </tr>
                <tr>
                    <td>Deal Activo</td>
                    <td>${myStats.deals}</td>
                    <td>${compStats.deals}</td>
                </tr>
            </tbody>
        </table>
        `;

        document.getElementById('comparator-view').innerHTML = html;
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        
        // Redraw charts if moving to static (fix resize bug)
        if(tabId === 'static') { drawAllCharts(); }
        if(tabId === 'interactive') { updateComparator(); }
    }

    // Handle Resize
    window.onresize = drawAllCharts;

</script>

</body>
</html>