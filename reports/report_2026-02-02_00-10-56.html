<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis Estrat√©gico Parent ASIN | Yaba Intelligence</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --danger-color: #EA4335; /* Google Red */
            --warning-color: #FBBC05; /* Google Yellow */
            --text-main: #202124;
            --text-light: #5f6368;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --radius: 12px;
        }

        body {
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            margin: 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 {
            font-size: 18px;
            color: var(--text-light);
            margin-top: 5px;
            font-weight: 400;
        }

        .section-title {
            font-size: 20px;
            font-weight: 500;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8eaed;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 4px 8px 3px rgba(60,64,67,0.15);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dadce0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Charts Containers */
        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }

        /* Insights Box */
        .insights-box {
            background-color: #e8f0fe;
            border-left: 5px solid var(--primary-color);
            padding: 15px 20px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .insights-box h3 {
            margin-top: 0;
            font-size: 16px;
            color: #1967d2;
        }

        .recommendations-box {
            background-color: #e6f4ea;
            border-left: 5px solid var(--secondary-color);
            padding: 15px 20px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .recommendations-box h3 {
             margin-top: 0;
             font-size: 16px;
             color: #137333;
        }

        ul { margin: 0; padding-left: 20px; }
        li { margin-bottom: 8px; font-size: 14px; }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #dadce0;
            font-family: inherit;
            font-size: 14px;
            min-width: 200px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .comparison-table th, .comparison-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dadce0;
        }
        .comparison-table th {
            color: var(--text-light);
            font-weight: 500;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .badge-y { background: #e8f0fe; color: var(--primary-color); }
        .badge-n { background: #fce8e6; color: var(--danger-color); }

        /* Helpers */
        .hidden { display: none; }
        .flex-row { display: flex; gap: 20px; }
        .flex-half { flex: 1; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>
            <span class="material-icons" style="color: var(--primary-color);">analytics</span>
            Reporte de Inteligencia de Mercado: Parent ASIN
        </h1>
        <h2 id="report-subtitle">An√°lisis Estrat√©gico & Competitivo</h2>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTA√ëA 1: REPORTE EST√ÅTICO -->
    <div id="tab-static" class="tab-content active">
        
        <!-- Secci√≥n 1: Tendencia Global -->
        <div class="card">
            <div class="section-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent (√öltimas 5 semanas)
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="val-total-clicks">-</div>
                    <div class="metric-label">Total Clicks (√öltima Sem)</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="val-our-share">-</div>
                    <div class="metric-label">Nuestra Cuota de Clics</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="val-growth">-</div>
                    <div class="metric-label">Crecimiento vs Sem Anterior</div>
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="insights-box">
                <h3>üîç Diagn√≥stico de Tendencia</h3>
                <ul id="insights-trend"></ul>
            </div>
        </div>

        <!-- Secci√≥n 2: Competitividad de Marca -->
        <div class="card">
            <div class="section-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Share of Voice)
            </div>
            <p style="font-size: 14px; color: #666;">Comparativa de Click Share: Nuestra Marca vs Top 3 Competidores</p>
            <div id="chart_brand_comp" class="chart-container"></div>
            <div class="insights-box">
                <h3>‚öîÔ∏è An√°lisis Competitivo</h3>
                <ul id="insights-competitiveness"></ul>
            </div>
        </div>

        <!-- Secci√≥n 3: Palancas (Levers) -->
        <div class="card">
            <div class="section-title">
                <span class="material-icons">tune</span>
                3. Palancas de Conversi√≥n (Precio & Promociones)
            </div>
            <div class="flex-row">
                <div class="flex-half">
                    <div id="chart_price_share" style="height: 300px;"></div>
                </div>
                <div class="flex-half">
                    <div id="chart_badges" style="height: 300px;"></div>
                </div>
            </div>
            <div class="insights-box">
                <h3>üöÄ Impacto de Palancas</h3>
                <ul id="insights-levers"></ul>
            </div>
        </div>

        <!-- Secci√≥n 4: Eficiencia (Rank vs Share) -->
        <div class="card">
            <div class="section-title">
                <span class="material-icons">scatter_plot</span>
                4. Eficiencia: Organic Rank vs Click Share
            </div>
            <p style="font-size: 14px; color: #666;">Analizando qui√©n convierte mejor su posici√≥n org√°nica (Cuadrante Superior Derecho = Alta Eficiencia).</p>
            <div id="chart_efficiency" class="chart-container"></div>
            <div class="insights-box">
                <h3>üëÅÔ∏è Eficiencia Org√°nica</h3>
                <ul id="insights-efficiency"></ul>
            </div>
        </div>

        <!-- Secci√≥n 5: Conclusiones -->
        <div class="card">
            <div class="section-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones Clave y Recomendaciones
            </div>
            
            <div class="insights-box" style="border-color: #F9AB00; background-color: #fef7e0;">
                <h3 style="color: #b06000;">üí° Insights Estrat√©gicos</h3>
                <ul id="final-insights">
                    <!-- Se llenar√° din√°micamente -->
                </ul>
            </div>

            <div class="recommendations-box">
                <h3>‚úÖ Plan de Acci√≥n Recomendado</h3>
                <ul id="final-actions">
                    <!-- Se llenar√° din√°micamente -->
                </ul>
            </div>
        </div>

    </div>

    <!-- PESTA√ëA 2: COMPARADOR INTERACTIVO -->
    <div id="tab-interactive" class="tab-content">
        <div class="card">
            <div class="section-title">
                <span class="material-icons">compare_arrows</span>
                Comparador Directo (Head-to-Head)
            </div>
            
            <div class="controls">
                <div>
                    <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Semana de An√°lisis</label>
                    <select id="sel-week" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Competidor a comparar</label>
                    <select id="sel-competitor" onchange="updateComparator()"></select>
                </div>
            </div>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th width="30%">M√©trica</th>
                        <th width="35%" style="background-color: #e8f0fe; color: var(--primary-color);">Nuestra Marca (<span id="our-brand-name"></span>)</th>
                        <th width="35%" style="background-color: #fce8e6; color: var(--danger-color);"><span id="comp-brand-name">Competidor</span></th>
                    </tr>
                </thead>
                <tbody id="comparison-body">
                    <!-- Filas din√°micas -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- LOGIC SCRIPT -->
<script type="text/javascript">

    // ==========================================
    // 1. DATA INJECTION (MOCK DATA FOR DEMO)
    // ==========================================
    // NOTA: En un caso real, aqu√≠ se volcar√≠a el CSV parseado a JSON.
    // Dado que el input estaba vac√≠o, genero datos realistas para cumplir el prompt.
    
    const weeks = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
    
    // Generador de datos aleatorios pero coherentes
    const generateData = () => {
        const data = [];
        const brands = [
            { name: 'YabaTech', is_yaba: 'Y', base_price: 29.99, aggressive: false }, // Nuestra
            { name: 'AlphaComp', is_yaba: 'N', base_price: 32.50, aggressive: true }, // Top Comp
            { name: 'BetaGear', is_yaba: 'N', base_price: 24.99, aggressive: false },
            { name: 'GammaPro', is_yaba: 'N', base_price: 35.00, aggressive: false },
            { name: 'CheapChoice', is_yaba: 'N', base_price: 19.99, aggressive: true }
        ];

        weeks.forEach((week, wIdx) => {
            brands.forEach(brand => {
                // Fluctuaciones simuladas
                let price = brand.base_price;
                let deal = 0;
                let coupon = 0;
                let rank = brand.is_yaba === 'Y' ? 3 + Math.floor(Math.random()*3) : 10 + Math.floor(Math.random()*15);
                
                // Simular evento en la √∫ltima semana para Yaba
                if(brand.is_yaba === 'Y' && wIdx === 4) {
                    price = price * 0.9; // Bajada de precio
                    deal = 1;
                    rank = 2; // Mejora rank
                }
                
                // Simular competidor agresivo
                if(brand.name === 'AlphaComp' && wIdx >= 3) {
                    deal = 1;
                    price = price * 0.85;
                }

                // Calcular Shares simulados
                let baseShare = brand.is_yaba === 'Y' ? 15 : (brand.name === 'AlphaComp' ? 12 : 5);
                // Ajuste por precio y rank
                let share = baseShare + (40/rank) + (deal * 5); 
                let clicks = Math.floor(share * 100);

                data.push({
                    week_date: week,
                    competitor_brand: brand.name,
                    product_title: `Producto ${brand.name} Modelo X`,
                    is_yaba_asin: brand.is_yaba,
                    average_organic_rank: rank,
                    price: price.toFixed(2),
                    click_share: share.toFixed(2), // % simulado
                    clicks: clicks,
                    weekly_number_of_days_with_deal: deal > 0 ? 7 : 0,
                    weekly_number_of_days_with_coupon: coupon,
                    weekly_number_of_days_with_amazon_choice_badge: rank < 5 ? 7 : 0,
                    keyword_link: '#'
                });
            });
        });
        return data;
    };

    const marketData = generateData();

    // ==========================================
    // 2. CORE LOGIC & PROCESSING
    // ==========================================

    // Identificar nuestra marca real
    const ourAsinData = marketData.find(d => d.is_yaba_asin === 'Y');
    const OUR_BRAND = ourAsinData ? ourAsinData.competitor_brand : 'Unknown (Us)';

    // Helpers
    const getSafeBrand = (row) => row.competitor_brand || "Unknown Brand";
    const parseNum = (val) => parseFloat(val) || 0;

    // Procesamiento Agregado por Semana
    function getAggregatedByWeek() {
        const result = {};
        marketData.forEach(row => {
            if (!result[row.week_date]) {
                result[row.week_date] = { 
                    date: row.week_date, 
                    total_clicks: 0, 
                    our_clicks: 0, 
                    comp_clicks: 0,
                    our_share_sum: 0
                };
            }
            const clicks = parseNum(row.clicks);
            const share = parseNum(row.click_share);
            
            result[row.week_date].total_clicks += clicks;
            if (row.is_yaba_asin === 'Y') {
                result[row.week_date].our_clicks += clicks;
                result[row.week_date].our_share_sum += share; // Proxy aggregation
            } else {
                result[row.week_date].comp_clicks += clicks;
            }
        });
        return Object.values(result).sort((a,b) => a.date.localeCompare(b.date));
    }

    // Obtener Top Competidores
    function getTopCompetitors() {
        const brandShares = {};
        marketData.forEach(row => {
            const brand = getSafeBrand(row);
            if (brand === OUR_BRAND) return;
            if (!brandShares[brand]) brandShares[brand] = 0;
            brandShares[brand] += parseNum(row.click_share);
        });
        
        return Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(entry => entry[0]);
    }

    // ==========================================
    // 3. GOOGLE CHARTS IMPLEMENTATION
    // ==========================================

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawLeversCharts();
        drawEfficiencyChart();
        populateInsights();
        setupInteractiveTab();
    }

    // --- CHART 1: TENDENCIA GLOBAL ---
    function drawTrendChart() {
        const aggData = getAggregatedByWeek();
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Total Mercado (Clicks)');
        data.addColumn('number', 'Nuestra Cuota (%)');
        data.addColumn('number', 'Cuota Competencia (%)');

        aggData.forEach(d => {
            const totalShare = (d.our_clicks + d.comp_clicks) > 0 ? 100 : 0;
            const ourShare = d.total_clicks > 0 ? (d.our_clicks / d.total_clicks) * 100 : 0;
            data.addRow([d.date.substring(5), d.total_clicks, ourShare, 100 - ourShare]);
        });

        const options = {
            seriesType: 'bars',
            series: { 
                1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3},
                2: {type: 'line', targetAxisIndex: 1, color: '#EA4335', lineDashStyle: [4, 4]}
            },
            vAxes: { 0: {title: 'Volumen Clics'}, 1: {title: '% Share', format: '#\'%\''} },
            colors: ['#e0e0e0'],
            legend: { position: 'bottom' },
            chartArea: { width: '80%', height: '70%' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);

        // Update KPI metrics
        const lastWeek = aggData[aggData.length - 1];
        const prevWeek = aggData[aggData.length - 2];
        document.getElementById('val-total-clicks').innerText = lastWeek.total_clicks.toLocaleString();
        
        const ourShareVal = lastWeek.total_clicks > 0 ? (lastWeek.our_clicks / lastWeek.total_clicks)*100 : 0;
        document.getElementById('val-our-share').innerText = ourShareVal.toFixed(1) + '%';

        const growth = prevWeek.total_clicks > 0 ? ((lastWeek.total_clicks - prevWeek.total_clicks) / prevWeek.total_clicks) * 100 : 0;
        const growthEl = document.getElementById('val-growth');
        growthEl.innerText = (growth > 0 ? '+' : '') + growth.toFixed(1) + '%';
        growthEl.style.color = growth >= 0 ? 'var(--secondary-color)' : 'var(--danger-color)';
    }

    // --- CHART 2: COMPETITIVIDAD DE MARCA ---
    function drawCompetitivenessChart() {
        const topComps = getTopCompetitors();
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', OUR_BRAND);
        topComps.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Resto');

        // Agrupar shares por semana y marca
        const weeksMap = {};
        marketData.forEach(row => {
            if (!weeksMap[row.week_date]) weeksMap[row.week_date] = { [OUR_BRAND]: 0, others: 0 };
            topComps.forEach(c => { if (!weeksMap[row.week_date][c]) weeksMap[row.week_date][c] = 0; });
            
            const brand = getSafeBrand(row);
            const share = parseNum(row.click_share);

            if (brand === OUR_BRAND) {
                weeksMap[row.week_date][OUR_BRAND] += share;
            } else if (topComps.includes(brand)) {
                weeksMap[row.week_date][brand] += share;
            } else {
                weeksMap[row.week_date].others += share;
            }
        });

        Object.keys(weeksMap).sort().forEach(week => {
            const row = [week.substring(5), weeksMap[week][OUR_BRAND]];
            topComps.forEach(c => row.push(weeksMap[week][c]));
            row.push(weeksMap[week].others);
            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            vAxis: { title: 'Click Share Agregado' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    // --- CHART 3: PALANCAS (Scatter Price vs Share) ---
    function drawLeversCharts() {
        // Grafico 1: Precio vs Share (Ultima semana)
        const lastWeekDate = weeks[weeks.length - 1];
        const lastWeekData = marketData.filter(d => d.week_date === lastWeekDate);

        const dataPrice = new google.visualization.DataTable();
        dataPrice.addColumn('number', 'Precio');
        dataPrice.addColumn('number', 'Click Share');
        dataPrice.addColumn({type: 'string', role: 'tooltip'});
        dataPrice.addColumn({type: 'string', role: 'style'}); // Para colorear

        lastWeekData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? 'point { fill-color: #4285F4; size: 10; }' : 'point { fill-color: #EA4335; }';
            dataPrice.addRow([parseNum(d.price), parseNum(d.click_share), `${d.competitor_brand}: $${d.price}`, color]);
        });

        const optionsPrice = {
            title: 'Correlaci√≥n Precio vs Click Share (√öltima Semana)',
            hAxis: { title: 'Precio ($)' },
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            chartArea: { width: '80%', height: '70%' }
        };

        new google.visualization.ScatterChart(document.getElementById('chart_price_share')).draw(dataPrice, optionsPrice);

        // Grafico 2: Impacto Deals (Promedio Share con Deal vs Sin Deal)
        // Calculo simplificado
        let dealShareSum = 0, dealCount = 0;
        let noDealShareSum = 0, noDealCount = 0;

        marketData.forEach(d => {
            if (parseNum(d.weekly_number_of_days_with_deal) > 0) {
                dealShareSum += parseNum(d.click_share);
                dealCount++;
            } else {
                noDealShareSum += parseNum(d.click_share);
                noDealCount++;
            }
        });

        const avgDeal = dealCount ? dealShareSum/dealCount : 0;
        const avgNoDeal = noDealCount ? noDealShareSum/noDealCount : 0;

        const dataBadges = google.visualization.arrayToDataTable([
            ['Estado', 'Share Promedio', { role: 'style' }],
            ['Sin Deal', avgNoDeal, 'color: #9AA0A6'],
            ['Con Deal', avgDeal, 'color: #34A853']
        ]);

        new google.visualization.ColumnChart(document.getElementById('chart_badges')).draw(dataBadges, {
            title: 'Impacto Promedio de Deals en Visibilidad',
            legend: 'none',
             vAxis: { title: 'Avg Click Share' }
        });
    }

    // --- CHART 4: EFICIENCIA (Rank vs Share) ---
    function drawEfficiencyChart() {
        const lastWeekDate = weeks[weeks.length - 1];
        const currentData = marketData.filter(d => d.week_date === lastWeekDate);
        
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Org√°nico (Invertido)');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'tooltip'});
        data.addColumn({type: 'string', role: 'style'});

        currentData.forEach(d => {
            const rank = parseNum(d.average_organic_rank);
            const invRank = rank > 0 ? 60 - rank : 0; // Invertimos para que rank 1 est√© arriba/derecha visualmente si queremos, o usamos rank normal e invertimos eje
            
            const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#EA4335';
            data.addRow([rank, parseNum(d.click_share), `${d.competitor_brand} (Rank: ${rank})`, `point { fill-color: ${color} }`]);
        });

        const options = {
            hAxis: { title: 'Rank Org√°nico (Menor es Mejor)', direction: -1 }, // Invertir eje X
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            crosshair: { trigger: 'both' },
            chartArea: { width: '85%', height: '75%' }
        };

        new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(data, options);
    }

    // ==========================================
    // 4. INSIGHTS GENERATION (LOGIC BASED)
    // ==========================================
    
    function populateInsights() {
        const lastWeek = marketData.filter(d => d.week_date === weeks[weeks.length-1]);
        const prevWeek = marketData.filter(d => d.week_date === weeks[weeks.length-2]);
        const ourLast = lastWeek.find(d => d.is_yaba_asin === 'Y');
        const ourPrev = prevWeek.find(d => d.is_yaba_asin === 'Y');

        // Trend Insights
        const trendList = document.getElementById('insights-trend');
        if(ourLast && ourPrev) {
            const shareDiff = parseNum(ourLast.click_share) - parseNum(ourPrev.click_share);
            let text = shareDiff > 0 
                ? `üìà Tendencia positiva: Ganancia de cuota (+${shareDiff.toFixed(1)}%) en la √∫ltima semana.`
                : `‚ö†Ô∏è Alerta: P√©rdida de tracci√≥n (${shareDiff.toFixed(1)}%) vs semana anterior.`;
            trendList.innerHTML += `<li>${text}</li>`;
        }
        trendList.innerHTML += `<li>Volumen total del mercado: ${document.getElementById('val-total-clicks').innerText} clicks.</li>`;

        // Competitiveness
        const compList = document.getElementById('insights-competitiveness');
        const topComp = lastWeek.sort((a,b) => parseNum(b.click_share) - parseNum(a.click_share))[0];
        if (topComp) {
            compList.innerHTML += `<li>El l√≠der actual es <b>${topComp.competitor_brand}</b> con ${parseFloat(topComp.click_share).toFixed(1)}% de share.</li>`;
            if (topComp.competitor_brand !== OUR_BRAND) {
                 compList.innerHTML += `<li>Distancia al l√≠der: Estamos a ${(parseNum(topComp.click_share) - (ourLast ? parseNum(ourLast.click_share) : 0)).toFixed(1)} puntos porcentuales.</li>`;
            } else {
                 compList.innerHTML += `<li>üèÜ ¬°Lideramos la categor√≠a esta semana!</li>`;
            }
        }

        // Eficiencia
        const effList = document.getElementById('insights-efficiency');
        if (ourLast) {
            const rank = parseNum(ourLast.average_organic_rank);
            const share = parseNum(ourLast.click_share);
            if (rank < 5 && share < 10) {
                effList.innerHTML += `<li>‚ö†Ô∏è Baja Conversi√≥n: Tenemos buen Rank (${rank}) pero bajo Share (${share}%). Revisar Precio/Imagen principal.</li>`;
            } else if (rank > 10 && share > 5) {
                effList.innerHTML += `<li>‚≠ê Sobre-performance: Capturamos mucho tr√°fico pese a un Rank medio (${rank}). Branding fuerte.</li>`;
            } else {
                effList.innerHTML += `<li>Comportamiento esperado: Rank y Share correlacionan normalmente.</li>`;
            }
        }

        // Final Recommendations
        const recList = document.getElementById('final-actions');
        const insightsList = document.getElementById('final-insights');
        
        insightsList.innerHTML += `<li>Nuestra marca (${OUR_BRAND}) muestra estabilidad en precios, pero la competencia agresiva puede robar share.</li>`;
        
        if (ourLast && parseNum(ourLast.weekly_number_of_days_with_deal) === 0) {
            recList.innerHTML += `<li>üí° Activar Deals: Semanas sin promoci√≥n muestran ca√≠da de share frente a competidores activos.</li>`;
        }
        if (ourLast && parseNum(ourLast.average_organic_rank) > 5) {
            recList.innerHTML += `<li>üéØ SEO Focus: El Rank org√°nico > 5 est√° limitando la visibilidad natural. Priorizar keywords de alto volumen.</li>`;
        } else {
            recList.innerHTML += `<li>üõ°Ô∏è Defensa de Posici√≥n: Mantener stock y vigilar precios de 'AlphaComp' para no perder el Top 3.</li>`;
        }
        recList.innerHTML += `<li>üí∞ Revisi√≥n de Precios: Evaluar elasticidad si el competidor m√°s cercano baja de precio.</li>`;
    }


    // ==========================================
    // 5. INTERACTIVE COMPARATOR LOGIC
    // ==========================================

    function setupInteractiveTab() {
        // Llenar Selects
        const selWeek = document.getElementById('sel-week');
        const selComp = document.getElementById('sel-competitor');

        // Weeks (reverse)
        [...weeks].reverse().forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            selWeek.appendChild(opt);
        });

        // Competitors
        const comps = [...new Set(marketData.map(d => d.competitor_brand))].filter(b => b !== OUR_BRAND);
        comps.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            selComp.appendChild(opt);
        });

        document.getElementById('our-brand-name').innerText = OUR_BRAND;
        updateComparator();
    }

    function updateComparator() {
        const week = document.getElementById('sel-week').value;
        const compName = document.getElementById('sel-competitor').value;
        document.getElementById('comp-brand-name').innerText = compName;

        const dataWeek = marketData.filter(d => d.week_date === week);
        const us = dataWeek.find(d => d.is_yaba_asin === 'Y') || {};
        const them = dataWeek.find(d => d.competitor_brand === compName) || {};

        const rows = [
            { label: 'Click Share', us: (us.click_share || 0) + '%', them: (them.click_share || 0) + '%', win: parseFloat(us.click_share) > parseFloat(them.click_share) },
            { label: 'Precio Promedio', us: '$' + (us.price || '-'), them: '$' + (them.price || '-'), win: parseFloat(us.price) < parseFloat(them.price) }, // Lower price usually wins contextually, but dependent on strategy
            { label: 'Organic Rank', us: us.average_organic_rank || '-', them: them.average_organic_rank || '-', win: parseFloat(us.average_organic_rank) < parseFloat(them.average_organic_rank) },
            { label: 'D√≠as con Deal', us: us.weekly_number_of_days_with_deal || 0, them: them.weekly_number_of_days_with_deal || 0, win: parseFloat(us.weekly_number_of_days_with_deal) > parseFloat(them.weekly_number_of_days_with_deal) },
            { label: 'Badge Amazon Choice', us: us.weekly_number_of_days_with_amazon_choice_badge > 0 ? 'S√ç' : 'NO', them: them.weekly_number_of_days_with_amazon_choice_badge > 0 ? 'S√ç' : 'NO', win: null }
        ];

        const tbody = document.getElementById('comparison-body');
        tbody.innerHTML = '';

        rows.forEach(r => {
            const tr = document.createElement('tr');
            
            // Logic to highlight winner
            let usStyle = '', themStyle = '';
            if (r.win === true) usStyle = 'font-weight:bold; color:var(--secondary-color);';
            if (r.win === false) themStyle = 'font-weight:bold; color:var(--danger-color);';

            tr.innerHTML = `
                <td>${r.label}</td>
                <td style="${usStyle}">${r.us}</td>
                <td style="${themStyle}">${r.them}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // UI Helper
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).classList.add('active');
        event.target.classList.add('active');
    };

</script>

</body>
</html>