<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Rendimiento: Parent ASIN (NaturaleBio)</title>
    
    <!-- Google Native Ecosystem Compliance -->
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335;  /* Google Red */
            --text-dark: #202124;
            --text-gray: #5f6368;
            --bg-light: #f8f9fa;
            --card-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { margin: 0; font-size: 24px; color: var(--text-dark); }
        .header .meta { font-size: 12px; color: var(--text-gray); }

        /* Tabs */
        .tabs { margin-bottom: 20px; display: flex; gap: 10px; }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #e8eaed;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Content Sections */
        .section { display: none; }
        .section.active { display: block; }

        /* Cards Grid */
        .grid-kpi {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }
        .card h3 { margin-top: 0; font-size: 14px; color: var(--text-gray); font-weight: 500; }
        .card .value { font-size: 28px; font-weight: 700; color: var(--text-dark); margin: 5px 0; }
        .card .trend { font-size: 12px; display: flex; align-items: center; gap: 4px; }
        .trend.up { color: var(--success-color); }
        .trend.down { color: var(--danger-color); }

        /* Grid Charts */
        .grid-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            min-height: 350px;
        }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

        /* Insights Section */
        .insights-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }
        .insight-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .insight-group h4 { color: var(--primary-color); border-bottom: 2px solid #e8eaed; padding-bottom: 10px; margin-top: 0; }
        .insight-list { list-style: none; padding: 0; }
        .insight-list li { margin-bottom: 12px; display: flex; gap: 10px; align-items: start; }
        .insight-list li .material-icons { font-size: 18px; margin-top: 2px; }
        .insight-list li.warning .material-icons { color: var(--warning-color); }
        .insight-list li.check .material-icons { color: var(--success-color); }
        .insight-list li.info .material-icons { color: var(--primary-color); }

        /* Interactive Controls */
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #dadce0;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        /* Footer */
        .footer { text-align: center; color: var(--text-gray); margin-top: 40px; font-size: 11px; }

        /* Comparison Table */
        .comp-table-wrapper { overflow-x: auto; }
        table.comp-table { width: 100%; border-collapse: collapse; }
        table.comp-table th { text-align: left; padding: 12px; background: #f1f3f4; font-weight: 600; color: var(--text-gray); }
        table.comp-table td { padding: 12px; border-bottom: 1px solid #e8eaed; }
        table.comp-table tr:last-child td { border-bottom: none; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; margin-right: 4px; }
        .badge-choice { background: #202124; color: white; }
        .badge-deal { background: #EA4335; color: white; }
        .badge-coupon { background: #34A853; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>An√°lisis de Rendimiento: Matcha Ceremonial</h1>
                <div class="meta">Parent ASIN: NaturaleBio | Mercado: DE | √öltima actualizaci√≥n: Semana 01, 2026</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">NaturaleBio</div>
                <div style="font-size: 11px;">Marca Analizada</div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">üìä Reporte Ejecutivo</button>
            <button class="tab-btn" onclick="switchTab('interactive')">‚öîÔ∏è Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="static" class="section active">
            
            <!-- KPI Cards -->
            <div class="grid-kpi">
                <div class="card">
                    <h3>Click Share (Semana Actual)</h3>
                    <div class="value">17.5%</div>
                    <div class="trend down"><span class="material-icons">trending_down</span> -3.5 pp vs prev</div>
                </div>
                <div class="card">
                    <h3>Organic Rank Promedio</h3>
                    <div class="value">#5.5</div>
                    <div class="trend down"><span class="material-icons">arrow_downward</span> Estable (4-7)</div>
                </div>
                <div class="card">
                    <h3>Volumen de B√∫squeda</h3>
                    <div class="value">9,632</div>
                    <div class="trend down"><span class="material-icons">trending_down</span> Post-Holiday Dip</div>
                </div>
                <div class="card">
                    <h3>L√≠der de Categor√≠a</h3>
                    <div class="value" style="font-size: 18px; line-height: 1.5;">NORITUAL LAB</div>
                    <div class="trend up" style="color: var(--text-gray);">51.7% Share</div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid-charts">
                <div class="chart-container">
                    <div class="chart-title"><span class="material-icons">show_chart</span> Tendencia Global del Parent (Clicks & Share)</div>
                    <div id="chart_global_trend" style="width: 100%; height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title"><span class="material-icons">pie_chart</span> Competitividad de Marca (Click Share %)</div>
                    <div id="chart_brand_comp" style="width: 100%; height: 300px;"></div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid-charts">
                <div class="chart-container">
                    <div class="chart-title"><span class="material-icons">tune</span> Palancas: Precio vs Click Share</div>
                    <div id="chart_price_share" style="width: 100%; height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title"><span class="material-icons">scatter_plot</span> Eficiencia: Organic Rank vs Share</div>
                    <div id="chart_efficiency" style="width: 100%; height: 300px;"></div>
                </div>
            </div>

            <!-- Actionable Insights -->
            <div class="insights-container">
                <div class="insight-grid">
                    <div class="insight-group">
                        <h4>üí° Conclusiones Clave</h4>
                        <ul class="insight-list">
                            <li class="warning">
                                <span class="material-icons">warning</span>
                                <div><strong>P√©rdida de Tracci√≥n:</strong> NaturaleBio cay√≥ del 21% al 17.5% de Click Share en la √∫ltima semana, correlacionado directamente con la agresividad promocional de competidores.</div>
                            </li>
                            <li class="info">
                                <span class="material-icons">analytics</span>
                                <div><strong>Dominio de NORITUAL LAB:</strong> Este competidor captur√≥ el 51.7% del share en la √∫ltima semana gracias al uso intensivo de <strong>Cupones (4 d√≠as)</strong>, a pesar de tener un precio base en un rango medio-alto (22.90‚Ç¨).</div>
                            </li>
                            <li class="info">
                                <span class="material-icons">trending_down</span>
                                <div><strong>Contracci√≥n del Mercado:</strong> El volumen de b√∫squeda total se redujo casi un 50% tras las fiestas (Semana 52 vs 01), lo que hace que cada clic sea m√°s "caro" en t√©rminos de competencia.</div>
                            </li>
                            <li class="warning">
                                <span class="material-icons">money_off</span>
                                <div><strong>Ineficiencia Promocional:</strong> NaturaleBio tuvo 0 d√≠as de Deals o Cupones en el periodo analizado, dej√°ndolo vulnerable frente a competidores activos.</div>
                            </li>
                            <li class="check">
                                <span class="material-icons">visibility</span>
                                <div><strong>Visibilidad Org√°nica Saludable:</strong> A pesar de la ca√≠da en clicks, el Organic Rank se mantiene fuerte (Top 5). El problema es de conversi√≥n (CTR) por falta de incentivos visuales (badges), no de visibilidad.</div>
                            </li>
                        </ul>
                    </div>
                    <div class="insight-group">
                        <h4>üöÄ Recomendaciones Accionables</h4>
                        <ul class="insight-list">
                            <li class="check">
                                <span class="material-icons">check_circle</span>
                                <div><strong>Activar Cupones Inmediatamente:</strong> Replicar la estrategia de NORITUAL LAB. Activar un cup√≥n de 5-10% en el ASIN principal para recuperar el CTR perdido y romper su dominio.</div>
                            </li>
                            <li class="check">
                                <span class="material-icons">check_circle</span>
                                <div><strong>Defensa de Precio:</strong> El ASIN de 13.99‚Ç¨ de NaturaleBio tiene buen precio, pero est√° perdiendo contra el de 14.90‚Ç¨ de la competencia que ofrece mayor percepci√≥n de valor o branding. Revisar im√°genes principales para destacar "Value for Money".</div>
                            </li>
                            <li class="check">
                                <span class="material-icons">check_circle</span>
                                <div><strong>Preparar Deals para Rebote de Tr√°fico:</strong> Dado que el tr√°fico ha bajado, use este periodo 'valle' para testear badges (Amazon Choice/Best Seller) mediante PPC agresivo en keywords espec√≠ficas para estar posicionado cuando el volumen regrese.</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="insights-container">
                <h4>üîÆ Other Insights</h4>
                <p style="color: var(--text-gray);">
                    Se detect√≥ un competidor emergente "M'atelier" con un precio de 19.99‚Ç¨ y un crecimiento org√°nico interesante (6.7% share) sin grandes promociones visibles. Vigilar si activan publicidad. Adem√°s, la correlaci√≥n precio-share es d√©bil (-0.10), indicando que el cliente de "Matcha Ceremonial" es poco sensible al precio y prioriza calidad percibida o "Status" (Badges/Cupones).
                </p>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE -->
        <div id="interactive" class="section">
            <div class="controls">
                <div>
                    <label style="font-size: 12px; display: block; margin-bottom: 4px;">Seleccionar Semana:</label>
                    <select id="weekSelector" onchange="updateInteractive()">
                        <option value="2026-01">2026-01 (√öltima)</option>
                        <option value="2025-52">2025-52</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 12px; display: block; margin-bottom: 4px;">Comparar vs Competidor:</label>
                    <select id="compSelector" onchange="updateInteractive()">
                        <option value="NORITUAL LAB">NORITUAL LAB (L√≠der)</option>
                        <option value="Jibix">Jibix</option>
                        <option value="UNREAL">UNREAL</option>
                        <option value="M'atelier">M'atelier</option>
                    </select>
                </div>
            </div>

            <div class="grid-charts">
                <div class="chart-container">
                    <div class="chart-title"><span class="material-icons">compare_arrows</span> Cara a Cara: Share vs Precio</div>
                    <div id="chart_interactive_comparison" style="width: 100%; height: 350px;"></div>
                </div>
                <div class="card" style="height: 350px; overflow-y: auto;">
                    <div class="chart-title"><span class="material-icons">table_chart</span> Detalle de Variantes (Semana Seleccionada)</div>
                    <div id="table_variants_div"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            Generado autom√°ticamente por AI Analyst | Base de datos: Amazon DE Search Query Performance
        </div>
    </div>

    <!-- DATA INJECTION & LOGIC -->
    <script>
        // --- DATASET ---
        // Generado a partir del an√°lisis del CSV
        const marketData = [
            // Week 2026-01
            { week: '2026-01', brand: 'NaturaleBio', is_yaba: 'Y', asin: 'B06XQ5DCYJ', title: 'NaturaleBio Matcha Tee Pulver Bio...', click_share: 5.08, price: 13.99, rank: 4, deal: 0, coupon: 0, search_vol: 963.2 },
            { week: '2026-01', brand: 'NaturaleBio', is_yaba: 'Y', asin: 'B07SZFD3P9', title: 'NaturaleBio Matcha Ceremonial...', click_share: 5.74, price: 28.99, rank: 10, deal: 0, coupon: 0, search_vol: 963.2 },
            { week: '2026-01', brand: 'NORITUAL LAB', is_yaba: 'N', asin: 'B0CNRX8G5S', title: 'Ceremonial Matcha - Reines...', click_share: 17.86, price: 22.90, rank: 1, deal: 0, coupon: 4, search_vol: 963.2 },
            { week: '2026-01', brand: 'UNREAL', is_yaba: 'N', asin: 'B0F9B1LWQQ', title: 'UNREAL¬Æ 100g Ceremonial Bio...', click_share: 3.39, price: 29.95, rank: 10, deal: 0, coupon: 0, search_vol: 963.2 },
            { week: '2026-01', brand: 'Unknown', is_yaba: 'N', asin: 'B0FC2XRLV5', title: 'Matcha Pulver Ceremonial...', click_share: 1.96, price: 14.99, rank: 9, deal: 0, coupon: 0, search_vol: 963.2 },
            { week: '2026-01', brand: 'ORIGEENS', is_yaba: 'N', asin: 'B0FJ917BGC', title: 'ORIGEENS BIO MATCHA...', click_share: 2.74, price: 24.97, rank: 15, deal: 0, coupon: 0, search_vol: 963.2 },
            { week: '2026-01', brand: 'M\'atelier', is_yaba: 'N', asin: 'B0FK5VGD2H', title: 'M\'atelier Reines Matcha...', click_share: 4.17, price: 19.99, rank: 6, deal: 0, coupon: 0, search_vol: 963.2 },
            { week: '2026-01', brand: 'NORITUAL LAB', is_yaba: 'N', asin: 'B0FSL3C3Z8', title: 'Ceremonial Matcha Ryoku...', click_share: 14.08, price: 14.90, rank: 2, deal: 0, coupon: 0, search_vol: 963.2 },
            { week: '2026-01', brand: 'Unknown', is_yaba: 'N', asin: 'B0G1T7N675', title: 'Ceremonial Matcha Pulver...', click_share: 2.87, price: 8.47, rank: 13, deal: 4, coupon: 0, search_vol: 963.2 },
            { week: '2026-01', brand: 'Jibix', is_yaba: 'N', asin: 'B0G3XBLNKN', title: 'Jibix Ceremonial Matcha...', click_share: 3.91, price: 22.99, rank: 12, deal: 0, coupon: 0, search_vol: 963.2 },
            
            // Week 2025-52
            { week: '2025-52', brand: 'NaturaleBio', is_yaba: 'Y', asin: 'B06XQ5DCYJ', title: 'NaturaleBio Matcha Tee Pulver Bio...', click_share: 5.80, price: 14.35, rank: 4, deal: 0, coupon: 0, search_vol: 1898.14 },
            { week: '2025-52', brand: 'NaturaleBio', is_yaba: 'Y', asin: 'B07SZFD3P9', title: 'NaturaleBio Matcha Ceremonial...', click_share: 6.75, price: 29.23, rank: 7, deal: 1, coupon: 0, search_vol: 1898.14 },
            { week: '2025-52', brand: 'Matcha & CO', is_yaba: 'N', asin: 'B0882ZCHMW', title: 'T√© Matcha Ceremonial Premium...', click_share: 1.78, price: 31.34, rank: 14, deal: 0, coupon: 0, search_vol: 1898.14 },
            { week: '2025-52', brand: 'NORITUAL LAB', is_yaba: 'N', asin: 'B0CNRX8G5S', title: 'Ceremonial Matcha - Reines...', click_share: 17.63, price: 23.48, rank: 1, deal: 0, coupon: 7, search_vol: 1898.14 },
            { week: '2025-52', brand: 'WeightWorld', is_yaba: 'N', asin: 'B0DPJ4Z5WS', title: 'Bio Matcha Pulver...', click_share: 1.18, price: 13.32, rank: 42, deal: 0, coupon: 0, search_vol: 1898.14 },
            { week: '2025-52', brand: 'UNREAL', is_yaba: 'N', asin: 'B0F99ZP2TX', title: 'UNREAL¬Æ Ceremonial Bio...', click_share: 3.55, price: 9.18, rank: 4, deal: 0, coupon: 0, search_vol: 1898.14 },
            { week: '2025-52', brand: 'UNREAL', is_yaba: 'N', asin: 'B0F9B1LWQQ', title: 'UNREAL¬Æ 100g Ceremonial...', click_share: 2.49, price: 30.71, rank: 11, deal: 0, coupon: 0, search_vol: 1898.14 },
            { week: '2025-52', brand: 'Unknown', is_yaba: 'N', asin: 'B0FJM1MBLM', title: 'Ceremonial Matcha Kiri...', click_share: 2.84, price: 39.49, rank: 10, deal: 1, coupon: 0, search_vol: 1898.14 },
            { week: '2025-52', brand: 'NORITUAL LAB', is_yaba: 'N', asin: 'B0FSL3C3Z8', title: 'Ceremonial Matcha Ryoku...', click_share: 14.20, price: 15.28, rank: 2, deal: 0, coupon: 0, search_vol: 1898.14 },
            { week: '2025-52', brand: 'Jibix', is_yaba: 'N', asin: 'B0G3XBLNKN', title: 'Jibix Ceremonial Matcha...', click_share: 3.67, price: 23.58, rank: 12, deal: 0, coupon: 0, search_vol: 1898.14 }
        ];

        // --- INIT GOOGLE CHARTS ---
        google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
        google.charts.setOnLoadCallback(initCharts);

        function initCharts() {
            drawGlobalTrend();
            drawBrandComp();
            drawPriceShare();
            drawEfficiency();
            updateInteractive(); // Initial load of Tab 2
        }

        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            // Find button roughly
            const btns = document.querySelectorAll('.tab-btn');
            if(tabId === 'static') btns[0].classList.add('active');
            else btns[1].classList.add('active');
        }

        // --- CHART 1: GLOBAL TREND ---
        function drawGlobalTrend() {
            // Aggregating Data
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            const dataTable = [['Semana', 'Total Clicks (Est)', 'NaturaleBio Share %']];

            weeks.forEach(w => {
                const weekData = marketData.filter(d => d.week === w);
                // Calculate estimated clicks: sum((share/100) * volume)
                // Note: volume is repeated per row, so take max volume for the week * sum(share)/100 ? 
                // No, prompt implies 'keywords where appears'. Assuming single KW or aggregated. 
                // Let's sum clicks per ASIN: (share/100)*volume.
                
                const totalClicks = weekData.reduce((sum, item) => sum + (item.click_share/100 * item.search_vol), 0);
                const ourClicks = weekData.filter(d => d.is_yaba === 'Y').reduce((sum, item) => sum + (item.click_share/100 * item.search_vol), 0);
                
                // Avoid division by zero
                const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
                
                dataTable.push([w, Math.round(totalClicks), ourShare]);
            });

            const data = google.visualization.arrayToDataTable(dataTable);
            const options = {
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', pointSize: 5}},
                colors: ['#dadce0'],
                vAxes: {0: {title: 'Volumen Clicks'}, 1: {title: 'Share %', format: '#\'%\''}},
                legend: {position: 'bottom'},
                chartArea: {width: '80%', height: '70%'}
            };
            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
        }

        // --- CHART 2: BRAND COMPETITIVENESS ---
        function drawBrandComp() {
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            
            // Get Top Brands dynamically
            const brandShares = {};
            marketData.forEach(d => {
                const key = d.brand;
                if(!brandShares[key]) brandShares[key] = 0;
                // Rough sum of share points (simplified for visibility)
                brandShares[key] += d.click_share; 
            });
            
            const topBrands = Object.keys(brandShares)
                .sort((a,b) => brandShares[b] - brandShares[a])
                .slice(0, 4); // Top 4 to keep clean
            
            // Header
            const header = ['Semana', ...topBrands];
            const rows = [];

            weeks.forEach(w => {
                const weekData = marketData.filter(d => d.week === w);
                const weekTotalShare = weekData.reduce((sum, d) => sum + d.click_share, 0); // Normalizing base 100? No, assume share is of total market.
                
                const row = [w];
                topBrands.forEach(b => {
                    const bShare = weekData.filter(d => d.brand === b).reduce((sum, d) => sum + d.click_share, 0);
                    row.push(bShare);
                });
                rows.push(row);
            });

            const data = google.visualization.arrayToDataTable([header, ...rows]);
            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#888'],
                vAxis: {title: 'Click Share %'},
                chartArea: {width: '85%', height: '70%'},
                lineWidth: 3
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(data, options);
        }

        // --- CHART 3: PRICE VS SHARE (Last Week) ---
        function drawPriceShare() {
            // Aggregate by Brand for the scatter/line logic
            const lastWeek = '2026-01';
            const weekData = marketData.filter(d => d.week === lastWeek);
            
            // Group by Brand
            const brandStats = {};
            weekData.forEach(d => {
                if(!brandStats[d.brand]) brandStats[d.brand] = {share: 0, priceSum: 0, count: 0, isOurs: d.is_yaba};
                brandStats[d.brand].share += d.click_share;
                brandStats[d.brand].priceSum += d.price;
                brandStats[d.brand].count += 1;
            });

            const dataTable = [['Marca', 'Precio Promedio', 'Total Click Share']];
            Object.keys(brandStats).forEach(b => {
                const s = brandStats[b];
                dataTable.push([b, s.priceSum/s.count, s.share]);
            });

            const data = google.visualization.arrayToDataTable(dataTable);
            // Sorting by Share
            data.sort([{column: 2, desc: true}]);

            const options = {
                series: {
                    0: { targetAxisIndex: 0, type: 'bars', color: '#dadce0' } // Price
                },
                axes: {
                    x: {
                        0: { label: 'Precio' }
                    }
                },
                vAxes: {
                    0: {title: 'Precio (‚Ç¨)'},
                    1: {title: 'Share (%)'}
                },
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1, color: '#EA4335'}}, // Share Line overlay
                legend: 'none', // Custom legend needed?
                title: 'Precio Promedio (Barras) vs Share (L√≠nea) por Marca',
                chartArea: {width: '80%', height: '70%'}
            };
            
            // Actually, for "Palancas", a Scatter might be better: X=Price, Y=Share, Color=Brand
             const dataTableScatter = [['ID', 'Precio', 'Click Share', 'Marca', 'Size']];
             weekData.forEach(d => {
                 dataTableScatter.push([
                     d.brand, 
                     d.price, 
                     d.click_share, 
                     d.is_yaba === 'Y' ? 'NaturaleBio' : 'Competencia',
                     d.click_share
                 ]);
             });
             
             const dataScatter = google.visualization.arrayToDataTable(dataTableScatter);
             const optionsScatter = {
                 title: 'Dispersi√≥n: Precio vs Share (Cada punto es un ASIN)',
                 hAxis: {title: 'Precio (‚Ç¨)'},
                 vAxis: {title: 'Click Share (%)'},
                 bubble: {textStyle: {fontSize: 11}},
                 colors: ['#EA4335', '#4285F4'], // Comp vs Us
                 legend: {position: 'bottom'}
             };

            const chart = new google.visualization.BubbleChart(document.getElementById('chart_price_share'));
            chart.draw(dataScatter, optionsScatter);
        }

        // --- CHART 4: EFFICIENCY (Rank vs Share) ---
        function drawEfficiency() {
            const lastWeek = '2026-01';
            const weekData = marketData.filter(d => d.week === lastWeek);

            const dataTable = [['ID', 'Organic Rank', 'Click Share', 'Tipo']];
            weekData.forEach(d => {
                dataTable.push([
                    d.brand, 
                    d.rank, 
                    d.click_share, 
                    d.is_yaba === 'Y' ? 'NaturaleBio' : 'Competencia'
                ]);
            });

            const data = google.visualization.arrayToDataTable(dataTable);
            const options = {
                title: 'Eficiencia: Rank Org√°nico (Eje X inv) vs Share',
                hAxis: { title: 'Organic Rank (Menor es mejor)', direction: -1 }, // Invert to show rank 1 on right or left? Usually Rank 1 is good (high). Let's keep normal but explain. Or direction -1 puts 1 on right.
                vAxis: { title: 'Click Share (%)' },
                colors: ['#EA4335', '#4285F4'],
                legend: { position: 'bottom' },
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- INTERACTIVE SECTION ---
        function updateInteractive() {
            const week = document.getElementById('weekSelector').value;
            const compBrand = document.getElementById('compSelector').value;
            const ourBrand = 'NaturaleBio';

            // Filter data
            const subset = marketData.filter(d => d.week === week && (d.brand === ourBrand || d.brand === compBrand));

            // Chart Data: Group by Metric
            // Compare Averages for visualization
            const ours = subset.filter(d => d.brand === ourBrand);
            const comp = subset.filter(d => d.brand === compBrand);

            const avgPriceOurs = ours.reduce((s,i)=>s+i.price,0) / (ours.length||1);
            const avgPriceComp = comp.reduce((s,i)=>s+i.price,0) / (comp.length||1);
            
            const totalShareOurs = ours.reduce((s,i)=>s+i.click_share,0);
            const totalShareComp = comp.reduce((s,i)=>s+i.click_share,0);

            const data = google.visualization.arrayToDataTable([
                ['M√©trica', 'NaturaleBio', compBrand],
                ['Precio Promedio (‚Ç¨)', avgPriceOurs, avgPriceComp],
                ['Share Total (%)', totalShareOurs, totalShareComp],
            ]);

            const options = {
                title: `Comparativa Directa: ${week}`,
                seriesType: 'bars',
                colors: ['#4285F4', '#EA4335'],
                vAxis: {title: 'Valor'},
                chartArea: {width: '70%', height: '70%'}
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_interactive_comparison'));
            chart.draw(data, options);

            // Render HTML Table
            let html = `
                <table class="comp-table">
                    <thead>
                        <tr>
                            <th>Marca</th>
                            <th>Producto (T√≠tulo)</th>
                            <th>Precio</th>
                            <th>Share</th>
                            <th>Rank</th>
                            <th>Badges</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            subset.sort((a,b) => b.click_share - a.click_share).forEach(row => {
                let badges = '';
                if(row.deal > 0) badges += '<span class="badge badge-deal">DEAL</span>';
                if(row.coupon > 0) badges += '<span class="badge badge-coupon">COUPON</span>';
                if(row.choice > 0) badges += '<span class="badge badge-choice">CHOICE</span>';

                html += `
                    <tr>
                        <td style="color: ${row.brand === ourBrand ? 'var(--primary-color)' : 'var(--text-dark)'}; font-weight: 500;">
                            ${row.brand}
                        </td>
                        <td style="font-size: 11px;">${row.title.substring(0,40)}...</td>
                        <td>${row.price.toFixed(2)}‚Ç¨</td>
                        <td>${row.click_share.toFixed(2)}%</td>
                        <td>#${row.rank}</td>
                        <td>${badges}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('table_variants_div').innerHTML = html;
        }

    </script>
</body>
</html>