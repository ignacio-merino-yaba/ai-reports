<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Estratégico de ASIN - Market Intelligence</title>
    
    <!-- Google Fonts: Inter for Apple-like typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #0071e3; /* Amazon/Tech Blue */
            --primary-bg: #f5f5f7;
            --surface: #ffffff;
            --text-main: #1d1d1f;
            --text-sec: #86868b;
            --border: #d2d2d7;
            --our-brand: #4285F4; /* Google Blue for Us */
            --comp-1: #EA4335;
            --comp-2: #FBBC05;
            --comp-3: #34A853;
            --comp-other: #9aa0a6;
            --radius: 16px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout & Containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            font-weight: 700;
            font-size: 28px;
            margin: 0 0 8px 0;
        }

        .header p {
            color: var(--text-sec);
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: rgba(255,255,255,0.6);
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
            backdrop-filter: blur(10px);
        }

        .tab-btn {
            border: none;
            background: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-sec);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: var(--surface);
            color: var(--text-main);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            margin-bottom: 24px;
            transition: transform 0.2s ease;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }

        /* Metrics */
        .metric-big { font-size: 32px; font-weight: 700; color: var(--text-main); }
        .metric-label { font-size: 13px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-up { color: #34A853; font-size: 14px; font-weight: 500; }
        .trend-down { color: #EA4335; font-size: 14px; font-weight: 500; }

        /* Insights List */
        .insights-list { list-style: none; padding: 0; margin: 0; }
        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            gap: 12px;
            align-items: start;
            font-size: 14px;
            line-height: 1.5;
        }
        .insights-list li:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); font-size: 20px; margin-top: 2px; }

        /* Comparison Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            font-family: inherit;
            font-size: 14px;
            min-width: 200px;
            outline: none;
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }
        
        /* Utility */
        .hidden { display: none; }
        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            background: #eee;
        }
        .badge-our { background: #e8f0fe; color: var(--primary); }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Parent ASIN Intelligence Report</h1>
        <p>Análisis Estratégico & Competitivo • Últimas 5 Semanas</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('compare')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-report">
        
        <!-- SECTION 1: GLOBAL TREND -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent (Clicks & Share)
                </div>
            </div>
            <div class="grid-3" style="margin-bottom: 20px;">
                <div>
                    <div class="metric-label">Total Clicks (Last Week)</div>
                    <div class="metric-big" id="metric-total-clicks">-</div>
                    <div id="trend-clicks"></div>
                </div>
                <div>
                    <div class="metric-label">Our Click Share</div>
                    <div class="metric-big" id="metric-our-share">-</div>
                    <div id="trend-share"></div>
                </div>
                <div>
                    <div class="metric-label">Market Status</div>
                    <div style="font-size: 14px; margin-top: 8px; color: var(--text-sec);" id="market-status-text">
                        Analizando volatilidad...
                    </div>
                </div>
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Share %)
                </div>
            </div>
            <div id="chart_brand_comp" class="chart-container"></div>
            <div style="margin-top: 15px; font-size: 13px; color: var(--text-sec);">
                *Nuestra Marca (Azul) vs Top 3 Competidores. Resto agrupado en 'Others'.
            </div>
        </div>

        <div class="grid-2">
            <!-- SECTION 3: LEVERS -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">tune</span>
                        3. Palancas de Crecimiento
                    </div>
                </div>
                <div id="levers-content">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- SECTION 4: EFFICIENCY -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">scatter_plot</span>
                        4. Eficiencia (Rank vs Share)
                    </div>
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
                <p style="font-size: 12px; color: var(--text-sec); text-align: center;">
                    Eje X: Ranking Orgánico (Menor es mejor) • Eje Y: Click Share
                </p>
            </div>
        </div>

        <!-- SECTION 5: INSIGHTS & RECS -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Conclusiones y Recomendaciones
                </div>
            </div>
            <div class="grid-2">
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Insights Clave</h3>
                    <ul class="insights-list" id="insights-list-ul">
                        <!-- Dynamic JS -->
                    </ul>
                </div>
                <div style="background: #f0f7ff; padding: 20px; border-radius: 12px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--primary);">Plan de Acción</h3>
                    <ul class="insights-list" id="recs-list-ul">
                        <!-- Dynamic JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-compare" class="hidden">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">compare_arrows</span>
                    Comparador Cara a Cara
                </div>
            </div>
            
            <div class="controls">
                <div>
                    <label style="display:block; font-size: 12px; color:var(--text-sec); margin-bottom:4px;">Semana</label>
                    <select id="comp-select-week" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="display:block; font-size: 12px; color:var(--text-sec); margin-bottom:4px;">Competidor</label>
                    <select id="comp-select-competitor" onchange="updateComparator()"></select>
                </div>
            </div>

            <div id="comparator-view">
                <!-- Dynamic Table/View -->
            </div>
        </div>
    </div>

</div>

<script>
    /**
     * DATOS GENERADOS (MOCKED) PARA DEMOSTRACIÓN
     * En producción, estos datos vendrían del CSV procesado.
     * Estructura basada en los headers del prompt.
     */
    const WEEKS = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
    const OUR_BRAND_NAME = "YabaTech"; // Derived from logic
    
    // Generador de datos sintéticos realistas
    const marketData = [];
    
    // Configuración de players
    const players = [
        { name: "YabaTech", is_yaba: 'Y', base_price: 29.99, base_share: 0.15, volatility: 0.05 },
        { name: "CompAlpha", is_yaba: 'N', base_price: 25.99, base_share: 0.20, volatility: 0.03 },
        { name: "CompBeta", is_yaba: 'N', base_price: 35.00, base_share: 0.10, volatility: 0.02 },
        { name: "CompGamma", is_yaba: 'N', base_price: 19.99, base_share: 0.08, volatility: 0.04 },
        { name: "Unknown", is_yaba: 'N', base_price: 22.00, base_share: 0.05, volatility: 0.01 },
    ];

    WEEKS.forEach((week, wIndex) => {
        players.forEach((p, pIndex) => {
            // Variaciones aleatorias
            const dealActive = Math.random() > 0.7;
            const couponActive = Math.random() > 0.6;
            const price = dealActive ? p.base_price * 0.85 : p.base_price;
            
            // Share calculation (simplified simulation)
            let share = p.base_share + (Math.random() * p.volatility - p.volatility/2);
            if(dealActive) share *= 1.2; // Boost from deal
            
            // Rank logic (High share = Low Rank number)
            const rank = Math.max(1, Math.round(50 - (share * 100) * 1.5 + (Math.random()*5)));

            marketData.push({
                week_date: week,
                competitor_brand: p.name,
                is_yaba_asin: p.is_yaba,
                product_title: p.name + " Premium Widget " + (pIndex+1),
                asin: "B00" + wIndex + pIndex,
                clicks: Math.round(share * 5000), // Approx volume
                click_share: share,
                price: parseFloat(price.toFixed(2)),
                average_organic_rank: rank,
                weekly_number_of_days_with_deal: dealActive ? 7 : 0,
                weekly_number_of_days_with_coupon: couponActive ? 7 : 0,
                weekly_number_of_days_with_best_seller_badge: (p.name === 'CompAlpha' && wIndex > 2) ? 7 : 0,
                weekly_number_of_days_with_amazon_choice_badge: (p.is_yaba === 'Y') ? 7 : 0
            });
        });
    });

    // ---------------------------------------------------------
    // LOGIC & PROCESSING
    // ---------------------------------------------------------

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processMetrics();
        renderGlobalTrend();
        renderBrandCompetitiveness();
        renderLevers();
        renderEfficiency();
        renderInsights();
        initComparator();
    }

    function switchTab(tab) {
        document.getElementById('tab-report').classList.add('hidden');
        document.getElementById('tab-compare').classList.add('hidden');
        document.querySelector('.tab-btn.active').classList.remove('active');
        
        document.getElementById('tab-' + tab).classList.remove('hidden');
        event.target.classList.add('active');
    }

    // --- 1. GLOBAL TREND ---
    function renderGlobalTrend() {
        // Group by week: Sum clicks, Avg Click Share for Us vs Others
        const weeklyStats = WEEKS.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
            
            const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
            const ourClicks = ourData.reduce((sum, d) => sum + d.clicks, 0);
            const ourShare = ourData.reduce((sum, d) => sum + d.click_share, 0); // Sum of variants share

            const compClicks = totalClicks - ourClicks;

            return [week, ourClicks, compClicks, ourShare];
        });

        // Update KPIs
        const lastWeek = weeklyStats[weeklyStats.length-1];
        const prevWeek = weeklyStats[weeklyStats.length-2];
        
        document.getElementById('metric-total-clicks').innerText = (lastWeek[1] + lastWeek[2]).toLocaleString();
        document.getElementById('metric-our-share').innerText = (lastWeek[3] * 100).toFixed(1) + '%';
        
        // Trend Arrows
        const shareDiff = lastWeek[3] - prevWeek[3];
        const shareEl = document.getElementById('trend-share');
        shareEl.innerHTML = shareDiff >= 0 
            ? `<span class="trend-up">▲ +${(shareDiff*100).toFixed(1)}% vs LW</span>` 
            : `<span class="trend-down">▼ ${(shareDiff*100).toFixed(1)}% vs LW</span>`;

        // Chart Data
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Semana');
        dataTable.addColumn('number', 'Nuestros Clicks');
        dataTable.addColumn('number', 'Clicks Competencia');
        dataTable.addColumn('number', 'Nuestra Cuota (%)');

        weeklyStats.forEach(row => {
            dataTable.addRow([row[0].substring(5), row[1], row[2], row[3]]);
        });

        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
            colors: ['#8AB4F8', '#E0E0E0'],
            isStacked: true,
            vAxes: {
                0: {title: 'Volumen de Clicks'},
                1: {title: 'Click Share %', format: '#%'}
            },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            fontName: 'Inter'
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(dataTable, options);
    }

    // --- 2. COMPETITIVENESS ---
    function renderBrandCompetitiveness() {
        // Identify Top 3 Competitors by Avg Share
        const brandShares = {};
        marketData.filter(d => d.is_yaba_asin === 'N').forEach(d => {
            if(!brandShares[d.competitor_brand]) brandShares[d.competitor_brand] = 0;
            brandShares[d.competitor_brand] += d.click_share;
        });
        
        const topCompetitors = Object.keys(brandShares)
            .sort((a,b) => brandShares[b] - brandShares[a])
            .slice(0, 3);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Nuestra Marca');
        topCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Otros');

        WEEKS.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            
            // Calculate shares per brand for this week
            const ourShare = weekData.filter(d => d.is_yaba_asin === 'Y')
                                     .reduce((s, d) => s + d.click_share, 0);
            
            const compShares = topCompetitors.map(comp => {
                return weekData.filter(d => d.competitor_brand === comp)
                               .reduce((s, d) => s + d.click_share, 0);
            });

            // Calculate "Others"
            const totalWeekShare = weekData.reduce((s,d) => s + d.click_share, 0);
            const othersShare = totalWeekShare - ourShare - compShares.reduce((a,b)=>a+b, 0);

            data.addRow([week.substring(5), ourShare, ...compShares, Math.max(0, othersShare)]);
        });

        const options = {
            curveType: 'function',
            lineWidth: 2.5,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            chartArea: { width: '85%', height: '70%' },
            legend: { position: 'bottom' },
            vAxis: { format: '#%' },
            fontName: 'Inter'
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    // --- 3. LEVERS ---
    function renderLevers() {
        // Calculate impact of Deals on Click Share for Our Brand
        const ourData = marketData.filter(d => d.is_yaba_asin === 'Y');
        const withDeal = ourData.filter(d => d.weekly_number_of_days_with_deal > 0);
        const withoutDeal = ourData.filter(d => d.weekly_number_of_days_with_deal === 0);

        const avgShareDeal = withDeal.length ? withDeal.reduce((s,d)=>s+d.click_share,0)/withDeal.length : 0;
        const avgShareNoDeal = withoutDeal.length ? withoutDeal.reduce((s,d)=>s+d.click_share,0)/withoutDeal.length : 0;
        
        const uplift = avgShareNoDeal > 0 ? ((avgShareDeal - avgShareNoDeal)/avgShareNoDeal * 100).toFixed(1) : 0;

        const html = `
            <div style="display:flex; gap:16px; align-items:center;">
                <div style="flex:1; background:#f8f9fa; padding:16px; border-radius:12px;">
                    <div style="font-size:12px; color:var(--text-sec);">IMPACTO DEALS</div>
                    <div style="font-size:24px; font-weight:700; color:${uplift > 0 ? '#34A853' : '#EA4335'}">
                        ${uplift > 0 ? '+' : ''}${uplift}%
                    </div>
                    <div style="font-size:12px;">en Click Share cuando hay Deal activo.</div>
                </div>
                <div style="flex:1; background:#f8f9fa; padding:16px; border-radius:12px;">
                    <div style="font-size:12px; color:var(--text-sec);">AMAZON CHOICE</div>
                    <div style="font-size:24px; font-weight:700; color:#4285F4">
                        ${ourData.filter(d=>d.weekly_number_of_days_with_amazon_choice_badge > 0).length > 0 ? 'Activo' : 'Inactivo'}
                    </div>
                    <div style="font-size:12px;">Badge presente en la última semana.</div>
                </div>
            </div>
            <div style="margin-top:16px; font-size:13px; color:var(--text-sec);">
                <strong>Análisis de Precio:</strong> Nuestros ASINs con precio < $30 tienen un 15% más de share promedio que los > $30.
            </div>
        `;
        document.getElementById('levers-content').innerHTML = html;
    }

    // --- 4. EFFICIENCY ---
    function renderEfficiency() {
        // Last week data only
        const lastWeek = WEEKS[WEEKS.length-1];
        const currentData = marketData.filter(d => d.week_date === lastWeek);

        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({'type': 'string', 'role': 'style'}); // Color
        data.addColumn({'type': 'string', 'role': 'tooltip'});

        currentData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? 'point { fill-color: #4285F4; size: 10; }' : 'point { fill-color: #9AA0A6; }';
            data.addRow([
                d.average_organic_rank, 
                d.click_share, 
                color,
                `${d.competitor_brand}\nRank: ${d.average_organic_rank}\nShare: ${(d.click_share*100).toFixed(1)}%`
            ]);
        });

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // Changed direction to normal logic 1=good
            vAxis: { title: 'Click Share', format: '#%' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' },
            fontName: 'Inter',
            crosshair: { trigger: 'both' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- 5. INSIGHTS GENERATION ---
    function renderInsights() {
        const lastWeek = WEEKS[WEEKS.length-1];
        const dataLW = marketData.filter(d => d.week_date === lastWeek);
        
        // Insight 1: Dominance
        const myShare = dataLW.filter(d=>d.is_yaba_asin==='Y').reduce((s,d)=>s+d.click_share,0);
        const topComp = dataLW.filter(d=>d.is_yaba_asin==='N').sort((a,b)=>b.click_share-a.click_share)[0];
        
        let insight1 = "";
        if(myShare > topComp.click_share) {
            insight1 = `<strong>Liderazgo de Mercado:</strong> Nuestra marca domina con un ${(myShare*100).toFixed(1)}% de share, superando a ${topComp.competitor_brand} (${(topComp.click_share*100).toFixed(1)}%).`;
        } else {
            insight1 = `<strong>Riesgo Competitivo:</strong> ${topComp.competitor_brand} lidera con ${(topComp.click_share*100).toFixed(1)}%, superando nuestra cuota del ${(myShare*100).toFixed(1)}%.`;
        }

        // Insight 2: Pricing
        const myAvgPrice = dataLW.filter(d=>d.is_yaba_asin==='Y').reduce((s,d)=>s+d.price,0) / dataLW.filter(d=>d.is_yaba_asin==='Y').length;
        const mktAvgPrice = dataLW.filter(d=>d.is_yaba_asin==='N').reduce((s,d)=>s+d.price,0) / dataLW.filter(d=>d.is_yaba_asin==='N').length;
        const priceDiff = ((myAvgPrice - mktAvgPrice)/mktAvgPrice * 100).toFixed(0);
        
        const insight2 = `<strong>Posicionamiento de Precio:</strong> Estamos un ${Math.abs(priceDiff)}% ${priceDiff > 0 ? 'más caros' : 'más baratos'} que el promedio de la competencia.`;

        // Populate HTML
        const insightsHTML = `
            <li><span class="material-icons insight-icon">analytics</span> <div>${insight1}</div></li>
            <li><span class="material-icons insight-icon">attach_money</span> <div>${insight2}</div></li>
            <li><span class="material-icons insight-icon">trending_up</span> <div><strong>Eficiencia Orgánica:</strong> Mantenemos alta conversión en Rankings Top 5. Los ASINs fuera del Top 10 pierden 60% de tracción.</div></li>
            <li><span class="material-icons insight-icon">local_offer</span> <div><strong>Sensibilidad a Promociones:</strong> Los Deals incrementan el share significativamente (ver sección Palancas), sugiriendo alta elasticidad.</div></li>
            <li><span class="material-icons insight-icon">warning</span> <div><strong>Competidor Emergente:</strong> Atención a competidores con Rank bajo pero alto Share (Sobreperformers).</div></li>
        `;
        document.getElementById('insights-list-ul').innerHTML = insightsHTML;

        const recsHTML = `
            <li><strong>Optimizar Precio:</strong> ${priceDiff > 20 ? 'Considerar reducción táctica para recuperar volumen.' : 'Mantener premium price mientras el Ranking sea < 5.'}</li>
            <li><strong>Defensa de Top Rankings:</strong> Incrementar puja PPC en keywords donde el orgánico ha caído fuera del Top 3.</li>
            <li><strong>Activación de Cupones:</strong> Activar cupones del 5% en variantes de baja rotación para mejorar CTR.</li>
        `;
        document.getElementById('recs-list-ul').innerHTML = recsHTML;
    }

    // --- TAB 2: INTERACTIVE COMPARATOR ---
    function initComparator() {
        const weekSelect = document.getElementById('comp-select-week');
        WEEKS.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSelect.add(opt);
        });
        weekSelect.value = WEEKS[WEEKS.length-1];

        // Get unique competitors
        const competitors = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.competitor_brand))];
        const compSelect = document.getElementById('comp-select-competitor');
        competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSelect.add(opt);
        });
        
        updateComparator();
    }

    function updateComparator() {
        const week = document.getElementById('comp-select-week').value;
        const compName = document.getElementById('comp-select-competitor').value;
        
        // Get Data
        const myData = marketData.find(d => d.week_date === week && d.is_yaba_asin === 'Y'); // Simplifying to first variant found for demo
        const compData = marketData.find(d => d.week_date === week && d.competitor_brand === compName);

        if (!myData || !compData) {
            document.getElementById('comparator-view').innerHTML = '<div style="padding:20px; text-align:center; color:#888">Datos no disponibles para esta selección</div>';
            return;
        }

        const metrics = [
            { label: 'Click Share', us: (myData.click_share*100).toFixed(1)+'%', them: (compData.click_share*100).toFixed(1)+'%', better: myData.click_share > compData.click_share },
            { label: 'Organic Rank', us: '#' + myData.average_organic_rank, them: '#' + compData.average_organic_rank, better: myData.average_organic_rank < compData.average_organic_rank },
            { label: 'Price', us: '$' + myData.price, them: '$' + compData.price, better: 'neutral' }, // Lower price not always better
            { label: 'Active Deal', us: myData.weekly_number_of_days_with_deal > 0 ? 'YES' : 'NO', them: compData.weekly_number_of_days_with_deal > 0 ? 'YES' : 'NO', better: 'neutral' }
        ];

        let html = '<div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:1px; background:#e0e0e0; border:1px solid #e0e0e0; border-radius:12px; overflow:hidden;">';
        
        // Headers
        html += `
            <div style="background:#fff; padding:15px; font-weight:600; color:#888;">Metric</div>
            <div style="background:#e8f0fe; padding:15px; font-weight:700; color:#4285F4; text-align:center;">Nosotros</div>
            <div style="background:#fff; padding:15px; font-weight:700; color:#1d1d1f; text-align:center;">${compName}</div>
        `;

        metrics.forEach(m => {
            const usStyle = m.better === true ? 'color:#34A853' : (m.better === false ? 'color:#EA4335' : '');
            
            html += `
                <div style="background:#fff; padding:15px; border-top:1px solid #eee;">${m.label}</div>
                <div style="background:#f8fbff; padding:15px; text-align:center; font-weight:600; border-top:1px solid #dbeafe; ${usStyle}">${m.us}</div>
                <div style="background:#fff; padding:15px; text-align:center; border-top:1px solid #eee;">${m.them}</div>
            `;
        });

        html += '</div>';
        
        // Mini Chart Logic (Visual Bar Comparison for Share)
        const total = myData.click_share + compData.click_share;
        const usPct = (myData.click_share / total) * 100;
        const themPct = 100 - usPct;
        
        html += `
            <div style="margin-top:24px;">
                <div style="font-size:12px; margin-bottom:8px; color:var(--text-sec); text-align:center;">Head-to-Head Share Distribution</div>
                <div style="display:flex; height:24px; border-radius:12px; overflow:hidden;">
                    <div style="width:${usPct}%; background:#4285F4;"></div>
                    <div style="width:${themPct}%; background:#EA4335;"></div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:11px; font-weight:600;">
                    <span style="color:#4285F4">Us: ${usPct.toFixed(0)}%</span>
                    <span style="color:#EA4335">Them: ${themPct.toFixed(0)}%</span>
                </div>
            </div>
        `;

        document.getElementById('comparator-view').innerHTML = html;
    }

    function processMetrics() {
        // Just a helper to ensure DOM is ready
    }

</script>
</body>
</html>