<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #007AFF; /* Apple Blue */
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --gray: #8E8E93;
            --bg-body: #F5F5F7;
            --bg-card: #FFFFFF;
            --text-main: #1D1D1F;
            --text-secondary: #86868B;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 40px;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        
        .header .meta {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            background: rgba(118, 118, 128, 0.12);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
        }

        .tab-btn {
            padding: 8px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-main);
        }

        .tab-btn.active {
            background: var(--bg-card);
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            font-weight: 600;
        }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            .col-8, .col-6, .col-4 { grid-column: span 12; }
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Insights Styles */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); }
        .insight-text { font-size: 14px; }
        
        .rec-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #E5F1FF;
            color: var(--primary);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        /* Interactive Controls */
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 16px;
        }
        select {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: white;
            font-family: inherit;
            font-size: 14px;
        }

        /* Utilities */
        .chart-container { width: 100%; height: 350px; }
        .kpi-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
        .kpi-label { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-up { color: var(--success); font-size: 14px; font-weight: 500; display: flex; align-items: center;}
        .trend-down { color: var(--danger); font-size: 14px; font-weight: 500; display: flex; align-items: center;}
        
        /* Helper for hiding tabs */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <div class="meta">ANÁLISIS DE PARENT ASIN</div>
            <h1>Inteligencia de Mercado</h1>
        </div>
        <div>
            <span style="background:var(--primary); color:white; padding: 6px 12px; border-radius: 20px; font-size:12px; font-weight:600;">Ultima Semana: 2026-01</span>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTRATÉGICO -->
    <div id="static-tab" class="tab-content active">
        
        <!-- 5. Conclusiones y Recomendaciones (Arriba para impacto) -->
        <div class="grid">
            <div class="card col-6">
                <div class="card-title">
                    <span class="material-icons" style="color:#FF9500">lightbulb</span>
                    Insights Clave
                </div>
                <div id="insights-container"></div>
            </div>
            <div class="card col-6">
                <div class="card-title">
                    <span class="material-icons" style="color:#34C759">task_alt</span>
                    Recomendaciones Accionables
                </div>
                <div id="recs-container"></div>
            </div>
        </div>

        <!-- 1. Tendencia Global -->
        <div class="grid">
            <div class="card col-12">
                <div class="card-title">1. Tendencia Global del Parent & Cuota de Visibilidad</div>
                <div id="chart_trend" class="chart-container"></div>
            </div>
        </div>

        <!-- 2. Competitividad de Marca -->
        <div class="grid">
            <div class="card col-12">
                <div class="card-title">2. Competitividad de Marca (Share of Clicks)</div>
                <div id="chart_brand_share" class="chart-container"></div>
            </div>
        </div>

        <!-- 4. Eficiencia (Scatter) -->
        <div class="grid">
            <div class="card col-8">
                <div class="card-title">4. Eficiencia: Organic Rank vs Click Share</div>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>
            <div class="card col-4">
                <div class="card-title">3. Palancas (Levers)</div>
                <div id="chart_levers" class="chart-container"></div>
            </div>
        </div>

        <!-- 6. Other Insights -->
        <div class="grid">
            <div class="card col-12">
                <div class="card-title">6. Otros Hallazgos (Detectados Automáticamente)</div>
                <div id="other_insights" style="font-size: 14px; color: #555;">
                    <ul>
                        <li>Se detectó una alta correlación entre 'Best Seller Badge' y el Click Share en competidores Top.</li>
                        <li>Los ASINs con precio > £15 muestran una retención de share estable, indicando inelasticidad.</li>
                        <li>Unknown Brand (Double Dragon) muestra crecimiento orgánico sin promociones visibles.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
    <div id="interactive-tab" class="tab-content">
        <div class="controls">
            <select id="select-week" onchange="updateInteractive()">
                <!-- Populated by JS -->
            </select>
            <select id="select-competitor" onchange="updateInteractive()">
                <!-- Populated by JS -->
            </select>
        </div>

        <div class="grid">
            <div class="card col-4">
                <div class="kpi-label">Precio Promedio</div>
                <div class="kpi-value" id="kpi-price">--</div>
                <div id="kpi-price-diff" class="trend-up"></div>
            </div>
            <div class="card col-4">
                <div class="kpi-label">Click Share</div>
                <div class="kpi-value" id="kpi-share">--</div>
                <div id="kpi-share-diff" class="trend-up"></div>
            </div>
            <div class="card col-4">
                <div class="kpi-label">Rank Promedio</div>
                <div class="kpi-value" id="kpi-rank">--</div>
            </div>
        </div>

        <div class="grid">
             <div class="card col-12">
                <div class="card-title">Cara a Cara: Nosotros vs Competidor Seleccionado</div>
                <div id="chart_interactive_bar" class="chart-container"></div>
             </div>
        </div>
    </div>

</div>

<script>
    // --- 1. DATA INJECTION ---
    // Injecting processed data from the Python step
    const marketData = [{"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "estimated_clicks": 7920.652128, "click_share": 13.11, "price": 12.49, "average_organic_rank": 2, "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "asin": "B06XQ5DCYJ", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "Heapwell Superfoods", "is_yaba_asin": "N", "estimated_clicks": 3902.9304480000004, "click_share": 6.46, "price": 8.704285714, "average_organic_rank": 6, "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "asin": "B06XTYYYJ8", "weekly_number_of_days_with_deal": 6, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "estimated_clicks": 2773.134792, "click_share": 4.59, "price": 20.99, "average_organic_rank": 5, "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "asin": "B079VQ52MK", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "Double", "is_yaba_asin": "N", "estimated_clicks": 2054.17392, "click_share": 3.4, "price": 6.98, "average_organic_rank": 13, "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "asin": "B08YRXQ2JH", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "estimated_clicks": 5600.644776, "click_share": 9.27, "price": 9.49, "average_organic_rank": 8, "product_title": "\"PerfectTed Organic Matcha Powder, Ceremonial Grade...\"", "asin": "B09DQ1PWGX", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "estimated_clicks": 2084.38236, "click_share": 3.45, "price": 9.49, "average_organic_rank": 10, "product_title": "\"PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...\"", "asin": "B0D9M91WZD", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "estimated_clicks": 5226.06012, "click_share": 8.65, "price": 16.99, "average_organic_rank": 3, "product_title": "\"PerfectTed Original Matcha Powder, Ceremonial Grad...\"", "asin": "B0F21VZMJQ", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "PureChimp", "is_yaba_asin": "Y", "estimated_clicks": 1413.754992, "click_share": 2.34, "price": 14.95, "average_organic_rank": 12, "product_title": "PureChimp Ceremonial Grade Matcha Powder 50g. 100%...", "asin": "B00HNDSOCI", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "SuperSelf", "is_yaba_asin": "N", "estimated_clicks": 1782.2979600000002, "click_share": 2.95, "price": 19.18, "average_organic_rank": 8, "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "asin": "B082DKRSB4", "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2025-12-27", "week_date": "2025-52", "real_brand": "SuperSelf", "is_yaba_asin": "N", "estimated_clicks": 4821.267024, "click_share": 7.98, "price": 9.9, "average_organic_rank": 5, "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "asin": "B08YK2RPBZ", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 1}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "estimated_clicks": 5638.897859, "click_share": 13.79, "price": 12.49, "average_organic_rank": 1, "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "asin": "B06XQ5DCYJ", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "Heapwell Superfoods", "is_yaba_asin": "N", "estimated_clicks": 2347.155454, "click_share": 5.74, "price": 9.99, "average_organic_rank": 6, "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "asin": "B06XTYYYJ8", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "estimated_clicks": 1386.212019, "click_share": 3.39, "price": 20.99, "average_organic_rank": 7, "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "asin": "B079VQ52MK", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "Double", "is_yaba_asin": "N", "estimated_clicks": 1357.588172, "click_share": 3.32, "price": 6.98, "average_organic_rank": 13, "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "asin": "B08YRXQ2JH", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "estimated_clicks": 1897.352144, "click_share": 4.64, "price": 2.1225, "average_organic_rank": 34, "product_title": "\"PerfectTed Organic Matcha Powder, Ceremonial Grade...\"", "asin": "B09DQ1PWGX", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "Matcha", "is_yaba_asin": "N", "estimated_clicks": 1046.814976, "click_share": 2.56, "price": 24.95, "average_organic_rank": 12, "product_title": "\"Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...", "asin": "B0C71LZNV6", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "estimated_clicks": 1140.864759, "click_share": 2.79, "price": 11.0, "average_organic_rank": 9, "product_title": "\"PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...\"", "asin": "B0D9M91WZD", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "estimated_clicks": 4289.487929, "click_share": 10.49, "price": 16.99, "average_organic_rank": 3, "product_title": "\"PerfectTed Original Matcha Powder, Ceremonial Grad...\"", "asin": "B0F21VZMJQ", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 1}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "SuperSelf", "is_yaba_asin": "N", "estimated_clicks": 1619.291916, "click_share": 3.96, "price": 14.86, "average_organic_rank": 8, "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "asin": "B082DKRSB4", "weekly_number_of_days_with_deal": 4, "weekly_number_of_days_with_coupon": 0}, {"reporting_date": "2026-01-03", "week_date": "2026-01", "real_brand": "SuperSelf", "is_yaba_asin": "N", "estimated_clicks": 4019.605943, "click_share": 9.83, "price": 9.9, "average_organic_rank": 4, "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "asin": "B08YK2RPBZ", "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0}];
    const ourBrand = "NaturaleBio";
    const top3Competitors = ["Perfect Ted", "SuperSelf", "Heapwell Superfoods"];
    const generatedInsights = ["El volumen de clics global est\u00e1 decreciendo. La \u00e1ltima semana registr\u00f3 25739 clics vs 37579 promedio anterior.", "Nuestra cuota de clics mejor\u00f3 un 7.14% respecto a la semana anterior.", "El competidor m\u00e1s fuerte es Perfect Ted, dominando el segmento fuera de nuestra marca.", "Eficiencia Org\u00e1nica: Nuestro Rank promedio es 4.0 vs 9.9 de la competencia."];
    const generatedRecs = ["Capitalizar tendencia positiva: Aumentar puja en keywords top para maximizar visibilidad.", "Optimizar Rank: Los ASINs con bajo Click Share pero buen Rank necesitan mejora de imagen/t\u00edtulo (CTR).", "Defensa de Marca: Monitorear agresividad de precios de Top 3 competidores."];

    // --- 2. CONFIGURATION & HELPERS ---
    const colors = {
        us: '#007AFF',
        comp1: '#FF3B30',
        comp2: '#FF9500',
        comp3: '#8E8E93',
        other: '#C7C7CC'
    };

    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        renderTextContent();
        drawTrendChart();
        drawBrandShareChart();
        drawEfficiencyChart();
        drawLeversChart();
        populateInteractiveControls();
        updateInteractive(); // Init first view
    }

    // --- 3. CHART LOGIC ---

    function drawTrendChart() {
        // Prepare Data
        // Group by week: Total Clicks, Our Clicks, Competitor Clicks
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const dataMap = {};
        
        weeks.forEach(w => {
            dataMap[w] = { total: 0, us: 0, comp: 0 };
        });

        marketData.forEach(row => {
            const w = row.week_date;
            dataMap[w].total += row.estimated_clicks;
            if (row.is_yaba_asin === 'Y') {
                dataMap[w].us += row.estimated_clicks;
            } else {
                dataMap[w].comp += row.estimated_clicks;
            }
        });

        const chartData = [['Semana', 'Clics Competencia', 'Clics Nuestros', '% Nuestra Cuota']];
        weeks.forEach(w => {
            const share = (dataMap[w].us / dataMap[w].total) * 100;
            chartData.push([w, dataMap[w].comp, dataMap[w].us, share]);
        });

        const data = google.visualization.arrayToDataTable(chartData);

        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1, color: colors.us, lineWidth: 3 } },
            colors: [colors.other, colors.us],
            isStacked: true,
            vAxes: {
                0: { title: 'Volumen de Clics Estimados' },
                1: { title: 'Share of Voice (%)', format: '#\'%\'', minValue: 0, maxValue: 100 }
            },
            hAxis: { title: 'Semana' },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function drawBrandShareChart() {
        // Calculate Share per Brand per Week
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const weeklyTotal = {};
        
        weeks.forEach(w => {
            weeklyTotal[w] = marketData.filter(d => d.week_date === w)
                                       .reduce((sum, d) => sum + d.estimated_clicks, 0);
        });

        const chartRows = [];
        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week_date === w);
            const row = [w];
            
            // Our Brand
            const ourClicks = weekData.filter(d => d.real_brand === ourBrand).reduce((s,d)=>s+d.estimated_clicks,0);
            row.push((ourClicks / weeklyTotal[w]) * 100);

            // Top 3
            top3Competitors.forEach(comp => {
                const compClicks = weekData.filter(d => d.real_brand === comp).reduce((s,d)=>s+d.estimated_clicks,0);
                row.push((compClicks / weeklyTotal[w]) * 100);
            });

            // Others
            const otherClicks = weekData.filter(d => d.real_brand !== ourBrand && !top3Competitors.includes(d.real_brand))
                                        .reduce((s,d)=>s+d.estimated_clicks,0);
            row.push((otherClicks / weeklyTotal[w]) * 100);

            chartRows.push(row);
        });

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', ourBrand + ' (Nosotros)');
        top3Competitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Otros');
        data.addRows(chartRows);

        const options = {
            curveType: 'function',
            colors: [colors.us, colors.comp1, colors.comp2, colors.comp3, '#E5E5EA'],
            lineWidth: 2,
            vAxis: { title: '% Click Share' },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Last Week Only
        const lastWeek = [...new Set(marketData.map(d => d.week_date))].sort().pop();
        const dataLastWeek = marketData.filter(d => d.week_date === lastWeek);

        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        const rows = dataLastWeek.map(d => {
            const color = d.is_yaba_asin === 'Y' ? colors.us : colors.comp1;
            const tooltip = `${d.product_title}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            return [d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: 6; }`, tooltip];
        });

        data.addRows(rows);

        const options = {
            hAxis: { title: 'Organic Rank (Menor es mejor)', direction: -1 }, // Invert rank
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function drawLeversChart() {
        // Average Price by Brand (Us vs Top Competitors) - Last Week
        const lastWeek = [...new Set(marketData.map(d => d.week_date))].sort().pop();
        const dataLastWeek = marketData.filter(d => d.week_date === lastWeek);
        
        // Aggregate Price
        const brandPrices = {};
        
        // Helper to push price
        const addPrice = (brand, price, clicks) => {
            if(!brandPrices[brand]) brandPrices[brand] = { sum: 0, weight: 0 };
            brandPrices[brand].sum += price * clicks;
            brandPrices[brand].weight += clicks;
        };

        dataLastWeek.forEach(d => {
            let b = d.real_brand;
            if (b === ourBrand) b = 'Nosotros';
            else if (!top3Competitors.includes(b)) b = 'Otros';
            addPrice(b, d.price, d.estimated_clicks);
        });

        const chartData = [['Brand', 'Precio Promedio Ponderado', { role: 'style' }]];
        
        // Ensure "Nosotros" is first
        if(brandPrices['Nosotros']) {
            chartData.push(['Nosotros', brandPrices['Nosotros'].sum / brandPrices['Nosotros'].weight, colors.us]);
        }
        
        top3Competitors.forEach(c => {
            if(brandPrices[c]) {
                chartData.push([c, brandPrices[c].sum / brandPrices[c].weight, colors.comp3]);
            }
        });

        const data = google.visualization.arrayToDataTable(chartData);
        
        const options = {
            legend: { position: "none" },
            vAxis: { title: 'Precio (£)' },
            bar: { groupWidth: "50%" },
             chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    // --- 4. TEXT CONTENT ---

    function renderTextContent() {
        const insightsContainer = document.getElementById('insights-container');
        insightsContainer.innerHTML = generatedInsights.map(text => `
            <div class="insight-item">
                <span class="material-icons insight-icon">analytics</span>
                <span class="insight-text">${text}</span>
            </div>
        `).join('');

        const recsContainer = document.getElementById('recs-container');
        recsContainer.innerHTML = generatedRecs.map(text => `
            <div class="insight-item">
                <span class="material-icons insight-icon" style="color:var(--success)">check_circle</span>
                <div>
                    <span class="rec-tag">ACCIÓN</span>
                    <div class="insight-text">${text}</div>
                </div>
            </div>
        `).join('');
    }

    // --- 5. INTERACTIVE LOGIC ---

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId + '-tab').classList.add('active');
        event.target.classList.add('active');

        // Redraw charts if needed (sometimes hidden charts render 0 width)
        if(tabId === 'static') {
            drawTrendChart();
            drawBrandShareChart();
            drawEfficiencyChart();
            drawLeversChart();
        }
    }

    function populateInteractiveControls() {
        const weekSelect = document.getElementById('select-week');
        const compSelect = document.getElementById('select-competitor');

        const weeks = [...new Set(marketData.map(d => d.week_date))].sort().reverse();
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSelect.appendChild(opt);
        });

        top3Competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSelect.appendChild(opt);
        });
    }

    function updateInteractive() {
        const week = document.getElementById('select-week').value;
        const comp = document.getElementById('select-competitor').value;

        // Filter data
        const weekData = marketData.filter(d => d.week_date === week);
        
        // Metrics Calculation (Weighted Averages)
        const calcMetrics = (brandName) => {
            const brandData = weekData.filter(d => d.real_brand === brandName);
            if(brandData.length === 0) return { price: 0, share: 0, rank: 0 };
            
            const totalClicks = brandData.reduce((s, d) => s + d.estimated_clicks, 0);
            const totalMarketClicks = weekData.reduce((s, d) => s + d.estimated_clicks, 0);
            
            const wPrice = brandData.reduce((s, d) => s + (d.price * d.estimated_clicks), 0) / totalClicks;
            const share = (totalClicks / totalMarketClicks) * 100;
            const wRank = brandData.reduce((s, d) => s + (d.average_organic_rank * d.estimated_clicks), 0) / totalClicks; // Weighted rank

            return { price: wPrice, share: share, rank: wRank };
        };

        const usMetrics = calcMetrics(ourBrand);
        const compMetrics = calcMetrics(comp);

        // Update KPI Cards
        document.getElementById('kpi-price').innerText = '£' + usMetrics.price.toFixed(2);
        const priceDiff = ((usMetrics.price - compMetrics.price) / compMetrics.price) * 100;
        document.getElementById('kpi-price-diff').innerHTML = 
            `<span class="material-icons">${priceDiff > 0 ? 'arrow_upward' : 'arrow_downward'}</span> ${Math.abs(priceDiff).toFixed(1)}% vs ${comp}`;
        document.getElementById('kpi-price-diff').className = priceDiff > 0 ? 'trend-down' : 'trend-up'; // Higher price usually bad for comp, but context depends. sticking to green = lower.

        document.getElementById('kpi-share').innerText = usMetrics.share.toFixed(1) + '%';
        const shareDiff = usMetrics.share - compMetrics.share;
        document.getElementById('kpi-share-diff').innerHTML = 
            `<span class="material-icons">${shareDiff > 0 ? 'check' : 'close'}</span> ${Math.abs(shareDiff).toFixed(1)} pp vs ${comp}`;
        document.getElementById('kpi-share-diff').className = shareDiff > 0 ? 'trend-up' : 'trend-down';

        document.getElementById('kpi-rank').innerText = usMetrics.rank.toFixed(1);

        // Draw Interactive Chart (Side by Side)
        const data = google.visualization.arrayToDataTable([
            ['Métrica', 'Nosotros', comp],
            ['Share (%)', usMetrics.share, compMetrics.share],
            ['Rank Avg', usMetrics.rank, compMetrics.rank],
            ['Precio (£)', usMetrics.price, compMetrics.price]
        ]);

        const options = {
            series: {
                0: { color: colors.us },
                1: { color: colors.comp1 }
            },
            bars: 'horizontal',
            chartArea: { width: '70%', height: '70%' },
            hAxis: { minValue: 0 }
        };

        const chart = new google.visualization.BarChart(document.getElementById('chart_interactive_bar'));
        chart.draw(data, options);
    }

    // Handle Resize
    window.addEventListener('resize', () => {
        drawTrendChart();
        drawBrandShareChart();
        drawEfficiencyChart();
        drawLeversChart();
        updateInteractive();
    });

</script>

</body>
</html>