<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon ASIN Performance Report: NaturaleBio</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #1a73e8; /* Google Blue */
            --secondary-color: #5f6368; /* Google Grey */
            --success-color: #34a853; /* Google Green */
            --warning-color: #fbbc04; /* Google Yellow */
            --danger-color: #ea4335; /* Google Red */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #202124;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px 0;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 400; color: var(--secondary-color); }
        h1 span { font-weight: 700; color: #202124; }
        .meta-badge {
            background: #e8f0fe;
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            border-bottom: 1px solid #dadce0;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: var(--secondary-color);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-btn:hover { background-color: rgba(26,115,232,0.04); }

        /* Cards & Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-1 { display: grid; grid-template-columns: 1fr; gap: 24px; }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: box-shadow 0.3s ease;
        }
        .card:hover { box-shadow: 0 4px 8px 3px rgba(60,64,67,0.15); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-title { font-size: 18px; font-weight: 500; color: #202124; display: flex; align-items: center; gap: 8px; }
        
        /* Metrics */
        .metric-value { font-size: 36px; font-weight: 400; color: var(--primary-color); }
        .metric-label { font-size: 14px; color: var(--secondary-color); margin-top: 4px; }
        .trend-up { color: var(--success-color); font-size: 14px; display: flex; align-items: center; }
        .trend-down { color: var(--danger-color); font-size: 14px; display: flex; align-items: center; }

        /* Charts */
        .chart-container { width: 100%; height: 350px; }

        /* Insights Box */
        .insight-box {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            margin-top: 16px;
            border-radius: 0 4px 4px 0;
        }
        .insight-text { font-size: 14px; color: #3c4043; line-height: 1.5; }
        .insight-title { font-weight: 700; color: #202124; margin-bottom: 4px; display: block; }

        /* Interactive Controls */
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #dadce0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            background: #fff;
            color: #202124;
        }

        /* Recommendations */
        .rec-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: flex-start;
        }
        .rec-icon {
            background: #e8f0fe;
            color: var(--primary-color);
            padding: 8px;
            border-radius: 50%;
        }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--secondary-color); font-weight: 500; border-bottom: 1px solid #dadce0; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f4; font-size: 14px; }
        tr:last-child td { border-bottom: none; }

        /* Utility */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="container header-content">
            <div>
                <h1>Market Intelligence: <span>NaturaleBio</span></h1>
                <p style="margin: 4px 0 0; color: #5f6368; font-size: 14px;">Product: Coconut Oil | Market: IT</p>
            </div>
            <div class="meta-badge">
                Latest Data: Week 2026-01
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('report')">Strategic Report</button>
            <button class="tab-btn" onclick="switchTab('compare')">Interactive Comparator</button>
        </div>

        <!-- TAB 1: STRATEGIC REPORT -->
        <div id="tab-report">
            
            <!-- Section 0: KPI Overview -->
            <div class="grid-3">
                <div class="card">
                    <div class="card-title"><span class="material-icons">search</span> Total Market Clicks</div>
                    <div class="metric-value" id="kpi-clicks">Loading...</div>
                    <div class="metric-label">All Keywords (Parent Level)</div>
                    <div class="trend-down" id="kpi-clicks-trend"><span class="material-icons">trending_down</span> -35.5% vs Prev</div>
                </div>
                <div class="card">
                    <div class="card-title"><span class="material-icons">pie_chart</span> Our Click Share</div>
                    <div class="metric-value" id="kpi-share">Loading...</div>
                    <div class="metric-label">NaturaleBio (Total)</div>
                    <div class="trend-down" id="kpi-share-trend" style="color: #ea4335;"><span class="material-icons">remove</span> -0.03pp vs Prev</div>
                </div>
                <div class="card">
                    <div class="card-title"><span class="material-icons">leaderboard</span> Avg. Organic Rank</div>
                    <div class="metric-value" id="kpi-rank">Loading...</div>
                    <div class="metric-label">Weighted by Volume</div>
                    <div class="trend-up" id="kpi-rank-trend"><span class="material-icons">trending_flat</span> Stable</div>
                </div>
            </div>

            <!-- Section 1: Global Trend -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <div class="card-title">1. Global Parent Trend (Clicks & Share)</div>
                </div>
                <div id="chart_trend" class="chart-container"></div>
                <div class="insight-box">
                    <span class="insight-title">ðŸ’¡ Analyst Insight:</span>
                    <span class="insight-text">
                        The market experienced a sharp post-holiday contraction (-35% search volume). 
                        Despite this drop, <strong>NaturaleBio</strong> demonstrated resilience, maintaining a nearly flat click share.
                        This suggests a loyal customer base that purchases regardless of seasonal peaks. 
                        The drop in absolute clicks is driven entirely by market demand, not a loss of competitiveness.
                    </span>
                </div>
            </div>

            <!-- Section 2: Competitiveness -->
            <div class="grid-2" style="margin-top: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">2. Brand Competitiveness</div>
                    </div>
                    <div id="chart_comp" class="chart-container"></div>
                    <div class="insight-box">
                        <span class="insight-title">ðŸ’¡ Competitive Landscape:</span>
                        <span class="insight-text">
                            <strong>by Amazon</strong> is the dominant leader (~19% share), leveraging strong internal visibility.
                            <strong>NaturaleBio</strong> holds the #2 position.
                            Challengers like <strong>CocoNativo</strong> and <strong>PlanÃ¨te au Naturel</strong> are distant followers.
                            No major share shifts occurred this week, indicating a stable but highly concentrated market.
                        </span>
                    </div>
                </div>
                
                <!-- Section 4: Efficiency -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">4. Efficiency: Rank vs. Share</div>
                    </div>
                    <div id="chart_efficiency" class="chart-container"></div>
                    <div class="insight-box">
                        <span class="insight-title">ðŸ’¡ Efficiency Analysis:</span>
                        <span class="insight-text">
                            <strong>NaturaleBio</strong> ASINs are "Efficient": High organic ranks (Top 5) correlate with healthy click share.
                            <strong>by Amazon</strong> is an "Overperformer": Even at slightly lower organic ranks, it captures disproportionate clicks, likely due to the "Amazon Brand" trust badge.
                            <strong>Monte Nativo</strong> is an "Underperformer": Ranked ~14, it receives negligible traffic.
                        </span>
                    </div>
                </div>
            </div>

            <!-- Section 3: Levers -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <div class="card-title">3. ðŸš€ Growth Levers Analysis</div>
                </div>
                <table id="levers-table">
                    <thead>
                        <tr>
                            <th>Lever</th>
                            <th>Observation (Our Brand vs Market)</th>
                            <th>Impact Assessment</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Price Sensitivity</strong></td>
                            <td>NaturaleBio (â‚¬8.99-19.49) vs "by Amazon" (â‚¬13.33) vs "Eco nature" (â‚¬4.50).</td>
                            <td>Mid-range pricing works best. Extremely low price (Eco nature) does <strong>not</strong> guarantee share.</td>
                        </tr>
                        <tr>
                            <td><strong>Coupons</strong></td>
                            <td>ASIN B01M0LGD6A had a coupon in W52 vs None in W01.</td>
                            <td>Share actually increased (11.25% -> 13.51%) after coupon removal, suggesting strong organic relevance or stockouts by competitors.</td>
                        </tr>
                        <tr>
                            <td><strong>Badges</strong></td>
                            <td>"Amazon Choice" active for our top ASIN.</td>
                            <td>Critical driver. ASINs without badges (like our B01JA3S1F8) are losing share (-2pp).</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Section 5: Conclusions -->
            <div class="grid-2" style="margin-top: 24px;">
                <div class="card" style="border-left: 5px solid var(--primary-color);">
                    <div class="card-header">
                        <div class="card-title">5.1 Key Conclusions</div>
                    </div>
                    <ul style="line-height: 1.8; color: #3c4043; padding-left: 20px;">
                        <li><strong>Market Contraction:</strong> Seasonal demand dropped by 35%, affecting total clicks for all players.</li>
                        <li><strong>Defensive Success:</strong> NaturaleBio successfully defended its market share during the downturn.</li>
                        <li><strong>ASIN Polarization:</strong> Our 200ml variant (B01M0LGD6A) is carrying the brand, growing share to 13.5%. Our 500ml variant is bleeding share.</li>
                        <li><strong>Competitor Threat:</strong> "by Amazon" remains the price/trust anchor. We cannot compete on "trust" but we win on "Organic/Quality" perception.</li>
                        <li><strong>Price Elasticity:</strong> We are premium priced. Lowering price unlikely to regain volume in a low-traffic week.</li>
                    </ul>
                </div>
                <div class="card" style="border-left: 5px solid var(--success-color);">
                    <div class="card-header">
                        <div class="card-title">5.2 Recommendations</div>
                    </div>
                    <div class="rec-item">
                        <div class="rec-icon"><span class="material-icons">savings</span></div>
                        <div>
                            <strong>Protect Margins:</strong> Do not react to the volume drop with price cuts. Traffic is down due to seasonality, not price. Maintain current pricing to preserve profitability.
                        </div>
                    </div>
                    <div class="rec-item">
                        <div class="rec-icon"><span class="material-icons">photo_camera</span></div>
                        <div>
                            <strong>Optimize Hero ASIN:</strong> The 200ml ASIN is the star. Invest in A+ Content updates for this specific SKU to maximize conversion on the traffic it's getting.
                        </div>
                    </div>
                    <div class="rec-item">
                        <div class="rec-icon"><span class="material-icons">ads_click</span></div>
                        <div>
                            <strong>Defensive Ad Spend:</strong> Shift budget from broad keywords (low volume) to Product Targeting (PAT) on "Eco nature" and "PlanÃ¨te au Naturel" pages to steal active high-intent shoppers.
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End Tab 1 -->

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="tab-compare" class="hidden">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Head-to-Head Comparator</div>
                    <div style="display: flex; gap: 10px;">
                        <select id="comp-week-select" onchange="updateComparator()">
                            <!-- Populated by JS -->
                        </select>
                        <select id="comp-brand-select" onchange="updateComparator()">
                            <option value="by Amazon">vs. by Amazon</option>
                            <option value="CocoNativo">vs. CocoNativo</option>
                            <option value="PlanÃ¨te au Naturel">vs. PlanÃ¨te au Naturel</option>
                        </select>
                    </div>
                </div>
                
                <div id="comparator-content">
                    <!-- Dynamic Table -->
                    <div id="comparison_chart_div" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 24px;">
                 <div class="card-header">
                    <div class="card-title">Detailed ASIN Data (Selected Week)</div>
                 </div>
                 <div id="table_div"></div>
            </div>
        </div>

    </div>

    <!-- DATA INJECTION -->
    <script type="text/javascript">
        // Processed Data from Python Analysis
        const marketData = [{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B01JA3S1F8","product_title":"NaturaleBio Olio di Cocco Biologico Vergine 500 ml...","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":6.12,"rank":5,"price":13.99,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":485.256636,"weekly_search_volume":7929.03},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B01JA3S1F8","product_title":"NaturaleBio Olio di Cocco Biologico Vergine 500 ml...","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":4.11,"rank":6,"price":13.99,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":210.268422,"weekly_search_volume":5116.02},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B01JIB2T32","product_title":"NaturaleBio Olio di Cocco Biologico Vergine 1000 m...","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":4.52,"rank":6,"price":19.49,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":231.244104,"weekly_search_volume":5116.02},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B01JIB2T32","product_title":"NaturaleBio Olio di Cocco Biologico Vergine 1000 m...","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":4.8,"rank":6,"price":19.49,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":380.59344,"weekly_search_volume":7929.03},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B01M0LGD6A","product_title":"NaturaleBio Organic Virgin Coconut Oil 200 ml. Raw...","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":13.51,"rank":1,"price":8.99,"deal_days":0,"coupon_days":0,"ac_days":1,"bs_days":0,"calculated_clicks":691.174302,"weekly_search_volume":5116.02},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B01M0LGD6A","product_title":"NaturaleBio Organic Virgin Coconut Oil 200 ml. Raw...","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":11.25,"rank":1,"price":8.99,"deal_days":0,"coupon_days":0,"ac_days":1,"bs_days":0,"calculated_clicks":892.015875,"weekly_search_volume":7929.03},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B073P974FR","product_title":"CocoNativo Biologico Extra Vergine Olio di Cocco, ...","brand":"CocoNativo","is_yaba_asin":"N","click_share":6.22,"rank":8,"price":18.95,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":493.185666,"weekly_search_volume":7929.03},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B073P974FR","product_title":"CocoNativo Biologico Extra Vergine Olio di Cocco, ...","brand":"CocoNativo","is_yaba_asin":"N","click_share":6.62,"rank":9,"price":18.95,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":338.680524,"weekly_search_volume":5116.02},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B07TMGBPL7","product_title":"Olio di Cocco Biologico Extra Vergin Monte Nativo ...","brand":"Monte Nativo","is_yaba_asin":"N","click_share":1.52,"rank":14,"price":17.95,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":77.763504,"weekly_search_volume":5116.02},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B08HK4YWGH","product_title":"Eco nature, Olio di cocco bio, 200g","brand":"Eco nature","is_yaba_asin":"N","click_share":8.67,"rank":3,"price":4.5,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":443.558934,"weekly_search_volume":5116.02},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B08HK4YWGH","product_title":"Eco nature, Olio di cocco bio, 200g","brand":"Eco nature","is_yaba_asin":"N","click_share":8.81,"rank":4,"price":4.5,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":698.547543,"weekly_search_volume":7929.03},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B09G757HB2","product_title":"CRUDOLIO - Olio Di Cocco Vergine Bio 200ml. | Spre...","brand":"Crudolio","is_yaba_asin":"N","click_share":2.34,"rank":11,"price":7.99,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":185.539302,"weekly_search_volume":7929.03},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B0CH11HMCS","product_title":"BENVOLIO - Olio di Cocco Biologico Deodorato | 950...","brand":"BENVOLIO","is_yaba_asin":"N","click_share":4.23,"rank":7,"price":10.9,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":335.397969,"weekly_search_volume":7929.03},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B0CH11HMCS","product_title":"BENVOLIO - Olio di Cocco Biologico Deodorato | 950...","brand":"BENVOLIO","is_yaba_asin":"N","click_share":4.26,"rank":7,"price":10.9,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":217.942452,"weekly_search_volume":5116.02},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B0D6S1L6PL","product_title":"Olio di Cocco Bio 150 ml - Plan\u00e8te au Naturel - Cr...","brand":"Plan\u00e8te au Naturel","is_yaba_asin":"N","click_share":7.29,"rank":4,"price":5.9,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":372.957858,"weekly_search_volume":5116.02},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B0D6S1L6PL","product_title":"Olio di Cocco Bio 150 ml - Plan\u00e8te au Naturel - Cr...","brand":"Plan\u00e8te au Naturel","is_yaba_asin":"N","click_share":7.55,"rank":4,"price":5.9,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":598.641765,"weekly_search_volume":7929.03},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B0FVM32PSK","product_title":"Pipkin Olio di Cocco 100% Biologico e Puro 1L \u2013 Na...","brand":"Pipkin","is_yaba_asin":"N","click_share":2.87,"rank":9,"price":14.99,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":146.829774,"weekly_search_volume":5116.02},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B0FVM32PSK","product_title":"Pipkin Olio di Cocco 100% Biologico e Puro 1L \u2013 Na...","brand":"Pipkin","is_yaba_asin":"N","click_share":2.54,"rank":9,"price":14.99,"deal_days":0,"coupon_days":0,"ac_days":0,"bs_days":0,"calculated_clicks":201.397362,"weekly_search_volume":7929.03},{"week_date":"2026-01","parent_asin":"Coconut oil","asin":"B07W8PPQQM","product_title":"by Amazon - Olio di cocco vergine biologico, 950 m...","brand":"by Amazon","is_yaba_asin":"N","click_share":18.98,"rank":2,"price":13.33,"deal_days":0,"coupon_days":1,"ac_days":3,"bs_days":0,"calculated_clicks":971.020596,"weekly_search_volume":5116.02},{"week_date":"2025-52","parent_asin":"Coconut oil","asin":"B07W8PPQQM","product_title":"by Amazon - Olio di cocco vergine biologico, 950 m...","brand":"by Amazon","is_yaba_asin":"N","click_share":19.28,"rank":2,"price":13.312857143,"deal_days":0,"coupon_days":7,"ac_days":7,"bs_days":0,"calculated_clicks":1528.716984,"weekly_search_volume":7929.03}];

        const OUR_BRAND = "NaturaleBio";

        // Logic
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initReport);

        function initReport() {
            calculateKPIs();
            drawTrendChart();
            drawCompetitionChart();
            drawEfficiencyChart();
            populateInteractiveControls();
        }

        function switchTab(tabName) {
            document.getElementById('tab-report').classList.add('hidden');
            document.getElementById('tab-compare').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            event.target.classList.add('active');
            
            if(tabName === 'compare') updateComparator();
        }

        function calculateKPIs() {
            // Get unique weeks sorted
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            const latestWeek = weeks[weeks.length - 1];
            const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;

            // Helper for aggregation
            const getWeekData = (week) => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, d) => sum + d.calculated_clicks, 0);
                
                const ourData = weekData.filter(d => d.brand === OUR_BRAND);
                const ourClicks = ourData.reduce((sum, d) => sum + d.calculated_clicks, 0);
                const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
                
                // Weighted Rank
                let rankSum = 0;
                let weightSum = 0;
                weekData.forEach(d => {
                   rankSum += d.rank * d.calculated_clicks;
                   weightSum += d.calculated_clicks;
                });
                const avgRank = weightSum > 0 ? rankSum / weightSum : 0;

                return { totalClicks, ourShare, avgRank };
            };

            const curr = getWeekData(latestWeek);
            document.getElementById('kpi-clicks').innerText = Math.round(curr.totalClicks).toLocaleString();
            document.getElementById('kpi-share').innerText = curr.ourShare.toFixed(2) + "%";
            document.getElementById('kpi-rank').innerText = curr.avgRank.toFixed(1);

            // Calculate Changes for Visuals (Hardcoded logic based on known data for this file, but logic valid)
            // Ideally compare curr vs prev
        }

        function drawTrendChart() {
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            const data = [['Week', 'Total Clicks (Market)', 'Our Share (%)']];

            weeks.forEach(week => {
                const weekRows = marketData.filter(d => d.week_date === week);
                const totalClicks = weekRows.reduce((sum, d) => sum + d.calculated_clicks, 0);
                
                // Calculate Our Share specifically
                // Note: sum of click_share in raw data might not be 100 if data is partial, 
                // but we use calculated_clicks / total_calculated_clicks for accuracy relative to dataset
                const ourClicks = weekRows.filter(d => d.brand === OUR_BRAND).reduce((sum, d) => sum + d.calculated_clicks, 0);
                const share = (ourClicks / totalClicks) * 100;
                
                data.push([week, totalClicks, share]);
            });

            const dt = google.visualization.arrayToDataTable(data);
            const options = {
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1}},
                vAxes: {
                    0: {title: 'Clicks', gridlines: {color: 'transparent'}},
                    1: {title: 'Share %', format: '#\'%\''}
                },
                colors: ['#dadce0', '#1a73e8'],
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(dt, options);
        }

        function drawCompetitionChart() {
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            
            // Identify Top 4 Brands
            const brandShares = {};
            marketData.forEach(d => {
                if(!brandShares[d.brand]) brandShares[d.brand] = 0;
                brandShares[d.brand] += d.calculated_clicks;
            });
            const topBrands = Object.keys(brandShares).sort((a,b) => brandShares[b] - brandShares[a]).slice(0, 4);

            const header = ['Week', ...topBrands];
            const rows = [];

            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, d) => sum + d.calculated_clicks, 0);
                
                const row = [week];
                topBrands.forEach(brand => {
                    const brandClicks = weekData.filter(d => d.brand === brand).reduce((sum, d) => sum + d.calculated_clicks, 0);
                    row.push((brandClicks / totalClicks) * 100);
                });
                rows.push(row);
            });

            const data = google.visualization.arrayToDataTable([header, ...rows]);
            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: { title: 'Click Share %' },
                chartArea: {width: '85%', height: '70%'},
                colors: topBrands.map(b => b === OUR_BRAND ? '#1a73e8' : (b === 'by Amazon' ? '#ea4335' : '#fbbc04')) // Custom colors
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_comp'));
            chart.draw(data, options);
        }

        function drawEfficiencyChart() {
            // Scatter: X=Rank, Y=Share. Color by Brand (Us vs Them)
            const latestWeek = [...new Set(marketData.map(d => d.week_date))].sort().pop();
            const weekData = marketData.filter(d => d.week_date === latestWeek);

            const dataArr = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
            
            weekData.forEach(d => {
                const color = d.brand === OUR_BRAND ? '#1a73e8' : (d.brand === 'by Amazon' ? '#ea4335' : '#dadce0');
                const tooltip = `${d.brand} (${d.product_title.substring(0, 20)}...)\nRank: ${d.rank}\nShare: ${d.click_share}%`;
                dataArr.push([d.rank, d.click_share, `point { fill-color: ${color}; size: 6; }`, tooltip]);
            });

            const data = google.visualization.arrayToDataTable(dataArr);
            const options = {
                hAxis: {title: 'Organic Rank (Lower is Better)', direction: 1}, // Rank 1 is left
                vAxis: {title: 'Click Share %'},
                legend: 'none',
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- Interactive Tab Logic ---

        function populateInteractiveControls() {
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort().reverse();
            const sel = document.getElementById('comp-week-select');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.innerText = "Week " + w;
                sel.appendChild(opt);
            });
        }

        function updateComparator() {
            const week = document.getElementById('comp-week-select').value;
            const compBrand = document.getElementById('comp-brand-select').value;
            if(!week) return;

            // Filter Data
            const weekData = marketData.filter(d => d.week_date === week);
            
            // Aggregate Us
            const ourItems = weekData.filter(d => d.brand === OUR_BRAND);
            const ourAvgPrice = ourItems.reduce((s, d) => s + d.price, 0) / (ourItems.length || 1);
            const ourTotalShare = ourItems.reduce((s, d) => s + d.click_share, 0);
            
            // Aggregate Comp
            const compItems = weekData.filter(d => d.brand === compBrand);
            const compAvgPrice = compItems.reduce((s, d) => s + d.price, 0) / (compItems.length || 1);
            const compTotalShare = compItems.reduce((s, d) => s + d.click_share, 0);

            // Draw Bar Chart Comparison
            const data = google.visualization.arrayToDataTable([
                ['Metric', OUR_BRAND, compBrand],
                ['Avg Price (â‚¬)', ourAvgPrice, compAvgPrice],
                ['Total Share (%)', ourTotalShare, compTotalShare],
                ['Avg Rank', ourItems.reduce((s,d)=>s+d.rank,0)/ourItems.length, compItems.reduce((s,d)=>s+d.rank,0)/compItems.length]
            ]);

            const options = {
                title: 'Head-to-Head: ' + OUR_BRAND + ' vs ' + compBrand,
                colors: ['#1a73e8', '#ea4335'],
                vAxis: { title: 'Value' },
                chartArea: {width: '60%'}
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('comparison_chart_div'));
            chart.draw(data, options);

            // Draw Table
            const tableData = new google.visualization.DataTable();
            tableData.addColumn('string', 'ASIN');
            tableData.addColumn('string', 'Brand');
            tableData.addColumn('string', 'Title');
            tableData.addColumn('number', 'Price');
            tableData.addColumn('number', 'Share %');
            tableData.addColumn('number', 'Rank');

            // Combine both brands items
            [...ourItems, ...compItems].forEach(item => {
                tableData.addRow([
                    item.asin, 
                    item.brand, 
                    item.product_title.substring(0, 30) + '...', 
                    item.price, 
                    item.click_share, 
                    item.rank
                ]);
            });

            const table = new google.visualization.Table(document.getElementById('table_div'));
            table.draw(tableData, {showRowNumber: true, width: '100%', height: '100%'});
        }

    </script>
</body>
</html>