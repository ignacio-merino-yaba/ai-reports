<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence Report</title>
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC04; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --gray: #5f6368;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: #202124;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout & Typography */
        h1, h2, h3 { margin: 0; font-weight: 600; }
        h1 { font-size: 24px; color: #202124; margin-bottom: 24px; }
        h2 { font-size: 18px; color: #202124; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .subtitle { font-size: 14px; color: var(--gray); margin-bottom: 32px; }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            margin-bottom: 24px;
            transition: box-shadow 0.2s;
        }
        .card:hover { box-shadow: 0 4px 8px 3px rgba(60,64,67,0.15); }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }

        /* KPI Badges */
        .kpi-box {
            padding: 16px;
            background: #F8F9FA;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }
        .kpi-value { font-size: 24px; font-weight: 700; color: #202124; }
        .kpi-label { font-size: 12px; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-up { color: var(--success); font-size: 12px; font-weight: 500; }
        .trend-down { color: var(--danger); font-size: 12px; font-weight: 500; }

        /* Tabs */
        .tabs { display: flex; gap: 16px; margin-bottom: 24px; border-bottom: 1px solid #e0e0e0; }
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray);
            transition: all 0.2s;
        }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Charts Container */
        .chart-container { width: 100%; height: 350px; }

        /* Insight Box */
        .insight-list { list-style: none; padding: 0; }
        .insight-item { 
            padding: 12px; 
            border-bottom: 1px solid #f1f3f4; 
            display: flex; 
            gap: 12px; 
            align-items: start;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); }
        
        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #f1f3f4;
            padding: 16px;
            border-radius: 12px;
        }
        select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-family: inherit;
            font-size: 14px;
        }

        /* Utilities */
        .text-blue { color: var(--primary); }
        .text-red { color: var(--danger); }
        .text-green { color: var(--success); }
        .chip {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
        }
        .chip-yaba { background: #e8f0fe; color: var(--primary); }
        .chip-comp { background: #fce8e6; color: var(--danger); }

        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Amazon Parent ASIN Analysis: <span class="text-blue">Matcha Premium</span></h1>
        <p class="subtitle">Reporting Period: Last 4 Weeks (Ending 2026-01-03)</p>
    </header>

    <!-- Tabs Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="static" class="tab-content active">
        
        <!-- SECTION 1: GLOBAL TREND -->
        <div class="card">
            <h2><span class="material-icons">trending_up</span> 1. Tendencia Global del Parent</h2>
            <div class="grid-4" id="kpi-container">
                <!-- KPIs injected via JS -->
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <p class="subtitle" style="margin-top:10px; font-size: 12px;">*Las barras representan volumen de clics estimado. La línea representa el Click Share total.</p>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="card">
            <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Share of Voice)</h2>
            <div class="grid-2">
                <div>
                    <div id="chart_brand_comp" class="chart-container"></div>
                </div>
                <div>
                    <h3>Dominio Semanal</h3>
                    <div id="brand_table_div"></div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: LEVERS -->
        <div class="card">
            <h2><span class="material-icons">tune</span> 3. Palancas de Crecimiento (Drivers)</h2>
            <div class="grid-2">
                <div id="chart_price_impact" class="chart-container"></div>
                <div>
                    <h3>Análisis de Impacto</h3>
                    <ul class="insight-list" id="levers_insights">
                        <!-- Insights injected JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- SECTION 4: EFFICIENCY -->
        <div class="card">
            <h2><span class="material-icons">scatter_plot</span> 4. Eficiencia (Organic Rank vs Click Share)</h2>
            <p style="font-size: 13px; color: #666;">Cuadrante Superior Izquierdo = Alta Eficiencia (Buen Share con peor Rank). Cuadrante Inferior Derecho = Baja Eficiencia.</p>
            <div id="chart_efficiency" class="chart-container"></div>
        </div>

        <!-- SECTION 5: CONCLUSIONS -->
        <div class="card" style="border-left: 6px solid var(--primary);">
            <h2><span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones</h2>
            <div class="grid-2">
                <div>
                    <h3 class="text-blue">Insights Clave</h3>
                    <ul class="insight-list" id="final_insights"></ul>
                </div>
                <div>
                    <h3 class="text-green">Acciones Recomendadas</h3>
                    <ul class="insight-list" id="final_recommendations"></ul>
                </div>
            </div>
        </div>

        <!-- SECTION 6: OTHER INSIGHTS -->
        <div class="card">
            <h2><span class="material-icons">insights</span> 6. Otros Hallazgos</h2>
            <ul class="insight-list" id="other_insights"></ul>
        </div>
    </div>

    <!-- PESTAÑA 2: INTERACTIVO -->
    <div id="interactive" class="tab-content">
        <div class="card">
            <h2><span class="material-icons">compare_arrows</span> Comparador Cara a Cara</h2>
            <div class="controls">
                <div>
                    <label>Semana:</label>
                    <select id="weekSelector" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label>Competidor VS Nosotros:</label>
                    <select id="compSelector" onchange="updateInteractive()"></select>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="kpi-box">
                    <div class="kpi-label">Diferencial de Precio</div>
                    <div class="kpi-value" id="price_diff">--</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">Gap de Click Share</div>
                    <div class="kpi-value" id="share_gap">--</div>
                </div>
            </div>

            <div id="table_interactive_div" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // --- 1. DATA INJECTION (PROCESSED FROM CSV) ---
        const marketData = [{"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "Jean", "asin": "B0F5BVFRC1", "product_title": "Jean & Len Handcreme I Love You So Matcha, f\u00fcr nor...", "country_code": "de", "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.92, "impression_share": 2.66, "price": 3.095714286, "click_share_rank": 10, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1168.4179199999999}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.48, "impression_share": 4.53, "price": 10.44, "click_share_rank": 7, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 2117.75748}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.48, "impression_share": 4.53, "price": 10.44, "click_share_rank": 7, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 2117.75748}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "Ceremonial", "asin": "B0G1T7N675", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "country_code": "de", "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.56, "impression_share": 3.71, "price": 8.898571429, "click_share_rank": 9, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1557.89056}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "\"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 8.0, "weekly_number_of_days_with_deal": 5.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.49, "impression_share": 4.25, "price": 9.005714286, "click_share_rank": 6, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 2123.84299}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "Ceremonial", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.85, "impression_share": 4.22, "price": 15.635714286, "click_share_rank": 3, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 5385.67635}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.85, "impression_share": 4.22, "price": 15.635714286, "click_share_rank": 3, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 5385.67635}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.85, "impression_share": 3.15, "price": 9.2, "click_share_rank": 4, "weekly_search_volume": 60855.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 2342.92135}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.69, "impression_share": 3.13, "price": 23.075714286, "click_share_rank": 5, "weekly_search_volume": 60855.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 2245.5531899999998}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 16.66, "impression_share": 3.14, "price": 24.03, "click_share_rank": 1, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 10138.45966}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 11.18, "impression_share": 3.15, "price": 14.084285714, "click_share_rank": 2, "weekly_search_volume": 60855.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 6803.599999999999}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-51", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 22.0, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.95, "impression_share": 2.57, "price": 26.748571429, "click_share_rank": 8, "weekly_search_volume": 60855.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1795.22545}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 23.0, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.93, "impression_share": 2.43, "price": 30.704285714, "click_share_rank": 8, "weekly_search_volume": 47708.06, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1397.846158}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07K1WBH4K", "product_title": "\"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "country_code": "de", "average_organic_rank": 20.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.47, "impression_share": 2.29, "price": 9.895714286, "click_share_rank": 10, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 701.308482}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.4, "impression_share": 4.7, "price": 10.71, "click_share_rank": 7, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1622.07404}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Matcha", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.4, "impression_share": 4.7, "price": 10.71, "click_share_rank": 7, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1622.07404}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "\"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.44, "impression_share": 3.4, "price": 12.367142857, "click_share_rank": 9, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1164.076664}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Bio", "asin": "B08XVX8V1T", "product_title": "\"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.44, "impression_share": 3.4, "price": 12.367142857, "click_share_rank": 9, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1164.076664}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "\"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.19, "impression_share": 5.29, "price": 9.895714286, "click_share_rank": 4, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1998.9677139999999}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.42, "impression_share": 4.24, "price": 16.037142857, "click_share_rank": 3, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 4017.018652}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Ceremonial", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.42, "impression_share": 4.24, "price": 16.037142857, "click_share_rank": 3, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 4017.018652}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.49, "impression_share": 3.36, "price": 24.855714286, "click_share_rank": 6, "weekly_search_volume": 47708.06, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1665.011294}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.75, "impression_share": 3.25, "price": 10.538571429, "click_share_rank": 5, "weekly_search_volume": 47708.06, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1789.05225}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 18.77, "impression_share": 3.35, "price": 24.648571429, "click_share_rank": 1, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 8954.802862}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 11.66, "impression_share": 3.37, "price": 15.058571429, "click_share_rank": 2, "weekly_search_volume": 47708.06, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 5562.7597959999995}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 0.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.68, "impression_share": 2.06, "price": 30.27, "click_share_rank": 8, "weekly_search_volume": 27011.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 723.89748}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "UNREAL\u00ae", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "country_code": "de", "average_organic_rank": 19.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.57, "impression_share": 1.96, "price": 31.2725, "click_share_rank": 10, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 424.07427}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 16.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "click_share": 3.0, "impression_share": 4.47, "price": 10.39, "click_share_rank": 7, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 810.333}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Matcha", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 16.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "click_share": 3.0, "impression_share": 4.47, "price": 10.39, "click_share_rank": 7, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 810.333}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "\"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.39, "impression_share": 3.91, "price": 11.9975, "click_share_rank": 9, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 645.56529}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Bio", "asin": "B08XVX8V1T", "product_title": "\"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.39, "impression_share": 3.91, "price": 11.9975, "click_share_rank": 9, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 645.56529}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "\"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.15, "impression_share": 5.19, "price": 10.43, "click_share_rank": 6, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 850.84965}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Ceremonial", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 7.38, "impression_share": 4.54, "price": 15.5575, "click_share_rank": 3, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1993.41918}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 7.38, "impression_share": 4.54, "price": 15.5575, "click_share_rank": 3, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 1993.41918}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.66, "impression_share": 3.36, "price": 24.5275, "click_share_rank": 4, "weekly_search_volume": 27011.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 988.60626}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.35, "impression_share": 3.02, "price": 10.2225, "click_share_rank": 5, "weekly_search_volume": 27011.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 904.87185}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 19.34, "impression_share": 3.36, "price": 23.91, "click_share_rank": 1, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 5223.94674}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 12.9, "impression_share": 3.37, "price": 14.6075, "click_share_rank": 2, "weekly_search_volume": 27011.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha", "estimated_clicks": 3484.4319}];

        // --- 2. LOGIC & INITIALIZATION ---
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        let ourBrandName = "";
        let weeks = [];
        let brands = [];

        function initDashboard() {
            processData();
            drawCharts();
            generateInsights();
            setupInteractive();
        }

        function processData() {
            // Identify Our Brand
            const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
            ourBrandName = ourAsinRow ? ourAsinRow.competitor_brand : "Our Brand";

            // Get unique weeks and sort
            weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            
            // Get top brands
            const brandShares = {};
            marketData.forEach(d => {
                if (!brandShares[d.competitor_brand]) brandShares[d.competitor_brand] = 0;
                brandShares[d.competitor_brand] += d.click_share;
            });
            brands = Object.keys(brandShares).sort((a,b) => brandShares[b] - brandShares[a]);
        }

        // --- 3. CHART DRAWING ---

        function drawCharts() {
            drawTrendChart();
            drawBrandCompChart();
            drawPriceImpactChart();
            drawEfficiencyChart();
        }

        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', 'Our Clicks');
            data.addColumn('number', 'Comp Clicks');
            data.addColumn('number', 'Our Share %');

            const aggData = {};
            marketData.forEach(d => {
                if (!aggData[d.week_date]) aggData[d.week_date] = { us_clicks:0, them_clicks:0, us_share:0, total_share:0 };
                if (d.is_yaba_asin === 'Y') {
                    aggData[d.week_date].us_clicks += d.estimated_clicks;
                    aggData[d.week_date].us_share += d.click_share;
                } else {
                    aggData[d.week_date].them_clicks += d.estimated_clicks;
                }
                aggData[d.week_date].total_share += d.click_share;
            });

            weeks.forEach(w => {
                const day = aggData[w];
                // Normalize share to 100% relative within dataset if needed, but using raw sum here
                data.addRow([w, Math.round(day.us_clicks), Math.round(day.them_clicks), day.us_share]);
            });

            const options = {
                title: 'Tendencia: Volumen de Clics vs Cuota (NaturaleBio)',
                seriesType: 'bars',
                series: { 2: { type: 'line', targetAxisIndex: 1 } },
                vAxes: { 0: {title: 'Clics Est.'}, 1: {title: 'Click Share %', format: '#\'%\''} },
                colors: ['#4285F4', '#dadce0', '#34A853'],
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        function drawBrandCompChart() {
            // Filter Top 3 Competitors + Us
            const topComps = brands.filter(b => b !== ourBrandName).slice(0, 3);
            const trackedBrands = [ourBrandName, ...topComps, "Resto"];

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            trackedBrands.forEach(b => data.addColumn('number', b));

            weeks.forEach(w => {
                const row = [w];
                trackedBrands.forEach(b => {
                    let share = 0;
                    if (b === "Resto") {
                        marketData.filter(d => d.week_date === w && !trackedBrands.includes(d.competitor_brand) && d.competitor_brand !== b)
                                  .forEach(d => share += d.click_share);
                    } else {
                        marketData.filter(d => d.week_date === w && d.competitor_brand === b)
                                  .forEach(d => share += d.click_share);
                    }
                    row.push(share);
                });
                data.addRow(row);
            });

            const options = {
                title: 'Evolución de Click Share: Top Marcas',
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC04', '#34A853', '#9AA0A6'],
                chartArea: { width: '90%', height: '70%' },
                vAxis: { format: '#\'%\'' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(data, options);

            // Table Data
            const tableData = new google.visualization.DataTable();
            tableData.addColumn('string', 'Marca');
            tableData.addColumn('number', 'Share Promedio');
            trackedBrands.forEach(b => {
                // Calc avg
                let total = 0;
                let count = 0;
                weeks.forEach(w => {
                    marketData.filter(d => d.week_date === w && d.competitor_brand === b).forEach(d => total += d.click_share);
                    count++;
                });
                tableData.addRow([b, parseFloat((total/weeks.length).toFixed(2))]);
            });
            const table = new google.visualization.Table(document.getElementById('brand_table_div'));
            table.draw(tableData, {width: '100%', height: '100%'});
        }

        function drawPriceImpactChart() {
            // Price vs Share for Us vs Top Competitor (aggregated)
            const topComp = brands.find(b => b !== ourBrandName);
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', 'Precio ' + ourBrandName);
            data.addColumn('number', 'Share ' + ourBrandName);

            weeks.forEach(w => {
                const usData = marketData.filter(d => d.week_date === w && d.is_yaba_asin === 'Y');
                if(usData.length) {
                    const avgPrice = usData.reduce((a,b)=>a+b.price,0)/usData.length;
                    const totalShare = usData.reduce((a,b)=>a+b.click_share,0);
                    data.addRow([w, avgPrice, totalShare]);
                }
            });

            const options = {
                title: `Elasticidad Precio: ${ourBrandName}`,
                series: { 
                    0: {type: 'line', color: '#4285F4', labelInLegend: 'Precio (€)'},
                    1: {type: 'bars', color: '#aecbfa', targetAxisIndex: 1, labelInLegend: 'Share (%)'}
                },
                vAxes: { 
                    0: {title: 'Precio (€)'}, 
                    1: {title: 'Share (%)'} 
                },
                legend: { position: 'bottom' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_price_impact'));
            chart.draw(data, options);
        }

        function drawEfficiencyChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank');
            data.addColumn('number', 'Click Share');
            data.addColumn({type: 'string', role: 'style'});
            data.addColumn({type: 'string', role: 'tooltip'});

            const lastWeek = weeks[weeks.length-1];
            const currentData = marketData.filter(d => d.week_date === lastWeek);

            currentData.forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#EA4335';
                const tooltip = `${d.competitor_brand} (${d.asin})\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
                // Invert rank axis visually (1 is top)
                data.addRow([d.average_organic_rank, d.click_share, `point { fill-color: ${color}; }`, tooltip]);
            });

            const options = {
                title: `Mapa de Eficiencia (Semana: ${lastWeek})`,
                hAxis: { title: 'Organic Rank (Menor es mejor)', direction: -1 }, // Inverted for Rank 1 at right
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- 4. INSIGHTS GENERATION ---
        function generateInsights() {
            const lastWeek = weeks[weeks.length-1];
            const prevWeek = weeks[weeks.length-2];
            
            // Calc Metrics
            const usDataCurrent = marketData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y');
            const usDataPrev = marketData.filter(d => d.week_date === prevWeek && d.is_yaba_asin === 'Y');
            
            const currentShare = usDataCurrent.reduce((a,b)=>a+b.click_share,0);
            const prevShare = usDataPrev.reduce((a,b)=>a+b.click_share,0);
            const diffShare = (currentShare - prevShare).toFixed(1);

            // KPIs
            const kpiHTML = `
                <div class="kpi-box">
                    <div class="kpi-label">Click Share Total</div>
                    <div class="kpi-value">${currentShare.toFixed(1)}%</div>
                    <div class="${diffShare >= 0 ? 'trend-up' : 'trend-down'}">
                        ${diffShare >= 0 ? '▲' : '▼'} ${Math.abs(diffShare)}pp vs prev
                    </div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">Rank Promedio</div>
                    <div class="kpi-value">${(usDataCurrent.reduce((a,b)=>a+b.average_organic_rank,0)/usDataCurrent.length).toFixed(1)}</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">Active ASINs</div>
                    <div class="kpi-value">${usDataCurrent.length}</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">Market Share Rank</div>
                    <div class="kpi-value">#${brands.indexOf(ourBrandName)+1}</div>
                </div>
            `;
            document.getElementById('kpi-container').innerHTML = kpiHTML;

            // Levers Insights
            const leverList = document.getElementById('levers_insights');
            let leverHtml = "";
            const usDeals = usDataCurrent.some(d => d.weekly_number_of_days_with_deal > 0);
            const usCoupons = usDataCurrent.some(d => d.weekly_number_of_days_with_coupon > 0);
            
            if(usDeals) leverHtml += `<li class="insight-item"><span class="insight-icon material-icons">local_offer</span> <strong>Deals Activos:</strong> Detectamos actividad promocional esta semana.</li>`;
            else leverHtml += `<li class="insight-item"><span class="insight-icon material-icons">money_off</span> <strong>Sin Deals:</strong> No hubo deals activos para nuestra marca. Oportunidad de activación.</li>`;
            
            // Check Price Competitiveness
            const marketAvgPrice = marketData.filter(d => d.week_date === lastWeek).reduce((a,b)=>a+b.price,0) / marketData.filter(d => d.week_date === lastWeek).length;
            const ourAvgPrice = usDataCurrent.reduce((a,b)=>a+b.price,0)/usDataCurrent.length;
            
            if(ourAvgPrice > marketAvgPrice) leverHtml += `<li class="insight-item"><span class="insight-icon material-icons">trending_up</span> <strong>Precio Premium:</strong> Estamos un ${((ourAvgPrice/marketAvgPrice -1)*100).toFixed(0)}% por encima del promedio del mercado.</li>`;
            else leverHtml += `<li class="insight-item"><span class="insight-icon material-icons">trending_down</span> <strong>Precio Competitivo:</strong> Estamos posicionados por debajo del precio medio.</li>`;
            
            leverList.innerHTML = leverHtml;

            // Final Conclusions
            const conclusions = document.getElementById('final_insights');
            let conclHtml = "";
            conclHtml += `<li class="insight-item"><strong>Tendencia:</strong> La marca ${diffShare >= 0 ? 'ganó' : 'perdió'} ${Math.abs(diffShare)} puntos de share esta semana.</li>`;
            conclHtml += `<li class="insight-item"><strong>Liderazgo:</strong> El competidor dominante es ${brands[0] === ourBrandName ? 'Nosotros' : brands[0]} con mayor share acumulado.</li>`;
            conclHtml += `<li class="insight-item"><strong>Eficiencia:</strong> Nuestros ASINs promedian rank ${(usDataCurrent.reduce((a,b)=>a+b.average_organic_rank,0)/usDataCurrent.length).toFixed(1)}.</li>`;
            conclusions.innerHTML = conclHtml;

            // Recommendations
            const recs = document.getElementById('final_recommendations');
            let recHtml = "";
            if(diffShare < 0) recHtml += `<li class="insight-item">🛑 <strong>Alerta de Share:</strong> Revisar agresividad de precios o pujas de PPC, hemos perdido visibilidad.</li>`;
            if(!usDeals && !usCoupons) recHtml += `<li class="insight-item">🎟️ <strong>Activar Promociones:</strong> No tenemos distintivos de descuento activos. Considerar cupones para mejorar CTR.</li>`;
            recHtml += `<li class="insight-item">🔍 <strong>Defensa de Rank:</strong> Enfocarse en las keywords donde perdimos el Top 5 orgánico.</li>`;
            recs.innerHTML = recHtml;
        }

        // --- 5. INTERACTIVE TAB ---
        function setupInteractive() {
            // Populate selectors
            const weekSel = document.getElementById('weekSelector');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.appendChild(opt);
            });
            weekSel.value = weeks[weeks.length-1];

            const compSel = document.getElementById('compSelector');
            brands.filter(b => b !== ourBrandName).forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                compSel.appendChild(opt);
            });

            updateInteractive();
        }

        function updateInteractive() {
            const week = document.getElementById('weekSelector').value;
            const comp = document.getElementById('compSelector').value;

            // Get Data
            const usData = marketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
            const compData = marketData.filter(d => d.week_date === week && d.competitor_brand === comp);

            // Calculate Metrics
            const usPrice = usData.length ? usData.reduce((a,b)=>a+b.price,0)/usData.length : 0;
            const compPrice = compData.length ? compData.reduce((a,b)=>a+b.price,0)/compData.length : 0;
            const usShare = usData.reduce((a,b)=>a+b.click_share,0);
            const compShare = compData.reduce((a,b)=>a+b.click_share,0);

            // Update UI
            document.getElementById('price_diff').innerText = (usPrice - compPrice).toFixed(2) + ' €';
            document.getElementById('price_diff').style.color = usPrice > compPrice ? '#EA4335' : '#34A853';
            
            document.getElementById('share_gap').innerText = (usShare - compShare).toFixed(1) + '%';

            // Draw Comparison Table
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Métrica');
            data.addColumn('number', ourBrandName);
            data.addColumn('number', comp);

            data.addRow(['Precio Promedio', parseFloat(usPrice.toFixed(2)), parseFloat(compPrice.toFixed(2))]);
            data.addRow(['Click Share %', usShare, compShare]);
            data.addRow(['Avg Rank', usData.reduce((a,b)=>a+b.average_organic_rank,0)/usData.length || 0, compData.reduce((a,b)=>a+b.average_organic_rank,0)/compData.length || 0]);
            
            const table = new google.visualization.Table(document.getElementById('table_interactive_div'));
            table.draw(data, {width: '100%', height: '200px'});
        }

        // Utilities
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(d => d.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

    </script>
</body>
</html>