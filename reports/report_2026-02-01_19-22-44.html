<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* Google Native / Apple-like Hybrid Style */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-secondary: #5F6368;
            --border-radius: 16px;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Headers & Typography */
        h1, h2, h3 {
            font-weight: 500;
            margin-bottom: 0.5em;
        }
        h1 { font-size: 24px; color: var(--text-main); }
        h2 { font-size: 20px; color: var(--text-main); margin-top: 30px; }
        .subtitle { font-size: 14px; color: var(--text-secondary); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #fff;
            padding: 5px;
            border-radius: 12px;
            width: fit-content;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-btn {
            border: none;
            background: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            transition: transform 0.2s;
        }
        .card:hover {
            box-shadow: 0 4px 8px rgba(60,64,67,0.3);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric-item {
            display: flex;
            flex-direction: column;
        }
        .metric-val {
            font-size: 28px;
            font-weight: 600;
            color: var(--primary-color);
        }
        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
        }
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: flex-start;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .insight-icon {
            color: var(--primary-color);
            margin-top: 2px;
        }
        .recommendation-item {
            background: #e8f0fe;
            border-left: 4px solid var(--primary-color);
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            min-width: 200px;
            outline: none;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .text-green { color: var(--success-color); }
        .text-red { color: var(--danger-color); }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        .badge-deal { background: var(--danger-color); }
        .badge-choice { background: var(--text-main); }
        
        table.comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .comparison-table th, .comparison-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .comparison-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>Reporte de Rendimiento: Parent ASIN</h1>
            <p class="subtitle">An√°lisis profundo de mercado, competencia y eficiencia.</p>
        </header>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Dashboard Anal√≠tico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="static-tab">
            
            <!-- Section 1: Global Trend -->
            <div class="card">
                <h2>1. Tendencia Global del Parent</h2>
                <div class="metrics-grid" id="global-metrics">
                    <!-- Metrics injected by JS -->
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
                <div class="insight-list" id="trend_insights"></div>
            </div>

            <!-- Section 2: Brand Competitiveness -->
            <div class="card">
                <h2>2. Competitividad de Marca</h2>
                <p class="subtitle">Evoluci√≥n del Click Share: Nuestra Marca vs Top 3 Competidores</p>
                <div id="chart_brand_share" class="chart-container"></div>
                <div class="insight-list" id="competitiveness_insights"></div>
            </div>

            <!-- Section 3: Levers -->
            <div class="card">
                <h2>3. üöÄ Palancas de Crecimiento</h2>
                <p class="subtitle">Impacto de Precio, Deals y Badges en la cuota de mercado.</p>
                <div class="metrics-grid" id="levers-metrics"></div>
                <div id="chart_levers" class="chart-container" style="height: 300px;"></div>
            </div>

            <!-- Section 4: Efficiency -->
            <div class="card">
                <h2>4. üëÅÔ∏è Eficiencia: Organic Rank vs Click Share</h2>
                <p class="subtitle">¬øQui√©n consigue m√°s clics con peor posici√≥n?</p>
                <div id="chart_efficiency" class="chart-container"></div>
                <div class="insight-list" id="efficiency_insights"></div>
            </div>

            <!-- Section 5: Conclusions -->
            <div class="card" style="border-left: 5px solid var(--success-color);">
                <h2>5. üí° Conclusiones y Plan de Acci√≥n</h2>
                <div class="insight-list" id="final_recommendations"></div>
            </div>
            
            <!-- Section 6: Other Insights -->
            <div class="card">
                <h2>6. Insights Adicionales</h2>
                <div class="insight-list" id="other_insights"></div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="interactive-tab" class="hidden">
            <div class="card">
                <h2>Cara a Cara: An√°lisis Competitivo</h2>
                <div class="controls">
                    <select id="comp-week-select" onchange="updateInteractive()">
                        <!-- Options filled by JS -->
                    </select>
                    <select id="comp-competitor-select" onchange="updateInteractive()">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                
                <div class="metrics-grid" id="interactive-metrics">
                    <!-- Dynamic metrics -->
                </div>

                <div id="chart_interactive_comparison" class="chart-container"></div>

                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>M√©trica</th>
                            <th>Nuestra Marca</th>
                            <th id="comp-table-header">Competidor</th>
                            <th>Delta</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-table-body">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- DATA & LOGIC -->
    <script>
        // --- 1. DATA INJECTION ---
        // Synthetic Data generated to match the structure requested
        const rawData = [{"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2024-12-28", "week_date": "2024-12-28", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B0068471", "product_title": "SoundCore Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1611, "impression_share": 0.1772, "price": 57.19, "click_share_rank": 15, "weekly_search_volume": 11624, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2024-12-28", "week_date": "2024-12-28", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B0058864", "product_title": "Sony Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2588, "impression_share": 0.2847, "price": 89.28, "click_share_rank": 8, "weekly_search_volume": 11624, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2024-12-28", "week_date": "2024-12-28", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B0072046", "product_title": "JBL Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 19, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1084, "impression_share": 0.1192, "price": 49.37, "click_share_rank": 18, "weekly_search_volume": 11624, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2024-12-28", "week_date": "2024-12-28", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B0027734", "product_title": "Bose Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0401, "impression_share": 0.0441, "price": 125.76, "click_share_rank": 11, "weekly_search_volume": 11624, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2024-12-28", "week_date": "2024-12-28", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B0053702", "product_title": "Generic Budget Headphone Black", "country_code": "US", "average_organic_rank": 25, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0535, "impression_share": 0.0588, "price": 31.25, "click_share_rank": 16, "weekly_search_volume": 11624, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-04", "week_date": "2025-01-04", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B0091392", "product_title": "SoundCore Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1873, "impression_share": 0.206, "price": 60.19, "click_share_rank": 10, "weekly_search_volume": 12051, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-04", "week_date": "2025-01-04", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B0053966", "product_title": "Sony Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2464, "impression_share": 0.2711, "price": 89.26, "click_share_rank": 4, "weekly_search_volume": 12051, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-11", "week_date": "2025-01-11", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B0017409", "product_title": "SoundCore Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1706, "impression_share": 0.1876, "price": 60.13, "click_share_rank": 14, "weekly_search_volume": 12216, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-11", "week_date": "2025-01-11", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B0086208", "product_title": "Sony Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.3065, "impression_share": 0.3371, "price": 87.05, "click_share_rank": 3, "weekly_search_volume": 12216, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-18", "week_date": "2025-01-18", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B0058284", "product_title": "SoundCore Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 16, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1415, "impression_share": 0.1557, "price": 57.06, "click_share_rank": 17, "weekly_search_volume": 11529, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-25", "week_date": "2025-01-25", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B0076214", "product_title": "SoundCore Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 7, "click_share": 0.1804, "impression_share": 0.1985, "price": 57.43, "click_share_rank": 18, "weekly_search_volume": 10091, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-25", "week_date": "2025-01-25", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B0014023", "product_title": "Sony Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2592, "impression_share": 0.2851, "price": 93.68, "click_share_rank": 20, "weekly_search_volume": 10091, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-25", "week_date": "2025-01-25", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B0086392", "product_title": "JBL Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 19, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1082, "impression_share": 0.119, "price": 52.12, "click_share_rank": 15, "weekly_search_volume": 10091, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-25", "week_date": "2025-01-25", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B0068471", "product_title": "Bose Wireless Headphone Premium", "country_code": "US", "average_organic_rank": 24, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0573, "impression_share": 0.063, "price": 128.52, "click_share_rank": 5, "weekly_search_volume": 10091, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}, {"brand_aggregation": "Headphones", "parent_asin": "PARENT123", "reporting_date": "2025-01-25", "week_date": "2025-01-25", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B0091816", "product_title": "Generic Budget Headphone Black", "country_code": "US", "average_organic_rank": 23, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0631, "impression_share": 0.0694, "price": 30.64, "click_share_rank": 11, "weekly_search_volume": 10091, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones"}];

        // --- 2. DATA PROCESSING ---
        let processedData = [];
        let ourBrandName = "";
        let weeks = [];
        let allBrands = new Set();

        function initData() {
            // 1. Identify Our Brand & Clean Brands
            rawData.forEach(row => {
                let brand = row.competitor_brand;
                if (!brand) {
                    // Extraction logic
                    if (row.product_title) {
                        brand = row.product_title.split(' ')[0]; // Simple heuristic
                    } else {
                        brand = "Unknown Brand";
                    }
                }
                
                if (row.is_yaba_asin === 'Y') {
                    ourBrandName = brand;
                }
                
                row.real_brand = brand;
                allBrands.add(brand);
            });
            
            if(!ourBrandName) ourBrandName = "Our Brand (Not Found)";

            // 2. Aggregate by Week & Brand
            // We need to sum clicks (volume * share) and avg rank/price weighted
            const grouped = {};
            
            rawData.forEach(row => {
                const key = `${row.week_date}_${row.real_brand}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        week: row.week_date,
                        brand: row.real_brand,
                        is_us: row.real_brand === ourBrandName,
                        total_volume: 0,
                        est_clicks: 0,
                        sum_rank_vol: 0,
                        sum_price_vol: 0,
                        deal_days: 0,
                        bs_days: 0,
                        ac_days: 0,
                        count: 0
                    };
                }
                
                const vol = row.weekly_search_volume || 0;
                grouped[key].total_volume += vol;
                grouped[key].est_clicks += (row.click_share * vol);
                grouped[key].sum_rank_vol += (row.average_organic_rank * vol);
                grouped[key].sum_price_vol += (row.price * vol);
                grouped[key].deal_days = Math.max(grouped[key].deal_days, row.weekly_number_of_days_with_deal); // Max for now
                grouped[key].bs_days = Math.max(grouped[key].bs_days, row.weekly_number_of_days_with_best_seller_badge);
                grouped[key].ac_days = Math.max(grouped[key].ac_days, row.weekly_number_of_days_with_amazon_choice_badge);
                grouped[key].count++;
            });

            // Flatten and calculate averages
            processedData = Object.values(grouped).map(g => {
                const total_mkt_vol = 100000; // Proxy for total market volume to calc share
                return {
                    week: g.week,
                    brand: g.brand,
                    is_us: g.is_us,
                    clicks: Math.round(g.est_clicks),
                    avg_rank: g.total_volume ? (g.sum_rank_vol / g.total_volume) : 0,
                    avg_price: g.total_volume ? (g.sum_price_vol / g.total_volume) : 0,
                    deal_active: g.deal_days > 0,
                    badges_active: (g.bs_days > 0 || g.ac_days > 0)
                };
            }).sort((a,b) => a.week.localeCompare(b.week));

            weeks = [...new Set(processedData.map(d => d.week))].sort();
        }

        // --- 3. GOOGLE CHARTS SETUP ---
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawDashboard);

        function drawDashboard() {
            initData();
            drawTrendChart();
            drawBrandCompetitiveness();
            drawLevers(); // Simulating logic for chart
            drawEfficiency();
            generateInsights();
            populateInteractiveControls();
        }

        // --- CHART 1: GLOBAL TREND ---
        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Clicks Mercado');
            data.addColumn('number', 'Nuestros Clicks');
            data.addColumn('number', 'Cuota (%)');

            // Aggregate by week for the whole parent vs market
            const weeklyStats = weeks.map(w => {
                const weekData = processedData.filter(d => d.week === w);
                const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
                const ourClicks = weekData.filter(d => d.is_us).reduce((sum, d) => sum + d.clicks, 0);
                const share = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
                return [w, totalClicks, ourClicks, share];
            });

            data.addRows(weeklyStats);

            const options = {
                title: 'Volumen de Clicks y Evoluci√≥n de Cuota',
                seriesType: 'bars',
                series: {
                    2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}
                },
                vAxes: {
                    0: {title: 'Volumen Clicks'},
                    1: {title: 'Cuota (%)', format: '#\'%\''}
                },
                colors: ['#E0E0E0', '#34A853'],
                legend: {position: 'bottom'},
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
            
            // Metrics
            const lastWeek = weeklyStats[weeklyStats.length-1];
            const prevWeek = weeklyStats[weeklyStats.length-2] || lastWeek;
            
            const trendHtml = `
                <div class="metric-item">
                    <span class="metric-val">${lastWeek[1].toLocaleString()}</span>
                    <span class="metric-label">Total Clicks (Semana)</span>
                </div>
                <div class="metric-item">
                    <span class="metric-val" style="color:${lastWeek[3] >= prevWeek[3] ? '#34A853' : '#EA4335'}">
                        ${lastWeek[3].toFixed(1)}%
                    </span>
                    <span class="metric-label">Nuestra Cuota</span>
                </div>
                <div class="metric-item">
                    <span class="metric-val">
                        ${((lastWeek[1] - prevWeek[1])/prevWeek[1] * 100).toFixed(1)}%
                    </span>
                    <span class="metric-label">Tendencia WoW</span>
                </div>
            `;
            document.getElementById('global-metrics').innerHTML = trendHtml;
        }

        // --- CHART 2: BRAND COMPETITIVENESS ---
        function drawBrandCompetitiveness() {
            // Top 3 + Us
            // Calculate total clicks per brand to find Top 3
            const brandTotals = {};
            processedData.forEach(d => {
                brandTotals[d.brand] = (brandTotals[d.brand] || 0) + d.clicks;
            });
            
            const sortedBrands = Object.entries(brandTotals)
                .sort((a,b) => b[1] - a[1])
                .map(e => e[0]);
                
            const topCompetitors = sortedBrands.filter(b => b !== ourBrandName).slice(0, 3);
            const brandsToPlot = [ourBrandName, ...topCompetitors];

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            brandsToPlot.forEach(b => data.addColumn('number', b));

            const rows = weeks.map(w => {
                const row = [w];
                const weekTotal = processedData.filter(d => d.week === w).reduce((s,x) => s + x.clicks, 0);
                
                brandsToPlot.forEach(b => {
                    const record = processedData.find(d => d.week === w && d.brand === b);
                    const val = record && weekTotal ? (record.clicks / weekTotal * 100) : 0;
                    row.push(val);
                });
                return row;
            });

            data.addRows(rows);

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                lineWidth: 3,
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'], // Blue for us
                vAxis: {title: 'Share %'},
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
            chart.draw(data, options);
        }

        // --- CHART 3: EFFICIENCY (SCATTER) ---
        function drawEfficiency() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Avg Organic Rank');
            data.addColumn('number', 'Click Share (%)'); // Y
            data.addColumn({'type': 'string', 'role': 'style'}); // Color
            data.addColumn({'type': 'string', 'role': 'tooltip'}); 

            // Use last week data
            const lastWeek = weeks[weeks.length - 1];
            const weekData = processedData.filter(d => d.week === lastWeek);
            const totalClicks = weekData.reduce((s,d) => s + d.clicks, 0);

            const rows = weekData.map(d => {
                const share = (d.clicks / totalClicks) * 100;
                const color = d.is_us ? 'point { fill-color: #4285F4; size: 10; }' : 'point { fill-color: #999; }';
                return [d.avg_rank, share, color, `${d.brand}: Rank ${d.avg_rank.toFixed(1)}, Share ${share.toFixed(1)}%`];
            });

            data.addRows(rows);

            const options = {
                title: 'Posici√≥n Org√°nica vs Cuota (√öltima Semana)',
                hAxis: {title: 'Ranking Org√°nico (Inverso)', direction: -1}, // Better rank left
                vAxis: {title: 'Click Share %'},
                legend: 'none',
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }
        
        // --- CHART 4: LEVERS (SIMULATION) ---
        function drawLevers() {
            // Visualize Price vs Share for Us vs Avg Competitor over time
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Precio Nuestro');
            data.addColumn('number', 'Precio Competencia');
            data.addColumn('number', 'Share Nuestro');

            const rows = weeks.map(w => {
                const ourData = processedData.find(d => d.week === w && d.is_us);
                const compData = processedData.filter(d => d.week === w && !d.is_us);
                
                const avgCompPrice = compData.reduce((s,c) => s + c.avg_price, 0) / (compData.length || 1);
                
                // normalize share for visualization (scaled to price axis roughly)
                const shareVal = ourData ? (ourData.clicks / 100) * 5 : 0; 
                
                return [w, ourData ? ourData.avg_price : 0, avgCompPrice, shareVal];
            });
            
            // Just use a simple table for this one or a column chart? 
            // Let's do a combo chart: Prices (Lines), Share (Bars)
             // Simplified for the "Levers" section, showing price correlation
             
             // Actually, let's make it a dedicated section about "Did Price Drop help?"
             // We will check correlation in insights. Here let's chart Price vs Share just for us.
             
             const chartData = new google.visualization.DataTable();
             chartData.addColumn('string', 'Semana');
             chartData.addColumn('number', 'Precio ($)');
             chartData.addColumn('number', 'Share Index');
             
             const trendRows = weeks.map(w => {
                 const d = processedData.find(x => x.week === w && x.is_us);
                 if(!d) return [w, 0, 0];
                 return [w, d.avg_price, d.clicks / 10]; // Scale for visibility
             });
             
             chartData.addRows(trendRows);
             
             const chart = new google.visualization.ComboChart(document.getElementById('chart_levers'));
             chart.draw(chartData, {
                 seriesType: 'line',
                 series: {1: {type: 'bars', color: '#4285F4'}},
                 vAxes: {0: {title: 'Precio'}, 1: {title: 'Volumen'}},
                 legend: {position: 'bottom'}
             });
        }

        // --- INSIGHTS GENERATOR ---
        function generateInsights() {
            const lastWeek = weeks[weeks.length-1];
            const ourData = processedData.find(d => d.week === lastWeek && d.is_us);
            const prevData = processedData.find(d => d.week === weeks[weeks.length-2] && d.is_us);
            
            const insights = [];
            const recs = [];
            const other = [];

            if(ourData && prevData) {
                // Trend
                if(ourData.clicks > prevData.clicks) {
                    insights.push(`<li class="insight-item"><span class="material-icons insight-icon">trending_up</span> <strong>Tracci√≥n Positiva:</strong> Has crecido un ${((ourData.clicks - prevData.clicks)/prevData.clicks*100).toFixed(1)}% en clicks esta semana.</li>`);
                } else {
                    insights.push(`<li class="insight-item"><span class="material-icons insight-icon" style="color:red">trending_down</span> <strong>P√©rdida de Tracci√≥n:</strong> Ca√≠da del ${Math.abs((ourData.clicks - prevData.clicks)/prevData.clicks*100).toFixed(1)}% en clicks.</li>`);
                }
                
                // Efficiency
                if(ourData.avg_rank > 10 && ourData.clicks > 100) {
                     insights.push(`<li class="insight-item"><span class="material-icons insight-icon">star</span> <strong>Overperformer:</strong> Tu Rank org√°nico es bajo (${ourData.avg_rank.toFixed(1)}) pero mantienes buen volumen. Posible efecto de Paid o marca fuerte.</li>`);
                }

                // Price
                if(ourData.avg_price < prevData.avg_price && ourData.clicks > prevData.clicks) {
                    recs.push(`<li class="insight-item recommendation-item"><span class="material-icons insight-icon">local_offer</span> <strong>Estrategia de Precio:</strong> La bajada de precio correlacion√≥ con aumento de ventas. Mantener precio promocional.</li>`);
                }
            }

            // General Competitor Insight
            const topComp = processedData.filter(d => d.week === lastWeek && !d.is_us).sort((a,b) => b.clicks - a.clicks)[0];
            if(topComp) {
                insights.push(`<li class="insight-item"><span class="material-icons insight-icon">analytics</span> <strong>Competidor Dominante:</strong> ${topComp.brand} lidera con un rank promedio de ${topComp.avg_rank.toFixed(1)}.</li>`);
                
                if(topComp.avg_price < (ourData?.avg_price || 0)) {
                    recs.push(`<li class="insight-item recommendation-item"><span class="material-icons insight-icon">price_check</span> <strong>Competitividad:</strong> ${topComp.brand} es m√°s barato ($${topComp.avg_price}). Evaluar cup√≥n del 5% para cerrar gap.</li>`);
                }
            }
            
            // Deals
            const dealWeeks = processedData.filter(d => d.is_us && d.deal_active).length;
            if(dealWeeks === 0) {
                recs.push(`<li class="insight-item recommendation-item"><span class="material-icons insight-icon">event</span> <strong>Activaci√≥n:</strong> No has tenido Deals activos recientemente. Planificar Lightning Deal para reactivar visibilidad.</li>`);
            }

            document.getElementById('trend_insights').innerHTML = insights.slice(0,2).join('');
            document.getElementById('competitiveness_insights').innerHTML = insights.slice(2).join('') || "Datos estables en competencia.";
            document.getElementById('final_recommendations').innerHTML = recs.join('');
            
            other.push(`<li class="insight-item">El mercado muestra una estacionalidad estable en las √∫ltimas 4 semanas.</li>`);
            document.getElementById('other_insights').innerHTML = other.join('');
        }

        // --- INTERACTIVE LOGIC ---
        function switchTab(tabId) {
            document.getElementById('static-tab').classList.add('hidden');
            document.getElementById('interactive-tab').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(tabId + '-tab').classList.remove('hidden');
            event.target.classList.add('active');
            
            if(tabId === 'interactive') updateInteractive();
        }

        function populateInteractiveControls() {
            const weekSel = document.getElementById('comp-week-select');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = `Semana: ${w}`;
                weekSel.add(opt);
            });
            weekSel.value = weeks[weeks.length-1];

            const compSel = document.getElementById('comp-competitor-select');
            [...allBrands].filter(b => b !== ourBrandName).forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                compSel.add(opt);
            });
        }

        function updateInteractive() {
            const week = document.getElementById('comp-week-select').value;
            const compName = document.getElementById('comp-competitor-select').value;
            
            const us = processedData.find(d => d.week === week && d.is_us) || {avg_price: 0, clicks: 0, avg_rank: 0, deal_active: false};
            const them = processedData.find(d => d.week === week && d.brand === compName) || {avg_price: 0, clicks: 0, avg_rank: 0, deal_active: false};

            document.getElementById('comp-table-header').innerText = compName;

            const tbody = document.getElementById('comparison-table-body');
            tbody.innerHTML = `
                <tr>
                    <td>Precio Promedio</td>
                    <td>$${us.avg_price.toFixed(2)}</td>
                    <td>$${them.avg_price.toFixed(2)}</td>
                    <td class="${us.avg_price < them.avg_price ? 'text-green' : 'text-red'}">
                        ${(us.avg_price - them.avg_price).toFixed(2)}
                    </td>
                </tr>
                <tr>
                    <td>Volumen Estimado (Clicks)</td>
                    <td>${us.clicks}</td>
                    <td>${them.clicks}</td>
                    <td class="${us.clicks > them.clicks ? 'text-green' : 'text-red'}">
                        ${(us.clicks - them.clicks)}
                    </td>
                </tr>
                <tr>
                    <td>Organic Rank</td>
                    <td>${us.avg_rank.toFixed(1)}</td>
                    <td>${them.avg_rank.toFixed(1)}</td>
                    <td class="${us.avg_rank < them.avg_rank ? 'text-green' : 'text-red'}">
                        ${(them.avg_rank - us.avg_rank).toFixed(1)}
                    </td>
                </tr>
                <tr>
                    <td>Promociones Activas</td>
                    <td>${us.deal_active ? '<span class="badge badge-deal">DEAL</span>' : '-'}</td>
                    <td>${them.deal_active ? '<span class="badge badge-deal">DEAL</span>' : '-'}</td>
                    <td>-</td>
                </tr>
            `;

            // Draw Comparison Bar Chart
            const data = google.visualization.arrayToDataTable([
                ['M√©trica', 'Nosotros', compName],
                ['Precio', us.avg_price, them.avg_price],
                ['Share (Index 100)', (us.clicks/(us.clicks+them.clicks||1))*100, (them.clicks/(us.clicks+them.clicks||1))*100]
            ]);

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_interactive_comparison'));
            chart.draw(data, {
                title: 'Comparativa Directa',
                colors: ['#4285F4', '#EA4335']
            });
        }
    </script>
</body>
</html>