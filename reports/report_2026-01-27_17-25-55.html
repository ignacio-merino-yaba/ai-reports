<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Analysis Report</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* Apple-like/Google-Native Design System */
        :root {
            --primary-blue: #4285F4;
            --success-green: #34A853;
            --warning-yellow: #FBBC05;
            --danger-red: #EA4335;
            --gray-bg: #F8F9FA;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--gray-bg);
            color: #333;
            line-height: 1.5;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid #E5E7EB;
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6B7280;
            font-weight: 500;
        }

        .trend-up { color: var(--success-green); }
        .trend-down { color: var(--danger-red); }
        
        .tab-btn {
            padding: 10px 20px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #6B7280;
        }

        .tab-btn.active {
            background-color: var(--primary-blue);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(66, 133, 244, 0.4);
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Insights List */
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background-color: #F3F4F6;
            border-radius: 8px;
        }
        
        .insight-icon {
            color: var(--primary-blue);
        }
    </style>
</head>
<body class="p-6 max-w-7xl mx-auto">

    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Parent ASIN Intelligence Report</h1>
            <p class="text-gray-500 mt-1">Deep analysis of market performance & competitive landscape</p>
        </div>
        <div class="flex gap-2 bg-white p-1 rounded-full shadow-sm border">
            <button class="tab-btn active" onclick="switchTab('static')">Strategic Dashboard</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Interactive Comparator</button>
        </div>
    </header>

    <!-- DATA INJECTION -->
    <script>
        // Data injected from Python process
        const rawData = [{"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "", "asin": "B08YRXQ2JH", "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "country_code": "uk", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.32, "impression_share": 3.16, "price": 6.98, "click_share_rank": 8, "weekly_search_volume": 40830.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "", "asin": "B08YRXQ2JH", "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "country_code": "uk", "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.4, "impression_share": 3.43, "price": 6.98, "click_share_rank": 8, "weekly_search_volume": 60393.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "", "asin": "B0C71LZNV6", "product_title": "Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...", "country_code": "uk", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 2.56, "impression_share": 4.22, "price": 24.95, "click_share_rank": 10, "weekly_search_volume": 40830.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Heapwell Superfoods", "asin": "B06XTYYYJ8", "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "country_code": "uk", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.74, "impression_share": 5.52, "price": 9.99, "click_share_rank": 4, "weekly_search_volume": 40830.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Heapwell Superfoods", "asin": "B06XTYYYJ8", "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "country_code": "uk", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 6, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 6.46, "impression_share": 4.7, "price": 8.704285714, "click_share_rank": 5, "weekly_search_volume": 60393.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "country_code": "uk", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.39, "impression_share": 3.28, "price": 20.99, "click_share_rank": 7, "weekly_search_volume": 40830.61, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "country_code": "uk", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.59, "impression_share": 3.26, "price": 20.99, "click_share_rank": 6, "weekly_search_volume": 60393.4, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "country_code": "uk", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 13.11, "impression_share": 3.29, "price": 12.49, "click_share_rank": 1, "weekly_search_volume": 60393.4, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "country_code": "uk", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 0, "click_share": 13.79, "impression_share": 3.33, "price": 12.49, "click_share_rank": 1, "weekly_search_volume": 40830.61, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Perfect Ted", "asin": "B09DQ1PWGX", "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "country_code": "uk", "average_organic_rank": 34, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.64, "impression_share": 3.45, "price": 2.1225, "click_share_rank": 5, "weekly_search_volume": 40830.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Perfect Ted", "asin": "B09DQ1PWGX", "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 9.27, "impression_share": 6.06, "price": 9.49, "click_share_rank": 2, "weekly_search_volume": 60393.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Perfect Ted", "asin": "B0F21VZMJQ", "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "country_code": "uk", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 8.65, "impression_share": 3.53, "price": 16.99, "click_share_rank": 3, "weekly_search_volume": 60393.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Perfect Ted", "asin": "B0F21VZMJQ", "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "country_code": "uk", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 1, "weekly_number_of_days_with_coupon": 0, "click_share": 10.49, "impression_share": 3.3, "price": 16.99, "click_share_rank": 2, "weekly_search_volume": 40830.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "Perfect Ted", "asin": "B0D9M91WZD", "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "country_code": "uk", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 2.79, "impression_share": 3.5, "price": 11.0, "click_share_rank": 9, "weekly_search_volume": 40830.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "Perfect Ted", "asin": "B0D9M91WZD", "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "country_code": "uk", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.45, "impression_share": 4.83, "price": 9.49, "click_share_rank": 7, "weekly_search_volume": 60393.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "PureChimp", "asin": "B00HNDSOCI", "product_title": "PureChimp Ceremonial Grade Matcha Powder 50g. 100%...", "country_code": "uk", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 2.34, "impression_share": 3.39, "price": 14.95, "click_share_rank": 10, "weekly_search_volume": 60393.4, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "SuperSelf", "asin": "B08YK2RPBZ", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "country_code": "uk", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 4, "click_share": 9.83, "impression_share": 3.56, "price": 9.9, "click_share_rank": 3, "weekly_search_volume": 40830.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "matcha", "competitor_brand": "SuperSelf", "asin": "B082DKRSB4", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 4, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 4, "click_share": 3.96, "impression_share": 4.48, "price": 14.86, "click_share_rank": 6, "weekly_search_volume": 40830.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "SuperSelf", "asin": "B082DKRSB4", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "country_code": "uk", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 2.95, "impression_share": 4.13, "price": 19.18, "click_share_rank": 9, "weekly_search_volume": 60393.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "matcha", "competitor_brand": "SuperSelf", "asin": "B08YK2RPBZ", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "country_code": "uk", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 1, "weekly_number_of_days_with_coupon": 7, "click_share": 7.98, "impression_share": 3.43, "price": 9.9, "click_share_rank": 4, "weekly_search_volume": 60393.4, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.co.uk/s?k=matcha"}];
    </script>

    <!-- REPORT CONTENT -->
    <div id="static-report">
        
        <!-- SECTION 1: GLOBAL TREND -->
        <div class="card">
            <h2><i class="material-icons text-blue-500">trending_up</i> Global Parent Trend (Clicks & Share)</h2>
            <div id="chart_global_trend" class="chart-container"></div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4" id="trend_insights">
                <!-- Dynamic Insights populated via JS -->
            </div>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="card">
            <h2><i class="material-icons text-red-500">emoji_events</i> Brand Competitiveness</h2>
            <div id="chart_brand_share" class="chart-container"></div>
            <div class="mt-4 text-sm text-gray-600" id="brand_insights"></div>
        </div>

        <!-- SECTION 3 & 4: LEVERS & EFFICIENCY -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card">
                <h2><i class="material-icons text-yellow-600">tune</i> Growth Levers Impact</h2>
                <div id="levers_analysis" class="space-y-3"></div>
            </div>
            <div class="card">
                <h2><i class="material-icons text-green-600">scatter_plot</i> Efficiency (Rank vs Share)</h2>
                <div id="chart_efficiency" class="chart-container"></div>
                <p class="text-xs text-gray-500 mt-2 text-center">X: Organic Rank (Lower is better) | Y: Click Share</p>
            </div>
        </div>

        <!-- SECTION 5: CONCLUSIONS & RECOMMENDATIONS -->
        <div class="card border-l-4 border-blue-500">
            <h2><i class="material-icons text-blue-600">lightbulb</i> Strategic Insights & Recommendations</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-semibold mb-3 text-gray-700">Key Insights</h3>
                    <ul id="key_insights_list" class="space-y-2 text-sm text-gray-700 list-disc pl-5"></ul>
                </div>
                <div>
                    <h3 class="font-semibold mb-3 text-gray-700">Actionable Recommendations</h3>
                    <ul id="recommendations_list" class="space-y-2 text-sm text-gray-700 list-disc pl-5"></ul>
                </div>
            </div>
        </div>

        <!-- OTHER INSIGHTS -->
        <div class="card bg-blue-50">
            <h2><i class="material-icons text-blue-800">radar</i> Other Signals</h2>
            <div id="other_insights" class="text-sm text-blue-900"></div>
        </div>
    </div>

    <!-- INTERACTIVE COMPARATOR (Hidden by default) -->
    <div id="interactive-report" style="display: none;">
        <div class="card">
            <div class="flex gap-4 mb-6">
                <select id="comp_week_select" class="p-2 border rounded-md" onchange="updateComparator()">
                    <!-- Populated by JS -->
                </select>
                <select id="comp_brand_select" class="p-2 border rounded-md" onchange="updateComparator()">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div id="comparator_output" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-xl">
                    <h3 class="text-center font-bold text-blue-600 mb-2">Our Brand</h3>
                    <div id="our_metrics" class="space-y-2"></div>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl">
                    <h3 class="text-center font-bold text-red-500 mb-2" id="comp_name_display">Competitor</h3>
                    <div id="comp_metrics" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script>
        // --- 1. DATA PROCESSING ENGINE ---
        
        function normalizeBrand(item) {
            if (item.competitor_brand && item.competitor_brand.trim() !== "") {
                return item.competitor_brand;
            }
            // Fallback: Extract from Product Title (First part before | or -)
            const title = item.product_title || "";
            const match = title.split(/[|\-]/)[0].trim();
            return match || "Unknown Brand";
        }

        // Augment Data
        const processedData = rawData.map(d => {
            return {
                ...d,
                real_brand: normalizeBrand(d),
                estimated_clicks: (d.click_share / 100) * d.weekly_search_volume
            };
        });

        // Identify Our Brand
        const ourAsinExample = processedData.find(d => d.is_yaba_asin === 'Y');
        const OUR_BRAND = ourAsinExample ? ourAsinExample.real_brand : "Our Brand";

        // Get Unique Weeks (Sorted)
        const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        const latestWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];

        // --- 2. GOOGLE CHARTS SETUP ---
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawCharts);

        function drawCharts() {
            drawTrendChart();
            drawBrandCompetitivenessChart();
            drawEfficiencyChart();
            generateInsights();
            initComparator();
        }

        // --- 3. CHART LOGIC ---

        function drawTrendChart() {
            // Aggregate Clicks by Week for Us vs Them
            const trendData = weeks.map(week => {
                const weekData = processedData.filter(d => d.week_date === week);
                const ourClicks = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((sum, d) => sum + d.estimated_clicks, 0);
                const compClicks = weekData.filter(d => d.is_yaba_asin === 'N').reduce((sum, d) => sum + d.estimated_clicks, 0);
                
                // Calculate Share
                const total = ourClicks + compClicks;
                const ourShare = total > 0 ? (ourClicks / total) : 0;
                
                return [week, ourClicks, compClicks, ourShare];
            });

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', 'Our Clicks');
            data.addColumn('number', 'Competitor Clicks');
            data.addColumn('number', 'Our Click Share');

            data.addRows(trendData);

            const options = {
                seriesType: 'bars',
                series: {2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
                colors: ['#8AB4F8', '#E5E7EB'],
                legend: {position: 'bottom'},
                vAxes: {
                    0: {title: 'Clicks Volume'},
                    1: {title: 'Share %', format: '#%'}
                },
                chartArea: {width: '85%', height: '70%'},
                animation: { startup: true, duration: 1000, easing: 'out' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
        }

        function drawBrandCompetitivenessChart() {
            // Identify Top 3 Competitors
            const brandShares = {};
            processedData.forEach(d => {
                if (d.real_brand === OUR_BRAND) return;
                if (!brandShares[d.real_brand]) brandShares[d.real_brand] = 0;
                brandShares[d.real_brand] += d.click_share;
            });
            const topCompetitors = Object.entries(brandShares)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(e => e[0]);

            // Build Matrix: Week | Our Brand | Comp 1 | Comp 2 | Comp 3 | Others
            const rows = weeks.map(week => {
                const weekData = processedData.filter(d => d.week_date === week);
                
                const getShare = (brand) => {
                    return weekData.filter(d => d.real_brand === brand).reduce((sum, d) => sum + d.click_share, 0);
                };

                const ourShare = getShare(OUR_BRAND);
                const comp1 = getShare(topCompetitors[0]);
                const comp2 = getShare(topCompetitors[1]);
                const comp3 = getShare(topCompetitors[2]);
                
                return [week, ourShare, comp1, comp2, comp3];
            });

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', OUR_BRAND);
            topCompetitors.forEach(c => data.addColumn('number', c));

            data.addRows(rows);

            const options = {
                curveType: 'function',
                lineWidth: 3,
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
                legend: {position: 'bottom'},
                chartArea: {width: '90%', height: '70%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
            chart.draw(data, options);
        }

        function drawEfficiencyChart() {
            // Only Latest Week
            const weekData = processedData.filter(d => d.week_date === latestWeek);
            
            const rows = weekData.map(d => {
                // Tooltip content
                const tooltip = `${d.real_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
                return [d.average_organic_rank, d.click_share, d.is_yaba_asin === 'Y' ? '#4285F4' : '#9AA0A6', tooltip];
            });

            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Rank');
            data.addColumn('number', 'Click Share');
            data.addColumn({type: 'string', role: 'style'});
            data.addColumn({type: 'string', role: 'tooltip'});

            data.addRows(rows);

            const options = {
                hAxis: {title: 'Organic Rank (Inverted)', direction: -1}, // Better rank on right
                vAxis: {title: 'Click Share %'},
                legend: 'none',
                chartArea: {width: '85%', height: '80%'},
                pointSize: 10
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- 4. INSIGHTS GENERATION ENGINE ---

        function generateInsights() {
            const currentData = processedData.filter(d => d.week_date === latestWeek);
            const prevData = processedData.filter(d => d.week_date === prevWeek);

            // 1. Trend Analysis
            const totalVol = currentData.reduce((sum, d) => sum + d.weekly_search_volume, 0) / currentData.length; // Volume is repeated per row usually
            const prevVol = prevData.reduce((sum, d) => sum + d.weekly_search_volume, 0) / prevData.length;
            const volChange = ((totalVol - prevVol) / prevVol) * 100;

            const trendDiv = document.getElementById('trend_insights');
            trendDiv.innerHTML = `
                <div class="insight-item">
                    <i class="material-icons insight-icon">search</i>
                    <div>
                        <span class="font-bold">Search Volume:</span> 
                        ${Math.round(totalVol).toLocaleString()} 
                        <span class="${volChange >= 0 ? 'text-green-600' : 'text-red-600'} text-sm font-bold">
                            (${volChange > 0 ? '+' : ''}${volChange.toFixed(1)}%)
                        </span> vs previous week.
                    </div>
                </div>
            `;

            // 2. Levers Analysis (Price & Badges)
            const leversDiv = document.getElementById('levers_analysis');
            const ourAvgPrice = currentData.filter(d => d.real_brand === OUR_BRAND).reduce((s, d) => s + d.price, 0) / currentData.filter(d => d.real_brand === OUR_BRAND).length;
            const mktAvgPrice = currentData.filter(d => d.real_brand !== OUR_BRAND).reduce((s, d) => s + d.price, 0) / currentData.filter(d => d.real_brand !== OUR_BRAND).length;
            
            leversDiv.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded mb-2">
                    <span>Our Avg Price</span>
                    <span class="font-bold">£${ourAvgPrice.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded mb-2">
                    <span>Market Avg Price</span>
                    <span class="font-bold">£${mktAvgPrice.toFixed(2)}</span>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    ${ourAvgPrice > mktAvgPrice ? 'We are positioned as a PREMIUM option.' : 'We are positioned aggressively on PRICE.'}
                </div>
            `;

            // 3. Strategic Recommendations
            const recList = document.getElementById('recommendations_list');
            const keyInsights = document.getElementById('key_insights_list');
            
            let insights = [];
            let recs = [];

            // Logic: High Rank but Low Share
            const ourLowShare = currentData.filter(d => d.is_yaba_asin === 'Y' && d.average_organic_rank < 5 && d.click_share < 10);
            if (ourLowShare.length > 0) {
                insights.push("Some variants have Top 5 ranking but low Click Share (<10%).");
                recs.push("Review Main Image and Price on high-ranking variants to improve CTR.");
            }

            // Logic: Competitor with Deal
            const compDeals = currentData.filter(d => d.is_yaba_asin === 'N' && (d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0));
            if (compDeals.length > 0) {
                insights.push(`${compDeals.length} competitor ASINs are currently running Deals/Coupons.`);
                recs.push("Monitor competitor promotions; consider defensive coupons if share drops.");
            }

            // Logic: Price Gap
            if (ourAvgPrice > mktAvgPrice * 1.2) {
                insights.push("Our price is >20% higher than market average.");
                recs.push("Ensure listing highlights premium value propositions (Quality/Origin) to justify price delta.");
            }

            // Populate Lists
            if (insights.length === 0) insights.push("Market appears stable with no major anomalies.");
            if (recs.length === 0) recs.push("Maintain current strategy and monitor daily.");

            keyInsights.innerHTML = insights.map(i => `<li>${i}</li>`).join('');
            recList.innerHTML = recs.map(i => `<li>${i}</li>`).join('');

            // Other Insights
            const otherDiv = document.getElementById('other_insights');
            otherDiv.innerText = `Data indicates ${currentData.filter(d => d.is_yaba_asin === 'N').length} active competitor ASINs in this parent cluster.`;
        }

        // --- 5. INTERACTIVE COMPARATOR ---

        function initComparator() {
            const weekSelect = document.getElementById('comp_week_select');
            const brandSelect = document.getElementById('comp_brand_select');

            // Populate Weeks
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                if(w === latestWeek) opt.selected = true;
                weekSelect.appendChild(opt);
            });

            // Populate Competitors
            const brands = [...new Set(processedData.map(d => d.real_brand))].filter(b => b !== OUR_BRAND);
            brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                brandSelect.appendChild(opt);
            });

            updateComparator();
        }

        function updateComparator() {
            const selectedWeek = document.getElementById('comp_week_select').value;
            const selectedComp = document.getElementById('comp_brand_select').value;
            document.getElementById('comp_name_display').innerText = selectedComp;

            const weekData = processedData.filter(d => d.week_date === selectedWeek);
            
            const getMetrics = (brand) => {
                const brandData = weekData.filter(d => d.real_brand === brand);
                if (brandData.length === 0) return { share: 0, price: 0, rank: 0 };
                
                const share = brandData.reduce((s,d) => s + d.click_share, 0);
                const price = brandData.reduce((s,d) => s + d.price, 0) / brandData.length;
                const rank = brandData.reduce((s,d) => s + d.average_organic_rank, 0) / brandData.length;
                
                return { share, price, rank };
            };

            const renderMetrics = (metrics, containerId) => {
                document.getElementById(containerId).innerHTML = `
                    <div class="flex justify-between border-b pb-1"><span>Share</span> <span class="font-bold">${metrics.share.toFixed(1)}%</span></div>
                    <div class="flex justify-between border-b pb-1"><span>Avg Price</span> <span class="font-bold">£${metrics.price.toFixed(2)}</span></div>
                    <div class="flex justify-between"><span>Avg Rank</span> <span class="font-bold">#${metrics.rank.toFixed(0)}</span></div>
                `;
            };

            renderMetrics(getMetrics(OUR_BRAND), 'our_metrics');
            renderMetrics(getMetrics(selectedComp), 'comp_metrics');
        }

        // --- UTILS ---
        function switchTab(tab) {
            document.getElementById('static-report').style.display = tab === 'static' ? 'block' : 'none';
            document.getElementById('interactive-report').style.display = tab === 'interactive' ? 'block' : 'none';
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

    </script>
</body>
</html>