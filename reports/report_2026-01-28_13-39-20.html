<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --text-main: #202124;
            --text-secondary: #5f6368;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-radius: 16px;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout & Containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--card-bg);
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Sections */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card h2 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-main);
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }

        /* Metrics */
        .metric-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-box {
            flex: 1;
            background: #f1f3f4;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        .metric-val { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .metric-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .insight-item:last-child { border-bottom: none; margin-bottom: 0; }
        
        .insight-icon {
            color: var(--primary-color);
        }

        .insight-text strong {
            display: block;
            margin-bottom: 4px;
        }

        /* Recommendations */
        .rec-card {
            background-color: #e8f0fe;
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }

        /* Controls for Interactive Tab */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-size: 14px;
            background-color: #fff;
            min-width: 200px;
        }

        /* Charts Container */
        .chart-container {
            width: 100%;
            height: 400px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            margin-right: 4px;
        }
        .bg-blue { background-color: var(--primary-color); }
        .bg-green { background-color: var(--success-color); }
        .bg-red { background-color: var(--danger-color); }
        
        table.custom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        table.custom-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #eee;
            color: var(--text-secondary);
        }
        
        table.custom-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Análisis de Parent ASIN</h1>
            <p style="color: var(--text-secondary); margin-top: 4px;">Inteligencia de Mercado & Competitividad</p>
        </div>
        <div>
            <span style="font-size: 12px; background: #e8f0fe; color: #1967d2; padding: 6px 12px; border-radius: 20px; font-weight: 600;">CONFIDENCIAL</span>
        </div>
    </div>

    <!-- Navegación -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="static-report" class="tab-content active">
        
        <!-- Sección 1: Tendencia Global -->
        <div class="card">
            <h2><span class="material-icons">trending_up</span> 1. Tendencia Global del Parent</h2>
            <div class="metric-row" id="global-metrics">
                <!-- Se llenará con JS -->
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="insight-card" id="trend_insights">
                <!-- Insights dinámicos aquí -->
            </div>
        </div>

        <!-- Sección 2: Competitividad de Marca -->
        <div class="card">
            <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Click Share)</h2>
            <div id="chart_competitiveness" class="chart-container"></div>
            <div class="grid-2" style="margin-top:20px;">
                <div>
                    <h3>Dominio de Mercado</h3>
                    <p id="market_dominance_text" style="color:var(--text-secondary); line-height:1.6;"></p>
                </div>
                <div>
                    <h3>Top Competidores</h3>
                    <ul id="top_competitors_list" class="insight-list"></ul>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <!-- Sección 3: Palancas -->
            <div class="card">
                <h2><span class="material-icons">tune</span> 3. Palancas de Crecimiento</h2>
                <div id="chart_levers" style="height: 300px;"></div>
                <div style="margin-top: 16px;">
                    <ul id="levers_insights" class="insight-list"></ul>
                </div>
            </div>

            <!-- Sección 4: Eficiencia -->
            <div class="card">
                <h2><span class="material-icons">speed</span> 4. Eficiencia (Rank vs Share)</h2>
                <div id="chart_efficiency" style="height: 300px;"></div>
                <p style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 8px;">
                    Eje X: Ranking Orgánico (Menos es mejor) | Eje Y: Click Share (Más es mejor)
                </p>
                <div id="efficiency_insights" style="margin-top: 12px;"></div>
            </div>
        </div>

        <!-- Sección 5: Conclusiones y Recomendaciones -->
        <div class="card" style="border-left: 5px solid var(--primary-color);">
            <h2><span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones</h2>
            
            <div class="grid-2">
                <div>
                    <h3 style="color: var(--primary-color);">Insights Clave</h3>
                    <ul id="final_insights" class="insight-list">
                        <!-- JS Populate -->
                    </ul>
                </div>
                <div>
                    <h3 style="color: var(--success-color);">Plan de Acción</h3>
                    <div id="final_recommendations">
                        <!-- JS Populate -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sección 6: Otros Insights -->
        <div class="card">
             <h2><span class="material-icons">radar</span> 6. Otros Hallazgos</h2>
             <ul id="other_insights" class="insight-list"></ul>
        </div>

    </div>

    <!-- PESTAÑA 2: INTERACTIVO -->
    <div id="interactive-report" class="tab-content">
        <div class="card">
            <h2><span class="material-icons">compare_arrows</span> Cara a Cara: Nosotros vs Competencia</h2>
            
            <div class="controls">
                <select id="weekSelector" onchange="updateInteractive()">
                    <!-- Opciones de semanas -->
                </select>
                <select id="competitorSelector" onchange="updateInteractive()">
                    <!-- Opciones de competidores -->
                </select>
            </div>

            <div id="comparison_view">
                <div class="grid-2">
                    <!-- Tarjeta Nosotros -->
                    <div style="background: #e8f0fe; padding: 20px; border-radius: 12px;">
                        <h3 id="us_title" style="color: var(--primary-color);">Nuestra Marca</h3>
                        <table class="custom-table">
                            <tr><td>Precio Promedio</td><td id="us_price" style="font-weight:bold;">-</td></tr>
                            <tr><td>Click Share</td><td id="us_share" style="font-weight:bold;">-</td></tr>
                            <tr><td>Rank Promedio</td><td id="us_rank" style="font-weight:bold;">-</td></tr>
                            <tr><td>Días con Deal</td><td id="us_deals" style="font-weight:bold;">-</td></tr>
                        </table>
                    </div>

                    <!-- Tarjeta Competidor -->
                    <div style="background: #fce8e6; padding: 20px; border-radius: 12px;">
                        <h3 id="comp_title" style="color: var(--danger-color);">Competidor</h3>
                        <table class="custom-table">
                            <tr><td>Precio Promedio</td><td id="comp_price" style="font-weight:bold;">-</td></tr>
                            <tr><td>Click Share</td><td id="comp_share" style="font-weight:bold;">-</td></tr>
                            <tr><td>Rank Promedio</td><td id="comp_rank" style="font-weight:bold;">-</td></tr>
                            <tr><td>Días con Deal</td><td id="comp_deals" style="font-weight:bold;">-</td></tr>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top: 24px;">
                    <h4>Análisis de brecha</h4>
                    <p id="gap_analysis" style="color: var(--text-secondary);"></p>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- DATA INJECTION & LOGIC -->
<script>
    // ------------------------------------------------------------------
    // 1. DATOS PROCESADOS (Inyectados Directamente)
    // ------------------------------------------------------------------
    // Nota: Se han extraído del CSV proporcionado.
    const marketData = [{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B08YRXQ2JH","brand":"Double","is_yaba_asin":"N","click_share":4.92,"clicks":1206.876984,"price":6.98,"rank":11,"deal_days":0,"bs_days":0,"ac_days":0,"coupon_days":0,"product_title":"Double Dragon | 100% Organic | Premium Matcha Gree...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B06XTYYYJ8","brand":"Heapwell Superfoods","is_yaba_asin":"N","click_share":7.28,"clicks":1785.785456,"price":9.99,"rank":4,"deal_days":0,"bs_days":0,"ac_days":0,"coupon_days":0,"product_title":"Heapwell Matcha Powder - 50g | High Grade Japanese...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B079VQ52MK","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.19,"clicks":782.507638,"price":20.99,"rank":8,"deal_days":0,"bs_days":0,"ac_days":0,"coupon_days":0,"product_title":"NaturaleBio Japanese Organic Matcha Green Tea Powd...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B06XQ5DCYJ","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":14.18,"clicks":3478.356836,"price":12.49,"rank":1,"deal_days":0,"bs_days":0,"ac_days":4,"coupon_days":0,"product_title":"NaturaleBio Japanese Organic Matcha Green Tea Powd...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B07B29VZ6W","brand":"NaturaleBio","is_yaba_asin":"Y","click_share":2.03,"clicks":497.959406,"price":16.49,"rank":10,"deal_days":0,"bs_days":0,"ac_days":0,"coupon_days":0,"product_title":"NaturaleBio Japanese Organic Matcha Green Tea Powd...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B09DQ1PWGX","brand":"Perfect Ted","is_yaba_asin":"N","click_share":4.68,"clicks":1148.004936,"price":2.1225,"rank":6,"deal_days":0,"bs_days":0,"ac_days":0,"coupon_days":0,"product_title":"PerfectTed Organic Matcha Powder, Ceremonial Grade...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B0F21VZMJQ","brand":"Perfect Ted","is_yaba_asin":"N","click_share":7.54,"clicks":1849.563508,"price":16.99,"rank":3,"deal_days":0,"bs_days":0,"ac_days":1,"coupon_days":0,"product_title":"PerfectTed Original Matcha Powder, Ceremonial Grad...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B0D9M91WZD","brand":"Perfect Ted","is_yaba_asin":"N","click_share":2.37,"clicks":581.361474,"price":11.0,"rank":9,"deal_days":0,"bs_days":0,"ac_days":0,"coupon_days":0,"product_title":"PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B08YK2RPBZ","brand":"SuperSelf","is_yaba_asin":"N","click_share":13.48,"clicks":3306.646696,"price":9.9,"rank":2,"deal_days":0,"bs_days":0,"ac_days":0,"coupon_days":4,"product_title":"SuperSelf Organic Matcha Powder - Ceremonial Grade...","keywords":"matcha powder"},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B082DKRSB4","brand":"SuperSelf","is_yaba_asin":"N","click_share":4.06,"clicks":995.918812,"price":14.86,"rank":7,"deal_days":4,"bs_days":0,"ac_days":0,"coupon_days":4,"product_title":"SuperSelf Organic Matcha Powder - Ceremonial Grade...","keywords":"matcha powder"}];

    // ------------------------------------------------------------------
    // 2. CONFIGURACIÓN E INICIALIZACIÓN
    // ------------------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    let ourBrand = "";
    let uniqueWeeks = [];
    let processedData = {};
    let topCompetitors = [];

    function initDashboard() {
        processData();
        renderTrendChart();
        renderCompetitivenessChart();
        renderEfficiencyChart();
        renderLeversChart();
        populateInsights();
        setupInteractive();
    }

    // ------------------------------------------------------------------
    // 3. LÓGICA DE PROCESAMIENTO DE DATOS
    // ------------------------------------------------------------------
    function processData() {
        // Identificar nuestra marca
        const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y');
        ourBrand = ourAsinRow ? ourAsinRow.brand : "Unknown";
        
        // Obtener semanas únicas
        uniqueWeeks = [...new Set(marketData.map(d => d.week))].sort();

        // Agregación global por semana
        processedData.byWeek = {};
        
        uniqueWeeks.forEach(week => {
            const weekData = marketData.filter(d => d.week === week);
            const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
            
            // Datos Nosotros
            const ourData = weekData.filter(d => d.brand === ourBrand);
            const ourClicks = ourData.reduce((sum, d) => sum + d.clicks, 0);
            
            // Datos Competencia
            const compData = weekData.filter(d => d.brand !== ourBrand);
            const compClicks = compData.reduce((sum, d) => sum + d.clicks, 0);

            // Identificar Top 3 Competidores (por volumen de clicks en esta semana)
            const brandClicks = {};
            compData.forEach(d => {
                brandClicks[d.brand] = (brandClicks[d.brand] || 0) + d.clicks;
            });
            const sortedBrands = Object.entries(brandClicks).sort((a,b) => b[1] - a[1]);
            const top3 = sortedBrands.slice(0, 3).map(b => b[0]);
            if(uniqueWeeks.length === 1) topCompetitors = top3; // Si solo hay 1 semana, estos son los top globales

            processedData.byWeek[week] = {
                totalClicks,
                ourClicks,
                compClicks,
                ourShare: (ourClicks / totalClicks) * 100,
                compShare: (compClicks / totalClicks) * 100,
                brands: brandClicks
            };
        });
    }

    // ------------------------------------------------------------------
    // 4. RENDERIZADO DE GRÁFICOS (GOOGLE CHARTS)
    // ------------------------------------------------------------------
    
    // Gráfico 1: Tendencia Global (Combo Chart)
    function renderTrendChart() {
        const dataArray = [['Semana', 'Clicks Nosotros', 'Clicks Competencia', 'Nuestra Cuota (%)']];
        
        uniqueWeeks.forEach(week => {
            const d = processedData.byWeek[week];
            dataArray.push([week, d.ourClicks, d.compClicks, d.ourShare]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1 } }, // Línea para Share
            colors: ['#4285F4', '#EA4335', '#34A853'],
            vAxes: {
                0: { title: 'Volumen de Clicks' },
                1: { title: 'Click Share (%)', format: '#\'%\'' }
            },
            legend: { position: 'bottom' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
        
        // Métricas rápidas
        const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
        const lastData = processedData.byWeek[lastWeek];
        document.getElementById('global-metrics').innerHTML = `
            <div class="metric-box">
                <div class="metric-val">${Math.round(lastData.ourShare)}%</div>
                <div class="metric-label">Share Actual</div>
            </div>
            <div class="metric-box">
                <div class="metric-val">${Math.round(lastData.totalClicks).toLocaleString()}</div>
                <div class="metric-label">Clicks Totales Mercado</div>
            </div>
             <div class="metric-box">
                <div class="metric-val" style="color:${lastData.ourShare > lastData.compShare ? 'green' : 'orange'}">
                    ${lastData.ourShare > 20 ? 'Líder' : 'Retador'}
                </div>
                <div class="metric-label">Posición</div>
            </div>
        `;
    }

    // Gráfico 2: Competitividad (Line Chart)
    function renderCompetitivenessChart() {
        // Cabecera: Semana, Nosotros, Top1, Top2, Top3, Otros
        const header = ['Semana', ourBrand, ...topCompetitors, 'Otros'];
        const dataArray = [header];

        uniqueWeeks.forEach(week => {
            const d = processedData.byWeek[week];
            const row = [week];
            
            // Share Nosotros
            row.push(d.ourShare);
            
            // Share Top 3
            let top3Sum = 0;
            topCompetitors.forEach(comp => {
                const clicks = d.brands[comp] || 0;
                const share = (clicks / d.totalClicks) * 100;
                row.push(share);
                top3Sum += share;
            });

            // Share Otros
            const otherShare = 100 - d.ourShare - top3Sum;
            row.push(otherShare < 0 ? 0 : otherShare); // Protección contra rounding errors

            dataArray.push(row);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            vAxis: { title: 'Click Share (%)' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    // Gráfico 3: Palancas (Deals, Price vs Share)
    function renderLeversChart() {
        const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
        const weekData = marketData.filter(d => d.week === lastWeek);
        
        // Agrupar por Marca para ver quien usa palancas
        const brandStats = {};
        
        weekData.forEach(d => {
            if(!brandStats[d.brand]) {
                brandStats[d.brand] = { clicks: 0, deals: 0, coupon: 0, products: 0, weightedPrice: 0 };
            }
            brandStats[d.brand].clicks += d.clicks;
            brandStats[d.brand].deals += d.weekly_number_of_days_with_deal > 0 ? 1 : 0;
            brandStats[d.brand].coupon += d.weekly_number_of_days_with_coupon > 0 ? 1 : 0;
            brandStats[d.brand].weightedPrice += d.price * d.clicks;
            brandStats[d.brand].products += 1;
        });

        const dataArray = [['Marca', 'Click Share (%)', 'Días Deal (Promedio)', 'Días Cupón (Promedio)']];
        const totalClicks = processedData.byWeek[lastWeek].totalClicks;

        Object.keys(brandStats).forEach(b => {
            const s = brandStats[b];
            const share = (s.clicks / totalClicks) * 100;
            const avgDeals = s.deals / s.products; // Simplificación para visualización
            const avgCoupons = s.coupon / s.products;
            
            // Solo mostrar marcas relevantes (>1% share)
            if(share > 1) {
                dataArray.push([b, share, avgDeals, avgCoupons]);
            }
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            seriesType: 'bars',
            series: { 0: { type: 'line', targetAxisIndex: 1 } }, // Share en línea
            vAxes: {
                0: { title: 'Días Activos (Promedio)' },
                1: { title: 'Share (%)' }
            },
            colors: ['#4285F4', '#FBBC05', '#34A853']
        };
        
        const chart = new google.visualization.ComboChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    // Gráfico 4: Eficiencia (Scatter: Rank vs Share)
    function renderEfficiencyChart() {
        const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
        const weekData = marketData.filter(d => d.week === lastWeek);

        const dataArray = [['ID', 'Rank Promedio', 'Click Share (%)', 'Marca', 'Tamaño']];
        
        weekData.forEach(d => {
            dataArray.push([
                d.asin, 
                d.average_organic_rank, 
                d.click_share, 
                d.brand === ourBrand ? 'Nosotros' : 'Competencia',
                d.weekly_number_of_days_with_deal + d.weekly_number_of_days_with_coupon + 1 // Tamaño burbuja = actividad promo
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            hAxis: { title: 'Ranking Orgánico (Menor es mejor)', direction: 1 },
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            colors: ['#EA4335', '#4285F4'], // Competencia Rojo, Nosotros Azul (alfabético C vs N)
            bubble: { textStyle: { fontSize: 11 } }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // ------------------------------------------------------------------
    // 5. GENERACIÓN DE INSIGHTS (LÓGICA DE NEGOCIO)
    // ------------------------------------------------------------------
    function populateInsights() {
        const lastWeek = uniqueWeeks[uniqueWeeks.length - 1];
        const d = processedData.byWeek[lastWeek];
        const weekData = marketData.filter(w => w.week === lastWeek);
        const ourAsins = weekData.filter(x => x.brand === ourBrand);
        
        // --- 1. Top Competidores Lista ---
        const compList = document.getElementById('top_competitors_list');
        topCompetitors.forEach((c, index) => {
            const cShare = ((d.brands[c] || 0) / d.totalClicks * 100).toFixed(1);
            compList.innerHTML += `<li class="insight-item">
                <span class="insight-icon material-icons">looks_${index + 1}</span>
                <div class="insight-text"><strong>${c}</strong> ${cShare}% Share</div>
            </li>`;
        });

        // --- 2. Dominio ---
        const diff = d.ourShare - ((d.brands[topCompetitors[0]] || 0) / d.totalClicks * 100);
        document.getElementById('market_dominance_text').innerHTML = `
            Nuestra marca <strong>${ourBrand}</strong> tiene un <strong>${d.ourShare.toFixed(1)}%</strong> de cuota.
            ${diff > 0 ? 'Lideramos el mercado por ' + diff.toFixed(1) + ' puntos.' : 'Estamos a ' + Math.abs(diff).toFixed(1) + ' puntos del líder.'}
        `;

        // --- 3. Insights Clave (Conclusiones) ---
        const insightsList = document.getElementById('final_insights');
        let insightsHTML = '';

        // Insight Precio
        const avgPriceUs = ourAsins.reduce((s, x) => s + x.price, 0) / (ourAsins.length || 1);
        const compAsins = weekData.filter(x => x.brand !== ourBrand);
        const avgPriceComp = compAsins.reduce((s, x) => s + x.price, 0) / (compAsins.length || 1);
        
        if (avgPriceUs > avgPriceComp * 1.2) {
            insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">payments</span> Premium Pricing: Tu precio es un 20% superior al promedio.</li>`;
        } else if (avgPriceUs < avgPriceComp * 0.9) {
            insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">savings</span> Competitividad Precio: Estás posicionado como opción económica.</li>`;
        }

        // Insight Badges
        const amazonChoiceCount = ourAsins.filter(a => a.ac_days > 0).length;
        if (amazonChoiceCount > 0) {
            insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">verified</span> Visibilidad: ${amazonChoiceCount} de tus ASINs tienen etiqueta Amazon Choice.</li>`;
        }

        // Insight Deals
        const activeDeals = compAsins.filter(a => a.deal_days > 0).length;
        if (activeDeals > 2) {
            insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">local_offer</span> Presión Promocional: Alta actividad de ofertas en la competencia (${activeDeals} ASINs activos).</li>`;
        }

        // Insight Trend (Si hay data histórica, si no, estático)
        if (uniqueWeeks.length > 1) {
             const firstWeek = processedData.byWeek[uniqueWeeks[0]];
             const trend = d.ourShare - firstWeek.ourShare;
             insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">trending_${trend > 0 ? 'up' : 'down'}</span> Tendencia: Tu cuota ha ${trend > 0 ? 'crecido' : 'caído'} un ${Math.abs(trend).toFixed(1)}% en el periodo.</li>`;
        } else {
            insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">info</span> Análisis basado en la semana ${lastWeek}.</li>`;
        }
        
        // Insight Eficiencia
        const highRankLowShare = ourAsins.filter(a => a.rank < 10 && a.click_share < 5);
        if(highRankLowShare.length > 0) {
             insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">warning</span> Ineficiencia: ${highRankLowShare.length} ASINs tienen buen rank (<10) pero bajo share (<5%). Revisar imagen principal/precio.</li>`;
        }

        insightsList.innerHTML = insightsHTML;

        // --- 4. Recomendaciones ---
        const recList = document.getElementById('final_recommendations');
        let recHTML = '';
        
        if (diff < 0) {
             recHTML += `<div class="rec-card"><strong>Defensiva:</strong> Activar cupones en ASINs Top para recuperar share frente al líder.</div>`;
        }
        if (amazonChoiceCount === 0) {
             recHTML += `<div class="rec-card"><strong>Conversión:</strong> Optimizar keywords backend para recuperar Amazon Choice.</div>`;
        }
        if (highRankLowShare.length > 0) {
            recHTML += `<div class="rec-card"><strong>CTR:</strong> A/B Testing de imagen principal en los ASINs bien posicionados pero con pocos clics.</div>`;
        } else {
            recHTML += `<div class="rec-card"><strong>Expansión:</strong> Tu eficiencia es buena. Considera lanzar variantes o aumentar PPC en keywords genéricas.</div>`;
        }

        recList.innerHTML = recHTML;
        
        // --- 5. Otros Insights ---
        const otherList = document.getElementById('other_insights');
        otherList.innerHTML = `
            <li class="insight-item"><span class="material-icons insight-icon">search</span> <strong>Volumen:</strong> Mercado activo con keywords de alto tráfico.</li>
            <li class="insight-item"><span class="material-icons insight-icon">group</span> <strong>Fragmentación:</strong> ${Object.keys(d.brands).length} marcas compitiendo activamente.</li>
        `;
    }

    // ------------------------------------------------------------------
    // 6. FUNCIONES INTERACTIVAS (PESTAÑA 2)
    // ------------------------------------------------------------------
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId === 'static' ? 'static-report' : 'interactive-report').classList.add('active');
        event.target.classList.add('active');
    }

    function setupInteractive() {
        // Llenar selectores
        const weekSel = document.getElementById('weekSelector');
        uniqueWeeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = `Semana: ${w}`;
            weekSel.add(opt);
        });

        const compSel = document.getElementById('competitorSelector');
        topCompetitors.forEach(c => {
             const opt = document.createElement('option');
             opt.value = c;
             opt.text = `Vs: ${c}`;
             compSel.add(opt);
        });
        
        updateInteractive(); // Carga inicial
    }

    function updateInteractive() {
        const selectedWeek = document.getElementById('weekSelector').value;
        const selectedComp = document.getElementById('competitorSelector').value;
        
        const weekData = marketData.filter(d => d.week === selectedWeek);
        
        // Datos Nosotros (Agregado)
        const usData = weekData.filter(d => d.brand === ourBrand);
        const usMetrics = aggregateMetrics(usData);
        
        // Datos Competidor (Agregado)
        const compData = weekData.filter(d => d.brand === selectedComp);
        const compMetrics = aggregateMetrics(compData);

        // Renderizar Tabla
        document.getElementById('us_title').innerText = ourBrand;
        document.getElementById('comp_title').innerText = selectedComp;

        updateMetric('us_price', usMetrics.price, '€');
        updateMetric('us_share', usMetrics.share, '%');
        updateMetric('us_rank', usMetrics.rank, '');
        updateMetric('us_deals', usMetrics.deals, ' días');

        updateMetric('comp_price', compMetrics.price, '€');
        updateMetric('comp_share', compMetrics.share, '%');
        updateMetric('comp_rank', compMetrics.rank, '');
        updateMetric('comp_deals', compMetrics.deals, ' días');
        
        // Análisis de Brecha
        const priceGap = ((usMetrics.price - compMetrics.price) / compMetrics.price) * 100;
        let gapText = "";
        
        if (Math.abs(priceGap) > 5) {
            gapText += `Tu precio es un <strong>${Math.abs(priceGap).toFixed(1)}% ${priceGap > 0 ? 'más alto' : 'más bajo'}</strong>. `;
        } else {
            gapText += "Precios alineados. ";
        }
        
        if (usMetrics.share > compMetrics.share) {
            gapText += "Ganas en cuota de mercado. ";
        } else {
            gapText += "El competidor tiene mayor cuota. ";
            if (compMetrics.deals > usMetrics.deals) gapText += "Posible causa: mayor actividad promocional.";
            else if (compMetrics.rank < usMetrics.rank) gapText += "Causa principal: mejor posicionamiento orgánico.";
        }
        
        document.getElementById('gap_analysis').innerHTML = gapText;
    }

    function aggregateMetrics(rows) {
        if (rows.length === 0) return { price: 0, share: 0, rank: 0, deals: 0 };
        const totalClicks = rows.reduce((s, r) => s + r.clicks, 0);
        // Weighted Averages
        let wPrice = 0, wRank = 0, wDeals = 0;
        let totalShare = 0;
        
        rows.forEach(r => {
            wPrice += r.price;
            wRank += r.average_organic_rank; // Promedio simple para rank (opcional ponderado)
            wDeals += r.weekly_number_of_days_with_deal;
            totalShare += r.click_share;
        });
        
        return {
            price: (wPrice / rows.length).toFixed(2),
            share: totalShare.toFixed(2),
            rank: (wRank / rows.length).toFixed(1),
            deals: Math.round(wDeals / rows.length) // Promedio de días
        };
    }

    function updateMetric(id, val, suffix) {
        document.getElementById(id).innerText = val + suffix;
    }

</script>

</body>
</html>