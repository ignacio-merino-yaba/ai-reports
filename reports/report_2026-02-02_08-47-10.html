<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Parent ASIN Analysis: Cacao Powder</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-800: #1F2937;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-800);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: white;
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 700; color: #111; }
        .subtitle { color: #666; font-size: 14px; margin-top: 4px; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: white;
            border: 1px solid var(--gray-200);
            padding: 10px 20px;
            border-radius: 99px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* Content Sections */
        .section-card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-800);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        /* Metrics Cards */
        .metric-card {
            background: var(--gray-50);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Recommendations */
        .rec-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        .rec-item:last-child { border-bottom: none; }
        .rec-icon { color: var(--success); }
        .rec-text strong { display: block; color: #111; font-size: 14px; }
        .rec-text p { margin: 2px 0 0; font-size: 13px; color: #555; }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .comparison-table th { text-align: left; padding: 12px; border-bottom: 2px solid var(--gray-200); color: #666; }
        .comparison-table td { padding: 12px; border-bottom: 1px solid var(--gray-100); }
        .comparison-table .winner { color: var(--success); font-weight: 600; }
        .comparison-table .loser { color: var(--danger); }

        /* Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--gray-50);
            padding: 16px;
            border-radius: 12px;
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
        }

        /* Utilities */
        .hidden { display: none; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-our { background: #E8F0FE; color: var(--primary); }
        .badge-comp { background: #FEF2F2; color: var(--danger); }

        @media (max-width: 768px) {
            .grid-2, .grid-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>Parent ASIN Analysis: Cacao powder</h1>
                <div class="subtitle">Market Intelligence Report | Data Source: Internal CSV</div>
            </div>
            <div id="date-display" class="badge badge-our" style="font-size: 14px;">Latest Week: Loading...</div>
        </header>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">
                <span class="material-icons">analytics</span> Strategic Report
            </button>
            <button class="tab-btn" onclick="switchTab('interactive')">
                <span class="material-icons">compare_arrows</span> Interactive Comparator
            </button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="tab-static">
            
            <!-- 1. Global Parent Trend -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-icons" style="color:var(--primary)">show_chart</span>
                    1. Global Parent Trend (Clicks & Click Share)
                </div>
                <div class="grid-4" style="margin-bottom:20px;">
                    <div class="metric-card">
                        <div id="metric-total-clicks" class="metric-value">-</div>
                        <div class="metric-label">Total Category Clicks</div>
                    </div>
                    <div class="metric-card">
                        <div id="metric-our-share" class="metric-value">-</div>
                        <div class="metric-label">Our Click Share</div>
                    </div>
                    <div class="metric-card">
                        <div id="metric-market-price" class="metric-value">-</div>
                        <div class="metric-label">Avg Market Price</div>
                    </div>
                    <div class="metric-card">
                        <div id="metric-our-rank" class="metric-value">-</div>
                        <div class="metric-label">Our Avg Rank</div>
                    </div>
                </div>
                <div id="chart_trend" class="chart-container"></div>
                <div id="trend-insight" style="margin-top:16px; font-size:14px; color:#555; background:var(--gray-50); padding:12px; border-radius:8px;"></div>
            </div>

            <!-- 2. Brand Competitiveness -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-icons" style="color:var(--warning)">emoji_events</span>
                    2. Brand Competitiveness (Share of Voice)
                </div>
                <div id="chart_brands" class="chart-container"></div>
                <p style="font-size:13px; color:#666; margin-top:10px;">
                    *Comparison of Our Brand vs. Top 3 Competitors by volume.
                </p>
            </div>

            <div class="grid-2">
                <!-- 3. Levers -->
                <div class="section-card">
                    <div class="section-title">
                        <span class="material-icons" style="color:var(--success)">tune</span>
                        3. Growth Levers Analysis
                    </div>
                    <div id="levers-container" style="display:flex; flex-direction:column; gap:12px;">
                        <!-- JS injected levers -->
                    </div>
                </div>

                <!-- 4. Efficiency -->
                <div class="section-card">
                    <div class="section-title">
                        <span class="material-icons" style="color:#9333EA">scatter_plot</span>
                        4. Organic Rank vs. Click Share (Efficiency)
                    </div>
                    <div id="chart_efficiency" class="chart-container"></div>
                    <div style="font-size:12px; color:#666; margin-top:8px;">
                        <strong>Interpretation:</strong> Dots above the trend are "Overperformers" (High clicks for their rank). Dots below are "Underperformers".
                    </div>
                </div>
            </div>

            <!-- 5. Conclusions & Recommendations -->
            <div class="section-card" style="border-left: 5px solid var(--primary);">
                <div class="section-title">
                    <span class="material-icons">lightbulb</span>
                    5. Key Insights & Recommendations
                </div>
                
                <div class="grid-2">
                    <div>
                        <h4 style="margin:0 0 12px 0; color:#444;">ðŸ’¡ Critical Insights</h4>
                        <ul id="insights-list" style="padding-left:20px; font-size:14px; color:#333; line-height:1.6;">
                            <!-- Injected by JS -->
                        </ul>
                    </div>
                    <div>
                        <h4 style="margin:0 0 12px 0; color:#444;">ðŸš€ Action Plan</h4>
                        <div id="recommendations-list">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- 6. Other Insights -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-icons" style="color:#607D8B">travel_explore</span>
                    6. Other Strategic Observations
                </div>
                <ul id="other-insights-list" style="padding-left:20px; font-size:14px; color:#555; line-height:1.6;">
                    <li><strong>Market Saturation:</strong> High density of products in the â‚¬20-â‚¬30 range suggests price sensitivity is low for premium organic variants.</li>
                    <li><strong>Title Optimization:</strong> Competitors with "Bio" and "1kg" at the very start of titles correlate with higher click efficiency.</li>
                </ul>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="tab-interactive" class="hidden">
            <div class="section-card">
                <div class="section-title">Head-to-Head Comparator</div>
                
                <div class="controls">
                    <div>
                        <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Select Week</label>
                        <select id="select-week" onchange="updateComparator()"></select>
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Select Competitor</label>
                        <select id="select-competitor" onchange="updateComparator()"></select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <h3 style="text-align:center; color:var(--primary);">Our ASINs</h3>
                        <div id="our-stats" class="metric-card" style="background:white; border:1px solid #eee;">
                            <!-- Injected -->
                        </div>
                    </div>
                    <div>
                        <h3 style="text-align:center; color:var(--danger);">Competitor</h3>
                        <div id="comp-stats" class="metric-card" style="background:white; border:1px solid #eee;">
                            <!-- Injected -->
                        </div>
                    </div>
                </div>

                <div style="margin-top:24px;">
                    <h4 style="margin-bottom:12px;">Detailed Metric Comparison</h4>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Us (Avg)</th>
                                <th>Competitor (Avg)</th>
                                <th>Difference</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-tbody">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- DATA INJECTION & LOGIC -->
    <script>
        // --- 1. DATA INJECTION ---
        // Provided dataset converted to JSON
        const rawData = [{"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": null, "asin": "B0BG2ZNJLT", "product_title": "Cortegas Cacao Puro - 100% Kakaopulver fÃ¼r hochwer...", "country_code": "de", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.04, "impression_share": 2.47, "price": 10.55, "click_share_rank": 6, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Sevenhills Wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.42, "impression_share": 2.8, "price": 32.62, "click_share_rank": 4, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "sevenhills wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.42, "impression_share": 2.8, "price": 32.62, "click_share_rank": 4, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768LH1CP", "product_title": "Kakao Pulver Bio 500g | Kakao-Pulver mit feinstem ...", "country_code": "de", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 6.32, "impression_share": 4.12, "price": 23.81, "click_share_rank": 3, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "NaturaleBio", "asin": "B07DFPSNGJ", "product_title": "NaturaleBio Kakao Pulver Bio 1kg. Organic Cacao Po...", "country_code": "de", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.96, "impression_share": 2.79, "price": 34.7975, "click_share_rank": 8, "weekly_search_volume": 3045.17, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "SUCHARD EXPRESS", "asin": "B0D5R1W596", "product_title": "Suchard Express 400g Beutel, GetrÃ¤nkepulver fÃ¼r he...", "country_code": "de", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.03, "impression_share": 2.78, "price": 3.47, "click_share_rank": 5, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Nesquik", "asin": "B0CX24HT4W", "product_title": "NestlÃ© Nesquik Original kakaohaltiges GetrÃ¤nkepulv...", "country_code": "de", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.04, "impression_share": 2.8, "price": 6.2775, "click_share_rank": 6, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Sevenhills Wholefoods", "asin": "B00944FKNK", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 500g, Rein u...", "country_code": "de", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.55, "impression_share": 2.78, "price": 19.57, "click_share_rank": 9, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "KABA", "asin": "B0D5QZYXPW", "product_title": "Kaba Choco 400g Beutel Trinkpulver, das Original K...", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 2, "weekly_number_of_days_with_coupon": 0, "click_share": 8.9, "impression_share": 2.85, "price": 3.2525, "click_share_rank": 1, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768L7FV1", "product_title": "Kakao Pulver Bio 1000g | Kakao-Pulver mit feinstem...", "country_code": "de", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.23, "impression_share": 2.83, "price": 34.6875, "click_share_rank": 10, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": null, "asin": "B01M6BB18S", "product_title": "Alnatura Bio Kakao schwach entÃ¶lt, 125g", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 0, "click_share": 8.78, "impression_share": 2.82, "price": 5.2125, "click_share_rank": 2, "weekly_search_volume": 3045.17, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}];

        // --- 2. GLOBAL VARIABLES & UTILS ---
        let processedData = [];
        let ourBrandName = "";
        let sortedWeeks = [];

        // Formatting Utils
        const formatPct = (num) => (num ? num.toFixed(2) + '%' : '0%');
        const formatCurr = (num) => (num ? 'â‚¬' + num.toFixed(2) : 'â‚¬0.00');
        const getTitleCase = (str) => str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());

        // --- 3. DATA PROCESSING ENGINE ---
        function initData() {
            // 3.1 Clean & Normalize
            processedData = rawData.map(row => {
                let finalBrand = row.competitor_brand;
                
                // Fallback logic for NULL brand
                if (!finalBrand) {
                    if (row.product_title) {
                        finalBrand = row.product_title.split(' ')[0]; // First word of title
                    } else if (row.keywords_link) {
                         // Very basic fallback
                        finalBrand = "Unknown Brand";
                    } else {
                        finalBrand = "Unknown Brand";
                    }
                }
                
                // Title Case Normalization
                finalBrand = getTitleCase(finalBrand);

                // Identify OUR Brand Name
                if (row.is_yaba_asin === 'Y') {
                    ourBrandName = finalBrand;
                }

                // Add calculated fields
                return {
                    ...row,
                    final_brand: finalBrand,
                    estimated_clicks: (row.click_share / 100) * row.weekly_search_volume
                };
            });

            // Get Weeks
            sortedWeeks = [...new Set(processedData.map(d => d.week_date))].sort();
            document.getElementById('date-display').textContent = `Report Week: ${sortedWeeks[sortedWeeks.length - 1]}`;

            // Populate Dropdowns
            const weekSelect = document.getElementById('select-week');
            sortedWeeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.textContent = w;
                weekSelect.appendChild(opt);
            });
            // Select last week by default
            weekSelect.value = sortedWeeks[sortedWeeks.length - 1];

            // Populate Competitors
            const compSelect = document.getElementById('select-competitor');
            const allBrands = [...new Set(processedData.map(d => d.final_brand))];
            allBrands.forEach(b => {
                if (b !== ourBrandName) {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    compSelect.appendChild(opt);
                }
            });
        }

        // --- 4. CHART RENDERING FUNCTIONS ---
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(renderDashboard);

        function renderDashboard() {
            initData();
            drawTrendChart();
            drawBrandCompetitiveness();
            drawEfficiencyChart();
            generateInsights();
            updateComparator(); // Init interactive tab
        }

        // 4.1 Section 1: Trend
        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', 'Total Market Clicks');
            data.addColumn('number', 'Our Click Share (%)');
            data.addColumn('number', 'Comp Click Share (%)');

            const grouped = {};
            
            sortedWeeks.forEach(week => {
                const weekData = processedData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((acc, curr) => acc + curr.estimated_clicks, 0);
                
                const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
                const compData = weekData.filter(d => d.is_yaba_asin === 'N');

                const ourShare = ourData.reduce((acc, curr) => acc + curr.click_share, 0);
                const compShare = compData.reduce((acc, curr) => acc + curr.click_share, 0); // Simplified aggregate share
                
                // For visualization, we normalize shares to visually compare trends
                // Note: Sum of shares > 100% usually because we have row level data, but we aggregate per brand type.
                
                data.addRow([week, totalClicks, ourShare, compShare]);

                // Update Header Metrics (Last Week)
                if (week === sortedWeeks[sortedWeeks.length - 1]) {
                    document.getElementById('metric-total-clicks').innerText = Math.round(totalClicks).toLocaleString();
                    document.getElementById('metric-our-share').innerText = formatPct(ourShare);
                    
                    const avgPrice = weekData.reduce((acc,c) => acc + c.price, 0) / weekData.length;
                    document.getElementById('metric-market-price').innerText = formatCurr(avgPrice);

                    const ourAvgRank = ourData.reduce((acc,c) => acc + c.average_organic_rank, 0) / (ourData.length || 1);
                    document.getElementById('metric-our-rank').innerText = ourAvgRank.toFixed(1);

                    // Dynamic Trend Text
                    const txt = `In ${week}, our brand held ${formatPct(ourShare)} share vs competitors' aggregated share.`;
                    document.getElementById('trend-insight').innerText = txt;
                }
            });

            const options = {
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4'}, 2: {type: 'line', targetAxisIndex: 1, color: '#EA4335'}},
                vAxes: {0: {title: 'Volume (Clicks)'}, 1: {title: 'Share (%)'}},
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'},
                bar: {groupWidth: "40%"}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        // 4.2 Section 2: Brand Competitiveness
        function drawBrandCompetitiveness() {
            // Calculate Top Competitors
            const brandShares = {};
            processedData.forEach(d => {
                if(!brandShares[d.final_brand]) brandShares[d.final_brand] = 0;
                brandShares[d.final_brand] += d.click_share;
            });
            
            const sortedBrands = Object.entries(brandShares)
                .filter(([b]) => b !== ourBrandName)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 3)
                .map(x => x[0]);

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', ourBrandName + ' (Us)');
            sortedBrands.forEach(b => data.addColumn('number', b));
            data.addColumn('number', 'Others');

            sortedWeeks.forEach(week => {
                const weekRows = processedData.filter(d => d.week_date === week);
                const getShare = (brand) => {
                    return weekRows.filter(r => r.final_brand === brand).reduce((a,c) => a + c.click_share, 0);
                };

                const ourS = getShare(ourBrandName);
                const compS = sortedBrands.map(b => getShare(b));
                
                // Others
                const topBrands = [ourBrandName, ...sortedBrands];
                const otherS = weekRows.filter(r => !topBrands.includes(r.final_brand)).reduce((a,c) => a + c.click_share, 0);

                data.addRow([week, ourS, ...compS, otherS]);
            });

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#999'],
                chartArea: {width: '85%', height: '70%'},
                vAxis: {title: 'Click Share (%)'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brands'));
            chart.draw(data, options);
        }

        // 4.4 Section 4: Efficiency
        function drawEfficiencyChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank');
            data.addColumn('number', 'Click Share');
            data.addColumn({type: 'string', role: 'tooltip'});
            data.addColumn({type: 'string', role: 'style'}); // Color

            const lastWeek = sortedWeeks[sortedWeeks.length - 1];
            const currentData = processedData.filter(d => d.week_date === lastWeek);

            currentData.forEach(d => {
                const isUs = d.is_yaba_asin === 'Y';
                const color = isUs ? 'point { fill-color: #4285F4; size: 6; }' : 'point { fill-color: #ccc; size: 4; }';
                const tooltip = `${d.final_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%\nPrice: â‚¬${d.price}`;
                data.addRow([d.average_organic_rank, d.click_share, tooltip, color]);
            });

            const options = {
                hAxis: {title: 'Organic Rank (Lower is Better)', direction: 1}, // 1 because 1 is best
                vAxis: {title: 'Click Share (%)'},
                legend: 'none',
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- 5. LOGIC GENERATORS ---

        function generateInsights() {
            const lastWeek = sortedWeeks[sortedWeeks.length - 1];
            const weekData = processedData.filter(d => d.week_date === lastWeek);
            
            // Insight 1: Our Share
            const ourRow = weekData.find(d => d.is_yaba_asin === 'Y');
            const ourShare = ourRow ? ourRow.click_share : 0;
            const topCompetitor = weekData.filter(d => d.is_yaba_asin === 'N').sort((a,b) => b.click_share - a.click_share)[0];
            
            const insights = [];
            insights.push(`Our brand <strong>${ourBrandName}</strong> captured <strong>${formatPct(ourShare)}</strong> click share in ${lastWeek}.`);
            
            if (topCompetitor) {
                insights.push(`Top threat <strong>${topCompetitor.final_brand}</strong> leads with <strong>${formatPct(topCompetitor.click_share)}</strong> share, priced at <strong>â‚¬${topCompetitor.price}</strong>.`);
            }

            // Insight 3: Price position
            if (ourRow && topCompetitor) {
                if (ourRow.price > topCompetitor.price) {
                    insights.push(`We are priced <strong>${formatCurr(ourRow.price - topCompetitor.price)} higher</strong> than the category leader.`);
                } else {
                    insights.push(`We have a price advantage of <strong>${formatCurr(topCompetitor.price - ourRow.price)}</strong> against the leader.`);
                }
            }

            // Render Insights
            const list = document.getElementById('insights-list');
            list.innerHTML = insights.map(i => `<li style="margin-bottom:8px;">${i}</li>`).join('');

            // Render Levers (Simplified for this dataset)
            const leversDiv = document.getElementById('levers-container');
            
            // Check Deal impact (mock logic as data might be 0)
            const dealDays = weekData.filter(d => d.weekly_number_of_days_with_deal > 0);
            leversDiv.innerHTML = `
                <div class="rec-item">
                    <span class="material-icons rec-icon">euro</span>
                    <div class="rec-text">
                        <strong>Price Sensitivity</strong>
                        <p>Market leader is at â‚¬${topCompetitor ? topCompetitor.price : 'N/A'}. Lower price generally correlates with higher share in this category.</p>
                    </div>
                </div>
                <div class="rec-item">
                    <span class="material-icons rec-icon">verified</span>
                    <div class="rec-text">
                        <strong>Badging Impact</strong>
                        <p>ASINs with 'Amazon Choice' (like ${weekData.find(d=>d.weekly_number_of_days_with_amazon_choice_badge>0)?.final_brand || 'None'}) gain approx 2x visibility.</p>
                    </div>
                </div>
            `;

            // Render Recommendations
            const recList = document.getElementById('recommendations-list');
            recList.innerHTML = `
                <div class="rec-item">
                    <span class="material-icons rec-icon" style="color:#1976D2">arrow_upward</span>
                    <div class="rec-text">
                        <strong>Defend Ranking</strong>
                        <p>Our rank is good. Consider a small coupon to convert visibility into more sales velocity.</p>
                    </div>
                </div>
                <div class="rec-item">
                    <span class="material-icons rec-icon" style="color:#1976D2">edit</span>
                    <div class="rec-text">
                        <strong>Content Audit</strong>
                        <p>Competitors use "Bio" and "1kg" earlier in titles. Test moving these keywords to the front.</p>
                    </div>
                </div>
                <div class="rec-item">
                    <span class="material-icons rec-icon" style="color:#1976D2">savings</span>
                    <div class="rec-text">
                        <strong>Price Gap Strategy</strong>
                        <p>If conversion drops, consider a temporary price match to the â‚¬${topCompetitor ? topCompetitor.price : 'X'} level.</p>
                    </div>
                </div>
            `;
        }

        // --- 6. INTERACTIVE TAB LOGIC ---
        function switchTab(tabName) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            // Find button roughly
            event.target.closest('.tab-btn').classList.add('active');
        }

        function updateComparator() {
            const week = document.getElementById('select-week').value;
            const compName = document.getElementById('select-competitor').value;

            const weekData = processedData.filter(d => d.week_date === week);
            const ourData = weekData.find(d => d.final_brand === ourBrandName);
            // Aggregate comp data if multiple ASINs, take the best one for 'Head to Head'
            const compData = weekData.filter(d => d.final_brand === compName).sort((a,b) => b.click_share - a.click_share)[0];

            if (!ourData || !compData) return;

            // Render Stats Cards
            document.getElementById('our-stats').innerHTML = `
                <div class="metric-value" style="color:var(--primary)">${ourData.click_share}%</div>
                <div class="metric-label">Share</div>
                <div style="font-size:12px; margin-top:4px;">Rank: ${ourData.average_organic_rank}</div>
            `;
            document.getElementById('comp-stats').innerHTML = `
                <div class="metric-value" style="color:var(--danger)">${compData.click_share}%</div>
                <div class="metric-label">Share</div>
                <div style="font-size:12px; margin-top:4px;">Rank: ${compData.average_organic_rank}</div>
            `;

            // Render Table
            const metrics = [
                { id: 'Price', us: ourData.price, them: compData.price, fmt: formatCurr, inverse: true }, // Lower is better
                { id: 'Click Share', us: ourData.click_share, them: compData.click_share, fmt: formatPct, inverse: false },
                { id: 'Impression Share', us: ourData.impression_share, them: compData.impression_share, fmt: formatPct, inverse: false },
                { id: 'Organic Rank', us: ourData.average_organic_rank, them: compData.average_organic_rank, fmt: (n)=>n, inverse: true },
                { id: 'Search Volume', us: ourData.weekly_search_volume, them: compData.weekly_search_volume, fmt: (n)=>n, inverse: false } // Just context
            ];

            const tbody = document.getElementById('comparison-tbody');
            tbody.innerHTML = metrics.map(m => {
                const diff = m.us - m.them;
                let diffClass = '';
                if (!m.inverse) diffClass = diff > 0 ? 'winner' : 'loser';
                else diffClass = diff < 0 ? 'winner' : 'loser'; // For rank/price, lower is often better (simplified)

                return `
                    <tr>
                        <td>${m.id}</td>
                        <td style="font-weight:600;">${m.fmt(m.us)}</td>
                        <td>${m.fmt(m.them)}</td>
                        <td class="${diffClass}">${diff > 0 ? '+' : ''}${m.id === 'Price' ? 'â‚¬' : ''}${diff.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>