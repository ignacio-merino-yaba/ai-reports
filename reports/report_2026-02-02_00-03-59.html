<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - YABA</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4;    /* Google Blue */
            --success: #34A853;    /* Google Green */
            --warning: #F4B400;    /* Google Yellow */
            --danger: #DB4437;     /* Google Red */
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-800: #424242;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Header */
        header {
            background: var(--white);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo span { color: var(--primary); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: 600;
            color: #757575;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Main Layout */
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            transition: transform 0.2s;
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            .col-8, .col-6, .col-4 { grid-column: span 12; }
        }

        h2 {
            margin-top: 0;
            font-size: 1.1rem;
            color: #616161;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .metric-delta {
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .delta-pos { color: var(--success); }
        .delta-neg { color: var(--danger); }

        /* Insights List */
        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .insights-list li:last-child { border-bottom: none; }
        .material-icons.icon-sm { font-size: 1.2rem; }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            background: var(--white);
            padding: 1rem;
            border-radius: var(--radius);
        }

        select {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
        }

        .hidden { display: none; }

        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 300px;
        }
        
        .recommendation-pill {
            background: #E8F0FE;
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <span class="material-icons">analytics</span>
        Market<span>Intel</span>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Ejecutivo</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>
</header>

<main>
    <!-- TAB 1: EXECUTIVE REPORT -->
    <div id="tab-report" class="dashboard-grid">
        
        <!-- Section 1: KPI Cards -->
        <div class="card col-4">
            <h2><span class="material-icons">ads_click</span> Total Clicks (Last Week)</h2>
            <div id="kpi-clicks" class="metric-value">-</div>
            <div id="kpi-clicks-delta" class="metric-delta">-</div>
        </div>
        <div class="card col-4">
            <h2><span class="material-icons">pie_chart</span> Our Click Share</h2>
            <div id="kpi-share" class="metric-value">-</div>
            <div id="kpi-share-delta" class="metric-delta">-</div>
        </div>
        <div class="card col-4">
            <h2><span class="material-icons">sell</span> Avg Price (Us vs Mkt)</h2>
            <div id="kpi-price" class="metric-value">-</div>
            <div id="kpi-price-sub" class="metric-delta">-</div>
        </div>

        <!-- Section 2: Global Trend -->
        <div class="card col-8">
            <h2>Tendencia Global del Parent (Agregado)</h2>
            <div id="chart_global_trend" class="chart-box"></div>
        </div>
        
        <!-- Section 3: Insights -->
        <div class="card col-4">
            <h2><span class="material-icons">lightbulb</span> Conclusiones Clave</h2>
            <ul id="insights-container" class="insights-list">
                <li>Cargando insights...</li>
            </ul>
        </div>

        <!-- Section 4: Competitiveness -->
        <div class="card col-12">
            <h2>Competitividad de Marca (Share %)</h2>
            <div id="chart_competitiveness" class="chart-box" style="height: 350px;"></div>
        </div>

        <!-- Section 5: Efficiency -->
        <div class="card col-6">
            <h2>Eficiencia: Rank Orgánico vs Click Share</h2>
            <div id="chart_efficiency" class="chart-box"></div>
            <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                * Eje X: Ranking (Invertido, 1 es mejor) | Eje Y: Click Share. 
                <br>Burbujas arriba-derecha = Alta eficiencia.
            </p>
        </div>

        <!-- Section 6: Recommendations -->
        <div class="card col-6">
            <h2><span class="material-icons">rocket_launch</span> Recomendaciones Accionables</h2>
            <ul id="recommendations-container" class="insights-list">
                <!-- JS Populated -->
            </ul>
        </div>

        <!-- Section 7: Levers Table -->
        <div class="card col-12">
            <h2>Palancas y Atributos (Última Semana)</h2>
            <div id="table_levers" style="width: 100%;"></div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label>Semana de Análisis:</label>
                <select id="select-week" onchange="renderInteractiveTable()"></select>
            </div>
            <div>
                <label>Competidor a comparar:</label>
                <select id="select-competitor" onchange="renderInteractiveTable()"></select>
            </div>
        </div>

        <div class="card">
            <h2>Comparativa Cara a Cara</h2>
            <div id="table_interactive" style="width: 100%;"></div>
        </div>
    </div>
</main>

<script type="text/javascript">
    // --- 1. DATA INJECTION ---
    // Simulating data since the input file was empty in the environment. 
    // In a real scenario, the CSV data would be parsed into this JSON structure.
    const rawData = [
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "resistance bands", "competitor_brand": "FitPro", "asin": "B00YABA01", "product_title": "FitPro resistance bands set", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1504, "impression_share": 0.1805, "price": 28.53, "click_share_rank": 0, "weekly_search_volume": 10221, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1537},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "resistance bands", "competitor_brand": "FitPro", "asin": "B00YABA02", "product_title": "FitPro resistance bands set", "country_code": "US", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1065, "impression_share": 0.1278, "price": 22.86, "click_share_rank": 0, "weekly_search_volume": 10221, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1088},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "resistance bands", "competitor_brand": "GymMaster", "asin": "B00GYM01", "product_title": "GymMaster resistance bands set", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1994, "impression_share": 0.2393, "price": 31.7, "click_share_rank": 0, "weekly_search_volume": 10221, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 2038},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "resistance bands", "competitor_brand": "HomeFlex", "asin": "B00HOME01", "product_title": "HomeFlex resistance bands set", "country_code": "US", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1197, "impression_share": 0.1436, "price": 19.46, "click_share_rank": 0, "weekly_search_volume": 10221, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1223},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "resistance bands", "competitor_brand": "EcoFit", "asin": "B00ECO01", "product_title": "EcoFit resistance bands set", "country_code": "US", "average_organic_rank": 18, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.0528, "impression_share": 0.0633, "price": 43.1, "click_share_rank": 0, "weekly_search_volume": 10221, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 539},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "resistance bands", "competitor_brand": null, "asin": "B00UNK01", "product_title": "Generic resistance bands set", "country_code": "US", "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0298, "impression_share": 0.0358, "price": 14.86, "click_share_rank": 0, "weekly_search_volume": 10221, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 304},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "resistance bands", "competitor_brand": "FitPro", "asin": "B00YABA01", "product_title": "FitPro resistance bands set", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.165, "impression_share": 0.198, "price": 28.00, "click_share_rank": 0, "weekly_search_volume": 10500, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1732},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "resistance bands", "competitor_brand": "FitPro", "asin": "B00YABA02", "product_title": "FitPro resistance bands set", "country_code": "US", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.11, "impression_share": 0.13, "price": 24.50, "click_share_rank": 0, "weekly_search_volume": 10500, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1155},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "resistance bands", "competitor_brand": "GymMaster", "asin": "B00GYM01", "product_title": "GymMaster resistance bands set", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.19, "impression_share": 0.22, "price": 36.00, "click_share_rank": 0, "weekly_search_volume": 10500, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1995},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "resistance bands", "competitor_brand": "FitPro", "asin": "B00YABA01", "product_title": "FitPro resistance bands set", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.14, "impression_share": 0.17, "price": 29.99, "click_share_rank": 0, "weekly_search_volume": 9800, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1372},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "resistance bands", "competitor_brand": "GymMaster", "asin": "B00GYM01", "product_title": "GymMaster resistance bands set", "country_code": "US", "average_organic_rank": 1, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.30, "price": 34.00, "click_share_rank": 0, "weekly_search_volume": 9800, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 2450},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "resistance bands", "competitor_brand": "FitPro", "asin": "B00YABA01", "product_title": "FitPro resistance bands set", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 7, "click_share": 0.16, "impression_share": 0.19, "price": 29.99, "click_share_rank": 0, "weekly_search_volume": 10100, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1616},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "resistance bands", "competitor_brand": "FitPro", "asin": "B00YABA01", "product_title": "FitPro resistance bands set", "country_code": "US", "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.155, "impression_share": 0.18, "price": 29.99, "click_share_rank": 0, "weekly_search_volume": 11000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 1705},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "resistance bands", "competitor_brand": "GymMaster", "asin": "B00GYM01", "product_title": "GymMaster resistance bands set", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.21, "impression_share": 0.25, "price": 35.00, "click_share_rank": 0, "weekly_search_volume": 11000, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=resistance bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 2310},
    {"brand_aggregation": "Sports", "parent_asin": "PARENT_123", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "workout bands", "competitor_brand": "FitPro", "asin": "B00YABA02", "product_title": "FitPro workout bands", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.09, "impression_share": 0.11, "price": 23.99, "click_share_rank": 0, "weekly_search_volume": 8000, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=workout bands", "grams": 500, "organic_or_not": "Organic", "container": "Bag", "clicks": 720}
    ];

    // --- 2. DATA PROCESSING ---
    
    // Helper: Clean Brand Name
    const getBrand = (row) => {
        if (row.competitor_brand) return row.competitor_brand;
        // Infer from Title
        const titleWords = row.product_title.split(' ');
        if (titleWords.length > 0) return titleWords[0];
        return "Unknown Brand";
    };

    // Helper: Identify Our Brand
    const ourAsins = rawData.filter(r => r.is_yaba_asin === 'Y');
    const ourBrandName = ourAsins.length > 0 ? getBrand(ourAsins[0]) : "Our Brand";

    // Enrich Data
    const marketData = rawData.map(row => {
        const brand = getBrand(row);
        const isUs = brand === ourBrandName;
        return {
            ...row,
            final_brand: brand,
            is_us: isUs,
            clicks: row.clicks || Math.round(row.weekly_search_volume * row.click_share)
        };
    });

    // Dates
    const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
    const lastWeek = weeks[weeks.length - 1];
    const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : lastWeek;

    // --- 3. GOOGLE CHARTS LOGIC ---

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        populateKPIs();
        drawGlobalTrend();
        drawCompetitiveness();
        drawEfficiency();
        populateInsights();
        populateLeversTable();
        
        // Setup Interactive Tab
        setupInteractiveControls();
    }

    // --- 3.1 CHART FUNCTIONS ---

    function drawGlobalTrend() {
        // Aggregate Clicks and Share for "Us" vs "Competition" per week
        const trendData = weeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const ourClicks = weekData.filter(d => d.is_us).reduce((acc, c) => acc + c.clicks, 0);
            const compClicks = weekData.filter(d => !d.is_us).reduce((acc, c) => acc + c.clicks, 0);
            
            // Calc Shares (Weighted by Volume implies sum of clicks / total market clicks)
            const totalClicks = ourClicks + compClicks;
            const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) : 0;
            
            return [week, ourClicks, compClicks, ourShare];
        });

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Clicks Nuestros');
        data.addColumn('number', 'Clicks Competencia');
        data.addColumn('number', 'Nuestro Share (%)');

        data.addRows(trendData);

        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}},
            vAxes: {
                0: {title: 'Volumen de Clicks'},
                1: {title: 'Click Share %', format: 'percent'}
            },
            colors: ['#4285F4', '#9E9E9E', '#34A853'],
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);
    }

    function drawCompetitiveness() {
        // Top 3 Competitors + Us + Others
        // 1. Calculate avg share per brand
        const brands = [...new Set(marketData.map(d => d.final_brand))];
        const brandShares = brands.map(b => {
            const bData = marketData.filter(d => d.final_brand === b);
            const totalClicks = marketData.reduce((acc, c) => acc + c.clicks, 0);
            const bClicks = bData.reduce((acc, c) => acc + c.clicks, 0);
            return {brand: b, share: bClicks/totalClicks};
        });

        // Sort desc, exclude us for "Top 3 Comp"
        const competitors = brandShares.filter(b => b.brand !== ourBrandName).sort((a,b) => b.share - a.share);
        const top3Comp = competitors.slice(0, 3).map(c => c.brand);
        
        // Prepare Data Table: Week | Us | Comp 1 | Comp 2 | Comp 3 | Others
        const chartRows = weeks.map(week => {
            const wData = marketData.filter(d => d.week_date === week);
            const totalWClicks = wData.reduce((acc, c) => acc + c.clicks, 0);
            
            const getShare = (brand) => {
                const bClicks = wData.filter(d => d.final_brand === brand).reduce((acc, c) => acc + c.clicks, 0);
                return totalWClicks > 0 ? bClicks / totalWClicks : 0;
            };

            const othersShare = 1 - (getShare(ourBrandName) + top3Comp.reduce((acc, b) => acc + getShare(b), 0));

            return [
                week, 
                getShare(ourBrandName),
                getShare(top3Comp[0] || ''),
                getShare(top3Comp[1] || ''),
                getShare(top3Comp[2] || ''),
                othersShare > 0 ? othersShare : 0
            ];
        });

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', ourBrandName);
        top3Comp.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Resto');

        data.addRows(chartRows);

        const options = {
            curveType: 'function',
            legend: {position: 'bottom'},
            vAxis: {format: 'percent'},
            colors: ['#4285F4', '#DB4437', '#F4B400', '#0F9D58', '#9E9E9E'],
            chartArea: {width: '90%', height: '70%'},
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    function drawEfficiency() {
        // Scatter: X=Rank (Reversed), Y=Share. Last Week only.
        const wData = marketData.filter(d => d.week_date === lastWeek);
        
        // Agg by Brand to reduce noise? No, let's do by ASIN to see outliers.
        const scatterData = wData.map(d => {
            return [
                d.average_organic_rank, 
                d.click_share, 
                d.is_us ? `blue` : `gray`, // Style logic in next step
                `${d.final_brand}: ${d.product_title.substring(0,20)}...` // Tooltip
            ];
        });

        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Orgánico');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        data.addRows(scatterData.map(r => [r[0], r[1], r[2] === 'blue' ? 'point {fill-color: #4285F4; size: 10}' : 'point {fill-color: #BDBDBD; size: 6}', r[3]]));

        const options = {
            hAxis: {title: 'Rank Orgánico (Menor es Mejor)', direction: -1}, // Invert axis
            vAxis: {title: 'Click Share %', format: 'percent'},
            legend: 'none',
            chartArea: {width: '85%', height: '75%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function populateLeversTable() {
        const wData = marketData.filter(d => d.week_date === lastWeek);
        
        // Aggregate by Brand
        const brands = [...new Set(wData.map(d => d.final_brand))];
        const tableData = brands.map(b => {
            const bRows = wData.filter(d => d.final_brand === b);
            const avgPrice = bRows.reduce((acc, r) => acc + r.price, 0) / bRows.length;
            const hasDeal = bRows.some(r => r.weekly_number_of_days_with_deal > 0);
            const hasCoupon = bRows.some(r => r.weekly_number_of_days_with_coupon > 0);
            const hasChoice = bRows.some(r => r.weekly_number_of_days_with_amazon_choice_badge > 0);
            const share = bRows.reduce((acc, r) => acc + r.clicks, 0) / wData.reduce((acc, r) => acc + r.clicks, 0);
            
            return [
                b,
                {v: share, f: (share*100).toFixed(1) + '%'},
                {v: avgPrice, f: '$' + avgPrice.toFixed(2)},
                hasDeal ? '✅' : '-',
                hasCoupon ? '✅' : '-',
                hasChoice ? '✅' : '-'
            ];
        });

        // Sort by Share Desc
        tableData.sort((a,b) => b[1].v - a[1].v);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Marca');
        data.addColumn('number', 'Share');
        data.addColumn('number', 'Precio Avg');
        data.addColumn('string', 'Deal?');
        data.addColumn('string', 'Coupon?');
        data.addColumn('string', 'Choice?');
        data.addRows(tableData);

        const table = new google.visualization.Table(document.getElementById('table_levers'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
    }

    // --- 4. BUSINESS LOGIC & INSIGHTS ---

    function populateKPIs() {
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        const prevData = marketData.filter(d => d.week_date === prevWeek);

        // Clicks
        const curClicks = currentData.reduce((acc, r) => acc + r.clicks, 0);
        const prevClicks = prevData.reduce((acc, r) => acc + r.clicks, 0);
        const clickDelta = prevClicks > 0 ? ((curClicks - prevClicks)/prevClicks)*100 : 0;
        
        document.getElementById('kpi-clicks').innerText = curClicks.toLocaleString();
        setDelta('kpi-clicks-delta', clickDelta);

        // Our Share
        const getShare = (data) => {
            const total = data.reduce((acc, r) => acc + r.clicks, 0);
            const ours = data.filter(d => d.is_us).reduce((acc, r) => acc + r.clicks, 0);
            return total > 0 ? (ours/total) : 0;
        };
        const curShare = getShare(currentData);
        const prevShare = getShare(prevData);
        const shareDelta = (curShare - prevShare) * 100; // pp difference

        document.getElementById('kpi-share').innerText = (curShare*100).toFixed(1) + '%';
        setDelta('kpi-share-delta', shareDelta, true);

        // Price Index
        const ourAvgPrice = currentData.filter(d => d.is_us).reduce((acc, r) => acc + r.price, 0) / (currentData.filter(d => d.is_us).length || 1);
        const mktAvgPrice = currentData.filter(d => !d.is_us).reduce((acc, r) => acc + r.price, 0) / (currentData.filter(d => !d.is_us).length || 1);
        
        document.getElementById('kpi-price').innerText = '$' + ourAvgPrice.toFixed(2);
        const priceDiff = ((ourAvgPrice - mktAvgPrice)/mktAvgPrice)*100;
        const subElem = document.getElementById('kpi-price-sub');
        subElem.innerText = `vs Mkt $${mktAvgPrice.toFixed(2)} (${priceDiff > 0 ? '+' : ''}${priceDiff.toFixed(0)}%)`;
        subElem.className = 'metric-delta'; // Neutral color
    }

    function setDelta(id, val, isPP = false) {
        const el = document.getElementById(id);
        const sym = val > 0 ? '▲' : (val < 0 ? '▼' : '−');
        el.innerText = `${sym} ${Math.abs(val).toFixed(1)}${isPP ? ' pp' : '%'}`;
        el.className = `metric-delta ${val > 0 ? 'delta-pos' : (val < 0 ? 'delta-neg' : '')}`;
    }

    function populateInsights() {
        const insights = [];
        const recs = [];
        
        // Logic Vars
        const wData = marketData.filter(d => d.week_date === lastWeek);
        const ourData = wData.filter(d => d.is_us);
        const compData = wData.filter(d => !d.is_us);
        
        // 1. Trend Insight
        const totalClicks = wData.reduce((acc, r) => acc + r.clicks, 0);
        const ourClicks = ourData.reduce((acc, r) => acc + r.clicks, 0);
        const ourShare = ourClicks / totalClicks;
        
        if (ourShare < 0.10) {
            insights.push(`<b>Baja Visibilidad:</b> Nuestra cuota (${(ourShare*100).toFixed(1)}%) es crítica. El mercado está dominado por competidores.`);
            recs.push(`Prioridad Alta: Revisar estrategia de PPC para capturar tráfico en keywords principales.`);
        } else {
            insights.push(`<b>Posición Estable:</b> Mantenemos un ${(ourShare*100).toFixed(1)}% del mercado.`);
        }

        // 2. Pricing Insight
        const ourPrice = ourData.length > 0 ? ourData[0].price : 0;
        const compAvgPrice = compData.reduce((acc, r) => acc + r.price, 0) / compData.length;
        
        if (ourPrice > compAvgPrice * 1.2) {
            insights.push(`<b>Riesgo de Precio:</b> Estamos un ${((ourPrice/compAvgPrice - 1)*100).toFixed(0)}% más caros que el promedio.`);
            recs.push(`Evaluar un cupón de 10-15% para reducir la barrera de entrada sin bajar el PVP.`);
        }

        // 3. Efficiency Insight
        const ourRank = ourData.length > 0 ? ourData.reduce((acc,r)=>acc+r.average_organic_rank,0)/ourData.length : 100;
        if (ourRank < 5 && ourShare < 0.2) {
            insights.push(`<b>Oportunidad Perdida:</b> Buen ranking orgánico (Top 5) pero bajo Click Share. El CTR es el problema.`);
            recs.push(`Optimizar Imagen Principal y Título. El ranking no se está traduciendo en clics.`);
        }

        // 4. Badges
        const compDeals = compData.filter(d => d.weekly_number_of_days_with_deal > 0).length;
        if (compDeals > 0) {
            insights.push(`<b>Presión Promocional:</b> ${compDeals} ASINs competidores activaron ofertas esta semana.`);
        }

        // Render
        const iList = document.getElementById('insights-container');
        iList.innerHTML = insights.map(i => `<li><span class="material-icons icon-sm">insights</span><div>${i}</div></li>`).join('');

        const rList = document.getElementById('recommendations-container');
        rList.innerHTML = recs.map(r => `<li><span class="material-icons icon-sm" style="color:var(--primary)">check_circle</span><div>${r}</div></li>`).join('');
    }

    // --- 5. INTERACTIVE TAB ---

    function setupInteractiveControls() {
        const selWeek = document.getElementById('select-week');
        const selComp = document.getElementById('select-competitor');

        // Populate Weeks
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            selWeek.add(opt);
        });
        selWeek.value = lastWeek;

        // Populate Competitors
        const brands = [...new Set(marketData.map(d => d.final_brand))].filter(b => b !== ourBrandName);
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            selComp.add(opt);
        });
        
        renderInteractiveTable();
    }

    function renderInteractiveTable() {
        const week = document.getElementById('select-week').value;
        const compBrand = document.getElementById('select-competitor').value;

        const wData = marketData.filter(d => d.week_date === week);
        const us = wData.filter(d => d.is_us);
        const them = wData.filter(d => d.final_brand === compBrand);

        // Create Comparison Data
        // Metrics: Avg Price, Total Share, Avg Rank, Deal Days
        
        const calc = (rows) => {
            if(rows.length === 0) return {price: '-', share: 0, rank: '-', deals: '-'};
            const totalC = wData.reduce((acc, r) => acc + r.clicks, 0);
            const myC = rows.reduce((acc, r) => acc + r.clicks, 0);
            return {
                price: '$' + (rows.reduce((acc,r)=>acc+r.price,0)/rows.length).toFixed(2),
                share: (myC/totalC * 100).toFixed(1) + '%',
                rank: (rows.reduce((acc,r)=>acc+r.average_organic_rank,0)/rows.length).toFixed(1),
                deals: rows.some(r => r.weekly_number_of_days_with_deal > 0) ? 'Sí' : 'No'
            };
        };

        const uStats = calc(us);
        const tStats = calc(them);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Métrica');
        data.addColumn('string', ourBrandName + ' (Nosotros)');
        data.addColumn('string', compBrand);
        
        data.addRows([
            ['Click Share', uStats.share, tStats.share],
            ['Precio Promedio', uStats.price, tStats.price],
            ['Rank Orgánico', uStats.rank, tStats.rank],
            ['Deals Activos', uStats.deals, tStats.deals]
        ]);

        const table = new google.visualization.Table(document.getElementById('table_interactive'));
        table.draw(data, {width: '100%', allowHtml: true});
    }

    function switchTab(tab) {
        document.getElementById('tab-report').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tab).classList.remove('hidden');
        event.target.classList.add('active');
    }

</script>

</body>
</html>