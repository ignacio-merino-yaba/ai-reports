<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence Report</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray: #5f6368;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #202124;
        }

        body {
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 400;
            margin: 0;
            color: var(--text);
        }

        .date-badge {
            background: #e8f0fe;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dadce0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 18px;
            color: var(--text);
            margin-bottom: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        /* KPIs */
        .kpi-value {
            font-size: 32px;
            font-weight: 400;
            color: var(--primary);
        }

        .kpi-label {
            font-size: 14px;
            color: var(--gray);
            margin-top: 4px;
        }

        /* Insights List */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f3f4;
        }

        .insight-icon {
            color: var(--primary);
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3);
        }

        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #dadce0;
            font-family: inherit;
            font-size: 14px;
            min-width: 150px;
        }

        /* Comparison Table */
        .comp-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comp-table th, .comp-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
        }
        .comp-table th {
            color: var(--gray);
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
        }
        .highlight-row {
            background-color: #f8f9fa;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            background: var(--gray);
        }
        .badge-deal { background: var(--danger); }
        .badge-choice { background: var(--text); }
        .badge-best { background: var(--warning); color: #000; }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Market Intelligence Report</h1>
            <div style="font-size: 14px; color: var(--gray); margin-top: 4px;">Parent ASIN Analysis</div>
        </div>
        <div class="date-badge" id="date-range-badge">Loading...</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Strategic Overview</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Competitor Deep Dive</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static" class="tab-content active">
        
        <!-- KPI Row -->
        <div class="grid-3">
            <div class="card">
                <div class="card-title"><span class="material-icons">ads_click</span>Total Market Volume</div>
                <div class="kpi-value" id="kpi-clicks">-</div>
                <div class="kpi-label">Estimated Weekly Clicks</div>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">pie_chart</span>Our Click Share</div>
                <div class="kpi-value" id="kpi-share">-</div>
                <div class="kpi-label" id="kpi-share-delta">vs previous week</div>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">trending_up</span>Top Competitor</div>
                <div class="kpi-value" id="kpi-comp">-</div>
                <div class="kpi-label">Share of Clicks</div>
            </div>
        </div>

        <!-- Trend Section -->
        <div class="card">
            <div class="card-title">1. Global Parent Trend (Volume vs Share)</div>
            <div id="trend_chart" class="chart-container"></div>
            <div style="font-size: 13px; color: var(--gray); margin-top: 10px; text-align: center;">
                Bars: Total Market Clicks | Line: Our Brand Share (%)
            </div>
        </div>

        <!-- Competitiveness Section -->
        <div class="card">
            <div class="card-title">2. Brand Competitiveness (Share of Clicks)</div>
            <div id="comp_chart" class="chart-container"></div>
            <div style="font-size: 13px; color: var(--gray); margin-top: 10px;">
                Comparing our brand vs. Top 3 competitors over time.
            </div>
        </div>

        <!-- Efficiency Section -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">4. Efficiency: Organic Rank vs Click Share</div>
                <div id="scatter_chart" class="chart-container"></div>
                <div style="font-size: 12px; color: var(--gray);">
                    Top Left = High Efficiency (Good Rank, High Share).<br>
                    Blue = Our ASINs, Gray = Competitors.
                </div>
            </div>
            <div class="card">
                <div class="card-title"><span class="material-icons">lightbulb</span>5. Insights & Recommendations</div>
                <div id="insights-container">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE TOOL -->
    <div id="interactive" class="tab-content">
        <div class="controls">
            <div>
                <label style="font-size: 12px; display: block; color: var(--gray); margin-bottom: 4px;">Analysis Week</label>
                <select id="week-select" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label style="font-size: 12px; display: block; color: var(--gray); margin-bottom: 4px;">Competitor to Compare</label>
                <select id="comp-select" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="grid-2">
            <!-- Our Stats -->
            <div class="card" style="border-top: 4px solid var(--primary);">
                <div class="card-title" id="us-card-title">Our Performance</div>
                <table class="comp-table">
                    <tr>
                        <td>Avg Price</td>
                        <td id="us-price" style="font-weight: bold;">-</td>
                    </tr>
                    <tr>
                        <td>Click Share</td>
                        <td id="us-share" style="font-weight: bold;">-</td>
                    </tr>
                    <tr>
                        <td>Avg Rank</td>
                        <td id="us-rank" style="font-weight: bold;">-</td>
                    </tr>
                    <tr>
                        <td>Active Deals</td>
                        <td id="us-deals">-</td>
                    </tr>
                </table>
            </div>

            <!-- Competitor Stats -->
            <div class="card" style="border-top: 4px solid var(--danger);">
                <div class="card-title" id="them-card-title">Competitor Performance</div>
                <table class="comp-table">
                    <tr>
                        <td>Avg Price</td>
                        <td id="them-price" style="font-weight: bold;">-</td>
                    </tr>
                    <tr>
                        <td>Click Share</td>
                        <td id="them-share" style="font-weight: bold;">-</td>
                    </tr>
                    <tr>
                        <td>Avg Rank</td>
                        <td id="them-rank" style="font-weight: bold;">-</td>
                    </tr>
                    <tr>
                        <td>Active Deals</td>
                        <td id="them-deals">-</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Detailed Variant Comparison (Top 10 by Share)</div>
            <div id="table_chart" style="width: 100%;"></div>
        </div>
    </div>
</div>

<script>
    // --- DATA INJECTION START ---
    // This variable is populated by the Python script
    const rawData = {"marketData": [{"week_date": "2026-01", "real_brand": "Bio Matcha", "is_yaba_asin": "N", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 12.0, "click_share": 3.08, "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 856.133124, "click_share_rank": 8}, {"week_date": "2026-01", "real_brand": "bioKontor", "is_yaba_asin": "N", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 12.0, "click_share": 3.08, "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 856.133124, "click_share_rank": 8}, {"week_date": "2026-01", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 23.91, "click_share": 14.01, "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 3894.293853, "click_share_rank": 2}, {"week_date": "2025-52", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 24.6, "click_share": 14.83, "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 5101.911512, "click_share_rank": 1}, {"week_date": "2025-52", "real_brand": "Ceremonial Matcha", "is_yaba_asin": "N", "asin": "B0G1T7N675", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "price": 12.45, "click_share": 2.38, "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 3.0, "estimated_clicks": 818.7828319999999, "click_share_rank": 10}, {"week_date": "2025-52", "real_brand": "Ceremonial Matcha", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.01, "click_share": 5.94, "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 2043.516816, "click_share_rank": 3}, {"week_date": "2025-52", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.01, "click_share": 5.94, "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 2043.516816, "click_share_rank": 3}, {"week_date": "2026-01", "real_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.56, "click_share": 6.01, "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 1670.571453, "click_share_rank": 3}, {"week_date": "2026-01", "real_brand": "Ceremonial Matcha", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.56, "click_share": 6.01, "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 1670.571453, "click_share_rank": 3}, {"week_date": "2025-52", "real_brand": "Matcha Pulver", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.69, "click_share": 4.12, "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 1417.388768, "click_share_rank": 6}, {"week_date": "2025-52", "real_brand": "Special Leaves", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.69, "click_share": 4.12, "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 1417.388768, "click_share_rank": 6}, {"week_date": "2026-01", "real_brand": "Special Leaves", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "click_share": 3.51, "average_organic_rank": 15.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 975.658203, "click_share_rank": 6}, {"week_date": "2026-01", "real_brand": "Matcha Pulver", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "click_share": 3.51, "average_organic_rank": 15.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 975.658203, "click_share_rank": 6}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.27, "click_share": 2.69, "average_organic_rank": NaN, "weekly_number_of_days_with_deal": NaN, "estimated_clicks": 747.7266569999999, "click_share_rank": 10}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.56, "click_share": 2.75, "average_organic_rank": 25.0, "weekly_number_of_days_with_deal": 1.0, "estimated_clicks": 946.0726, "click_share_rank": 9}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.74, "click_share": 3.98, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 1369.225072, "click_share_rank": 7}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.22, "click_share": 4.96, "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 1378.707888, "click_share_rank": 4}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.52, "click_share": 5.19, "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 1785.497016, "click_share_rank": 5}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 15.03, "click_share": 14.3, "average_organic_rank": 1.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 4919.577520000001, "click_share_rank": 2}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 14.61, "click_share": 14.75, "average_organic_rank": 1.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 4099.9881749999995, "click_share_rank": 1}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.53, "click_share": 3.5, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 972.87855, "click_share_rank": 7}, {"week_date": "2026-01", "real_brand": "VAHDAM", "is_yaba_asin": "N", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 10.43, "click_share": 3.79, "average_organic_rank": 8.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 1053.488487, "click_share_rank": 5}, {"week_date": "2025-52", "real_brand": "VAHDAM", "is_yaba_asin": "N", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 9.73, "click_share": 5.4, "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 3.0, "estimated_clicks": 1857.7425600000001, "click_share_rank": 4}, {"week_date": "2026-01", "real_brand": "VAHDAM", "is_yaba_asin": "N", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "price": 10.43, "click_share": 2.74, "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 0.0, "estimated_clicks": 761.624922, "click_share_rank": 9}, {"week_date": "2025-52", "real_brand": "VAHDAM", "is_yaba_asin": "N", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "price": 9.73, "click_share": 3.49, "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 3.0, "estimated_clicks": 1200.652136, "click_share_rank": 8}], "trendChart": [["2025-52", 24921, 36.19547211485368], ["2026-01", 19913, 36.15298715801229]], "compChart": [["2025-52", 26.22, 20.77, 8.32, 8.89, 8.239999999999998], ["2026-01", 25.9, 20.02, 6.01, 6.53, 13.18]], "insights": {"trend": "Total clicks moved from 24921 to 19913. Our share changed from 36.2% to 36.2%.", "top_competitors": ["NORITUAL LAB", "Ceremonial Matcha", "VAHDAM"], "our_brand": "NaturaleBio", "recommendations": ["Monitor pricing of NORITUAL LAB.", "Investigate efficiency of ASINs with high rank but low share.", "Consider deals to regain share if price sensitivity is observed."]}, "weeks": ["2025-52", "2026-01"]};
    // --- DATA INJECTION END ---

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    const marketData = rawData.marketData;
    const ourBrand = rawData.insights.our_brand;
    const weeks = rawData.weeks;

    function initDashboard() {
        // 1. Render Date Badge
        document.getElementById('date-range-badge').textContent = `${weeks[0]} to ${weeks[weeks.length-1]}`;

        // 2. Render KPIs (Last Week)
        const lastWeek = weeks[weeks.length - 1];
        const lastTrendData = rawData.trendChart[rawData.trendChart.length - 1];
        
        document.getElementById('kpi-clicks').textContent = lastTrendData[1].toLocaleString();
        document.getElementById('kpi-share').textContent = lastTrendData[2].toFixed(1) + '%';
        
        // Find top competitor share in last week
        const lastCompData = rawData.compChart[rawData.compChart.length - 1];
        // compChart structure: [Week, Us, C1, C2, C3, Rest]
        const topCompShare = lastCompData[2]; // C1
        document.getElementById('kpi-comp').textContent = topCompShare.toFixed(1) + '%';
        
        // 3. Draw Charts
        drawTrendChart();
        drawCompChart();
        drawScatterChart();
        
        // 4. Render Insights
        renderInsights();

        // 5. Init Interactive Controls
        initControls();
    }

    function drawTrendChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Total Clicks');
        data.addColumn('number', 'Our Click Share %');
        data.addRows(rawData.trendChart);

        var options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Clicks'}, 1: {title: 'Share %', minValue: 0, maxValue: 100}},
            colors: ['#dadce0', '#4285F4'],
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        var chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
        chart.draw(data, options);
    }

    function drawCompChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', ourBrand);
        
        const comps = rawData.insights.top_competitors;
        comps.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Rest');

        data.addRows(rawData.compChart);

        var options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'],
            chartArea: {width: '90%', height: '70%'},
            vAxis: {title: 'Click Share %'}
        };

        var chart = new google.visualization.LineChart(document.getElementById('comp_chart'));
        chart.draw(data, options);
    }

    function drawScatterChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank (Inverted)');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'});
        data.addColumn({type: 'string', role: 'tooltip'});

        const lastWeek = weeks[weeks.length-1];
        const weekData = marketData.filter(d => d.week_date === lastWeek);

        const rows = weekData.map(d => {
            const isUs = d.is_yaba_asin === 'Y';
            const color = isUs ? '#4285F4' : '#9aa0a6';
            const tooltip = `${d.real_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
            // Rank usually: 1 is best. Scatter wants numbers. We want 1 on the left? 
            // Google charts hAxis direction: -1 flips it.
            return [d.average_organic_rank || 100, d.click_share, `point { fill-color: ${color}; size: 6; }`, tooltip];
        });

        data.addRows(rows);

        var options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: -1, viewWindow: {min: 1}},
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            chartArea: {width: '85%', height: '80%'}
        };

        var chart = new google.visualization.ScatterChart(document.getElementById('scatter_chart'));
        chart.draw(data, options);
    }

    function renderInsights() {
        const container = document.getElementById('insights-container');
        const i = rawData.insights;
        
        let html = `<div class="insight-item"><span class="material-icons insight-icon">trending_up</span><div><strong>Trend:</strong> ${i.trend}</div></div>`;
        
        i.recommendations.forEach(rec => {
            html += `<div class="insight-item"><span class="material-icons insight-icon">check_circle</span><div>${rec}</div></div>`;
        });
        
        container.innerHTML = html;
    }

    // --- INTERACTIVE LOGIC ---

    function initControls() {
        // Populate Weeks
        const wSelect = document.getElementById('week-select');
        weeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            wSelect.add(opt);
        });
        wSelect.value = weeks[weeks.length - 1];

        // Populate Competitors
        const cSelect = document.getElementById('comp-select');
        const comps = rawData.insights.top_competitors;
        comps.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            cSelect.add(opt);
        });
        
        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('week-select').value;
        const comp = document.getElementById('comp-select').value;
        
        document.getElementById('us-card-title').textContent = ourBrand;
        document.getElementById('them-card-title').textContent = comp;

        // Filter Data
        const weekData = marketData.filter(d => d.week_date === week);
        const usData = weekData.filter(d => d.is_yaba_asin === 'Y');
        const compData = weekData.filter(d => d.real_brand === comp);

        // Calculate Stats
        updateCard('us', usData);
        updateCard('them', compData);

        // Draw Comparison Table
        drawTable(usData, compData);
    }

    function updateCard(prefix, data) {
        if(data.length === 0) {
            document.getElementById(`${prefix}-price`).textContent = '-';
            document.getElementById(`${prefix}-share`).textContent = '-';
            return;
        }
        
        // Weighted Averages
        const totalShare = data.reduce((sum, d) => sum + d.click_share, 0);
        const avgPrice = data.reduce((sum, d) => sum + (d.price * d.click_share), 0) / (totalShare || 1);
        const avgRank = data.reduce((sum, d) => sum + ((d.average_organic_rank||50) * d.click_share), 0) / (totalShare || 1);
        const hasDeals = data.some(d => d.weekly_number_of_days_with_deal > 0);

        document.getElementById(`${prefix}-price`).textContent = '€' + avgPrice.toFixed(2);
        document.getElementById(`${prefix}-share`).textContent = totalShare.toFixed(1) + '%';
        document.getElementById(`${prefix}-rank`).textContent = avgRank.toFixed(1);
        
        const dealEl = document.getElementById(`${prefix}-deals`);
        if(hasDeals) dealEl.innerHTML = '<span class="badge badge-deal">Active</span>';
        else dealEl.innerHTML = '<span style="color:#ccc">None</span>';
    }

    function drawTable(usData, compData) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Brand');
        data.addColumn('string', 'Product Title');
        data.addColumn('number', 'Price (€)');
        data.addColumn('number', 'Share (%)');
        data.addColumn('number', 'Rank');

        const combined = [...usData, ...compData].sort((a,b) => b.click_share - a.click_share).slice(0, 10);
        
        combined.forEach(d => {
            data.addRow([
                d.real_brand,
                d.product_title.substring(0, 30) + '...',
                d.price,
                d.click_share,
                d.average_organic_rank || 0
            ]);
        });

        var table = new google.visualization.Table(document.getElementById('table_chart'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
    }

    // UI Utilities
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');
        
        // Redraw charts if unhidden to fix dimension bugs
        if(tabId === 'static') initDashboard();
    }

</script>

</body>
</html>