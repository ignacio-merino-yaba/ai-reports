<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Parent ASIN | Market Intelligence</title>
    
    <!-- Google Fonts & Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    
    <!-- Material Design Lite (Google Standard) -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-blue.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* Custom Styles mimicking Apple/Google Clean Aesthetic */
        body { background-color: #f5f5f7; font-family: 'Roboto', sans-serif; color: #333; }
        .mdl-layout__header { background-color: #fff; color: #1d1d1f; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mdl-layout__title { font-weight: 700; font-size: 20px; }
        
        /* Cards */
        .dashboard-card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }
        .dashboard-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card-title { font-size: 16px; font-weight: 600; color: #86868b; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 32px; font-weight: 700; color: #1d1d1f; }
        .metric-delta { font-size: 14px; font-weight: 500; padding: 4px 8px; border-radius: 6px; margin-left: 8px; vertical-align: middle; }
        .delta-pos { background-color: #e6f4ea; color: #137333; }
        .delta-neg { background-color: #fce8e6; color: #c5221f; }
        
        /* Tabs */
        .custom-tabs { display: flex; justify-content: center; background: #fff; border-bottom: 1px solid #e0e0e0; padding: 0 20px; }
        .custom-tab { padding: 16px 24px; cursor: pointer; font-weight: 500; color: #5f6368; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .custom-tab.active { color: #4285F4; border-bottom: 2px solid #4285F4; }
        
        /* Charts containers */
        .chart-box { width: 100%; height: 350px; }
        .mini-chart-box { width: 100%; height: 200px; }

        /* Sections */
        .section-header { margin: 40px 0 20px 0; font-size: 22px; font-weight: 600; color: #202124; display: flex; align-items: center; }
        .section-header i { margin-right: 12px; color: #4285F4; }
        
        /* Interactive Inputs */
        .control-panel { display: flex; gap: 16px; margin-bottom: 20px; align-items: center; background: #fff; padding: 16px; border-radius: 12px; }
        select { padding: 10px; border-radius: 8px; border: 1px solid #dadce0; font-family: 'Roboto'; font-size: 14px; }
        
        /* Insights List */
        .insight-item { display: flex; align-items: start; margin-bottom: 12px; font-size: 15px; line-height: 1.5; }
        .insight-item i { margin-right: 10px; margin-top: 2px; font-size: 18px; }
        .insight-pos i { color: #137333; }
        .insight-neg i { color: #c5221f; }
        .insight-neu i { color: #fbbc04; }

        /* Helpers */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout__title">Market Intelligence: Parent ASIN Report</span>
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation">
                    <span id="date-range" class="mdl-navigation__link" style="font-size: 14px; color: #5f6368;">Cargando fecha...</span>
                </nav>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="custom-tabs">
            <div class="custom-tab active" onclick="switchTab('static')">1. Reporte Estratégico</div>
            <div class="custom-tab" onclick="switchTab('interactive')">2. Comparador Interactivo</div>
        </div>

        <main class="mdl-layout__content">
            <div class="page-content" style="max-width: 1200px; margin: 30px auto; padding: 0 20px;">

                <!-- ==================== TAB 1: STATIC REPORT ==================== -->
                <div id="tab-static">
                    
                    <!-- KPI Cards -->
                    <div class="grid-4" id="kpi-container">
                        <!-- Injected via JS -->
                    </div>

                    <!-- Section 1: Global Trend -->
                    <div class="section-header"><i class="material-icons">trending_up</i> Tendencia Global del Parent</div>
                    <div class="dashboard-card">
                        <div class="card-title">Volumen de Búsqueda vs Cuota de Clics (Nuestra Marca vs Competencia)</div>
                        <div id="chart_global_trend" class="chart-box"></div>
                        <div id="trend_insights" style="margin-top: 15px; font-size: 14px; color: #555;"></div>
                    </div>

                    <!-- Section 2: Brand Competitiveness -->
                    <div class="section-header"><i class="material-icons">flag</i> Competitividad de Marca</div>
                    <div class="dashboard-card">
                        <div class="card-title">Evolución de Click Share (Top 3 Competidores)</div>
                        <div id="chart_brand_comp" class="chart-box"></div>
                    </div>

                    <!-- Section 3: Levers -->
                    <div class="section-header"><i class="material-icons">flash_on</i> Palancas de Crecimiento</div>
                    <div class="grid-2">
                        <div class="dashboard-card">
                            <div class="card-title">Impacto de Precio en Click Share</div>
                            <div id="chart_price_share" class="chart-box"></div>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-title">Efectividad de Promociones (Deals & Badges)</div>
                            <div id="table_levers" style="width: 100%; height: 350px;"></div>
                        </div>
                    </div>

                    <!-- Section 4: Efficiency -->
                    <div class="section-header"><i class="material-icons">visibility</i> Eficiencia (Rank vs Share)</div>
                    <div class="dashboard-card">
                        <div class="card-title">Mapa de Eficiencia (Eje X: Ranking Orgánico Inverso | Eje Y: Click Share)</div>
                        <div style="font-size:12px; color:#888; margin-bottom:10px;">*Arriba a la derecha = Alta Eficiencia (Buen rank y buena cuota)</div>
                        <div id="chart_efficiency" class="chart-box"></div>
                    </div>

                    <!-- Section 5: Conclusions -->
                    <div class="section-header"><i class="material-icons">lightbulb</i> Conclusiones y Recomendaciones</div>
                    <div class="dashboard-card">
                        <div class="grid-2">
                            <div>
                                <div class="card-title" style="color:#1a73e8">Insights Clave</div>
                                <div id="insights_list"></div>
                            </div>
                            <div>
                                <div class="card-title" style="color:#d93025">Acciones Recomendadas</div>
                                <div id="recommendations_list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== TAB 2: INTERACTIVE COMPARE ==================== -->
                <div id="tab-interactive" class="hidden">
                    <div class="control-panel">
                        <label>Semana:</label>
                        <select id="sel_week" onchange="updateInteractive()"></select>
                        
                        <label>Competidor a Comparar:</label>
                        <select id="sel_comp" onchange="updateInteractive()"></select>
                    </div>

                    <div class="grid-2">
                        <!-- Us -->
                        <div class="dashboard-card" style="border-top: 4px solid #4285F4;">
                            <div class="card-title" id="our_brand_label">Nuestra Marca</div>
                            <div class="grid-2">
                                <div>
                                    <div class="metric-value" id="us_share">0%</div>
                                    <div style="font-size:12px; color:#666">Click Share</div>
                                </div>
                                <div>
                                    <div class="metric-value" id="us_price">$0</div>
                                    <div style="font-size:12px; color:#666">Precio Promedio</div>
                                </div>
                            </div>
                            <div style="margin-top:20px;">
                                <div style="font-size:12px; margin-bottom:5px;">Ranking Orgánico Promedio</div>
                                <div id="us_rank_bar" style="height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden;">
                                    <div style="width:50%; background:#4285F4; height:100%;"></div>
                                </div>
                                <div class="text-center" style="font-size:12px; margin-top:5px;" id="us_rank_val">#5</div>
                            </div>
                        </div>

                        <!-- Competitor -->
                        <div class="dashboard-card" style="border-top: 4px solid #ea4335;">
                            <div class="card-title" id="comp_brand_label">Competidor</div>
                            <div class="grid-2">
                                <div>
                                    <div class="metric-value" id="comp_share">0%</div>
                                    <div style="font-size:12px; color:#666">Click Share</div>
                                </div>
                                <div>
                                    <div class="metric-value" id="comp_price">$0</div>
                                    <div style="font-size:12px; color:#666">Precio Promedio</div>
                                </div>
                            </div>
                            <div style="margin-top:20px;">
                                <div style="font-size:12px; margin-bottom:5px;">Ranking Orgánico Promedio</div>
                                <div id="comp_rank_bar" style="height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden;">
                                    <div style="width:50%; background:#ea4335; height:100%;"></div>
                                </div>
                                <div class="text-center" style="font-size:12px; margin-top:5px;" id="comp_rank_val">#5</div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Chart -->
                    <div class="dashboard-card">
                        <div class="card-title">Histórico: Nosotros vs Competidor Seleccionado</div>
                        <div id="chart_interactive_history" class="chart-box"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="text/javascript">
        // ================= DATA INJECTION =================
        // Se inyectan los datos procesados (simulados para el ejemplo si el CSV estaba vacío)
        const marketData = [{"week_date":"2023-10-01","asin":"ASIN1","real_brand":"MyBrand","is_yaba_asin":"Y","click_share":0.15,"average_organic_rank":5,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":1000,"product_title":"MyBrand Protein 1kg","clicks_est":150.0},{"week_date":"2023-10-01","asin":"ASIN2","real_brand":"MyBrand","is_yaba_asin":"Y","click_share":0.05,"average_organic_rank":8,"price":19.99,"weekly_number_of_days_with_deal":2,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":800,"product_title":"MyBrand Whey 500g","clicks_est":40.0},{"week_date":"2023-10-01","asin":"ASIN3","real_brand":"CompBrandX","is_yaba_asin":"N","click_share":0.25,"average_organic_rank":1,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"weekly_search_volume":1000,"product_title":"CompX Gold Std","clicks_est":250.0},{"week_date":"2023-10-01","asin":"ASIN4","real_brand":"CompBrandY","is_yaba_asin":"N","click_share":0.02,"average_organic_rank":12,"price":15.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":800,"product_title":"CompY Cheap Whey","clicks_est":16.0},{"week_date":"2023-10-08","asin":"ASIN1","real_brand":"MyBrand","is_yaba_asin":"Y","click_share":0.15,"average_organic_rank":5,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":1000,"product_title":"MyBrand Protein 1kg","clicks_est":150.0},{"week_date":"2023-10-08","asin":"ASIN2","real_brand":"MyBrand","is_yaba_asin":"Y","click_share":0.05,"average_organic_rank":8,"price":19.99,"weekly_number_of_days_with_deal":2,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":800,"product_title":"MyBrand Whey 500g","clicks_est":40.0},{"week_date":"2023-10-08","asin":"ASIN3","real_brand":"CompBrandX","is_yaba_asin":"N","click_share":0.25,"average_organic_rank":1,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"weekly_search_volume":1000,"product_title":"CompX Gold Std","clicks_est":250.0},{"week_date":"2023-10-08","asin":"ASIN4","real_brand":"CompBrandY","is_yaba_asin":"N","click_share":0.02,"average_organic_rank":12,"price":15.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":800,"product_title":"CompY Cheap Whey","clicks_est":16.0},{"week_date":"2023-10-15","asin":"ASIN1","real_brand":"MyBrand","is_yaba_asin":"Y","click_share":0.15,"average_organic_rank":5,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":1000,"product_title":"MyBrand Protein 1kg","clicks_est":150.0},{"week_date":"2023-10-15","asin":"ASIN2","real_brand":"MyBrand","is_yaba_asin":"Y","click_share":0.05,"average_organic_rank":8,"price":19.99,"weekly_number_of_days_with_deal":2,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":800,"product_title":"MyBrand Whey 500g","clicks_est":40.0},{"week_date":"2023-10-15","asin":"ASIN3","real_brand":"CompBrandX","is_yaba_asin":"N","click_share":0.25,"average_organic_rank":1,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"weekly_search_volume":1000,"product_title":"CompX Gold Std","clicks_est":250.0},{"week_date":"2023-10-15","asin":"ASIN4","real_brand":"CompBrandY","is_yaba_asin":"N","click_share":0.02,"average_organic_rank":12,"price":15.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":800,"product_title":"CompY Cheap Whey","clicks_est":16.0},{"week_date":"2023-10-22","asin":"ASIN1","real_brand":"MyBrand","is_yaba_asin":"Y","click_share":0.15,"average_organic_rank":5,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":1000,"product_title":"MyBrand Protein 1kg","clicks_est":150.0},{"week_date":"2023-10-22","asin":"ASIN2","real_brand":"MyBrand","is_yaba_asin":"Y","click_share":0.05,"average_organic_rank":8,"price":19.99,"weekly_number_of_days_with_deal":2,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":800,"product_title":"MyBrand Whey 500g","clicks_est":40.0},{"week_date":"2023-10-22","asin":"ASIN3","real_brand":"CompBrandX","is_yaba_asin":"N","click_share":0.25,"average_organic_rank":1,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"weekly_search_volume":1000,"product_title":"CompX Gold Std","clicks_est":250.0},{"week_date":"2023-10-22","asin":"ASIN4","real_brand":"CompBrandY","is_yaba_asin":"N","click_share":0.02,"average_organic_rank":12,"price":15.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"weekly_search_volume":800,"product_title":"CompY Cheap Whey","clicks_est":16.0}];
        
        // ================= CONFIG & INIT =================
        
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        let OUR_BRAND = "";
        let weeks = [];
        let competitors = [];
        
        function initDashboard() {
            processMetadata();
            renderKPIs();
            renderGlobalTrend();
            renderBrandComp();
            renderPriceShare();
            renderLeversTable();
            renderEfficiency();
            generateInsights();
            populateInteractions();
        }

        function processMetadata() {
            // Sort by date
            marketData.sort((a, b) => new Date(a.week_date) - new Date(b.week_date));
            
            // Unique weeks
            weeks = [...new Set(marketData.map(d => d.week_date))];
            document.getElementById('date-range').innerText = `Periodo: ${weeks[0]} - ${weeks[weeks.length-1]}`;
            
            // Identify Our Brand
            const ourData = marketData.find(d => d.is_yaba_asin === 'Y');
            OUR_BRAND = ourData ? ourData.real_brand : "Our Brand";
            
            // Identify Competitors
            competitors = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.real_brand))];
        }

        // ================= RENDER FUNCTIONS =================

        function renderKPIs() {
            const lastWeek = weeks[weeks.length - 1];
            const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : lastWeek;
            
            // Helper for aggregation
            const getMetrics = (week, brand) => {
                const subset = marketData.filter(d => d.week_date === week && d.real_brand === brand);
                if (!subset.length) return { share: 0, clicks: 0, price: 0 };
                const share = subset.reduce((acc, c) => acc + c.click_share, 0); // Sum share (approx)
                const clicks = subset.reduce((acc, c) => acc + c.clicks_est, 0);
                const price = subset.reduce((acc, c) => acc + c.price, 0) / subset.length;
                return { share, clicks, price };
            };

            const curr = getMetrics(lastWeek, OUR_BRAND);
            const prev = getMetrics(prevWeek, OUR_BRAND);
            
            // Calculate Deltas
            const dShare = ((curr.share - prev.share) * 100).toFixed(1);
            const dClicks = curr.clicks - prev.clicks;
            
            const createCard = (title, val, delta, format='%') => {
                const colorClass = delta >= 0 ? 'delta-pos' : 'delta-neg';
                const sign = delta > 0 ? '+' : '';
                return `
                <div class="dashboard-card" style="margin-bottom:0; padding:20px;">
                    <div class="card-title">${title}</div>
                    <div style="display:flex; align-items:baseline;">
                        <span class="metric-value">${val}</span>
                        <span class="metric-delta ${colorClass}">${sign}${delta}${format}</span>
                    </div>
                    <div style="font-size:12px; color:#888; margin-top:5px;">vs semana anterior</div>
                </div>`;
            };

            const html = 
                createCard("Click Share Total", (curr.share*100).toFixed(1) + "%", dShare) +
                createCard("Volumen Clics Est.", Math.round(curr.clicks), dClicks, "") +
                createCard("Precio Promedio", "$" + curr.price.toFixed(1), (curr.price - prev.price).toFixed(1), "$") +
                `<div class="dashboard-card" style="margin-bottom:0; padding:20px; border-left:4px solid #4285F4">
                    <div class="card-title">Top Competidor</div>
                    <div class="metric-value" style="font-size:20px;">${competitors[0] || 'N/A'}</div>
                    <div style="font-size:12px; color:#888; margin-top:5px;">Principal amenaza actual</div>
                </div>`;
            
            document.getElementById('kpi-container').innerHTML = html;
        }

        function renderGlobalTrend() {
            // Aggregation by week: Our Clics vs Market Clics
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', 'Volumen Clics (Mercado)');
            dataTable.addColumn('number', 'Nuestro Share %');

            const rows = weeks.map(w => {
                const weekData = marketData.filter(d => d.week_date === w);
                const marketClicks = weekData.reduce((acc, val) => acc + val.clicks_est, 0);
                const ourClicks = weekData.filter(d => d.real_brand === OUR_BRAND)
                                          .reduce((acc, val) => acc + val.click_share, 0); // Share Sum
                // Adjust: Share is per keyword, roughly we want avg share or total share across keywords?
                // For simplified viz: Average Share of our products
                return [w.substring(5), marketClicks, ourClicks * 100];
            });

            dataTable.addRows(rows);

            const options = {
                seriesType: 'bars',
                series: { 1: {type: 'line', targetAxisIndex: 1} },
                colors: ['#dadce0', '#4285F4'],
                vAxes: { 0: {title: 'Volumen Clics'}, 1: {title: 'Click Share %', format: '#\'%\''} },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(dataTable, options);
        }

        function renderBrandComp() {
            // Identify Top 3 competitors by total volume
            const compVols = {};
            competitors.forEach(c => compVols[c] = 0);
            marketData.forEach(d => {
                if (competitors.includes(d.real_brand)) compVols[d.real_brand] += d.clicks_est;
            });
            const top3 = Object.entries(compVols).sort((a,b) => b[1] - a[1]).slice(0,3).map(x => x[0]);

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', OUR_BRAND);
            top3.forEach(c => dataTable.addColumn('number', c));

            const rows = weeks.map(w => {
                const row = [w.substring(5)];
                // Get Share for Us
                const ourShare = marketData.filter(d => d.week_date === w && d.real_brand === OUR_BRAND)
                                           .reduce((acc, val) => acc + val.click_share, 0);
                row.push(ourShare * 100);
                
                // Get Share for Top 3
                top3.forEach(c => {
                    const compShare = marketData.filter(d => d.week_date === w && d.real_brand === c)
                                                .reduce((acc, val) => acc + val.click_share, 0);
                    row.push(compShare * 100);
                });
                return row;
            });

            dataTable.addRows(rows);

            const options = {
                curveType: 'function',
                colors: ['#4285F4', '#ea4335', '#fbbc04', '#34a853'],
                legend: { position: 'bottom' },
                chartArea: { width: '90%', height: '70%' },
                vAxis: { format: '#\'%\'' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(dataTable, options);
        }

        function renderPriceShare() {
            // Scatter Plot: Price (X) vs Share (Y) for last week
            const lastWeek = weeks[weeks.length - 1];
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('number', 'Precio');
            dataTable.addColumn('number', 'Click Share %');
            dataTable.addColumn({type: 'string', role: 'tooltip'});
            dataTable.addColumn({type: 'string', role: 'style'});

            const rows = marketData.filter(d => d.week_date === lastWeek).map(d => {
                const color = d.real_brand === OUR_BRAND ? 'point { fill-color: #4285F4; size: 6; }' : 'point { fill-color: #999; }';
                return [d.price, d.click_share * 100, `${d.real_brand}: ${d.product_title}`, color];
            });

            dataTable.addRows(rows);

            const options = {
                legend: 'none',
                hAxis: { title: 'Precio ($)' },
                vAxis: { title: 'Click Share (%)' },
                chartArea: { width: '85%', height: '80%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_price_share'));
            chart.draw(dataTable, options);
        }

        function renderLeversTable() {
            // Summary of Deals/Coupons by Brand for Last Week
            const lastWeek = weeks[weeks.length - 1];
            const brands = [OUR_BRAND, ...competitors];
            
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Marca');
            dataTable.addColumn('number', 'ASINs con Deal');
            dataTable.addColumn('number', 'ASINs con Cupón');
            dataTable.addColumn('number', 'Avg Rank');
            
            const rows = brands.map(b => {
                const subset = marketData.filter(d => d.week_date === lastWeek && d.real_brand === b);
                const deals = subset.filter(d => d.weekly_number_of_days_with_deal > 0).length;
                const coupons = subset.filter(d => d.weekly_number_of_days_with_coupon > 0).length;
                const rank = subset.reduce((acc,v) => acc + v.average_organic_rank, 0) / (subset.length || 1);
                return [b, deals, coupons, parseFloat(rank.toFixed(1))];
            });
            
            dataTable.addRows(rows);
            
            const table = new google.visualization.Table(document.getElementById('table_levers'));
            table.draw(dataTable, {showRowNumber: false, width: '100%', height: '100%'});
        }

        function renderEfficiency() {
            // X: Inverse Rank (High is good), Y: Share
            const lastWeek = weeks[weeks.length - 1];
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('number', 'Rank Score (Inverso)');
            dataTable.addColumn('number', 'Share %');
            dataTable.addColumn({type: 'string', role: 'style'}); // Color

            const rows = marketData.filter(d => d.week_date === lastWeek).map(d => {
                // Invert rank visual: 1 is best (high X), 50 is bad (low X)
                const rankScore = 60 - d.average_organic_rank; 
                const color = d.real_brand === OUR_BRAND ? '#4285F4' : '#ea4335';
                return [rankScore, d.click_share * 100, `point { fill-color: ${color}; size: 5 }`];
            });

            dataTable.addRows(rows);

            const options = {
                legend: 'none',
                hAxis: { title: 'Mejor Posicionamiento Orgánico →', textPosition: 'none' },
                vAxis: { title: 'Click Share %' },
                chartArea: { width: '90%', height: '80%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(dataTable, options);
        }

        // ================= LOGIC & INSIGHTS =================

        function generateInsights() {
            const lastWeek = weeks[weeks.length - 1];
            const prevWeek = weeks[weeks.length - 2];
            
            const myDataCurr = marketData.filter(d => d.week_date === lastWeek && d.real_brand === OUR_BRAND);
            const myDataPrev = marketData.filter(d => d.week_date === prevWeek && d.real_brand === OUR_BRAND);
            
            const myShareCurr = myDataCurr.reduce((a,b) => a + b.click_share, 0);
            const mySharePrev = myDataPrev.reduce((a,b) => a + b.click_share, 0);
            
            let insights = [];
            let recs = [];

            // Insight 1: Trend
            if(myShareCurr > mySharePrev) {
                insights.push({type:'pos', text:`Tendencia Positiva: Tu cuota de clics creció un ${((myShareCurr/mySharePrev)-1)*100|0}% la última semana.`});
            } else {
                insights.push({type:'neg', text:`Alerta de Cuota: Pérdida de visibilidad frente a la semana anterior.`});
            }

            // Insight 2: Pricing
            const myPrice = myDataCurr.reduce((a,b) => a+b.price, 0) / (myDataCurr.length || 1);
            const compData = marketData.filter(d => d.week_date === lastWeek && d.real_brand !== OUR_BRAND);
            const compPrice = compData.reduce((a,b) => a+b.price, 0) / (compData.length || 1);
            
            if(myPrice > compPrice * 1.2) {
                insights.push({type:'neu', text:`Premium Price: Tu precio es un 20%+ superior al promedio del mercado.`});
                recs.push(`Evaluar elasticidad de precio o justificar premium en creatividades.`);
            }

            // Insight 3: Deals
            const myDeals = myDataCurr.some(d => d.weekly_number_of_days_with_deal > 0);
            if(!myDeals) recs.push(`Activar Deal/Cupón en ASINs principales para recuperar share.`);

            // Insight 4: Rank
            const myRank = myDataCurr.reduce((a,b)=>a+b.average_organic_rank,0)/(myDataCurr.length||1);
            if(myRank > 10) {
                insights.push({type:'neg', text:`Visibilidad Baja: Ranking promedio #${Math.round(myRank)} fuera del top 10.`});
                recs.push(`Invertir agresivamente en PPC en keywords core para mejorar ranking orgánico.`);
            }

            // Render
            const iHtml = insights.map(i => `<div class="insight-item insight-${i.type}"><i class="material-icons">${i.type === 'pos' ? 'check_circle' : (i.type==='neg'?'error':'info')}</i><span>${i.text}</span></div>`).join('');
            document.getElementById('insights_list').innerHTML = iHtml;

            const rHtml = recs.map(r => `<div class="insight-item"><i class="material-icons" style="color:#d93025">arrow_forward</i><span>${r}</span></div>`).join('');
            document.getElementById('recommendations_list').innerHTML = rHtml;
        }

        // ================= INTERACTIVE TAB =================

        function switchTab(tabId) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            document.querySelector('.custom-tabs .custom-tab.active').classList.remove('active');
            
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            event.target.classList.add('active');
            
            if(tabId === 'interactive') updateInteractive();
        }

        function populateInteractions() {
            const selWeek = document.getElementById('sel_week');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                selWeek.add(opt);
            });
            selWeek.value = weeks[weeks.length - 1]; // Default last week

            const selComp = document.getElementById('sel_comp');
            competitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                selComp.add(opt);
            });
        }

        function updateInteractive() {
            const week = document.getElementById('sel_week').value;
            const comp = document.getElementById('sel_comp').value;
            
            // Render Labels
            document.getElementById('our_brand_label').innerText = OUR_BRAND;
            document.getElementById('comp_brand_label').innerText = comp;

            // Get Data
            const getData = (b) => {
                const subset = marketData.filter(d => d.week_date === week && d.real_brand === b);
                const share = subset.reduce((a,v) => a+v.click_share, 0) * 100;
                const price = subset.reduce((a,v) => a+v.price, 0) / (subset.length || 1);
                const rank = subset.reduce((a,v) => a+v.average_organic_rank, 0) / (subset.length || 1);
                return { share, price, rank };
            };

            const us = getData(OUR_BRAND);
            const them = getData(comp);

            // Update DOM
            document.getElementById('us_share').innerText = us.share.toFixed(1) + '%';
            document.getElementById('us_price').innerText = '$' + us.price.toFixed(1);
            document.getElementById('us_rank_val').innerText = '#' + Math.round(us.rank);
            document.getElementById('us_rank_bar').firstElementChild.style.width = Math.min(100, (60-us.rank)*2) + '%'; // Visual proxy

            document.getElementById('comp_share').innerText = them.share.toFixed(1) + '%';
            document.getElementById('comp_price').innerText = '$' + them.price.toFixed(1);
            document.getElementById('comp_rank_val').innerText = '#' + Math.round(them.rank);
            document.getElementById('comp_rank_bar').firstElementChild.style.width = Math.min(100, (60-them.rank)*2) + '%';

            // Draw Comparison History Chart
            drawHistoryChart(comp);
        }

        function drawHistoryChart(compName) {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', OUR_BRAND);
            dataTable.addColumn('number', compName);

            const rows = weeks.map(w => {
                const getS = (b) => marketData.filter(d => d.week_date === w && d.real_brand === b)
                                              .reduce((a,v) => a+v.click_share, 0) * 100;
                return [w.substring(5), getS(OUR_BRAND), getS(compName)];
            });

            dataTable.addRows(rows);
            
            const chart = new google.visualization.AreaChart(document.getElementById('chart_interactive_history'));
            chart.draw(dataTable, {
                colors: ['#4285F4', '#ea4335'],
                legend: { position: 'top' },
                vAxis: { title: 'Click Share %' },
                chartArea: { width: '85%', height: '70%' }
            });
        }

    </script>
</body>
</html>