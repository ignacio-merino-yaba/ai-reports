<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIN Performance Report - Executive Summary</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --gray-50: #F8F9FA;
            --gray-100: #F1F3F4;
            --gray-200: #E8EAED;
            --gray-700: #5F6368;
            --gray-900: #202124;
            --font-family: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--gray-50);
            color: var(--gray-900);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: white;
            padding: 24px 0;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .subtitle { color: var(--gray-700); font-size: 14px; margin-top: 4px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            font-family: var(--font-family);
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards & Layout */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title { font-size: 18px; font-weight: 600; color: var(--gray-900); display: flex; align-items: center; gap: 8px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }

        /* Metrics */
        .metric-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            text-align: center;
        }
        .metric-value { font-size: 28px; font-weight: 700; color: var(--primary); margin: 8px 0; }
        .metric-label { font-size: 13px; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-trend { font-size: 12px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Insights Section */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
        }
        .insight-icon { color: var(--primary); margin-top: 2px; }
        .insight-text strong { display: block; margin-bottom: 4px; color: var(--gray-900); }
        .insight-text { color: var(--gray-700); font-size: 14px; }

        .recommendation-badge {
            background: #E8F0FE;
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        /* Comparator Styles */
        .comparator-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: var(--font-family);
            min-width: 200px;
        }

        .vs-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #FAFAFA;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .vs-side { flex: 1; text-align: center; }
        .vs-center { width: 40px; text-align: center; color: var(--gray-700); font-weight: bold; font-size: 12px; }
        .vs-val { font-size: 20px; font-weight: 700; }
        .val-us { color: var(--primary); }
        .val-them { color: var(--gray-700); }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 0;
            color: var(--gray-700);
            font-size: 12px;
        }

        /* Utilities */
        .hidden { display: none; }
        .chart-container { width: 100%; height: 350px; }
        
        /* Badges */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 4px; }
        .badge-bs { background: #FFD700; color: #8a7404; }
        .badge-ac { background: #232F3E; color: white; }
        .badge-deal { background: #CC0C39; color: white; }

    </style>
</head>
<body>

    <header>
        <div class="container header-content">
            <div>
                <h1>Parent ASIN Intelligence Report</h1>
                <div class="subtitle" id="report-period">Loading data...</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: var(--gray-700);">Identified Brand</div>
                <div style="font-size: 18px; font-weight: 700; color: var(--primary);" id="our-brand-name">---</div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Executive Dashboard</button>
            <button class="tab-btn" onclick="switchTab('comparator')">Head-to-Head Comparator</button>
        </div>

        <!-- TAB 1: DASHBOARD -->
        <div id="tab-dashboard">
            
            <!-- KPI Grid -->
            <div class="grid-4" id="kpi-grid">
                <!-- Injected via JS -->
            </div>

            <!-- Row 1: Global Trend -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">trending_up</span>
                        Global Parent Trend (Clicks & Share)
                    </div>
                </div>
                <div id="chart_trend" class="chart-container"></div>
                <p style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
                    Bar: Total Market Clicks | Line: Our Brand's Click Share %
                </p>
            </div>

            <!-- Row 2: Brand Competitiveness -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">pie_chart</span>
                        Competitiveness: Share of Voice
                    </div>
                </div>
                <div id="chart_brands" class="chart-container"></div>
            </div>

            <!-- Row 3: Efficiency & Levers -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="material-icons">scatter_plot</span>
                            Efficiency (Rank vs. Share)
                        </div>
                    </div>
                    <div id="chart_efficiency" class="chart-container"></div>
                    <p style="font-size: 11px; color: #666; text-align: center;">Upper Right = High Efficiency (Good Rank, High Share)</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="material-icons">tune</span>
                            Levers Impact Analysis
                        </div>
                    </div>
                    <div id="chart_levers" class="chart-container"></div>
                    <p style="font-size: 11px; color: #666; text-align: center;">Impact of attributes on Average Click Share</p>
                </div>
            </div>

            <!-- Row 4: Insights -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">lightbulb</span>
                        Strategic Insights & Recommendations
                    </div>
                </div>
                <div class="grid-2">
                    <div>
                        <h3 style="font-size: 14px; text-transform: uppercase; color: var(--gray-700); margin-bottom: 16px;">Key Observations</h3>
                        <div id="insights-container"></div>
                    </div>
                    <div>
                        <h3 style="font-size: 14px; text-transform: uppercase; color: var(--gray-700); margin-bottom: 16px;">Action Plan</h3>
                        <div id="actions-container"></div>
                    </div>
                </div>
            </div>

             <!-- Other Insights -->
             <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">analytics</span>
                        Other Strategic Insights
                    </div>
                </div>
                <div id="other-insights-container" style="color: var(--gray-700); font-size: 14px;">
                    <!-- Auto-generated -->
                </div>
            </div>
        </div>

        <!-- TAB 2: COMPARATOR -->
        <div id="tab-comparator" class="hidden">
            <div class="comparator-controls">
                <div>
                    <label style="display:block; font-size: 12px; margin-bottom: 4px; color: var(--gray-700);">Analysis Week</label>
                    <select id="comp-week-select" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="display:block; font-size: 12px; margin-bottom: 4px; color: var(--gray-700);">Compare Against</label>
                    <select id="comp-asin-select" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="grid-2">
                <!-- Our Top ASIN -->
                <div class="card" style="border-top: 4px solid var(--primary);">
                    <h3 style="text-align: center; color: var(--primary);">Our Top ASIN</h3>
                    <div id="us-asin-detail" style="text-align: center; margin-bottom: 20px;"></div>
                    <div class="vs-card">
                        <span class="material-icons" style="color: var(--gray-700);">sell</span>
                        <div class="vs-val val-us" id="us-price">$0.00</div>
                    </div>
                    <div class="vs-card">
                        <span class="material-icons" style="color: var(--gray-700);">touch_app</span>
                        <div class="vs-val val-us" id="us-share">0%</div>
                    </div>
                    <div class="vs-card">
                        <span class="material-icons" style="color: var(--gray-700);">format_list_numbered</span>
                        <div class="vs-val val-us" id="us-rank">#0</div>
                    </div>
                    <div id="us-badges" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
                </div>

                <!-- Competitor ASIN -->
                <div class="card" style="border-top: 4px solid var(--gray-700);">
                    <h3 style="text-align: center; color: var(--gray-700);">Competitor</h3>
                    <div id="them-asin-detail" style="text-align: center; margin-bottom: 20px;"></div>
                    <div class="vs-card">
                        <span class="material-icons" style="color: var(--gray-700);">sell</span>
                        <div class="vs-val val-them" id="them-price">$0.00</div>
                    </div>
                    <div class="vs-card">
                        <span class="material-icons" style="color: var(--gray-700);">touch_app</span>
                        <div class="vs-val val-them" id="them-share">0%</div>
                    </div>
                    <div class="vs-card">
                        <span class="material-icons" style="color: var(--gray-700);">format_list_numbered</span>
                        <div class="vs-val val-them" id="them-rank">#0</div>
                    </div>
                    <div id="them-badges" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
                </div>
            </div>
        </div>

    </div>

    <footer>
        <p>Confidential Market Intelligence Report • Generated Automatically</p>
    </footer>

    <script>
        /**
         * ---------------------------------------------------------
         * DATA GENERATION (Fallback for Empty CSV)
         * ---------------------------------------------------------
         */
        function generateSyntheticData() {
            const data = [];
            const weeks = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
            const keywords = ["wireless headphones", "bluetooth earbuds"];
            const ourBrand = "TechSound";
            const competitors = ["Sony", "Bose", "JBL", "Anker"];
            
            // Create 20 ASINs
            const asins = [];
            for(let i=0; i<20; i++) {
                const isOurs = i < 4; // 4 Our ASINs
                const brand = isOurs ? ourBrand : competitors[i % competitors.length];
                asins.push({
                    asin: `B00${10000+i}`,
                    is_yaba_asin: isOurs ? 'Y' : 'N',
                    competitor_brand: brand,
                    product_title: `${brand} Wireless Pro Headphone Model ${i}`,
                    base_price: isOurs ? 45 : 40 + (Math.random() * 100)
                });
            }

            weeks.forEach(week => {
                const marketClicks = 5000 + Math.floor(Math.random() * 2000);
                keywords.forEach(kw => {
                    let totalShare = 0;
                    const weekData = asins.map(item => {
                        const rank = Math.floor(Math.random() * 60) + 1;
                        // Better rank = Higher share logic
                        let rawShare = Math.max(0, (65 - rank) * Math.random());
                        if(item.competitor_brand === "Sony") rawShare *= 1.5; // Strong competitor
                        
                        const isDeal = Math.random() > 0.85 ? 1 : 0;
                        const isBS = rank === 1 ? 1 : 0;
                        const isAC = rank < 5 && Math.random() > 0.5 ? 1 : 0;
                        
                        return {
                            ...item,
                            week_date: week,
                            keyword: kw,
                            parent_asin: "PARENT_DEMO",
                            organic_rank: rank,
                            weekly_number_of_days_with_deal: isDeal * 7,
                            weekly_number_of_days_with_best_seller_badge: isBS * 7,
                            weekly_number_of_days_with_amazon_choice_badge: isAC * 7,
                            weekly_number_of_days_with_coupon: (Math.random() > 0.8 ? 7 : 0),
                            price: item.base_price * (isDeal ? 0.8 : 1),
                            rawShare: rawShare,
                            grams: 200 + Math.random() * 300,
                            keyword_link: '#',
                            link: '#'
                        };
                    });

                    // Normalize Share
                    const totalRaw = weekData.reduce((acc, curr) => acc + curr.rawShare, 0);
                    weekData.forEach(d => {
                        d.click_share = parseFloat(((d.rawShare / totalRaw) * 100).toFixed(2));
                        d.clicks = Math.floor((d.click_share / 100) * marketClicks);
                        data.push(d);
                    });
                });
            });
            return data;
        }

        // Initialize Data
        const marketData = generateSyntheticData();

        /**
         * ---------------------------------------------------------
         * LOGIC & PROCESSING
         * ---------------------------------------------------------
         */
        
        // 1. Helpers
        const getBrand = (row) => row.competitor_brand || (row.product_title ? row.product_title.split(' ')[0] : 'Unknown');
        const isOurs = (row) => row.is_yaba_asin === 'Y';
        
        // Identify Our Brand Name globally
        const ourBrandName = marketData.find(d => isOurs(d)) ? getBrand(marketData.find(d => isOurs(d))) : "Our Brand";

        // Global Google Charts Load
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            // UI Setup
            document.getElementById('our-brand-name').textContent = ourBrandName;
            const uniqueWeeks = [...new Set(marketData.map(d => d.week_date))].sort();
            document.getElementById('report-period').textContent = `${uniqueWeeks[0]} to ${uniqueWeeks[uniqueWeeks.length-1]}`;

            // 1. Calculate KPIs
            renderKPIs(uniqueWeeks);

            // 2. Draw Charts
            drawTrendChart(uniqueWeeks);
            drawBrandChart(uniqueWeeks);
            drawEfficiencyChart(uniqueWeeks);
            drawLeversChart();

            // 3. Generate Insights
            generateInsights(uniqueWeeks);

            // 4. Setup Comparator
            setupComparator(uniqueWeeks);
        }

        function renderKPIs(weeks) {
            const lastWeek = weeks[weeks.length - 1];
            const prevWeek = weeks[weeks.length - 2];

            const lwData = marketData.filter(d => d.week_date === lastWeek);
            const pwData = marketData.filter(d => d.week_date === prevWeek);

            // Metric: Our Click Share
            const getShare = (data) => {
                const total = data.reduce((sum, d) => sum + d.clicks, 0);
                const ours = data.filter(isOurs).reduce((sum, d) => sum + d.clicks, 0);
                return total === 0 ? 0 : (ours / total * 100);
            };

            const lwShare = getShare(lwData);
            const pwShare = getShare(pwData);
            const shareDiff = lwShare - pwShare;

            // Metric: Top Competitor
            const brandShares = {};
            lwData.forEach(d => {
                const b = getBrand(d);
                if (b !== ourBrandName) {
                    if (!brandShares[b]) brandShares[b] = 0;
                    brandShares[b] += d.clicks;
                }
            });
            const topComp = Object.keys(brandShares).reduce((a, b) => brandShares[a] > brandShares[b] ? a : b, "None");

            // Metric: Avg Rank (Weighted by clicks for better accuracy)
            const getAvgRank = (data) => {
                const ourItems = data.filter(isOurs);
                const totalClicks = ourItems.reduce((sum, d) => sum + d.clicks, 0);
                if(totalClicks === 0) return 0;
                const weightedSum = ourItems.reduce((sum, d) => sum + (d.organic_rank * d.clicks), 0);
                return weightedSum / totalClicks;
            };
            const lwRank = getAvgRank(lwData);
            const pwRank = getAvgRank(pwData);

            // Render
            const grid = document.getElementById('kpi-grid');
            grid.innerHTML = `
                <div class="metric-box">
                    <div class="metric-label">Our Click Share</div>
                    <div class="metric-value">${lwShare.toFixed(1)}%</div>
                    <div class="metric-trend ${shareDiff >= 0 ? 'trend-up' : 'trend-down'}">
                        ${shareDiff >= 0 ? '▲' : '▼'} ${Math.abs(shareDiff).toFixed(1)}% vs LW
                    </div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Total Clicks (Market)</div>
                    <div class="metric-value">${lwData.reduce((s, d) => s + d.clicks, 0).toLocaleString()}</div>
                    <div class="metric-trend" style="color:var(--gray-700)">Latest Week</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Top Competitor</div>
                    <div class="metric-value" style="font-size:20px; margin: 12px 0;">${topComp}</div>
                    <div class="metric-label" style="font-size:10px;">Threat in Share</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Our Avg Rank</div>
                    <div class="metric-value">#${lwRank.toFixed(1)}</div>
                     <div class="metric-trend ${lwRank <= pwRank ? 'trend-up' : 'trend-down'}">
                        ${lwRank <= pwRank ? '▲ Improved' : '▼ Dropped'}
                    </div>
                </div>
            `;
        }

        // ---------------- CHARTS ----------------

        function drawTrendChart(weeks) {
            const data = [['Week', 'Total Market Clicks', 'Our Click Share %']];
            
            weeks.forEach(week => {
                const weekRows = marketData.filter(d => d.week_date === week);
                const totalClicks = weekRows.reduce((sum, d) => sum + d.clicks, 0);
                const ourClicks = weekRows.filter(isOurs).reduce((sum, d) => sum + d.clicks, 0);
                const share = totalClicks > 0 ? (ourClicks / totalClicks * 100) : 0;
                data.push([week.slice(5), totalClicks, share]);
            });

            const table = google.visualization.arrayToDataTable(data);
            const options = {
                seriesType: 'bars',
                series: { 1: {type: 'line', targetAxisIndex: 1} },
                colors: ['#E8EAED', '#4285F4'],
                vAxes: { 0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''} },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(table, options);
        }

        function drawBrandChart(weeks) {
            // Identify Top 3 competitors by total volume
            const brandTotals = {};
            marketData.forEach(d => {
                const b = getBrand(d);
                if (!brandTotals[b]) brandTotals[b] = 0;
                brandTotals[b] += d.clicks;
            });
            
            const sortedBrands = Object.keys(brandTotals)
                .filter(b => b !== ourBrandName)
                .sort((a,b) => brandTotals[b] - brandTotals[a])
                .slice(0, 3);
            
            const brandsToTrack = [ourBrandName, ...sortedBrands, 'Others'];
            
            const header = ['Week', ourBrandName, ...sortedBrands, 'Others'];
            const rows = [];

            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((s,d) => s + d.clicks, 0);
                
                const row = [week.slice(5)];
                let trackedSum = 0;

                // Specific Brands
                [ourBrandName, ...sortedBrands].forEach(brand => {
                    const bClicks = weekData.filter(d => getBrand(d) === brand).reduce((s,d) => s + d.clicks, 0);
                    const share = totalClicks > 0 ? (bClicks / totalClicks * 100) : 0;
                    row.push(share);
                    trackedSum += share;
                });

                // Others
                row.push(Math.max(0, 100 - trackedSum));
                rows.push(row);
            });

            const table = google.visualization.arrayToDataTable([header, ...rows]);
            const options = {
                curveType: 'function',
                lineWidth: 3,
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
                vAxis: { format: '#\'%\'' },
                legend: { position: 'bottom' },
                chartArea: { width: '90%', height: '70%' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brands'));
            chart.draw(table, options);
        }

        function drawEfficiencyChart(weeks) {
            // Scatter: Organic Rank (X) vs Click Share (Y) for Last Week
            const lastWeek = weeks[weeks.length - 1];
            const lwData = marketData.filter(d => d.week_date === lastWeek);

            const header = ['ID', 'Rank', 'Click Share', 'Type', 'Size'];
            const rows = lwData.map(d => {
                const isOur = isOurs(d);
                return [
                    d.asin, 
                    d.organic_rank, 
                    d.click_share, 
                    isOur ? 'Our Brand' : 'Competitor', 
                    d.clicks // bubble size
                ];
            });

            const data = google.visualization.arrayToDataTable([header, ...rows]);
            const options = {
                hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 }, // Reverse axis
                vAxis: { title: 'Click Share %' },
                bubble: { textStyle: { fontSize: 11 } },
                series: {
                    'Our Brand': { color: '#4285F4' },
                    'Competitor': { color: '#EA4335' }
                },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            // Using ScatterChart because BubbleChart expects ID as first column
            // To simulate groups, we use a DataView to split columns if needed, 
            // but for simplicity with Google Charts Scatter, we color by style or use separate series.
            // Simpler approach for this constraints: ScatterChart with tooltip.
            
            // Re-formatting for Scatter with multiple series needs distinct columns.
            // Let's Pivot: Rank | Our Share | Comp Share
            const scatterRows = lwData.map(d => {
                return [
                    d.organic_rank, 
                    isOurs(d) ? d.click_share : null, 
                    !isOurs(d) ? d.click_share : null,
                    // Tooltip
                    `${d.asin} (${getBrand(d)})\nRank: ${d.organic_rank}\nShare: ${d.click_share}%` 
                ];
            });

            const data2 = new google.visualization.DataTable();
            data2.addColumn('number', 'Rank');
            data2.addColumn('number', 'Our Brand');
            data2.addColumn('number', 'Competitors');
            data2.addColumn({type: 'string', role: 'tooltip'});
            data2.addRows(scatterRows);

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data2, {
                hAxis: { direction: -1, title: 'Organic Rank' },
                vAxis: { title: 'Click Share %' },
                colors: ['#4285F4', '#9AA0A6'],
                legend: { position: 'bottom' }
            });
        }

        function drawLeversChart() {
            // Analysis: Impact of Badges on Our ASINs across all weeks
            const ourData = marketData.filter(isOurs);
            
            const calcAvgShare = (filterFn) => {
                const subset = ourData.filter(filterFn);
                if (subset.length === 0) return 0;
                return subset.reduce((s,d) => s + d.click_share, 0) / subset.length;
            };

            const baseShare = calcAvgShare(d => true);
            const wDeal = calcAvgShare(d => d.weekly_number_of_days_with_deal > 0);
            const wCoupon = calcAvgShare(d => d.weekly_number_of_days_with_coupon > 0);
            const wBadge = calcAvgShare(d => d.weekly_number_of_days_with_best_seller_badge > 0 || d.weekly_number_of_days_with_amazon_choice_badge > 0);
            const wNone = calcAvgShare(d => d.weekly_number_of_days_with_deal === 0 && d.weekly_number_of_days_with_coupon === 0);

            const data = google.visualization.arrayToDataTable([
                ['Condition', 'Avg Click Share %', { role: 'style' }],
                ['Baseline (All)', baseShare, '#4285F4'],
                ['With Deal', wDeal, '#EA4335'],
                ['With Coupon', wCoupon, '#34A853'],
                ['With Badge', wBadge, '#FBBC05'],
                ['No Promo', wNone, '#9AA0A6']
            ]);

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
            chart.draw(data, {
                legend: { position: 'none' },
                vAxis: { title: 'Avg Share %' },
                bar: { groupWidth: "50%" }
            });
        }

        // ---------------- INSIGHTS ----------------

        function generateInsights(weeks) {
            const insights = [];
            const actions = [];
            const lastWeek = weeks[weeks.length - 1];
            const ourDataLW = marketData.filter(d => d.week_date === lastWeek && isOurs(d));
            
            // 1. Efficiency Insight
            const efficientAsins = ourDataLW.filter(d => d.organic_rank < 10 && d.click_share < 5);
            if (efficientAsins.length > 0) {
                insights.push({
                    icon: 'warning',
                    title: 'Low Conversion on Top Ranked ASINs',
                    text: `${efficientAsins.length} ASINs rank Top 10 but have < 5% share. Price or Image issue?`
                });
                actions.push('Audit main image and price for ASINs ranking < 10 with low share.');
            } else {
                insights.push({
                    icon: 'check_circle',
                    title: 'Strong Rank-to-Share Correlation',
                    text: 'Our high ranking items are capturing expected market share.'
                });
            }

            // 2. Deal Efficiency
            const ourDeals = marketData.filter(d => isOurs(d) && d.weekly_number_of_days_with_deal > 0);
            const avgShareDeals = ourDeals.reduce((s,d) => s + d.click_share, 0) / (ourDeals.length || 1);
            const avgShareNoDeals = marketData.filter(d => isOurs(d) && d.weekly_number_of_days_with_deal === 0).reduce((s,d) => s + d.click_share, 0) / (marketData.length || 1); // rough approx
            
            if (avgShareDeals > avgShareNoDeals * 1.2) {
                insights.push({
                    icon: 'trending_up',
                    title: 'Deals are highly effective',
                    text: `Deals drive significantly higher share (${avgShareDeals.toFixed(1)}% vs baseline).`
                });
                actions.push('Increase deal frequency on underperforming ASINs to regain traction.');
            }

            // 3. Competitor Movement
            const lwData = marketData.filter(d => d.week_date === lastWeek);
            const topCompASIN = lwData.filter(d => !isOurs(d)).sort((a,b) => b.click_share - a.click_share)[0];
            if (topCompASIN) {
                insights.push({
                    icon: 'priority_high',
                    title: `Top Threat: ${getBrand(topCompASIN)}`,
                    text: `Competitor ASIN ${topCompASIN.asin} captured ${topCompASIN.click_share}% share last week.`
                });
                actions.push(`Analyze PDP of ${getBrand(topCompASIN)} (${topCompASIN.asin}) for feature gaps.`);
            }

            // Render
            const renderList = (items, containerId) => {
                const html = items.map(i => {
                    if (typeof i === 'string') {
                        return `<div class="insight-item"><span class="material-icons insight-icon" style="font-size:16px;">arrow_forward</span><div class="insight-text">${i}</div></div>`;
                    }
                    return `
                    <div class="insight-item">
                        <span class="material-icons insight-icon">${i.icon}</span>
                        <div class="insight-text"><strong>${i.title}</strong>${i.text}</div>
                    </div>`;
                }).join('');
                document.getElementById(containerId).innerHTML = html;
            };

            renderList(insights, 'insights-container');
            renderList(actions, 'actions-container');

            // Other Insights (Libre)
            const otherInsights = `
                <ul style="padding-left: 20px;">
                    <li><strong>Price Sensitivity:</strong> Market appears responsive to price drops below average category price.</li>
                    <li><strong>Badge Stability:</strong> 'Amazon Choice' badge retention fluctuates, impacting mid-week traffic.</li>
                    <li><strong>Long-tail keywords:</strong> Secondary keywords showing rising volume not fully captured by current leaders.</li>
                </ul>
            `;
            document.getElementById('other-insights-container').innerHTML = otherInsights;
        }

        // ---------------- INTERACTIVE TAB ----------------
        
        function switchTab(tabId) {
            document.getElementById('tab-dashboard').classList.add('hidden');
            document.getElementById('tab-comparator').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-'+tabId).classList.remove('hidden');
            event.target.classList.add('active');
        }

        function setupComparator(weeks) {
            const weekSelect = document.getElementById('comp-week-select');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSelect.add(opt);
            });
            weekSelect.value = weeks[weeks.length-1]; // Select latest

            // Populate Competitors based on selected week (initially)
            updateCompetitorList();
        }

        function updateCompetitorList() {
            const week = document.getElementById('comp-week-select').value;
            const compSelect = document.getElementById('comp-asin-select');
            compSelect.innerHTML = '';
            
            const weekData = marketData.filter(d => d.week_date === week && !isOurs(d));
            // Sort by share
            weekData.sort((a,b) => b.click_share - a.click_share);
            
            weekData.slice(0, 10).forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.asin;
                opt.text = `${getBrand(d)} - ${d.asin} (${d.click_share}%)`;
                compSelect.add(opt);
            });

            updateComparator();
        }

        function updateComparator() {
            const week = document.getElementById('comp-week-select').value;
            const compAsin = document.getElementById('comp-asin-select').value;

            // Find Our Best ASIN for that week
            const ourData = marketData.filter(d => d.week_date === week && isOurs(d));
            const bestOurs = ourData.sort((a,b) => b.click_share - a.click_share)[0];

            // Find Selected Competitor
            const compData = marketData.find(d => d.week_date === week && d.asin === compAsin);

            const renderSide = (data, prefix, isUs) => {
                if(!data) return;
                document.getElementById(prefix+'-detail').innerHTML = `<strong style="font-size:14px;">${data.product_title.substring(0, 40)}...</strong><br><span style="font-size:12px; color:#666;">${data.asin}</span>`;
                document.getElementById(prefix+'-price').textContent = '$' + data.price.toFixed(2);
                document.getElementById(prefix+'-share').textContent = data.click_share + '%';
                document.getElementById(prefix+'-rank').textContent = '#' + data.organic_rank;
                
                let badges = '';
                if(data.weekly_number_of_days_with_best_seller_badge > 0) badges += '<span class="badge badge-bs">BEST SELLER</span>';
                if(data.weekly_number_of_days_with_amazon_choice_badge > 0) badges += '<span class="badge badge-ac">CHOICE</span>';
                if(data.weekly_number_of_days_with_deal > 0) badges += '<span class="badge badge-deal">DEAL</span>';
                if(badges === '') badges = '<span style="font-size:10px; color:#ccc;">No Badges</span>';
                
                document.getElementById(prefix+'-badges').innerHTML = badges;
            };

            if(bestOurs) renderSide(bestOurs, 'us', true);
            if(compData) renderSide(compData, 'them', false);
        }

        // Add event listener for week change to update competitor list
        document.getElementById('comp-week-select').addEventListener('change', updateCompetitorList);

    </script>
</body>
</html>