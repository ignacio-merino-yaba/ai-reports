<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - NaturaleBio</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #1a73e8; /* Google Blue */
            --secondary: #5f6368; /* Grey */
            --success: #1e8e3e; /* Green */
            --danger: #d93025; /* Red */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #202124;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            margin-bottom: 24px;
        }
        .header-title {
            font-size: 28px;
            font-weight: 600;
            color: #202124;
        }
        .header-subtitle {
            color: var(--secondary);
            font-size: 14px;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .tab-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: none;
            background: #e8eaed;
            color: var(--secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(26,115,232,0.3);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.12);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        .kpi-label {
            font-size: 12px;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trend-up { color: var(--success); font-size: 13px; font-weight: 500; }
        .trend-down { color: var(--danger); font-size: 13px; font-weight: 500; }

        /* Charts Container */
        .chart-container {
            width: 100%;
            height: 400px;
        }
        
        /* Insights List */
        .insights-list {
            list-style: none;
            padding: 0;
        }
        .insights-list li {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f3f4;
        }
        .insights-list li:last-child { border-bottom: none; }
        .insight-icon {
            color: var(--primary);
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            outline: none;
        }

        /* Utility */
        .hidden { display: none; }
        .section-tag {
            background: #e8f0fe;
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-title">Market Intelligence: NaturaleBio</div>
        <div class="header-subtitle">An√°lisis Estrat√©gico de Parent ASIN | Datos Semanales</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTA√ëA 1: REPORTE EST√ÅTICO -->
    <div id="tab-static">
        
        <!-- KPI Summary (Last Week) -->
        <div class="kpi-grid" id="kpi-container">
            <!-- Injected by JS -->
        </div>

        <!-- 1. Tendencia Global -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div id="insight_trend" style="margin-top:10px; font-size:14px; color:#5f6368;"></div>
        </div>

        <!-- 2. Competitividad de Marca -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Share of Voice)
                </div>
            </div>
            <div id="chart_competitiveness" class="chart-container"></div>
            <div id="insight_competitiveness" style="margin-top:10px; font-size:14px; color:#5f6368;"></div>
        </div>

        <!-- 3. Palancas (Levers) -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">tune</span>
                    3. Palancas de Crecimiento (Precio & Promociones)
                </div>
            </div>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div id="chart_price_corr" style="flex:1; min-width:300px; height:300px;"></div>
                <div id="chart_badges" style="flex:1; min-width:300px; height:300px;"></div>
            </div>
        </div>

        <!-- 4. Eficiencia (Rank vs Share) -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Eficiencia: Organic Rank vs Click Share
                </div>
            </div>
            <div id="chart_efficiency" class="chart-container"></div>
            <p style="font-size:12px; color:gray; text-align:center;">
                Eje X: Ranking Org√°nico (Menor es mejor) | Eje Y: Click Share (%) | Burbuja: Volumen
            </p>
        </div>

        <!-- 5. Conclusiones y Recomendaciones -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Conclusiones y Recomendaciones Accionables
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
                <div>
                    <h3 style="font-size:16px; margin-bottom:12px;">üîç Insights Clave</h3>
                    <ul class="insights-list" id="insights_final_list">
                        <!-- Filled by JS -->
                    </ul>
                </div>
                <div>
                    <h3 style="font-size:16px; margin-bottom:12px;">üöÄ Plan de Acci√≥n</h3>
                    <ul class="insights-list" id="recommendations_list">
                        <!-- Filled by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Other Insights -->
        <div class="card">
             <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">analytics</span>
                    An√°lisis Adicional (Anomal√≠as)
                </div>
            </div>
            <div id="other_insights_text" style="font-size:14px;"></div>
        </div>
    </div>

    <!-- PESTA√ëA 2: INTERACTIVO -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label style="font-size:12px; display:block; margin-bottom:4px;">Semana</label>
                <select id="sel_week" onchange="updateInteractive()"></select>
            </div>
            <div>
                <label style="font-size:12px; display:block; margin-bottom:4px;">Competidor a Comparar</label>
                <select id="sel_competitor" onchange="updateInteractive()"></select>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="text-align:center">
                <div class="kpi-label">Diferencial Precio</div>
                <div class="kpi-value" id="diff_price">--</div>
            </div>
             <div class="kpi-card" style="text-align:center">
                <div class="kpi-label">Diferencial Share</div>
                <div class="kpi-value" id="diff_share">--</div>
            </div>
             <div class="kpi-card" style="text-align:center">
                <div class="kpi-label">Diferencial Rank</div>
                <div class="kpi-value" id="diff_rank">--</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title" style="margin-bottom:15px;">Comparativa Directa (Spider Chart / Barras)</div>
            <div id="chart_interactive_comparison" class="chart-container"></div>
        </div>
    </div>

</div>

<script>
    // --- 1. DATA INJECTION ---
    const marketData = [{"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": NaN, "asin": "B000W45AZY", "product_title": "Caotina Dark dunkle Trinkschokolade - Kakao-Pulver...", "country_code": "de", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 2.93, "impression_share": 2.31, "price": 9.722857143, "click_share_rank": 10, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Caotina", "est_clicks": 162.29856}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768LH1CP", "product_title": "Kakao Pulver Bio 500g | Kakao-Pulver mit feinstem ...", "country_code": "de", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.85, "impression_share": 3.45, "price": 22.425714286, "click_share_rank": 4, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "vom-Achterhof", "est_clicks": 268.65119999999996}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768L7FV1", "product_title": "Kakao Pulver Bio 1000g | Kakao-Pulver mit feinstem...", "country_code": "de", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.34, "impression_share": 2.93, "price": 32.67, "click_share_rank": 9, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "vom-Achterhof", "est_clicks": 185.00928}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "Nesquik", "asin": "B0CX24HT4W", "product_title": "Nestl\u00e9 Nesquik Original kakaohaltiges Getr\u00e4nkepulv...", "country_code": "de", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.56, "impression_share": 2.83, "price": 5.911428571, "click_share_rank": 8, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Nesquik", "est_clicks": 197.19552}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "SUCHARD EXPRESS", "asin": "B0D5R1W596", "product_title": "Suchard Express 400g Beutel, Getr\u00e4nkepulver f\u00fcr he...", "country_code": "de", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.06, "impression_share": 2.81, "price": 3.268571429, "click_share_rank": 3, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "SUCHARD EXPRESS", "est_clicks": 280.28352}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "NaturaleBio", "asin": "B07DFPSNGJ", "product_title": "NaturaleBio Kakao Pulver Bio 1kg. Organic Cacao Po...", "country_code": "de", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.82, "impression_share": 2.81, "price": 32.772857143, "click_share_rank": 5, "weekly_search_volume": 5539.2, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "NaturaleBio", "est_clicks": 266.98944}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": NaN, "asin": "B01M6BB18S", "product_title": "Alnatura Bio Kakao schwach ent\u00f6lt, 125g", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 5, "weekly_number_of_days_with_coupon": 0, "click_share": 7.64, "impression_share": 2.83, "price": 4.907142857, "click_share_rank": 2, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Alnatura", "est_clicks": 423.19487999999996}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "Sevenhills Wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.76, "impression_share": 2.81, "price": 30.724285714, "click_share_rank": 6, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Sevenhills Wholefoods", "est_clicks": 263.66591999999997}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "sevenhills wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.76, "impression_share": 2.81, "price": 30.724285714, "click_share_rank": 6, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "sevenhills wholefoods", "est_clicks": 263.66591999999997}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": NaN, "asin": "B0BG2ZNJLT", "product_title": "Cortegas Cacao Puro - 100% Kakaopulver f\u00fcr hochwer...", "country_code": "de", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.97, "impression_share": 2.56, "price": 9.937142857, "click_share_rank": 7, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Cortegas", "est_clicks": 219.90624}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "KABA", "asin": "B0D5QZYXPW", "product_title": "Kaba Choco 400g Beutel Trinkpulver, das Original K...", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 5, "weekly_number_of_days_with_coupon": 0, "click_share": 8.71, "impression_share": 2.87, "price": 2.765714286, "click_share_rank": 1, "weekly_search_volume": 5539.2, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "KABA", "est_clicks": 482.46432000000004}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Sevenhills Wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.42, "impression_share": 2.8, "price": 32.62, "click_share_rank": 4, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Sevenhills Wholefoods", "est_clicks": 165.397262}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Nesquik", "asin": "B0CX24HT4W", "product_title": "Nestl\u00e9 Nesquik Original kakaohaltiges Getr\u00e4nkepulv...", "country_code": "de", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.04, "impression_share": 2.8, "price": 6.2775, "click_share_rank": 6, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Nesquik", "est_clicks": 123.285044}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "NaturaleBio", "asin": "B07DFPSNGJ", "product_title": "NaturaleBio Kakao Pulver Bio 1kg. Organic Cacao Po...", "country_code": "de", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.96, "impression_share": 2.79, "price": 34.7975, "click_share_rank": 8, "weekly_search_volume": 3051.61, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "NaturaleBio", "est_clicks": 120.843756}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "SUCHARD EXPRESS", "asin": "B0D5R1W596", "product_title": "Suchard Express 400g Beutel, Getr\u00e4nkepulver f\u00fcr he...", "country_code": "de", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.03, "impression_share": 2.78, "price": 3.47, "click_share_rank": 5, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "SUCHARD EXPRESS", "est_clicks": 153.49598300000002}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768L7FV1", "product_title": "Kakao Pulver Bio 1000g | Kakao-Pulver mit feinstem...", "country_code": "de", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.23, "impression_share": 2.83, "price": 34.6875, "click_share_rank": 10, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "vom-Achterhof", "est_clicks": 98.56700300000001}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Sevenhills Wholefoods", "asin": "B00944FKNK", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 500g, Rein u...", "country_code": "de", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.55, "impression_share": 2.78, "price": 19.57, "click_share_rank": 9, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Sevenhills Wholefoods", "est_clicks": 108.332155}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": NaN, "asin": "B0BG2ZNJLT", "product_title": "Cortegas Cacao Puro - 100% Kakaopulver f\u00fcr hochwer...", "country_code": "de", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.04, "impression_share": 2.47, "price": 10.55, "click_share_rank": 6, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Cortegas", "est_clicks": 123.285044}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768LH1CP", "product_title": "Kakao Pulver Bio 500g | Kakao-Pulver mit feinstem ...", "country_code": "de", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 6.32, "impression_share": 4.12, "price": 23.81, "click_share_rank": 3, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "vom-Achterhof", "est_clicks": 192.86175200000002}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "KABA", "asin": "B0D5QZYXPW", "product_title": "Kaba Choco 400g Beutel Trinkpulver, das Original K...", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 2, "weekly_number_of_days_with_coupon": 0, "click_share": 8.9, "impression_share": 2.85, "price": 3.2525, "click_share_rank": 1, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "KABA", "est_clicks": 271.59329}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": NaN, "asin": "B01M6BB18S", "product_title": "Alnatura Bio Kakao schwach ent\u00f6lt, 125g", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 0, "click_share": 8.78, "impression_share": 2.82, "price": 5.2125, "click_share_rank": 2, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "Alnatura", "est_clicks": 267.931358}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "sevenhills wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.42, "impression_share": 2.8, "price": 32.62, "click_share_rank": 4, "weekly_search_volume": 3051.61, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver", "brand_real": "sevenhills wholefoods", "est_clicks": 165.397262}];
    const MY_BRAND_NAME = "NaturaleBio";

    // --- 2. GOOGLE CHARTS INIT ---
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    // --- 3. STATE & UTILS ---
    function switchTab(tabName) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        // Find button by text roughly or index (simplified)
        event.target.classList.add('active');
    }

    function getWeeks() {
        return [...new Set(marketData.map(d => d.week_date))].sort();
    }
    
    function getCompetitors() {
        const allBrands = [...new Set(marketData.map(d => d.brand_real))];
        return allBrands.filter(b => b !== MY_BRAND_NAME);
    }

    // --- 4. CORE LOGIC ---
    function initDashboard() {
        renderKPISummary();
        drawTrendChart();
        drawCompetitivenessChart();
        drawEfficiencyChart();
        drawLeverAnalysis();
        generateTextInsights();
        initInteractiveControls();
    }

    function renderKPISummary() {
        const weeks = getWeeks();
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];

        // Filter data for my brand
        const myDataLast = marketData.filter(d => d.week_date === lastWeek && d.brand_real === MY_BRAND_NAME);
        const myDataPrev = marketData.filter(d => d.week_date === prevWeek && d.brand_real === MY_BRAND_NAME);

        // Aggregations
        const sumClicksLast = myDataLast.reduce((a,b) => a + b.est_clicks, 0);
        const sumClicksPrev = myDataPrev.reduce((a,b) => a + b.est_clicks, 0);
        
        // Weighted Avg Share
        const totalVolLast = myDataLast.reduce((a,b) => a + b.weekly_search_volume, 0) || 1;
        const wShareLast = myDataLast.reduce((a,b) => a + (b.click_share * b.weekly_search_volume), 0) / totalVolLast;
        
        const totalVolPrev = myDataPrev.reduce((a,b) => a + b.weekly_search_volume, 0) || 1;
        const wSharePrev = myDataPrev.reduce((a,b) => a + (b.click_share * b.weekly_search_volume), 0) / totalVolPrev;

        const deltaClicks = ((sumClicksLast - sumClicksPrev) / sumClicksPrev * 100).toFixed(1);
        const deltaShare = (wShareLast - wSharePrev).toFixed(2);

        // Render HTML
        const container = document.getElementById('kpi-container');
        container.innerHTML = `
            <div class="kpi-card">
                <div class="kpi-label">Total Clicks (Last Week)</div>
                <div class="kpi-value">${Math.round(sumClicksLast)}</div>
                <div class="${deltaClicks >= 0 ? 'trend-up' : 'trend-down'}">
                    ${deltaClicks > 0 ? '+' : ''}${deltaClicks}% vs prev
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Weighted Click Share</div>
                <div class="kpi-value">${wShareLast.toFixed(2)}%</div>
                <div class="${deltaShare >= 0 ? 'trend-up' : 'trend-down'}">
                    ${deltaShare > 0 ? '+' : ''}${deltaShare} pp
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active Keywords</div>
                <div class="kpi-value">${myDataLast.length}</div>
            </div>
        `;
    }

    function drawTrendChart() {
        // Logic: Group by Week -> Sum Clicks (My Brand vs Competitors) + Avg Click Share (My Brand)
        const weeks = getWeeks();
        const dataTable = [['Week', 'My Clicks', 'Competitor Clicks', 'My Click Share (%)']];

        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            
            const myData = weekData.filter(d => d.brand_real === MY_BRAND_NAME);
            const compData = weekData.filter(d => d.brand_real !== MY_BRAND_NAME);

            const myClicks = myData.reduce((a,b) => a + b.est_clicks, 0);
            const compClicks = compData.reduce((a,b) => a + b.est_clicks, 0);

            // Weighted Share for My Brand
            const totalVol = myData.reduce((a,b) => a + b.weekly_search_volume, 0) || 1;
            const myShare = myData.reduce((a,b) => a + (b.click_share * b.weekly_search_volume), 0) / totalVol;

            dataTable.push([week, myClicks, compClicks, myShare]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}},
            colors: ['#4285F4', '#E0E0E0', '#FBBC05'],
            vAxes: {0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''}},
            chartArea: {width: '80%', height: '70%'},
            legend: {position: 'bottom'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function drawCompetitivenessChart() {
        // 1. Identify Top 3 Competitors by Total Click Volume
        const brandVols = {};
        marketData.forEach(d => {
            if (d.brand_real !== MY_BRAND_NAME) {
                brandVols[d.brand_real] = (brandVols[d.brand_real] || 0) + d.est_clicks;
            }
        });
        const top3 = Object.entries(brandVols)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);

        // 2. Build Data Table
        const weeks = getWeeks();
        // Header: Week, MyBrand, Comp1, Comp2, Comp3, Rest
        const header = ['Week', MY_BRAND_NAME, ...top3, 'Others'];
        const rows = [];

        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const row = [week];

            // Helper to get weighted share
            const getShare = (brandName) => {
                let subset;
                if (brandName === 'Others') {
                    subset = weekData.filter(d => d.brand_real !== MY_BRAND_NAME && !top3.includes(d.brand_real));
                } else {
                    subset = weekData.filter(d => d.brand_real === brandName);
                }
                
                if (subset.length === 0) return 0;
                const vol = subset.reduce((a,b) => a + b.weekly_search_volume, 0) || 1;
                return subset.reduce((a,b) => a + (b.click_share * b.weekly_search_volume), 0) / vol;
            };

            row.push(getShare(MY_BRAND_NAME));
            top3.forEach(c => row.push(getShare(c)));
            row.push(getShare('Others'));
            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            chartArea: {width: '85%', height: '70%'},
            legend: {position: 'bottom'},
            vAxis: {title: 'Click Share %'},
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'] // Distinct colors
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Scatter: X=Avg Rank, Y=Click Share, Size=Search Volume, Color=MyBrand vs Comp
        // Focus on latest week
        const weeks = getWeeks();
        const lastWeek = weeks[weeks.length - 1];
        const subset = marketData.filter(d => d.week_date === lastWeek);

        const dataTable = [['ID', 'Organic Rank', 'Click Share', 'Brand', 'Volume']];
        
        subset.forEach(d => {
            // Add jitter to X slightly to avoid overlap
            const isMine = d.brand_real === MY_BRAND_NAME;
            const label = isMine ? 'My Brand' : 'Competition';
            dataTable.push([
                d.brand_real, 
                d.average_organic_rank, 
                d.click_share, 
                label,
                d.weekly_search_volume
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: 1},
            vAxis: {title: 'Click Share (%)'},
            bubble: {textStyle: {fontSize: 11}},
            colors: ['#EA4335', '#4285F4'], // Red (Comp), Blue (Mine) - alphabetical order of label usually
            chartArea: {width: '80%', height: '70%'},
            explorer: { actions: ['dragToZoom', 'rightClickToReset'] }
        };

        const chart = new google.visualization.BubbleChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function drawLeverAnalysis() {
        // Chart 1: Price vs Share Correlation (Scatter simplified)
        // Group by brand and week
        const dataArr = [['Price', 'Share', { role: 'style' }]];
        marketData.forEach(d => {
            const color = d.brand_real === MY_BRAND_NAME ? '#4285F4' : '#ccc';
            if(d.price > 0 && d.click_share > 0) {
                dataArr.push([d.price, d.click_share, color]);
            }
        });

        const dataPrice = google.visualization.arrayToDataTable(dataArr);
        const optPrice = {
            title: 'Correlaci√≥n Precio vs Share',
            hAxis: {title: 'Price (‚Ç¨)'},
            vAxis: {title: 'Share (%)'},
            legend: 'none',
            chartArea: {width: '80%', height: '70%'}
        };
        new google.visualization.ScatterChart(document.getElementById('chart_price_corr')).draw(dataPrice, optPrice);

        // Chart 2: Badge Impact (Deals vs None)
        // Compare Avg Share when deal > 0 vs deal = 0
        const withDeal = marketData.filter(d => d.weekly_number_of_days_with_deal > 0);
        const withoutDeal = marketData.filter(d => d.weekly_number_of_days_with_deal === 0);
        
        const avgShareDeal = withDeal.reduce((a,b)=>a+b.click_share,0) / (withDeal.length || 1);
        const avgShareNoDeal = withoutDeal.reduce((a,b)=>a+b.click_share,0) / (withoutDeal.length || 1);

        const dataBadge = google.visualization.arrayToDataTable([
            ['Condition', 'Avg Click Share', { role: 'style' }],
            ['Con Deal', avgShareDeal, '#34A853'],
            ['Sin Deal', avgShareNoDeal, '#9AA0A6']
        ]);
        
        const optBadge = {
            title: 'Impacto Promociones (Deals)',
            legend: 'none',
            vAxis: {minValue: 0}
        };
        new google.visualization.ColumnChart(document.getElementById('chart_badges')).draw(dataBadge, optBadge);
    }

    function generateTextInsights() {
        const weeks = getWeeks();
        const lastWeek = weeks[weeks.length - 1];
        
        // --- 1. Global Trend Insight ---
        const myDataLast = marketData.filter(d => d.week_date === lastWeek && d.brand_real === MY_BRAND_NAME);
        const myShare = myDataLast.reduce((a,b) => a + b.click_share, 0) / (myDataLast.length || 1); // Simple avg for text
        const totalShare = 100; // Relative
        
        const trendList = document.getElementById('insights_final_list');
        const recList = document.getElementById('recommendations_list');

        let trendText = "";
        let recText = "";

        // Insight 1: Share Dominance
        if (myShare > 15) {
            trendList.innerHTML += `<li><span class="material-icons insight-icon">verified</span><strong>Liderazgo S√≥lido:</strong> Nuestra marca mantiene una cuota significativa (>15%) en el parent.</li>`;
        } else {
            trendList.innerHTML += `<li><span class="material-icons insight-icon">warning</span><strong>Baja Visibilidad:</strong> La cuota de clic es baja, sugiriendo alta competencia o ranking deficiente.</li>`;
        }

        // Insight 2: Price Position
        const avgPriceMy = myDataLast.reduce((a,b)=>a+b.price,0) / (myDataLast.length || 1);
        const compData = marketData.filter(d => d.week_date === lastWeek && d.brand_real !== MY_BRAND_NAME);
        const avgPriceComp = compData.reduce((a,b)=>a+b.price,0) / (compData.length || 1);
        
        if (avgPriceMy > avgPriceComp * 1.2) {
             trendList.innerHTML += `<li><span class="material-icons insight-icon">payments</span><strong>Precio Premium:</strong> Estamos un 20%+ por encima del mercado. Verificar si la conversi√≥n justifica el precio.</li>`;
             recText += `<li>Evaluar elasticidad de precio o activar cupones para reducir barrera de entrada.</li>`;
        } else if (avgPriceMy < avgPriceComp * 0.8) {
             trendList.innerHTML += `<li><span class="material-icons insight-icon">trending_down</span><strong>Precio Agresivo:</strong> Precio significativamente menor. ¬øEstamos dejando margen sobre la mesa?</li>`;
        }

        // Insight 3: Deals
        const activeDeals = myDataLast.filter(d => d.weekly_number_of_days_with_deal > 0).length;
        if (activeDeals === 0) {
            recText += `<li>Activar Deals en variantes con bajo ranking para reactivar el flywheel.</li>`;
        }

        // Insight 4: Efficiency
        const badRankGoodShare = myDataLast.filter(d => d.average_organic_rank > 10 && d.click_share > 5);
        if (badRankGoodShare.length > 0) {
             trendList.innerHTML += `<li><span class="material-icons insight-icon">star</span><strong>Alta Eficiencia:</strong> Algunas variantes convierten muy bien a pesar de mal ranking. Candidatos a Ads.</li>`;
             recText += `<li>Invertir PPC en ASINs eficientes (Alto Share / Bajo Rank) para escalar posiciones.</li>`;
        }

        recList.innerHTML = recText || "<li>Mantener monitoreo de precios semanal.</li><li>Revisar creatividades de ASINs con bajo CTR.</li><li>Optimizar t√≠tulos con keywords de competencia.</li>";
        
        // Other Insights
        document.getElementById('other_insights_text').innerText = "Se detecta alta fragmentaci√≥n en el mercado. Marcas 'Unknown' o secundarias acumulan cuota relevante, indicando oportunidad para consolidaci√≥n mediante branding agresivo.";
    }

    function initInteractiveControls() {
        const weekSel = document.getElementById('sel_week');
        getWeeks().forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        weekSel.value = getWeeks()[getWeeks().length -1]; // Select last

        const compSel = document.getElementById('sel_competitor');
        getCompetitors().forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });
        
        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('sel_week').value;
        const comp = document.getElementById('sel_competitor').value;

        // Filter Data
        const myData = marketData.filter(d => d.week_date === week && d.brand_real === MY_BRAND_NAME);
        const compData = marketData.filter(d => d.week_date === week && d.brand_real === comp);

        // Calc Averages
        const getAvg = (data, field) => data.reduce((a,b) => a + b[field], 0) / (data.length || 1);
        
        const myPrice = getAvg(myData, 'price');
        const compPrice = getAvg(compData, 'price');
        
        const myShare = getAvg(myData, 'click_share');
        const compShare = getAvg(compData, 'click_share');

        const myRank = getAvg(myData, 'average_organic_rank');
        const compRank = getAvg(compData, 'average_organic_rank');

        // Update KPIs
        document.getElementById('diff_price').innerText = (myPrice - compPrice).toFixed(2) + ' ‚Ç¨';
        document.getElementById('diff_price').style.color = (myPrice > compPrice) ? '#d93025' : '#1e8e3e';
        
        document.getElementById('diff_share').innerText = (myShare - compShare).toFixed(2) + ' %';
        document.getElementById('diff_share').style.color = (myShare > compShare) ? '#1e8e3e' : '#d93025';

        document.getElementById('diff_rank').innerText = (myRank - compRank).toFixed(1);

        // Update Chart (Bar Comparison)
        const data = google.visualization.arrayToDataTable([
            ['Metric', 'My Brand', comp],
            ['Price (‚Ç¨)', myPrice, compPrice],
            ['Share (%)', myShare, compShare],
            ['Rank (Inv)', 20 - myRank, 20 - compRank] // Invert rank for visual (higher bar is better)
        ]);

        const options = {
            title: 'Comparativa Directa (Rank Invertido: Barra alta es mejor)',
            bars: 'horizontal',
            colors: ['#4285F4', '#EA4335']
        };

        const chart = new google.visualization.BarChart(document.getElementById('chart_interactive_comparison'));
        chart.draw(data, options);
    }

</script>

</body>
</html>