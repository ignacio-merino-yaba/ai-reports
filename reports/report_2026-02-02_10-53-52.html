<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon ASIN Performance Report</title>
    <!-- Google Native Dependencies -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* Google Material Design / Apple-like Hybrid Style */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-radius: 16px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #fff;
            padding: 10px;
            border-radius: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .nav-tab {
            padding: 10px 24px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: var(--primary-color);
        }

        .section-title .material-icons {
            margin-right: 10px;
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Metrics */
        .metric-big {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }

        /* Text Content */
        .analysis-text ul {
            padding-left: 20px;
        }
        .analysis-text li {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        .highlight-box {
            background-color: #e8f0fe;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            background: white;
            cursor: pointer;
            outline: none;
        }
        
        select:focus {
            border-color: var(--primary-color);
        }

        /* Hidden Sections */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-weight: 300; margin-bottom: 10px;">Market Intelligence <span style="font-weight: 700;">ASIN Report</span></h1>
            <p style="color: var(--text-secondary);">Análisis Profundo de Rendimiento, Competitividad y Palancas</p>
        </header>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('static')">Reporte Estratégico</div>
            <div class="nav-tab" onclick="switchTab('interactive')">Comparador Interactivo</div>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="static-tab">
            
            <!-- Section 1: Tendencia Global -->
            <div class="card">
                <div class="section-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent (Últimas 5 Semanas)
                </div>
                <div class="grid-2">
                    <div id="chart_global_trend" style="height: 300px;"></div>
                    <div class="analysis-text">
                        <div class="metric-label">Total Clicks (Última Semana)</div>
                        <div class="metric-big" id="metric-total-clicks">-</div>
                        <div id="metric-trend-text" style="font-size: 0.9rem; margin-bottom: 15px;"></div>
                        
                        <div class="highlight-box">
                            <strong>Insight Principal:</strong>
                            <p id="insight-global" style="margin: 5px 0 0 0; font-size: 0.9rem;">Analizando datos...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Competitividad -->
            <div class="card">
                <div class="section-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Share of Voice)
                </div>
                <div class="grid-2">
                    <div id="chart_competitiveness" style="height: 300px;"></div>
                    <div class="analysis-text">
                        <h4>Dinámica de Mercado</h4>
                        <ul id="list-competitiveness-insights">
                            <li>Cargando análisis...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 3 & 4: Palancas & Eficiencia -->
            <div class="grid-2">
                <div class="card">
                    <div class="section-title">
                        <span class="material-icons">tune</span>
                        3. Impacto de Palancas (Deals & Badges)
                    </div>
                    <div id="levers-analysis" class="analysis-text">
                        <!-- Dynamic Content -->
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">
                        <span class="material-icons">scatter_plot</span>
                        4. Eficiencia (Rank vs Share)
                    </div>
                    <div id="chart_efficiency" style="height: 200px;"></div>
                    <p id="efficiency-insight" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 10px;"></p>
                </div>
            </div>

            <!-- Section 5: Conclusiones -->
            <div class="card" style="border-left: 5px solid var(--success-color);">
                <div class="section-title">
                    <span class="material-icons">lightbulb</span>
                    5. Conclusiones y Acciones Recomendadas
                </div>
                <div class="grid-2">
                    <div>
                        <h4 style="margin-top:0;">Insights Clave</h4>
                        <ul id="final-insights-list" class="analysis-text"></ul>
                    </div>
                    <div>
                        <h4 style="margin-top:0;">Recomendaciones Accionables</h4>
                        <ul id="final-recommendations-list" class="analysis-text"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="interactive-tab" class="hidden">
            <div class="card">
                <div class="section-title">
                    <span class="material-icons">compare_arrows</span>
                    Cara a Cara: Nosotros vs Competencia
                </div>
                
                <div class="controls">
                    <select id="comp-selector" onchange="renderComparator()">
                        <option value="">Selecciona Competidor</option>
                    </select>
                    <select id="week-selector" onchange="renderComparator()">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="grid-3" id="comparator-cards">
                    <!-- Cards will be injected here -->
                </div>
            </div>
            
            <div class="card">
                 <div class="section-title">Detalle de Datos</div>
                 <div id="table_div" style="width: 100%;"></div>
            </div>
        </div>

    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script>
        // --- 1. DATA INJECTION ---
        // This variable is populated by the Python step before generating HTML
        const marketData = [{"week_date": "2023-10-01", "parent_asin": "PARENT123", "asin": "B00YABA001", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 001", "is_yaba_asin": "Y", "click_share": 7.5, "price": 29.99, "weekly_search_volume": 1022, "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 76}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "asin": "B00YABA002", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 002", "is_yaba_asin": "Y", "click_share": 7.5, "price": 29.99, "weekly_search_volume": 1022, "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 76}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "asin": "B00ALPHA01", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A01", "is_yaba_asin": "N", "click_share": 15.0, "price": 45.0, "weekly_search_volume": 1022, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 153}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "asin": "B00ALPHA02", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A02", "is_yaba_asin": "N", "click_share": 15.0, "price": 45.0, "weekly_search_volume": 1022, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 153}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "asin": "B00BETA001", "competitor_brand": "CompBeta", "product_title": "CompBeta Wireless Product 001", "is_yaba_asin": "N", "click_share": 20.0, "price": 25.0, "weekly_search_volume": 1022, "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 204}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "asin": "B00GAMMA01", "competitor_brand": "CompGamma", "product_title": "CompGamma Wireless Product A01", "is_yaba_asin": "N", "click_share": 10.0, "price": 19.99, "weekly_search_volume": 1022, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 102}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "asin": "B00OTHER01", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R01", "is_yaba_asin": "N", "click_share": 2.5, "price": 35.0, "weekly_search_volume": 1022, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 25}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "asin": "B00OTHER02", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R02", "is_yaba_asin": "N", "click_share": 2.5, "price": 35.0, "weekly_search_volume": 1022, "average_organic_rank": 28, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 25}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "asin": "B00YABA001", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 001", "is_yaba_asin": "Y", "click_share": 7.5, "price": 29.99, "weekly_search_volume": 1017, "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 76}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "asin": "B00YABA002", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 002", "is_yaba_asin": "Y", "click_share": 7.5, "price": 29.99, "weekly_search_volume": 1017, "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 76}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "asin": "B00ALPHA01", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A01", "is_yaba_asin": "N", "click_share": 15.0, "price": 45.0, "weekly_search_volume": 1017, "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 152}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "asin": "B00ALPHA02", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A02", "is_yaba_asin": "N", "click_share": 15.0, "price": 45.0, "weekly_search_volume": 1017, "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 152}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "asin": "B00BETA001", "competitor_brand": "CompBeta", "product_title": "CompBeta Wireless Product 001", "is_yaba_asin": "N", "click_share": 20.0, "price": 25.0, "weekly_search_volume": 1017, "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 203}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "asin": "B00GAMMA01", "competitor_brand": "CompGamma", "product_title": "CompGamma Wireless Product A01", "is_yaba_asin": "N", "click_share": 10.0, "price": 19.99, "weekly_search_volume": 1017, "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 101}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "asin": "B00OTHER01", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R01", "is_yaba_asin": "N", "click_share": 2.5, "price": 35.0, "weekly_search_volume": 1017, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 25}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "asin": "B00OTHER02", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R02", "is_yaba_asin": "N", "click_share": 2.5, "price": 35.0, "weekly_search_volume": 1017, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 25}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "asin": "B00YABA001", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 001", "is_yaba_asin": "Y", "click_share": 7.5, "price": 29.99, "weekly_search_volume": 997, "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 74}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "asin": "B00YABA002", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 002", "is_yaba_asin": "Y", "click_share": 7.5, "price": 29.99, "weekly_search_volume": 997, "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 74}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "asin": "B00ALPHA01", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A01", "is_yaba_asin": "N", "click_share": 15.0, "price": 45.0, "weekly_search_volume": 997, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 149}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "asin": "B00ALPHA02", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A02", "is_yaba_asin": "N", "click_share": 15.0, "price": 45.0, "weekly_search_volume": 997, "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 149}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "asin": "B00BETA001", "competitor_brand": "CompBeta", "product_title": "CompBeta Wireless Product 001", "is_yaba_asin": "N", "click_share": 20.0, "price": 25.0, "weekly_search_volume": 997, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 199}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "asin": "B00GAMMA01", "competitor_brand": "CompGamma", "product_title": "CompGamma Wireless Product A01", "is_yaba_asin": "N", "click_share": 10.0, "price": 19.99, "weekly_search_volume": 997, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 99}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "asin": "B00OTHER01", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R01", "is_yaba_asin": "N", "click_share": 2.5, "price": 35.0, "weekly_search_volume": 997, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 24}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "asin": "B00OTHER02", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R02", "is_yaba_asin": "N", "click_share": 2.5, "price": 35.0, "weekly_search_volume": 997, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 24}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "asin": "B00YABA001", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 001", "is_yaba_asin": "Y", "click_share": 11.25, "price": 25.49, "weekly_search_volume": 1056, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 118}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "asin": "B00YABA002", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 002", "is_yaba_asin": "Y", "click_share": 11.25, "price": 25.49, "weekly_search_volume": 1056, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 118}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "asin": "B00ALPHA01", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A01", "is_yaba_asin": "N", "click_share": 13.5, "price": 45.0, "weekly_search_volume": 1056, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 142}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "asin": "B00ALPHA02", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A02", "is_yaba_asin": "N", "click_share": 13.5, "price": 45.0, "weekly_search_volume": 1056, "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 142}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "asin": "B00BETA001", "competitor_brand": "CompBeta", "product_title": "CompBeta Wireless Product 001", "is_yaba_asin": "N", "click_share": 18.0, "price": 25.0, "weekly_search_volume": 1056, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 190}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "asin": "B00GAMMA01", "competitor_brand": "CompGamma", "product_title": "CompGamma Wireless Product A01", "is_yaba_asin": "N", "click_share": 9.0, "price": 19.99, "weekly_search_volume": 1056, "average_organic_rank": 13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 95}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "asin": "B00OTHER01", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R01", "is_yaba_asin": "N", "click_share": 2.25, "price": 35.0, "weekly_search_volume": 1056, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 23}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "asin": "B00OTHER02", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R02", "is_yaba_asin": "N", "click_share": 2.25, "price": 35.0, "weekly_search_volume": 1056, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 23}, {"week_date": "2023-10-29", "parent_asin": "PARENT123", "asin": "B00YABA001", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 001", "is_yaba_asin": "Y", "click_share": 7.5, "price": 29.99, "weekly_search_volume": 1046, "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 78}, {"week_date": "2023-10-29", "parent_asin": "PARENT123", "asin": "B00YABA002", "competitor_brand": "YabaTech", "product_title": "YabaTech Wireless Product 002", "is_yaba_asin": "Y", "click_share": 7.5, "price": 29.99, "weekly_search_volume": 1046, "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 78}, {"week_date": "2023-10-29", "parent_asin": "PARENT123", "asin": "B00ALPHA01", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A01", "is_yaba_asin": "N", "click_share": 15.0, "price": 45.0, "weekly_search_volume": 1046, "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 156}, {"week_date": "2023-10-29", "parent_asin": "PARENT123", "asin": "B00ALPHA02", "competitor_brand": "CompAlpha", "product_title": "CompAlpha Wireless Product A02", "is_yaba_asin": "N", "click_share": 15.0, "price": 45.0, "weekly_search_volume": 1046, "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 156}, {"week_date": "2023-10-29", "parent_asin": "PARENT123", "asin": "B00BETA001", "competitor_brand": "CompBeta", "product_title": "CompBeta Wireless Product 001", "is_yaba_asin": "N", "click_share": 20.0, "price": 25.0, "weekly_search_volume": 1046, "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 209}, {"week_date": "2023-10-29", "parent_asin": "PARENT123", "asin": "B00GAMMA01", "competitor_brand": "CompGamma", "product_title": "CompGamma Wireless Product A01", "is_yaba_asin": "N", "click_share": 10.0, "price": 19.99, "weekly_search_volume": 1046, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 104}, {"week_date": "2023-10-29", "parent_asin": "PARENT123", "asin": "B00OTHER01", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R01", "is_yaba_asin": "N", "click_share": 2.5, "price": 35.0, "weekly_search_volume": 1046, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 26}, {"week_date": "2023-10-29", "parent_asin": "PARENT123", "asin": "B00OTHER02", "competitor_brand": "Unknown Brand", "product_title": "Unknown Brand Wireless Product R02", "is_yaba_asin": "N", "click_share": 2.5, "price": 35.0, "weekly_search_volume": 1046, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "keywords": "wireless headphones", "keywords_link": "https://amazon.com/s?k=wireless+headphones", "clicks": 26}];

        // --- 2. LOGIC & PROCESSING ---
        
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        let ourBrand = "";
        let competitors = [];
        let weeks = [];
        let aggregatedData = {};

        function initDashboard() {
            processData();
            drawGlobalTrend();
            drawCompetitiveness();
            drawEfficiency();
            analyzeLevers();
            generateInsights();
            populateInteractiveControls();
        }

        function switchTab(tabName) {
            document.getElementById('static-tab').classList.add('hidden');
            document.getElementById('interactive-tab').classList.add('hidden');
            document.querySelector('.nav-tabs .active').classList.remove('active');
            
            if(tabName === 'static') {
                document.getElementById('static-tab').classList.remove('hidden');
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
            } else {
                document.getElementById('interactive-tab').classList.remove('hidden');
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
            }
        }

        function processData() {
            // Identify Our Brand
            const ourAsin = marketData.find(r => r.is_yaba_asin === 'Y');
            ourBrand = ourAsin ? ourAsin.competitor_brand : "Unknown";

            // Get unique weeks sorted
            weeks = [...new Set(marketData.map(d => d.week_date))].sort();

            // Aggregation by Brand/Week
            aggregatedData = {};
            
            marketData.forEach(row => {
                const key = `${row.week_date}_${row.competitor_brand}`;
                if(!aggregatedData[key]) {
                    aggregatedData[key] = {
                        week: row.week_date,
                        brand: row.competitor_brand,
                        clicks: 0,
                        share: 0,
                        priceSum: 0,
                        count: 0,
                        rankSum: 0,
                        deals: 0,
                        is_yaba: row.is_yaba_asin === 'Y'
                    };
                }
                aggregatedData[key].clicks += row.clicks;
                aggregatedData[key].share += row.click_share;
                aggregatedData[key].priceSum += row.price;
                aggregatedData[key].rankSum += row.average_organic_rank;
                aggregatedData[key].deals += row.weekly_number_of_days_with_deal;
                aggregatedData[key].count++;
            });

            // Identify Top Competitors
            const brandShares = {};
            marketData.forEach(r => {
                if(r.competitor_brand !== ourBrand) {
                    brandShares[r.competitor_brand] = (brandShares[r.competitor_brand] || 0) + r.click_share;
                }
            });
            competitors = Object.entries(brandShares)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 3)
                .map(e => e[0]);
        }

        function drawGlobalTrend() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Clicks Nuestros');
            data.addColumn('number', 'Clicks Mercado');
            data.addColumn('number', 'Share (%)');

            const trendData = weeks.map(w => {
                const ours = Object.values(aggregatedData).find(d => d.week === w && d.brand === ourBrand);
                const market = Object.values(aggregatedData).filter(d => d.week === w).reduce((sum, d) => sum + d.clicks, 0);
                const ourClicks = ours ? ours.clicks : 0;
                const share = (ourClicks / market) * 100; // Recalculated share based on clicks for consistency
                
                return [w, ourClicks, market, share];
            });

            data.addRows(trendData);

            const options = {
                vAxes: {0: {title: 'Volumen Clicks'}, 1: {title: 'Share %', format: '#\'%\''}},
                hAxis: {title: 'Semana'},
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1}, 2: {type: 'line', targetAxisIndex: 1, color: '#EA4335'}},
                colors: ['#4285F4', '#E0E0E0', '#34A853'],
                legend: {position: 'bottom'},
                chartArea: {width: '80%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);

            // Metrics Update
            const lastWeek = trendData[trendData.length - 1];
            const prevWeek = trendData[trendData.length - 2];
            document.getElementById('metric-total-clicks').innerText = lastWeek[1];
            
            const diff = lastWeek[1] - prevWeek[1];
            const trendText = document.getElementById('metric-trend-text');
            trendText.innerHTML = `<span class="${diff >= 0 ? 'trend-up' : 'trend-down'}">${diff >= 0 ? '▲' : '▼'} ${Math.abs(diff)}</span> vs semana anterior`;

            // Insight Logic
            const insight = diff > 0 
                ? "Nuestra marca ha ganado tracción en la última semana, aumentando el volumen de tráfico cualificado." 
                : "Se observa una contracción en el volumen de clicks. Revisar agresividad de competidores.";
            document.getElementById('insight-global').innerText = insight;
        }

        function drawCompetitiveness() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', ourBrand);
            competitors.forEach(c => data.addColumn('number', c));
            data.addColumn('number', 'Resto');

            weeks.forEach(w => {
                const row = [w];
                // Our Brand
                const ours = Object.values(aggregatedData).find(d => d.week === w && d.brand === ourBrand);
                row.push(ours ? ours.share : 0);
                
                // Top 3
                let top3Sum = 0;
                competitors.forEach(c => {
                    const comp = Object.values(aggregatedData).find(d => d.week === w && d.brand === c);
                    const s = comp ? comp.share : 0;
                    row.push(s);
                    top3Sum += s;
                });

                // Rest
                const totalShare = Object.values(aggregatedData).filter(d => d.week === w).reduce((s, d) => s + d.share, 0);
                const ourShare = ours ? ours.share : 0;
                row.push(totalShare - ourShare - top3Sum);

                data.addRow(row);
            });

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: {title: 'Click Share %'},
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6']
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(data, options);
        }

        function analyzeLevers() {
            // Check correlation between Deals and Share for our brand
            const ourData = Object.values(aggregatedData).filter(d => d.brand === ourBrand);
            const dealWeeks = ourData.filter(d => d.deals > 0);
            const noDealWeeks = ourData.filter(d => d.deals === 0);

            const avgShareDeals = dealWeeks.length ? dealWeeks.reduce((s,d)=>s+d.share,0)/dealWeeks.length : 0;
            const avgShareNoDeals = noDealWeeks.length ? noDealWeeks.reduce((s,d)=>s+d.share,0)/noDealWeeks.length : 0;
            const lift = avgShareNoDeals > 0 ? ((avgShareDeals - avgShareNoDeals)/avgShareNoDeals * 100).toFixed(1) : 0;

            let html = `
                <div style="margin-bottom:15px;">
                    <strong>Efectividad de Promociones:</strong><br>
                    ${dealWeeks.length > 0 ? `Las semanas con Deals generaron un lift del <span class="trend-up">+${lift}%</span> en Click Share.` : "No se activaron deals en el periodo analizado."}
                </div>
                <div>
                    <strong>Comparativa de Precio:</strong><br>
                    Nuestro precio promedio: $${(ourData[0].priceSum/ourData[0].count).toFixed(2)}<br>
                    Líder de categoría (${competitors[0]}): $${(Object.values(aggregatedData).find(d=>d.brand===competitors[0]).priceSum/2).toFixed(2)}
                </div>
            `;
            document.getElementById('levers-analysis').innerHTML = html;
        }

        function drawEfficiency() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank');
            data.addColumn('number', 'Click Share');
            data.addColumn({type: 'string', role: 'style'}); // Color
            data.addColumn({type: 'string', role: 'tooltip'});

            const currentWeek = weeks[weeks.length - 1];
            const weeklyData = marketData.filter(d => d.week_date === currentWeek);

            weeklyData.forEach(row => {
                const color = row.competitor_brand === ourBrand ? '#4285F4' : '#999';
                data.addRow([
                    row.average_organic_rank, 
                    row.click_share, 
                    `point { fill-color: ${color}; }`,
                    `${row.competitor_brand}: Rank ${row.average_organic_rank}, Share ${row.click_share}%`
                ]);
            });

            const options = {
                hAxis: {title: 'Rank Orgánico (Menor es mejor)', direction: -1},
                vAxis: {title: 'Click Share %'},
                legend: 'none',
                colors: ['#4285F4']
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);

            // Efficiency Insight
            const efficient = weeklyData.filter(d => d.average_organic_rank > 10 && d.click_share > 5).length;
            document.getElementById('efficiency-insight').innerText = 
                efficient > 0 ? "Detectados ASINs con alto Share pese a Rank bajo (Oportunidad de ads)." : "Correlación Rank-Share normal.";
        }

        function generateInsights() {
            const ulRecs = document.getElementById('final-recommendations-list');
            const ulInsights = document.getElementById('final-insights-list');
            
            // Generate dynamic recommendations
            const recs = [
                "Mantener competitividad de precio en semanas sin deals.",
                "Defender posición orgánica en top keywords para reducir dependencia de ads.",
                "Analizar estrategias de cupones de competidores emergentes."
            ];
            ulRecs.innerHTML = recs.map(r => `<li>${r}</li>`).join('');

            // Generate insights
            const insights = [
                `Marca dominante actual: ${competitors[0]}`,
                "Sensibilidad alta a promociones detectada.",
                `Nuestra marca mantiene un rank promedio estable.`
            ];
            ulInsights.innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        }

        // --- INTERACTIVE TAB LOGIC ---
        function populateInteractiveControls() {
            const compSel = document.getElementById('comp-selector');
            competitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                compSel.appendChild(opt);
            });
            
            const weekSel = document.getElementById('week-selector');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.appendChild(opt);
            });
            weekSel.value = weeks[weeks.length-1]; // Select last week
        }

        function renderComparator() {
            const comp = document.getElementById('comp-selector').value;
            const week = document.getElementById('week-selector').value;
            if(!comp || !week) return;

            const us = Object.values(aggregatedData).find(d => d.week === week && d.brand === ourBrand) || {share: 0, priceSum: 0, count: 1, rankSum: 0};
            const them = Object.values(aggregatedData).find(d => d.week === week && d.brand === comp) || {share: 0, priceSum: 0, count: 1, rankSum: 0};

            const myPrice = (us.priceSum/us.count).toFixed(2);
            const theirPrice = (them.priceSum/them.count).toFixed(2);

            const html = `
                <div class="card" style="text-align:center;">
                    <h5>Precio Promedio</h5>
                    <div style="font-size:1.5rem; color:var(--primary-color);">$${myPrice}</div>
                    <div style="font-size:1.2rem; color:#999;">vs $${theirPrice}</div>
                </div>
                <div class="card" style="text-align:center;">
                    <h5>Click Share</h5>
                    <div style="font-size:1.5rem; color:var(--primary-color);">${us.share.toFixed(1)}%</div>
                    <div style="font-size:1.2rem; color:#999;">vs ${them.share.toFixed(1)}%</div>
                </div>
                <div class="card" style="text-align:center;">
                    <h5>Rank Promedio</h5>
                    <div style="font-size:1.5rem; color:var(--primary-color);">${(us.rankSum/us.count).toFixed(0)}</div>
                    <div style="font-size:1.2rem; color:#999;">vs ${(them.rankSum/them.count).toFixed(0)}</div>
                </div>
            `;
            document.getElementById('comparator-cards').innerHTML = html;
        }

    </script>
</body>
</html>