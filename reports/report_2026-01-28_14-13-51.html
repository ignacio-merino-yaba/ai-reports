<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado: Matcha Premium</title>
    
    <!-- Google Native Dependencies -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- Tailwind CSS (CDN for styling) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Babel for "in-browser" logic interpretation if needed, though we stick to Vanilla JS for Google compliance -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #1f2937; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 24px; border: 1px solid #e5e7eb; }
        .chart-container { width: 100%; height: 400px; }
        .tab-btn { cursor: pointer; padding: 12px 24px; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; }
        .metric-value { font-size: 24px; font-weight: 700; color: #111827; }
        .metric-label { font-size: 14px; color: #6b7280; }
        .badge { padding: 4px 8px; border-radius: 9999px; font-size: 12px; font-weight: 600; }
        .badge-green { background-color: #dcfce7; color: #166534; }
        .badge-red { background-color: #fee2e2; color: #991b1b; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        
        /* Select styling */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <span class="material-icons text-blue-600 mr-2">analytics</span>
                    <h1 class="text-xl font-bold text-gray-900">An√°lisis Parent ASIN: Matcha Premium</h1>
                </div>
                <div class="flex space-x-4">
                    <button onclick="switchTab('report')" id="tab-report" class="tab-btn active">Reporte Ejecutivo</button>
                    <button onclick="switchTab('interactive')" id="tab-interactive" class="tab-btn text-gray-500 hover:text-gray-700">Comparador Interactivo</button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- ======================= TAB 1: EXECUTIVE REPORT ======================= -->
        <div id="view-report" class="space-y-8 animate-fade-in">
            
            <!-- Executive Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="card flex flex-col justify-between">
                    <div>
                        <p class="metric-label">Tendencia Mercado (Volumen)</p>
                        <p class="metric-value text-red-600">-45.3% <span class="text-sm font-normal text-gray-500">vs semana ant.</span></p>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">Ca√≠da estacional post-navidad esperada.</div>
                </div>
                <div class="card flex flex-col justify-between">
                    <div>
                        <p class="metric-label">Nuestros Clicks (NaturaleBio)</p>
                        <p class="metric-value text-red-600">-41.3% <span class="text-sm font-normal text-gray-500">vs semana ant.</span></p>
                    </div>
                    <div class="mt-2 text-xs text-green-600 font-bold">Resiste mejor que el mercado.</div>
                </div>
                <div class="card flex flex-col justify-between">
                    <div>
                        <p class="metric-label">Top Competidor</p>
                        <p class="metric-value text-gray-800">NORITUAL LAB</p>
                    </div>
                    <div class="mt-2 text-xs text-blue-600">Dominio por Cupones (4-7 d√≠as activos).</div>
                </div>
                <div class="card flex flex-col justify-between">
                    <div>
                        <p class="metric-label">Oportunidad Clave</p>
                        <p class="metric-value text-blue-600">Activaci√≥n Cupones</p>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">Recuperar cuota frente a agresividad de competidores.</div>
                </div>
            </div>

            <!-- Section 1: Global Trend -->
            <div class="card">
                <div class="border-b border-gray-100 pb-4 mb-4">
                    <h2 class="text-lg font-bold flex items-center">
                        <span class="material-icons text-gray-400 mr-2">show_chart</span>
                        1. Tendencia Global del Parent
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Evoluci√≥n agregada de Clicks y Cuota de Mercado (NaturaleBio vs Competencia)</p>
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
                <div class="mt-4 bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                    <strong>Insight de Tendencia:</strong> El mercado sufre una contracci√≥n severa de volumen (-45%) t√≠pica de la "resaca" post-navide√±a (S52 -> S01). 
                    Aunque <strong>NaturaleBio</strong> pierde clicks en absoluto, su ca√≠da (-41%) es menor que la del mercado, lo que indica una 
                    <strong>resiliencia relativa</strong> y una ligera ganancia de "Share of Voice" en un mercado que se encoge.
                </div>
            </div>

            <!-- Section 2: Brand Competitiveness -->
            <div class="card">
                <div class="border-b border-gray-100 pb-4 mb-4">
                    <h2 class="text-lg font-bold flex items-center">
                        <span class="material-icons text-gray-400 mr-2">pie_chart</span>
                        2. Competitividad de Marca (Share of Click)
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">NaturaleBio vs Top 3 Competidores (Semana a Semana)</p>
                </div>
                <div id="chart_brand_comp" class="chart-container"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div class="text-sm text-gray-600">
                        <p class="mb-2"><strong>An√°lisis de Competencia:</strong></p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>NORITUAL LAB:</strong> L√≠der indiscutible con >11% de cuota. Su estrategia se basa en agresividad promocional (Cupones visibles).</li>
                            <li><strong>VAHDAM:</strong> Muestra estabilidad y ligero crecimiento (2.8% -> 3.1%), consolid√°ndose como la alternativa premium.</li>
                            <li><strong>NaturaleBio (Nosotros):</strong> Mantenemos posici√≥n en el Top 3, pero la distancia con el l√≠der sugiere necesidad de defensa activa.</li>
                        </ul>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-sm border border-gray-200">
                        <p class="font-bold mb-1">‚ö†Ô∏è Amenaza Detectada:</p>
                        <p>La consistencia de <strong>NORITUAL LAB</strong> en ambas semanas sugiere que no es un pico estacional, sino un posicionamiento estructural ganado mediante conversi√≥n (rankings org√°nicos altos + badges).</p>
                    </div>
                </div>
            </div>

            <!-- Section 3 & 4: Drivers & Efficiency -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Rank vs Share -->
                <div class="card">
                    <div class="border-b border-gray-100 pb-4 mb-4">
                        <h2 class="text-lg font-bold flex items-center">
                            <span class="material-icons text-gray-400 mr-2">scatter_plot</span>
                            4. Eficiencia: Organic Rank vs Click Share
                        </h2>
                    </div>
                    <div id="chart_efficiency" style="width: 100%; height: 350px;"></div>
                    <p class="text-xs text-gray-500 mt-2">Cada punto es un ASIN. Eje Y: % Cuota de Clicks, Eje X: Ranking Org√°nico (Invertido).</p>
                    <div class="mt-3 text-sm text-gray-700">
                        <strong>Interpretaci√≥n:</strong> Nuestros ASINs (Azul) tienen buen ranking org√°nico (Avg Rank ~5) pero su conversi√≥n a Click Share es inferior a los ASINs "Estrella" de la competencia (Rojos en la zona superior izquierda). Esto indica que, aunque somos visibles, el competidor gana el clic por <strong>precio, imagen o badge (cup√≥n)</strong>.
                    </div>
                </div>

                <!-- Drivers Table -->
                <div class="card">
                    <div class="border-b border-gray-100 pb-4 mb-4">
                        <h2 class="text-lg font-bold flex items-center">
                            <span class="material-icons text-gray-400 mr-2">tune</span>
                            3. üöÄ Palancas de Crecimiento
                        </h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-50 font-medium text-gray-500">
                                <tr>
                                    <th class="px-4 py-2">Palanca</th>
                                    <th class="px-4 py-2">Impacto Observado</th>
                                    <th class="px-4 py-2">Estado Competencia</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr>
                                    <td class="px-4 py-3 font-medium">üè∑Ô∏è Cupones</td>
                                    <td class="px-4 py-3 text-green-600">ALTO. Explica el liderazgo de NORITUAL LAB.</td>
                                    <td class="px-4 py-3">Activos (4-7 d√≠as/semana)</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium">üí∞ Precio</td>
                                    <td class="px-4 py-3 text-gray-600">Neutro. VAHDAM crece con precio estable.</td>
                                    <td class="px-4 py-3">Estable</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium">üèÜ Badges</td>
                                    <td class="px-4 py-3 text-yellow-600">Medio. Choice ayuda a mantener suelo de tr√°fico.</td>
                                    <td class="px-4 py-3">Mixto</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section 5: Conclusions -->
            <div class="card bg-gradient-to-r from-slate-800 to-slate-900 text-white border-none">
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="material-icons mr-3 text-yellow-400">lightbulb</span>
                        5. Conclusiones y Recomendaciones Accionables
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-bold text-lg mb-4 text-blue-200">Insights Clave</h3>
                            <ul class="space-y-3 text-gray-300 text-sm">
                                <li class="flex items-start">
                                    <span class="material-icons text-xs mr-2 mt-1">check_circle</span>
                                    <span>La ca√≠da de tr√°fico es <strong>estructural del mercado</strong> (-45%), no un fallo de producto.</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="material-icons text-xs mr-2 mt-1">check_circle</span>
                                    <span><strong>NORITUAL LAB</strong> est√° "comprando" cuota de mercado mediante cupones agresivos, desplaz√°ndonos a pesar de nuestro buen ranking org√°nico.</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="material-icons text-xs mr-2 mt-1">check_circle</span>
                                    <span>NaturaleBio tiene una <strong>eficiencia de ranking</strong> defendible, pero necesitamos mejorar el CTR (Click Through Rate) para capitalizar la posici√≥n.</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div>
                            <h3 class="font-bold text-lg mb-4 text-green-300">Plan de Acci√≥n (Next Steps)</h3>
                            <div class="space-y-4">
                                <div class="bg-white/10 p-3 rounded-lg flex items-start">
                                    <span class="material-icons text-green-400 mr-3">local_offer</span>
                                    <div>
                                        <p class="font-bold text-sm">Contratacar con Cupones</p>
                                        <p class="text-xs text-gray-300">Activar cup√≥n del 5-10% en el ASIN principal durante 7 d√≠as para neutralizar la ventaja visual de NORITUAL LAB.</p>
                                    </div>
                                </div>
                                <div class="bg-white/10 p-3 rounded-lg flex items-start">
                                    <span class="material-icons text-blue-400 mr-3">edit</span>
                                    <div>
                                        <p class="font-bold text-sm">Optimizaci√≥n de T√≠tulo/Imagen</p>
                                        <p class="text-xs text-gray-300">Revisar main image para destacar "Bio" o "Premium", ya que el ranking es bueno pero el click share no acompa√±a proporcionalmente.</p>
                                    </div>
                                </div>
                                <div class="bg-white/10 p-3 rounded-lg flex items-start">
                                    <span class="material-icons text-purple-400 mr-3">ads_click</span>
                                    <div>
                                        <p class="font-bold text-sm">Defensa de Ranking</p>
                                        <p class="text-xs text-gray-300">No bajar puja en PPC. En mercados a la baja, mantener la visibilidad es clave para rebotar primero cuando vuelva la demanda.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ======================= TAB 2: INTERACTIVE COMPARATOR ======================= -->
        <div id="view-interactive" class="hidden animate-fade-in space-y-6">
            <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-lg font-bold">Comparador "Cara a Cara"</h2>
                        <p class="text-sm text-gray-500">Analiza ASINs espec√≠ficos vs NaturaleBio</p>
                    </div>
                    <div class="flex gap-4">
                        <select id="weekSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <!-- Populated by JS -->
                        </select>
                        <select id="brandSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <option value="ALL">Todas las Marcas</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <!-- Dynamic Table Container -->
                <div id="table_interactive_div"></div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="font-bold mb-4">Distribuci√≥n de Precios (Semana Seleccionada)</h3>
                    <div id="chart_price_dist" class="h-64 w-full"></div>
                </div>
                <div class="card">
                    <h3 class="font-bold mb-4">Top 5 ASINs por Cuota (Semana Seleccionada)</h3>
                    <div id="chart_top_asins" class="h-64 w-full"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- DATA INJECTION -->
    <script type="text/javascript">
        // Data injected from Python analysis
        const marketData = [{"week":"2025-52","parent":"Matcha Premium","asin":"B0FSL3C3Z8","brand":"NORITUAL LAB","is_yaba":"N","title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","rank":6.0,"price":16.037142857,"share_pct":8.42,"clicks":4017.387448,"vol":47712.44,"deal_days":0.0,"coupon_days":0.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B07MD4LB49","brand":"VAHDAM","is_yaba":"N","title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","rank":7.0,"price":9.895714286,"share_pct":4.19,"clicks":1999.151236,"vol":47712.44,"deal_days":3.0,"coupon_days":0.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B06XQ69YCQ","brand":"NaturaleBio","is_yaba":"Y","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","rank":4.0,"price":10.538571429,"share_pct":3.75,"clicks":1789.2165,"vol":47712.44,"deal_days":0.0,"coupon_days":0.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B079VQ52MK","brand":"NaturaleBio","is_yaba":"Y","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","rank":5.0,"price":24.855714286,"share_pct":3.49,"clicks":1665.164156,"vol":47712.44,"deal_days":0.0,"coupon_days":0.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B0DRP6Y6XC","brand":"Special Leaves","is_yaba":"N","title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","rank":13.0,"price":10.71,"share_pct":3.4,"clicks":1622.22296,"vol":47712.44,"deal_days":0.0,"coupon_days":7.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B0CNRX8G5S","brand":"NORITUAL LAB","is_yaba":"N","title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","rank":2.0,"price":24.648571429,"share_pct":18.77,"clicks":8955.624988,"vol":47712.44,"deal_days":0.0,"coupon_days":0.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B07SZFD3P9","brand":"NaturaleBio","is_yaba":"Y","title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","rank":23.0,"price":30.704285714,"share_pct":2.93,"clicks":1397.974492,"vol":47712.44,"deal_days":1.0,"coupon_days":0.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B08XVX8V1T","brand":"bioKontor","is_yaba":"N","title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","rank":10.0,"price":12.367142857,"share_pct":2.44,"clicks":1164.183536,"vol":47712.44,"deal_days":0.0,"coupon_days":0.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B07K1WBH4K","brand":"VAHDAM","is_yaba":"N","title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","rank":20.0,"price":9.895714286,"share_pct":1.47,"clicks":701.372868,"vol":47712.44,"deal_days":3.0,"coupon_days":0.0},{"week":"2025-52","parent":"Matcha Premium","asin":"B06XQ5DCYJ","brand":"NaturaleBio","is_yaba":"Y","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","rank":2.0,"price":15.058571429,"share_pct":11.66,"clicks":5563.270504,"vol":47712.44,"deal_days":0.0,"coupon_days":0.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B07SZFD3P9","brand":"NaturaleBio","is_yaba":"Y","title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","rank":100.0,"price":30.27,"share_pct":2.68,"clicks":725.055776,"vol":27054.32,"deal_days":0.0,"coupon_days":0.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B06XQ5DCYJ","brand":"NaturaleBio","is_yaba":"Y","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","rank":2.0,"price":14.6075,"share_pct":12.9,"clicks":3490.00728,"vol":27054.32,"deal_days":0.0,"coupon_days":0.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B06XQ69YCQ","brand":"NaturaleBio","is_yaba":"Y","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","rank":5.0,"price":10.2225,"share_pct":3.35,"clicks":906.31972,"vol":27054.32,"deal_days":0.0,"coupon_days":0.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B079VQ52MK","brand":"NaturaleBio","is_yaba":"Y","title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","rank":5.0,"price":24.5275,"share_pct":3.66,"clicks":990.188112,"vol":27054.32,"deal_days":0.0,"coupon_days":0.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B0CNRX8G5S","brand":"NORITUAL LAB","is_yaba":"N","title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","rank":2.0,"price":23.91,"share_pct":19.34,"clicks":5232.305488,"vol":27054.32,"deal_days":0.0,"coupon_days":4.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B0DRP6Y6XC","brand":"Special Leaves","is_yaba":"N","title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","rank":16.0,"price":10.39,"share_pct":3.0,"clicks":811.6296,"vol":27054.32,"deal_days":0.0,"coupon_days":4.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B0F9B1LWQQ","brand":"UNREAL\u00ae","is_yaba":"N","title":"UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...","rank":19.0,"price":31.2725,"share_pct":1.57,"clicks":424.752824,"vol":27054.32,"deal_days":0.0,"coupon_days":0.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B0FSL3C3Z8","brand":"NORITUAL LAB","is_yaba":"N","title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","rank":6.0,"price":15.5575,"share_pct":7.38,"clicks":1996.608816,"vol":27054.32,"deal_days":0.0,"coupon_days":0.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B08XVX8V1T","brand":"bioKontor","is_yaba":"N","title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","rank":10.0,"price":11.9975,"share_pct":2.39,"clicks":646.598248,"vol":27054.32,"deal_days":0.0,"coupon_days":0.0},{"week":"2026-01","parent":"Matcha Premium","asin":"B07MD4LB49","brand":"VAHDAM","is_yaba":"N","title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","rank":9.0,"price":10.43,"share_pct":3.15,"clicks":852.21108,"vol":27054.32,"deal_days":0.0,"coupon_days":0.0}];
    </script>

    <!-- LOGIC -->
    <script type="text/javascript">
        // --- 1. Utility Functions ---
        const formatCurrency = (val) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(val);
        const formatNumber = (val) => new Intl.NumberFormat('es-ES').format(val);
        
        // --- 2. Chart Initialization ---
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            drawGlobalTrend();
            drawBrandComp();
            drawEfficiency();
            populateSelectors();
            updateInteractiveView();
        }

        // --- 3. Chart Drawing Functions ---

        // Chart 1: Global Trend (Combo: Clicks vs Our Share)
        function drawGlobalTrend() {
            // Aggregate by week
            const weeks = [...new Set(marketData.map(d => d.week))];
            const data = [];
            data.push(['Semana', 'Total Clicks Mercado', 'Nuestra Cuota (%)']);

            weeks.forEach(w => {
                const weekData = marketData.filter(d => d.week === w);
                const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
                const ourClicks = weekData.filter(d => d.is_yaba === 'Y').reduce((sum, d) => sum + d.clicks, 0);
                const share = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
                data.push([w, totalClicks, share]);
            });

            const dataTable = google.visualization.arrayToDataTable(data);
            const options = {
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1}},
                vAxes: {0: {title: 'Volumen Clicks'}, 1: {title: 'Cuota de Clicks (%)', format: '#\'%\''}},
                colors: ['#e5e7eb', '#2563eb'],
                legend: {position: 'top'},
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(dataTable, options);
        }

        // Chart 2: Brand Competitiveness (Line)
        function drawBrandComp() {
            // Identify Top 3 Brands excluding us
            const brands = [...new Set(marketData.filter(d => d.is_yaba === 'N').map(d => d.brand))];
            const brandVolumes = brands.map(b => ({
                brand: b,
                clicks: marketData.filter(d => d.brand === b).reduce((sum, d) => sum + d.clicks, 0)
            }));
            const top3 = brandVolumes.sort((a,b) => b.clicks - a.clicks).slice(0, 3).map(b => b.brand);
            
            // Build DataTable structure
            const weeks = [...new Set(marketData.map(d => d.week))];
            const header = ['Semana', 'NaturaleBio (Nosotros)', ...top3];
            const rows = [];

            weeks.forEach(w => {
                const weekData = marketData.filter(d => d.week === w);
                const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
                
                const getShare = (brandName) => {
                    const clicks = weekData.filter(d => d.brand === brandName).reduce((sum, d) => sum + d.clicks, 0);
                    return totalClicks > 0 ? (clicks / totalClicks) * 100 : 0;
                };

                const row = [w, getShare('NaturaleBio')];
                top3.forEach(b => row.push(getShare(b)));
                rows.push(row);
            });

            const dataTable = google.visualization.arrayToDataTable([header, ...rows]);
            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: {title: 'Cuota de Clicks (%)'},
                colors: ['#2563eb', '#dc2626', '#ea580c', '#65a30d'], // Blue for us, Reds/Warm for competitors
                chartArea: {width: '85%', height: '70%'},
                lineWidth: 3
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(dataTable, options);
        }

        // Chart 3: Efficiency (Scatter: Rank vs Share)
        function drawEfficiency() {
            // Use latest week only
            const latestWeek = marketData.map(d => d.week).sort().pop();
            const currentData = marketData.filter(d => d.week === latestWeek);

            const data = [['Rank Org√°nico', 'Cuota de Clicks (%)', {role: 'style'}, {role: 'tooltip'}]];
            
            currentData.forEach(d => {
                // Invert rank for visual (Rank 1 is "high" on X? No, usually Scatter places 0 at left. We want 1 at left.)
                // Let's use X axis standard, but mentally invert.
                // Color: Blue if Us, Red if Comp.
                const color = d.is_yaba === 'Y' ? '#2563eb' : '#ef4444';
                const label = `${d.brand} - ${d.asin}\nRank: ${d.rank}\nShare: ${d.share_pct}%`;
                data.push([d.rank, d.share_pct, `point {fill-color: ${color}; size: 10}`, label]);
            });

            const dataTable = google.visualization.arrayToDataTable(data);
            const options = {
                hAxis: {title: 'Rank Org√°nico (Menor es Mejor)', direction: 1}, // 1 -> 100
                vAxis: {title: 'Cuota de Clicks (%)'},
                legend: 'none',
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(dataTable, options);
        }

        // --- 4. Interactive Tab Logic ---

        function populateSelectors() {
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            const brands = [...new Set(marketData.map(d => d.brand))].sort();
            
            const wSelect = document.getElementById('weekSelector');
            const bSelect = document.getElementById('brandSelector');

            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = `Semana: ${w}`;
                wSelect.appendChild(opt);
            });
            // Select last week by default
            wSelect.value = weeks[weeks.length - 1];

            brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                bSelect.appendChild(opt);
            });

            wSelect.addEventListener('change', updateInteractiveView);
            bSelect.addEventListener('change', updateInteractiveView);
        }

        function updateInteractiveView() {
            const week = document.getElementById('weekSelector').value;
            const brand = document.getElementById('brandSelector').value;

            let filtered = marketData.filter(d => d.week === week);
            if (brand !== 'ALL') {
                filtered = filtered.filter(d => d.brand === brand);
            }

            // Draw Table
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'ASIN');
            data.addColumn('string', 'Marca');
            data.addColumn('string', 'T√≠tulo');
            data.addColumn('number', 'Precio');
            data.addColumn('number', 'Rank');
            data.addColumn('number', 'Share %');
            data.addColumn('number', 'Deal Days');

            filtered.forEach(d => {
                data.addRow([
                    d.asin, 
                    d.brand, 
                    d.title.substring(0, 30) + '...', 
                    d.price, 
                    d.rank, 
                    d.share_pct,
                    d.deal_days
                ]);
            });

            const table = new google.visualization.Table(document.getElementById('table_interactive_div'));
            table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});

            // Draw Distribution Charts
            drawInteractiveCharts(filtered);
        }

        function drawInteractiveCharts(data) {
            // Price Dist
            const priceData = [['ASIN', 'Precio']];
            data.forEach(d => priceData.push([d.asin, d.price]));
            const pChart = new google.visualization.ColumnChart(document.getElementById('chart_price_dist'));
            pChart.draw(google.visualization.arrayToDataTable(priceData), {
                title: 'Distribuci√≥n de Precios',
                legend: 'none',
                colors: ['#94a3b8']
            });

            // Top Share Pie
            const shareData = [['Brand', 'Share']];
            data.forEach(d => shareData.push([d.brand, d.share_pct]));
            const sChart = new google.visualization.PieChart(document.getElementById('chart_top_asins'));
            sChart.draw(google.visualization.arrayToDataTable(shareData), {
                title: 'Share en Selecci√≥n',
                pieHole: 0.4
            });
        }

        // --- 5. UI Logic ---
        function switchTab(tabId) {
            document.getElementById('view-report').classList.add('hidden');
            document.getElementById('view-interactive').classList.add('hidden');
            document.getElementById('tab-report').classList.remove('active', 'text-blue-600', 'border-blue-600');
            document.getElementById('tab-interactive').classList.remove('active', 'text-blue-600', 'border-blue-600');
            document.getElementById('tab-report').classList.add('text-gray-500');
            document.getElementById('tab-interactive').classList.add('text-gray-500');

            document.getElementById('view-' + tabId).classList.remove('hidden');
            const btn = document.getElementById('tab-' + tabId);
            btn.classList.add('active');
            btn.classList.remove('text-gray-500');
        }

        // Redraw on resize
        window.onresize = function() {
            initDashboard();
        };

    </script>
</body>
</html>