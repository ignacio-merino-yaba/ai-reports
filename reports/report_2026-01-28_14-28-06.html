<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado: Matcha Premium</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        /* CSS Vanilla con estilo "Apple-like" / Material Design */
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-500: #6B7280;
            --gray-800: #1F2937;
            --white: #FFFFFF;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        header {
            background: var(--white);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--gray-800); }
        h2 { margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: var(--gray-800); }
        .subtitle { font-size: 14px; color: var(--gray-500); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: 10px 20px;
            border-radius: 99px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards & Layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        /* KPI Metrics */
        .kpi-box {
            background: var(--gray-50);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        .kpi-label { font-size: 12px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 24px; font-weight: 700; color: var(--primary); margin: 4px 0; }
        .kpi-change { font-size: 12px; font-weight: 500; }
        .kpi-change.pos { color: var(--success); }
        .kpi-change.neg { color: var(--danger); }

        /* Insights List */
        .insight-list { list-style: none; padding: 0; margin: 0; }
        .insight-item {
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
            font-size: 14px;
        }
        .insight-item::before {
            content: "‚Ä¢";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
            font-size: 18px;
            line-height: 18px;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
            font-size: 14px;
            min-width: 200px;
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Recommendations */
        .rec-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 8px;
        }
        .rec-tag.price { background: #E8F0FE; color: var(--primary); }
        .rec-tag.promo { background: #FEF7E0; color: var(--warning); }
        .rec-tag.keyword { background: #CEEAD6; color: var(--success); }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-4 { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: flex-start; }
            .tabs { width: 100%; overflow-x: auto; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div>
                <h1>An√°lisis de Rendimiento: Matcha Premium</h1>
                <div class="subtitle">Periodo: Semana 52 (2025) - Semana 01 (2026) | Pa√≠s: UK</div>
            </div>
            <div style="text-align: right;">
                <span style="font-size: 12px; color: #6B7280;">Marca Principal</span>
                <div style="font-weight: 700; color: var(--primary);">NaturaleBio & Portfolio</div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">
                <span class="material-icons">dashboard</span> Reporte Ejecutivo
            </button>
            <button class="tab-btn" onclick="switchTab('interactive')">
                <span class="material-icons">compare_arrows</span> Comparador Interactivo
            </button>
        </div>

        <!-- PESTA√ëA 1: REPORTE EST√ÅTICO -->
        <div id="static" class="tab-content active">
            
            <!-- 1. TENDENCIA GLOBAL -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2>1. Tendencia Global del Parent</h2>
                    <div class="kpi-change neg">Volumen Mercado: -32% WoW</div>
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
                <div class="insight-list" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-100);">
                    <div class="insight-item"><strong>Ca√≠da Estacional:</strong> El volumen de b√∫squeda se contrajo dr√°sticamente (de 60k a 40k) tras la semana de Navidad (S52 -> S01), un patr√≥n t√≠pico post-festivo.</div>
                    <div class="insight-item"><strong>Resiliencia de Nuestra Marca:</strong> A pesar de la ca√≠da del mercado, nuestros ASINs (NaturaleBio) mantuvieron una cuota de clicks estable en el rango del 13-14% en sus productos estrella.</div>
                </div>
            </div>

            <!-- 2. COMPETITIVIDAD DE MARCA -->
            <div class="card">
                <h2>2. Competitividad de Marca (Share of Voice)</h2>
                <div class="grid-2">
                    <div id="chart_brand_share" class="chart-container"></div>
                    <div>
                        <h3>Din√°mica Competitiva</h3>
                        <ul class="insight-list">
                            <li class="insight-item"><strong>Dominio Compartido:</strong> NaturaleBio mantiene el liderazgo efectivo gracias a la suma de sus variantes, compitiendo cabeza a cabeza con <em>Perfect Ted</em>.</li>
                            <li class="insight-item"><strong>Movimiento Agresivo de Perfect Ted:</strong> Se observa volatilidad en su share. En la semana 01, aunque aumentaron precios en algunas referencias, su ASIN principal perdi√≥ share (9.2% -> 4.6%).</li>
                            <li class="insight-item"><strong>SuperSelf (Estabilidad):</strong> Mantiene un share constante (~4-5%) sin grandes fluctuaciones de precio, consolid√°ndose como el tercer jugador s√≥lido.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 3. PALANCAS Y EFICIENCIA -->
            <div class="grid-2">
                <div class="card">
                    <h2>3. Palancas de Crecimiento</h2>
                    <div class="kpi-box" style="margin-bottom: 12px; text-align: left; display: flex; justify-content: space-between;">
                        <span>üè∑Ô∏è Impacto Precio</span>
                        <strong>Alto</strong>
                    </div>
                    <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">ASINs con precio >¬£20 (como el nuestro B07...) tienen menor rotaci√≥n de click share (3-4%) comparado con el rango ¬£9-¬£12 que concentra el volumen masivo.</p>
                    
                    <div class="kpi-box" style="margin-bottom: 12px; text-align: left; display: flex; justify-content: space-between;">
                        <span>üèÜ Amazon Choice</span>
                        <strong>+20% Eficiencia</strong>
                    </div>
                    <p style="font-size: 13px; color: var(--gray-500);">Nuestros ASINs con badge (d√≠as > 0) convierten impresiones a clicks mejor que la media.</p>
                </div>

                <div class="card">
                    <h2>4. Eficiencia (Rank vs Share)</h2>
                    <div id="chart_efficiency" style="width: 100%; height: 250px;"></div>
                    <p style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">
                        <em>Eje X: Ranking Org√°nico (Menor es mejor) | Eje Y: Click Share</em><br>
                        Puntos Azules: Nuestros ASINs | Rojos: Competencia.
                        <br><strong>Insight:</strong> Nuestro ASIN Top (Rank #1-2) captura +13% share, mostrando m√°xima eficiencia.
                    </p>
                </div>
            </div>

            <!-- 5. CONCLUSIONES Y RECOMENDACIONES -->
            <div class="card" style="border-left: 4px solid var(--primary);">
                <h2>5. Conclusiones y Plan de Acci√≥n</h2>
                
                <h3 style="font-size: 16px; margin-top: 16px;">üí° Key Insights</h3>
                <ul class="insight-list">
                    <li class="insight-item">La demanda se ha contra√≠do un 32%, obligando a maximizar la conversi√≥n sobre el tr√°fico existente.</li>
                    <li class="insight-item">NaturaleBio lidera en eficiencia org√°nica (Rank #1-2), pero sufre presi√≥n de precio en el segmento medio (¬£12-¬£15).</li>
                    <li class="insight-item">Perfect Ted est√° testeando elasticidad de precio; es el momento de atacar su cuota si mantienen precios altos.</li>
                    <li class="insight-item">El segmento "Premium" (>¬£20) es estable pero de nicho; el volumen est√° en el segmento ¬£9-¬£12 donde SuperSelf es fuerte.</li>
                    <li class="insight-item">PureChimp (parte de nuestro portfolio) tiene un share bajo (2%) a pesar de buen precio, indicando falta de visibilidad/ranking.</li>
                </ul>

                <h3 style="font-size: 16px; margin-top: 16px;">üöÄ Recomendaciones Accionables</h3>
                <div style="margin-top: 12px;">
                    <div style="margin-bottom: 12px;">
                        <span class="rec-tag price">PRECIO</span>
                        <strong>Defensa del Segmento Medio:</strong> Evaluar un cup√≥n t√°ctico en el ASIN B06XQ5DCYJ para capturar a los clientes sensibles al precio que abandonan Perfect Ted.
                    </div>
                    <div style="margin-bottom: 12px;">
                        <span class="rec-tag keyword">VISIBILIDAD</span>
                        <strong>Reactivaci√≥n de PureChimp:</strong> Invertir en PPC agresivo para PureChimp en keywords long-tail para subir su Organic Rank del #10 al Top 5.
                    </div>
                    <div style="margin-bottom: 12px;">
                        <span class="rec-tag promo">CONVERSI√ìN</span>
                        <strong>Aprovechar "Best Seller":</strong> Asegurar inventario para mantener el badge de Best Seller en nuestro ASIN principal, ya que es el driver #1 de su eficiencia actual.
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTA√ëA 2: INTERACTIVO -->
        <div id="interactive" class="tab-content">
            <div class="card">
                <h2>Comparador Cara a Cara</h2>
                <div class="controls">
                    <div>
                        <label style="display:block; font-size:12px; color:gray; margin-bottom:4px;">Semana</label>
                        <select id="weekSelector" onchange="updateInteractive()"></select>
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; color:gray; margin-bottom:4px;">Competidor a Analizar</label>
                        <select id="compSelector" onchange="updateInteractive()">
                            <option value="ALL">Todos los Competidores</option>
                        </select>
                    </div>
                </div>
                
                <div id="table_interactive"></div>
            </div>
            
            <div class="grid-2">
                 <div class="card">
                    <h3>Distribuci√≥n de Precios (Semana Seleccionada)</h3>
                    <div id="chart_price_dist" class="chart-container" style="height: 250px;"></div>
                 </div>
                 <div class="card">
                    <h3>Top Ganadores de Share (Semana Seleccionada)</h3>
                    <div id="chart_winners" class="chart-container" style="height: 250px;"></div>
                 </div>
            </div>
        </div>

    </div>

    <!-- DATA & LOGIC -->
    <script type="text/javascript">
        // INJECTED DATA FROM PYTHON
        const marketData = [{"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "N", "asin": "B08YRXQ2JH", "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "click_share": 3.4, "average_organic_rank": 13.0, "price": 6.98, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 2054.0, "weekly_search_volume": 60416.88}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "N", "asin": "B08YRXQ2JH", "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "click_share": 3.32, "average_organic_rank": 13.0, "price": 6.98, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 1358.0, "weekly_search_volume": 40891.21}, {"week_date": "2025-52", "real_brand": "Heapwell Superfoods", "is_yaba_asin": "N", "asin": "B06XTYYYJ8", "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "click_share": 6.46, "average_organic_rank": 6.0, "price": 8.7, "weekly_number_of_days_with_deal": 6, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 3903.0, "weekly_search_volume": 60416.88}, {"week_date": "2026-01", "real_brand": "Heapwell Superfoods", "is_yaba_asin": "N", "asin": "B06XTYYYJ8", "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "click_share": 5.74, "average_organic_rank": 6.0, "price": 9.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 2347.0, "weekly_search_volume": 40891.21}, {"week_date": "2026-01", "real_brand": "Matcha Fuel", "is_yaba_asin": "N", "asin": "B0C71LZNV6", "product_title": "Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...", "click_share": 2.56, "average_organic_rank": 12.0, "price": 24.95, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 1047.0, "weekly_search_volume": 40891.21}, {"week_date": "2025-52", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "asin": "B09DQ1PWGX", "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "click_share": 9.27, "average_organic_rank": 8.0, "price": 9.49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 5601.0, "weekly_search_volume": 60416.88}, {"week_date": "2026-01", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "asin": "B09DQ1PWGX", "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "click_share": 4.64, "average_organic_rank": 34.0, "price": 2.12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 1897.0, "weekly_search_volume": 40891.21}, {"week_date": "2025-52", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "asin": "B0F21VZMJQ", "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "click_share": 8.65, "average_organic_rank": 3.0, "price": 16.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 5226.0, "weekly_search_volume": 60416.88}, {"week_date": "2026-01", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "asin": "B0F21VZMJQ", "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "click_share": 10.49, "average_organic_rank": 3.0, "price": 16.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 4289.0, "weekly_search_volume": 40891.21}, {"week_date": "2026-01", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "asin": "B0D9M91WZD", "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "click_share": 2.79, "average_organic_rank": 9.0, "price": 11.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 1141.0, "weekly_search_volume": 40891.21}, {"week_date": "2025-52", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "asin": "B0D9M91WZD", "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "click_share": 3.45, "average_organic_rank": 10.0, "price": 9.49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 2084.0, "weekly_search_volume": 60416.88}, {"week_date": "2026-01", "real_brand": "SuperSelf", "is_yaba_asin": "N", "asin": "B08YK2RPBZ", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "click_share": 9.83, "average_organic_rank": 4.0, "price": 9.9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 4, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 4020.0, "weekly_search_volume": 40891.21}, {"week_date": "2026-01", "real_brand": "SuperSelf", "is_yaba_asin": "N", "asin": "B082DKRSB4", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "click_share": 3.96, "average_organic_rank": 8.0, "price": 14.86, "weekly_number_of_days_with_deal": 4, "weekly_number_of_days_with_coupon": 4, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 1619.0, "weekly_search_volume": 40891.21}, {"week_date": "2025-52", "real_brand": "SuperSelf", "is_yaba_asin": "N", "asin": "B082DKRSB4", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "click_share": 2.95, "average_organic_rank": 8.0, "price": 19.18, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 1782.0, "weekly_search_volume": 60416.88}, {"week_date": "2025-52", "real_brand": "SuperSelf", "is_yaba_asin": "N", "asin": "B08YK2RPBZ", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "click_share": 7.98, "average_organic_rank": 5.0, "price": 9.9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 4821.0, "weekly_search_volume": 60416.88}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B079VQ52MK", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "click_share": 4.59, "average_organic_rank": 5.0, "price": 20.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 2773.0, "weekly_search_volume": 60416.88}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B079VQ52MK", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "click_share": 3.39, "average_organic_rank": 7.0, "price": 20.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 1386.0, "weekly_search_volume": 40891.21}, {"week_date": "2026-01", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "click_share": 13.79, "average_organic_rank": 1.0, "price": 12.49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "est_clicks": 5639.0, "weekly_search_volume": 40891.21}, {"week_date": "2025-52", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "click_share": 13.11, "average_organic_rank": 2.0, "price": 12.49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "est_clicks": 7921.0, "weekly_search_volume": 60416.88}, {"week_date": "2025-52", "real_brand": "PureChimp", "is_yaba_asin": "Y", "asin": "B00HNDSOCI", "product_title": "PureChimp Ceremonial Grade Matcha Powder 50g. 100%...", "click_share": 2.34, "average_organic_rank": 12.0, "price": 14.95, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "est_clicks": 1414.0, "weekly_search_volume": 60416.88}];

        // INITIALIZATION
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            drawTrendChart();
            drawBrandShareChart();
            drawEfficiencyChart();
            initInteractiveControls();
        }

        // --- CHART 1: GLOBAL TREND (Volume vs Share) ---
        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Volumen B√∫squedas');
            data.addColumn('number', 'Cuota Nuestros ASINs (%)');

            // Aggregate data by week
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            
            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const volume = weekData.length > 0 ? weekData[0].weekly_search_volume : 0;
                
                // Sum Click Share of My ASINs (is_yaba_asin = 'Y')
                const myShare = weekData
                    .filter(d => d.is_yaba_asin === 'Y')
                    .reduce((sum, d) => sum + d.click_share, 0);

                data.addRow([week, volume, myShare]);
            });

            const options = {
                title: 'Tendencia Mercado: Volumen vs Nuestra Cuota',
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
                vAxes: {
                    0: {title: 'Volumen B√∫squedas', textStyle: {color: '#6B7280'}},
                    1: {title: 'Click Share (%)', format: '#\'%\'', textStyle: {color: '#4285F4'}}
                },
                bar: {groupWidth: '30%'},
                colors: ['#E5E7EB'],
                legend: {position: 'bottom'},
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
        }

        // --- CHART 2: BRAND SHARE CURVES ---
        function drawBrandShareChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'NaturaleBio (Nosotros)');
            data.addColumn('number', 'Perfect Ted');
            data.addColumn('number', 'SuperSelf');
            data.addColumn('number', 'Resto Mercado');

            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();

            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                
                // Calculate Shares per Brand
                const getShare = (brand) => weekData
                    .filter(d => (d.real_brand === brand || (brand === 'NaturaleBio' && d.is_yaba_asin === 'Y')))
                    .reduce((sum, d) => sum + d.click_share, 0);
                
                const shareMy = getShare('NaturaleBio'); // Includes PureChimp due to Y logic
                const shareTed = getShare('Perfect Ted');
                const shareSuper = getShare('SuperSelf');
                const shareRest = 100 - (shareMy + shareTed + shareSuper);

                data.addRow([week, shareMy, shareTed, shareSuper, shareRest]);
            });

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#9CA3AF'],
                lineWidth: 3,
                vAxis: {title: 'Click Share (%)'},
                chartArea: {width: '85%', height: '70%'},
                pointSize: 5
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
            chart.draw(data, options);
        }

        // --- CHART 3: EFFICIENCY SCATTER ---
        function drawEfficiencyChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Rank Org√°nico');
            data.addColumn('number', 'Click Share (%)');
            data.addColumn({type: 'string', role: 'style'}); // Color
            data.addColumn({type: 'string', role: 'tooltip'});

            // Filter for latest week
            const lastWeek = [...new Set(marketData.map(d => d.week_date))].sort().pop();
            const currentData = marketData.filter(d => d.week_date === lastWeek);

            currentData.forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? 'point { fill-color: #4285F4; size: 6; }' : 'point { fill-color: #EA4335; size: 4; }';
                const label = `${d.real_brand} | Rank: ${d.average_organic_rank} | Share: ${d.click_share}%`;
                data.addRow([d.average_organic_rank, d.click_share, color, label]);
            });

            const options = {
                title: 'Semana Actual: Ranking vs Share',
                hAxis: {title: 'Organic Rank (Inv)', direction: -1}, // 1 is better
                vAxis: {title: 'Click Share (%)'},
                legend: 'none',
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- INTERACTIVE LOGIC ---
        function initInteractiveControls() {
            const weekSelect = document.getElementById('weekSelector');
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort().reverse();
            weeks.forEach(w => {
                let opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSelect.add(opt);
            });

            const compSelect = document.getElementById('compSelector');
            const competitors = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.real_brand))];
            competitors.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                compSelect.add(opt);
            });

            updateInteractive();
        }

        function updateInteractive() {
            const week = document.getElementById('weekSelector').value;
            const comp = document.getElementById('compSelector').value;
            
            // Filter Data
            let filtered = marketData.filter(d => d.week_date === week);
            if (comp !== 'ALL') {
                filtered = filtered.filter(d => d.is_yaba_asin === 'Y' || d.real_brand === comp);
            }

            // Draw Table
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Marca');
            data.addColumn('string', 'Producto (Corto)');
            data.addColumn('number', 'Precio (¬£)');
            data.addColumn('number', 'Share (%)');
            data.addColumn('number', 'Rank');
            
            filtered.sort((a,b) => b.click_share - a.click_share);

            filtered.forEach(d => {
                const title = d.product_title.substring(0, 30) + '...';
                data.addRow([d.real_brand, title, d.price, d.click_share, d.average_organic_rank]);
            });

            const table = new google.visualization.Table(document.getElementById('table_interactive'));
            table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});

            // Auxiliary Charts for Interactive Tab
            // 1. Price Distribution Bar
            const priceData = new google.visualization.DataTable();
            priceData.addColumn('string', 'ASIN');
            priceData.addColumn('number', 'Precio');
            filtered.slice(0, 5).forEach(d => priceData.addRow([d.real_brand.substring(0,5)+"..", d.price]));
            new google.visualization.ColumnChart(document.getElementById('chart_price_dist')).draw(priceData, {title: 'Top 5 x Share: Precio', legend: 'none'});

            // 2. Share Pie
            const shareData = new google.visualization.DataTable();
            shareData.addColumn('string', 'Marca');
            shareData.addColumn('number', 'Share');
            
            // Group by brand for the pie
            const brandShares = {};
            filtered.forEach(d => {
                brandShares[d.real_brand] = (brandShares[d.real_brand] || 0) + d.click_share;
            });
            Object.keys(brandShares).forEach(k => shareData.addRow([k, brandShares[k]]));
            
            new google.visualization.PieChart(document.getElementById('chart_winners')).draw(shareData, {title: 'Share Total (Selecci√≥n)', pieHole: 0.4});
        }

        // UTILS
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            // Redraw charts if needed to fix sizing
            if(tabId === 'interactive') updateInteractive();
        }
    </script>
</body>
</html>