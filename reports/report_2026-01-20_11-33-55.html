<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Azul Yaba/Google */
            --secondary: #5f6368; /* Gris Texto */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --radius: 16px;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #202124;
            -webkit-font-smoothing: antialiased;
        }

        header {
            background: var(--card-bg);
            padding: 20px 40px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand-logo {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs {
            display: flex;
            gap: 20px;
        }

        .tab-btn {
            border: none;
            background: none;
            padding: 10px 20px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            color: var(--secondary);
            border-radius: 20px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: #e8f0fe;
            color: var(--primary);
            font-weight: 600;
        }

        main {
            padding: 30px 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Grid Layouts */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }

        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        .col-3 { grid-column: span 3; }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #202124;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
            color: #202124;
        }

        .kpi-sub {
            font-size: 13px;
            color: var(--secondary);
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Charts Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }
        
        .small-chart {
            height: 250px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f1f3f4;
        }

        .insight-item:last-child { border-bottom: none; }

        .insight-icon {
            color: var(--primary);
            background: #e8f0fe;
            padding: 8px;
            border-radius: 50%;
            height: 24px;
            width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .insight-text h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .insight-text p {
            margin: 0;
            font-size: 13px;
            color: var(--secondary);
            line-height: 1.4;
        }

        /* Comparison Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            text-align: left;
            padding: 12px;
            color: var(--secondary);
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            background: #fff;
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            background: #fff;
            min-width: 200px;
        }

        /* Utility */
        .hidden { display: none !important; }
        
        /* Badges */
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-deal { background: #FCE8E6; color: #EA4335; }
        .badge-choice { background: #202124; color: #fff; }
        .badge-coupon { background: #E6F4EA; color: #34A853; }

    </style>
</head>
<body>

<header>
    <div class="brand-logo">
        <span class="material-icons">analytics</span>
        Market Intel Report
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Dinámico</button>
    </div>
</header>

<main id="static-report">
    <!-- Section 1: KPI & Global Trend -->
    <div class="dashboard-grid">
        <div class="col-12">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 10px;">1. Tendencia Global del Parent</h2>
        </div>
        
        <!-- KPI Cards -->
        <div class="col-3 card">
            <div class="card-header">
                <span class="card-title">Total Clicks (4w)</span>
                <span class="material-icons" style="color:var(--primary)">mouse</span>
            </div>
            <div class="kpi-value" id="kpi-clicks">-</div>
            <div class="kpi-sub" id="kpi-clicks-trend">vs prev. period</div>
        </div>

        <div class="col-3 card">
            <div class="card-header">
                <span class="card-title">Avg Click Share (Yaba)</span>
                <span class="material-icons" style="color:var(--primary)">pie_chart</span>
            </div>
            <div class="kpi-value" id="kpi-share">-</div>
            <div class="kpi-sub" id="kpi-share-trend">Cuota promedio</div>
        </div>

        <div class="col-6 card">
            <div class="card-header">
                <span class="card-title">Nuestra Marca vs Competencia (Volumen & Share)</span>
            </div>
            <div id="trend_chart" class="small-chart"></div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="col-12">
            <h2 style="font-size: 20px; font-weight: 600; margin-top: 20px;">2. Competitividad de Marca</h2>
        </div>

        <div class="col-8 card">
            <div class="card-header">
                <span class="card-title">Evolución de Click Share (Top 3 + Yaba)</span>
            </div>
            <div id="brand_chart" class="chart-container"></div>
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
                *La marca Yaba (Azul) se compara contra los 3 competidores con mayor cuota acumulada.
            </div>
        </div>

        <div class="col-4 card">
            <div class="card-header">
                <span class="card-title">Top Players (Última Semana)</span>
            </div>
            <div id="top_players_table"></div>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div class="col-12">
            <h2 style="font-size: 20px; font-weight: 600; margin-top: 20px;">3. Palancas & Eficiencia</h2>
        </div>

        <div class="col-6 card">
            <div class="card-header">
                <span class="card-title">Impacto de Deals & Cupones (Click Share)</span>
            </div>
            <div id="levers_chart" class="small-chart"></div>
        </div>

        <div class="col-6 card">
            <div class="card-header">
                <span class="card-title">Eficiencia: Organic Rank vs Click Share</span>
            </div>
            <div id="efficiency_chart" class="small-chart"></div>
            <div style="font-size: 12px; color: #666; text-align: center;">
                Eje X: Ranking (Invertido) | Eje Y: Click Share | Burbuja: Ours (Azul) vs Comp (Gris)
            </div>
        </div>

        <!-- Section 5: Insights -->
        <div class="col-12">
            <h2 style="font-size: 20px; font-weight: 600; margin-top: 20px;">5. Conclusiones y Recomendaciones</h2>
        </div>

        <div class="col-6 card">
            <div class="card-header">
                <span class="card-title"><span class="material-icons" style="color:var(--warning)">lightbulb</span> Insights Clave</span>
            </div>
            <ul class="insight-list" id="insights_container">
                <!-- Populated by JS -->
            </ul>
        </div>

        <div class="col-6 card">
            <div class="card-header">
                <span class="card-title"><span class="material-icons" style="color:var(--success)">check_circle</span> Recomendaciones Accionables</span>
            </div>
            <ul class="insight-list" id="recommendations_container">
                <!-- Populated by JS -->
            </ul>
        </div>
    </div>
</main>

<main id="interactive-comparator" class="hidden">
    <div class="controls">
        <div>
            <label style="display:block; font-size:12px; font-weight:600; color:var(--secondary); margin-bottom:4px;">Selecciona Semana</label>
            <select id="weekSelector" onchange="updateComparator()"></select>
        </div>
        <div>
            <label style="display:block; font-size:12px; font-weight:600; color:var(--secondary); margin-bottom:4px;">Comparar contra</label>
            <select id="competitorSelector" onchange="updateComparator()"></select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="col-12 card">
            <div class="card-header">
                <span class="card-title">Cara a Cara: Nosotros vs Competidor</span>
            </div>
            <div id="h2h_table_div"></div>
        </div>
        
        <div class="col-6 card">
            <div class="card-header">
                <span class="card-title">Comparativa de Precio</span>
            </div>
            <div id="price_comp_chart" class="small-chart"></div>
        </div>
        
        <div class="col-6 card">
            <div class="card-header">
                <span class="card-title">Comparativa de Click Share</span>
            </div>
            <div id="share_comp_chart" class="small-chart"></div>
        </div>
    </div>
</main>

<script type="text/javascript">
    // --- 1. DATA INJECTION (Generated by Python) ---
    const marketDataRaw = [{"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00YABA001", "is_yaba_asin": "Y", "competitor_brand": "YabaTech", "product_title": "YabaTech Premium Widget", "click_share": 18.23, "clicks": 1058, "price": 29.99, "average_organic_rank": 23, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5808, "keywords_link": "https://amazon.com/s?k=widget&brand=YabaTech", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00COMP001", "is_yaba_asin": "N", "competitor_brand": "CompePro", "product_title": "CompePro Standard Widget", "click_share": 22.84, "clicks": 1326, "price": 25.99, "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5808, "keywords_link": "https://amazon.com/s?k=widget&brand=CompePro", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00COMP002", "is_yaba_asin": "N", "competitor_brand": "BudgetKing", "product_title": "BudgetKing Cheap Widget", "click_share": 14.81, "clicks": 860, "price": 19.99, "average_organic_rank": 32, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5808, "keywords_link": "https://amazon.com/s?k=widget&brand=BudgetKing", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00COMP003", "is_yaba_asin": "N", "competitor_brand": "LuxeLife", "product_title": "LuxeLife Gold Widget", "click_share": 9.92, "clicks": 576, "price": 45.0, "average_organic_rank": 38, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5808, "keywords_link": "https://amazon.com/s?k=widget&brand=LuxeLife", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-01", "asin": "B00UNK001", "is_yaba_asin": "N", "competitor_brand": null, "product_title": "Generic Widget - Amazing Quality", "click_share": 4.14, "clicks": 240, "price": 15.0, "average_organic_rank": 49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5808, "keywords_link": "https://amazon.com/s?k=widget&brand=Unknown", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00YABA001", "is_yaba_asin": "Y", "competitor_brand": "YabaTech", "product_title": "YabaTech Premium Widget", "click_share": 17.15, "clicks": 997, "price": 29.99, "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5815, "keywords_link": "https://amazon.com/s?k=widget&brand=YabaTech", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00COMP001", "is_yaba_asin": "N", "competitor_brand": "CompePro", "product_title": "CompePro Standard Widget", "click_share": 21.36, "clicks": 1241, "price": 25.99, "average_organic_rank": 19, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5815, "keywords_link": "https://amazon.com/s?k=widget&brand=CompePro", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00COMP002", "is_yaba_asin": "N", "competitor_brand": "BudgetKing", "product_title": "BudgetKing Cheap Widget", "click_share": 14.88, "clicks": 865, "price": 19.99, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5815, "keywords_link": "https://amazon.com/s?k=widget&brand=BudgetKing", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00COMP003", "is_yaba_asin": "N", "competitor_brand": "LuxeLife", "product_title": "LuxeLife Gold Widget", "click_share": 9.93, "clicks": 577, "price": 45.0, "average_organic_rank": 40, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5815, "keywords_link": "https://amazon.com/s?k=widget&brand=LuxeLife", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-08", "asin": "B00UNK001", "is_yaba_asin": "N", "competitor_brand": null, "product_title": "Generic Widget - Amazing Quality", "click_share": 5.92, "clicks": 344, "price": 15.0, "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5815, "keywords_link": "https://amazon.com/s?k=widget&brand=Unknown", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00YABA001", "is_yaba_asin": "Y", "competitor_brand": "YabaTech", "product_title": "YabaTech Premium Widget", "click_share": 25.43, "clicks": 1391, "price": 23.99, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_search_volume": 5469, "keywords_link": "https://amazon.com/s?k=widget&brand=YabaTech", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00COMP001", "is_yaba_asin": "N", "competitor_brand": "CompePro", "product_title": "CompePro Standard Widget", "click_share": 22.25, "clicks": 1216, "price": 25.99, "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5469, "keywords_link": "https://amazon.com/s?k=widget&brand=CompePro", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00COMP002", "is_yaba_asin": "N", "competitor_brand": "BudgetKing", "product_title": "BudgetKing Cheap Widget", "click_share": 15.68, "clicks": 857, "price": 19.99, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5469, "keywords_link": "https://amazon.com/s?k=widget&brand=BudgetKing", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00COMP003", "is_yaba_asin": "N", "competitor_brand": "LuxeLife", "product_title": "LuxeLife Gold Widget", "click_share": 10.96, "clicks": 599, "price": 45.0, "average_organic_rank": 40, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5469, "keywords_link": "https://amazon.com/s?k=widget&brand=LuxeLife", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-15", "asin": "B00UNK001", "is_yaba_asin": "N", "competitor_brand": null, "product_title": "Generic Widget - Amazing Quality", "click_share": 5.17, "clicks": 282, "price": 15.0, "average_organic_rank": 52, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5469, "keywords_link": "https://amazon.com/s?k=widget&brand=Unknown", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00YABA001", "is_yaba_asin": "Y", "competitor_brand": "YabaTech", "product_title": "YabaTech Premium Widget", "click_share": 15.04, "clicks": 794, "price": 29.99, "average_organic_rank": 31, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5285, "keywords_link": "https://amazon.com/s?k=widget&brand=YabaTech", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00COMP001", "is_yaba_asin": "N", "competitor_brand": "CompePro", "product_title": "CompePro Standard Widget", "click_share": 30.64, "clicks": 1619, "price": 22.09, "average_organic_rank": 0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5285, "keywords_link": "https://amazon.com/s?k=widget&brand=CompePro", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00COMP002", "is_yaba_asin": "N", "competitor_brand": "BudgetKing", "product_title": "BudgetKing Cheap Widget", "click_share": 14.5, "clicks": 766, "price": 19.99, "average_organic_rank": 30, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5285, "keywords_link": "https://amazon.com/s?k=widget&brand=BudgetKing", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00COMP003", "is_yaba_asin": "N", "competitor_brand": "LuxeLife", "product_title": "LuxeLife Gold Widget", "click_share": 10.37, "clicks": 548, "price": 45.0, "average_organic_rank": 39, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5285, "keywords_link": "https://amazon.com/s?k=widget&brand=LuxeLife", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-22", "asin": "B00UNK001", "is_yaba_asin": "N", "competitor_brand": null, "product_title": "Generic Widget - Amazing Quality", "click_share": 5.75, "clicks": 303, "price": 15.0, "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5285, "keywords_link": "https://amazon.com/s?k=widget&brand=Unknown", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00YABA001", "is_yaba_asin": "Y", "competitor_brand": "YabaTech", "product_title": "YabaTech Premium Widget", "click_share": 18.06, "clicks": 978, "price": 29.99, "average_organic_rank": 22, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5419, "keywords_link": "https://amazon.com/s?k=widget&brand=YabaTech", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00COMP001", "is_yaba_asin": "N", "competitor_brand": "CompePro", "product_title": "CompePro Standard Widget", "click_share": 22.84, "clicks": 1237, "price": 25.99, "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5419, "keywords_link": "https://amazon.com/s?k=widget&brand=CompePro", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00COMP002", "is_yaba_asin": "N", "competitor_brand": "BudgetKing", "product_title": "BudgetKing Cheap Widget", "click_share": 14.86, "clicks": 805, "price": 19.99, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5419, "keywords_link": "https://amazon.com/s?k=widget&brand=BudgetKing", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00COMP003", "is_yaba_asin": "N", "competitor_brand": "LuxeLife", "product_title": "LuxeLife Gold Widget", "click_share": 10.38, "clicks": 562, "price": 45.0, "average_organic_rank": 39, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5419, "keywords_link": "https://amazon.com/s?k=widget&brand=LuxeLife", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}, {"parent_asin": "PARENT123", "week_date": "2023-10-29", "asin": "B00UNK001", "is_yaba_asin": "N", "competitor_brand": null, "product_title": "Generic Widget - Amazing Quality", "click_share": 5.92, "clicks": 320, "price": 15.0, "average_organic_rank": 48, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 5419, "keywords_link": "https://amazon.com/s?k=widget&brand=Unknown", "grams": 500, "organic_or_not": "Organic", "container": "Bag"}];

    // --- 2. DATA PROCESSING ---
    
    // Normalize and Enrich Data
    let processedData = marketDataRaw.map(row => {
        let brand = row.competitor_brand;
        if (!brand) {
            // Extraction logic (Mock)
            if (row.product_title && row.product_title.split(" ").length > 0) {
                brand = row.product_title.split(" ")[0]; // First word of title
            } else {
                brand = "Unknown Brand";
            }
        }
        
        return {
            ...row,
            brand_final: brand,
            week_num: row.week_date // Simplified
        };
    });

    // Identify OUR BRAND
    const ourAsins = processedData.filter(d => d.is_yaba_asin === 'Y');
    const ourBrand = ourAsins.length > 0 ? ourAsins[0].brand_final : "Our Brand";

    // Unique Weeks and Brands
    const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
    
    // Calculate Shares per Week per Brand
    const brandShares = {};
    const weekAggs = {};

    weeks.forEach(week => {
        const weekData = processedData.filter(d => d.week_date === week);
        
        // Total Volume
        const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
        const yabaClicks = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((sum, d) => sum + d.clicks, 0);
        const compClicks = totalClicks - yabaClicks;

        const yabaShare = weekData.filter(d => d.brand_final === ourBrand).reduce((sum, d) => sum + d.click_share, 0);
        
        weekAggs[week] = {
            totalClicks,
            yabaClicks,
            compClicks,
            yabaShare
        };

        // Brand aggregation
        const brandsInWeek = {};
        weekData.forEach(d => {
            if(!brandsInWeek[d.brand_final]) brandsInWeek[d.brand_final] = 0;
            brandsInWeek[d.brand_final] += d.click_share;
        });

        Object.keys(brandsInWeek).forEach(b => {
            if(!brandShares[b]) brandShares[b] = 0;
            brandShares[b] += brandsInWeek[b]; // Accumulate for ranking
        });
    });

    // Identify Top 3 Competitors
    const competitorBrands = Object.keys(brandShares).filter(b => b !== ourBrand);
    competitorBrands.sort((a, b) => brandShares[b] - brandShares[a]); // Descending
    const top3Competitors = competitorBrands.slice(0, 3);

    // --- 3. GOOGLE CHARTS SETUP ---
    google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        drawTrendChart();
        drawBrandChart();
        drawLeversChart();
        drawEfficiencyChart();
        populateInsights();
        setupInteractiveControls();
        updateKPIs();
    }

    // --- 4. DRAWING FUNCTIONS ---

    function updateKPIs() {
        const lastWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];
        const lastData = weekAggs[lastWeek];
        const prevData = weekAggs[prevWeek];

        const clicksDiff = ((lastData.totalClicks - prevData.totalClicks) / prevData.totalClicks) * 100;
        const shareDiff = lastData.yabaShare - prevData.yabaShare;

        document.getElementById('kpi-clicks').innerText = lastData.totalClicks.toLocaleString();
        document.getElementById('kpi-clicks-trend').innerHTML = 
            `<span class="${clicksDiff >= 0 ? 'trend-up' : 'trend-down'}">${clicksDiff > 0 ? '+' : ''}${clicksDiff.toFixed(1)}%</span> vs semana anterior`;
        
        document.getElementById('kpi-share').innerText = lastData.yabaShare.toFixed(1) + "%";
        document.getElementById('kpi-share-trend').innerHTML = 
            `<span class="${shareDiff >= 0 ? 'trend-up' : 'trend-down'}">${shareDiff > 0 ? '+' : ''}${shareDiff.toFixed(1)}pp</span> vs semana anterior`;
    }

    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Clicks Competencia');
        data.addColumn('number', 'Clicks Yaba');
        data.addColumn('number', 'Cuota Yaba (%)');

        weeks.forEach(week => {
            data.addRow([
                week.substring(5), // Remove year for space
                weekAggs[week].compClicks,
                weekAggs[week].yabaClicks,
                weekAggs[week].yabaShare
            ]);
        });

        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}},
            isStacked: true,
            colors: ['#dadce0', '#4285F4', '#1a73e8'],
            vAxes: {0: {title: 'Volumen de Clicks'}, 1: {title: 'Cuota %', format: '#\'%\''}},
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'},
            backgroundColor: 'transparent'
        };

        const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
        chart.draw(data, options);
    }

    function drawBrandChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', ourBrand);
        top3Competitors.forEach(c => data.addColumn('number', c));

        weeks.forEach(week => {
            const row = [week.substring(5)];
            
            // Get share for our brand
            const ourShare = processedData
                .filter(d => d.week_date === week && d.brand_final === ourBrand)
                .reduce((sum, d) => sum + d.click_share, 0);
            row.push(ourShare);

            // Get share for comps
            top3Competitors.forEach(comp => {
                const compShare = processedData
                    .filter(d => d.week_date === week && d.brand_final === comp)
                    .reduce((sum, d) => sum + d.click_share, 0);
                row.push(compShare);
            });
            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            legend: {position: 'bottom'},
            chartArea: {width: '90%', height: '75%'},
            vAxis: {title: 'Share %'},
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('brand_chart'));
        chart.draw(data, options);

        // Draw Table
        const tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'Marca');
        tableData.addColumn('number', 'Share (LW)');
        tableData.addColumn('string', 'Status');

        const lastWeek = weeks[weeks.length-1];
        
        // Add ours
        const ourLastShare = processedData
            .filter(d => d.week_date === lastWeek && d.brand_final === ourBrand)
            .reduce((s,d)=>s+d.click_share,0);
        tableData.addRow([ourBrand, ourLastShare, 'Nuestra Marca']);

        // Add comps
        top3Competitors.forEach(comp => {
            const s = processedData
                .filter(d => d.week_date === lastWeek && d.brand_final === comp)
                .reduce((sum, d) => sum + d.click_share, 0);
            tableData.addRow([comp, s, 'Competidor']);
        });

        const table = new google.visualization.Table(document.getElementById('top_players_table'));
        table.draw(tableData, {width: '100%', height: '100%'});
    }

    function drawLeversChart() {
        // Aggregate data: Avg Share when Deal=0 vs Deal>0
        let noDealShare = [];
        let dealShare = [];

        processedData.forEach(d => {
            if(d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0) {
                dealShare.push(d.click_share);
            } else {
                noDealShare.push(d.click_share);
            }
        });

        const avgNoDeal = noDealShare.length ? noDealShare.reduce((a,b)=>a+b,0)/noDealShare.length : 0;
        const avgDeal = dealShare.length ? dealShare.reduce((a,b)=>a+b,0)/dealShare.length : 0;

        const data = google.visualization.arrayToDataTable([
            ['Estado', 'Share Promedio', { role: 'style' }],
            ['Sin Promo', avgNoDeal, 'color: #dadce0'],
            ['Con Promo', avgDeal, 'color: #34A853']
        ]);

        const options = {
            legend: { position: "none" },
            vAxis: {title: 'Avg Share %'},
            chartArea: {width: '80%', height: '70%'}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('levers_chart'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Orgánico');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        const lastWeek = weeks[weeks.length-1];
        const weekData = processedData.filter(d => d.week_date === lastWeek);

        weekData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#9aa0a6';
            data.addRow([
                d.average_organic_rank, 
                d.click_share, 
                `point { fill-color: ${color}; size: 6; }`,
                `${d.brand_final}: Rank ${d.average_organic_rank}, Share ${d.click_share}%`
            ]);
        });

        const options = {
            hAxis: {title: 'Rank Orgánico (Menor es mejor)', direction: -1},
            vAxis: {title: 'Click Share %'},
            legend: 'none',
            chartArea: {width: '85%', height: '75%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
        chart.draw(data, options);
    }

    function populateInsights() {
        const container = document.getElementById('insights_container');
        const recContainer = document.getElementById('recommendations_container');
        
        // Causal Analysis Logic
        const lastWeek = weeks[weeks.length-1];
        const prevWeek = weeks[weeks.length-2];
        const ourDataLast = processedData.find(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y');
        const ourDataPrev = processedData.find(d => d.week_date === prevWeek && d.is_yaba_asin === 'Y');
        
        // Find biggest competitor threat
        const threats = processedData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'N')
                                     .sort((a,b) => b.click_share - a.click_share);
        const topThreat = threats[0];

        let insights = [];
        let recs = [];

        // Insight 1: Trend
        if (ourDataLast.click_share > ourDataPrev.click_share) {
            insights.push({icon: 'trending_up', title: 'Crecimiento de Cuota', text: `Nuestra marca creció a ${ourDataLast.click_share}% esta semana.`});
        } else {
            insights.push({icon: 'trending_down', title: 'Pérdida de Cuota', text: `Nuestra cuota cayó de ${ourDataPrev.click_share}% a ${ourDataLast.click_share}%.`});
        }

        // Insight 2: Pricing
        if (topThreat.price < ourDataLast.price) {
            insights.push({icon: 'sell', title: 'Desventaja de Precio', text: `${topThreat.brand_final} está posicionado ${((ourDataLast.price - topThreat.price)/ourDataLast.price*100).toFixed(0)}% más barato.`});
            recs.push('Considerar cupón del 10% para combatir precio del líder.');
        }

        // Insight 3: Deals
        if (ourDataLast.weekly_number_of_days_with_deal > 0) {
            insights.push({icon: 'local_offer', title: 'Impacto de Promoción', text: 'El Deal activo contribuyó al mantenimiento de la cuota.'});
        }

        // Insight 4: Rank
        if (ourDataLast.average_organic_rank > 10) {
            insights.push({icon: 'visibility_off', title: 'Visibilidad Orgánica Baja', text: `Rank actual promedio: ${ourDataLast.average_organic_rank}. Fuera del Top 10.`});
            recs.push('Invertir en PPC defensivo para recuperar Top of Search.');
        }

        // Insight 5: Efficiency
        if (ourDataLast.click_share < 5 && ourDataLast.average_organic_rank < 10) {
            insights.push({icon: 'warning', title: 'Baja Conversión Visual', text: 'Buen rank pero pocos clicks. Revisar imagen principal.'});
            recs.push('A/B Testing de Main Image.');
        } else {
             insights.push({icon: 'check', title: 'Estabilidad de Mercado', text: 'El mercado muestra baja volatilidad en el Top 3.'});
             recs.push('Monitorizar stock de competidores Top 3.');
        }

        // Render
        container.innerHTML = insights.map(i => `
            <li class="insight-item">
                <div class="insight-icon"><span class="material-icons">${i.icon}</span></div>
                <div class="insight-text"><h4>${i.title}</h4><p>${i.text}</p></div>
            </li>
        `).join('');

        recContainer.innerHTML = recs.map(r => `
            <li class="insight-item">
                <div class="insight-icon" style="background:#E6F4EA; color:#34A853"><span class="material-icons">add_task</span></div>
                <div class="insight-text"><h4>Acción Recomendada</h4><p>${r}</p></div>
            </li>
        `).join('');
    }

    // --- 5. INTERACTIVE LOGIC ---

    function setupInteractiveControls() {
        const weekSel = document.getElementById('weekSelector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        weekSel.value = weeks[weeks.length-1]; // Select last

        const compSel = document.getElementById('competitorSelector');
        top3Competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });
        
        updateComparator();
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if(tab === 'static') {
            document.getElementById('static-report').classList.remove('hidden');
            document.getElementById('interactive-comparator').classList.add('hidden');
        } else {
            document.getElementById('static-report').classList.add('hidden');
            document.getElementById('interactive-comparator').classList.remove('hidden');
            updateComparator(); // Redraw
        }
    }

    function updateComparator() {
        const selectedWeek = document.getElementById('weekSelector').value;
        const selectedComp = document.getElementById('competitorSelector').value;

        // Get Data
        const myData = processedData.find(d => d.week_date === selectedWeek && d.brand_final === ourBrand);
        const compData = processedData.find(d => d.week_date === selectedWeek && d.brand_final === selectedComp);

        if(!myData || !compData) return;

        // Draw Table
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Métrica');
        data.addColumn('string', 'Nosotros');
        data.addColumn('string', 'Competidor');
        
        data.addRows([
            ['Precio', `$${myData.price}`, `$${compData.price}`],
            ['Click Share', `${myData.click_share}%`, `${compData.click_share}%`],
            ['Organic Rank', `#${myData.average_organic_rank}`, `#${compData.average_organic_rank}`],
            ['Deal Activo', myData.weekly_number_of_days_with_deal > 0 ? 'Sí' : 'No', compData.weekly_number_of_days_with_deal > 0 ? 'Sí' : 'No']
        ]);

        const table = new google.visualization.Table(document.getElementById('h2h_table_div'));
        table.draw(data, {width: '100%', allowHtml: true});

        // Draw Charts
        drawCompChart('price_comp_chart', 'Precio', myData.price, compData.price);
        drawCompChart('share_comp_chart', 'Share %', myData.click_share, compData.click_share);
    }

    function drawCompChart(elementId, label, val1, val2) {
        const data = google.visualization.arrayToDataTable([
            ['Brand', label, { role: 'style' }],
            ['Nosotros', val1, '#4285F4'],
            ['Competencia', val2, '#EA4335']
        ]);

        const options = {
            legend: { position: "none" },
            vAxis: { minValue: 0 },
            chartArea: {width: '80%', height: '70%'}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById(elementId));
        chart.draw(data, options);
    }

</script>

</body>
</html>