<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado: NaturaleBio</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Charts (CDN) -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f5f5f7; color: #1d1d1f; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); transition: transform 0.2s ease; }
        .card:hover { transform: translateY(-2px); }
        .chart-container { width: 100%; min-height: 350px; }
        .nav-pill { cursor: pointer; transition: all 0.3s ease; }
        .nav-pill.active { background-color: #0071e3; color: white; box-shadow: 0 2px 10px rgba(0,113,227,0.3); }
        .metric-value { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Interactive Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
    </style>
</head>
<body class="pb-12">

    <!-- DATA INJECTION -->
    <script>
        const MY_BRAND = "NaturaleBio";
        
        // Raw Data injected from Python processing
        const marketData = [
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "is_yaba_asin": "Y", "click_share": 2.68, "clicks": 725.06, "average_organic_rank": 0.0, "price": 30.27, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NaturaleBio"},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "is_yaba_asin": "N", "click_share": 19.34, "clicks": 5232.31, "average_organic_rank": 2.0, "price": 23.91, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NORITUAL LAB"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "is_yaba_asin": "N", "click_share": 18.77, "clicks": 8955.62, "average_organic_rank": 2.0, "price": 24.65, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NORITUAL LAB"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba_asin": "Y", "click_share": 11.66, "clicks": 5563.27, "average_organic_rank": 2.0, "price": 15.06, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NaturaleBio"},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba_asin": "Y", "click_share": 12.9, "clicks": 3490.01, "average_organic_rank": 2.0, "price": 14.61, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NaturaleBio"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba_asin": "Y", "click_share": 3.75, "clicks": 1789.22, "average_organic_rank": 4.0, "price": 10.54, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NaturaleBio"},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba_asin": "Y", "click_share": 3.35, "clicks": 906.32, "average_organic_rank": 5.0, "price": 10.22, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NaturaleBio"},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba_asin": "Y", "click_share": 3.66, "clicks": 990.19, "average_organic_rank": 5.0, "price": 24.53, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NaturaleBio"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "is_yaba_asin": "Y", "click_share": 3.49, "clicks": 1665.16, "average_organic_rank": 5.0, "price": 24.86, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NaturaleBio"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "Unknown Brand", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba_asin": "N", "click_share": 8.42, "clicks": 4017.39, "average_organic_rank": 6.0, "price": 16.04, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": ""},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "is_yaba_asin": "N", "click_share": 7.38, "clicks": 1996.61, "average_organic_rank": 6.0, "price": 15.56, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NORITUAL LAB"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "is_yaba_asin": "N", "click_share": 4.19, "clicks": 1999.15, "average_organic_rank": 7.0, "price": 9.90, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "VAHDAM"},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "is_yaba_asin": "N", "click_share": 3.15, "clicks": 852.21, "average_organic_rank": 9.0, "price": 10.43, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "VAHDAM"},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "is_yaba_asin": "N", "click_share": 2.39, "clicks": 646.60, "average_organic_rank": 10.0, "price": 12.00, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "bioKontor"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "is_yaba_asin": "N", "click_share": 2.44, "clicks": 1164.18, "average_organic_rank": 10.0, "price": 12.37, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "bioKontor"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "is_yaba_asin": "N", "click_share": 3.4, "clicks": 1622.22, "average_organic_rank": 13.0, "price": 10.71, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "Special Leaves"},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "is_yaba_asin": "N", "click_share": 3.0, "clicks": 811.63, "average_organic_rank": 16.0, "price": 10.39, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "Special Leaves"},
            {"parent_asin": "Matcha Premium", "week_date": "2026-01", "keywords": "matcha", "real_brand": "Unknown Brand", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "is_yaba_asin": "N", "click_share": 1.57, "clicks": 424.75, "average_organic_rank": 19.0, "price": 31.27, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": ""},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "VAHDAM", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "is_yaba_asin": "N", "click_share": 1.47, "clicks": 701.37, "average_organic_rank": 20.0, "price": 9.90, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "VAHDAM"},
            {"parent_asin": "Matcha Premium", "week_date": "2025-52", "keywords": "matcha", "real_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "is_yaba_asin": "Y", "click_share": 2.93, "clicks": 1397.97, "average_organic_rank": 23.0, "price": 30.70, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "grams": "", "organic_or_not": "", "container": "", "competitor_brand": "NaturaleBio"}
        ];

        // --- Data Processing Logic ---

        function getUniqueWeeks() {
            return [...new Set(marketData.map(d => d.week_date))].sort();
        }

        function getUniqueCompetitors() {
            return [...new Set(marketData.filter(d => d.real_brand !== MY_BRAND && d.real_brand !== "Unknown Brand").map(d => d.real_brand))].sort();
        }

        function getAggregatedByBrandAndWeek() {
            const agg = {}; // { week: { brand: { clicks, share_sum, count, price_sum, asin_count } } }
            
            marketData.forEach(row => {
                if (!agg[row.week_date]) agg[row.week_date] = {};
                const brand = row.real_brand || "Unknown";
                if (!agg[row.week_date][brand]) {
                    agg[row.week_date][brand] = { clicks: 0, share: 0, price_sum: 0, count: 0, deals: 0, coupons: 0 };
                }
                agg[row.week_date][brand].clicks += row.clicks;
                agg[row.week_date][brand].share += row.click_share;
                agg[row.week_date][brand].price_sum += row.price;
                agg[row.week_date][brand].deals += row.weekly_number_of_days_with_deal;
                agg[row.week_date][brand].coupons += row.weekly_number_of_days_with_coupon;
                agg[row.week_date][brand].count += 1;
            });
            return agg;
        }

        function getTopCompetitors() {
            const agg = getAggregatedByBrandAndWeek();
            const brandScores = {};
            
            Object.values(agg).forEach(weekData => {
                Object.entries(weekData).forEach(([brand, data]) => {
                    if (brand === MY_BRAND || brand === "Unknown" || brand === "Unknown Brand") return;
                    if (!brandScores[brand]) brandScores[brand] = 0;
                    brandScores[brand] += data.share;
                });
            });

            return Object.entries(brandScores)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(e => e[0]);
        }

    </script>

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <span class="material-icons">analytics</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 tracking-tight">An√°lisis de Parent ASIN</h1>
                    <p class="text-xs text-gray-500 font-medium mt-0.5">Parent: Matcha Premium | Brand: <span class="text-blue-600 font-bold">NaturaleBio</span></p>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="flex bg-gray-100 rounded-lg p-1">
                <div id="nav-static" class="nav-pill active px-4 py-2 rounded-md text-sm font-medium" onclick="switchTab('static')">Reporte Estrat√©gico</div>
                <div id="nav-interactive" class="nav-pill px-4 py-2 rounded-md text-sm font-medium" onclick="switchTab('interactive')">Comparador Interactivo</div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- TAB 1: STATIC REPORT -->
        <div id="tab-static-content" class="space-y-8">
            
            <!-- SECTION 1: GLOBAL TREND -->
            <div class="card p-6">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <span class="material-icons text-blue-600">trending_up</span>
                            1. Tendencia Global del Parent
                        </h2>
                        <p class="text-sm text-gray-500">Volumen de Clicks y Share Total (Nosotros vs Competencia)</p>
                    </div>
                    <div id="trend-summary" class="text-right">
                        <!-- JS injected summary -->
                    </div>
                </div>
                <div id="chart_global_trend" class="chart-container"></div>
            </div>

            <!-- SECTION 2: COMPETITIVENESS -->
            <div class="card p-6">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2 mb-4">
                    <span class="material-icons text-purple-600">pie_chart</span>
                    2. Competitividad de Marca (Click Share)
                </h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div id="chart_brand_comp" class="chart-container"></div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <h3 class="font-semibold text-gray-800 mb-3 text-sm">Din√°mica de Mercado (√öltima Semana)</h3>
                        <div id="market-dynamics-list" class="space-y-3 text-sm"></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 3 & 4: DRIVERS & EFFICIENCY -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Drivers -->
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2 mb-4">
                        <span class="material-icons text-green-600">monetization_on</span>
                        3. Palancas de Crecimiento
                    </h2>
                    <div id="drivers-analysis" class="space-y-4">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Efficiency -->
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2 mb-4">
                        <span class="material-icons text-orange-600">ads_click</span>
                        4. Eficiencia (Rank vs Share)
                    </h2>
                    <p class="text-xs text-gray-500 mb-2">Eje X: Ranking Org√°nico (Menor es mejor) | Eje Y: Click Share</p>
                    <div id="chart_efficiency" style="height: 300px; width: 100%;"></div>
                </div>
            </div>

            <!-- SECTION 5: INSIGHTS -->
            <div class="card p-6 bg-gradient-to-r from-blue-50 to-white border-blue-100">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2 mb-6">
                    <span class="material-icons text-blue-700">lightbulb</span>
                    5. Conclusiones y Recomendaciones
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-bold text-blue-800 text-sm uppercase tracking-wide mb-3">Insights Clave</h3>
                        <ul id="insights-list" class="space-y-2 text-sm text-gray-700 list-disc list-outside pl-4">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-green-800 text-sm uppercase tracking-wide mb-3">Recomendaciones Accionables</h3>
                        <ul id="recommendations-list" class="space-y-2 text-sm text-gray-700 list-disc list-outside pl-4">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
            </div>

        </div>

        <!-- TAB 2: INTERACTIVE COMPARE -->
        <div id="tab-interactive-content" class="hidden space-y-6">
            <div class="card p-6 sticky top-24 z-40 bg-white/95 backdrop-blur">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Semana de An√°lisis</label>
                        <select id="select-week" class="w-full bg-gray-50 border border-gray-200 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateInteractive()">
                            <!-- Options JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Competidor a Comparar</label>
                        <select id="select-competitor" class="w-full bg-gray-50 border border-gray-200 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateInteractive()">
                            <!-- Options JS -->
                        </select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Head to Head Cards -->
                <div class="card p-6 text-center border-t-4 border-blue-500">
                    <h3 class="text-gray-500 text-sm font-bold uppercase mb-2">Nuestra Marca</h3>
                    <div class="text-3xl font-bold text-gray-900 mb-1" id="h2h-my-share">-</div>
                    <div class="text-xs text-gray-500 mb-4">Click Share</div>
                    <div class="text-xl font-semibold text-gray-700" id="h2h-my-price">-</div>
                    <div class="text-xs text-gray-500">Precio Promedio</div>
                </div>

                <div class="flex items-center justify-center">
                    <div class="bg-gray-100 rounded-full p-4">
                        <span class="material-icons text-gray-400 text-3xl">compare_arrows</span>
                    </div>
                </div>

                <div class="card p-6 text-center border-t-4 border-red-400">
                    <h3 class="text-gray-500 text-sm font-bold uppercase mb-2" id="h2h-comp-name">Competidor</h3>
                    <div class="text-3xl font-bold text-gray-900 mb-1" id="h2h-comp-share">-</div>
                    <div class="text-xs text-gray-500 mb-4">Click Share</div>
                    <div class="text-xl font-semibold text-gray-700" id="h2h-comp-price">-</div>
                    <div class="text-xs text-gray-500">Precio Promedio</div>
                </div>
            </div>

            <div class="card p-6">
                 <h3 class="font-bold text-gray-800 mb-4">Detalle de Variantes (Top 5 por Share)</h3>
                 <div id="variants-table" class="overflow-x-auto"></div>
            </div>
        </div>
    </main>

    <!-- LOGIC SCRIPT -->
    <script>
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        let topCompetitors = [];

        function initDashboard() {
            topCompetitors = getTopCompetitors();
            
            // Draw all static charts
            drawGlobalTrend();
            drawBrandCompetitiveness();
            drawEfficiencyChart();
            generateInsights();
            populateInteractiveControls();
        }

        function switchTab(tab) {
            document.getElementById('nav-static').classList.toggle('active', tab === 'static');
            document.getElementById('nav-interactive').classList.toggle('active', tab === 'interactive');
            document.getElementById('tab-static-content').style.display = tab === 'static' ? 'block' : 'none';
            document.getElementById('tab-interactive-content').style.display = tab === 'interactive' ? 'block' : 'none';
            if(tab === 'interactive') updateInteractive();
        }

        // --- 1. Global Trend Chart ---
        function drawGlobalTrend() {
            const weeks = getUniqueWeeks();
            const dataTable = [['Semana', 'Clicks Nuestros', 'Clicks Competencia', 'Share Total (%)']];
            
            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const myClicks = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((sum, d) => sum + d.clicks, 0);
                const compClicks = weekData.filter(d => d.is_yaba_asin === 'N').reduce((sum, d) => sum + d.clicks, 0);
                const totalClicks = myClicks + compClicks;
                const myShare = totalClicks > 0 ? (myClicks / totalClicks) * 100 : 0; // Calculated share from volume
                
                // Or use average share from dataset
                const avgShare = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((sum, d) => sum + d.click_share, 0); // This is sum of shares across keywords? No, share is per keyword. 
                // Simplified: Sum of Clicks is best proxy for volume.
                
                dataTable.push([week, myClicks, compClicks, myShare]);
            });

            const data = google.visualization.arrayToDataTable(dataTable);

            const options = {
                vAxes: { 0: {title: 'Volumen de Clicks'}, 1: {title: 'Share (%)', format: '#\'%\''} },
                seriesType: 'bars',
                series: { 2: {type: 'line', targetAxisIndex: 1, color: '#2563EB', pointSize: 5} },
                colors: ['#3B82F6', '#E5E7EB'], // Blue for us, Gray for them
                legend: { position: 'bottom' },
                bar: { groupWidth: '50%' },
                chartArea: { width: '85%', height: '70%' },
                animation: { startup: true, duration: 1000, easing: 'out' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
            chart.draw(data, options);
        }

        // --- 2. Brand Competitiveness ---
        function drawBrandCompetitiveness() {
            const weeks = getUniqueWeeks();
            const header = ['Semana', MY_BRAND, ...topCompetitors, 'Resto del Mercado'];
            const dataTable = [header];
            
            weeks.forEach(week => {
                const agg = getAggregatedByBrandAndWeek()[week];
                const row = [week];
                
                // My Brand
                row.push(agg[MY_BRAND] ? agg[MY_BRAND].share : 0);
                
                // Top Competitors
                let topCompShare = 0;
                topCompetitors.forEach(comp => {
                    const s = agg[comp] ? agg[comp].share : 0;
                    row.push(s);
                    topCompShare += s;
                });
                
                // Rest
                let totalShare = Object.values(agg).reduce((s, b) => s + b.share, 0);
                let myShare = agg[MY_BRAND] ? agg[MY_BRAND].share : 0;
                row.push(totalShare - myShare - topCompShare); // Residual
                
                dataTable.push(row);
            });

            const data = google.visualization.arrayToDataTable(dataTable);
            
            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' },
                pointSize: 5,
                lineWidth: 3,
                colors: ['#2563EB', '#DC2626', '#EA580C', '#D97706', '#9CA3AF'], // Blue (Me), Reds/Oranges (Comps), Gray (Rest)
                vAxis: { title: 'Click Share Total' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
            chart.draw(data, options);

            // Populate side text
            const lastWeek = weeks[weeks.length - 1];
            const lastData = getAggregatedByBrandAndWeek()[lastWeek];
            const list = document.getElementById('market-dynamics-list');
            let html = '';
            
            [MY_BRAND, ...topCompetitors].forEach(brand => {
                const share = lastData[brand] ? lastData[brand].share.toFixed(1) : 0;
                const prevWeek = weeks[weeks.length - 2];
                const prevShare = (getAggregatedByBrandAndWeek()[prevWeek] && getAggregatedByBrandAndWeek()[prevWeek][brand]) ? getAggregatedByBrandAndWeek()[prevWeek][brand].share : 0;
                const diff = (share - prevShare).toFixed(1);
                const icon = diff > 0 ? 'trending_up' : (diff < 0 ? 'trending_down' : 'remove');
                const color = diff > 0 ? 'text-green-600' : (diff < 0 ? 'text-red-600' : 'text-gray-400');
                
                html += `<div class="flex justify-between items-center pb-2 border-b border-gray-100 last:border-0">
                            <span class="font-medium ${brand === MY_BRAND ? 'text-blue-700' : 'text-gray-600'}">${brand}</span>
                            <div class="text-right">
                                <div class="font-bold text-gray-900">${share}%</div>
                                <div class="text-xs ${color} flex items-center justify-end gap-1">
                                    <span class="material-icons text-[10px]">${icon}</span> ${diff > 0 ? '+' : ''}${diff}%
                                </div>
                            </div>
                         </div>`;
            });
            list.innerHTML = html;
        }

        // --- 4. Efficiency Chart ---
        function drawEfficiencyChart() {
            const lastWeek = getUniqueWeeks().pop();
            const currentData = marketData.filter(d => d.week_date === lastWeek);
            
            // [Rank, Share, Color, Tooltip]
            const dataTable = [['Organic Rank', 'Click Share', { role: 'style' }, { role: 'tooltip' }]];
            
            currentData.forEach(d => {
                if(d.click_share > 0) { // Filter noise
                    const color = d.is_yaba_asin === 'Y' ? '#2563EB' : '#9CA3AF'; // Blue vs Gray
                    const tooltip = `${d.real_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%\nPrice: ${d.price}`;
                    dataTable.push([d.average_organic_rank, d.click_share, color, tooltip]);
                }
            });

            const data = google.visualization.arrayToDataTable(dataTable);
            
            const options = {
                legend: 'none',
                hAxis: { title: 'Rank Org√°nico (Menor es mejor)', direction: 1 },
                vAxis: { title: 'Click Share (%)' },
                chartArea: { width: '85%', height: '70%' },
                pointSize: 8,
                dataOpacity: 0.7
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- Insights Generation ---
        function generateInsights() {
            const weeks = getUniqueWeeks();
            const lastWeek = weeks[weeks.length - 1];
            const prevWeek = weeks[weeks.length - 2];
            const agg = getAggregatedByBrandAndWeek();
            
            const myCurrent = agg[lastWeek][MY_BRAND];
            const myPrev = agg[prevWeek] ? agg[prevWeek][MY_BRAND] : {share: 0, price_sum: 0, count: 1};
            
            // Determine price trend
            const myPriceCurr = myCurrent.price_sum / myCurrent.count;
            const myPricePrev = myPrev.price_sum / myPrev.count;
            
            const mainCompetitor = topCompetitors[0];
            const compData = agg[lastWeek][mainCompetitor];
            const compPrice = compData.price_sum / compData.count;

            // Generate HTML for Drivers section
            const driversDiv = document.getElementById('drivers-analysis');
            const priceDiff = ((myPriceCurr - compPrice) / compPrice * 100).toFixed(1);
            const cheaper = myPriceCurr < compPrice;
            
            driversDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div class="text-xs text-gray-500 uppercase font-bold">Posicionamiento Precio</div>
                        <div class="text-lg font-bold ${cheaper ? 'text-green-600' : 'text-red-600'}">
                            ${cheaper ? 'M√°s Barato' : 'M√°s Caro'} (${Math.abs(priceDiff)}%)
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Vs ${mainCompetitor}</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div class="text-xs text-gray-500 uppercase font-bold">Actividad Promocional</div>
                        <div class="text-sm font-medium text-gray-700 mt-1">
                            ${myCurrent.deals > 0 ? '‚úÖ Deal Activo' : '‚ùå Sin Deals'}
                        </div>
                        <div class="text-sm font-medium text-gray-700">
                            ${myCurrent.coupons > 0 ? '‚úÖ Cup√≥n Activo' : '‚ùå Sin Cupones'}
                        </div>
                    </div>
                </div>
            `;

            // Textual Insights
            const insightsList = document.getElementById('insights-list');
            const recsList = document.getElementById('recommendations-list');
            
            const shareTrend = myCurrent.share > myPrev.share ? "aumentando" : "disminuyendo";
            const shareDiff = (myCurrent.share - myPrev.share).toFixed(2);
            
            insightsList.innerHTML = `
                <li>Nuestra marca <strong>${shareTrend}</strong> su visibilidad (+${shareDiff} pts) en la √∫ltima semana.</li>
                <li>Competidor principal: <strong>${mainCompetitor}</strong> domina con ${(compData.share).toFixed(1)}% share.</li>
                <li>Precio: Estamos un <strong>${Math.abs(priceDiff)}% ${cheaper ? 'm√°s baratos' : 'm√°s caros'}</strong> que el l√≠der.</li>
                <li>Eficiencia: ${myCurrent.share > 10 ? 'Alta conversi√≥n de Rank a Share.' : 'Oportunidad de mejorar CTR en posiciones altas.'}</li>
                <li>Tendencia: El volumen total de clicks del parent ${myCurrent.clicks > myPrev.clicks ? 'creci√≥' : 'cay√≥'}, indicando estacionalidad.</li>
            `;

            recsList.innerHTML = `
                <li><strong>Defensa de Share:</strong> ${!cheaper ? 'Considerar ajuste de precio t√°ctico' : 'Mantener ventaja de precio'} frente a ${mainCompetitor}.</li>
                <li><strong>Visibilidad:</strong> ${myCurrent.deals === 0 ? 'Activar cupones (5-10%) para recuperar visibilidad perdida.' : 'Optimizar creatividades para maximizar el tr√°fico del Deal actual.'}</li>
                <li><strong>Contenido:</strong> Revisar t√≠tulos e im√°genes principales de ASINs con rank < 5 pero bajo click share.</li>
            `;
        }

        // --- Interactive Tab Logic ---
        function populateInteractiveControls() {
            const weekSel = document.getElementById('select-week');
            const compSel = document.getElementById('select-competitor');
            
            getUniqueWeeks().reverse().forEach(w => {
                weekSel.innerHTML += `<option value="${w}">${w}</option>`;
            });
            
            getUniqueCompetitors().forEach(c => {
                compSel.innerHTML += `<option value="${c}">${c}</option>`;
            });
            
            // Set defaults if available
            if(topCompetitors.length > 0) compSel.value = topCompetitors[0];
        }

        function updateInteractive() {
            const week = document.getElementById('select-week').value;
            const competitor = document.getElementById('select-competitor').value;
            
            const weekData = marketData.filter(d => d.week_date === week);
            
            // My Data
            const myItems = weekData.filter(d => d.is_yaba_asin === 'Y');
            const myShare = myItems.reduce((sum, d) => sum + d.click_share, 0).toFixed(2);
            const myPrice = (myItems.reduce((sum, d) => sum + d.price, 0) / (myItems.length || 1)).toFixed(2);
            
            // Competitor Data
            const compItems = weekData.filter(d => d.real_brand === competitor);
            const compShare = compItems.reduce((sum, d) => sum + d.click_share, 0).toFixed(2);
            const compPrice = (compItems.reduce((sum, d) => sum + d.price, 0) / (compItems.length || 1)).toFixed(2);
            
            // Update Cards
            document.getElementById('h2h-my-share').innerText = myShare + '%';
            document.getElementById('h2h-my-price').innerText = '‚Ç¨' + myPrice;
            
            document.getElementById('h2h-comp-name').innerText = competitor;
            document.getElementById('h2h-comp-share').innerText = compShare + '%';
            document.getElementById('h2h-comp-price').innerText = '‚Ç¨' + compPrice;
            
            // Table
            const tableDiv = document.getElementById('variants-table');
            let tableHTML = `<table class="min-w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3">ASIN</th>
                                        <th class="px-4 py-3">Brand</th>
                                        <th class="px-4 py-3">Share</th>
                                        <th class="px-4 py-3">Price</th>
                                        <th class="px-4 py-3">Badges</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                                
            // Combine and sort top 5
            const allItems = [...myItems, ...compItems].sort((a,b) => b.click_share - a.click_share).slice(0, 10);
            
            allItems.forEach(item => {
                const isMe = item.is_yaba_asin === 'Y';
                const badges = [];
                if(item.weekly_number_of_days_with_deal > 0) badges.push('üè∑Ô∏è Deal');
                if(item.weekly_number_of_days_with_amazon_choice_badge > 0) badges.push('‚≠ê AC');
                if(item.weekly_number_of_days_with_coupon > 0) badges.push('‚úÇÔ∏è Cpn');
                
                tableHTML += `<tr class="bg-white border-b ${isMe ? 'bg-blue-50' : ''}">
                                <td class="px-4 py-3 font-medium text-gray-900">${item.asin}</td>
                                <td class="px-4 py-3">${item.real_brand}</td>
                                <td class="px-4 py-3 font-bold">${item.click_share}%</td>
                                <td class="px-4 py-3">‚Ç¨${item.price}</td>
                                <td class="px-4 py-3 text-xs">${badges.join(' ')}</td>
                              </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            tableDiv.innerHTML = tableHTML;
        }

    </script>
</body>
</html>