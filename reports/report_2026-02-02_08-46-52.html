<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --danger: #EA4335;
            --warning: #FBBC05;
            --bg: #F8F9FA;
            --surface: #FFFFFF;
            --text-main: #202124;
            --text-sub: #5F6368;
            --border: #DADCE0;
            --shadow: 0 1px 2px rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary);
        }
        header p {
            margin: 4px 0 0;
            color: var(--text-sub);
            font-size: 0.9rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #e8f0fe;
            color: var(--primary);
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(66,133,244,0.3);
        }

        /* Content Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s;
        }
        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            border: 1px solid var(--border);
        }
        .card h3 {
            margin-top: 0;
            color: var(--text-sub);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 10px 0;
        }
        .metric-trend {
            font-size: 0.9rem;
            font-weight: 500;
        }
        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }

        /* Chart Containers */
        .chart-container {
            height: 350px;
            width: 100%;
        }

        /* Insights List */
        ul.insights {
            padding-left: 20px;
        }
        ul.insights li {
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 6px;
        }
        .badge-pos { background: #e6f4ea; color: var(--secondary); }
        .badge-neg { background: #fce8e6; color: var(--danger); }
        .badge-neu { background: #f1f3f4; color: var(--text-sub); }

        /* Comparator Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: 'Inter', sans-serif;
            min-width: 200px;
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .comparison-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            color: var(--text-sub);
        }
        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        .comparison-table td:first-child {
            font-weight: 500;
        }

        /* Footer */
        footer {
            margin-top: 40px;
            text-align: center;
            color: var(--text-sub);
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>An√°lisis de Parent ASIN</h1>
            <p id="header-subtitle">Inteligencia de Mercado - √öltima semana disponible</p>
        </div>
        <div style="text-align: right;">
            <div id="current-week-display" style="font-weight: 700; color: var(--primary);">Week: Cargando...</div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">1. Dashboard Ejecutivo</button>
        <button class="tab-btn" onclick="switchTab('comparator')">2. Comparador Interactivo</button>
    </div>

    <!-- PESTA√ëA 1: DASHBOARD -->
    <div id="dashboard" class="section active">
        
        <!-- KPIs Globales -->
        <div class="grid-3">
            <div class="card">
                <h3><span class="material-icons">touch_app</span> Clics Totales (Est.)</h3>
                <div id="kpi-clicks" class="metric-value">-</div>
                <div id="kpi-clicks-sub" class="metric-trend">Nuestros ASINs vs Mercado</div>
            </div>
            <div class="card">
                <h3><span class="material-icons">pie_chart</span> Click Share Total</h3>
                <div id="kpi-share" class="metric-value">-</div>
                <div class="metric-trend">Cuota de mercado de nuestra marca</div>
            </div>
            <div class="card">
                <h3><span class="material-icons">leaderboard</span> Rank Org√°nico Promedio</h3>
                <div id="kpi-rank" class="metric-value">-</div>
                <div class="metric-trend">Posici√≥n media ponderada</div>
            </div>
        </div>

        <!-- Secci√≥n 1: Tendencia Global -->
        <div class="card" style="margin-bottom: 24px;">
            <h3>1. Tendencia Global del Parent (Volumen & Share)</h3>
            <div id="trend_chart" class="chart-container"></div>
            <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                *Debido a la limitaci√≥n de los datos (una √∫nica semana), se muestra la instant√°nea actual. En un entorno con historial, esto mostrar√≠a la evoluci√≥n de 4-5 semanas.
            </p>
        </div>

        <!-- Secci√≥n 2: Competitividad -->
        <div class="grid-2">
            <div class="card">
                <h3>2. Competitividad de Marca (Share %)</h3>
                <div id="competitiveness_chart" class="chart-container"></div>
            </div>
            <div class="card">
                <h3>Ranking de Competidores (Top 5)</h3>
                <div id="competitor_table_div" style="height: 350px;"></div>
            </div>
        </div>

        <!-- Secci√≥n 3: Palancas -->
        <div class="card" style="margin-bottom: 24px;">
            <h3>3. Palancas de Conversi√≥n (Impacto en Share)</h3>
            <div id="drivers_chart" class="chart-container"></div>
            <p style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                An√°lisis de ASINs individuales comparando Precio vs Click Share. Los colores indican presencia de Deals/Cupones.
            </p>
        </div>

        <!-- Secci√≥n 4: Eficiencia -->
        <div class="card" style="margin-bottom: 24px;">
            <h3>4. Eficiencia Org√°nica (Rank vs Click Share)</h3>
            <div id="efficiency_chart" class="chart-container"></div>
            <p style="font-size: 0.85rem; color: #666; text-align: center; margin-top: 5px;">
                <b>Cuadrante Superior Izquierdo:</b> Alta Eficiencia (Buen Rank, Alto Share) | <b>Inferior Derecho:</b> Baja Eficiencia.
            </p>
        </div>

        <!-- Secci√≥n 5: Insights -->
        <div class="grid-2">
            <div class="card">
                <h3>5. üí° Conclusiones Clave</h3>
                <ul id="insights-list" class="insights">
                    <!-- Dynamic Generation -->
                </ul>
            </div>
            <div class="card">
                <h3>üöÄ Recomendaciones Accionables</h3>
                <ul id="actions-list" class="insights">
                    <!-- Dynamic Generation -->
                </ul>
            </div>
        </div>
        
        <div class="card">
            <h3>6. Other Insights & Anomalies</h3>
             <ul id="other-insights" class="insights">
                <!-- Dynamic Generation -->
            </ul>
        </div>
    </div>

    <!-- PESTA√ëA 2: COMPARADOR -->
    <div id="comparator" class="section">
        <div class="controls">
            <div>
                <label style="display:block; font-size: 0.8rem; margin-bottom: 4px; color: #666;">Seleccionar Competidor</label>
                <select id="comp-selector" onchange="updateComparator()"></select>
            </div>
            <div>
                <label style="display:block; font-size: 0.8rem; margin-bottom: 4px; color: #666;">Semana de An√°lisis</label>
                <select id="week-selector" disabled><option>2026-03 (√önica disponible)</option></select>
            </div>
        </div>

        <div class="grid-2">
            <!-- Our ASIN Card -->
            <div class="card" style="border-top: 4px solid var(--primary);">
                <h2 style="color: var(--primary); margin-top:0;">Nuestra Marca</h2>
                <h3 id="our-brand-name">-</h3>
                <table class="comparison-table">
                    <tr><td>Click Share</td><td id="comp-our-share">-</td></tr>
                    <tr><td>Avg. Price</td><td id="comp-our-price">-</td></tr>
                    <tr><td>Avg. Rank</td><td id="comp-our-rank">-</td></tr>
                    <tr><td>Active Deals</td><td id="comp-our-deals">-</td></tr>
                </table>
            </div>

            <!-- Competitor ASIN Card -->
            <div class="card" style="border-top: 4px solid var(--danger);">
                <h2 style="color: var(--danger); margin-top:0;">Competidor</h2>
                <h3 id="comp-brand-name">-</h3>
                <table class="comparison-table">
                    <tr><td>Click Share</td><td id="comp-their-share">-</td></tr>
                    <tr><td>Avg. Price</td><td id="comp-their-price">-</td></tr>
                    <tr><td>Avg. Rank</td><td id="comp-their-rank">-</td></tr>
                    <tr><td>Active Deals</td><td id="comp-their-deals">-</td></tr>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>Visualizaci√≥n Comparativa (Share vs Precio)</h3>
            <div id="head_to_head_chart" class="chart-container"></div>
        </div>
    </div>

    <footer>
        Generado autom√°ticamente por Market Intelligence System ‚Ä¢ Fecha de Reporte: <span id="report-date"></span>
    </footer>
</div>

<script>
    // --- 1. DATOS INYECTADOS (Procesados desde el CSV) ---
    const marketData = [{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Chaism","asin":"B0BPXQ2PR5","product_title":"Chaism Ceremonial Grade Matcha Green Tea Powder - ...","country_code":"us","average_organic_rank":9,"weekly_number_of_days_with_deal":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":5.66,"impression_share":3.66,"price":17.847142857,"click_share_rank":3,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"MATCHA DNA","asin":"B077572GG8","product_title":"MATCHA DNA Certified Organic Matcha Green Tea Powd...","country_code":"us","average_organic_rank":8,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":3.93,"impression_share":4.82,"price":19.99,"click_share_rank":7,"weekly_search_volume":110710.5,"is_yaba_asin":"Y","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":null,"asin":"B097Z6ZH1S","product_title":"Jade Leaf Matcha Premium Ceremonial Grade Matcha G...","country_code":"us","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":2.78,"impression_share":2.64,"price":17.99,"click_share_rank":8,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Naoki Matcha","asin":"B01L2GW7SI","product_title":"Naoki Matcha Superior Ceremonial Blend ‚Äì Authentic...","country_code":"us","average_organic_rank":3,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":4,"weekly_number_of_days_with_coupon":0,"click_share":8.35,"impression_share":5.1,"price":24.99,"click_share_rank":2,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Micro Ingredients","asin":"B08PY3Q8XS","product_title":"Micro Ingredients Organic Matcha Green Tea Powder,...","country_code":"us","average_organic_rank":3,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":5,"weekly_number_of_days_with_coupon":7,"click_share":5.16,"impression_share":3.71,"price":23.19,"click_share_rank":4,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Crafti","asin":"B0CXT6L9H5","product_title":"Crafti Ceremonial Grade Matcha Powder (Organic) - ...","country_code":"us","average_organic_rank":21,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":1.97,"impression_share":3.32,"price":20.95,"click_share_rank":10,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Jade Leaf Matcha","asin":"B00PFDH0IC","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":13.99,"impression_share":4.45,"price":10.99,"click_share_rank":1,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Jade Leaf Matcha","asin":"B01DTQD7VA","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":6,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":4.83,"impression_share":3.32,"price":10.99,"click_share_rank":5,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":null,"asin":"B0DV6Z5MYZ","product_title":"Soeos Organic Matcha Powder, Matcha Green Tea Powd...","country_code":"us","average_organic_rank":12,"weekly_number_of_days_with_deal":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":2.47,"impression_share":1.83,"price":6.69,"click_share_rank":9,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"},{"brand_aggregation":"purechimp","parent_asin":"Matcha Powder Jar","reporting_date":"2026-01-17","week_date":"2026-03","keywords":"matcha powder","competitor_brand":"Jade Leaf Matcha","asin":"B089Q9XD2T","product_title":"Jade Leaf Matcha Organic Premium Ceremonial Grade ...","country_code":"us","average_organic_rank":7,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":3,"click_share":4.47,"impression_share":3.63,"price":30.984285714,"click_share_rank":6,"weekly_search_volume":110710.5,"is_yaba_asin":"N","keywords_link":"https://www.amazon.com/s?k=matcha+powder"}];

    // --- 2. L√ìGICA DE PROCESAMIENTO ---
    let processedData = [];
    let ourBrand = "Unknown";
    let allBrands = [];
    
    function init() {
        processRawData();
        renderKPIs();
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(drawCharts);
        generateInsights();
        populateComparator();
    }

    function processRawData() {
        // 1. Identificar nuestra marca (Source of Truth: is_yaba_asin == 'Y')
        const yabaAsin = marketData.find(row => row.is_yaba_asin === 'Y');
        if (yabaAsin) {
            ourBrand = yabaAsin.competitor_brand || extractBrand(yabaAsin);
        }

        // 2. Normalizar datos
        processedData = marketData.map(row => {
            let brand = row.competitor_brand;
            if (!brand) brand = extractBrand(row);
            
            // Calculo estimado de clicks (Volume * Share / 100)
            const estClicks = (row.click_share / 100) * row.weekly_search_volume;

            return {
                ...row,
                real_brand: brand,
                est_clicks: estClicks,
                is_promo: (row.weekly_number_of_days_with_deal > 0 || row.weekly_number_of_days_with_coupon > 0)
            };
        });

        // Unique Brands list
        const brandSet = new Set(processedData.map(d => d.real_brand));
        allBrands = Array.from(brandSet);
        
        // Update header
        document.getElementById('current-week-display').innerText = `Semana: ${processedData[0].week_date}`;
        document.getElementById('report-date').innerText = new Date().toLocaleDateString();
    }

    function extractBrand(row) {
        // Fallback extraction logic
        if (row.product_title) {
            const words = row.product_title.split(' ');
            if (words.length > 0) return words[0].replace(/[^a-zA-Z0-9]/g, '');
        }
        return "Unknown Brand";
    }

    // --- 3. AGREGACI√ìN DE M√âTRICAS ---
    function renderKPIs() {
        // Filter for "Our Brand" vs "Total Market"
        const ourData = processedData.filter(d => d.real_brand === ourBrand);
        
        const totalClicks = processedData.reduce((acc, curr) => acc + curr.est_clicks, 0);
        const ourClicks = ourData.reduce((acc, curr) => acc + curr.est_clicks, 0);
        
        // Share Calculation
        const ourShare = (ourClicks / totalClicks) * 100;
        
        // Rank Calculation (Weighted Average by clicks would be better, but simple avg for now)
        const avgRank = ourData.reduce((acc, curr) => acc + curr.average_organic_rank, 0) / (ourData.length || 1);

        document.getElementById('kpi-clicks').innerText = Math.round(ourClicks).toLocaleString();
        document.getElementById('kpi-clicks-sub').innerText = `${Math.round(totalClicks).toLocaleString()} mercado total`;
        document.getElementById('kpi-share').innerText = `${ourShare.toFixed(2)}%`;
        document.getElementById('kpi-rank').innerText = `#${avgRank.toFixed(1)}`;
    }

    // --- 4. GR√ÅFICOS GOOGLE CHARTS ---
    function drawCharts() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawDriversChart();
        drawEfficiencyChart();
        drawCompetitorTable();
        drawHeadToHead();
    }

    function drawTrendChart() {
        // Como solo hay 1 semana, hacemos un gr√°fico de barras comparando Nosotros vs Resto
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Entidad');
        data.addColumn('number', 'Volumen de Clics');
        data.addColumn({type: 'string', role: 'style'});

        const ourData = processedData.filter(d => d.real_brand === ourBrand);
        const compData = processedData.filter(d => d.real_brand !== ourBrand);

        const ourClicks = ourData.reduce((sum, d) => sum + d.est_clicks, 0);
        const compClicks = compData.reduce((sum, d) => sum + d.est_clicks, 0);

        data.addRows([
            ['Nuestra Marca', ourClicks, '#4285F4'],
            ['Competencia (Agregada)', compClicks, '#EA4335']
        ]);

        const options = {
            title: 'Distribuci√≥n de Clics Totales (Snapshot Semanal)',
            hAxis: {title: 'Entidad'},
            vAxis: {title: 'Clics Estimados'},
            legend: {position: 'none'},
            animation: {startup: true, duration: 1000, easing: 'out'}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('trend_chart'));
        chart.draw(data, options);
    }

    function drawCompetitivenessChart() {
        // Agrupar Click Share por Marca
        const brandShares = {};
        processedData.forEach(d => {
            if (!brandShares[d.real_brand]) brandShares[d.real_brand] = 0;
            brandShares[d.real_brand] += d.click_share;
        });

        // Convertir a array y ordenar
        let sortedBrands = Object.entries(brandShares).sort((a,b) => b[1] - a[1]);
        
        // Top 5 + Otros
        const top5 = sortedBrands.slice(0, 5);
        
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Marca');
        data.addColumn('number', 'Click Share %');
        data.addColumn({type: 'string', role: 'style'});

        top5.forEach(([brand, share]) => {
            const color = (brand === ourBrand) ? '#4285F4' : '#9AA0A6';
            data.addRow([brand, share, color]);
        });

        const options = {
            title: 'Top 5 Marcas por Cuota de Clics',
            pieHole: 0.4,
            colors: top5.map(b => (b[0] === ourBrand) ? '#4285F4' : '#757575'),
            legend: {position: 'right'}
        };

        // Usamos un BarChart para mejor legibilidad que LineChart con 1 solo punto temporal
        const chart = new google.visualization.BarChart(document.getElementById('competitiveness_chart'));
        chart.draw(data, {legend: {position: "none"}});
    }

    function drawDriversChart() {
        // Graficar Precio vs Share para cada ASIN, coloreando si tiene promo
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'ASIN');
        data.addColumn('number', 'Precio ($)');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'style'}); // Color based on promo
        data.addColumn({type: 'string', role: 'tooltip'});

        processedData.forEach(row => {
            const hasPromo = row.weekly_number_of_days_with_deal > 0 || row.weekly_number_of_days_with_coupon > 0;
            const color = (row.real_brand === ourBrand) ? '#4285F4' : (hasPromo ? '#34A853' : '#EA4335');
            const tooltip = `${row.real_brand}\n$${row.price.toFixed(2)}\nShare: ${row.click_share}%\nPromo: ${hasPromo ? 'SI' : 'NO'}`;
            
            data.addRow([row.asin, row.price, row.click_share, color, tooltip]);
        });

        const options = {
            title: 'Impacto del Precio y Promociones en Share',
            hAxis: {title: 'Precio ($)'},
            vAxis: {title: 'Click Share (%)'},
            legend: 'none'
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('drivers_chart'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Org√°nico (Invertido)');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({type: 'string', role: 'style'});
        data.addColumn({type: 'string', role: 'tooltip'});

        processedData.forEach(row => {
            const color = (row.real_brand === ourBrand) ? '#4285F4' : '#9AA0A6';
            data.addRow([row.average_organic_rank, row.click_share, color, `${row.real_brand}: Rank ${row.average_organic_rank}`]);
        });

        const options = {
            title: 'Eficiencia: Rank Org√°nico vs Share',
            hAxis: {title: 'Rank Org√°nico (Menor es mejor)', direction: -1}, // Invertir eje
            vAxis: {title: 'Click Share (%)'},
            legend: 'none'
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
        chart.draw(data, options);
    }
    
    function drawCompetitorTable() {
         const data = new google.visualization.DataTable();
         data.addColumn('string', 'Marca');
         data.addColumn('number', 'Share Total %');
         data.addColumn('number', 'Precio Promedio $');
         
         const brandStats = {};
         processedData.forEach(d => {
             if(!brandStats[d.real_brand]) brandStats[d.real_brand] = {share:0, priceSum:0, count:0};
             brandStats[d.real_brand].share += d.click_share;
             brandStats[d.real_brand].priceSum += d.price;
             brandStats[d.real_brand].count += 1;
         });
         
         Object.keys(brandStats).forEach(b => {
             const avgPrice = brandStats[b].priceSum / brandStats[b].count;
             data.addRow([b, parseFloat(brandStats[b].share.toFixed(2)), parseFloat(avgPrice.toFixed(2))]);
         });
         
         // Sort by Share descending
         data.sort({column: 1, desc: true});
         
         const table = new google.visualization.Table(document.getElementById('competitor_table_div'));
         table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
    }

    // --- 5. INSIGHTS GENERATOR (TEXTUAL) ---
    function generateInsights() {
        const ul = document.getElementById('insights-list');
        const actionsUl = document.getElementById('actions-list');
        const otherUl = document.getElementById('other-insights');
        
        // Helper Data
        const brandShares = {};
        processedData.forEach(d => {
             if(!brandShares[d.real_brand]) brandShares[d.real_brand] = 0;
             brandShares[d.real_brand] += d.click_share;
        });
        const sortedBrands = Object.entries(brandShares).sort((a,b) => b[1] - a[1]);
        const marketLeader = sortedBrands[0];
        const ourEntry = sortedBrands.find(b => b[0] === ourBrand);
        const ourTotalShare = ourEntry ? ourEntry[1] : 0;
        
        // Insight 1: Market Position
        let html1 = `<li><span class="badge badge-pos">Posici√≥n</span> Nuestra marca <b>${ourBrand}</b> tiene un <b>${ourTotalShare.toFixed(2)}%</b> de cuota. `;
        if (marketLeader[0] !== ourBrand) {
            html1 += `El l√≠der es <b>${marketLeader[0]}</b> con ${marketLeader[1].toFixed(2)}%. Estamos a una distancia de ${(marketLeader[1]-ourTotalShare).toFixed(2)} pts.</li>`;
        } else {
            html1 += `¬°Somos l√≠deres de la categor√≠a!</li>`;
        }
        ul.innerHTML += html1;

        // Insight 2: Pricing vs Competition
        const ourPrices = processedData.filter(d => d.real_brand === ourBrand).map(d => d.price);
        const compPrices = processedData.filter(d => d.real_brand !== ourBrand).map(d => d.price);
        const avgOurPrice = ourPrices.reduce((a,b)=>a+b,0)/ourPrices.length;
        const avgCompPrice = compPrices.reduce((a,b)=>a+b,0)/compPrices.length;
        
        let html2 = `<li><span class="badge badge-neu">Precio</span> Nuestro precio promedio ($${avgOurPrice.toFixed(2)}) es `;
        html2 += (avgOurPrice > avgCompPrice) ? `<b>superior</b> al promedio competidor ($${avgCompPrice.toFixed(2)}).` : `<b>m√°s competitivo</b> que el promedio ($${avgCompPrice.toFixed(2)}).`;
        html2 += `</li>`;
        ul.innerHTML += html2;

        // Insight 3: Promociones
        const ourPromos = processedData.filter(d => d.real_brand === ourBrand && d.is_promo).length;
        const compPromos = processedData.filter(d => d.real_brand !== ourBrand && d.is_promo).length;
        ul.innerHTML += `<li><span class="badge badge-warning">Promociones</span> Tenemos ${ourPromos} ASINs activos con Deals/Cupones frente a ${compPromos} de la competencia.</li>`;

        // Insight 4: Efficiency Check
        const inefficientAsins = processedData.filter(d => d.real_brand === ourBrand && d.average_organic_rank > 10);
        if (inefficientAsins.length > 0) {
            ul.innerHTML += `<li><span class="badge badge-neg">Eficiencia</span> ${inefficientAsins.length} de nuestros ASINs tienen ranking org√°nico > 10, limitando la visibilidad.</li>`;
        } else {
            ul.innerHTML += `<li><span class="badge badge-pos">Eficiencia</span> Todos nuestros ASINs rankean en Top 10 org√°nico.</li>`;
        }

        // Recommendations
        if (ourTotalShare < marketLeader[1]) {
            actionsUl.innerHTML += `<li>üéØ <b>Estrategia Defensiva:</b> Analizar los top-selling ASINs de ${marketLeader[0]} para igualar sus ofertas de cupones.</li>`;
        }
        if (avgOurPrice > avgCompPrice * 1.2) {
             actionsUl.innerHTML += `<li>üí∞ <b>Revisi√≥n de Precio:</b> Nuestro precio est√° un 20% por encima del mercado. Evaluar elasticidad o justificar valor premium en listing.</li>`;
        }
        actionsUl.innerHTML += `<li>üîë <b>SEO:</b> Priorizar keywords donde 'rank' es bajo pero 'volume' es alto.</li>`;

        // Other Insights
        const lowRankHighShare = processedData.filter(d => d.average_organic_rank > 15 && d.click_share > 2);
        if (lowRankHighShare.length > 0) {
             otherUl.innerHTML += `<li>üïµÔ∏è <b>Anomal√≠a Competitiva:</b> La marca ${lowRankHighShare[0].real_brand} logra alto share (>2%) con mal ranking org√°nico (#${lowRankHighShare[0].average_organic_rank}). Posiblemente alto gasto en PPC.</li>`;
        } else {
             otherUl.innerHTML += `<li>‚úÖ Correlaci√≥n Rank/Share consistente en el mercado.</li>`;
        }
    }

    // --- 6. INTERACTIVIDAD ---
    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        
        if (tabId === 'comparator') updateComparator();
    }

    function populateComparator() {
        const select = document.getElementById('comp-selector');
        allBrands.filter(b => b !== ourBrand).forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            select.appendChild(opt);
        });
        // Select leader by default
        if(select.options.length > 0) select.selectedIndex = 0;
    }

    function updateComparator() {
        const compBrand = document.getElementById('comp-selector').value;
        if (!compBrand) return;

        // Our Data
        const ourRows = processedData.filter(d => d.real_brand === ourBrand);
        const compRows = processedData.filter(d => d.real_brand === compBrand);

        const calcStats = (rows) => {
            const share = rows.reduce((s,r) => s+r.click_share, 0);
            const price = rows.reduce((s,r) => s+r.price, 0) / (rows.length || 1);
            const rank = rows.reduce((s,r) => s+r.average_organic_rank, 0) / (rows.length || 1);
            const deals = rows.filter(r => r.is_promo).length;
            return {share, price, rank, deals};
        };

        const ours = calcStats(ourRows);
        const theirs = calcStats(compRows);

        document.getElementById('our-brand-name').innerText = ourBrand;
        document.getElementById('comp-our-share').innerText = ours.share.toFixed(2) + '%';
        document.getElementById('comp-our-price').innerText = '$' + ours.price.toFixed(2);
        document.getElementById('comp-our-rank').innerText = '#' + ours.rank.toFixed(1);
        document.getElementById('comp-our-deals').innerText = ours.deals;

        document.getElementById('comp-brand-name').innerText = compBrand;
        document.getElementById('comp-their-share').innerText = theirs.share.toFixed(2) + '%';
        document.getElementById('comp-their-price').innerText = '$' + theirs.price.toFixed(2);
        document.getElementById('comp-their-rank').innerText = '#' + theirs.rank.toFixed(1);
        document.getElementById('comp-their-deals').innerText = theirs.deals;
        
        drawHeadToHead(ours, theirs, compBrand);
    }
    
    function drawHeadToHead(ours, theirs, compName) {
        if (!google.visualization) return; // Wait for load
        
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'M√©trica');
        data.addColumn('number', ourBrand);
        data.addColumn('number', compName);
        
        // Normalize values to 100 for radar-like view or just simple bars
        // For simplicity, using side-by-side bars of Raw Share
        data.addRow(['Click Share (%)', ours?.share || 0, theirs?.share || 0]);
        data.addRow(['Precio ($)', ours?.price || 0, theirs?.price || 0]);
        
        const options = {
            title: 'Comparativa Directa',
            bars: 'horizontal',
            colors: ['#4285F4', '#EA4335']
        };
        
        const chart = new google.visualization.BarChart(document.getElementById('head_to_head_chart'));
        chart.draw(data, options);
    }

    // --- INIT ---
    // Start when DOM is ready
    document.addEventListener("DOMContentLoaded", init);

</script>

</body>
</html>