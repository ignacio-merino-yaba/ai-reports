<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* --- ESTILOS GOOGLE MATERIAL / APPLE-LIKE --- */
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --grey-100: #F1F3F4;
            --grey-300: #DADCE0;
            --grey-800: #202124;
            --white: #FFFFFF;
            --shadow: 0 1px 3px rgba(60,64,67, 0.3), 0 4px 8px 3px rgba(60,64,67, 0.15);
            --card-radius: 16px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--grey-100);
            color: var(--grey-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--white);
            padding: 20px 0;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 500; }
        .subtitle { color: #5f6368; font-size: 14px; }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--white);
            border-radius: var(--card-radius);
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            width: fit-content;
        }
        .tab-btn {
            border: none;
            background: none;
            padding: 10px 24px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background-color: var(--primary);
            color: var(--white);
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--card-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            transition: transform 0.2s;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            color: var(--grey-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-icon { color: var(--primary); }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }

        /* Metrics */
        .metric-box {
            text-align: center;
            padding: 16px;
            background: #F8F9FA;
            border-radius: 12px;
        }
        .metric-val { font-size: 24px; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Insights List */
        ul.insights-list { list-style: none; padding: 0; }
        ul.insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--grey-300);
            display: flex;
            align-items: start;
            gap: 12px;
        }
        ul.insights-list li:last-child { border-bottom: none; }
        .insight-icon { font-size: 20px; margin-top: 2px; }
        .insight-pos { color: var(--success); }
        .insight-neg { color: var(--danger); }
        .insight-neu { color: var(--primary); }

        /* Selectors */
        .controls { display: flex; gap: 16px; margin-bottom: 20px; }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--grey-300);
            font-family: inherit;
            background: white;
            font-size: 14px;
        }

        /* Charts Containers */
        .chart-container { width: 100%; height: 350px; }
        .mini-chart { width: 100%; height: 200px; }

        /* Comparison Table */
        .comp-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        .comp-table th, .comp-table td { text-align: left; padding: 12px; border-bottom: 1px solid var(--grey-300); }
        .comp-table th { font-size: 12px; color: #5f6368; text-transform: uppercase; }
        
        /* Helpers */
        .hidden { display: none; }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        .bg-blue { background-color: var(--primary); }
        .bg-red { background-color: var(--danger); }
        .bg-green { background-color: var(--success); }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div>
                <h1>Parent ASIN Analysis</h1>
                <div class="subtitle">Reporte de Inteligencia de Mercado | Últimas 5 Semanas</div>
            </div>
            <div style="text-align: right;">
                <div class="subtitle" id="report-date">Generado: Hoy</div>
                <div style="font-weight: 500; color: var(--primary);">Nuestra Marca: <span id="our-brand-name">Detectando...</span></div>
            </div>
        </div>
    </header>

    <div class="container">
        
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="tab-static">
            
            <!-- Section 1: Global Trend -->
            <div class="card">
                <h2><span class="material-icons card-icon">trending_up</span> 1. Tendencia Global del Parent (Volumen & Share)</h2>
                <p style="font-size: 14px; color: #666; margin-bottom: 16px;">Análisis agregado de todas las keywords. Barras = Volumen Mercado (Clicks), Líneas = Click Share.</p>
                <div id="chart_trend" class="chart-container"></div>
                <div class="grid-3" style="margin-top: 16px;">
                    <div class="metric-box">
                        <div class="metric-val" id="metric-total-clicks">-</div>
                        <div class="metric-label">Total Clicks (Last Wk)</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="metric-our-share">-</div>
                        <div class="metric-label">Nuestro Share (Last Wk)</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="metric-trend-status">-</div>
                        <div class="metric-label">Tendencia vs Prev Wk</div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Brand Competitiveness -->
            <div class="card">
                <h2><span class="material-icons card-icon">pie_chart</span> 2. Competitividad de Marca (Top 3 vs Nosotros)</h2>
                <div class="grid-2">
                    <div>
                        <p style="font-size: 14px; color: #666;">Evolución semanal del Click Share por Marca.</p>
                        <div id="chart_brand_share" class="chart-container"></div>
                    </div>
                    <div>
                        <h3>Dinámica Competitiva</h3>
                        <ul class="insights-list" id="brand-insights">
                            <!-- JS Injected -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 3: Levers -->
            <div class="card">
                <h2><span class="material-icons card-icon">tune</span> 3. Palancas de Crecimiento (Precio & Promociones)</h2>
                <div class="grid-2">
                    <div id="chart_levers" class="chart-container"></div>
                    <div>
                        <table class="comp-table">
                            <thead>
                                <tr>
                                    <th>Palanca</th>
                                    <th>Impacto Detectado</th>
                                    <th>Vs Competencia</th>
                                </tr>
                            </thead>
                            <tbody id="levers-table-body">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section 4: Efficiency -->
            <div class="card">
                <h2><span class="material-icons card-icon">scatter_plot</span> 4. Eficiencia (Organic Rank vs Click Share)</h2>
                <p style="font-size: 14px; color: #666;">Cada punto es un ASIN. Eje X = Ranking (Mejor a la izq). Eje Y = Click Share. Arriba/Derecha = Alta Eficiencia.</p>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>

            <!-- Section 5: Conclusions -->
            <div class="grid-2">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <h2><span class="material-icons card-icon">lightbulb</span> 5. Insights Clave</h2>
                    <ul class="insights-list" id="main-insights">
                        <!-- JS Injected -->
                    </ul>
                </div>
                <div class="card" style="border-left: 5px solid var(--success);">
                    <h2><span class="material-icons card-icon">task_alt</span> Recomendaciones Accionables</h2>
                    <ul class="insights-list" id="recommendations">
                        <!-- JS Injected -->
                    </ul>
                </div>
            </div>

        </div>

        <!-- TAB 2: INTERACTIVE -->
        <div id="tab-interactive" class="hidden">
            <div class="card">
                <h2><span class="material-icons card-icon">compare_arrows</span> Comparador Cara a Cara</h2>
                
                <div class="controls">
                    <select id="sel-week" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                    <select id="sel-competitor" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="grid-2">
                    <!-- Our ASIN Stats -->
                    <div style="background: #F8FBFF; padding: 20px; border-radius: 12px; border: 1px solid #cce0ff;">
                        <h3 style="color: var(--primary); margin-top:0;">Nuestra Marca (<span class="our-brand-disp"></span>)</h3>
                        <div id="interactive-us-stats"></div>
                        <div id="chart_int_us" class="mini-chart"></div>
                    </div>

                    <!-- Competitor Stats -->
                    <div style="background: #FFF8F8; padding: 20px; border-radius: 12px; border: 1px solid #ffcccc;">
                        <h3 style="color: var(--danger); margin-top:0;">Competidor (<span id="comp-brand-disp"></span>)</h3>
                        <div id="interactive-comp-stats"></div>
                        <div id="chart_int_comp" class="mini-chart"></div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>Detalle de ASINs en esta semana</h3>
                    <div id="interactive-table-div"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script type="text/javascript">
        
        // 1. DATASET SINTÉTICO (SIMULANDO CSV PROCESADO)
        // Estructura basada en los campos del prompt.
        // Semanas: 2023-40 a 2023-44
        const marketData = [
            // WEEK 1: Estabilidad
            { week: '2023-W40', brand: 'YabaTech', asin: 'B001_Y', title: 'YabaTech Charger 20W USB-C', price: 19.99, rank: 3, clicks: 1200, share: 12.0, deal: 0, coupon: 0, choice: 1, is_yaba: 'Y' },
            { week: '2023-W40', brand: 'YabaTech', asin: 'B002_Y', title: 'YabaTech Cable 2M', price: 9.99, rank: 5, clicks: 800, share: 8.0, deal: 0, coupon: 1, choice: 0, is_yaba: 'Y' },
            { week: '2023-W40', brand: 'Anker', asin: 'B003_A', title: 'Anker Nano Pro', price: 22.99, rank: 1, clicks: 2500, share: 25.0, deal: 0, coupon: 0, choice: 1, is_yaba: 'N' },
            { week: '2023-W40', brand: 'Belkin', asin: 'B004_B', title: 'Belkin BoostCharge', price: 24.99, rank: 8, clicks: 500, share: 5.0, deal: 0, coupon: 0, choice: 0, is_yaba: 'N' },
            { week: '2023-W40', brand: 'Ugreen', asin: 'B005_U', title: 'Ugreen Nexode', price: 18.99, rank: 4, clicks: 1100, share: 11.0, deal: 0, coupon: 1, choice: 0, is_yaba: 'N' },

            // WEEK 2: YabaTech sube precio, baja share
            { week: '2023-W41', brand: 'YabaTech', asin: 'B001_Y', title: 'YabaTech Charger 20W USB-C', price: 21.99, rank: 4, clicks: 1000, share: 9.5, deal: 0, coupon: 0, choice: 0, is_yaba: 'Y' },
            { week: '2023-W41', brand: 'YabaTech', asin: 'B002_Y', title: 'YabaTech Cable 2M', price: 9.99, rank: 6, clicks: 750, share: 7.1, deal: 0, coupon: 1, choice: 0, is_yaba: 'Y' },
            { week: '2023-W41', brand: 'Anker', asin: 'B003_A', title: 'Anker Nano Pro', price: 22.99, rank: 1, clicks: 2600, share: 24.8, deal: 0, coupon: 0, choice: 1, is_yaba: 'N' },
            { week: '2023-W41', brand: 'Belkin', asin: 'B004_B', title: 'Belkin BoostCharge', price: 24.99, rank: 7, clicks: 550, share: 5.2, deal: 0, coupon: 0, choice: 0, is_yaba: 'N' },
            { week: '2023-W41', brand: 'Ugreen', asin: 'B005_U', title: 'Ugreen Nexode', price: 18.99, rank: 3, clicks: 1300, share: 12.4, deal: 1, coupon: 0, choice: 0, is_yaba: 'N' },

            // WEEK 3: Anker Deal agresivo
            { week: '2023-W42', brand: 'YabaTech', asin: 'B001_Y', title: 'YabaTech Charger 20W USB-C', price: 21.99, rank: 5, clicks: 900, share: 8.2, deal: 0, coupon: 0, choice: 0, is_yaba: 'Y' },
            { week: '2023-W42', brand: 'YabaTech', asin: 'B002_Y', title: 'YabaTech Cable 2M', price: 9.99, rank: 6, clicks: 700, share: 6.4, deal: 0, coupon: 0, choice: 0, is_yaba: 'Y' },
            { week: '2023-W42', brand: 'Anker', asin: 'B003_A', title: 'Anker Nano Pro', price: 19.99, rank: 1, clicks: 3500, share: 32.0, deal: 7, coupon: 0, choice: 1, is_yaba: 'N' },
            { week: '2023-W42', brand: 'Ugreen', asin: 'B005_U', title: 'Ugreen Nexode', price: 18.99, rank: 4, clicks: 1000, share: 9.1, deal: 0, coupon: 0, choice: 0, is_yaba: 'N' },
            { week: '2023-W42', brand: 'Unknown', asin: 'B006_X', title: 'Cheap Generic', price: 5.99, rank: 10, clicks: 300, share: 2.7, deal: 0, coupon: 0, choice: 0, is_yaba: 'N' },

            // WEEK 4: YabaTech reacciona con Coupon
            { week: '2023-W43', brand: 'YabaTech', asin: 'B001_Y', title: 'YabaTech Charger 20W USB-C', price: 21.99, rank: 3, clicks: 1300, share: 13.0, deal: 0, coupon: 7, choice: 0, is_yaba: 'Y' },
            { week: '2023-W43', brand: 'Anker', asin: 'B003_A', title: 'Anker Nano Pro', price: 22.99, rank: 1, clicks: 2400, share: 24.0, deal: 0, coupon: 0, choice: 1, is_yaba: 'N' },
            { week: '2023-W43', brand: 'Ugreen', asin: 'B005_U', title: 'Ugreen Nexode', price: 16.99, rank: 2, clicks: 1800, share: 18.0, deal: 3, coupon: 0, choice: 0, is_yaba: 'N' },
            { week: '2023-W43', brand: 'Belkin', asin: 'B004_B', title: 'Belkin BoostCharge', price: 23.99, rank: 9, clicks: 400, share: 4.0, deal: 0, coupon: 0, choice: 0, is_yaba: 'N' },

            // WEEK 5 (LAST WEEK): YabaTech Deal Days + Price Correction
            { week: '2023-W44', brand: 'YabaTech', asin: 'B001_Y', title: 'YabaTech Charger 20W USB-C', price: 19.99, rank: 2, clicks: 1800, share: 16.5, deal: 5, coupon: 0, choice: 1, is_yaba: 'Y' },
            { week: '2023-W44', brand: 'YabaTech', asin: 'B002_Y', title: 'YabaTech Cable 2M', price: 8.99, rank: 5, clicks: 900, share: 8.2, deal: 0, coupon: 1, choice: 0, is_yaba: 'Y' },
            { week: '2023-W44', brand: 'Anker', asin: 'B003_A', title: 'Anker Nano Pro', price: 22.99, rank: 1, clicks: 2200, share: 20.1, deal: 0, coupon: 0, choice: 0, is_yaba: 'N' },
            { week: '2023-W44', brand: 'Ugreen', asin: 'B005_U', title: 'Ugreen Nexode', price: 18.99, rank: 3, clicks: 1500, share: 13.7, deal: 0, coupon: 0, choice: 0, is_yaba: 'N' },
            { week: '2023-W44', brand: 'Belkin', asin: 'B004_B', title: 'Belkin BoostCharge', price: 24.99, rank: 8, clicks: 450, share: 4.1, deal: 0, coupon: 0, choice: 0, is_yaba: 'N' },
        ];

        // 2. CONFIGURACIÓN E INICIALIZACIÓN
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        let OUR_BRAND = '';
        let TOP_COMPETITORS = [];
        let WEEKS = [];
        
        function initDashboard() {
            processData();
            renderStaticReport();
            setupInteractiveControls();
        }

        // 3. PROCESAMIENTO DE DATOS
        function processData() {
            // Identificar nuestra marca
            const ourAsin = marketData.find(d => d.is_yaba === 'Y');
            OUR_BRAND = ourAsin ? ourAsin.brand : 'Unknown';
            document.getElementById('our-brand-name').innerText = OUR_BRAND;
            
            // Setear displays de marca
            document.querySelectorAll('.our-brand-disp').forEach(el => el.innerText = OUR_BRAND);

            // Obtener semanas únicas
            WEEKS = [...new Set(marketData.map(d => d.week))].sort();

            // Identificar Top Competidores (por share total)
            const brandShares = {};
            marketData.forEach(d => {
                if (d.brand === OUR_BRAND) return;
                brandShares[d.brand] = (brandShares[d.brand] || 0) + d.share;
            });
            TOP_COMPETITORS = Object.entries(brandShares)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 3)
                .map(e => e[0]);
        }

        // 4. RENDERIZADO DEL REPORTE ESTÁTICO
        function renderStaticReport() {
            drawTrendChart();
            drawBrandShareChart();
            drawEfficiencyChart();
            drawLeversAnalysis();
            generateTextInsights();
        }

        // --- SECCIÓN 1: TREND ---
        function drawTrendChart() {
            // Agrupar por semana: Total Clicks, Our Clicks, Comp Clicks
            const trendData = WEEKS.map(week => {
                const weekData = marketData.filter(d => d.week === week);
                const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
                const ourClicks = weekData.filter(d => d.is_yaba === 'Y').reduce((sum, d) => sum + d.clicks, 0);
                const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
                return [week, totalClicks, ourShare];
            });

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Volumen Mercado (Clicks)');
            data.addColumn('number', 'Nuestro Share %');

            data.addRows(trendData);

            const options = {
                seriesType: 'bars',
                series: { 1: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
                colors: ['#DADCE0'],
                vAxes: {
                    0: { title: 'Clicks Totales', gridlines: {count: 4} },
                    1: { title: 'Share %', format: '#\'%\'', minValue: 0 }
                },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);

            // Metrics Update
            const lastWeek = trendData[trendData.length - 1];
            const prevWeek = trendData[trendData.length - 2];
            
            document.getElementById('metric-total-clicks').innerText = lastWeek[1].toLocaleString();
            document.getElementById('metric-our-share').innerText = lastWeek[2].toFixed(1) + '%';
            
            const trendDiff = lastWeek[1] - prevWeek[1];
            const trendEl = document.getElementById('metric-trend-status');
            trendEl.innerText = (trendDiff >= 0 ? '+' : '') + ((trendDiff/prevWeek[1])*100).toFixed(1) + '%';
            trendEl.style.color = trendDiff >= 0 ? 'var(--success)' : 'var(--danger)';
        }

        // --- SECCIÓN 2: BRAND SHARE ---
        function drawBrandShareChart() {
            // Estructura: Week, OurBrand, Comp1, Comp2, Comp3, Others
            const header = ['Semana', OUR_BRAND, ...TOP_COMPETITORS, 'Resto'];
            
            const rows = WEEKS.map(week => {
                const weekData = marketData.filter(d => d.week === week);
                const totalShare = weekData.reduce((sum, d) => sum + d.share, 0); // Should be ~100
                
                const getShare = (brand) => {
                    return weekData.filter(d => d.brand === brand).reduce((sum, d) => sum + d.share, 0);
                };

                const ourShare = getShare(OUR_BRAND);
                const compShares = TOP_COMPETITORS.map(c => getShare(c));
                const knownShare = ourShare + compShares.reduce((a,b)=>a+b, 0);
                const otherShare = Math.max(0, 100 - knownShare); // Aprox del total mercado real

                return [week, ourShare, ...compShares, otherShare];
            });

            const data = google.visualization.arrayToDataTable([header, ...rows]);

            const options = {
                curveType: 'function',
                lineWidth: 2.5,
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' },
                vAxis: { title: 'Click Share %' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
            chart.draw(data, options);

            // Insights de Marca
            const list = document.getElementById('brand-insights');
            const lastRow = rows[rows.length-1];
            const prevRow = rows[rows.length-2];
            // Indice 1 es Nuestra Marca
            const diff = lastRow[1] - prevRow[1];
            
            let html = `
                <li>
                    <span class="material-icons insight-icon ${diff >= 0 ? 'insight-pos' : 'insight-neg'}">
                        ${diff >= 0 ? 'trending_up' : 'trending_down'}
                    </span>
                    <div>
                        <strong>${OUR_BRAND}:</strong> ${diff >= 0 ? 'Ganó' : 'Perdió'} 
                        ${Math.abs(diff).toFixed(1)} puntos de cuota vs semana anterior.
                    </div>
                </li>
            `;
            
            // Analizar competidor dominante
            const compIndex = 2; // Primer competidor
            const compName = TOP_COMPETITORS[0];
            const compDiff = lastRow[compIndex] - prevRow[compIndex];
            html += `
                <li>
                    <span class="material-icons insight-icon insight-neu">visibility</span>
                    <div>
                        <strong>${compName} (Líder Rival):</strong> Tendencia ${compDiff > 0 ? 'alcista' : 'bajista'} (${compDiff.toFixed(1)} pts).
                    </div>
                </li>
            `;
            list.innerHTML = html;
        }

        // --- SECCIÓN 3: PALANCAS (Precios y Promos) ---
        function drawLeversAnalysis() {
            // Gráfico: Precio promedio vs Share (Nuestra Marca vs Mercado)
            const rows = WEEKS.map(week => {
                const weekData = marketData.filter(d => d.week === week);
                const ourData = weekData.filter(d => d.brand === OUR_BRAND);
                const mktData = weekData.filter(d => d.brand !== OUR_BRAND);

                const avgPriceUs = ourData.reduce((s, d) => s + d.price, 0) / (ourData.length || 1);
                const avgPriceMkt = mktData.reduce((s, d) => s + d.price, 0) / (mktData.length || 1);
                
                return [week, avgPriceUs, avgPriceMkt];
            });

            const data = google.visualization.arrayToDataTable([
                ['Semana', 'Precio Promedio (Nosotros)', 'Precio Promedio (Competencia)'],
                ...rows
            ]);

            const options = {
                series: {
                    0: { color: '#4285F4', lineWidth: 3 },
                    1: { color: '#9AA0A6', lineDashStyle: [4, 4] }
                },
                legend: { position: 'bottom' },
                vAxis: { title: 'Precio Promedio ($)' },
                chartArea: { width: '80%', height: '70%' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_levers'));
            chart.draw(data, options);

            // Tabla de Impacto
            // Logica simple: ¿Semanas con Deal tuvieron más share?
            const analyzeImpact = (brand) => {
                const brandData = marketData.filter(d => d.brand === brand);
                const withDeal = brandData.filter(d => d.deal > 0);
                const noDeal = brandData.filter(d => d.deal === 0);
                
                const avgShareDeal = withDeal.length ? withDeal.reduce((s,d)=>s+d.share,0)/withDeal.length : 0;
                const avgShareNoDeal = noDeal.length ? noDeal.reduce((s,d)=>s+d.share,0)/noDeal.length : 0;
                
                return { hasDeals: withDeal.length > 0, lift: avgShareDeal - avgShareNoDeal };
            };

            const usImpact = analyzeImpact(OUR_BRAND);
            const compImpact = analyzeImpact(TOP_COMPETITORS[0]);

            const tbody = document.getElementById('levers-table-body');
            tbody.innerHTML = `
                <tr>
                    <td><strong>Deals / Ofertas</strong></td>
                    <td>${usImpact.hasDeals 
                        ? (usImpact.lift > 0 ? `<span class="badge bg-green">+${usImpact.lift.toFixed(1)}% Share</span>` : 'Sin impacto claro') 
                        : 'No activado'}</td>
                    <td>${compImpact.hasDeals ? (compImpact.lift > 0 ? 'Efectivo' : 'Neutro') : 'Inactivo'}</td>
                </tr>
                <tr>
                    <td><strong>Sensibilidad Precio</strong></td>
                    <td>Alta (Subidas reducen share)</td>
                    <td>Media</td>
                </tr>
                <tr>
                    <td><strong>Amazon Choice</strong></td>
                    <td>Factor clave de conversión</td>
                    <td>Presente en Top ASINs</td>
                </tr>
            `;
        }

        // --- SECCIÓN 4: EFICIENCIA ---
        function drawEfficiencyChart() {
            // Scatter: Rank (X) vs Share (Y). Última Semana.
            const lastWeek = WEEKS[WEEKS.length - 1];
            const currentData = marketData.filter(d => d.week === lastWeek);

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('number', 'Organic Rank');
            dataTable.addColumn('number', 'Click Share');
            dataTable.addColumn({type: 'string', role: 'style'}); // Color
            dataTable.addColumn({type: 'string', role: 'tooltip'});

            currentData.forEach(d => {
                const color = d.brand === OUR_BRAND ? '#4285F4' : (TOP_COMPETITORS.includes(d.brand) ? '#EA4335' : '#9AA0A6');
                dataTable.addRow([
                    d.rank, 
                    d.share, 
                    `point { fill-color: ${color}; size: 10; }`,
                    `${d.brand} - ${d.asin}\nRank: ${d.rank}\nShare: ${d.share}%`
                ]);
            });

            const options = {
                hAxis: { title: 'Ranking Orgánico (Invertido)', direction: -1, viewWindow: {min: 1} },
                vAxis: { title: 'Click Share %' },
                legend: 'none',
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(dataTable, options);
        }

        // --- SECCIÓN 5: INSIGHTS & RECOMENDACIONES ---
        function generateTextInsights() {
            const ulInsights = document.getElementById('main-insights');
            const ulRecs = document.getElementById('recommendations');

            // Logica simple para generar texto
            ulInsights.innerHTML = `
                <li>
                    <span class="material-icons insight-icon insight-neu">show_chart</span>
                    <div><strong>Tendencia General:</strong> El parent muestra recuperación en la última semana gracias a la reactivación promocional (Deals).</div>
                </li>
                <li>
                    <span class="material-icons insight-icon insight-neg">money_off</span>
                    <div><strong>Sensibilidad al Precio:</strong> En la semana 41, el incremento de precio de $19.99 a $21.99 causó una pérdida de cuota inmediata (-2.5 pts).</div>
                </li>
                <li>
                    <span class="material-icons insight-icon insight-pos">local_offer</span>
                    <div><strong>Efectividad de Deals:</strong> Los Deal Days activados en la última semana generaron un lift de share superior al de los cupones.</div>
                </li>
                <li>
                    <span class="material-icons insight-icon insight-neg">warning</span>
                    <div><strong>Amenaza Competitiva:</strong> ${TOP_COMPETITORS[0]} mantiene el liderazgo en rank #1 orgánico consistentemente, bloqueando visibilidad.</div>
                </li>
                <li>
                    <span class="material-icons insight-icon insight-pos">star</span>
                    <div><strong>Eficiencia:</strong> Nuestros ASINs tienen un 'Overperformance' relativo; logran buen share (Top 3) pese a rankear por debajo del Top 2 orgánico.</div>
                </li>
            `;

            ulRecs.innerHTML = `
                <li>
                    <span class="material-icons insight-icon insight-pos">check_circle</span>
                    <div><strong>Mantener Precio Competitivo:</strong> Estabilizar el precio en $19.99. Subir a $21.99 rompe la elasticidad de la demanda.</div>
                </li>
                <li>
                    <span class="material-icons insight-icon insight-pos">check_circle</span>
                    <div><strong>Defensa contra ${TOP_COMPETITORS[0]}:</strong> Activar cupones de defensa en las semanas donde ellos no tienen Deal para robar tráfico susceptible al precio.</div>
                </li>
                <li>
                    <span class="material-icons insight-icon insight-pos">check_circle</span>
                    <div><strong>SEO en Títulos:</strong> El ASIN B002_Y tiene bajo Rank (#5-6). Revisar keywords de backend para intentar asaltar el Top 3 orgánico.</div>
                </li>
            `;
        }

        // --- PESTAÑA 2: INTERACTIVO ---
        function setupInteractiveControls() {
            // Llenar Selects
            const selWeek = document.getElementById('sel-week');
            WEEKS.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                selWeek.appendChild(opt);
            });
            selWeek.value = WEEKS[WEEKS.length-1]; // Select last week

            const selComp = document.getElementById('sel-competitor');
            TOP_COMPETITORS.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                selComp.appendChild(opt);
            });

            updateInteractive();
        }

        function updateInteractive() {
            const week = document.getElementById('sel-week').value;
            const comp = document.getElementById('sel-competitor').value;
            document.getElementById('comp-brand-disp').innerText = comp;

            const weekData = marketData.filter(d => d.week === week);
            const usData = weekData.filter(d => d.brand === OUR_BRAND);
            const compData = weekData.filter(d => d.brand === comp);

            // Calcular Stats Agregados
            const calcStats = (data) => {
                const share = data.reduce((s,d)=>s+d.share, 0).toFixed(1);
                const avgRank = (data.reduce((s,d)=>s+d.rank, 0) / (data.length||1)).toFixed(1);
                const deals = data.reduce((s,d)=>s+d.deal, 0);
                return { share, avgRank, deals };
            };

            const usStats = calcStats(usData);
            const compStats = calcStats(compData);

            // Render Stats HTML
            const renderBox = (id, stats, color) => {
                document.getElementById(id).innerHTML = `
                    <div class="grid-2">
                        <div>
                            <div style="font-size:20px; font-weight:bold; color:${color}">${stats.share}%</div>
                            <div style="font-size:12px; color:#666">Click Share</div>
                        </div>
                        <div>
                            <div style="font-size:20px; font-weight:bold; color:${color}">#${stats.avgRank}</div>
                            <div style="font-size:12px; color:#666">Avg Rank</div>
                        </div>
                    </div>
                    <div style="margin-top:12px; font-size:13px;">
                        <strong>Deals Activos:</strong> ${stats.deals > 0 ? 'SÍ' : 'NO'}
                    </div>
                `;
            };

            renderBox('interactive-us-stats', usStats, '#4285F4');
            renderBox('interactive-comp-stats', compStats, '#EA4335');

            // Render Tabla Detallada
            let tableHtml = `<table class="comp-table"><thead><tr><th>ASIN</th><th>Brand</th><th>Precio</th><th>Rank</th><th>Share</th><th>Badges</th></tr></thead><tbody>`;
            
            [...usData, ...compData].sort((a,b)=>a.rank - b.rank).forEach(d => {
                const badges = [];
                if(d.deal > 0) badges.push('<span class="badge bg-red">DEAL</span>');
                if(d.choice > 0) badges.push('<span class="badge bg-blue">CHOICE</span>');
                if(d.coupon > 0) badges.push('<span class="badge bg-green">CPN</span>');

                tableHtml += `
                    <tr>
                        <td>${d.asin}</td>
                        <td>${d.brand}</td>
                        <td>$${d.price}</td>
                        <td>#${d.rank}</td>
                        <td>${d.share}%</td>
                        <td>${badges.join(' ')}</td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            document.getElementById('interactive-table-div').innerHTML = tableHtml;
        }

        // --- UTILIDAD: CAMBIO DE PESTAÑAS ---
        window.switchTab = function(tabName) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            event.target.classList.add('active'); // Nota: event global simple
        }

    </script>
</body>
</html>