<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - NaturaleBio</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-800: #1f2937;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { margin: 0; font-size: 24px; color: var(--gray-800); }
        .header p { margin: 4px 0 0; color: #6b7280; font-size: 14px; }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .nav-btn {
            padding: 12px 24px;
            border: none;
            background: var(--white);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-btn.active {
            background: var(--primary);
            color: var(--white);
        }
        .nav-btn:hover:not(.active) {
            background: var(--gray-200);
        }

        /* Content Sections */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .metric-card {
            background: #f8fafc;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }
        .metric-value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Charts Containers */
        .chart-container {
            width: 100%;
            min-height: 400px;
        }
        
        /* Insights List */
        .insights-list { list-style: none; padding: 0; }
        .insights-list li {
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .insights-list li:last-child { border-bottom: none; }
        .icon-box {
            background: #e0e7ff;
            color: var(--primary);
            padding: 8px;
            border-radius: 8px;
            display: flex;
        }
        .rec-box { background: #dcfce7; color: var(--success); }

        /* Interactivity */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #f8fafc;
            padding: 16px;
            border-radius: 12px;
        }
        select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-size: 14px;
            min-width: 200px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .metrics-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; gap: 12px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Análisis de Parent ASIN: Matcha Premium</h1>
                <p>Marca: NaturaleBio | Mercado: UK | Última Semana: 2026-01</p>
            </div>
            <div style="text-align: right;">
                <span class="material-icons" style="font-size: 32px; color: var(--primary);">analytics</span>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('static')">
                <span class="material-icons">dashboard</span> Reporte Estático
            </button>
            <button class="nav-btn" onclick="switchTab('interactive')">
                <span class="material-icons">compare_arrows</span> Comparador Interactivo
            </button>
        </div>

        <!-- TAB 1: Reporte Estático -->
        <div id="static" class="tab-content active">
            
            <!-- 1. Tendencia Global -->
            <div class="card">
                <h2><span class="material-icons">trending_up</span> 1. Tendencia Global del Parent (Clicks & Share)</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Clicks (Est.)</div>
                        <div class="metric-value" id="total-clicks">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Click Share Total (Nosotros)</div>
                        <div class="metric-value" id="our-share">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Click Share Total (Comp.)</div>
                        <div class="metric-value" id="comp-share">-</div>
                    </div>
                </div>
                <div id="trend_chart" class="chart-container"></div>
                <p style="font-size: 13px; color: #666; margin-top: 10px;">*Nota: Mostrando snapshot actual debido a la disponibilidad de datos de una única semana.</p>
            </div>

            <!-- 2. Competitividad de Marca -->
            <div class="card">
                <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Share vs Top 3)</h2>
                <div id="brand_chart" class="chart-container"></div>
                <div style="margin-top: 15px; font-size: 14px;">
                    <strong>Análisis:</strong> <span id="brand-analysis-text">Cargando...</span>
                </div>
            </div>

            <!-- 3. Palancas -->
            <div class="card">
                <h2><span class="material-icons">rocket_launch</span> 3. Palancas que Aumentan el Click Share</h2>
                <div id="levers_chart" class="chart-container"></div>
                <p style="font-size: 14px; margin-top: 10px;">
                    Se compara el Click Share promedio de ASINs con vs sin palancas activas (Cupones, Deals, Badges).
                </p>
            </div>

            <!-- 4. Eficiencia (Rank vs Share) -->
            <div class="card">
                <h2><span class="material-icons">visibility</span> 4. Eficiencia: Organic Rank vs Click Share</h2>
                <div id="efficiency_chart" class="chart-container"></div>
                <div style="font-size: 12px; color: #666; text-align: center; margin-top: 5px;">
                    Eje X: Ranking Orgánico (Invertido: 1 es mejor) | Eje Y: Click Share %
                </div>
            </div>

            <!-- 5. Insights y Recomendaciones -->
            <div class="card" style="background: linear-gradient(to right, #ffffff, #f0f9ff);">
                <h2><span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div>
                        <h3 style="color: var(--primary);">Insights Clave</h3>
                        <ul class="insights-list">
                            <li>
                                <div class="icon-box"><span class="material-icons">check</span></div>
                                <div><strong>Dominio del Líder:</strong> Nuestro ASIN principal (B06XQ5DCYJ) domina con 14.18% de share gracias al Rank #1 y Amazon Choice.</div>
                            </li>
                            <li>
                                <div class="icon-box"><span class="material-icons">warning</span></div>
                                <div><strong>Amenaza de SuperSelf:</strong> SuperSelf es el competidor más fuerte (17.5% share combinado) usando agresivamente cupones en rank #3 y #7.</div>
                            </li>
                            <li>
                                <div class="icon-box"><span class="material-icons">sell</span></div>
                                <div><strong>Sensibilidad al Precio:</strong> Perfect Ted gana tracción en segmento bajo precio (£2.12) aunque su rank es pobre (#34), indicando alta elasticidad.</div>
                            </li>
                            <li>
                                <div class="icon-box"><span class="material-icons">trending_down</span></div>
                                <div><strong>Ineficiencia Interna:</strong> Nuestros ASINs secundarios (B07B..., B079...) tienen precios altos (>£16) y bajo share (<3.2%) a pesar de tener ranks decentes (Top 10).</div>
                            </li>
                            <li>
                                <div class="icon-box"><span class="material-icons">verified</span></div>
                                <div><strong>Impacto de Badges:</strong> El 'Amazon Choice' multiplica x4 la eficiencia de clicks comparado con ASINs en posiciones similares sin badge.</div>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 style="color: var(--success);">Recomendaciones Accionables</h3>
                        <ul class="insights-list">
                            <li>
                                <div class="icon-box rec-box"><span class="material-icons">ads_click</span></div>
                                <div><strong>Defensa de Posición #1:</strong> Mantener stock y precio del ASIN B06XQ5DCYJ. No tocar nada mientras mantenga >14% share.</div>
                            </li>
                            <li>
                                <div class="icon-box rec-box"><span class="material-icons">local_offer</span></div>
                                <div><strong>Contraataque a SuperSelf:</strong> Activar cupón del 5-10% en el ASIN B07B29VZ6W (Rank #10) para recuperar cuota perdida ante su agresividad.</div>
                            </li>
                            <li>
                                <div class="icon-box rec-box"><span class="material-icons">price_check</span></div>
                                <div><strong>Revisión de Precio Premium:</strong> Evaluar bajar ligeramente el precio de £20.99 (B079VQ52MK) para mejorar conversión, ya que su conversión visual (rank->click) es baja.</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 6. Other Insights -->
             <div class="card">
                <h2><span class="material-icons">search</span> 6. Otros Hallazgos (Oportunidades Ocultas)</h2>
                <p>Se detecta un competidor "Double Dragon" con un precio muy bajo (£6.98) pero buena eficiencia (Rank 11, Share 4.9%). Es una marca a vigilar si comienza a escalar posiciones, ya que ataca el segmento de entrada de precio donde NaturaleBio es más caro.</p>
            </div>

        </div>

        <!-- TAB 2: Comparador Interactivo -->
        <div id="interactive" class="tab-content">
            <div class="card">
                <h2><span class="material-icons">compare</span> Comparador Cara a Cara</h2>
                
                <div class="controls">
                    <div>
                        <label style="display:block; font-size:12px; margin-bottom:4px;">Semana</label>
                        <select id="weekSelector">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; margin-bottom:4px;">Competidor a Comparar</label>
                        <select id="compSelector" onchange="updateComparator()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1; background: #e8f0fe; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary);">
                        <h3 style="margin-top:0;">NaturaleBio (Nosotros)</h3>
                        <div id="us-stats"></div>
                    </div>
                    <div style="flex: 1; background: #fce8e6; padding: 20px; border-radius: 12px; border-left: 4px solid var(--danger);">
                        <h3 style="margin-top:0;" id="comp-name-display">Competidor</h3>
                        <div id="them-stats"></div>
                    </div>
                </div>

                <h3>Comparativa de Precios (Avg)</h3>
                <div id="price_comp_chart" class="chart-container" style="height: 300px;"></div>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        // 1. DATA INJECTION
        // ------------------------------------------------------------------
        const marketData = [
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": null,
    "asin": "B08YRXQ2JH",
    "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...",
    "country_code": "uk",
    "average_organic_rank": 11,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 4.92,
    "impression_share": 3.79,
    "price": 6.98,
    "click_share_rank": 5,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "Double Dragon"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "Heapwell Superfoods",
    "asin": "B06XTYYYJ8",
    "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...",
    "country_code": "uk",
    "average_organic_rank": 6,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 7.28,
    "impression_share": 6.26,
    "price": 9.99,
    "click_share_rank": 4,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "Heapwell Superfoods"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "NaturaleBio",
    "asin": "B07B29VZ6W",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 10,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 2.03,
    "impression_share": 3.01,
    "price": 16.49,
    "click_share_rank": 10,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "NaturaleBio"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "NaturaleBio",
    "asin": "B079VQ52MK",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 7,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 3.19,
    "impression_share": 3.37,
    "price": 20.99,
    "click_share_rank": 8,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "NaturaleBio"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "NaturaleBio",
    "asin": "B06XQ5DCYJ",
    "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...",
    "country_code": "uk",
    "average_organic_rank": 1,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 4,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 14.18,
    "impression_share": 3.44,
    "price": 12.49,
    "click_share_rank": 1,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "Y",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "NaturaleBio"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "Perfect Ted",
    "asin": "B0F21VZMJQ",
    "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...",
    "country_code": "uk",
    "average_organic_rank": 4,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 1,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 7.54,
    "impression_share": 3.41,
    "price": 16.99,
    "click_share_rank": 3,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "Perfect Ted"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "Perfect Ted",
    "asin": "B09DQ1PWGX",
    "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 34,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 4.68,
    "impression_share": 3.65,
    "price": 2.1225,
    "click_share_rank": 6,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "Perfect Ted"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "Perfect Ted",
    "asin": "B0D9M91WZD",
    "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...",
    "country_code": "uk",
    "average_organic_rank": 11,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 0,
    "click_share": 2.37,
    "impression_share": 3.53,
    "price": 11,
    "click_share_rank": 9,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "Perfect Ted"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "SuperSelf",
    "asin": "B08YK2RPBZ",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 3,
    "weekly_number_of_days_with_deal": 0,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 4,
    "click_share": 13.48,
    "impression_share": 3.85,
    "price": 9.9,
    "click_share_rank": 2,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "SuperSelf"
  },
  {
    "brand_aggregation": "naturalebio",
    "parent_asin": "Matcha Premium",
    "reporting_date": "2026-01-03",
    "week_date": "2026-01",
    "keywords": "matcha powder",
    "competitor_brand": "SuperSelf",
    "asin": "B082DKRSB4",
    "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...",
    "country_code": "uk",
    "average_organic_rank": 7,
    "weekly_number_of_days_with_deal": 4,
    "weekly_number_of_days_with_best_seller_badge": 0,
    "weekly_number_of_days_with_amazon_choice_badge": 0,
    "weekly_number_of_days_with_coupon": 4,
    "click_share": 4.06,
    "impression_share": 5.29,
    "price": 14.86,
    "click_share_rank": 7,
    "weekly_search_volume": 24530.02,
    "is_yaba_asin": "N",
    "keywords_link": "https://www.amazon.co.uk/s?k=matcha+powder",
    "final_brand": "SuperSelf"
  }
];

        // 2. INITIALIZATION
        // ------------------------------------------------------------------
        google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
        google.charts.setOnLoadCallback(initDashboard);

        let ourBrand = "NaturaleBio"; // Identified from logic
        const COLORS = {
            us: '#4285F4',
            comp1: '#EA4335',
            comp2: '#FBBC05',
            comp3: '#34A853',
            other: '#9AA0A6'
        };

        function initDashboard() {
            // Identify "Our Brand" dynamically
            const ourBrandRow = marketData.find(d => d.is_yaba_asin === 'Y');
            if (ourBrandRow) ourBrand = ourBrandRow.final_brand;
            
            // Populate Selectors
            populateSelectors();

            // Calculate Metrics
            calcMetrics();

            // Draw Charts
            drawTrendChart();
            drawBrandChart();
            drawLeversChart();
            drawEfficiencyChart();
            
            // Interactive Init
            updateComparator();
        }

        // 3. LOGIC & HELPERS
        // ------------------------------------------------------------------
        function calcMetrics() {
            // Filter latest week
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            const latestWeek = weeks[weeks.length - 1];
            const data = marketData.filter(d => d.week_date === latestWeek);

            const totalVol = data[0].weekly_search_volume; // Assuming same volume for all rows for the keyword
            const totalClicks = data.reduce((sum, d) => sum + (totalVol * d.click_share / 100), 0);
            
            const usData = data.filter(d => d.final_brand === ourBrand);
            const compData = data.filter(d => d.final_brand !== ourBrand);

            const usShare = usData.reduce((sum, d) => sum + d.click_share, 0);
            const compShare = compData.reduce((sum, d) => sum + d.click_share, 0); // Approx rest

            document.getElementById('total-clicks').innerText = Math.round(totalClicks).toLocaleString();
            document.getElementById('our-share').innerText = usShare.toFixed(2) + '%';
            document.getElementById('comp-share').innerText = compShare.toFixed(2) + '%';
        }

        // 4. CHARTS
        // ------------------------------------------------------------------
        
        // SECTION 1: GLOBAL TREND (Us vs Competitors Aggregated)
        function drawTrendChart() {
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            
            const chartData = [['Semana', 'Click Share Nosotros (%)', 'Click Share Competencia (%)']];
            
            weeks.forEach(week => {
                const weeklyData = marketData.filter(d => d.week_date === week);
                const usShare = weeklyData.filter(d => d.final_brand === ourBrand)
                                          .reduce((sum, d) => sum + d.click_share, 0);
                const compShare = weeklyData.filter(d => d.final_brand !== ourBrand)
                                            .reduce((sum, d) => sum + d.click_share, 0);
                chartData.push([week, usShare, compShare]);
            });

            const data = google.visualization.arrayToDataTable(chartData);
            const options = {
                title: 'Evolución de Click Share: Nosotros vs Competencia',
                seriesType: 'bars',
                series: {1: {type: 'line'}},
                colors: [COLORS.us, COLORS.comp1],
                legend: {position: 'bottom'},
                vAxis: {title: 'Click Share %'},
                animation: {startup: true, duration: 1000, easing: 'out'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
            chart.draw(data, options);
        }

        // SECTION 2: BRAND COMPETITIVENESS
        function drawBrandChart() {
            // Find Top 3 Competitors by Avg Share
            const brandShares = {};
            marketData.forEach(d => {
                if(d.final_brand === ourBrand) return;
                if(!brandShares[d.final_brand]) brandShares[d.final_brand] = 0;
                brandShares[d.final_brand] += d.click_share;
            });
            const sortedComps = Object.entries(brandShares).sort((a,b) => b[1] - a[1]).slice(0,3).map(x => x[0]);
            
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            const header = ['Semana', ourBrand, ...sortedComps, 'Otros'];
            const chartData = [header];

            weeks.forEach(week => {
                const weeklyData = marketData.filter(d => d.week_date === week);
                const row = [week];
                
                // Us
                row.push(weeklyData.filter(d => d.final_brand === ourBrand).reduce((s, d) => s + d.click_share, 0));
                
                // Top 3 Comps
                let top3Share = 0;
                sortedComps.forEach(comp => {
                    const s = weeklyData.filter(d => d.final_brand === comp).reduce((sum, d) => sum + d.click_share, 0);
                    row.push(s);
                    top3Share += s;
                });

                // Others
                const totalShare = weeklyData.reduce((s,d) => s + d.click_share, 0); // This sums the provided rows share
                // In a partial dataset, 'Others' might be implied. Here we sum known others.
                const usShare = row[1];
                const others = weeklyData.filter(d => d.final_brand !== ourBrand && !sortedComps.includes(d.final_brand))
                                         .reduce((s, d) => s + d.click_share, 0);
                row.push(others);

                chartData.push(row);
            });

            const data = google.visualization.arrayToDataTable(chartData);
            const options = {
                title: 'Click Share por Marca (Semana a Semana)',
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: [COLORS.us, COLORS.comp1, COLORS.comp2, COLORS.comp3, COLORS.other],
                pointSize: 5,
                vAxis: {title: '% Share'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('brand_chart'));
            chart.draw(data, options);

            // Dynamic Text
            document.getElementById('brand-analysis-text').innerText = 
                `Nuestra marca (${ourBrand}) compite principalmente contra ${sortedComps.join(', ')}. ` +
                `El competidor más fuerte es ${sortedComps[0]}.`;
        }

        // SECTION 3: PALANCAS (Levers)
        function drawLeversChart() {
            // Group by: Deal vs No Deal, Coupon vs No Coupon
            // For Us vs Competitors
            
            let usWithPromo = 0, usWithout = 0, usCountP = 0, usCountNP = 0;
            let compWithPromo = 0, compWithout = 0, compCountP = 0, compCountNP = 0;

            marketData.forEach(d => {
                const hasPromo = d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0 || d.weekly_number_of_days_with_amazon_choice_badge > 0;
                
                if (d.final_brand === ourBrand) {
                    if (hasPromo) { usWithPromo += d.click_share; usCountP++; }
                    else { usWithout += d.click_share; usCountNP++; }
                } else {
                    if (hasPromo) { compWithPromo += d.click_share; compCountP++; }
                    else { compWithout += d.click_share; compCountNP++; }
                }
            });

            const avgUsP = usCountP ? usWithPromo / usCountP : 0;
            const avgUsNP = usCountNP ? usWithout / usCountNP : 0;
            const avgCompP = compCountP ? compWithPromo / compCountP : 0;
            const avgCompNP = compCountNP ? compWithout / compCountNP : 0;

            const data = google.visualization.arrayToDataTable([
                ['Grupo', 'Share Promedio SIN Palancas', 'Share Promedio CON Palancas'],
                ['Nosotros', avgUsNP, avgUsP],
                ['Competencia', avgCompNP, avgCompP]
            ]);

            const options = {
                title: 'Impacto de Promociones/Badges en Click Share Promedio',
                colors: [COLORS.other, COLORS.us],
                vAxis: {title: 'Avg Click Share %'},
                seriesType: 'bars'
            };

            const chart = new google.visualization.ComboChart(document.getElementById('levers_chart'));
            chart.draw(data, options);
        }

        // SECTION 4: EFFICIENCY
        function drawEfficiencyChart() {
            const dataArr = [['Rank Orgánico', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
            
            marketData.forEach(d => {
                const color = d.final_brand === ourBrand ? COLORS.us : COLORS.comp1;
                // Tooltip
                const tooltip = `${d.final_brand}\nASIN: ${d.asin}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
                dataArr.push([d.average_organic_rank, d.click_share, `point { fill-color: ${color}; size: 6; }`, tooltip]);
            });

            const data = google.visualization.arrayToDataTable(dataArr);
            const options = {
                title: 'Mapa de Eficiencia: Ranking vs Share',
                hAxis: {title: 'Posición Orgánica (Menor es mejor)', direction: -1}, // Inverted
                vAxis: {title: 'Click Share %'},
                legend: 'none',
                tooltip: {isHtml: false}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
            chart.draw(data, options);
        }

        // TAB 2: INTERACTIVE
        function populateSelectors() {
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            const wSel = document.getElementById('weekSelector');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                wSel.appendChild(opt);
            });

            const comps = [...new Set(marketData.filter(d => d.final_brand !== ourBrand).map(d => d.final_brand))].sort();
            const cSel = document.getElementById('compSelector');
            comps.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                cSel.appendChild(opt);
            });
        }

        function updateComparator() {
            const week = document.getElementById('weekSelector').value;
            const comp = document.getElementById('compSelector').value;
            document.getElementById('comp-name-display').innerText = comp;

            const weekData = marketData.filter(d => d.week_date === week);
            
            // Aggregates
            const getStats = (brand) => {
                const brandRows = weekData.filter(d => d.final_brand === brand);
                const share = brandRows.reduce((s,d) => s + d.click_share, 0);
                const avgPrice = brandRows.length ? brandRows.reduce((s,d) => s + d.price, 0) / brandRows.length : 0;
                const bestRank = brandRows.length ? Math.min(...brandRows.map(d => d.average_organic_rank)) : '-';
                const deals = brandRows.reduce((s,d) => s + d.weekly_number_of_days_with_deal + d.weekly_number_of_days_with_coupon, 0);
                return { share, avgPrice, bestRank, deals };
            };

            const usStats = getStats(ourBrand);
            const themStats = getStats(comp);

            const renderStats = (id, stats) => {
                document.getElementById(id).innerHTML = `
                    <div style="margin-bottom:8px;"><strong>Click Share:</strong> ${stats.share.toFixed(2)}%</div>
                    <div style="margin-bottom:8px;"><strong>Mejor Rank:</strong> #${stats.bestRank}</div>
                    <div style="margin-bottom:8px;"><strong>Precio Prom:</strong> £${stats.avgPrice.toFixed(2)}</div>
                    <div><strong>Días Promo Totales:</strong> ${stats.deals}</div>
                `;
            };

            renderStats('us-stats', usStats);
            renderStats('them-stats', themStats);

            // Mini Price Chart
            const data = google.visualization.arrayToDataTable([
                ['Marca', 'Precio Promedio', { role: 'style' }],
                ['Nosotros', usStats.avgPrice, COLORS.us],
                [comp, themStats.avgPrice, COLORS.comp1]
            ]);

            const chart = new google.visualization.ColumnChart(document.getElementById('price_comp_chart'));
            chart.draw(data, { 
                legend: 'none', 
                vAxis: {title: 'Precio (£)'},
                animation: {startup: true, duration: 500}
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            
            // Redraw charts to fix width issues if hidden
            if(tabId === 'static') {
                drawTrendChart();
                drawBrandChart();
                drawLeversChart();
                drawEfficiencyChart();
            } else {
                updateComparator();
            }
        }

        window.addEventListener('resize', () => {
            if(document.getElementById('static').classList.contains('active')) {
                drawTrendChart();
                drawBrandChart();
                drawLeversChart();
                drawEfficiencyChart();
            } else {
                updateComparator();
            }
        });

    </script>
</body>
</html>