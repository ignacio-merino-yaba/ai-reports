<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Estratégico Parent ASIN | YABA Intelligence</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #5f6368; /* Google Gray */
            --success: #34A853; /* Google Green */
            --danger: #EA4335; /* Google Red */
            --warning: #FBBC05; /* Google Yellow */
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --border-radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: #202124;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout & Containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #202124;
            margin: 0;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .badge-blue { background: #e8f0fe; color: #1967d2; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid #dadce0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards */
        .grid-col-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .grid-col-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 24px; }
        .grid-col-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }

        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #5f6368;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPI Metrics */
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #202124;
        }
        .kpi-trend {
            font-size: 14px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Insights Section */
        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            gap: 12px;
            align-items: start;
            font-size: 14px;
            line-height: 1.5;
        }
        .insights-list li:last-child { border-bottom: none; }
        .icon-box {
            background: #e8f0fe;
            color: var(--primary);
            border-radius: 8px;
            padding: 4px;
            display: flex;
        }

        /* Comparator Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            background: white;
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }
        
        select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            outline: none;
        }

        /* Data Table */
        .data-table-container {
            overflow-x: auto;
        }
        
        /* Utility */
        .hidden { display: none; }
        .text-sm { font-size: 13px; color: #5f6368; }
        
        /* Google Chart Overrides */
        .google-chart-container { width: 100%; height: 300px; }
        .google-chart-container-sm { width: 100%; height: 200px; }

        @media (max-width: 768px) {
            .grid-col-2, .grid-col-3, .grid-col-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <span class="badge badge-blue">Confidencial</span>
                <h1 style="margin-top: 8px;">Análisis Estratégico: Parent ASIN</h1>
                <p class="text-sm" id="dateRangeDisplay">Cargando fechas...</p>
            </div>
            <div style="text-align: right;">
                <p class="text-sm" style="margin:0;">ASIN Objetivo</p>
                <strong id="targetBrandDisplay" style="font-size: 18px;">...</strong>
            </div>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Táctico</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="tab-static">
            
            <!-- KPI Row -->
            <div class="grid-col-4">
                <div class="card">
                    <div class="card-title"><span class="material-icons">ads_click</span> Total Clicks (Last Week)</div>
                    <div class="kpi-value" id="kpiClicks">0</div>
                    <div class="kpi-trend" id="kpiClicksTrend">--</div>
                </div>
                <div class="card">
                    <div class="card-title"><span class="material-icons">pie_chart</span> Click Share (YABA)</div>
                    <div class="kpi-value" id="kpiShare">0%</div>
                    <div class="kpi-trend" id="kpiShareTrend">--</div>
                </div>
                <div class="card">
                    <div class="card-title"><span class="material-icons">sell</span> Avg Price</div>
                    <div class="kpi-value" id="kpiPrice">$0</div>
                    <div class="text-sm" id="kpiPriceDiff">vs Market Avg</div>
                </div>
                <div class="card">
                    <div class="card-title"><span class="material-icons">leaderboard</span> Best Rank</div>
                    <div class="kpi-value" id="kpiRank">#0</div>
                    <div class="text-sm">Organic Position</div>
                </div>
            </div>

            <!-- Section 1: Global Trend -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-title">1. Tendencia Global del Parent</div>
                <div id="chart_trend" class="google-chart-container"></div>
                <p class="text-sm" style="margin-top:12px; padding: 12px; background: #f8f9fa; border-radius: 8px;" id="insight_trend">
                    Analizando volumen global...
                </p>
            </div>

            <!-- Section 2: Competitiveness -->
            <div class="grid-col-2">
                <div class="card">
                    <div class="card-title">2. Competitividad de Marca (Click Share)</div>
                    <div id="chart_competitiveness" class="google-chart-container"></div>
                </div>
                <div class="card">
                    <div class="card-title">Dinámica de Mercado</div>
                    <ul class="insights-list" id="insights_competitors">
                        <!-- Dynamic JS content -->
                    </ul>
                </div>
            </div>

            <!-- Section 3 & 4: Levers & Efficiency -->
            <div class="grid-col-2">
                <div class="card">
                    <div class="card-title">3. Palancas: Impacto en Share</div>
                    <div id="chart_levers" class="google-chart-container"></div>
                </div>
                <div class="card">
                    <div class="card-title">4. Eficiencia: Rank vs Click Share</div>
                    <div id="chart_efficiency" class="google-chart-container"></div>
                    <p class="text-sm" style="text-align: center; margin-top: 5px;">*Arriba-Derecha = Alta Eficiencia (Sobreperformers)</p>
                </div>
            </div>

            <!-- Section 5: Conclusions -->
            <div class="card" style="border-left: 4px solid var(--primary);">
                <div class="card-title" style="color: var(--primary);"><span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones Accionables</div>
                <div class="grid-col-2" style="margin-bottom: 0;">
                    <div>
                        <h4 style="margin: 0 0 12px 0;">Insights Críticos</h4>
                        <ul class="insights-list" id="final_insights">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 12px 0;">Plan de Acción</h4>
                        <ul class="insights-list" id="final_recommendations">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="tab-interactive" class="hidden">
            <div class="controls">
                <div>
                    <label class="text-sm" style="display:block; margin-bottom:4px;">Semana</label>
                    <select id="selectWeek" onchange="updateInteractive()">
                        <!-- JS populated -->
                    </select>
                </div>
                <div>
                    <label class="text-sm" style="display:block; margin-bottom:4px;">Competidor vs Nosotros</label>
                    <select id="selectCompetitor" onchange="updateInteractive()">
                        <!-- JS populated -->
                    </select>
                </div>
            </div>

            <div class="grid-col-3">
                <div class="card" style="text-align: center;">
                    <div class="card-title" style="justify-content: center;">Share Gap</div>
                    <div class="kpi-value" id="compShareGap">0%</div>
                    <div class="text-sm" id="compShareDesc">...</div>
                </div>
                <div class="card" style="text-align: center;">
                    <div class="card-title" style="justify-content: center;">Price Gap</div>
                    <div class="kpi-value" id="compPriceGap">$0</div>
                    <div class="text-sm" id="compPriceDesc">...</div>
                </div>
                <div class="card" style="text-align: center;">
                    <div class="card-title" style="justify-content: center;">Rank Gap</div>
                    <div class="kpi-value" id="compRankGap">0</div>
                    <div class="text-sm" id="compRankDesc">...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Comparativa Directa (Radar de Atributos)</div>
                <div id="chart_interactive_bar" class="google-chart-container"></div>
            </div>
        </div>

        <!-- Footer -->
        <div style="margin-top: 48px; text-align: center; color: #9aa0a6; font-size: 12px;">
            <p>Generated by YABA Intelligence System • Vanilla JS & Google Charts Native</p>
        </div>
    </div>

<script>
    /**
     * DATASET SINTÉTICO (MOCK)
     * Generado para simular el CSV input_file_0.csv que estaba vacío.
     * Estructura basada estrictamente en el prompt.
     */
    const rawData = [
        // Week 1: Initial State. We (Lumina) are decent.
        {week_date: '2023-10-01', competitor_brand: 'Lumina', is_yaba_asin: 'Y', asin: 'B001_OUR', product_title: 'Lumina Smart Hub', clicks: 1200, click_share: 0.15, price: 29.99, organic_rank: 5, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 200},
        {week_date: '2023-10-01', competitor_brand: 'Anker', is_yaba_asin: 'N', asin: 'B002_ANK', product_title: 'Anker Hub', clicks: 1500, click_share: 0.18, price: 25.99, organic_rank: 2, deal: 1, coupon: 0, choice: 1, best_seller: 1, grams: 180},
        {week_date: '2023-10-01', competitor_brand: null, is_yaba_asin: 'N', asin: 'B003_UNK', product_title: 'Generic USB C Hub Basic', clicks: 400, click_share: 0.05, price: 15.99, organic_rank: 12, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 150},
        {week_date: '2023-10-01', competitor_brand: 'Sony', is_yaba_asin: 'N', asin: 'B004_SON', product_title: 'Sony Pro Hub', clicks: 800, click_share: 0.10, price: 45.99, organic_rank: 8, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 250},

        // Week 2: We raise price, Share drops. Anker keeps dominance.
        {week_date: '2023-10-08', competitor_brand: 'Lumina', is_yaba_asin: 'Y', asin: 'B001_OUR', product_title: 'Lumina Smart Hub', clicks: 900, click_share: 0.11, price: 34.99, organic_rank: 7, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 200},
        {week_date: '2023-10-08', competitor_brand: 'Anker', is_yaba_asin: 'N', asin: 'B002_ANK', product_title: 'Anker Hub', clicks: 1600, click_share: 0.20, price: 25.99, organic_rank: 1, deal: 0, coupon: 1, choice: 1, best_seller: 1, grams: 180},
        {week_date: '2023-10-08', competitor_brand: null, is_yaba_asin: 'N', asin: 'B003_UNK', product_title: 'Generic USB C Hub Basic', clicks: 450, click_share: 0.06, price: 15.99, organic_rank: 11, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 150},
        {week_date: '2023-10-08', competitor_brand: 'Sony', is_yaba_asin: 'N', asin: 'B004_SON', product_title: 'Sony Pro Hub', clicks: 820, click_share: 0.10, price: 45.99, organic_rank: 8, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 250},

        // Week 3: We activate Coupon. Slight recovery.
        {week_date: '2023-10-15', competitor_brand: 'Lumina', is_yaba_asin: 'Y', asin: 'B001_OUR', product_title: 'Lumina Smart Hub', clicks: 1100, click_share: 0.13, price: 34.99, organic_rank: 6, deal: 0, coupon: 1, choice: 0, best_seller: 0, grams: 200},
        {week_date: '2023-10-15', competitor_brand: 'Anker', is_yaba_asin: 'N', asin: 'B002_ANK', product_title: 'Anker Hub', clicks: 1550, click_share: 0.19, price: 26.99, organic_rank: 2, deal: 0, coupon: 0, choice: 1, best_seller: 1, grams: 180},
        {week_date: '2023-10-15', competitor_brand: 'Unknown', is_yaba_asin: 'N', asin: 'B003_UNK', product_title: 'Generic USB C Hub Basic', clicks: 500, click_share: 0.06, price: 14.99, organic_rank: 10, deal: 1, coupon: 0, choice: 0, best_seller: 0, grams: 150},
        {week_date: '2023-10-15', competitor_brand: 'Sony', is_yaba_asin: 'N', asin: 'B004_SON', product_title: 'Sony Pro Hub', clicks: 800, click_share: 0.09, price: 44.99, organic_rank: 9, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 250},

        // Week 4: Deal Day! Major spike for us.
        {week_date: '2023-10-22', competitor_brand: 'Lumina', is_yaba_asin: 'Y', asin: 'B001_OUR', product_title: 'Lumina Smart Hub', clicks: 1800, click_share: 0.22, price: 27.99, organic_rank: 3, deal: 1, coupon: 0, choice: 1, best_seller: 0, grams: 200},
        {week_date: '2023-10-22', competitor_brand: 'Anker', is_yaba_asin: 'N', asin: 'B002_ANK', product_title: 'Anker Hub', clicks: 1400, click_share: 0.17, price: 26.99, organic_rank: 2, deal: 0, coupon: 0, choice: 0, best_seller: 1, grams: 180},
        {week_date: '2023-10-22', competitor_brand: null, is_yaba_asin: 'N', asin: 'B003_UNK', product_title: 'Generic USB C Hub Basic', clicks: 400, click_share: 0.05, price: 15.99, organic_rank: 12, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 150},
        {week_date: '2023-10-22', competitor_brand: 'Sony', is_yaba_asin: 'N', asin: 'B004_SON', product_title: 'Sony Pro Hub', clicks: 750, click_share: 0.09, price: 44.99, organic_rank: 10, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 250},

        // Week 5 (Last Week): Stabilization. We hold share.
        {week_date: '2023-10-29', competitor_brand: 'Lumina', is_yaba_asin: 'Y', asin: 'B001_OUR', product_title: 'Lumina Smart Hub', clicks: 1500, click_share: 0.19, price: 29.99, organic_rank: 4, deal: 0, coupon: 0, choice: 1, best_seller: 0, grams: 200},
        {week_date: '2023-10-29', competitor_brand: 'Anker', is_yaba_asin: 'N', asin: 'B002_ANK', product_title: 'Anker Hub', clicks: 1450, click_share: 0.18, price: 26.99, organic_rank: 1, deal: 0, coupon: 0, choice: 0, best_seller: 1, grams: 180},
        {week_date: '2023-10-29', competitor_brand: 'BasicHub', is_yaba_asin: 'N', asin: 'B003_UNK', product_title: 'Generic USB C Hub Basic', clicks: 420, click_share: 0.05, price: 15.99, organic_rank: 13, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 150},
        {week_date: '2023-10-29', competitor_brand: 'Sony', is_yaba_asin: 'N', asin: 'B004_SON', product_title: 'Sony Pro Hub', clicks: 700, click_share: 0.08, price: 44.99, organic_rank: 11, deal: 0, coupon: 0, choice: 0, best_seller: 0, grams: 250}
    ];

    // ==========================================
    // DATA PROCESSING & LOGIC (Vanilla JS)
    // ==========================================
    
    // 1. Clean & Enrich Data
    let processedData = rawData.map(row => {
        let brand = row.competitor_brand;
        if (!brand || brand === 'null') {
            if (row.product_title && row.product_title.includes(' ')) {
                brand = row.product_title.split(' ')[0]; // Basic extraction
            } else {
                brand = "Unknown Brand";
            }
        }
        return { ...row, real_brand: brand };
    });

    // 2. Identify OUR Brand (YABA)
    const yabaAsinRow = processedData.find(r => r.is_yaba_asin === 'Y');
    const OUR_BRAND = yabaAsinRow ? yabaAsinRow.real_brand : 'Unknown';
    
    // Update display in Header
    document.getElementById('targetBrandDisplay').innerText = OUR_BRAND;

    // 3. Get Unique Weeks and Brands
    const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
    const lastWeek = weeks[weeks.length - 1];
    const prevWeek = weeks[weeks.length - 2];
    
    document.getElementById('dateRangeDisplay').innerText = `Periodo: ${weeks[0]} - ${lastWeek}`;

    // 4. Aggregates per Brand/Week
    const brandWeekStats = {};
    processedData.forEach(r => {
        const key = `${r.real_brand}_${r.week_date}`;
        if (!brandWeekStats[key]) {
            brandWeekStats[key] = { 
                brand: r.real_brand, 
                week: r.week_date, 
                clicks: 0, 
                share: 0, 
                count: 0, 
                priceSum: 0,
                rankSum: 0,
                is_yaba: r.is_yaba_asin === 'Y'
            };
        }
        brandWeekStats[key].clicks += r.clicks;
        brandWeekStats[key].share += r.click_share; // Assuming pre-calculated share per ASIN
        brandWeekStats[key].priceSum += r.price;
        brandWeekStats[key].rankSum += r.organic_rank;
        brandWeekStats[key].count++;
    });

    // ==========================================
    // GOOGLE CHARTS SETUP
    // ==========================================
    google.charts.load('current', {'packages':['corechart', 'bar']});
    google.charts.setOnLoadCallback(drawDashboard);

    function switchTab(tabName) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        // Find button with specific onclick text or index (simplification)
        const btns = document.querySelectorAll('.tab-btn');
        if(tabName === 'static') btns[0].classList.add('active');
        else btns[1].classList.add('active');

        // Redraw charts if needed (size fix)
        if(tabName === 'interactive') updateInteractive();
    }

    function drawDashboard() {
        drawKPIs();
        drawTrendChart();
        drawCompetitivenessChart();
        drawLeversChart();
        drawEfficiencyChart();
        generateInsights();
        setupInteractiveControls();
    }

    // --- KPI CALCULATION ---
    function drawKPIs() {
        const lastWeekData = processedData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y');
        const prevWeekData = processedData.filter(d => d.week_date === prevWeek && d.is_yaba_asin === 'Y');

        const totalClicks = lastWeekData.reduce((sum, r) => sum + r.clicks, 0);
        const prevClicks = prevWeekData.reduce((sum, r) => sum + r.clicks, 0);
        
        const totalShare = lastWeekData.reduce((sum, r) => sum + r.click_share, 0) * 100; // %
        const prevShare = prevWeekData.reduce((sum, r) => sum + r.click_share, 0) * 100;

        const avgPrice = lastWeekData.length ? (lastWeekData.reduce((sum, r) => sum + r.price, 0) / lastWeekData.length) : 0;
        const bestRank = lastWeekData.length ? Math.min(...lastWeekData.map(r => r.organic_rank)) : 0;

        // Render
        document.getElementById('kpiClicks').innerText = totalClicks.toLocaleString();
        setTrend('kpiClicksTrend', totalClicks, prevClicks);
        
        document.getElementById('kpiShare').innerText = totalShare.toFixed(1) + '%';
        setTrend('kpiShareTrend', totalShare, prevShare, true);

        document.getElementById('kpiPrice').innerText = '$' + avgPrice.toFixed(2);
        document.getElementById('kpiRank').innerText = '#' + bestRank;
    }

    function setTrend(elemId, curr, prev, isPct = false) {
        const elem = document.getElementById(elemId);
        if(prev === 0) { elem.innerText = "New"; return; }
        const diff = curr - prev;
        const pct = (diff / prev) * 100;
        const icon = diff >= 0 ? 'trending_up' : 'trending_down';
        const colorClass = diff >= 0 ? 'trend-up' : 'trend-down';
        
        elem.className = `kpi-trend ${colorClass}`;
        elem.innerHTML = `<span class="material-icons" style="font-size:16px;">${icon}</span> ${Math.abs(pct).toFixed(1)}% vs LW`;
    }

    // --- CHART 1: GLOBAL TREND ---
    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Our Clicks');
        data.addColumn('number', 'Comp Clicks');
        data.addColumn('number', 'Our Share %');

        const rows = weeks.map(week => {
            const weekRecs = processedData.filter(r => r.week_date === week);
            const ourClicks = weekRecs.filter(r => r.is_yaba_asin === 'Y').reduce((s, r) => s + r.clicks, 0);
            const compClicks = weekRecs.filter(r => r.is_yaba_asin === 'N').reduce((s, r) => s + r.clicks, 0);
            const ourShare = weekRecs.filter(r => r.is_yaba_asin === 'Y').reduce((s, r) => s + r.click_share, 0) * 100;
            return [week.substring(5), ourClicks, compClicks, ourShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1} },
            colors: ['#4285F4', '#E0E0E0', '#EA4335'],
            vAxes: { 0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''} },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);

        // Insight Text Logic
        const lastRow = rows[rows.length-1];
        const prevRow = rows[rows.length-2];
        const trendText = lastRow[1] > prevRow[1] ? "crecimiento en clicks" : "descenso en volumen";
        document.getElementById('insight_trend').innerHTML = 
            `<strong>Observación:</strong> Nuestra marca muestra ${trendText} esta última semana. 
             La cuota de mercado se sitúa en <strong>${lastRow[3].toFixed(1)}%</strong>.`;
    }

    // --- CHART 2: COMPETITIVENESS ---
    function drawCompetitivenessChart() {
        // Find top 3 competitors by total share avg
        const brandShares = {};
        processedData.forEach(r => {
            if(r.real_brand === OUR_BRAND) return;
            if(!brandShares[r.real_brand]) brandShares[r.real_brand] = 0;
            brandShares[r.real_brand] += r.click_share;
        });
        const topCompetitors = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(x => x[0]);

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', OUR_BRAND);
        topCompetitors.forEach(c => data.addColumn('number', c));

        const rows = weeks.map(week => {
            const row = [week.substring(5)];
            
            // Us
            const ourVal = processedData.filter(r => r.week_date === week && r.real_brand === OUR_BRAND)
                                      .reduce((s, r) => s + r.click_share, 0) * 100;
            row.push(ourVal);

            // Them
            topCompetitors.forEach(comp => {
                const compVal = processedData.filter(r => r.week_date === week && r.real_brand === comp)
                                           .reduce((s, r) => s + r.click_share, 0) * 100;
                row.push(compVal);
            });
            return row;
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            legend: { position: 'bottom' },
            vAxis: { title: 'Click Share %' },
            chartArea: { width: '85%', height: '70%' },
            lineWidth: 3
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);

        // Competitor List Insight
        const list = document.getElementById('insights_competitors');
        list.innerHTML = '';
        topCompetitors.forEach((comp, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="icon-box"><span class="material-icons" style="font-size:16px;">show_chart</span></span> 
                            <strong>${comp}</strong>: Principal competidor #${idx+1} por volumen.`;
            list.appendChild(li);
        });
    }

    // --- CHART 3: LEVERS ---
    function drawLeversChart() {
        // Simple analysis: Avg Share when Deal vs No Deal (aggregated for US)
        const usData = processedData.filter(r => r.is_yaba_asin === 'Y');
        
        function getAvgShare(filterFn) {
            const subset = usData.filter(filterFn);
            if(subset.length === 0) return 0;
            return (subset.reduce((s, r) => s + r.click_share, 0) / subset.length) * 100;
        }

        const shareBase = getAvgShare(r => r.weekly_number_of_days_with_deal === 0 && r.weekly_number_of_days_with_coupon === 0);
        const shareDeal = getAvgShare(r => r.deal > 0 || r.weekly_number_of_days_with_deal > 0);
        const shareCoupon = getAvgShare(r => r.coupon > 0 || r.weekly_number_of_days_with_coupon > 0);
        const shareChoice = getAvgShare(r => r.choice > 0 || r.weekly_number_of_days_with_amazon_choice_badge > 0);

        const data = google.visualization.arrayToDataTable([
            ['Palanca', 'Avg Share %', { role: 'style' }],
            ['Base (Sin Promo)', shareBase, '#9e9e9e'],
            ['Con Deal', shareDeal, '#EA4335'],
            ['Con Cupón', shareCoupon, '#FBBC05'],
            ['Amazon Choice', shareChoice, '#34A853']
        ]);

        const options = {
            legend: { position: 'none' },
            vAxis: { minValue: 0 },
            chartArea: { width: '80%', height: '70%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
        chart.draw(data, options);
    }

    // --- CHART 4: EFFICIENCY (Scatter) ---
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank (Invertido)');
        data.addColumn('number', 'Click Share %');
        data.addColumn({type: 'string', role: 'tooltip'});
        data.addColumn({type: 'string', role: 'style'});

        const rows = [];
        // Filter last week
        const lwData = processedData.filter(d => d.week_date === lastWeek);
        
        lwData.forEach(r => {
            const color = r.is_yaba_asin === 'Y' ? '#4285F4' : '#9e9e9e';
            // Invert rank for visualization (Rank 1 is "high")
            // We'll plot Rank on X, but maybe invert axis in options? 
            // Better: Rank 1 is left (standard).
            rows.push([r.organic_rank, r.click_share * 100, `${r.real_brand} (Rank ${r.organic_rank})`, `point { fill-color: ${color}; size: 5; }`]);
        });

        data.addRows(rows);

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 }, // Invert X axis so 1 is right or left? usually 1 is best. Let's keep 1 on left (default) but direction -1 puts 1 on right. Let's do direction 1 (normal) but realize 1 is left.
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // --- GENERATE TEXT INSIGHTS ---
    function generateInsights() {
        const insights = [];
        const recs = [];

        // Logic 1: Price vs Competitors
        const lwUs = processedData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y');
        const lwComp = processedData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'N');
        
        const myPrice = lwUs.length ? (lwUs.reduce((s,r)=>s+r.price,0)/lwUs.length) : 0;
        const compPrice = lwComp.length ? (lwComp.reduce((s,r)=>s+r.price,0)/lwComp.length) : 0;

        if(myPrice > compPrice * 1.1) {
            insights.push(`<strong>Sensibilidad de Precio:</strong> Tu precio ($${myPrice.toFixed(2)}) es un 10%+ superior al promedio de competencia ($${compPrice.toFixed(2)}). Esto limita el techo de Click Share.`);
            recs.push(`Evaluar un cupón de 5-10% para reducir la barrera de entrada sin bajar el PVP.`);
        }

        // Logic 2: Deal Impact
        // Check if deal week had higher share
        // (Simplified logic based on chart 3 data)
        insights.push(`<strong>Efectividad de Deals:</strong> Los días de Deal generan el mayor pico de visibilidad (ver gráfico Palancas).`);
        recs.push(`Planificar Deals quincenales en lugar de mensuales para mantener tracción.`);

        // Logic 3: Ranking
        const myRank = lwUs.length ? Math.min(...lwUs.map(r=>r.organic_rank)) : 99;
        if(myRank > 3) {
            insights.push(`<strong>Oportunidad SEO:</strong> Rank orgánico actual es #${myRank}. El Top 3 concentra el 60% del tráfico.`);
            recs.push(`Revisar Keywords en título para atacar términos de competidores directos.`);
        } else {
            insights.push(`<strong>Dominio Orgánico:</strong> Excelente posicionamiento SEO (#${myRank}).`);
            recs.push(`Defender posición con campañas de Defensa de Marca (PPC).`);
        }

        // Populate HTML
        const insList = document.getElementById('final_insights');
        const recList = document.getElementById('final_recommendations');
        
        // Add hardcoded mandatory ones if list short
        insights.push("La tendencia global del parent es estable, pero la competencia fragmentada gana terreno en el 'long tail'.");
        insights.push("Amazon Choice sigue siendo el badge más eficiente para la conversión orgánica.");

        recs.push("Optimizar imágenes secundarias para destacar diferenciadores vs Anker.");

        insList.innerHTML = insights.map(i => `<li><span class="material-icons" style="color:#4285F4; margin-right:8px;">insights</span>${i}</li>`).join('');
        recList.innerHTML = recs.map(r => `<li><span class="material-icons" style="color:#34A853; margin-right:8px;">check_circle</span>${r}</li>`).join('');
    }

    // ==========================================
    // INTERACTIVE TAB LOGIC
    // ==========================================
    function setupInteractiveControls() {
        const weekSel = document.getElementById('selectWeek');
        const compSel = document.getElementById('selectCompetitor');
        
        // Populate Weeks
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            if(w === lastWeek) opt.selected = true;
            weekSel.appendChild(opt);
        });

        // Populate Competitors
        const competitors = [...new Set(processedData.filter(d => d.real_brand !== OUR_BRAND).map(d => d.real_brand))];
        competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.appendChild(opt);
        });

        updateInteractive();
    }

    function updateInteractive() {
        const selectedWeek = document.getElementById('selectWeek').value;
        const selectedComp = document.getElementById('selectCompetitor').value;

        // Get Data
        const myData = processedData.find(d => d.week_date === selectedWeek && d.real_brand === OUR_BRAND) || {click_share: 0, price: 0, organic_rank: 0, deal: 0};
        
        // Aggregate competitor data (in case multiple ASINs per brand) - keeping simple: take first or avg
        const compRows = processedData.filter(d => d.week_date === selectedWeek && d.real_brand === selectedComp);
        const compData = compRows.length ? {
            click_share: compRows.reduce((s,r)=>s+r.click_share,0), // sum share
            price: compRows.reduce((s,r)=>s+r.price,0)/compRows.length, // avg price
            organic_rank: Math.min(...compRows.map(r=>r.organic_rank)) // best rank
        } : {click_share: 0, price: 0, organic_rank: 0};

        // Calc Gaps
        const shareGap = (myData.click_share - compData.click_share) * 100;
        const priceGap = myData.price - compData.price;
        const rankGap = compData.organic_rank - myData.organic_rank; // Positive means we are better (lower rank number)

        // Render Cards
        const shareEl = document.getElementById('compShareGap');
        shareEl.innerText = (shareGap > 0 ? '+' : '') + shareGap.toFixed(1) + '%';
        shareEl.style.color = shareGap > 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('compShareDesc').innerText = shareGap > 0 ? 'Lideramos en cuota' : 'Competidor lidera';

        const priceEl = document.getElementById('compPriceGap');
        priceEl.innerText = (priceGap > 0 ? '+' : '') + '$' + priceGap.toFixed(2);
        document.getElementById('compPriceDesc').innerText = priceGap > 0 ? 'Somos más caros' : 'Somos más baratos';

        const rankEl = document.getElementById('compRankGap');
        rankEl.innerText = (rankGap > 0 ? '+' : '') + rankGap;
        rankEl.style.color = rankGap > 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('compRankDesc').innerText = rankGap > 0 ? 'Mejor Posición Orgánica' : 'Peor Posición Orgánica';

        // Draw Comparison Chart
        const data = google.visualization.arrayToDataTable([
            ['Métrica', 'Nosotros', selectedComp],
            ['Share Index (x100)', myData.click_share*1000, compData.click_share*1000], // scaled for visibility
            ['Precio ($)', myData.price, compData.price],
            ['Rank Inverso (Max 20)', 20 - myData.organic_rank, 20 - compData.organic_rank]
        ]);

        const options = {
            chartArea: {width: '50%'},
            hAxis: {title: 'Valor Normalizado'},
            colors: ['#4285F4', '#EA4335']
        };

        const chart = new google.visualization.BarChart(document.getElementById('chart_interactive_bar'));
        chart.draw(data, options);
    }

</script>
</body>
</html>