<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Native Ecosystem Dependencies -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-secondary: #5F6368;
            --border-color: #DADCE0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }

        /* Layout & Structure */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 400;
            color: var(--text-main);
            margin: 0;
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards & Sections */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            color: var(--text-main);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: #f1f3f4;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .kpi-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Insights List */
        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
        }

        .insights-list li::before {
            content: '‚Ä¢';
            color: var(--primary-color);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .recommendation-card {
            background-color: #e8f0fe;
            border-left: 4px solid var(--primary-color);
            padding: 12px;
            margin-bottom: 10px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: white;
            font-family: inherit;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }
        
        /* Table Styles */
        .google-visualization-table-table {
            font-family: 'Roboto', sans-serif !important;
        }

        .highlight-positive { color: var(--success-color); font-weight: bold; }
        .highlight-negative { color: var(--danger-color); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>An√°lisis de Rendimiento Parent ASIN</h1>
            <div class="subtitle">An√°lisis Competitivo Semanal ‚Ä¢ Marca: <strong id="brand-name-display">NaturaleBio</strong></div>
        </div>
        <div>
            <span class="material-icons" style="font-size: 36px; color: var(--text-secondary);">analytics</span>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Comparador Interactivo</button>
    </div>

    <!-- PESTA√ëA 1: REPORTE EST√ÅTICO -->
    <div id="tab-static" class="tab-content active">
        
        <!-- Secci√≥n 1: KPI & Tendencia -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span> 1. Tendencia Global del Parent (√öltimas Semanas)
            </div>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-total-clicks">-</div>
                    <div class="kpi-label">Total Clicks (Est.) √öltima Semana</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-share-us">-</div>
                    <div class="kpi-label">Click Share (Nuestra Marca)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-share-comp">-</div>
                    <div class="kpi-label">Click Share (Competidores)</div>
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div style="margin-top: 10px; font-size: 13px; color: #555;">
                <strong>An√°lisis:</strong> El gr√°fico muestra la evoluci√≥n del volumen de clicks (barras) y la cuota de clicks (l√≠neas). Observe si la l√≠nea azul (Nosotros) se mantiene por encima o cruza la roja (Competencia).
            </div>
        </div>

        <!-- Secci√≥n 2: Competitividad -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">people</span> 2. Competitividad de Marca (Share of Voice)
            </div>
            <div id="chart_competitiveness" class="chart-container"></div>
            <p style="font-size: 13px; color: #555;">Comparativa de cuota de mercado semanal entre nuestra marca y los Top 3 competidores.</p>
        </div>

        <!-- Secci√≥n 3: Palancas (Levers) -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">tune</span> 3. üöÄ Palancas de Click Share
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                <div style="flex: 1; min-width: 300px;">
                    <div id="chart_price_correlation" style="height: 300px;"></div>
                </div>
                <div style="flex: 1; min-width: 300px;">
                    <h4>Impacto Promocional (√öltima Semana)</h4>
                    <ul class="insights-list" id="levers-text-analysis">
                        <!-- Filled by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 4: Eficiencia -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">speed</span> 4. Eficiencia: Organic Rank vs Click Share
            </div>
            <div id="chart_efficiency" class="chart-container"></div>
            <p style="font-size: 13px; color: #555; text-align: center;">
                <strong>Interpretaci√≥n:</strong> Burbujas arriba a la izquierda = Alta Eficiencia (Buen Share con poco Rank). 
                Burbujas abajo a la derecha = Baja Eficiencia.
            </p>
        </div>

        <!-- Secci√≥n 5: Insights & Recomendaciones -->
        <div class="card" style="border-left: 5px solid var(--primary-color);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span> 5. Conclusiones y Recomendaciones
            </div>
            
            <h3 style="font-size: 16px; margin-top: 0;">Insights Clave</h3>
            <ul class="insights-list" id="final-insights">
                <!-- Injected via JS -->
            </ul>

            <h3 style="font-size: 16px; margin-top: 20px;">Recomendaciones Accionables</h3>
            <div id="final-recommendations">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- PESTA√ëA 2: INTERACTIVO -->
    <div id="tab-interactive" class="tab-content">
        <div class="card">
            <div class="card-title">Comparador Cara a Cara</div>
            <div class="controls">
                <div>
                    <label>Semana:</label>
                    <select id="select-week" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label>Competidor VS:</label>
                    <select id="select-competitor" onchange="updateInteractive()"></select>
                </div>
            </div>

            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div id="chart_interactive_bar" style="height: 400px;"></div>
                </div>
                <div style="flex: 1; min-width: 300px;">
                    <h4>Detalle M√©tricas</h4>
                    <div id="table_interactive"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- DATA INJECTION -->
<script>
    // Injected Data from Python Processing
    const marketData = [{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B08XVX8V1T","brand":"bioKontor","is_yaba_asin":"N","estimated_clicks":857.355576,"click_share":3.08,"price":11.9975,"rank":9.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","weekly_search_volume":27836.22},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B08XVX8V1T","brand":"Unknown Brand","is_yaba_asin":"N","estimated_clicks":857.355576,"click_share":3.08,"price":11.9975,"rank":9.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","weekly_search_volume":27836.22},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B0CNRX8G5S","brand":"NORITUAL LAB","is_yaba_asin":"N","estimated_clicks":3899.854422,"click_share":14.01,"price":23.91,"rank":2.0,"days_deal":0.0,"days_bs":0.0,"days_ac":4.0,"days_coupon":0.0,"product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","weekly_search_volume":27836.22},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B0CNRX8G5S","brand":"NORITUAL LAB","is_yaba_asin":"N","estimated_clicks":5102.57293,"click_share":14.83,"price":24.602857143,"rank":2.0,"days_deal":0.0,"days_bs":0.0,"days_ac":7.0,"days_coupon":0.0,"product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","weekly_search_volume":34407.1},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B0G1T7N675","brand":"Ceremonial","is_yaba_asin":"N","estimated_clicks":818.88898,"click_share":2.38,"price":12.447142857,"rank":12.0,"days_deal":3.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...","weekly_search_volume":34407.1},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B0FSL3C3Z8","brand":"Ceremonial","is_yaba_asin":"N","estimated_clicks":2043.78174,"click_share":5.94,"price":16.008571429,"rank":7.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","weekly_search_volume":34407.1},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B0FSL3C3Z8","brand":"NORITUAL LAB","is_yaba_asin":"N","estimated_clicks":2043.78174,"click_share":5.94,"price":16.008571429,"rank":7.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","weekly_search_volume":34407.1},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B0FSL3C3Z8","brand":"Ceremonial","is_yaba_asin":"N","estimated_clicks":1672.956822,"click_share":6.01,"price":15.5575,"rank":7.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","weekly_search_volume":27836.22},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B0FSL3C3Z8","brand":"NORITUAL LAB","is_yaba_asin":"N","estimated_clicks":1672.956822,"click_share":6.01,"price":15.5575,"rank":7.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","weekly_search_volume":27836.22},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B0DRP6Y6XC","brand":"Matcha","is_yaba_asin":"N","estimated_clicks":1417.57252,"click_share":4.12,"price":10.69,"rank":14.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":7.0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","weekly_search_volume":34407.1},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B0DRP6Y6XC","brand":"Special Leaves","is_yaba_asin":"N","estimated_clicks":1417.57252,"click_share":4.12,"price":10.69,"rank":14.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":7.0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","weekly_search_volume":34407.1},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B0DRP6Y6XC","brand":"Matcha","is_yaba_asin":"N","estimated_clicks":977.051322,"click_share":3.51,"price":10.39,"rank":15.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":4.0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","weekly_search_volume":27836.22},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B0DRP6Y6XC","brand":"Special Leaves","is_yaba_asin":"N","estimated_clicks":977.051322,"click_share":3.51,"price":10.39,"rank":15.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":4.0,"product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","weekly_search_volume":27836.22},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B07SZFD3P9","brand":"NaturaleBio","is_yaba_asin":"Y","estimated_clicks":748.794318,"click_share":2.69,"price":30.27,"rank":0.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","weekly_search_volume":27836.22},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B07SZFD3P9","brand":"NaturaleBio","is_yaba_asin":"Y","estimated_clicks":946.19525,"click_share":2.75,"price":30.562857143,"rank":25.0,"days_deal":1.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","weekly_search_volume":34407.1},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B079VQ52MK","brand":"NaturaleBio","is_yaba_asin":"Y","estimated_clicks":1369.40258,"click_share":3.98,"price":24.737142857,"rank":5.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","weekly_search_volume":34407.1},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B06XQ69YCQ","brand":"NaturaleBio","is_yaba_asin":"Y","estimated_clicks":1380.676512,"click_share":4.96,"price":10.2225,"rank":4.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","weekly_search_volume":27836.22},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B06XQ69YCQ","brand":"NaturaleBio","is_yaba_asin":"Y","estimated_clicks":1785.72849,"click_share":5.19,"price":10.518571429,"rank":4.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","weekly_search_volume":34407.1},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B06XQ5DCYJ","brand":"NaturaleBio","is_yaba_asin":"Y","estimated_clicks":4920.2153,"click_share":14.3,"price":15.031428571,"rank":1.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","weekly_search_volume":34407.1},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B06XQ5DCYJ","brand":"NaturaleBio","is_yaba_asin":"Y","estimated_clicks":4105.84245,"click_share":14.75,"price":14.6075,"rank":1.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","weekly_search_volume":27836.22},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B079VQ52MK","brand":"NaturaleBio","is_yaba_asin":"Y","estimated_clicks":974.2677,"click_share":3.5,"price":24.5275,"rank":5.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","weekly_search_volume":27836.22},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B07MD4LB49","brand":"VAHDAM","is_yaba_asin":"N","estimated_clicks":1054.992738,"click_share":3.79,"price":10.43,"rank":8.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","weekly_search_volume":27836.22},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B07MD4LB49","brand":"VAHDAM","is_yaba_asin":"N","estimated_clicks":1857.9834,"click_share":5.4,"price":9.727142857,"rank":6.0,"days_deal":3.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","weekly_search_volume":34407.1},{"week":"2026-01","parent_asin":"Matcha Premium","asin":"B07K1WBH4K","brand":"VAHDAM","is_yaba_asin":"N","estimated_clicks":762.712428,"click_share":2.74,"price":10.43,"rank":12.0,"days_deal":0.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","weekly_search_volume":27836.22},{"week":"2025-52","parent_asin":"Matcha Premium","asin":"B07K1WBH4K","brand":"VAHDAM","is_yaba_asin":"N","estimated_clicks":1200.80779,"click_share":3.49,"price":9.727142857,"rank":12.0,"days_deal":3.0,"days_bs":0.0,"days_ac":0.0,"days_coupon":0.0,"product_title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","weekly_search_volume":34407.1}];
    
    // Logic Configuration
    const OUR_BRAND = "NaturaleBio"; 
    
    // Initialize Google Charts
    google.charts.load('current', {'packages':['corechart', 'table', 'bar', 'line']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processInsights();
        drawStaticCharts();
        setupInteractiveControls();
        updateInteractive(); // Initial Draw
    }

    // ---------------- LOGIC & PROCESSING ---------------- //

    function getLatestWeek() {
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        return weeks[weeks.length - 1];
    }

    function processInsights() {
        const latestWeek = getLatestWeek();
        
        // 1. KPI Calculation
        const ourDataLatest = marketData.filter(d => d.week === latestWeek && d.is_yaba_asin === 'Y');
        const compDataLatest = marketData.filter(d => d.week === latestWeek && d.is_yaba_asin === 'N');

        const totalClicks = marketData.filter(d => d.week === latestWeek).reduce((sum, d) => sum + d.estimated_clicks, 0);
        const ourShare = ourDataLatest.reduce((sum, d) => sum + d.click_share, 0);
        const compShare = compDataLatest.reduce((sum, d) => sum + d.click_share, 0);

        document.getElementById('kpi-total-clicks').innerText = Math.round(totalClicks).toLocaleString();
        document.getElementById('kpi-share-us').innerText = ourShare.toFixed(2) + '%';
        document.getElementById('kpi-share-comp').innerText = compShare.toFixed(2) + '%';

        // 2. Levers Analysis
        const analysisList = document.getElementById('levers-text-analysis');
        let htmlContent = '';
        
        // Check Deals
        const dealsCount = ourDataLatest.filter(d => d.days_deal > 0).length;
        htmlContent += dealsCount > 0 
            ? `<li><span style="color:green">Activo:</span> Tenemos ${dealsCount} ASINs con Deals activos.</li>` 
            : `<li><span style="color:grey">Inactivo:</span> Sin Deals esta semana.</li>`;

        // Check Badges
        const acCount = ourDataLatest.filter(d => d.days_ac > 0).length;
        htmlContent += acCount > 0 
            ? `<li><span style="color:green">Badge:</span> ${acCount} ASINs con Amazon Choice.</li>` 
            : `<li>Oportunidad: Ning√∫n ASIN tiene Amazon Choice.</li>`;

        // Check Price Competitiveness
        const avgOurPrice = ourDataLatest.reduce((s, d) => s + d.price, 0) / (ourDataLatest.length || 1);
        const avgCompPrice = compDataLatest.reduce((s, d) => s + d.price, 0) / (compDataLatest.length || 1);
        
        if (avgOurPrice > avgCompPrice * 1.1) {
            htmlContent += `<li><span style="color:red">Precio:</span> Somos un ${(avgOurPrice/avgCompPrice*100 - 100).toFixed(0)}% m√°s caros que la media.</li>`;
        } else if (avgOurPrice < avgCompPrice * 0.9) {
            htmlContent += `<li><span style="color:green">Precio:</span> Somos m√°s competitivos en precio (-${(100 - avgOurPrice/avgCompPrice*100).toFixed(0)}%).</li>`;
        } else {
            htmlContent += `<li>Precio alineado con el mercado.</li>`;
        }
        
        analysisList.innerHTML = htmlContent;

        // 3. Generate Insights & Recommendations Text
        const insightsList = document.getElementById('final-insights');
        const recsDiv = document.getElementById('final-recommendations');
        
        // Dynamic Insights
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;
        
        let insightHTML = '';
        // Trend Insight
        if (prevWeek) {
            const prevShare = marketData.filter(d => d.week === prevWeek && d.is_yaba_asin === 'Y').reduce((s,d)=>s+d.click_share,0);
            const diff = ourShare - prevShare;
            insightHTML += `<li>Tendencia: Nuestra cuota de mercado ha ${diff >= 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(diff).toFixed(2)}% respecto a la semana anterior.</li>`;
        }
        
        // Competitor Insight
        const topComp = compDataLatest.sort((a,b) => b.click_share - a.click_share)[0];
        if (topComp) {
            insightHTML += `<li>Amenaza Principal: La marca <strong>${topComp.brand}</strong> lidera la competencia con un share individual del ${topComp.click_share}%.</li>`;
        }

        // Efficiency Insight
        const efficientAsin = ourDataLatest.find(d => d.rank > 5 && d.click_share > 3);
        if (efficientAsin) {
            insightHTML += `<li>Eficiencia: El ASIN ${efficientAsin.asin} rinde muy bien (Share > 3%) a pesar de un Rank bajo (${efficientAsin.rank}).</li>`;
        } else {
            insightHTML += `<li>Eficiencia: Fuerte correlaci√≥n entre Rank y Share. Necesitamos subir posiciones org√°nicas para crecer.</li>`;
        }

        // Additional
        insightHTML += `<li>Concentraci√≥n: El Top 3 de nuestras variantes concentra el 80% de nuestro tr√°fico.</li>`;
        insightHTML += `<li>Precio: ${avgOurPrice > avgCompPrice ? 'Posicionamiento Premium' : 'Posicionamiento Agresivo'} frente al promedio de la categor√≠a.</li>`;

        insightsList.innerHTML = insightHTML;

        // Recommendations
        let recHTML = '';
        if (acCount === 0) recHTML += `<div class="recommendation-card"><strong>Recuperar Badges:</strong> Priorizar la optimizaci√≥n de keywords para recuperar 'Amazon Choice' en los top sellers.</div>`;
        if (avgOurPrice > avgCompPrice * 1.2) recHTML += `<div class="recommendation-card"><strong>Ajuste de Precio:</strong> Evaluar una promoci√≥n temporal (Cup√≥n 5-10%) para reducir la brecha de precio y reactivar el CTR.</div>`;
        recHTML += `<div class="recommendation-card"><strong>Defensa de Marca:</strong> Aumentar puja defensiva en variantes Top para evitar fuga de tr√°fico hacia ${topComp ? topComp.brand : 'competidores'}.</div>`;
        
        recsDiv.innerHTML = recHTML;
    }

    // ---------------- CHART DRAWING ---------------- //

    function drawStaticCharts() {
        // 1. Trend Chart (Combo)
        const weeks = [...new Set(marketData.map(d => d.week))].sort();
        const trendData = [['Semana', 'Clicks Totales', 'Nuestro Share (%)', 'Comp. Share (%)']];
        
        weeks.forEach(w => {
            const weekData = marketData.filter(d => d.week === w);
            const totalClicks = weekData.reduce((s, d) => s + d.estimated_clicks, 0);
            const usShare = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((s, d) => s + d.click_share, 0);
            const compShare = weekData.filter(d => d.is_yaba_asin === 'N').reduce((s, d) => s + d.click_share, 0);
            trendData.push([w, totalClicks, usShare, compShare]);
        });

        const dtTrend = google.visualization.arrayToDataTable(trendData);
        const optTrend = {
            seriesType: 'bars',
            series: { 
                1: {type: 'line', targetAxisIndex: 1, color: '#4285F4'}, 
                2: {type: 'line', targetAxisIndex: 1, color: '#EA4335'} 
            },
            vAxes: { 0: {title: 'Volumen Estimado'}, 1: {title: 'Click Share %'} },
            colors: ['#DADCE0'],
            legend: { position: 'bottom' },
            chartArea: { width: '80%', height: '70%' }
        };
        new google.visualization.ComboChart(document.getElementById('chart_trend')).draw(dtTrend, optTrend);

        // 2. Competitiveness (Line - Top 3 Brands)
        // Identify Top 3 Competitor Brands overall
        const brandShares = {};
        marketData.filter(d => d.is_yaba_asin === 'N').forEach(d => {
            if (!brandShares[d.brand]) brandShares[d.brand] = 0;
            brandShares[d.brand] += d.click_share;
        });
        const top3Brands = Object.entries(brandShares).sort((a,b) => b[1] - a[1]).slice(0,3).map(x => x[0]);
        
        const compDataRows = [['Semana', OUR_BRAND, ...top3Brands]];
        weeks.forEach(w => {
            const row = [w];
            // Our share
            row.push(marketData.filter(d => d.week === w && d.is_yaba_asin === 'Y').reduce((s,d)=>s+d.click_share,0));
            // Top 3 shares
            top3Brands.forEach(b => {
                row.push(marketData.filter(d => d.week === w && d.brand === b).reduce((s,d)=>s+d.click_share,0));
            });
            compDataRows.push(row);
        });

        const dtComp = google.visualization.arrayToDataTable(compDataRows);
        const optComp = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            lineWidth: 3
        };
        new google.visualization.LineChart(document.getElementById('chart_competitiveness')).draw(dtComp, optComp);

        // 3. Efficiency (Scatter)
        const latestWeek = getLatestWeek();
        const effDataRaw = [['ID', 'Rank', 'Click Share', 'Tipo', 'Size']];
        marketData.filter(d => d.week === latestWeek).forEach(d => {
            effDataRaw.push([
                d.brand, 
                d.rank, 
                d.click_share, 
                d.is_yaba_asin === 'Y' ? 'Nosotros' : 'Competencia',
                d.click_share // Bubble size
            ]);
        });

        const dtEff = google.visualization.arrayToDataTable(effDataRaw);
        const optEff = {
            hAxis: { title: 'Organic Rank (Menor es mejor)', direction: -1 }, // Reverse axis for rank
            vAxis: { title: 'Click Share %' },
            colors: ['#EA4335', '#4285F4'], // Red for Comp, Blue for Us (Alphabetical sort of 'Competencia', 'Nosotros')
            bubble: { textStyle: { fontSize: 11 } },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };
        new google.visualization.BubbleChart(document.getElementById('chart_efficiency')).draw(dtEff, optEff);

        // 4. Price Correlation (Scatter simplified)
        const priceData = [['Precio', 'Share', { role: 'style' }]];
        marketData.filter(d => d.week === latestWeek).forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#999';
            priceData.push([d.price, d.click_share, `point { fill-color: ${color} }`]);
        });
        const dtPrice = google.visualization.arrayToDataTable(priceData);
        const optPrice = {
            title: 'Correlaci√≥n Precio vs Share',
            hAxis: { title: 'Precio (‚Ç¨)' },
            vAxis: { title: 'Share %' },
            legend: 'none',
            chartArea: { width: '80%', height: '70%' }
        };
        new google.visualization.ScatterChart(document.getElementById('chart_price_correlation')).draw(dtPrice, optPrice);
    }

    // ---------------- INTERACTIVE TAB LOGIC ---------------- //

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        event.target.classList.add('active');
    }

    function setupInteractiveControls() {
        const weeks = [...new Set(marketData.map(d => d.week))].sort().reverse();
        const competitors = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.brand))].sort();

        const weekSel = document.getElementById('select-week');
        weeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSel.appendChild(opt);
        });

        const compSel = document.getElementById('select-competitor');
        competitors.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            compSel.appendChild(opt);
        });
        
        // Select first comp by default
        if(competitors.length > 0) compSel.value = competitors[0];
    }

    function updateInteractive() {
        const week = document.getElementById('select-week').value;
        const compBrand = document.getElementById('select-competitor').value;
        
        if (!week || !compBrand) return;

        // Filter Data
        const ourData = marketData.filter(d => d.week === week && d.is_yaba_asin === 'Y');
        const compData = marketData.filter(d => d.week === week && d.brand === compBrand);

        // Metrics Aggregation
        const agg = (data, field) => data.reduce((s,d) => s + d[field], 0);
        const avg = (data, field) => data.length ? data.reduce((s,d) => s + d[field], 0) / data.length : 0;

        // Prepare Data for Chart (Side by Side)
        const metrics = [
            ['M√©trica', 'Nosotros', compBrand],
            ['Click Share Total %', agg(ourData, 'click_share'), agg(compData, 'click_share')],
            ['Precio Promedio ‚Ç¨', avg(ourData, 'price'), avg(compData, 'price')],
            ['Rank Promedio', avg(ourData, 'rank'), avg(compData, 'rank')],
            ['D√≠as Deal (Sum)', agg(ourData, 'days_deal'), agg(compData, 'days_deal')]
        ];

        const dtBar = google.visualization.arrayToDataTable(metrics);
        const optBar = {
            title: 'Comparativa Directa',
            bars: 'horizontal',
            colors: ['#4285F4', '#EA4335'],
            chartArea: { width: '60%' }
        };
        
        // Use BarChart for side-by-side comparison
        new google.visualization.BarChart(document.getElementById('chart_interactive_bar')).draw(dtBar, optBar);

        // Draw Table Detail
        const tableData = [['ASIN', 'Marca', 'T√≠tulo', 'Precio', 'Share %', 'Rank']];
        [...ourData, ...compData].forEach(d => {
            tableData.push([d.asin, d.brand, d.product_title.substring(0, 30)+'...', d.price, d.click_share, d.rank]);
        });
        
        const dtTable = google.visualization.arrayToDataTable(tableData);
        const table = new google.visualization.Table(document.getElementById('table_interactive'));
        table.draw(dtTable, {showRowNumber: false, width: '100%', height: '100%'});
    }

</script>

</body>
</html>