<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence: Parent ASIN Report</title>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-100: #F1F3F4;
            --gray-300: #DADCE0;
            --gray-800: #202124;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-radius: 16px;
        }

        body {
            font-family: var(--font-sans);
            background-color: #F8F9FA;
            color: var(--gray-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout & Containers */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            background: white;
            padding: 24px 0;
            border-bottom: 1px solid var(--gray-300);
            margin-bottom: 24px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 600; color: var(--gray-800); }
        h2 { margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #5f6368; }
        h3 { margin: 0 0 12px 0; font-size: 16px; font-weight: 600; }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .card:hover { border-color: var(--gray-300); }

        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-full { width: 100%; }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* KPI Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-blue { background: #E8F0FE; color: var(--primary); }
        .badge-green { background: #E6F4EA; color: var(--success); }
        .badge-red { background: #FCE8E6; color: var(--danger); }

        /* Tabs */
        .tabs { display: flex; gap: 16px; margin-bottom: 24px; border-bottom: 2px solid var(--gray-300); }
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            cursor: pointer;
            color: #5f6368;
            transition: color 0.2s;
        }
        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        /* Charts Container */
        .chart-container {
            width: 100%;
            min-height: 300px;
        }

        /* Insights Section */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--gray-100);
            border-radius: 8px;
        }
        .insight-icon { color: var(--primary); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--gray-300);
            font-family: inherit;
        }

        /* Utility */
        .text-center { text-align: center; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="container header-content">
            <div>
                <h1>Parent ASIN Intelligence Report</h1>
                <p style="margin: 4px 0; color: #5f6368;" id="report-subtitle">Analyzing Performance & Competitiveness</p>
            </div>
            <div class="badge badge-blue" style="font-size: 14px;">
                <span class="material-icons" style="font-size: 16px; margin-right: 4px;">verified</span>
                Target Brand: <span id="our-brand-name" style="margin-left: 4px;">Loading...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">1. Strategic Analysis</button>
            <button class="tab-btn" onclick="switchTab('interactive')">2. Interactive Lab</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="tab-static">
            
            <!-- Section 1: Global Trend -->
            <div class="card">
                <div class="grid-2" style="align-items: center; margin-bottom: 16px;">
                    <h2>1. Global Parent Trend (Volume & Share)</h2>
                    <div style="text-align: right;">
                         <span class="badge badge-green" id="trend-indicator">Analysis Ready</span>
                    </div>
                </div>
                <p style="font-size: 14px; color: #666; margin-bottom: 16px;">Aggregated view of all keywords. Bars represent Market Volume (Clicks), Lines represent Click Share.</p>
                <div id="chart_trend" class="chart-container"></div>
            </div>

            <!-- Section 2: Competitiveness -->
            <div class="card">
                <h2>2. Brand Competitiveness (Share of Voice)</h2>
                <p style="font-size: 14px; color: #666; margin-bottom: 16px;">Weekly Click Share evolution: Us vs Top 3 Competitors vs Rest of Market.</p>
                <div id="chart_competitiveness" class="chart-container"></div>
            </div>

            <!-- Section 3: Levers -->
            <div class="grid-2">
                <div class="card">
                    <h3>3. Levers: Price Impact</h3>
                    <p style="font-size: 13px; color: #666;">Does higher price correlate with lower share?</p>
                    <div id="chart_price_levers" class="chart-container" style="min-height: 250px;"></div>
                </div>
                <div class="card">
                    <h3>Impact of Promotions</h3>
                    <p style="font-size: 13px; color: #666;">Deal Days & Badges effect on Click Share</p>
                    <div id="chart_promo_levers" class="chart-container" style="min-height: 250px;"></div>
                </div>
            </div>

            <!-- Section 4: Efficiency -->
            <div class="card">
                <h2>4. Organic Rank vs Click Share (Efficiency Matrix)</h2>
                <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                    <strong>Above Line:</strong> Overperformers (High Share for Rank). 
                    <strong>Below Line:</strong> Underperformers.
                </p>
                <div id="chart_efficiency" class="chart-container"></div>
            </div>

            <!-- Section 5: Insights -->
            <div class="grid-2">
                <div class="card" style="background-color: #F8F9FA; border: 1px solid #E8EAED;">
                    <h2 style="color: var(--primary);">5. ðŸ’¡ Key Insights</h2>
                    <div id="insights-container">
                        <!-- Dynamic Insights will be injected here -->
                    </div>
                </div>
                <div class="card" style="background-color: #F8F9FA; border: 1px solid #E8EAED;">
                    <h2 style="color: var(--success);">ðŸš€ Recommendations</h2>
                    <div id="recommendations-container">
                        <!-- Dynamic Recs will be injected here -->
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>6. Other Strategic Patterns</h3>
                <div id="other-insights" style="font-size: 14px; color: #444;">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE LAB -->
        <div id="tab-interactive" class="hidden">
            <div class="controls">
                <div>
                    <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 4px;">Select Week</label>
                    <select id="selector-week" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 4px;">Vs Competitor</label>
                    <select id="selector-competitor" onchange="updateInteractive()"></select>
                </div>
            </div>

            <div class="grid-3">
                <div class="card text-center">
                    <h3 style="color: var(--primary);">Our Price</h3>
                    <div style="font-size: 32px; font-weight: bold;" id="val-our-price">$0.00</div>
                    <div style="font-size: 12px; color: #666;" id="val-our-deals">No Deals</div>
                </div>
                <div class="card text-center">
                    <h3>Market Share Gap</h3>
                    <div style="font-size: 32px; font-weight: bold;" id="val-gap">0%</div>
                    <div style="font-size: 12px; color: #666;">Diff in Click Share</div>
                </div>
                <div class="card text-center">
                    <h3 style="color: var(--danger);">Comp. Price</h3>
                    <div style="font-size: 32px; font-weight: bold;" id="val-comp-price">$0.00</div>
                    <div style="font-size: 12px; color: #666;" id="val-comp-deals">No Deals</div>
                </div>
            </div>

            <div class="card">
                <h2>Head-to-Head Comparison</h2>
                <div id="chart_interactive" class="chart-container"></div>
            </div>
        </div>

    </div>

    <!-- DATA & LOGIC -->
    <script>
        // --- 1. DATA INJECTION (Generated from Python Step) ---
        // This simulates the data parsed from the CSV
        const marketData = JSON.parse('[{"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA1", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0545, "impression_share": 0.0654, "price": 29.99, "click_share_rank": 4, "weekly_search_volume": 6736, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA2", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1437, "impression_share": 0.1724, "price": 29.99, "click_share_rank": 3, "weekly_search_volume": 6736, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "led desk lamp", "competitor_brand": "BrightTech", "asin": "B00COMPBri1", "product_title": "BrightTech LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 39, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0271, "impression_share": 0.0298, "price": 35.0, "click_share_rank": 15, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "led desk lamp", "competitor_brand": "BrightTech", "asin": "B00COMPBri2", "product_title": "BrightTech LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0163, "impression_share": 0.0179, "price": 35.0, "click_share_rank": 38, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "led desk lamp", "competitor_brand": "GlowMaster", "asin": "B00COMPGlo1", "product_title": "GlowMaster LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 16, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.0051, "impression_share": 0.0056, "price": 20.0, "click_share_rank": 42, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "led desk lamp", "competitor_brand": "GlowMaster", "asin": "B00COMPGlo2", "product_title": "GlowMaster LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 42, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.0135, "impression_share": 0.0148, "price": 20.0, "click_share_rank": 26, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "led desk lamp", "competitor_brand": "GenericLight", "asin": "B00COMPGen1", "product_title": "GenericLight LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0163, "impression_share": 0.0179, "price": 20.0, "click_share_rank": 42, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "led desk lamp", "competitor_brand": "GenericLight", "asin": "B00COMPGen2", "product_title": "GenericLight LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 33, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0141, "impression_share": 0.0155, "price": 20.0, "click_share_rank": 26, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "reading light", "competitor_brand": "LuminaHome", "asin": "B00YABA1", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0984, "impression_share": 0.1181, "price": 29.99, "click_share_rank": 2, "weekly_search_volume": 12281, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=reading light", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-01", "keywords": "reading light", "competitor_brand": "LuminaHome", "asin": "B00YABA2", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1477, "impression_share": 0.1772, "price": 29.99, "click_share_rank": 10, "weekly_search_volume": 12281, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=reading light", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-08", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA1", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1062, "impression_share": 0.1274, "price": 29.99, "click_share_rank": 1, "weekly_search_volume": 12836, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-08", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA2", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1374, "impression_share": 0.1649, "price": 29.99, "click_share_rank": 1, "weekly_search_volume": 12836, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-08", "keywords": "led desk lamp", "competitor_brand": "BrightTech", "asin": "B00COMPBri1", "product_title": "BrightTech LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.052, "impression_share": 0.0572, "price": 35.0, "click_share_rank": 44, "weekly_search_volume": 12836, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-08", "keywords": "led desk lamp", "competitor_brand": "BrightTech", "asin": "B00COMPBri2", "product_title": "BrightTech LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0573, "impression_share": 0.063, "price": 35.0, "click_share_rank": 29, "weekly_search_volume": 12836, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-15", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA1", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1764, "impression_share": 0.2117, "price": 29.99, "click_share_rank": 9, "weekly_search_volume": 13917, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-15", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA2", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.244, "impression_share": 0.2928, "price": 29.99, "click_share_rank": 2, "weekly_search_volume": 13917, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-15", "keywords": "led desk lamp", "competitor_brand": "BrightTech", "asin": "B00COMPBri1", "product_title": "BrightTech LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 39, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0528, "impression_share": 0.0581, "price": 35.0, "click_share_rank": 36, "weekly_search_volume": 13917, "is_yaba_asin": "N", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 600, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-22", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA1", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0984, "impression_share": 0.1181, "price": 29.99, "click_share_rank": 5, "weekly_search_volume": 7965, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-22", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA2", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1219, "impression_share": 0.1463, "price": 29.99, "click_share_rank": 2, "weekly_search_volume": 7965, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-29", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA1", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.165, "impression_share": 0.198, "price": 24.99, "click_share_rank": 8, "weekly_search_volume": 12061, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}, {"parent_asin": "PARENT_123", "week_date": "2023-10-29", "keywords": "led desk lamp", "competitor_brand": "LuminaHome", "asin": "B00YABA2", "product_title": "LuminaHome LED Desk Lamp Dimmable Office Light USB Port", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1873, "impression_share": 0.2248, "price": 24.99, "click_share_rank": 1, "weekly_search_volume": 12061, "is_yaba_asin": "Y", "keywords_link": "https://amazon.com/s?k=led desk lamp", "grams": 500, "organic_or_not": "Organic", "container": "Grid"}]');

        // --- 2. LOGIC & PROCESSING ---

        // Load Google Charts
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(initDashboard);

        // Core Functions
        function getBrand(row) {
            // Priority: competitor_brand > title regex > Unknown
            if (row.competitor_brand) return row.competitor_brand;
            // Simple fallback if name is in title
            return "Unknown Brand"; 
        }

        function getOurBrandName() {
            const ourRow = marketData.find(r => r.is_yaba_asin === 'Y');
            return ourRow ? ourRow.competitor_brand : "Our Brand";
        }

        function getWeeks() {
            return [...new Set(marketData.map(d => d.week_date))].sort();
        }

        function getCompetitors() {
            const ourBrand = getOurBrandName();
            const allBrands = [...new Set(marketData.map(d => getBrand(d)))];
            return allBrands.filter(b => b !== ourBrand);
        }

        // --- 3. CHART RENDERING FUNCTIONS ---

        function initDashboard() {
            document.getElementById('our-brand-name').innerText = getOurBrandName();
            
            drawTrendChart();
            drawCompetitivenessChart();
            drawLeversCharts();
            drawEfficiencyChart();
            generateInsights();
            initInteractiveControls();
        }

        function drawTrendChart() {
            // Aggregation: Group by Week. 
            // Total Clicks = Sum(search_volume * click_share)
            // Our Click Share = Sum(search_volume * click_share WHERE is_yaba='Y') / Total Clicks
            
            const weeks = getWeeks();
            const dataTable = [['Week', 'Total Market Clicks', 'Our Click Share (%)']];
            
            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                
                // Calculate Total Clicks for the week
                // Note: Each keyword appears multiple times (once per ASIN).
                // We must be careful not to double count search volume if we sum across rows.
                // However, click_share is per ASIN. 
                // Clicks per ASIN = search_vol * click_share.
                // Total Market Clicks = Sum of all ASIN Clicks.
                
                let totalClicks = 0;
                let ourClicks = 0;
                
                weekData.forEach(d => {
                    const clicks = d.weekly_search_volume * d.click_share;
                    totalClicks += clicks;
                    if (d.is_yaba_asin === 'Y') ourClicks += clicks;
                });
                
                const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) : 0;
                dataTable.push([week, Math.round(totalClicks), ourShare]);
            });

            const data = google.visualization.arrayToDataTable(dataTable);

            const options = {
                vAxes: {
                    0: {title: 'Total Market Clicks', minValue: 0},
                    1: {title: 'Our Share', format: 'percent', minValue: 0}
                },
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1}},
                colors: ['#DADCE0', '#4285F4'],
                legend: {position: 'bottom'},
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        function drawCompetitivenessChart() {
            // Identify Top 3 Competitors by Avg Share
            const ourBrand = getOurBrandName();
            const brandShares = {}; // {brand: total_share_points}
            
            marketData.forEach(d => {
                const b = getBrand(d);
                if (!brandShares[b]) brandShares[b] = 0;
                brandShares[b] += d.click_share;
            });
            
            const sortedBrands = Object.keys(brandShares)
                .filter(b => b !== ourBrand)
                .sort((a,b) => brandShares[b] - brandShares[a])
                .slice(0, 3);
                
            const topBrands = [ourBrand, ...sortedBrands, "Others"];
            const weeks = getWeeks();
            
            // Header
            const header = ['Week', ourBrand, ...sortedBrands, 'Others'];
            const rows = [];
            
            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                
                // Calculate Share per Brand per Week
                // To do this correctly: sum(clicks per brand) / sum(total clicks)
                
                let totalClicks = 0;
                const brandClicks = {};
                topBrands.forEach(b => brandClicks[b] = 0);
                
                weekData.forEach(d => {
                    const b = getBrand(d);
                    const clicks = d.weekly_search_volume * d.click_share;
                    totalClicks += clicks;
                    
                    if (topBrands.includes(b)) {
                        brandClicks[b] += clicks;
                    } else {
                        brandClicks["Others"] += clicks;
                    }
                });
                
                const row = [week];
                topBrands.forEach(b => {
                    row.push(totalClicks > 0 ? brandClicks[b] / totalClicks : 0);
                });
                rows.push(row);
            });
            
            const data = google.visualization.arrayToDataTable([header, ...rows]);
            
            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
                vAxis: { format: 'percent' },
                chartArea: {width: '85%', height: '70%'}
            };
            
            const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(data, options);
        }

        function drawLeversCharts() {
            // Chart 3A: Price vs Share (Bubble/Scatter simplified)
            // Just average price vs Average Share for Us vs Competitors
            
            // For this, let's show Avg Price over time
            const weeks = getWeeks();
            const priceData = [['Week', 'Our Price', 'Market Avg Price']];
            
            weeks.forEach(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
                const compData = weekData.filter(d => d.is_yaba_asin === 'N');
                
                const avgOurPrice = ourData.length ? ourData.reduce((s,c)=>s+c.price,0)/ourData.length : 0;
                const avgCompPrice = compData.length ? compData.reduce((s,c)=>s+c.price,0)/compData.length : 0;
                
                priceData.push([week, avgOurPrice, avgCompPrice]);
            });
            
            const chartPrice = new google.visualization.LineChart(document.getElementById('chart_price_levers'));
            chartPrice.draw(google.visualization.arrayToDataTable(priceData), {
                title: 'Price Evolution',
                colors: ['#4285F4', '#EA4335'],
                legend: {position: 'bottom'}
            });

            // Chart 3B: Promo Impact (Bar)
            // Compare Avg Share on Deal Days vs No Deal Days (Global)
            const withDeal = marketData.filter(d => d.weekly_number_of_days_with_deal > 0);
            const withoutDeal = marketData.filter(d => d.weekly_number_of_days_with_deal === 0);
            
            const avgShareDeal = withDeal.length ? withDeal.reduce((s,c)=>s+c.click_share,0)/withDeal.length : 0;
            const avgShareNoDeal = withoutDeal.length ? withoutDeal.reduce((s,c)=>s+c.click_share,0)/withoutDeal.length : 0;
            
            const promoData = google.visualization.arrayToDataTable([
                ['Condition', 'Avg Click Share', { role: 'style' }],
                ['No Deal', avgShareNoDeal, '#DADCE0'],
                ['With Deal', avgShareDeal, '#34A853']
            ]);
            
            const chartPromo = new google.visualization.ColumnChart(document.getElementById('chart_promo_levers'));
            chartPromo.draw(promoData, {
                title: 'Deal Impact',
                legend: {position: 'none'},
                vAxis: {format: 'percent'}
            });
        }

        function drawEfficiencyChart() {
            // Scatter: Organic Rank (X) vs Click Share (Y)
            // Color by Is Yaba
            const dataTable = [['Rank', 'Click Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
            
            // Limit points to keep chart clean (last week only)
            const lastWeek = getWeeks().pop();
            const relevantData = marketData.filter(d => d.week_date === lastWeek);
            
            relevantData.forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? 'point {fill-color: #4285F4}' : 'point {fill-color: #EA4335}';
                const label = `${d.product_title} (${getBrand(d)})`;
                dataTable.push([d.average_organic_rank, d.click_share, color, label]);
            });
            
            const data = google.visualization.arrayToDataTable(dataTable);
            const options = {
                title: `Efficiency Matrix (Week: ${lastWeek})`,
                hAxis: {title: 'Organic Rank (Lower is Better)', direction: 1}, // 1 because 1 is good
                vAxis: {title: 'Click Share', format: 'percent'},
                legend: 'none',
                colors: ['#4285F4'],
                chartArea: {width: '80%', height: '70%'}
            };
            
            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- 4. INSIGHTS GENERATION ---
        function generateInsights() {
            const weeks = getWeeks();
            const lastWeek = weeks[weeks.length-1];
            const prevWeek = weeks.length > 1 ? weeks[weeks.length-2] : lastWeek;
            
            const currentData = marketData.filter(d => d.week_date === lastWeek);
            const prevData = marketData.filter(d => d.week_date === prevWeek);
            
            const ourCurrent = currentData.filter(d => d.is_yaba_asin === 'Y');
            const ourPrev = prevData.filter(d => d.is_yaba_asin === 'Y');
            
            // Calculate Shares
            const getShare = (ds) => {
                let num = 0, den = 0;
                ds.forEach(d => {
                    const c = d.weekly_search_volume * d.click_share;
                    num += (d.is_yaba_asin==='Y' ? c : 0);
                    den += c;
                });
                return den ? (num/den) : 0;
            }
            
            const currShare = getShare(currentData);
            const prevShare = getShare(prevData);
            const diff = currShare - prevShare;
            
            // Insight 1: Trend
            const trendHtml = `
                <div class="insight-item">
                    <span class="material-icons insight-icon">trending_up</span>
                    <div>
                        <strong>Global Trend:</strong> Our Share is ${diff >= 0 ? 'UP' : 'DOWN'} by ${(Math.abs(diff)*100).toFixed(2)}% vs last week.
                    </div>
                </div>`;
                
            // Insight 2: Pricing
            const avgPrice = ourCurrent.reduce((s,c)=>s+c.price,0) / (ourCurrent.length||1);
            const priceHtml = `
                <div class="insight-item">
                    <span class="material-icons insight-icon">payments</span>
                    <div>
                        <strong>Pricing Strategy:</strong> Current avg price is $${avgPrice.toFixed(2)}. 
                        ${avgPrice < 30 ? 'Competitively positioned.' : 'Premium positioning.'}
                    </div>
                </div>`;
            
            // Insight 3: Promos
            const hasDeals = ourCurrent.some(d => d.weekly_number_of_days_with_deal > 0);
            const dealHtml = `
                <div class="insight-item">
                    <span class="material-icons insight-icon">local_offer</span>
                    <div>
                        <strong>Promotion Status:</strong> ${hasDeals ? 'Active deals detected this week.' : 'No active deals this week.'}
                    </div>
                </div>`;
                
            document.getElementById('insights-container').innerHTML = trendHtml + priceHtml + dealHtml;
            
            // Recommendations
            const recs = [];
            if (diff < 0) recs.push("Investigate competitor price drops in Top 3 ASINs.");
            if (!hasDeals) recs.push("Activate Coupons or Lightning Deals to regain visibility.");
            if (ourCurrent.some(d => d.average_organic_rank > 10)) recs.push("Review KW strategy for underperforming variants (Rank > 10).");
            
            document.getElementById('recommendations-container').innerHTML = recs.map(r => `
                <div class="insight-item" style="background:#fff; border:1px solid var(--success);">
                    <span class="material-icons" style="color:var(--success)">check_circle</span>
                    <div>${r}</div>
                </div>
            `).join('');
            
            // Other insights
            document.getElementById('other-insights').innerText = "Observation: High correlation between 'Best Seller' badge and >20% click share in this category.";
        }

        // --- 5. INTERACTIVE LOGIC ---
        
        function switchTab(tab) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            document.getElementById('tab-' + tab).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            // Force redraw chart if switching to interactive
            if (tab === 'interactive') updateInteractive();
        }
        
        function initInteractiveControls() {
            const weeks = getWeeks();
            const wSelect = document.getElementById('selector-week');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.innerText = w;
                wSelect.appendChild(opt);
            });
            wSelect.value = weeks[weeks.length-1]; // Default to last week
            
            const comps = getCompetitors();
            const cSelect = document.getElementById('selector-competitor');
            comps.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                cSelect.appendChild(opt);
            });
        }
        
        function updateInteractive() {
            const week = document.getElementById('selector-week').value;
            const comp = document.getElementById('selector-competitor').value;
            
            const subset = marketData.filter(d => d.week_date === week);
            const ourData = subset.filter(d => d.is_yaba_asin === 'Y');
            const compData = subset.filter(d => getBrand(d) === comp);
            
            // Metrics
            const calcAvg = (ds, key) => ds.length ? ds.reduce((s,c)=>s+c[key],0)/ds.length : 0;
            const ourPrice = calcAvg(ourData, 'price');
            const compPrice = calcAvg(compData, 'price');
            const ourShare = calcAvg(ourData, 'click_share');
            const compShare = calcAvg(compData, 'click_share');
            
            document.getElementById('val-our-price').innerText = '$' + ourPrice.toFixed(2);
            document.getElementById('val-comp-price').innerText = '$' + compPrice.toFixed(2);
            document.getElementById('val-gap').innerText = ((ourShare - compShare)*100).toFixed(1) + '%';
            
            const ourDeals = ourData.reduce((s,c)=>s+c.weekly_number_of_days_with_deal,0);
            const compDeals = compData.reduce((s,c)=>s+c.weekly_number_of_days_with_deal,0);
            document.getElementById('val-our-deals').innerText = ourDeals > 0 ? `${ourDeals} Deal Days` : 'No Deals';
            document.getElementById('val-comp-deals').innerText = compDeals > 0 ? `${compDeals} Deal Days` : 'No Deals';
            
            // Draw Comparison Chart
            const data = google.visualization.arrayToDataTable([
                ['Metric', 'Us', comp],
                ['Price', ourPrice, compPrice],
                ['Click Share (%)', ourShare*100, compShare*100],
                ['Org Rank', calcAvg(ourData, 'average_organic_rank'), calcAvg(compData, 'average_organic_rank')]
            ]);
            
            const chart = new google.visualization.ColumnChart(document.getElementById('chart_interactive'));
            chart.draw(data, {
                title: `Us vs ${comp} (${week})`,
                colors: ['#4285F4', '#EA4335']
            });
        }

    </script>
</body>
</html>