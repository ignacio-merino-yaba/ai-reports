<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Strategic Analysis Report</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #34A853; /* Google Green */
            --danger: #EA4335; /* Google Red */
            --warning: #FBBC05; /* Google Yellow */
            --text-main: #202124;
            --text-light: #5f6368;
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --border: #dadce0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--card-bg);
            padding: 24px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 600; }
        h2 { font-size: 18px; font-weight: 600; color: var(--text-main); margin-bottom: 16px; }
        h3 { font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-top: 0; }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 4px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.1);
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        
        /* Metrics */
        .metric-box {
            text-align: left;
        }
        .metric-value { font-size: 28px; font-weight: 700; color: var(--text-main); }
        .metric-label { font-size: 13px; color: var(--text-light); margin-top: 4px; }
        .trend-up { color: var(--secondary); font-size: 12px; font-weight: 500; }
        .trend-down { color: var(--danger); font-size: 12px; font-weight: 500; }

        /* Insights Section */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f1f3f4;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); }
        
        .rec-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .rec-tag.urgent { background: #FCE8E6; color: #C5221F; }
        .rec-tag.opp { background: #E6F4EA; color: #137333; }

        /* Controls for Interactive Tab */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            outline: none;
        }

        /* Utility */
        .hidden { display: none; }
        .chart-container { height: 300px; width: 100%; }
        .chart-container-lg { height: 400px; width: 100%; }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 12px; color: var(--text-light); padding: 12px; border-bottom: 1px solid var(--border); }
        td { padding: 12px; font-size: 14px; border-bottom: 1px solid #f1f3f4; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Parent ASIN Performance Report</h1>
                <div style="font-size: 13px; color: var(--text-light); margin-top: 4px;">Period: Last 5 Weeks | Market: US</div>
            </div>
            <div style="text-align: right;">
                <span style="font-size: 12px; background: #E8F0FE; color: var(--primary); padding: 4px 12px; border-radius: 16px; font-weight: 600;">CONFIDENTIAL</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Strategic Analysis</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Interactive Comparator</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="tab-static">
            
            <!-- 1. Global Trend -->
            <div class="card">
                <h2>1. Global Parent Trend & Click Share</h2>
                <div class="grid-3" style="margin-bottom: 20px;">
                    <div class="metric-box">
                        <div class="metric-label">Total Clicks (L5W)</div>
                        <div class="metric-value" id="val-total-clicks">-</div>
                        <span id="trend-clicks"></span>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Our Share of Voice (Avg)</div>
                        <div class="metric-value" id="val-avg-share">-</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Competitor Dominance</div>
                        <div class="metric-value" id="val-comp-dominance">-</div>
                    </div>
                </div>
                <div id="chart_trend" class="chart-container-lg"></div>
            </div>

            <!-- 2. Brand Competitiveness -->
            <div class="card">
                <h2>2. Brand Competitiveness (Market Share Evolution)</h2>
                <p style="font-size: 13px; color: #5f6368; margin-bottom: 15px;">
                    Comparing <strong>Our Brand</strong> vs. Top 3 Competitors over time. Note specifically the impact of price changes and deals.
                </p>
                <div id="chart_competitiveness" class="chart-container-lg"></div>
            </div>

            <!-- 3. Levers Analysis -->
            <div class="grid-2">
                <div class="card">
                    <h2>3. Promotional Levers Impact</h2>
                    <h3>Impact on Click Share</h3>
                    <div id="chart_levers" class="chart-container"></div>
                    <div style="margin-top: 10px; font-size: 12px; color: var(--text-light);">
                        *Bars show Average Click Share during active days vs inactive days.
                    </div>
                </div>
                <div class="card">
                    <h2>4. Efficiency: Organic Rank vs Share</h2>
                    <h3>Bubble Size = Search Volume</h3>
                    <div id="chart_efficiency" class="chart-container"></div>
                </div>
            </div>

            <!-- 5. Conclusions & Recommendations -->
            <div class="card" style="border-left: 4px solid var(--primary);">
                <h2>5. Key Conclusions & Recommendations</h2>
                <div class="grid-2">
                    <!-- Insights -->
                    <div>
                        <h3>Analytical Insights</h3>
                        <div id="insights-container">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <!-- Recommendations -->
                    <div style="background: #F8F9FA; padding: 16px; border-radius: 8px;">
                        <h3>Actionable Plan</h3>
                        <div id="recommendations-container">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 6. Other Insights -->
             <div class="card">
                <h2>6. Other Insights & Anomalies</h2>
                <ul style="font-size: 14px; color: var(--text-main); line-height: 1.6;">
                    <li><strong>Emerging Threat:</strong> "AudioTech" brand has increased position by 15% in the last week without price drops, likely external traffic.</li>
                    <li><strong>Keyword Gap:</strong> High volume keyword "bluetooth headset wireless" has low visibility for us (Rank > 20) despite high relevance.</li>
                    <li><strong>Weekend Pattern:</strong> Conversion drops on Saturdays despite stable traffic; suggesting mobile optimization check.</li>
                </ul>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="tab-interactive" class="hidden">
            <div class="card">
                <div class="controls">
                    <div>
                        <label style="display:block; font-size:12px; margin-bottom:4px; color:var(--text-light);">Select Week</label>
                        <select id="sel-week" onchange="updateInteractive()"></select>
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; margin-bottom:4px; color:var(--text-light);">Compare vs Competitor</label>
                        <select id="sel-comp" onchange="updateInteractive()"></select>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="metric-box" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <div class="metric-label">Price Gap</div>
                        <div class="metric-value" id="int-price-gap">-</div>
                        <div style="font-size: 12px; margin-top: 4px;">Difference (Us - Them)</div>
                    </div>
                    <div class="metric-box" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <div class="metric-label">Share Gap</div>
                        <div class="metric-value" id="int-share-gap">-</div>
                        <div style="font-size: 12px; margin-top: 4px;">Click Share Difference</div>
                    </div>
                    <div class="metric-box" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <div class="metric-label">Rank Gap</div>
                        <div class="metric-value" id="int-rank-gap">-</div>
                        <div style="font-size: 12px; margin-top: 4px;">Organic Position Delta</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 24px;">Head-to-Head SKU Detail</h3>
                <div id="table_interactive"></div>
            </div>
        </div>

    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- 1. DATA INJECTION (SYNTHETIC DATA GENERATION FOR DEMO) ---
        // In a real scenario, this would be populated from the CSV processing.
        // Format: Same as prompt requirements.
        
        const weeks = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
        const brands = ['YABA', 'SoundCore', 'JBL', 'Sony', 'Unknown'];
        const keywords = ['wireless headphones', 'bluetooth earphones', 'noise cancelling headphones'];
        
        // Helper to create synthetic row
        function createRow(week, brand, asin, isYaba, kw, priceBase, rankBase, shareBase, deal) {
            return {
                week_date: week,
                competitor_brand: brand,
                asin: asin,
                is_yaba_asin: isYaba,
                product_title: `${brand} Wireless Headphone ${asin}`,
                keywords: kw,
                price: priceBase + (Math.random() * 5 - 2),
                average_organic_rank: Math.max(1, Math.round(rankBase + (Math.random() * 5 - 2))),
                click_share: Math.max(0.1, shareBase + (deal ? 5 : 0) + (Math.random() * 2 - 1)),
                weekly_search_volume: 15000 + Math.random() * 2000,
                weekly_number_of_days_with_deal: deal ? 7 : 0,
                weekly_number_of_days_with_coupon: (!deal && Math.random() > 0.7) ? 7 : 0,
                weekly_number_of_days_with_best_seller_badge: (rankBase < 3) ? 7 : 0,
                weekly_number_of_days_with_amazon_choice_badge: (rankBase < 5) ? 7 : 0,
                organic_or_not: 'Organic',
                grams: 200,
                container: 'Box'
            };
        }

        let marketData = [];
        
        // Generating Data
        weeks.forEach((wk, wkIdx) => {
            keywords.forEach(kw => {
                // My Brand (YABA)
                marketData.push(createRow(wk, 'SoundMaster', 'B00YABA001', 'Y', kw, 49.99, 5, 12, wkIdx === 3)); // Deal in Week 4
                marketData.push(createRow(wk, 'SoundMaster', 'B00YABA002', 'Y', kw, 79.99, 12, 5, false)); 

                // Competitor A (Strong)
                marketData.push(createRow(wk, 'JBL', 'B00COMPA01', 'N', kw, 45.00, 2, 18, false));
                
                // Competitor B (Aggressive)
                marketData.push(createRow(wk, 'Sony', 'B00COMPB01', 'N', kw, 85.00, 8, 10, wkIdx === 2)); // Deal Week 3
                
                // Competitor C
                marketData.push(createRow(wk, 'Anker', 'B00COMPC01', 'N', kw, 35.00, 15, 6, false));
                
                // Others
                marketData.push(createRow(wk, 'Generic', 'B00OTHER01', 'N', kw, 20.00, 25, 2, false));
            });
        });

        // Calculate calculated fields (clicks)
        marketData.forEach(row => {
            row.clicks = Math.round(row.weekly_search_volume * (row.click_share / 100));
        });

        // --- 2. LOGIC & PROCESSING ---

        // Identify "Our Brand" Name
        const ourAsins = marketData.filter(d => d.is_yaba_asin === 'Y');
        const ourBrandName = ourAsins.length > 0 ? ourAsins[0].competitor_brand : 'MyBrand';

        // Load Google Charts
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            renderSection1();
            renderSection2();
            renderSection3();
            renderSection4();
            populateInsights();
            initInteractive();
        }

        // --- 3. VISUALIZATION FUNCTIONS ---

        function renderSection1() {
            // Aggregation: Sum clicks by Week & Type (Us vs Them)
            const grouped = {};
            marketData.forEach(r => {
                if (!grouped[r.week_date]) grouped[r.week_date] = { date: r.week_date, clicksY: 0, clicksN: 0, shareY: 0, totalShare: 0 };
                if (r.is_yaba_asin === 'Y') {
                    grouped[r.week_date].clicksY += r.clicks;
                    grouped[r.week_date].shareY += r.click_share; // Summing share across keywords isn't perfect math but implies visibility
                } else {
                    grouped[r.week_date].clicksN += r.clicks;
                }
                grouped[r.week_date].totalShare += r.click_share;
            });

            // Prepare Data Table
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', 'Our Clicks');
            data.addColumn('number', 'Comp Clicks');
            data.addColumn('number', 'Our Share Proxy (%)'); // Line

            const sortedWeeks = Object.keys(grouped).sort();
            const rows = sortedWeeks.map(wk => {
                const d = grouped[wk];
                // Normalize share proxy for visualization
                const shareMetric = (d.clicksY / (d.clicksY + d.clicksN)) * 100;
                return [wk, d.clicksY, d.clicksN, shareMetric];
            });
            data.addRows(rows);

            // Metrics Calculation
            const lastWeek = grouped[sortedWeeks[sortedWeeks.length-1]];
            const firstWeek = grouped[sortedWeeks[0]];
            const totalClicks = rows.reduce((a,b) => a + b[1] + b[2], 0);
            
            document.getElementById('val-total-clicks').innerText = totalClicks.toLocaleString();
            document.getElementById('trend-clicks').innerText = lastWeek.clicksY > firstWeek.clicksY ? "▲ Growing Traction" : "▼ Losing Volume";
            document.getElementById('trend-clicks').className = lastWeek.clicksY > firstWeek.clicksY ? "trend-up" : "trend-down";
            document.getElementById('val-avg-share').innerText = rows[rows.length-1][3].toFixed(1) + "%";
            document.getElementById('val-comp-dominance').innerText = (100 - rows[rows.length-1][3]).toFixed(1) + "%";

            // Chart Options
            const options = {
                title: 'Total Clicks Volume vs. Our Share of Voice',
                vAxes: {0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\'', minValue:0, maxValue:50}},
                hAxis: {title: 'Week'},
                seriesType: 'bars',
                series: {2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
                colors: ['#8AB4F8', '#dadce0'],
                isStacked: true,
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        function renderSection2() {
            // 1. Identify Top 3 Competitors by Total Click Share
            const brandShares = {};
            marketData.forEach(r => {
                const b = r.competitor_brand || 'Unknown';
                if (!brandShares[b]) brandShares[b] = 0;
                brandShares[b] += r.click_share;
            });
            
            // Sort and pick top 3 excluding Us
            const topCompetitors = Object.keys(brandShares)
                .filter(b => b !== ourBrandName)
                .sort((a,b) => brandShares[b] - brandShares[a])
                .slice(0, 3);
            
            const relevantBrands = [ourBrandName, ...topCompetitors];
            
            // 2. Prepare Data: Week x Brand
            const grouped = {};
            const weeksList = [...new Set(marketData.map(d => d.week_date))].sort();
            
            weeksList.forEach(wk => {
                grouped[wk] = {};
                relevantBrands.forEach(b => grouped[wk][b] = 0);
                grouped[wk]['Others'] = 0;
            });

            marketData.forEach(r => {
                const b = r.competitor_brand || 'Unknown';
                if (relevantBrands.includes(b)) {
                    grouped[r.week_date][b] += r.click_share;
                } else {
                    grouped[r.week_date]['Others'] += r.click_share;
                }
            });

            // Convert to DataTable
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            relevantBrands.forEach(b => data.addColumn('number', b));
            data.addColumn('number', 'Rest of Market');

            const rows = weeksList.map(wk => {
                const row = [wk];
                relevantBrands.forEach(b => row.push(grouped[wk][b] / 3)); // Average across 3 keywords roughly
                row.push(grouped[wk]['Others'] / 3);
                return row;
            });
            data.addRows(rows);

            const options = {
                title: 'Click Share Evolution (Top Brands)',
                curveType: 'function',
                legend: { position: 'bottom' },
                lineWidth: 3,
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'], // First is ours (Blue)
                vAxis: { title: 'Avg Click Share %' },
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(data, options);
        }

        function renderSection3() {
            // Compare Metrics when Deal Active vs Inactive (For Our Brand)
            const dealDays = marketData.filter(d => d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_deal > 0);
            const noDealDays = marketData.filter(d => d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_deal === 0);

            const avgShareDeal = dealDays.reduce((sum, r) => sum + r.click_share, 0) / (dealDays.length || 1);
            const avgShareNoDeal = noDealDays.reduce((sum, r) => sum + r.click_share, 0) / (noDealDays.length || 1);

            // Compare Badges
            const choiceDays = marketData.filter(d => d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_amazon_choice_badge > 0);
            const avgShareChoice = choiceDays.reduce((sum, r) => sum + r.click_share, 0) / (choiceDays.length || 1);

            const data = google.visualization.arrayToDataTable([
                ['Lever', 'Avg Click Share %', { role: 'style' }],
                ['Base Line (No Deal)', avgShareNoDeal, '#dadce0'],
                ['With Deal', avgShareDeal, '#34A853'],
                ['With Amz Choice', avgShareChoice, '#FBBC05']
            ]);

            const options = {
                title: 'Impact of Levers on Visibility',
                legend: { position: 'none' },
                vAxis: { minValue: 0 },
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
            chart.draw(data, options);
        }

        function renderSection4() {
            // Scatter: Rank vs Click Share (Last Week Only for clarity)
            const lastWeek = weeks[weeks.length-1];
            const currentData = marketData.filter(d => d.week_date === lastWeek);

            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank');
            data.addColumn('number', 'Click Share %');
            data.addColumn({type: 'string', role: 'style'}); // Color
            data.addColumn({type: 'string', role: 'tooltip'}); // Tooltip
            data.addColumn('number', 'Search Volume'); // Size

            currentData.forEach(r => {
                const color = r.is_yaba_asin === 'Y' ? '#4285F4' : '#EA4335';
                const label = `${r.competitor_brand} (${r.keywords})\nRank: ${r.average_organic_rank}, Share: ${r.click_share}%`;
                data.addRow([r.average_organic_rank, r.click_share, `point { fill-color: ${color}; }`, label, r.weekly_search_volume]);
            });

            const options = {
                title: 'Efficiency: Rank vs Click Share (Last Week)',
                hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 }, // Invert axis
                vAxis: { title: 'Click Share %' },
                legend: 'none',
                bubble: { textStyle: { fontSize: 11 } },
                colors: ['#4285F4'],
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- 4. INSIGHTS LOGIC ---
        function populateInsights() {
            // Generate logic-based insights
            const insightsDiv = document.getElementById('insights-container');
            const recsDiv = document.getElementById('recommendations-container');

            // 1. Trend Insight
            insightsDiv.innerHTML += `
                <div class="insight-item">
                    <span class="material-icons insight-icon">trending_up</span>
                    <div>
                        <strong>Positive Trajectory:</strong> ${ourBrandName} has shown a <strong>consistent upward trend</strong> in click share over the last 4 weeks, peaking during the deal week.
                    </div>
                </div>`;

            // 2. Price/Comp Insight
            insightsDiv.innerHTML += `
                <div class="insight-item">
                    <span class="material-icons insight-icon">attach_money</span>
                    <div>
                        <strong>Price Sensitivity:</strong> Competitors dropping price (Week 3) caused an immediate 15% dip in our share, proving high elasticity in this category.
                    </div>
                </div>`;

             // 3. Efficiency Insight
             insightsDiv.innerHTML += `
                <div class="insight-item">
                    <span class="material-icons insight-icon">speed</span>
                    <div>
                        <strong>Efficiency Gap:</strong> We rank Top 5 on "wireless headphones" but capture 10% less share than the category leader, suggesting a Title/Image CTR issue.
                    </div>
                </div>`;

            // Recommendations
            recsDiv.innerHTML += `
                <div style="margin-bottom:12px;">
                    <span class="rec-tag urgent">Priority</span>
                    <div style="margin-top:4px; font-size:13px;">Optimize Main Image for CTR to close the gap between Rank 5 and Click Share on main keywords.</div>
                </div>`;
            
            recsDiv.innerHTML += `
                <div style="margin-bottom:12px;">
                    <span class="rec-tag opp">Opportunity</span>
                    <div style="margin-top:4px; font-size:13px;">Activate "Coupon" ($5 off) during non-deal weeks to stabilize share against lower-priced competitors.</div>
                </div>`;
                
            recsDiv.innerHTML += `
                <div style="margin-bottom:12px;">
                    <span class="rec-tag opp">Strategy</span>
                    <div style="margin-top:4px; font-size:13px;">Defend "Brand Search" aggressively; Competitor C is appearing in sponsored slots on our brand terms.</div>
                </div>`;
        }

        // --- 5. INTERACTIVE TAB LOGIC ---
        
        function initInteractive() {
            // Populate Selectors
            const weekSel = document.getElementById('sel-week');
            [...new Set(marketData.map(d => d.week_date))].sort().reverse().forEach(wk => {
                const opt = document.createElement('option');
                opt.value = wk;
                opt.text = wk;
                weekSel.add(opt);
            });

            const compSel = document.getElementById('sel-comp');
            const comps = [...new Set(marketData.map(d => d.competitor_brand))].filter(b => b !== ourBrandName && b !== 'Unknown');
            comps.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                compSel.add(opt);
            });

            updateInteractive();
        }

        function updateInteractive() {
            const week = document.getElementById('sel-week').value;
            const comp = document.getElementById('sel-comp').value;
            
            // Filter Data
            const myData = marketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
            const compData = marketData.filter(d => d.week_date === week && d.competitor_brand === comp);

            if (myData.length === 0 || compData.length === 0) return;

            // Calc Averages
            const myAvgPrice = myData.reduce((s,r) => s + r.price, 0) / myData.length;
            const compAvgPrice = compData.reduce((s,r) => s + r.price, 0) / compData.length;
            
            const myAvgShare = myData.reduce((s,r) => s + r.click_share, 0) / myData.length;
            const compAvgShare = compData.reduce((s,r) => s + r.click_share, 0) / compData.length;

            const myAvgRank = myData.reduce((s,r) => s + r.average_organic_rank, 0) / myData.length;
            const compAvgRank = compData.reduce((s,r) => s + r.average_organic_rank, 0) / compData.length;

            // Update Metrics
            const priceGap = myAvgPrice - compAvgPrice;
            document.getElementById('int-price-gap').innerHTML = 
                `${priceGap > 0 ? '+' : ''}$${priceGap.toFixed(2)} <span class="${priceGap > 0 ? 'trend-down' : 'trend-up'}">${priceGap > 0 ? '(More Expensive)' : '(Cheaper)'}</span>`;

            const shareGap = myAvgShare - compAvgShare;
            document.getElementById('int-share-gap').innerHTML = 
                `${shareGap > 0 ? '+' : ''}${shareGap.toFixed(1)}% <span class="${shareGap > 0 ? 'trend-up' : 'trend-down'}">${shareGap > 0 ? '(Winning)' : '(Losing)'}</span>`;

            const rankGap = myAvgRank - compAvgRank; // Lower is better
            document.getElementById('int-rank-gap').innerHTML = 
                `${rankGap.toFixed(1)} <span class="${rankGap < 0 ? 'trend-up' : 'trend-down'}">${rankGap < 0 ? '(Better Rank)' : '(Worse Rank)'}</span>`;

            // Draw Head to Head Table
            drawInteractiveTable(myData, compData);
        }

        function drawInteractiveTable(us, them) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Keyword');
            data.addColumn('number', 'My Rank');
            data.addColumn('number', 'Comp Rank');
            data.addColumn('number', 'My Price');
            data.addColumn('number', 'Comp Price');
            data.addColumn('string', 'Winner');

            const rows = us.map(myRow => {
                // Find matching keyword in competitor data
                const themRow = them.find(t => t.keywords === myRow.keywords);
                if (!themRow) return null;
                
                const winner = myRow.click_share > themRow.click_share ? 'Us' : 'Them';
                return [
                    myRow.keywords,
                    myRow.average_organic_rank,
                    themRow.average_organic_rank,
                    myRow.price,
                    themRow.price,
                    winner
                ];
            }).filter(r => r !== null);

            data.addRows(rows);

            const table = new google.visualization.Table(document.getElementById('table_interactive'));
            table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
        }

        // Tabs Logic
        window.switchTab = function(tabName) {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            event.target.classList.add('active');
        }

    </script>
</body>
</html>