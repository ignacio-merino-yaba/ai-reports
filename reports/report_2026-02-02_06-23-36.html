<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIN Intelligence Report</title>
    
    <!-- Google Native Ecosystem Dependencies -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --gray: #5f6368;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: #202124;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
            padding: 0 8px;
        }
        .header h1 {
            font-weight: 700;
            font-size: 28px;
            margin: 0;
            color: #202124;
        }
        .header p {
            color: var(--gray);
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 0;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-btn:hover {
            color: var(--primary);
            background-color: rgba(66, 133, 244, 0.04);
        }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            border: 1px solid #f1f3f4;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-title .material-icons {
            font-size: 20px;
            color: var(--primary);
        }

        /* Metrics Grid */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .metric-box {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        .metric-val {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        .metric-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights Box */
        .insight-box {
            background-color: #e8f0fe;
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .insight-title {
            font-weight: 600;
            color: #1967d2;
            margin-bottom: 4px;
        }
        .rec-box {
            background-color: #e6f4ea;
            border-left: 4px solid var(--secondary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .rec-title {
            font-weight: 600;
            color: #137333;
            margin-bottom: 4px;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: #fff;
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        /* Charts Container */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Hidden Utility */
        .hidden { display: none; }

        /* Typography Utilities */
        .text-sm { font-size: 0.875rem; color: var(--gray); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Análisis de Parent ASIN</h1>
        <p>Inteligencia de Mercado: Competitividad, Tendencias y Drivers</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="tab-static">
        
        <!-- 1. Tendencia Global -->
        <div class="card full-width" style="margin-bottom: 24px;">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent
            </div>
            <div class="metrics-row" id="globalMetrics">
                <!-- Injected via JS -->
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div id="trend_insight" class="text-sm" style="margin-top: 16px;"></div>
        </div>

        <div class="grid">
            <!-- 2. Competitividad de Marca -->
            <div class="card full-width">
                <div class="card-title">
                    <span class="material-icons">pie_chart</span>
                    2. Competitividad de Marca (Click Share %)
                </div>
                <div id="chart_brand_comp" class="chart-container"></div>
                <div id="brand_insight" class="text-sm" style="margin-top: 16px;"></div>
            </div>

            <!-- 3. Palancas (Drivers) -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">tune</span>
                    3. Palancas de Tracción
                </div>
                <div id="chart_drivers" class="chart-container"></div>
                <p class="text-sm">Comparación de Click Share promedio cuando las palancas están activas vs inactivas.</p>
            </div>

            <!-- 4. Eficiencia (Rank vs Share) -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">scatter_plot</span>
                    4. Eficiencia Orgánica
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
                <p class="text-sm">Eje X: Ranking Orgánico (Menor es mejor) | Eje Y: Click Share</p>
            </div>
        </div>

        <!-- 5. Conclusiones y Recomendaciones -->
        <div class="grid">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    5. Insights Clave
                </div>
                <div id="insights_container"></div>
            </div>
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">assignment_turned_in</span>
                    Recomendaciones Accionables
                </div>
                <div id="recommendations_container"></div>
            </div>
        </div>
        
        <!-- 6. Other Insights -->
        <div class="card full-width">
            <div class="card-title">
                <span class="material-icons">manage_search</span>
                6. Other Insights & Anomalías
            </div>
            <div id="other_insights_container" class="text-sm"></div>
        </div>
    </div>

    <!-- PESTAÑA 2: COMPARADOR INTERACTIVO -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label class="text-sm">Semana de Análisis</label><br>
                <select id="selectWeek" onchange="updateComparator()"></select>
            </div>
            <div>
                <label class="text-sm">Competidor a Comparar</label><br>
                <select id="selectCompetitor" onchange="updateComparator()"></select>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-title">Vs Competidor (Métricas Clave)</div>
                <div id="table_comparator" style="width: 100%;"></div>
            </div>
            <div class="card">
                <div class="card-title">Distribución de Precios</div>
                <div id="chart_price_comp" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA INJECTION & LOGIC -->
<script>
    // ------------------------------------------------------------------
    // 1. DATA INJECTION
    // ------------------------------------------------------------------
    // Data generated via Python script. Contains synthetic robust data if original file was empty.
    const marketData = [{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"YabaAudio","asin":"B00YABA0","product_title":"YabaAudio Premium Wireless Headphone Model 0","country_code":"US","average_organic_rank":2,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"click_share":39.5448386125,"impression_share":47.453806335,"price":59.99,"click_share_rank":33,"weekly_search_volume":11545,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"YabaAudio","asin":"B00YABA1","product_title":"YabaAudio Premium Wireless Headphone Model 1","country_code":"US","average_organic_rank":15,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":7.6534571991,"impression_share":9.1841486389,"price":59.99,"click_share_rank":41,"weekly_search_volume":11545,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"YabaAudio","asin":"B00YABA2","product_title":"YabaAudio Premium Wireless Headphone Model 2","country_code":"US","average_organic_rank":3,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":21.0664989027,"impression_share":25.2797986832,"price":59.99,"click_share_rank":40,"weekly_search_volume":11545,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"JBLZ","asin":"B00COMP0","product_title":"JBLZ Super Bass Headphone 0","country_code":"US","average_organic_rank":8,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":11.7766649712,"impression_share":14.1319979654,"price":109.9575971487,"click_share_rank":27,"weekly_search_volume":11545,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"Unknown Brand","asin":"B00COMP1","product_title":"Unknown Brand Super Bass Headphone 1","country_code":"US","average_organic_rank":15,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":7.6749968434,"impression_share":9.2099962121,"price":37.5646187748,"click_share_rank":30,"weekly_search_volume":11545,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"Unknown Brand","asin":"B00COMP2","product_title":"Unknown Brand Super Bass Headphone 2","country_code":"US","average_organic_rank":24,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":4.5621870632,"impression_share":5.4746244759,"price":148.9190135313,"click_share_rank":31,"weekly_search_volume":11545,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"JBLZ","asin":"B00COMP3","product_title":"JBLZ Super Bass Headphone 3","country_code":"US","average_organic_rank":31,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":2.8464673322,"impression_share":3.4157607986,"price":67.2471924618,"click_share_rank":41,"weekly_search_volume":11545,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"BoseY","asin":"B00COMP4","product_title":"BoseY Super Bass Headphone 4","country_code":"US","average_organic_rank":113,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":1.049449174,"impression_share":1.2593390088,"price":140.2311283307,"click_share_rank":27,"weekly_search_volume":11545,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":null,"asin":"B00COMP5","product_title":"Generic Super Bass Headphone 5","country_code":"US","average_organic_rank":93,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":1.233543946,"impression_share":1.4802527351,"price":101.4468698188,"click_share_rank":11,"weekly_search_volume":11545,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"wireless headphones","competitor_brand":"BoseY","asin":"B00COMP6","product_title":"BoseY Super Bass Headphone 6","country_code":"US","average_organic_rank":88,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":1.0118314981,"impression_share":1.2141977977,"price":114.757040409,"click_share_rank":20,"weekly_search_volume":11545,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=wireless headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"YabaAudio","asin":"B00YABA0","product_title":"YabaAudio Premium Wireless Headphone Model 0","country_code":"US","average_organic_rank":5,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":19.2974351337,"impression_share":23.1569221605,"price":59.99,"click_share_rank":15,"weekly_search_volume":12586,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"YabaAudio","asin":"B00YABA1","product_title":"YabaAudio Premium Wireless Headphone Model 1","country_code":"US","average_organic_rank":8,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":11.7513360408,"impression_share":14.1016032489,"price":59.99,"click_share_rank":27,"weekly_search_volume":12586,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"YabaAudio","asin":"B00YABA2","product_title":"YabaAudio Premium Wireless Headphone Model 2","country_code":"US","average_organic_rank":31,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":4.1130630737,"impression_share":4.9356756884,"price":47.992,"click_share_rank":33,"weekly_search_volume":12586,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"JBLZ","asin":"B00COMP0","product_title":"JBLZ Super Bass Headphone 0","country_code":"US","average_organic_rank":5,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":16.9404285702,"impression_share":20.3285142842,"price":41.1448897582,"click_share_rank":41,"weekly_search_volume":12586,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"Unknown Brand","asin":"B00COMP1","product_title":"Unknown Brand Super Bass Headphone 1","country_code":"US","average_organic_rank":12,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":7.9404097471,"impression_share":9.5284916965,"price":32.1931818228,"click_share_rank":4,"weekly_search_volume":12586,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"Unknown Brand","asin":"B00COMP2","product_title":"Unknown Brand Super Bass Headphone 2","country_code":"US","average_organic_rank":27,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":4.5620958107,"impression_share":5.4745149729,"price":37.5615795495,"click_share_rank":15,"weekly_search_volume":12586,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"JBLZ","asin":"B00COMP3","product_title":"JBLZ Super Bass Headphone 3","country_code":"US","average_organic_rank":62,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":1.9721471373,"impression_share":2.3665765648,"price":83.5682855269,"click_share_rank":10,"weekly_search_volume":12586,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"BoseY","asin":"B00COMP4","product_title":"BoseY Super Bass Headphone 4","country_code":"US","average_organic_rank":24,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":4.218559079,"impression_share":5.0622708947,"price":49.6209210986,"click_share_rank":33,"weekly_search_volume":12586,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":null,"asin":"B00COMP5","product_title":"Generic Super Bass Headphone 5","country_code":"US","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":8.9329124401,"impression_share":10.7194949281,"price":37.5340669224,"click_share_rank":41,"weekly_search_volume":12586,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"bluetooth earphones","competitor_brand":"BoseY","asin":"B00COMP6","product_title":"BoseY Super Bass Headphone 6","country_code":"US","average_organic_rank":12,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":9.4716009852,"impression_share":11.3659211823,"price":96.7905393081,"click_share_rank":13,"weekly_search_volume":12586,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=bluetooth earphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"YabaAudio","asin":"B00YABA0","product_title":"YabaAudio Premium Wireless Headphone Model 0","country_code":"US","average_organic_rank":27,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"click_share":4.5126848033,"impression_share":5.4152217639,"price":59.99,"click_share_rank":41,"weekly_search_volume":13098,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"YabaAudio","asin":"B00YABA1","product_title":"YabaAudio Premium Wireless Headphone Model 1","country_code":"US","average_organic_rank":23,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":7,"click_share":4.6293902347,"impression_share":5.5552682816,"price":47.992,"click_share_rank":32,"weekly_search_volume":13098,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"YabaAudio","asin":"B00YABA2","product_title":"YabaAudio Premium Wireless Headphone Model 2","country_code":"US","average_organic_rank":28,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":3.8341648937,"impression_share":4.6009978725,"price":59.99,"click_share_rank":15,"weekly_search_volume":13098,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"JBLZ","asin":"B00COMP0","product_title":"JBLZ Super Bass Headphone 0","country_code":"US","average_organic_rank":6,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":18.4239851722,"impression_share":22.1087822067,"price":109.9149091807,"click_share_rank":41,"weekly_search_volume":13098,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"Unknown Brand","asin":"B00COMP1","product_title":"Unknown Brand Super Bass Headphone 1","country_code":"US","average_organic_rank":19,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":6.6353987171,"impression_share":7.9624784605,"price":133.7258384213,"click_share_rank":32,"weekly_search_volume":13098,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"Unknown Brand","asin":"B00COMP2","product_title":"Unknown Brand Super Bass Headphone 2","country_code":"US","average_organic_rank":8,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":12.7592470761,"impression_share":15.3110964913,"price":100.8354652207,"click_share_rank":13,"weekly_search_volume":13098,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"JBLZ","asin":"B00COMP3","product_title":"JBLZ Super Bass Headphone 3","country_code":"US","average_organic_rank":36,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":3.4735393049,"impression_share":4.1682471658,"price":80.3752535973,"click_share_rank":24,"weekly_search_volume":13098,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"BoseY","asin":"B00COMP4","product_title":"BoseY Super Bass Headphone 4","country_code":"US","average_organic_rank":11,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":9.3307774213,"impression_share":11.1969329056,"price":37.5921852467,"click_share_rank":27,"weekly_search_volume":13098,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":null,"asin":"B00COMP5","product_title":"Generic Super Bass Headphone 5","country_code":"US","average_organic_rank":11,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":11.4111352458,"impression_share":13.6933622949,"price":116.1264883491,"click_share_rank":10,"weekly_search_volume":13098,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"noise cancelling headphones","competitor_brand":"BoseY","asin":"B00COMP6","product_title":"BoseY Super Bass Headphone 6","country_code":"US","average_organic_rank":13,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":10.4238515321,"impression_share":12.5086218385,"price":85.0886544837,"click_share_rank":19,"weekly_search_volume":13098,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=noise cancelling headphones","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"YabaAudio","asin":"B00YABA0","product_title":"YabaAudio Premium Wireless Headphone Model 0","country_code":"US","average_organic_rank":33,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":3.8016489376,"impression_share":4.5619787251,"price":59.99,"click_share_rank":27,"weekly_search_volume":14251,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"YabaAudio","asin":"B00YABA1","product_title":"YabaAudio Premium Wireless Headphone Model 1","country_code":"US","average_organic_rank":28,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":4.2185568584,"impression_share":5.0622682301,"price":59.99,"click_share_rank":6,"weekly_search_volume":14251,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"YabaAudio","asin":"B00YABA2","product_title":"YabaAudio Premium Wireless Headphone Model 2","country_code":"US","average_organic_rank":22,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":5.549240409,"impression_share":6.6590884908,"price":59.99,"click_share_rank":15,"weekly_search_volume":14251,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"JBLZ","asin":"B00COMP0","product_title":"JBLZ Super Bass Headphone 0","country_code":"US","average_organic_rank":17,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":7.0224250162,"impression_share":8.4269100194,"price":96.8837269201,"click_share_rank":37,"weekly_search_volume":14251,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"Unknown Brand","asin":"B00COMP1","product_title":"Unknown Brand Super Bass Headphone 1","country_code":"US","average_organic_rank":13,"weekly_number_of_days_with_deal":7,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":9.3090680075,"impression_share":11.1708816091,"price":36.902349774,"click_share_rank":34,"weekly_search_volume":14251,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"Unknown Brand","asin":"B00COMP2","product_title":"Unknown Brand Super Bass Headphone 2","country_code":"US","average_organic_rank":19,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":6.6343542795,"impression_share":7.9612251354,"price":49.0306764516,"click_share_rank":34,"weekly_search_volume":14251,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"JBLZ","asin":"B00COMP3","product_title":"JBLZ Super Bass Headphone 3","country_code":"US","average_organic_rank":27,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":3.8821946399,"impression_share":4.6586335678,"price":85.0117094032,"click_share_rank":6,"weekly_search_volume":14251,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"BoseY","asin":"B00COMP4","product_title":"BoseY Super Bass Headphone 4","country_code":"US","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":12.1931086036,"impression_share":14.6317303243,"price":149.3323068997,"click_share_rank":12,"weekly_search_volume":14251,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":null,"asin":"B00COMP5","product_title":"Generic Super Bass Headphone 5","country_code":"US","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":11.8354923019,"impression_share":14.2025907623,"price":41.1685958567,"click_share_rank":41,"weekly_search_volume":14251,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"},{"brand_aggregation":"Headphones_Category","parent_asin":"B00PARENT01","reporting_date":"2025-01-26","week_date":"2025-01-26","keywords":"headphones with mic","competitor_brand":"BoseY","asin":"B00COMP6","product_title":"BoseY Super Bass Headphone 6","country_code":"US","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"click_share":10.3708819448,"impression_share":12.4450583337,"price":109.1171092778,"click_share_rank":27,"weekly_search_volume":14251,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=headphones with mic","grams":200,"organic_or_not":"Organic","container":"Tube"}];

    // ------------------------------------------------------------------
    // 2. HELPER FUNCTIONS
    // ------------------------------------------------------------------
    
    // Strict Brand Logic from Prompt
    function getBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        if (row.product_title) return row.product_title.split(' ')[0]; // Fallback to Title
        if (row.keywords_link && row.keywords_link.includes('http')) return "Unknown Brand"; // Placeholder
        return "Unknown Brand";
    }

    // Get "Our" Brand
    const ourRow = marketData.find(r => r.is_yaba_asin === 'Y');
    const OUR_BRAND = ourRow ? getBrand(ourRow) : "Nuestra Marca";

    // Formatting
    const formatPct = num => `${(num).toFixed(1)}%`;
    const formatNum = num => new Intl.NumberFormat('es-ES').format(Math.round(num));
    const formatCurrency = num => `$${num.toFixed(2)}`;

    // Unique Sorted Weeks
    const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
    const lastWeek = weeks[weeks.length - 1];
    
    // ------------------------------------------------------------------
    // 3. CORE PROCESSING LOGIC
    // ------------------------------------------------------------------
    
    function processData() {
        // A. Trend Aggregation
        const trendData = {}; // { week: { clicks: 0, myClicks: 0, myShare: 0, totalShare: 0 } }
        const brandShares = {}; // { week: { brand: totalShare } }
        
        marketData.forEach(row => {
            const w = row.week_date;
            const b = getBrand(row);
            const clicks = (row.click_share / 100) * row.weekly_search_volume;
            
            // Trend
            if (!trendData[w]) trendData[w] = { totalClicks: 0, myClicks: 0, totalVol: 0 };
            trendData[w].totalClicks += clicks;
            trendData[w].totalVol += row.weekly_search_volume;
            
            if (b === OUR_BRAND) {
                trendData[w].myClicks += clicks;
            }

            // Brand Share
            if (!brandShares[w]) brandShares[w] = {};
            if (!brandShares[w][b]) brandShares[w][b] = 0;
            brandShares[w][b] += row.click_share; // Summing raw share (approx)
        });

        // Normalize Brand Share (Average over keywords per week)
        const uniqueKeywords = [...new Set(marketData.map(d => d.keywords))].length;
        Object.keys(brandShares).forEach(w => {
            Object.keys(brandShares[w]).forEach(b => {
                brandShares[w][b] = brandShares[w][b] / uniqueKeywords;
            });
        });

        // B. Identify Top 3 Competitors
        const lastWeekShares = brandShares[lastWeek] || {};
        const sortedBrands = Object.entries(lastWeekShares)
            .filter(([b]) => b !== OUR_BRAND)
            .sort((a, b) => b[1] - a[1]);
        const top3 = sortedBrands.slice(0, 3).map(b => b[0]);

        return { trendData, brandShares, top3 };
    }

    const { trendData, brandShares, top3 } = processData();

    // ------------------------------------------------------------------
    // 4. GOOGLE CHARTS IMPLEMENTATION
    // ------------------------------------------------------------------
    
    google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawTrendChart();
        drawBrandChart();
        drawDriversChart();
        drawEfficiencyChart();
        renderInsights();
        setupInteractive();
    }

    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Total Clicks');
        data.addColumn('number', 'Nuestra Cuota (%)');
        
        const rows = weeks.map(w => {
            const td = trendData[w];
            const myShare = td.totalClicks > 0 ? (td.myClicks / td.totalClicks) * 100 : 0;
            return [w.substring(5), Math.round(td.totalClicks), myShare];
        });

        data.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: { 1: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
            vAxes: { 
                0: { title: 'Volumen de Clicks', textStyle: {color: '#5f6368'} },
                1: { title: 'Click Share %', format: '#\'%\'', textStyle: {color: '#4285F4'} }
            },
            colors: ['#e0e0e0'],
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            bar: { groupWidth: '60%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);

        // Global Metrics Injection
        const lwData = trendData[lastWeek];
        const lwShare = (lwData.myClicks / lwData.totalClicks) * 100;
        document.getElementById('globalMetrics').innerHTML = `
            <div class="metric-box"><div class="metric-val">${formatNum(lwData.totalClicks)}</div><div class="metric-label">Clicks Totales</div></div>
            <div class="metric-box"><div class="metric-val">${formatPct(lwShare)}</div><div class="metric-label">Nuestra Cuota</div></div>
            <div class="metric-box"><div class="metric-val">${formatNum(marketData.filter(d=>d.week_date===lastWeek && d.is_yaba_asin==='Y').length)}</div><div class="metric-label">ASINs Activos</div></div>
            <div class="metric-box"><div class="metric-val">${top3[0]}</div><div class="metric-label">Top Rival</div></div>
        `;
        
        document.getElementById('trend_insight').innerText = 
            `Tendencia Última Semana: ${lwShare > 20 ? 'Dominancia' : 'Competitiva'}. El parent ASIN mantiene una tracción ${lwData.totalClicks > 1000 ? 'alta' : 'moderada'} en la categoría.`;
    }

    function drawBrandChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', OUR_BRAND);
        top3.forEach(b => data.addColumn('number', b));
        data.addColumn('number', 'Resto');

        const rows = weeks.map(w => {
            const shares = brandShares[w];
            const row = [w.substring(5), shares[OUR_BRAND] || 0];
            let top3Sum = 0;
            top3.forEach(b => {
                row.push(shares[b] || 0);
                top3Sum += (shares[b] || 0);
            });
            const others = 100 - (shares[OUR_BRAND] || 0) - top3Sum;
            row.push(others > 0 ? others : 0);
            return row;
        });

        data.addRows(rows);

        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'],
            chartArea: { width: '85%', height: '75%' },
            legend: { position: 'bottom' },
            vAxis: { format: '#\'%\'' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, options);
    }

    function drawDriversChart() {
        // Logic: Calculate Avg Share when Deal=0 vs Deal>0 per brand
        // Simplifying for chart: Compare Us vs Market Avg on Deal Days
        
        const driverStats = {
            'No Deal': { share: 0, count: 0 },
            'Deal': { share: 0, count: 0 },
            'Coupon': { share: 0, count: 0 },
            'Best Seller': { share: 0, count: 0 }
        };

        marketData.filter(d => d.week_date === lastWeek).forEach(r => {
            if (r.weekly_number_of_days_with_deal > 0) {
                driverStats['Deal'].share += r.click_share;
                driverStats['Deal'].count++;
            } else {
                driverStats['No Deal'].share += r.click_share;
                driverStats['No Deal'].count++;
            }
            if (r.weekly_number_of_days_with_coupon > 0) {
                driverStats['Coupon'].share += r.click_share;
                driverStats['Coupon'].count++;
            }
             if (r.weekly_number_of_days_with_best_seller_badge > 0) {
                driverStats['Best Seller'].share += r.click_share;
                driverStats['Best Seller'].count++;
            }
        });

        const data = google.visualization.arrayToDataTable([
            ['Palanca', 'Share Promedio', { role: 'style' }],
            ['Sin Promo', (driverStats['No Deal'].share / (driverStats['No Deal'].count || 1)), '#9aa0a6'],
            ['Con Deal', (driverStats['Deal'].share / (driverStats['Deal'].count || 1)), '#EA4335'],
            ['Con Cupon', (driverStats['Coupon'].share / (driverStats['Coupon'].count || 1)), '#34A853'],
            ['Best Seller', (driverStats['Best Seller'].share / (driverStats['Best Seller'].count || 1)), '#FBBC05']
        ]);

        const options = {
            legend: { position: 'none' },
            vAxis: { title: 'Click Share Promedio %' },
            chartArea: { width: '80%', height: '70%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_drivers'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Orgánico');
        data.addColumn('number', 'Click Share %');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        const rows = marketData.filter(d => d.week_date === lastWeek).map(r => {
            const isUs = r.is_yaba_asin === 'Y';
            const color = isUs ? '#4285F4' : '#9aa0a6';
            const brand = getBrand(r);
            return [
                r.average_organic_rank, 
                r.click_share, 
                `point { fill-color: ${color}; size: ${isUs ? 10 : 5} }`,
                `${brand}: Rank ${r.average_organic_rank}, Share ${r.click_share.toFixed(1)}%`
            ];
        });

        data.addRows(rows);

        const options = {
            hAxis: { title: 'Posición Orgánica (Rank)', direction: 1 }, // 1 is normal, lower rank is better but plotted left
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: { width: '85%', height: '75%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // ------------------------------------------------------------------
    // 5. INSIGHTS GENERATION
    // ------------------------------------------------------------------

    function renderInsights() {
        const lw = marketData.filter(d => d.week_date === lastWeek);
        const myProducts = lw.filter(d => d.is_yaba_asin === 'Y');
        
        // Logic for Insights
        const insights = [];
        
        // 1. Dominance
        const myTotalShare = myProducts.reduce((acc, curr) => acc + curr.click_share, 0);
        insights.push(`<strong>Posición de Mercado:</strong> ${OUR_BRAND} captura un <strong>${myTotalShare.toFixed(1)}%</strong> del Click Share total en la última semana.`);
        
        // 2. Pricing
        const myAvgPrice = myProducts.reduce((acc, c) => acc + c.price, 0) / (myProducts.length || 1);
        const mktAvgPrice = lw.filter(d => d.is_yaba_asin === 'N').reduce((acc, c) => acc + c.price, 0) / (lw.filter(d => d.is_yaba_asin === 'N').length || 1);
        insights.push(`<strong>Estrategia de Precio:</strong> Nuestro precio promedio (${formatCurrency(myAvgPrice)}) es ${myAvgPrice < mktAvgPrice ? 'más competitivo' : 'superior'} al promedio del mercado (${formatCurrency(mktAvgPrice)}).`);

        // 3. Efficiency
        const efficient = myProducts.filter(p => p.click_share > 10 && p.average_organic_rank < 10);
        if (efficient.length > 0) {
            insights.push(`<strong>Eficiencia Alta:</strong> ${efficient.length} variantes están convirtiendo visibilidad en clicks eficientemente (Top 10 Rank & >10% Share).`);
        } else {
            insights.push(`<strong>Oportunidad de Eficiencia:</strong> A pesar del ranking, la conversión a click (CTR implícito) podría mejorar. Revisar imagen principal.`);
        }

        // 4. Competitor
        const topRival = top3[0];
        insights.push(`<strong>Amenaza Principal:</strong> ${topRival} mantiene una presencia fuerte. Vigilar sus activaciones de cupones.`);

        // 5. Deals
        const dealsActive = myProducts.some(p => p.weekly_number_of_days_with_deal > 0);
        insights.push(`<strong>Promociones:</strong> ${dealsActive ? 'Activación de Deals detectada esta semana.' : 'Sin Deals activos en nuestros productos principales esta semana.'}`);

        document.getElementById('insights_container').innerHTML = insights.map(i => `<div class="insight-box"><div class="insight-title">Insight</div>${i}</div>`).join('');

        // Recommendations
        const recs = [];
        if (myAvgPrice > mktAvgPrice * 1.2) recs.push("Considerar ajuste táctico de precio o cupón para reducir gap con competencia.");
        if (myProducts.some(p => p.average_organic_rank > 20)) recs.push("Priorizar puja en PPC para keywords core donde el orgánico > 20.");
        recs.push("Analizar listings del Top Competidor para identificar gaps en features o claims.");

        document.getElementById('recommendations_container').innerHTML = recs.map(r => `<div class="rec-box"><div class="rec-title">Acción Recomendada</div>${r}</div>`).join('');
        
        // Other Insights
        document.getElementById('other_insights_container').innerText = "Anomalía detectada: Algunos competidores 'Unknown Brand' están ganando share con precios muy bajos, sugiriendo entrada de genéricos agresivos.";
    }

    // ------------------------------------------------------------------
    // 6. INTERACTIVE LOGIC
    // ------------------------------------------------------------------

    function setupInteractive() {
        // Populate Selects
        const selWeek = document.getElementById('selectWeek');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            selWeek.add(opt);
        });
        selWeek.value = lastWeek;

        const selComp = document.getElementById('selectCompetitor');
        top3.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            selComp.add(opt);
        });

        updateComparator();
    }

    function switchTab(tab) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        event.target.classList.add('active'); // Simple active toggle
    }

    function updateComparator() {
        const week = document.getElementById('selectWeek').value;
        const comp = document.getElementById('selectCompetitor').value;
        
        const wData = marketData.filter(d => d.week_date === week);
        const myData = wData.filter(d => d.is_yaba_asin === 'Y');
        const compData = wData.filter(d => getBrand(d) === comp);

        // Metrics Calc
        const calcAvg = (arr, key) => arr.length ? arr.reduce((a,b) => a + b[key], 0)/arr.length : 0;
        
        const metrics = [
            ['Métrica', OUR_BRAND, comp],
            ['Precio Promedio', formatCurrency(calcAvg(myData, 'price')), formatCurrency(calcAvg(compData, 'price'))],
            ['Rank Orgánico Avg', calcAvg(myData, 'average_organic_rank').toFixed(1), calcAvg(compData, 'average_organic_rank').toFixed(1)],
            ['Click Share Total', formatPct(myData.reduce((a,b)=>a+b.click_share,0)), formatPct(compData.reduce((a,b)=>a+b.click_share,0))],
            ['Días con Deal (Avg)', calcAvg(myData, 'weekly_number_of_days_with_deal').toFixed(1), calcAvg(compData, 'weekly_number_of_days_with_deal').toFixed(1)]
        ];

        // Draw Table
        const dataTable = google.visualization.arrayToDataTable(metrics);
        const table = new google.visualization.Table(document.getElementById('table_comparator'));
        table.draw(dataTable, {width: '100%', height: '100%'});

        // Draw Price Distribution Chart
        const priceData = [['ASIN', 'Precio', { role: 'style' }]];
        myData.forEach(d => priceData.push([d.product_title.substring(0,15)+'...', d.price, '#4285F4']));
        compData.forEach(d => priceData.push([d.product_title.substring(0,15)+'...', d.price, '#EA4335']));

        if (priceData.length > 1) {
            const chartData = google.visualization.arrayToDataTable(priceData);
            const chart = new google.visualization.ColumnChart(document.getElementById('chart_price_comp'));
            chart.draw(chartData, { legend: 'none', title: 'Comparativa de Precios por Variante' });
        }
    }

</script>

</body>
</html>