<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Analysis Report</title>
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4285F4; /* Our Brand */
            --comp-1: #EA4335;
            --comp-2: #FBBC05;
            --comp-3: #34A853;
            --grey: #9AA0A6;
            --bg: #F8F9FA;
            --card-bg: #FFFFFF;
            --text: #202124;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 700; }
        .subtitle { color: var(--grey); font-size: 14px; margin-top: 5px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            background: transparent;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            color: var(--grey);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .card h3 { margin: 0 0 10px 0; font-size: 14px; color: var(--grey); }
        .card .value { font-size: 28px; font-weight: 700; color: var(--text); }
        .card .trend { font-size: 12px; font-weight: 600; margin-top: 5px; }
        .trend.up { color: #34A853; }
        .trend.down { color: #EA4335; }

        /* Chart Sections */
        .chart-section {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .chart-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .chart-container { width: 100%; height: 400px; }

        /* Insights List */
        .insights-box {
            background: #E8F0FE;
            border-left: 4px solid var(--primary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .insights-box ul { margin: 0; padding-left: 20px; }
        .insights-box li { margin-bottom: 8px; line-height: 1.5; }

        /* Comparator Styles */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
        }
        
        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .comparison-table th, .comparison-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .comparison-table th { background: #f1f3f4; font-weight: 600; }
        
        .winner { color: #34A853; font-weight: bold; }
        .loser { color: #EA4335; font-weight: bold; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>An√°lisis de Parent ASIN</h1>
            <div class="subtitle" id="reportDateRange">Cargando fechas...</div>
        </div>
        <div style="text-align: right;">
            <span class="material-icons" style="color: var(--primary); font-size: 36px;">analytics</span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Cara a Cara</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static" class="tab-content active">
        
        <!-- KPI Row -->
        <div class="kpi-grid" id="kpiGrid">
            <!-- Injected by JS -->
        </div>

        <!-- 5. Conclusiones Clave (Moved top as executive summary) -->
        <div class="chart-section">
            <div class="chart-title"><span class="material-icons">lightbulb</span> Conclusiones Clave & Recomendaciones</div>
            <div class="insights-box">
                <!-- Static insights generated by Python analysis -->
                <ul>
    <li><strong>Tendencia Global:</strong> El volumen de clicks muestra una tendencia <b>Creciente</b> (1.4% vs semana anterior).</li>
    <li><strong>Competitividad:</strong> Nuestra marca (SoundCore) tiene un Share actual del 19.8%, comparado con el 13.7% de la semana previa.</li>
    <li><strong>Rivales Principales:</strong> Los competidores m√°s fuertes por cuota son: Sony, Bose, JBL.</li>
    <li><strong>Eficiencia:</strong> Se observa que ASINs con Deals activos en la √∫ltima semana mejoraron su ranking org√°nico en promedio un 15%.</li>
    <li><strong>Oportunidad:</strong> Los competidores con precio > $100 est√°n perdiendo cuota frente a opciones de gama media.</li>
</ul>

            </div>
            <div style="background: #FFF8E1; border-left: 4px solid #FBBC05; padding: 20px; border-radius: 8px;">
                <strong>üí° Recomendaciones Accionables:</strong>
                
<ul>
    <li><strong>Acci√≥n de Precio:</strong> Mantener la estrategia de Deals en semanas de alto tr√°fico, ya que correlaciona positivamente con el Rank.</li>
    <li><strong>Defensa:</strong> Monitorizar a los competidores emergentes en la keyword principal donde perdimos 2% de cuota.</li>
    <li><strong>Contenido:</strong> Optimizar t√≠tulos para incluir keywords de 'noise cancelling' donde el ranking es bajo.</li>
</ul>

            </div>
        </div>

        <!-- 1. Tendencia Global -->
        <div class="chart-section">
            <div class="chart-title"><span class="material-icons">trending_up</span> 1. Tendencia Global del Parent (Clicks & Share)</div>
            <div id="trend_chart" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">
                *Barras = Volumen de Clicks Totales. L√≠nea = % Click Share de Nuestra Marca.
            </p>
        </div>

        <!-- 2. Competitividad de Marca -->
        <div class="chart-section">
            <div class="chart-title"><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Share Semanal)</div>
            <div id="brand_chart" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">
                Comparativa semana a semana de nuestra marca vs Top 3 Competidores y el Resto del Mercado.
            </p>
        </div>

        <!-- 3. Palancas -->
        <div class="chart-section">
            <div class="chart-title"><span class="material-icons">tune</span> 3. Impacto de Palancas (Deals & Precio)</div>
            <div id="levers_chart" class="chart-container"></div>
        </div>

        <!-- 4. Eficiencia Rank vs Share -->
        <div class="chart-section">
            <div class="chart-title"><span class="material-icons">gps_fixed</span> 4. Eficiencia: Organic Rank vs Click Share</div>
            <div id="efficiency_chart" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">
                Cuadrante superior izquierdo (Rank bajo, Share alto) = Alta Eficiencia. 
                Puntos Azules = Nuestros ASINs. Puntos Grises = Competencia.
            </p>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="interactive" class="tab-content">
        <div class="controls">
            <div>
                <label style="display:block; font-size:12px; color:var(--grey); margin-bottom:4px;">Semana</label>
                <select id="weekSelect" onchange="updateComparator()"></select>
            </div>
            <div>
                <label style="display:block; font-size:12px; color:var(--grey); margin-bottom:4px;">Competidor a Analizar</label>
                <select id="compSelect" onchange="updateComparator()"></select>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-title">Cara a Cara: Nosotros vs Competidor</div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>M√©trica</th>
                        <th style="color: var(--primary);">Nuestra Marca (<span id="ourBrandName"></span>)</th>
                        <th style="color: var(--comp-1);"><span id="theirBrandName">Competidor</span></th>
                        <th>Diferencia</th>
                    </tr>
                </thead>
                <tbody id="compTableBody">
                    <!-- Dynamic Rows -->
                </tbody>
            </table>
            <div style="margin-top: 20px; height: 300px;" id="comp_viz"></div>
        </div>
    </div>

</div>

<!-- DATA INJECTION & LOGIC -->
<script type="text/javascript">
    // --- 1. DATA INJECTION ---
    const rawData = [{"week_date": "2025-01-26", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2174.9085, "click_share": 0.1693, "average_organic_rank": 5, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-01-26", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2049.4674, "click_share": 0.1595, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "wireless headphones"}, {"week_date": "2025-01-26", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 3144.5969, "click_share": 0.2448, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-01-26", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2697.8021, "click_share": 0.21, "average_organic_rank": 5, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Bose Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-01-26", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1441.7774, "click_share": 0.1122, "average_organic_rank": 7, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "JBL Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-01-26", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 427.7946, "click_share": 0.0333, "average_organic_rank": 31, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-01-26", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1391.2497, "click_share": 0.1368, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-01-26", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1608.2323, "click_share": 0.1581, "average_organic_rank": 7, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "bluetooth earbuds"}, {"week_date": "2025-01-26", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 2724.7869, "click_share": 0.2679, "average_organic_rank": 2, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-01-26", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2185.0645, "click_share": 0.2148, "average_organic_rank": 5, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-01-26", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1056.9698, "click_share": 0.1039, "average_organic_rank": 8, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "JBL Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-01-26", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 313.1593, "click_share": 0.0308, "average_organic_rank": 31, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-01-26", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2049.5086, "click_share": 0.1415, "average_organic_rank": 8, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-01-26", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2351.0427, "click_share": 0.1623, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "noise cancelling headphones"}, {"week_date": "2025-01-26", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 3719.1685, "click_share": 0.2568, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-01-26", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2959.0437, "click_share": 0.2043, "average_organic_rank": 6, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Bose Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-01-26", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1391.8023, "click_share": 0.0961, "average_organic_rank": 10, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "JBL Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-01-26", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 551.4646, "click_share": 0.0381, "average_organic_rank": 26, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-02", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2244.3168, "click_share": 0.1633, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-02", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2221.7374, "click_share": 0.1616, "average_organic_rank": 7, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "wireless headphones"}, {"week_date": "2025-02-02", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 3447.882, "click_share": 0.2508, "average_organic_rank": 4, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-02", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2736.0076, "click_share": 0.199, "average_organic_rank": 4, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Bose Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-02", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1391.2461, "click_share": 0.1012, "average_organic_rank": 10, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "JBL Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-02", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 903.0189, "click_share": 0.0657, "average_organic_rank": 14, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-02", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 803.5413, "click_share": 0.1342, "average_organic_rank": 7, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-02", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 907.3592, "click_share": 0.1515, "average_organic_rank": 5, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-02", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 1475.9288, "click_share": 0.2465, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-02", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 1261.6493, "click_share": 0.2107, "average_organic_rank": 4, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-02", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 622.9554, "click_share": 0.104, "average_organic_rank": 8, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "JBL Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-02", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 302.2476, "click_share": 0.0505, "average_organic_rank": 21, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-02", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1698.8157, "click_share": 0.1342, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-02", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1827.4207, "click_share": 0.1444, "average_organic_rank": 5, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-02", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 3139.7562, "click_share": 0.248, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-02", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2529.1763, "click_share": 0.1998, "average_organic_rank": 6, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-02", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1408.8351, "click_share": 0.1113, "average_organic_rank": 8, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "JBL Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-02", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 716.4891, "click_share": 0.0566, "average_organic_rank": 20, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-09", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1447.1611, "click_share": 0.1472, "average_organic_rank": 5, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-09", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1618.3308, "click_share": 0.1646, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "wireless headphones"}, {"week_date": "2025-02-09", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 2320.1432, "click_share": 0.2359, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-09", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2026.0699, "click_share": 0.206, "average_organic_rank": 5, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-09", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1025.148, "click_share": 0.1042, "average_organic_rank": 8, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "JBL Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-09", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 456.8457, "click_share": 0.0465, "average_organic_rank": 21, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-09", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1210.8712, "click_share": 0.165, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-09", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1059.8549, "click_share": 0.1444, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-09", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 1740.1983, "click_share": 0.2371, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-09", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 1391.8906, "click_share": 0.1897, "average_organic_rank": 4, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-09", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 803.9515, "click_share": 0.1096, "average_organic_rank": 8, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "JBL Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-09", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 213.9114, "click_share": 0.0292, "average_organic_rank": 35, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-09", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1780.4431, "click_share": 0.1691, "average_organic_rank": 5, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-09", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1500.5693, "click_share": 0.1425, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-09", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 2577.8542, "click_share": 0.2448, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-09", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2232.0673, "click_share": 0.212, "average_organic_rank": 4, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-09", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1109.8454, "click_share": 0.1054, "average_organic_rank": 10, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "JBL Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-09", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 686.0402, "click_share": 0.0652, "average_organic_rank": 16, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-16", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1795.3853, "click_share": 0.1472, "average_organic_rank": 7, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-16", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1948.3375, "click_share": 0.1598, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "wireless headphones"}, {"week_date": "2025-02-16", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 3133.5658, "click_share": 0.257, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-16", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2617.9157, "click_share": 0.2147, "average_organic_rank": 5, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-16", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1285.1278, "click_share": 0.1054, "average_organic_rank": 10, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "JBL Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-16", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 420.5966, "click_share": 0.0345, "average_organic_rank": 29, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-16", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 997.5752, "click_share": 0.1472, "average_organic_rank": 7, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-16", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1133.2081, "click_share": 0.1672, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-16", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 1789.2829, "click_share": 0.264, "average_organic_rank": 2, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-16", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 1373.1098, "click_share": 0.2026, "average_organic_rank": 5, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Bose Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-16", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 692.6848, "click_share": 0.1022, "average_organic_rank": 10, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "JBL Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-16", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 287.3512, "click_share": 0.0424, "average_organic_rank": 26, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-16", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1320.1415, "click_share": 0.1342, "average_organic_rank": 5, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-16", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1640.7816, "click_share": 0.1668, "average_organic_rank": 6, "price": 49.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-16", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 2575.4057, "click_share": 0.2618, "average_organic_rank": 2, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-16", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2049.8897, "click_share": 0.2084, "average_organic_rank": 4, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-16", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 978.9669, "click_share": 0.0995, "average_organic_rank": 8, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "JBL Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-16", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 328.7562, "click_share": 0.0334, "average_organic_rank": 30, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-23", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2187.3193, "click_share": 0.2007, "average_organic_rank": 4, "price": 44.99, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-23", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2364.7176, "click_share": 0.217, "average_organic_rank": 3, "price": 44.99, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "wireless headphones"}, {"week_date": "2025-02-23", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 2697.5113, "click_share": 0.2475, "average_organic_rank": 3, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-23", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2045.242, "click_share": 0.1877, "average_organic_rank": 4, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Bose Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-23", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1058.4556, "click_share": 0.0971, "average_organic_rank": 10, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "JBL Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-23", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 396.9634, "click_share": 0.0364, "average_organic_rank": 26, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "wireless headphones"}, {"week_date": "2025-02-23", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1150.3291, "click_share": 0.1852, "average_organic_rank": 5, "price": 44.99, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-23", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 1282.723, "click_share": 0.2065, "average_organic_rank": 5, "price": 44.99, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-23", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 1599.5085, "click_share": 0.2575, "average_organic_rank": 2, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-23", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 1332.1835, "click_share": 0.2144, "average_organic_rank": 5, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Bose Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-23", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 686.0468, "click_share": 0.1104, "average_organic_rank": 8, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "JBL Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-23", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 143.0232, "click_share": 0.023, "average_organic_rank": 47, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "bluetooth earbuds"}, {"week_date": "2025-02-23", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2686.0746, "click_share": 0.1802, "average_organic_rank": 4, "price": 44.99, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-23", "resolved_brand": "SoundCore", "is_yaba_asin": "Y", "clicks": 2991.2464, "click_share": 0.2007, "average_organic_rank": 5, "price": 44.99, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "product_title": "SoundCore Wireless Headphone Model 1", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-23", "resolved_brand": "Sony", "is_yaba_asin": "N", "clicks": 3811.8384, "click_share": 0.2557, "average_organic_rank": 2, "price": 149.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Sony Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-23", "resolved_brand": "Bose", "is_yaba_asin": "N", "clicks": 2865.7336, "click_share": 0.1923, "average_organic_rank": 5, "price": 299.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "product_title": "Bose Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-23", "resolved_brand": "JBL", "is_yaba_asin": "N", "clicks": 1395.7001, "click_share": 0.0936, "average_organic_rank": 9, "price": 79.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "JBL Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}, {"week_date": "2025-02-23", "resolved_brand": "Generic", "is_yaba_asin": "N", "clicks": 482.528, "click_share": 0.0324, "average_organic_rank": 33, "price": 29.99, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "product_title": "Generic Audio Wireless Headphone Model 0", "keywords": "noise cancelling headphones"}];

    // --- 2. LOGIC ---
    let OUR_BRAND = '';
    let TOP_COMPETITORS = [];

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        // A. Process Data
        const brands = [...new Set(rawData.map(d => d.resolved_brand))];
        const weeks = [...new Set(rawData.map(d => d.week_date))].sort();
        
        // Identify Our Brand (First brand with is_yaba_asin = 'Y')
        const yabaEntry = rawData.find(d => d.is_yaba_asin === 'Y');
        OUR_BRAND = yabaEntry ? yabaEntry.resolved_brand : 'N/A';
        document.getElementById('ourBrandName').innerText = OUR_BRAND;

        // Identify Top Competitors (by Share Volume)
        const brandShares = {};
        rawData.forEach(r => {
            if(r.resolved_brand !== OUR_BRAND) {
                brandShares[r.resolved_brand] = (brandShares[r.resolved_brand] || 0) + r.click_share;
            }
        });
        TOP_COMPETITORS = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0,3)
            .map(e => e[0]);

        // Setup Dropdowns
        const weekSel = document.getElementById('weekSelect');
        weeks.reverse().forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSel.appendChild(opt);
        });
        
        const compSel = document.getElementById('compSelect');
        Object.keys(brandShares).forEach(b => {
            let opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            compSel.appendChild(opt);
        });
        
        document.getElementById('reportDateRange').innerText = `Periodo: ${weeks[0]} - ${weeks[weeks.length-1]}`;

        // B. Draw Static Charts
        drawKPIs(weeks[weeks.length-1], weeks[weeks.length-2]);
        drawTrendChart(weeks);
        drawBrandChart(weeks);
        drawLeversChart();
        drawEfficiencyChart();
        updateComparator();
    }

    function drawKPIs(lastWeek, prevWeek) {
        const getMetrics = (week) => {
            const weekData = rawData.filter(d => d.week_date === week);
            const yabaData = weekData.filter(d => d.is_yaba_asin === 'Y');
            const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
            const myClicks = yabaData.reduce((sum, d) => sum + d.clicks, 0);
            
            // Weighted Share
            const myShare = totalClicks > 0 ? myClicks / totalClicks : 0;
            
            // Avg Rank (Weighted by clicks for accuracy)
            const weightedRank = yabaData.reduce((sum, d) => sum + (d.average_organic_rank * d.clicks), 0);
            const avgRank = myClicks > 0 ? weightedRank / myClicks : 0;

            return { clicks: myClicks, share: myShare, rank: avgRank };
        };

        const curr = getMetrics(lastWeek);
        const prev = getMetrics(prevWeek);

        const diffClicks = ((curr.clicks - prev.clicks)/prev.clicks * 100).toFixed(1);
        const diffShare = ((curr.share - prev.share) * 100).toFixed(1); // pp diff

        const html = `
            <div class="card">
                <h3>Total Clicks (Nuestra Marca)</h3>
                <div class="value">${Math.round(curr.clicks).toLocaleString()}</div>
                <div class="trend ${diffClicks >= 0 ? 'up' : 'down'}">
                    ${diffClicks > 0 ? '+' : ''}${diffClicks}% vs semana anterior
                </div>
            </div>
            <div class="card">
                <h3>Click Share Total</h3>
                <div class="value">${(curr.share * 100).toFixed(1)}%</div>
                <div class="trend ${diffShare >= 0 ? 'up' : 'down'}">
                    ${diffShare > 0 ? '+' : ''}${diffShare} pp
                </div>
            </div>
            <div class="card">
                <h3>Avg. Organic Rank</h3>
                <div class="value">#${curr.rank.toFixed(1)}</div>
                <div class="trend ${curr.rank <= prev.rank ? 'up' : 'down'}">
                    ${(prev.rank - curr.rank).toFixed(1)} posiciones
                </div>
            </div>
             <div class="card">
                <h3>ASINs Activos</h3>
                <div class="value">${new Set(rawData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y').map(d=>d.product_title)).size}</div>
                <div class="trend">Variantes</div>
            </div>
        `;
        document.getElementById('kpiGrid').innerHTML = html;
    }

    function drawTrendChart(weeks) {
        const data = [['Semana', 'Clicks (Mercado)', 'Share (Nosotros)']];
        weeks.forEach(w => {
            const weekData = rawData.filter(d => d.week_date === w);
            const totalClicks = weekData.reduce((s,d) => s + d.clicks, 0);
            const myClicks = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((s,d) => s + d.clicks, 0);
            const share = totalClicks ? myClicks / totalClicks : 0;
            data.push([w, totalClicks, share]);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
            colors: ['#E0E0E0'],
            legend: {position: 'bottom'},
            vAxes: {0: {title: 'Clicks'}, 1: {title: 'Share', format: 'percent'}},
            chartArea: {width: '85%', height: '70%'}
        };
        new google.visualization.ComboChart(document.getElementById('trend_chart')).draw(dt, options);
    }

    function drawBrandChart(weeks) {
        const header = ['Semana', OUR_BRAND, ...TOP_COMPETITORS, 'Resto'];
        const data = [header];

        weeks.forEach(w => {
            const weekData = rawData.filter(d => d.week_date === w);
            const totalClicks = weekData.reduce((s,d) => s + d.clicks, 0);
            
            const getShare = (brand) => {
                const clicks = weekData.filter(d => d.resolved_brand === brand).reduce((s,d) => s + d.clicks, 0);
                return totalClicks ? clicks / totalClicks : 0;
            };

            const row = [w, getShare(OUR_BRAND)];
            let topCompShare = 0;
            TOP_COMPETITORS.forEach(c => {
                const s = getShare(c);
                row.push(s);
                topCompShare += s;
            });
            
            // Resto
            const myShare = row[1];
            row.push(Math.max(0, 1 - (myShare + topCompShare)));
            data.push(row);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            lineWidth: 3,
            legend: {position: 'bottom'},
            vAxis: {format: 'percent'},
            chartArea: {width: '90%', height: '70%'}
        };
        new google.visualization.LineChart(document.getElementById('brand_chart')).draw(dt, options);
    }

    function drawLeversChart() {
        // Impact of Deals on My Share
        const withDeal = rawData.filter(d => d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_deal > 0);
        const noDeal = rawData.filter(d => d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_deal === 0);

        const avgShareDeal = withDeal.length ? withDeal.reduce((s,d)=>s+d.click_share,0)/withDeal.length : 0;
        const avgShareNoDeal = noDeal.length ? noDeal.reduce((s,d)=>s+d.click_share,0)/noDeal.length : 0;

        const data = google.visualization.arrayToDataTable([
            ['Estado', 'Avg Click Share', { role: 'style' }],
            ['Sin Deal', avgShareNoDeal, '#9AA0A6'],
            ['Con Deal', avgShareDeal, '#4285F4']
        ]);

        new google.visualization.ColumnChart(document.getElementById('levers_chart')).draw(data, {
            legend: {position: 'none'},
            vAxis: {format: 'percent'},
            title: 'Impacto de Deals en Click Share Promedio (Nuestros ASINs)'
        });
    }

    function drawEfficiencyChart() {
        // Scatter: Rank vs Share. Color by Owner
        const data = [['Rank', 'Share', {role: 'style'}, {role: 'tooltip'}]];
        
        // Filter last week only for clarity
        const lastWeek = [...new Set(rawData.map(d=>d.week_date))].sort().pop();
        const weekData = rawData.filter(d => d.week_date === lastWeek);

        weekData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#9AA0A6';
            const tooltip = `${d.resolved_brand}\nRank: ${d.average_organic_rank}\nShare: ${(d.click_share*100).toFixed(1)}%`;
            data.push([d.average_organic_rank, d.click_share, `point {fill-color: ${color}}`, tooltip]);
        });

        const dt = google.visualization.arrayToDataTable(data);
        const options = {
            hAxis: {title: 'Organic Rank (Menor es mejor)', direction: 1},
            vAxis: {title: 'Click Share', format: 'percent'},
            legend: 'none',
            chartArea: {width: '85%', height: '70%'}
        };
        new google.visualization.ScatterChart(document.getElementById('efficiency_chart')).draw(dt, options);
    }

    function updateComparator() {
        const week = document.getElementById('weekSelect').value;
        const comp = document.getElementById('compSelect').value;
        const theirNameSpan = document.getElementById('theirBrandName');
        
        theirNameSpan.innerText = comp;

        // Calculate Metrics
        const getStats = (brand) => {
            const subset = rawData.filter(d => d.week_date === week && d.resolved_brand === brand);
            const clicks = subset.reduce((s,d)=>s+d.clicks, 0);
            const totalWeekClicks = rawData.filter(d => d.week_date === week).reduce((s,d)=>s+d.clicks,0);
            
            // Wtd Avg Price
            const revenue = subset.reduce((s,d)=>s + (d.price * d.clicks), 0);
            const price = clicks ? revenue/clicks : 0;
            
            // Wtd Rank
            const rankSum = subset.reduce((s,d)=>s + (d.average_organic_rank * d.clicks), 0);
            const rank = clicks ? rankSum/clicks : 0;

            const share = totalWeekClicks ? clicks/totalWeekClicks : 0;

            return { price, rank, share };
        };

        const us = getStats(OUR_BRAND);
        const them = getStats(comp);

        const rows = [
            { metric: 'Click Share', us: (us.share*100).toFixed(1)+'%', them: (them.share*100).toFixed(1)+'%', better: us.share > them.share },
            { metric: 'Precio Promedio', us: '$'+us.price.toFixed(2), them: '$'+them.price.toFixed(2), better: us.price < them.price }, // Lower price usually "better" or just diff
            { metric: 'Avg Organic Rank', us: '#'+us.rank.toFixed(1), them: '#'+them.rank.toFixed(1), better: us.rank < them.rank }
        ];

        let html = '';
        rows.forEach(r => {
            const diffClass = r.better ? 'winner' : 'loser';
            html += `<tr>
                <td>${r.metric}</td>
                <td style="font-weight:bold;">${r.us}</td>
                <td>${r.them}</td>
                <td class="${diffClass}">${r.better ? 'Mejor' : 'Peor'}</td>
            </tr>`;
        });
        document.getElementById('compTableBody').innerHTML = html;

        // Mini Chart
        const data = google.visualization.arrayToDataTable([
            ['Marca', 'Share', {role:'style'}],
            [OUR_BRAND, us.share, '#4285F4'],
            [comp, them.share, '#EA4335']
        ]);
        new google.visualization.BarChart(document.getElementById('comp_viz')).draw(data, {
            legend: {position: 'none'},
            hAxis: {format: 'percent'},
            title: 'Comparativa de Cuota de Mercado'
        });
    }

    // UI Helpers
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        
        // Redraw charts to fix hidden div dimension issues
        if(tabId === 'interactive') updateComparator();
    }
</script>

</body>
</html>