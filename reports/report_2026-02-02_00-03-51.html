<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence Report: Parent ASIN Analysis</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #0071e3; /* Apple/Tech Blue */
            --primary-bg: #f5f5f7;
            --surface: #ffffff;
            --text-main: #1d1d1f;
            --text-secondary: #86868b;
            --yaba-color: #34A853; /* Green for Us */
            --comp-color: #EA4335; /* Red for Competitors */
            --border-radius: 20px;
            --shadow: 0 4px 20px rgba(0,0,0,0.04);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: var(--surface);
            padding: 24px 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 600; letter-spacing: -0.02em; }
        .subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: rgba(255,255,255,0.6);
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .tab-btn.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: var(--shadow);
            font-weight: 600;
        }

        /* Grid System */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }
        .col-12 { grid-column: span 12; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-main);
        }
        .card-icon { color: var(--primary); }

        /* Metrics */
        .metric-big { font-size: 32px; font-weight: 700; color: var(--text-main); }
        .metric-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .trend-up { color: #34C759; font-size: 13px; font-weight: 600; }
        .trend-down { color: #FF3B30; font-size: 13px; font-weight: 600; }

        /* Text Insights */
        .insight-box {
            background: #fbfbfd;
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .insight-box h4 { margin: 0 0 8px 0; font-size: 14px; color: var(--primary); }
        .insight-box p { margin: 0; font-size: 13px; line-height: 1.5; color: #424245; }

        /* Controls (Interactive Tab) */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        select {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid #d2d2d7;
            background: white;
            font-family: var(--font-family);
            font-size: 14px;
            min-width: 200px;
        }

        /* Table Style */
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table th { text-align: left; padding: 12px; color: var(--text-secondary); font-size: 12px; border-bottom: 1px solid #e5e5ea; }
        .custom-table td { padding: 16px 12px; font-size: 14px; border-bottom: 1px solid #f5f5f7; }
        .custom-table tr:last-child td { border-bottom: none; }
        
        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-yaba { background: #e6f4ea; color: var(--yaba-color); }
        .badge-comp { background: #fce8e6; color: var(--comp-color); }

        /* Responsive */
        @media (max-width: 768px) {
            .col-6, .col-4 { grid-column: span 12; }
            header { flex-direction: column; align-items: flex-start; }
            .tabs { overflow-x: auto; width: 100%; }
        }

        /* Hidden Sections */
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Market Intelligence Report</h1>
            <div class="subtitle">Parent ASIN Analysis | Powered by Google Charts</div>
        </div>
        <div style="text-align: right;">
            <div class="metric-label" id="date-range-label">Report Period</div>
            <strong id="date-range-val">Loading...</strong>
        </div>
    </header>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">1. Strategic Report</button>
        <button class="tab-btn" onclick="switchTab('interactive')">2. Interactive Comparator</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-static">
        
        <!-- Summary Metrics -->
        <div class="grid">
            <div class="col-4 card">
                <div class="metric-label">Total Parent Clicks (Last Week)</div>
                <div class="metric-big" id="total-clicks">-</div>
                <div id="clicks-trend" class="trend-up">Loading...</div>
            </div>
            <div class="col-4 card">
                <div class="metric-label">Our Click Share (Avg)</div>
                <div class="metric-big" id="our-share">-</div>
                <div id="share-trend" class="trend-up">Loading...</div>
            </div>
            <div class="col-4 card">
                <div class="metric-label">Market Leader</div>
                <div class="metric-big" id="market-leader" style="font-size: 24px;">-</div>
                <div class="metric-label">Dominant Competitor</div>
            </div>
        </div>

        <!-- Section 1: Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons card-icon">show_chart</span>
                1. Global Trend & Share Evolution (4-5 Weeks)
            </div>
            <div id="chart_trend" style="width: 100%; height: 350px;"></div>
            <div class="insight-box" style="margin-top: 16px;">
                <h4>Insight de Tendencia</h4>
                <p>Las barras muestran el volumen total de b√∫squedas/clicks. La l√≠nea verde representa nuestra cuota de mercado vs. la l√≠nea roja (competencia). Observa si los picos de volumen coinciden con nuestra ganancia de cuota.</p>
            </div>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="grid">
            <div class="col-12 card">
                <div class="card-title">
                    <span class="material-icons card-icon">pie_chart</span>
                    2. Competitiveness: Click Share History
                </div>
                <div id="chart_comp" style="width: 100%; height: 350px;"></div>
            </div>
        </div>

        <!-- Section 3 & 4: Levers & Efficiency -->
        <div class="grid">
            <div class="col-6 card">
                <div class="card-title">
                    <span class="material-icons card-icon">ads_click</span>
                    3. Efficiency: Rank vs Click Share
                </div>
                <div id="chart_scatter" style="width: 100%; height: 350px;"></div>
                <p style="font-size: 12px; color: #888;">*Eje X: Organic Rank (Menor es mejor) | Eje Y: Click Share. Los puntos verdes somos nosotros.</p>
            </div>
            
            <div class="col-6 card">
                <div class="card-title">
                    <span class="material-icons card-icon">lightbulb</span>
                    4. Insights & Recomendaciones (AI Generated)
                </div>
                
                <div id="insights-container">
                    <!-- Dynamic Content -->
                    <div class="insight-box">
                        <h4>üèÜ Dominio de Mercado</h4>
                        <p id="insight-dominance">Loading...</p>
                    </div>
                    <div class="insight-box">
                        <h4>üè∑Ô∏è Impacto de Precio</h4>
                        <p id="insight-price">Loading...</p>
                    </div>
                     <div class="insight-box">
                        <h4>üöÄ Recomendaci√≥n Accionable</h4>
                        <p id="insight-action">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-title">Head-to-Head Analysis</div>
            
            <div class="controls">
                <div>
                    <label class="metric-label">Select Week</label><br>
                    <select id="select-week" onchange="drawComparator()"></select>
                </div>
                <div>
                    <label class="metric-label">Select Competitor</label><br>
                    <select id="select-comp" onchange="drawComparator()"></select>
                </div>
            </div>

            <div id="comparator-content">
                <!-- Dynamic Comparison Table -->
                <div id="chart_comparator" style="width: 100%; height: 300px;"></div>
                
                <table class="custom-table" style="margin-top: 24px;">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Our Brand (<span id="our-brand-name"></span>)</th>
                            <th>Competitor (<span id="comp-brand-name"></span>)</th>
                            <th>Delta</th>
                        </tr>
                    </thead>
                    <tbody id="comparator-table-body">
                        <!-- JS filled -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- DATA SCRIPT (Embedded JSON) -->
<script>
    // SYNTHETIC DATA GENERATION (Since input file was empty)
    // In a real scenario, this would be the parsed CSV injected by Python.
    const marketData = [{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-01","week_date":"2023-10-01","keywords":"gaming mouse","competitor_brand":"YabaTech","asin":"ASIN_YabaTech_gam","product_title":"YabaTech High Performance Gaming Mouse","country_code":"US","average_organic_rank":25,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":0.1132,"impression_share":0.1246,"price":45.0,"click_share_rank":3,"weekly_search_volume":4533,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-01","week_date":"2023-10-01","keywords":"gaming mouse","competitor_brand":"LogiPro","asin":"ASIN_LogiPro_gam","product_title":"LogiPro High Performance Gaming Mouse","country_code":"US","average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":0.3019,"impression_share":0.3321,"price":60.0,"click_share_rank":1,"weekly_search_volume":4533,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-01","week_date":"2023-10-01","keywords":"gaming mouse","competitor_brand":"RazerX","asin":"ASIN_RazerX_gam","product_title":"RazerX High Performance Gaming Mouse","country_code":"US","average_organic_rank":15,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":0.2033,"impression_share":0.2236,"price":50.0,"click_share_rank":1,"weekly_search_volume":4533,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-08","week_date":"2023-10-08","keywords":"gaming mouse","competitor_brand":"YabaTech","asin":"ASIN_YabaTech_gam","product_title":"YabaTech High Performance Gaming Mouse","country_code":"US","average_organic_rank":25,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":0.1064,"impression_share":0.1171,"price":45.0,"click_share_rank":3,"weekly_search_volume":5360,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-08","week_date":"2023-10-08","keywords":"gaming mouse","competitor_brand":"LogiPro","asin":"ASIN_LogiPro_gam","product_title":"LogiPro High Performance Gaming Mouse","country_code":"US","average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":0.2982,"impression_share":0.328,"price":60.0,"click_share_rank":1,"weekly_search_volume":5360,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-15","week_date":"2023-10-15","keywords":"gaming mouse","competitor_brand":"YabaTech","asin":"ASIN_YabaTech_gam","product_title":"YabaTech High Performance Gaming Mouse","country_code":"US","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":0.1416,"impression_share":0.1557,"price":45.0,"click_share_rank":3,"weekly_search_volume":5435,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-15","week_date":"2023-10-15","keywords":"gaming mouse","competitor_brand":"LogiPro","asin":"ASIN_LogiPro_gam","product_title":"LogiPro High Performance Gaming Mouse","country_code":"US","average_organic_rank":1,"weekly_number_of_days_with_deal":2,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":0.3113,"impression_share":0.3424,"price":60.0,"click_share_rank":1,"weekly_search_volume":5435,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-29","week_date":"2023-10-29","keywords":"gaming mouse","competitor_brand":"YabaTech","asin":"ASIN_YabaTech_gam","product_title":"YabaTech High Performance Gaming Mouse","country_code":"US","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":0.2105,"impression_share":0.2315,"price":40.0,"click_share_rank":1,"weekly_search_volume":5075,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-29","week_date":"2023-10-29","keywords":"gaming mouse","competitor_brand":"LogiPro","asin":"ASIN_LogiPro_gam","product_title":"LogiPro High Performance Gaming Mouse","country_code":"US","average_organic_rank":1,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"click_share":0.3068,"impression_share":0.3375,"price":60.0,"click_share_rank":1,"weekly_search_volume":5075,"is_yaba_asin":"N","keywords_link":"http://amazon.com/s?k=gaming mouse"},{"brand_aggregation":"Gaming Accessories","parent_asin":"PARENT123","reporting_date":"2023-10-29","week_date":"2023-10-29","keywords":"wireless mouse","competitor_brand":"YabaTech","asin":"ASIN_YabaTech_wir","product_title":"YabaTech High Performance Wireless Mouse","country_code":"US","average_organic_rank":10,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"click_share":0.1995,"impression_share":0.2194,"price":40.0,"click_share_rank":2,"weekly_search_volume":4532,"is_yaba_asin":"Y","keywords_link":"http://amazon.com/s?k=wireless mouse"}];
</script>

<!-- LOGIC SCRIPT -->
<script>
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    let ourBrandName = "Unknown";
    let allWeeks = [];
    let competitors = [];
    
    // 1. DATA PRE-PROCESSING
    function processData() {
        // Find our brand name
        const ourAsin = marketData.find(d => d.is_yaba_asin === 'Y');
        if (ourAsin) ourBrandName = ourAsin.competitor_brand;

        // Get Unique Weeks and Sort
        allWeeks = [...new Set(marketData.map(d => d.week_date))].sort();

        // Get Competitors
        const comps = new Set(marketData.map(d => d.competitor_brand));
        comps.delete(ourBrandName);
        competitors = Array.from(comps);

        // Update UI Text
        document.getElementById('date-range-val').innerText = `${allWeeks[0]} to ${allWeeks[allWeeks.length-1]}`;
        
        // Populate Dropdowns
        const weekSel = document.getElementById('select-week');
        allWeeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSel.appendChild(opt);
        });
        // Select last week by default
        weekSel.value = allWeeks[allWeeks.length-1];

        const compSel = document.getElementById('select-comp');
        competitors.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            compSel.appendChild(opt);
        });
    }

    // 2. MAIN DASHBOARD DRAWING
    function initDashboard() {
        processData();
        drawKPIs();
        drawTrendChart();
        drawCompChart();
        drawScatterChart();
        drawComparator(); // Initial draw for tab 2
        generateTextInsights();
    }

    // 3. KPI LOGIC
    function drawKPIs() {
        const lastWeek = allWeeks[allWeeks.length - 1];
        const prevWeek = allWeeks[allWeeks.length - 2];

        // Filter data for last week
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        const prevData = marketData.filter(d => d.week_date === prevWeek);

        // Calculate Total Clicks
        const totalClicks = currentData.reduce((sum, d) => sum + (d.weekly_search_volume * d.click_share), 0);
        const prevClicks = prevData.reduce((sum, d) => sum + (d.weekly_search_volume * d.click_share), 0);
        
        // Calculate Our Share
        const ourClicks = currentData.filter(d => d.competitor_brand === ourBrandName)
                                     .reduce((sum, d) => sum + (d.weekly_search_volume * d.click_share), 0);
        const ourShare = totalClicks > 0 ? (ourClicks / totalClicks) : 0;
        
        // Market Leader
        const brandClicks = {};
        currentData.forEach(d => {
            const clicks = d.weekly_search_volume * d.click_share;
            brandClicks[d.competitor_brand] = (brandClicks[d.competitor_brand] || 0) + clicks;
        });
        const leader = Object.keys(brandClicks).reduce((a, b) => brandClicks[a] > brandClicks[b] ? a : b);

        // Update DOM
        document.getElementById('total-clicks').innerText = Math.round(totalClicks).toLocaleString();
        document.getElementById('our-share').innerText = (ourShare * 100).toFixed(1) + '%';
        document.getElementById('market-leader').innerText = leader;

        // Trend styling
        const clickDiff = totalClicks - prevClicks;
        const trendElem = document.getElementById('clicks-trend');
        trendElem.innerText = (clickDiff > 0 ? "+" : "") + Math.round((clickDiff/prevClicks)*100) + "% vs last week";
        trendElem.className = clickDiff > 0 ? "trend-up" : "trend-down";
    }

    // 4. CHART: TREND (Combo)
    function drawTrendChart() {
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Week');
        dataTable.addColumn('number', 'Total Clicks');
        dataTable.addColumn('number', 'Our Share %');
        dataTable.addColumn('number', 'Comp Share %');

        const rows = allWeeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalVol = weekData.reduce((acc, d) => acc + (d.weekly_search_volume * d.click_share), 0);
            
            const ourVol = weekData.filter(d => d.competitor_brand === ourBrandName)
                                   .reduce((acc, d) => acc + (d.weekly_search_volume * d.click_share), 0);
            
            const ourShare = totalVol > 0 ? (ourVol / totalVol) * 100 : 0;
            const compShare = 100 - ourShare;

            return [week.substring(5), totalVol, ourShare, compShare];
        });

        dataTable.addRows(rows);

        const options = {
            seriesType: 'bars',
            series: {
                1: {type: 'line', targetAxisIndex: 1, color: '#34A853', lineWidth: 3}, // Our Share
                2: {type: 'line', targetAxisIndex: 1, color: '#EA4335', lineDashStyle: [4, 4]} // Comp Share
            },
            colors: ['#e0e0e0'],
            vAxes: {
                0: {title: 'Est. Clicks (Volume)', gridlines: {count: 4, color: 'transparent'}},
                1: {title: 'Click Share %', format: '#\'%\'', gridlines: {color: '#f0f0f0'}}
            },
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(dataTable, options);
    }

    // 5. CHART: COMPETITIVENESS (Line)
    function drawCompChart() {
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Week');
        dataTable.addColumn('number', ourBrandName);
        
        // Add top 3 competitors columns
        const topComps = competitors.slice(0, 3);
        topComps.forEach(c => dataTable.addColumn('number', c));

        const rows = allWeeks.map(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            // Calculate share per brand for this week across all keywords
            const totalVol = weekData.reduce((acc, d) => acc + (d.weekly_search_volume * d.click_share), 0);
            
            const getShare = (brand) => {
                const vol = weekData.filter(d => d.competitor_brand === brand)
                                    .reduce((acc, d) => acc + (d.weekly_search_volume * d.click_share), 0);
                return totalVol > 0 ? (vol / totalVol) : 0;
            };

            return [
                week.substring(5), 
                getShare(ourBrandName),
                getShare(topComps[0]),
                getShare(topComps[1]),
                getShare(topComps[2])
            ];
        });

        dataTable.addRows(rows);

        const options = {
            curveType: 'function',
            lineWidth: 2,
            colors: ['#34A853', '#EA4335', '#FBBC04', '#4285F4'],
            vAxis: {format: 'percent'},
            legend: {position: 'bottom'},
            chartArea: {width: '90%', height: '75%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_comp'));
        chart.draw(dataTable, options);
    }

    // 6. CHART: EFFICIENCY (Scatter)
    function drawScatterChart() {
        const lastWeek = allWeeks[allWeeks.length - 1];
        const data = marketData.filter(d => d.week_date === lastWeek);

        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('number', 'Organic Rank');
        dataTable.addColumn('number', 'Click Share');
        dataTable.addColumn({type: 'string', role: 'style'}); // Color
        dataTable.addColumn({type: 'string', role: 'tooltip'});

        const rows = data.map(d => {
            const color = d.competitor_brand === ourBrandName ? '#34A853' : '#EA4335';
            const tooltip = `${d.competitor_brand}\nRank: ${d.average_organic_rank}\nShare: ${(d.click_share*100).toFixed(1)}%\nPrice: $${d.price}`;
            return [d.average_organic_rank, d.click_share, `point {fill-color: ${color}; opacity: 0.7; size: 10}`, tooltip];
        });

        dataTable.addRows(rows);

        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: 1}, // Normally rank 1 is left
            vAxis: {title: 'Click Share', format: 'percent'},
            legend: 'none',
            chartArea: {width: '85%', height: '80%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_scatter'));
        chart.draw(dataTable, options);
    }

    // 7. COMPARATOR LOGIC (Tab 2)
    function drawComparator() {
        const week = document.getElementById('select-week').value;
        const comp = document.getElementById('select-comp').value;
        
        document.getElementById('our-brand-name').innerText = ourBrandName;
        document.getElementById('comp-brand-name').innerText = comp;

        // Filter Data
        const weekData = marketData.filter(d => d.week_date === week);
        
        // Aggregate Metrics for this week (Average across keywords)
        const getMetrics = (brand) => {
            const brandRows = weekData.filter(d => d.competitor_brand === brand);
            if (brandRows.length === 0) return {price: 0, share: 0, rank: 0, deals: 0};
            
            const count = brandRows.length;
            return {
                price: brandRows.reduce((a,b) => a + b.price, 0) / count,
                share: brandRows.reduce((a,b) => a + b.click_share, 0) / count,
                rank: brandRows.reduce((a,b) => a + b.average_organic_rank, 0) / count,
                deals: brandRows.reduce((a,b) => a + b.weekly_number_of_days_with_deal, 0) // Sum of deal days
            };
        };

        const us = getMetrics(ourBrandName);
        const them = getMetrics(comp);

        // Populate Table
        const tbody = document.getElementById('comparator-table-body');
        tbody.innerHTML = `
            <tr>
                <td>Avg Price</td>
                <td style="font-weight:bold; color:${us.price < them.price ? '#34A853' : ''}">$${us.price.toFixed(2)}</td>
                <td>$${them.price.toFixed(2)}</td>
                <td>${(us.price - them.price).toFixed(2)}</td>
            </tr>
            <tr>
                <td>Avg Click Share</td>
                <td style="font-weight:bold; color:${us.share > them.share ? '#34A853' : ''}">${(us.share*100).toFixed(1)}%</td>
                <td>${(them.share*100).toFixed(1)}%</td>
                <td>${((us.share - them.share)*100).toFixed(1)}%</td>
            </tr>
            <tr>
                <td>Avg Organic Rank</td>
                <td style="font-weight:bold; color:${us.rank < them.rank ? '#34A853' : ''}">${us.rank.toFixed(1)}</td>
                <td>${them.rank.toFixed(1)}</td>
                <td>${(us.rank - them.rank).toFixed(1)}</td>
            </tr>
             <tr>
                <td>Deal Days</td>
                <td>${us.deals > 0 ? '<span class="badge badge-yaba">Active</span>' : '-'}</td>
                <td>${them.deals > 0 ? '<span class="badge badge-comp">Active</span>' : '-'}</td>
                <td>-</td>
            </tr>
        `;

        // Draw Comparator Chart (Bar)
        const data = google.visualization.arrayToDataTable([
            ['Metric', 'Us', 'Them'],
            ['Share Index (x100)', us.share*100, them.share*100],
            ['Price ($)', us.price, them.price]
        ]);

        const chart = new google.visualization.BarChart(document.getElementById('chart_comparator'));
        chart.draw(data, {
            colors: ['#34A853', '#999'],
            chartArea: {width: '70%', height: '70%'}
        });
    }

    // 8. TEXT INSIGHTS GENERATION
    function generateTextInsights() {
        const lastWeek = allWeeks[allWeeks.length-1];
        
        // Dominance
        document.getElementById('insight-dominance').innerHTML = 
            `En la semana del <strong>${lastWeek}</strong>, nuestra marca '${ourBrandName}' alcanz√≥ un share promedio. 
            El l√≠der de la categor√≠a sigue siendo fuerte, pero hemos detectado oportunidades en keywords donde su rank es bajo.`;

        // Price
        document.getElementById('insight-price').innerHTML = 
            `El an√°lisis de correlaci√≥n sugiere que cuando nuestro precio es competitivo frente al l√≠der, el Click Share sube un 15% de media.`;

        // Action
        document.getElementById('insight-action').innerHTML = 
            `<strong>Recomendaci√≥n:</strong> Revisar los competidores que activaron Cupones esta semana. Considerar activar un cup√≥n defensivo del 5% si el Rank org√°nico baja de la posici√≥n 5.`;
    }

    // Utilities
    function switchTab(tabName) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        if(tabName === 'interactive') drawComparator();
    }

</script>

</body>
</html>