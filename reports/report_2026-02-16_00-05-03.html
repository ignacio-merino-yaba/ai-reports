<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- GOOGLE NATIVE DEPENDENCIES -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet">

    <style>
        /* ESTILO "GOOGLE MATERIAL" & "APPLE-LIKE" CUSTOM CSS */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335;  /* Google Red */
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-radius: 16px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout & Grid */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 500;
            margin: 0;
            color: var(--text-primary);
        }

        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
        }

        .tab-btn.active {
            color: var(--primary-color);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            padding: 24px;
            margin-bottom: 24px;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 400;
            color: var(--text-primary);
        }

        .metric-change {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .positive { color: var(--success-color); }
        .negative { color: var(--danger-color); }
        .neutral { color: var(--text-secondary); }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
            color: var(--text-primary);
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge-deal { background-color: #FCE8E6; color: #C5221F; }
        .badge-choice { background-color: #202124; color: #fff; }
        .badge-bestseller { background-color: #E6F4EA; color: #137333; }

        /* Sections Toggle */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Insights Box */
        .insights-box {
            background-color: #E8F0FE;
            border-radius: 8px;
            padding: 16px;
            border-left: 4px solid var(--primary-color);
        }
        .insights-list li { margin-bottom: 8px; }

        /* Controls for Interactive Tab */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #dadce0;
            font-size: 14px;
            background: #fff;
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Parent ASIN Intelligence Report</h1>
        <div style="font-size: 12px; color: var(--text-secondary);">Generado Autom치ticamente</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Estrat칠gico</button>
        <button class="tab-btn" onclick="switchTab('compare')">Comparador Interactivo</button>
    </div>

    <!-- PESTA칌A 1: REPORTE ESTRAT칄GICO -->
    <div id="tab-report" class="tab-content active">
        
        <!-- KPIs Principales -->
        <div class="metrics-grid">
            <div class="card metric-item">
                <span class="metric-label">Click Share (Semana Actual)</span>
                <span class="metric-value" id="kpi-share">--%</span>
                <span class="metric-change" id="kpi-share-change">--</span>
            </div>
            <div class="card metric-item">
                <span class="metric-label">Precio Promedio</span>
                <span class="metric-value" id="kpi-price">$--</span>
                <span class="metric-change" id="kpi-price-gap">vs Mercado</span>
            </div>
            <div class="card metric-item">
                <span class="metric-label">Rank Org치nico</span>
                <span class="metric-value" id="kpi-rank">--</span>
                <span class="metric-change neutral">Promedio</span>
            </div>
            <div class="card metric-item">
                <span class="metric-label">Top Competidor</span>
                <span class="metric-value" id="kpi-comp" style="font-size: 20px; margin-top: 6px;">--</span>
                <span class="metric-change negative">Amenaza Principal</span>
            </div>
        </div>

        <!-- 1. Tendencia Global -->
        <div class="card">
            <div class="card-title">
                <i class="material-icons" style="color: var(--primary-color)">trending_up</i>
                1. Tendencia Global del Parent (Volumen vs Share)
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="insights-box" style="margin-top: 16px;">
                <strong>Diagn칩stico de Tendencia:</strong>
                <p id="insight-trend">Analizando la tracci칩n global...</p>
            </div>
        </div>

        <!-- 2. Competitividad de Marca -->
        <div class="card">
            <div class="card-title">
                <i class="material-icons" style="color: var(--danger-color)">pie_chart</i>
                2. Competitividad de Marca (Share of Voice)
            </div>
            <div id="chart_brand" class="chart-container"></div>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">
                *Comparativa de nuestra marca vs Top 3 competidores y el resto del mercado ("Others").
            </p>
        </div>

        <!-- 3. Palancas (Levers) -->
        <div class="card">
            <div class="card-title">
                <i class="material-icons" style="color: var(--warning-color)">flash_on</i>
                3. Palancas de Crecimiento (Precio & Badges)
            </div>
            <div id="levers_table_container">
                <!-- Table injected by JS -->
            </div>
        </div>

        <!-- 4. Eficiencia (Rank vs Share) -->
        <div class="card">
            <div class="card-title">
                <i class="material-icons" style="color: var(--success-color)">scatter_plot</i>
                4. Eficiencia: Organic Rank vs Click Share
            </div>
            <div id="chart_efficiency" class="chart-container"></div>
            <div class="insights-box" style="margin-top: 16px; background-color: #FCE8E6; border-left-color: #EA4335;">
                <strong>An치lisis de Eficiencia:</strong>
                <ul class="insights-list" id="insight-efficiency">
                    <!-- Injected via JS -->
                </ul>
            </div>
        </div>

        <!-- 5. Conclusiones y Recomendaciones -->
        <div class="card" style="border-left: 6px solid var(--primary-color);">
            <div class="card-title">
                <i class="material-icons">lightbulb</i>
                5. Conclusiones y Recomendaciones Accionables
            </div>
            
            <h4 style="margin-bottom: 8px;">游댐 Insights Clave</h4>
            <ul class="insights-list" id="final-insights">
                <!-- Injected via JS -->
            </ul>

            <h4 style="margin-top: 20px; margin-bottom: 8px;">游 Recomendaciones</h4>
            <ul class="insights-list" id="final-recommendations">
                <!-- Injected via JS -->
            </ul>
        </div>

        <!-- 6. Other Insights -->
        <div class="card">
            <div class="card-title">6. Other Insights & Anomalies</div>
            <p id="other-insights-text">
                Se detect칩 una alta correlaci칩n entre 'Best Seller' y la retenci칩n de cuota en competidores principales.
                Los ASINs con precio > $100 mantienen cuota estable a pesar de ranks inferiores (posible lealtad de marca).
            </p>
        </div>

    </div>

    <!-- PESTA칌A 2: COMPARADOR INTERACTIVO -->
    <div id="tab-compare" class="tab-content">
        <div class="card">
            <div class="card-title">Cara a Cara: Nosotros vs Competencia</div>
            
            <div class="controls">
                <select id="comp-select" onchange="updateComparator()">
                    <option value="">Selecciona un Competidor...</option>
                </select>
                <select id="metric-select" onchange="updateComparator()">
                    <option value="price">Comparar Precio</option>
                    <option value="rank">Comparar Rank Org치nico</option>
                    <option value="share">Comparar Click Share</option>
                </select>
            </div>

            <div id="chart_comparator" class="chart-container"></div>
            <div id="comparator_stats" style="margin-top: 20px; display: flex; justify-content: space-around;">
                <!-- Stats injected here -->
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
    // DATA INJECTION (FROM PYTHON)
    const marketData = [{"week_date": "2023-10-01", "keywords": "bluetooth earbuds", "competitor_brand": "SoundCore", "asin": "B00YABA000", "product_title": "SoundCore Life P0 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.08867370808381832, "weekly_search_volume": 50000, "price": 59.99, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-01", "keywords": "bluetooth earbuds", "competitor_brand": "SoundCore", "asin": "B00YABA001", "product_title": "SoundCore Life P1 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.12932371714545935, "weekly_search_volume": 50000, "price": 49.99, "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-01", "keywords": "noise cancelling headphones", "competitor_brand": "Sony", "asin": "B00COMP000", "product_title": "Sony Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.2, "weekly_search_volume": 50000, "price": 105, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00COMP001", "product_title": "Bose Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.04021703273183577, "weekly_search_volume": 50000, "price": 121, "average_organic_rank": 19, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00COMP002", "product_title": "JBL Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.010191834167530666, "weekly_search_volume": 50000, "price": 140, "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP002", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00COMP003", "product_title": "Generic Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.05373678783424107, "weekly_search_volume": 50000, "price": 158, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP003", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-01", "keywords": "noise cancelling headphones", "competitor_brand": "CheapBuds", "asin": "B00COMP004", "product_title": "CheapBuds Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.09139144432130097, "weekly_search_volume": 50000, "price": 185, "average_organic_rank": 33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP004", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00YABA000", "product_title": "SoundCore Life P0 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.0617066929949319, "weekly_search_volume": 50000, "price": 59.99, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-08", "keywords": "noise cancelling headphones", "competitor_brand": "SoundCore", "asin": "B00YABA001", "product_title": "SoundCore Life P1 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.11718017502447938, "weekly_search_volume": 50000, "price": 49.99, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00COMP000", "product_title": "Sony Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.2, "weekly_search_volume": 50000, "price": 99, "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-08", "keywords": "bluetooth earbuds", "competitor_brand": "Bose", "asin": "B00COMP001", "product_title": "Bose Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.04834789851610419, "weekly_search_volume": 50000, "price": 121, "average_organic_rank": 46, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-08", "keywords": "noise cancelling headphones", "competitor_brand": "JBL", "asin": "B00COMP002", "product_title": "JBL Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.013531986470659613, "weekly_search_volume": 50000, "price": 141, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP002", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-08", "keywords": "bluetooth earbuds", "competitor_brand": null, "asin": "B00COMP003", "product_title": "Generic Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.024346808794833297, "weekly_search_volume": 50000, "price": 161, "average_organic_rank": 33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP003", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-08", "keywords": "bluetooth earbuds", "competitor_brand": "CheapBuds", "asin": "B00COMP004", "product_title": "CheapBuds Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.09886915124115162, "weekly_search_volume": 50000, "price": 175, "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP004", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-15", "keywords": "noise cancelling headphones", "competitor_brand": "SoundCore", "asin": "B00YABA000", "product_title": "SoundCore Life P0 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.12604631627969344, "weekly_search_volume": 50000, "price": 59.99, "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00YABA001", "product_title": "SoundCore Life P1 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.13437146522814838, "weekly_search_volume": 50000, "price": 49.99, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-15", "keywords": "noise cancelling headphones", "competitor_brand": "Sony", "asin": "B00COMP000", "product_title": "Sony Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.2, "weekly_search_volume": 50000, "price": 99, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-15", "keywords": "bluetooth earbuds", "competitor_brand": "Bose", "asin": "B00COMP001", "product_title": "Bose Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.021028741362615414, "weekly_search_volume": 50000, "price": 121, "average_organic_rank": 49, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-15", "keywords": "noise cancelling headphones", "competitor_brand": "JBL", "asin": "B00COMP002", "product_title": "JBL Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.05435973809675271, "weekly_search_volume": 50000, "price": 135, "average_organic_rank": 36, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP002", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-15", "keywords": "noise cancelling headphones", "competitor_brand": null, "asin": "B00COMP003", "product_title": "Generic Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.05929314068353361, "weekly_search_volume": 50000, "price": 164, "average_organic_rank": 24, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP003", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "CheapBuds", "asin": "B00COMP004", "product_title": "CheapBuds Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.024535345717658097, "weekly_search_volume": 50000, "price": 181, "average_organic_rank": 19, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP004", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00YABA000", "product_title": "SoundCore Life P0 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.1293233857321591, "weekly_search_volume": 50000, "price": 59.99, "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "SoundCore", "asin": "B00YABA001", "product_title": "SoundCore Life P1 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.09831968846171966, "weekly_search_volume": 50000, "price": 49.99, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00COMP000", "product_title": "Sony Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.2, "weekly_search_volume": 50000, "price": 105, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00COMP001", "product_title": "Bose Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.0911762118471441, "weekly_search_volume": 50000, "price": 120, "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-22", "keywords": "noise cancelling headphones", "competitor_brand": "JBL", "asin": "B00COMP002", "product_title": "JBL Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.016335133614917173, "weekly_search_volume": 50000, "price": 145, "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP002", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-22", "keywords": "noise cancelling headphones", "competitor_brand": null, "asin": "B00COMP003", "product_title": "Generic Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.0573983369408665, "weekly_search_volume": 50000, "price": 157, "average_organic_rank": 40, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP003", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-22", "keywords": "noise cancelling headphones", "competitor_brand": "CheapBuds", "asin": "B00COMP004", "product_title": "CheapBuds Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.08803732997784013, "weekly_search_volume": 50000, "price": 182, "average_organic_rank": 31, "weekly_number_of_days_with_deal": 2, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP004", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-29", "keywords": "noise cancelling headphones", "competitor_brand": "SoundCore", "asin": "B00YABA000", "product_title": "SoundCore Life P0 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.12437651030997321, "weekly_search_volume": 50000, "price": 53.991, "average_organic_rank": 8, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-29", "keywords": "bluetooth earbuds", "competitor_brand": "SoundCore", "asin": "B00YABA001", "product_title": "SoundCore Life P1 Wireless Earbuds", "is_yaba_asin": "Y", "click_share": 0.05591325608753239, "weekly_search_volume": 50000, "price": 44.991, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 200, "link": "https://amazon.com/dp/B00YABA001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00COMP000", "product_title": "Sony Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.24, "weekly_search_volume": 50000, "price": 102, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP000", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00COMP001", "product_title": "Bose Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.08975878248795556, "weekly_search_volume": 50000, "price": 125, "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP001", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00COMP002", "product_title": "JBL Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.015091728103309259, "weekly_search_volume": 50000, "price": 141, "average_organic_rank": 39, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP002", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-29", "keywords": "bluetooth earbuds", "competitor_brand": null, "asin": "B00COMP003", "product_title": "Generic Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.08632619053303666, "weekly_search_volume": 50000, "price": 158, "average_organic_rank": 20, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP003", "keyword_link": "https://amazon.com/s?k=..."}, {"week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "CheapBuds", "asin": "B00COMP004", "product_title": "CheapBuds Wireless Headphone Pro", "is_yaba_asin": "N", "click_share": 0.05322965313175865, "weekly_search_volume": 50000, "price": 182, "average_organic_rank": 35, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 250, "link": "https://amazon.com/dp/B00COMP004", "keyword_link": "https://amazon.com/s?k=..."}];

    // GOOGLE CHARTS INIT
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    // GLOBAL STATE
    let processedData = {};
    let ourBrandName = "Unknown";
    let topCompetitors = [];

    function initDashboard() {
        processData();
        updateKPIs();
        drawTrends();
        drawBrandComp();
        renderLevers();
        drawEfficiency();
        populateComparatorSelect();
        generateTextInsights();
    }

    // 1. DATA PROCESSING LOGIC
    function processData() {
        // A. Brand Identification
        marketData.forEach(row => {
            if (!row.competitor_brand) {
                if (row.product_title && row.product_title.includes("Generic")) row.final_brand = "Generic";
                else row.final_brand = "Unknown Brand"; // Fallback
            } else {
                row.final_brand = row.competitor_brand;
            }
        });

        // B. Identify Our Brand
        const ourAsinRow = marketData.find(r => r.is_yaba_asin === 'Y');
        ourBrandName = ourAsinRow ? ourAsinRow.final_brand : "Our Brand";

        // C. Identify Top 3 Competitors (by total Share)
        const brandShares = {};
        marketData.forEach(r => {
            if (r.final_brand !== ourBrandName) {
                brandShares[r.final_brand] = (brandShares[r.final_brand] || 0) + r.click_share;
            }
        });
        topCompetitors = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);
    }

    function updateKPIs() {
        // Filter latest week
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const latestWeek = weeks[weeks.length - 1];
        const prevWeek = weeks[weeks.length - 2];

        const latestData = marketData.filter(d => d.week_date === latestWeek && d.is_yaba_asin === 'Y');
        const prevData = marketData.filter(d => d.week_date === prevWeek && d.is_yaba_asin === 'Y');

        // Share
        const shareCurrent = latestData.reduce((sum, r) => sum + r.click_share, 0);
        const sharePrev = prevData.reduce((sum, r) => sum + r.click_share, 0);
        const shareChange = sharePrev > 0 ? ((shareCurrent - sharePrev) / sharePrev) * 100 : 0;

        document.getElementById('kpi-share').innerText = (shareCurrent * 100).toFixed(1) + '%';
        const kpiShareChange = document.getElementById('kpi-share-change');
        kpiShareChange.innerText = (shareChange > 0 ? '+' : '') + shareChange.toFixed(1) + '% vs LW';
        kpiShareChange.className = 'metric-change ' + (shareChange > 0 ? 'positive' : 'negative');

        // Price
        const avgPrice = latestData.reduce((sum, r) => sum + r.price, 0) / (latestData.length || 1);
        const compData = marketData.filter(d => d.week_date === latestWeek && d.is_yaba_asin === 'N');
        const compPrice = compData.reduce((sum, r) => sum + r.price, 0) / (compData.length || 1);
        
        document.getElementById('kpi-price').innerText = '$' + avgPrice.toFixed(2);
        const priceGap = avgPrice - compPrice;
        const kpiPriceGap = document.getElementById('kpi-price-gap');
        kpiPriceGap.innerText = (priceGap > 0 ? '+$' : '-$') + Math.abs(priceGap).toFixed(2) + ' vs Mkt';
        kpiPriceGap.className = 'metric-change ' + (priceGap < 0 ? 'positive' : 'neutral'); // Cheaper is green

        // Rank
        const avgRank = latestData.reduce((sum, r) => sum + r.average_organic_rank, 0) / (latestData.length || 1);
        document.getElementById('kpi-rank').innerText = '#' + Math.round(avgRank);

        // Competitor
        document.getElementById('kpi-comp').innerText = topCompetitors[0] || "N/A";
    }

    // 2. CHART: GLOBAL TREND
    function drawTrends() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        // Prepare Data Table: [Week, Vol Us, Vol Comp, Share Us, Share Comp]
        const dataArray = [['Semana', 'Volumen (Nosotros)', 'Volumen (Comp)', 'Share % (Nosotros)', 'Share % (Comp)']];

        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const us = weekData.filter(d => d.is_yaba_asin === 'Y');
            const comp = weekData.filter(d => d.is_yaba_asin === 'N');

            // Approx Volume = click_share * search_volume
            const volUs = us.reduce((sum, r) => sum + (r.click_share * r.weekly_search_volume), 0);
            const volComp = comp.reduce((sum, r) => sum + (r.click_share * r.weekly_search_volume), 0);
            
            const shareUs = us.reduce((sum, r) => sum + r.click_share, 0);
            const shareComp = comp.reduce((sum, r) => sum + r.click_share, 0);

            dataArray.push([week.substring(5), volUs, volComp, shareUs, shareComp]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}, 3: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Volumen Estimado (Clicks)'}, 1: {title: 'Click Share (%)', format: 'percent'}},
            colors: ['#4285F4', '#E0E0E0', '#1967D2', '#757575'],
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    // 3. CHART: BRAND COMPETITIVENESS
    function drawBrandComp() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        // Header: Week, OurBrand, Comp1, Comp2, Comp3, Others
        const header = ['Semana', ourBrandName, ...topCompetitors, 'Otros'];
        const dataArray = [header];

        weeks.forEach(week => {
            const row = [week.substring(5)];
            const weekData = marketData.filter(d => d.week_date === week);
            
            // Our Share
            row.push(weekData.filter(d => d.final_brand === ourBrandName).reduce((s,r)=>s+r.click_share, 0));
            
            // Top Competitors
            topCompetitors.forEach(comp => {
                row.push(weekData.filter(d => d.final_brand === comp).reduce((s,r)=>s+r.click_share, 0));
            });

            // Others
            const allMentioned = [ourBrandName, ...topCompetitors];
            const otherShare = weekData.filter(d => !allMentioned.includes(d.final_brand)).reduce((s,r)=>s+r.click_share, 0);
            row.push(otherShare);

            dataArray.push(row);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            vAxis: {format: 'percent'},
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            chartArea: {width: '90%', height: '75%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand'));
        chart.draw(data, options);
    }

    // 4. LEVERS TABLE (Native HTML generation for better control than Google Table Chart)
    function renderLevers() {
        // Aggregate data for latest week
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const latestWeek = weeks[weeks.length - 1];
        const data = marketData.filter(d => d.week_date === latestWeek);

        // Group by Brand Category (Us vs Comp)
        const groups = {
            "Nuestra Marca": data.filter(d => d.is_yaba_asin === 'Y'),
            "Competencia": data.filter(d => d.is_yaba_asin === 'N')
        };

        let html = `<table><thead><tr>
            <th>Grupo</th>
            <th>Precio Prom.</th>
            <th>% con Deal</th>
            <th>% con Coupon</th>
            <th>% Amazon Choice</th>
            <th>Share Promedio</th>
        </tr></thead><tbody>`;

        for (const [name, rows] of Object.entries(groups)) {
            if(rows.length === 0) continue;
            const avgPrice = rows.reduce((s,r)=>s+r.price,0) / rows.length;
            const hasDeal = rows.filter(r=>r.weekly_number_of_days_with_deal > 0).length / rows.length;
            const hasCoupon = rows.filter(r=>r.weekly_number_of_days_with_coupon > 0).length / rows.length;
            const hasChoice = rows.filter(r=>r.weekly_number_of_days_with_amazon_choice_badge > 0).length / rows.length;
            const avgShare = rows.reduce((s,r)=>s+r.click_share,0) / rows.length; // per ASIN

            html += `<tr>
                <td style="font-weight:bold; color: ${name.includes('Nuestra') ? 'var(--primary-color)' : ''}">${name}</td>
                <td>$${avgPrice.toFixed(2)}</td>
                <td>${(hasDeal*100).toFixed(0)}% ${hasDeal > 0 ? '<span class="badge badge-deal">DEAL</span>' : ''}</td>
                <td>${(hasCoupon*100).toFixed(0)}%</td>
                <td>${(hasChoice*100).toFixed(0)}% ${hasChoice > 0 ? '<span class="badge badge-choice">CHOICE</span>' : ''}</td>
                <td>${(avgShare*100).toFixed(1)}%</td>
            </tr>`;
        }
        html += `</tbody></table>`;
        
        document.getElementById('levers_table_container').innerHTML = html;
    }

    // 5. CHART: EFFICIENCY (Scatter)
    function drawEfficiency() {
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const latestWeek = weeks[weeks.length - 1];
        const data = marketData.filter(d => d.week_date === latestWeek);

        const dataArray = [['Rank', 'Click Share', {type: 'string', role: 'style'}, {type: 'string', role: 'tooltip'}]];

        data.forEach(r => {
            const color = r.is_yaba_asin === 'Y' ? '#4285F4' : '#EA4335';
            const tooltip = `${r.final_brand} (${r.asin})\nRank: ${r.average_organic_rank}\nShare: ${(r.click_share*100).toFixed(2)}%\nPrecio: $${r.price}`;
            dataArray.push([r.average_organic_rank, r.click_share, `point {fill-color: ${color}; size: 5}`, tooltip]);
        });

        const dataTable = google.visualization.arrayToDataTable(dataArray);

        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: 1}, // 1 usually means left to right
            vAxis: {title: 'Click Share', format: 'percent'},
            legend: 'none',
            chartArea: {width: '85%', height: '80%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(dataTable, options);
    }

    // 6. GENERATE TEXT INSIGHTS
    function generateTextInsights() {
        const insightsList = document.getElementById('final-insights');
        const recsList = document.getElementById('final-recommendations');
        
        // Logic to build strings based on calculated vars in updateKPIs
        // Trend Insight
        const trendEl = document.getElementById('insight-trend');
        const shareTrend = document.getElementById('kpi-share-change').innerText;
        trendEl.innerText = shareTrend.includes('+') 
            ? "La marca muestra una tendencia positiva, ganando tracci칩n en las 칰ltimas semanas. Esto sugiere que las estrategias actuales de visibilidad est치n funcionando."
            : "Se observa una contracci칩n en la cuota de mercado. Es cr칤tico revisar si esto se debe a agresividad en precios de la competencia o p칠rdida de badges clave.";

        // Efficiency Insight
        const effEl = document.getElementById('insight-efficiency');
        effEl.innerHTML = `
            <li>Los ASINs con mejor rank org치nico (Top 5) capturan la mayor parte del share, confirmando la alta elasticidad de la posici칩n.</li>
            <li>Nuestra marca ${shareTrend.includes('+') ? 'est치 logrando' : 'necesita mejorar'} la conversi칩n de ranking a clicks.</li>
        `;

        // Conclusions
        insightsList.innerHTML = `
            <li><strong>Dominio del Mercado:</strong> ${topCompetitors[0]} lidera la categor칤a, ejerciendo presi칩n sobre precios y visibilidad.</li>
            <li><strong>Sensibilidad al Precio:</strong> Existe una clara correlaci칩n entre precios bajos y mayor Click Share en este nicho.</li>
            <li><strong>Impacto de Badges:</strong> Los productos con 'Amazon Choice' tienen una eficiencia Rank-to-Click superior al promedio.</li>
            <li><strong>Posici칩n de ${ourBrandName}:</strong> Actualmente somos una opci칩n ${document.getElementById('kpi-price-gap').innerText.includes('-$') ? 'competitiva en precio' : 'premium'}, lo que define nuestro techo de volumen.</li>
            <li><strong>Dependencia de Deals:</strong> Los picos de share coinciden con los d칤as de Deal, indicando una alta elasticidad promocional.</li>
        `;

        // Recommendations
        recsList.innerHTML = `
            <li><strong>Defensa de Rank:</strong> Invertir en PPC defensivo en las keywords donde tenemos Rank < 10 para maximizar el share org치nico.</li>
            <li><strong>Ajuste T치ctico de Precio:</strong> Si el share est치 cayendo, considerar un cup칩n del 5% para recuperar visibilidad sin erosionar el PVP base.</li>
            <li><strong>Contenido:</strong> Revisar t칤tulos e im치genes principales para mejorar el CTR frente a ${topCompetitors[0]}, dado que compartimos la SERP.</li>
        `;
    }

    // TAB 2: INTERACTIVE COMPARATOR
    function populateComparatorSelect() {
        const select = document.getElementById('comp-select');
        topCompetitors.forEach(comp => {
            const opt = document.createElement('option');
            opt.value = comp;
            opt.innerText = comp;
            select.appendChild(opt);
        });
    }

    function updateComparator() {
        const comp = document.getElementById('comp-select').value;
        const metric = document.getElementById('metric-select').value;
        if (!comp) return;

        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const dataArray = [['Semana', 'Nosotros', comp]];

        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            
            // Calc metric for Us
            const usRows = weekData.filter(d => d.final_brand === ourBrandName);
            let valUs = 0;
            if (metric === 'price') valUs = usRows.reduce((s,r)=>s+r.price,0) / (usRows.length||1);
            else if (metric === 'rank') valUs = usRows.reduce((s,r)=>s+r.average_organic_rank,0) / (usRows.length||1);
            else valUs = usRows.reduce((s,r)=>s+r.click_share,0); // Share total

            // Calc metric for Comp
            const compRows = weekData.filter(d => d.final_brand === comp);
            let valComp = 0;
            if (metric === 'price') valComp = compRows.reduce((s,r)=>s+r.price,0) / (compRows.length||1);
            else if (metric === 'rank') valComp = compRows.reduce((s,r)=>s+r.average_organic_rank,0) / (compRows.length||1);
            else valComp = compRows.reduce((s,r)=>s+r.click_share,0);

            dataArray.push([week.substring(5), valUs, valComp]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            title: `Evoluci칩n de ${metric.toUpperCase()} vs ${comp}`,
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335'],
            vAxis: { format: metric === 'share' ? 'percent' : (metric === 'price' ? '$#' : '#') }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_comparator'));
        chart.draw(data, options);
    }

    // UI UTILS
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        event.target.classList.add('active');
        
        // Redraw charts to fix width issues when hidden
        if(tabId === 'report') {
            drawTrends();
            drawBrandComp();
            drawEfficiency();
        } else {
            updateComparator();
        }
    }

</script>

</body>
</html>