<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Análisis de Mercado: NaturaleBio Matcha</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-secondary: #5F6368;
            --border-color: #E0E0E0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: var(--text-main);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Cards & Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: flex-start;
        }

        .insight-icon {
            background: #E8F0FE;
            color: var(--primary-color);
            padding: 8px;
            border-radius: 50%;
            font-size: 20px;
        }

        .recommendation-item {
            background: #FCE8E6;
            color: var(--danger-color);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            font-weight: 500;
        }

        /* Interactive Section */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: inherit;
            font-size: 14px;
            min-width: 200px;
        }

        .metric-card {
            text-align: center;
            padding: 20px;
            background: var(--bg-color);
            border-radius: 12px;
        }
        
        .metric-val {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-main);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Utility */
        .hidden { display: none; }
        .text-blue { color: var(--primary-color); }
        .text-red { color: var(--danger-color); }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-our { background: #E8F0FE; color: var(--primary-color); }
        .badge-comp { background: #FCE8E6; color: var(--danger-color); }

    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>Análisis de Mercado: NaturaleBio Matcha Premium</h1>
                <div class="subtitle">Análisis del Parent ASIN (Alemania) • Última actualización: 2026-01</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #5F6368;">Nuestra Marca</div>
                <div style="font-weight: 700; font-size: 18px; color: #4285F4;">NaturaleBio</div>
            </div>
        </header>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="static-tab">
            
            <!-- Section 1: Tendencia Global -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent (Clicks & Share)
                </div>
                <div id="chart_trend" class="chart-container"></div>
                <div style="margin-top: 16px; font-size: 14px; color: #5F6368;">
                    <strong>Análisis:</strong> El volumen de búsqueda ha caído de ~47k (W52) a ~27k (W01), una corrección post-temporada. Sin embargo, nuestra cuota de mercado (línea azul) se mantiene robusta. La caída en clicks absolutos es externa (demanda), no interna (competitividad).
                </div>
            </div>

            <div class="grid-2">
                <!-- Section 2: Competitividad -->
                <div class="card">
                    <div class="card-title">
                        <span class="material-icons">pie_chart</span>
                        2. Competitividad de Marca
                    </div>
                    <div id="chart_share" class="chart-container"></div>
                    <p style="font-size: 13px; color: #666; margin-top: 10px;">
                        Comparativa de Click Share: NaturaleBio vs Top 3 Competidores (Noritual Lab, Special Leaves, Vahdam).
                    </p>
                </div>

                <!-- Section 4: Eficiencia -->
                <div class="card">
                    <div class="card-title">
                        <span class="material-icons">scatter_plot</span>
                        4. Eficiencia (Rank vs Share)
                    </div>
                    <div id="chart_efficiency" class="chart-container"></div>
                    <p style="font-size: 13px; color: #666; margin-top: 10px;">
                        Eje Y: Click Share | Eje X: Rank Orgánico (Invertido). 
                        <br><span style="color: #4285F4">●</span> Nuestros ASINs | <span style="color: #EA4335">●</span> Competencia
                    </p>
                </div>
            </div>

            <!-- Section 3 & 5: Insights & Palancas -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-title">
                        <span class="material-icons">lightbulb</span>
                        5. Insights Clave & Palancas
                    </div>
                    <ul class="insight-list">
                        <li class="insight-item">
                            <span class="material-icons insight-icon">leaderboard</span>
                            <div>
                                <strong>Dominio defensivo:</strong> NaturaleBio mantiene el liderazgo con múltiples ASINs en el Top 10 orgánico. El ASIN B06XQ5DCYJ es el "Hero Product" con ~12.9% de share en W01.
                            </div>
                        </li>
                        <li class="insight-item">
                            <span class="material-icons insight-icon">local_offer</span>
                            <div>
                                <strong>Amenaza de Cupones:</strong> El competidor "NORITUAL LAB" (B0CNRX8G5S) logró un share masivo del 19.34% en W01 usando cupones agresivos (4 días activos), a pesar de tener un precio más alto (23.91€).
                            </div>
                        </li>
                        <li class="insight-item">
                            <span class="material-icons insight-icon">trending_down</span>
                            <div>
                                <strong>Contracción de Demanda:</strong> El volumen de búsqueda se redujo un ~43% semana a semana (W52 a W01). Es crítico optimizar el conversion rate ya que hay menos tráfico disponible.
                            </div>
                        </li>
                        <li class="insight-item">
                            <span class="material-icons insight-icon">verified</span>
                            <div>
                                <strong>Eficiencia de Rango:</strong> Nuestros ASINs tienen buen ranking (Avg 2-5), pero algunos competidores con peor ranking (ej. Rank 7) están capturando cuota desproporcionada gracias a distintivos visuales o precio.
                            </div>
                        </li>
                         <li class="insight-item">
                            <span class="material-icons insight-icon">euro</span>
                            <div>
                                <strong>Estrategia de Precio:</strong> NaturaleBio tiene una gama de precios amplia (10€ - 24€). El segmento bajo (10€) defiende volumen, el alto defiende margen, pero la competencia ataca el segmento premium (20€+) con éxito.
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="card" style="background-color: #FFF8F7; border-color: #FAD2CF;">
                    <div class="card-title" style="color: #B31412;">
                        <span class="material-icons">warning</span>
                        Acciones Recomendadas
                    </div>
                    <div class="recommendation-item">
                        1. Activación Defensiva de Cupones:
                        <div style="font-weight: 400; font-size: 13px; margin-top: 4px;">
                            Contraatacar a NORITUAL LAB activando un cupón del 5-10% en el ASIN B079VQ52MK (nuestro premium) para recuperar el share perdido en la gama alta.
                        </div>
                    </div>
                    <div class="recommendation-item">
                        2. Optimización de Hero Image:
                        <div style="font-weight: 400; font-size: 13px; margin-top: 4px;">
                            Revisar CTR del ASIN B06XQ69YCQ. Tiene buen precio (10.22€) y ranking (5), pero bajo share (3.35%). Posible debilidad visual frente a Vahdam.
                        </div>
                    </div>
                    <div class="recommendation-item">
                        3. Paquetización (Bundles):
                        <div style="font-weight: 400; font-size: 13px; margin-top: 4px;">
                            Dado que el volumen baja, aumentar el ticket medio creando packs de 2 o 3 unidades para fidelizar al cliente de matcha recurrente.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="interactive-tab" class="hidden">
            <div class="card">
                <div class="controls">
                    <div>
                        <label style="display:block; font-size: 12px; margin-bottom: 4px; color: #666;">Semana</label>
                        <select id="weekSelector" onchange="updateComparator()"></select>
                    </div>
                    <div>
                        <label style="display:block; font-size: 12px; margin-bottom: 4px; color: #666;">Comparar vs Competidor</label>
                        <select id="compSelector" onchange="updateComparator()"></select>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #eee;">
                    <div style="width: 45%;">
                        <div class="badge badge-our" style="width: fit-content; margin-bottom: 8px;">NOSOTROS (NaturaleBio)</div>
                        <h2 id="our-asin-title" style="font-size: 16px; margin: 0;">Promedio Portfolio</h2>
                    </div>
                    <div style="font-weight: 700; color: #999;">VS</div>
                    <div style="width: 45%; text-align: right;">
                        <div class="badge badge-comp" style="width: fit-content; margin-left: auto; margin-bottom: 8px;">COMPETENCIA</div>
                        <h2 id="comp-asin-title" style="font-size: 16px; margin: 0;">Seleccione Competidor</h2>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="metric-card">
                        <div class="metric-label">Click Share Gap</div>
                        <div id="share-gap" class="metric-val text-blue">0%</div>
                        <div id="share-detail" style="font-size: 12px; color: #666;">Us: 0% | Them: 0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Diferencia de Precio</div>
                        <div id="price-gap" class="metric-val">€0.00</div>
                        <div id="price-detail" style="font-size: 12px; color: #666;">Us: €0 | Them: €0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Diferencia de Ranking</div>
                        <div id="rank-gap" class="metric-val">0</div>
                        <div style="font-size: 12px; color: #666;">(Negativo es mejor para nosotros)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Intensidad Promocional</div>
                        <div id="promo-gap" class="metric-val">--</div>
                        <div id="promo-detail" style="font-size: 12px; color: #666;">Días con Cupón/Deal</div>
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <div id="chart_comparison" style="width: 100%; height: 300px;"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- DATA INJECTION -->
    <script>
        // Data generated from Python Analysis
        const marketData = [
            {"week": "2026-01", "brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium...", "price": 14.61, "org_rank": 2.0, "click_share": 12.9, "clicks": 3495.0, "is_yaba": "Y", "coupon_days": 0, "search_vol": 27092},
            {"week": "2026-01", "brand": "NaturaleBio", "asin": "B06XQ69YCQ", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium...", "price": 10.22, "org_rank": 5.0, "click_share": 3.35, "clicks": 907.6, "is_yaba": "Y", "coupon_days": 0, "search_vol": 27092},
            {"week": "2026-01", "brand": "NaturaleBio", "asin": "B079VQ52MK", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium...", "price": 24.53, "org_rank": 5.0, "click_share": 3.66, "clicks": 991.6, "is_yaba": "Y", "coupon_days": 0, "search_vol": 27092},
            {"week": "2026-01", "brand": "NaturaleBio", "asin": "B07SZFD3P9", "title": "NaturaleBio Matcha Ceremonial Grade 100g...", "price": 30.27, "org_rank": 2.68, "click_share": 2.06, "clicks": 558.1, "is_yaba": "Y", "coupon_days": 0, "search_vol": 27092},
            
            {"week": "2026-01", "brand": "VAHDAM", "asin": "B07MD4LB49", "title": "VAHDAM, Matcha Grüntee Pulver (100g)...", "price": 10.43, "org_rank": 9.0, "click_share": 3.15, "clicks": 853.4, "is_yaba": "N", "coupon_days": 0, "search_vol": 27092},
            {"week": "2026-01", "brand": "bioKontor", "asin": "B08XVX8V1T", "title": "Bio Matcha Pulver 100 g Japan...", "price": 11.99, "org_rank": 10.0, "click_share": 2.39, "clicks": 647.5, "is_yaba": "N", "coupon_days": 0, "search_vol": 27092},
            {"week": "2026-01", "brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "title": "Ceremonial Matcha - Reines Matcha Pulver...", "price": 23.91, "org_rank": 2.0, "click_share": 19.34, "clicks": 5239.7, "is_yaba": "N", "coupon_days": 4, "search_vol": 27092},
            {"week": "2026-01", "brand": "Special Leaves", "asin": "B0DRP6Y6XC", "title": "Matcha Pulver - 90g - 100% Natürlich...", "price": 10.39, "org_rank": 16.0, "click_share": 3.0, "clicks": 812.8, "is_yaba": "N", "coupon_days": 4, "search_vol": 27092},
            {"week": "2026-01", "brand": "Unknown", "asin": "B0F9B1LWQQ", "title": "UNREAL® 100g Ceremonial Bio Matcha...", "price": 31.27, "org_rank": 19.0, "click_share": 1.57, "clicks": 425.3, "is_yaba": "N", "coupon_days": 0, "search_vol": 27092},
            {"week": "2026-01", "brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "title": "Ceremonial Matcha Ryoku...", "price": 15.56, "org_rank": 6.0, "click_share": 7.38, "clicks": 1999.4, "is_yaba": "N", "coupon_days": 0, "search_vol": 27092},

            {"week": "2025-52", "brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "title": "NaturaleBio Matcha...", "price": 15.06, "org_rank": 2.0, "click_share": 11.66, "clicks": 5563.9, "is_yaba": "Y", "coupon_days": 0, "search_vol": 47718},
            {"week": "2025-52", "brand": "NaturaleBio", "asin": "B06XQ69YCQ", "title": "NaturaleBio Matcha...", "price": 10.54, "org_rank": 4.0, "click_share": 3.75, "clicks": 1789.4, "is_yaba": "Y", "coupon_days": 0, "search_vol": 47718},
            {"week": "2025-52", "brand": "NaturaleBio", "asin": "B079VQ52MK", "title": "NaturaleBio Matcha...", "price": 24.86, "org_rank": 5.0, "click_share": 3.49, "clicks": 1665.4, "is_yaba": "Y", "coupon_days": 0, "search_vol": 47718},
            {"week": "2025-52", "brand": "NaturaleBio", "asin": "B07SZFD3P9", "title": "NaturaleBio Matcha...", "price": 30.70, "org_rank": 23.0, "click_share": 2.93, "clicks": 1398.1, "is_yaba": "Y", "coupon_days": 0, "search_vol": 47718},
            {"week": "2025-52", "brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "title": "Ceremonial Matcha...", "price": 24.65, "org_rank": 2.0, "click_share": 18.77, "clicks": 8956.7, "is_yaba": "N", "coupon_days": 7, "search_vol": 47718},
            {"week": "2025-52", "brand": "VAHDAM", "asin": "B07MD4LB49", "title": "VAHDAM...", "price": 9.90, "org_rank": 7.0, "click_share": 4.19, "clicks": 1999.4, "is_yaba": "N", "coupon_days": 0, "search_vol": 47718}
        ];

        // --- GOOGLE CHARTS LOGIC ---
        google.charts.load('current', {'packages':['corechart', 'bar']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            drawTrendChart();
            drawShareChart();
            drawEfficiencyChart();
            populateInteractiveControls();
        }

        // 1. TREND CHART (Combo: Volume Bars + Share Lines)
        function drawTrendChart() {
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', 'Volumen Búsqueda');
            data.addColumn('number', 'NaturaleBio Share %');
            data.addColumn('number', 'Competencia Share %');

            const rows = weeks.map(week => {
                const weekData = marketData.filter(d => d.week === week);
                const vol = weekData.length > 0 ? weekData[0].search_vol : 0;
                
                const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
                const ourClicks = weekData.filter(d => d.is_yaba === 'Y').reduce((sum, d) => sum + d.clicks, 0);
                const compClicks = totalClicks - ourClicks;

                // Normalized share just for the chart (relative to dataset total captured)
                const totalShare = weekData.reduce((sum, d) => sum + d.click_share, 0);
                const ourShare = weekData.filter(d => d.is_yaba === 'Y').reduce((sum, d) => sum + d.click_share, 0);
                const compShare = totalShare - ourShare;

                return [week, vol, ourShare, compShare];
            });

            data.addRows(rows);

            const options = {
                title: 'Volumen de Mercado vs Cuota de Clics',
                seriesType: 'bars',
                series: {
                    1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3},
                    2: {type: 'line', targetAxisIndex: 1, color: '#EA4335', lineWidth: 3}
                },
                vAxes: {
                    0: {title: 'Volumen Búsqueda'},
                    1: {title: 'Click Share %', format: '#\'%\''}
                },
                hAxis: {title: 'Semana'},
                legend: {position: 'bottom'},
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        // 2. SHARE COMPETITIVENESS CHART
        function drawShareChart() {
            const weeks = [...new Set(marketData.map(d => d.week))].sort();
            const competitors = ['NORITUAL LAB', 'VAHDAM', 'Special Leaves']; // Top 3 fixed for simplicity

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            data.addColumn('number', 'NaturaleBio');
            competitors.forEach(c => data.addColumn('number', c));

            const rows = weeks.map(week => {
                const weekData = marketData.filter(d => d.week === week);
                const row = [week];
                
                // Us
                const ourShare = weekData.filter(d => d.brand === 'NaturaleBio').reduce((sum, d) => sum + d.click_share, 0);
                row.push(ourShare);

                // Them
                competitors.forEach(comp => {
                    const compShare = weekData.filter(d => d.brand === comp).reduce((sum, d) => sum + d.click_share, 0);
                    row.push(compShare);
                });
                return row;
            });

            data.addRows(rows);

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
                vAxis: { title: 'Click Share Total (%)' },
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_share'));
            chart.draw(data, options);
        }

        // 4. EFFICIENCY CHART (Scatter)
        function drawEfficiencyChart() {
            const latestWeek = "2026-01";
            const weekData = marketData.filter(d => d.week === latestWeek);

            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank (Inv)');
            data.addColumn('number', 'Click Share');
            data.addColumn({type: 'string', role: 'style'});
            data.addColumn({type: 'string', role: 'tooltip'});

            const rows = weekData.map(d => {
                // Invert rank for visual: Rank 1 is "High" on X
                // Actually, let's keep Rank 1 on left (standard) but explain it.
                // Or use standard Scatter: X = Rank, Y = Share.
                // Color: Blue for Us, Red for Them
                const color = d.is_yaba === 'Y' ? '#4285F4' : '#EA4335';
                const pointStyle = `point { size: 6; fill-color: ${color}; stroke-color: #fff; }`;
                const tooltip = `${d.brand} \nRank: ${d.org_rank} \nShare: ${d.click_share}% \nPrice: €${d.price}`;
                return [d.org_rank, d.click_share, pointStyle, tooltip];
            });

            data.addRows(rows);

            const options = {
                hAxis: { title: 'Ranking Orgánico (Menor es Mejor)', direction: 1, viewWindow: {min: 0, max: 25} },
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                chartArea: {width: '85%', height: '75%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- INTERACTIVE LOGIC ---
        function switchTab(tabName) {
            document.getElementById('static-tab').classList.add('hidden');
            document.getElementById('interactive-tab').classList.add('hidden');
            document.getElementsByClassName('tab-btn')[0].classList.remove('active');
            document.getElementsByClassName('tab-btn')[1].classList.remove('active');

            if(tabName === 'static') {
                document.getElementById('static-tab').classList.remove('hidden');
                document.getElementsByClassName('tab-btn')[0].classList.add('active');
            } else {
                document.getElementById('interactive-tab').classList.remove('hidden');
                document.getElementsByClassName('tab-btn')[1].classList.add('active');
                updateComparator(); // Refresh
            }
        }

        function populateInteractiveControls() {
            const weeks = [...new Set(marketData.map(d => d.week))].sort().reverse();
            const brands = [...new Set(marketData.filter(d => d.is_yaba === 'N').map(d => d.brand))].sort();

            const weekSel = document.getElementById('weekSelector');
            const compSel = document.getElementById('compSelector');

            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.add(opt);
            });

            brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                compSel.add(opt);
            });
            
            // Set default competitor to strongest
            if (brands.includes('NORITUAL LAB')) compSel.value = 'NORITUAL LAB';
        }

        function updateComparator() {
            const week = document.getElementById('weekSelector').value;
            const compBrand = document.getElementById('compSelector').value;
            const myBrand = "NaturaleBio";

            const weekData = marketData.filter(d => d.week === week);
            
            // Aggregates
            const myData = weekData.filter(d => d.brand === myBrand);
            const compData = weekData.filter(d => d.brand === compBrand);

            if (myData.length === 0 || compData.length === 0) return;

            // Weighted Avg Price based on Clicks (or simple avg if 0 clicks)
            const getAvgPrice = (arr) => {
                const totalClicks = arr.reduce((s, x) => s + x.clicks, 0);
                if (totalClicks === 0) return arr.reduce((s, x) => s + x.price, 0) / arr.length;
                return arr.reduce((s, x) => s + (x.price * x.clicks), 0) / totalClicks;
            };

            const myPrice = getAvgPrice(myData);
            const compPrice = getAvgPrice(compData);
            
            const myShare = myData.reduce((s, x) => s + x.click_share, 0);
            const compShare = compData.reduce((s, x) => s + x.click_share, 0);

            const myRank = myData.reduce((s, x) => s + x.org_rank, 0) / myData.length;
            const compRank = compData.reduce((s, x) => s + x.org_rank, 0) / compData.length;

            const myPromo = myData.some(d => d.coupon_days > 0);
            const compPromo = compData.some(d => d.coupon_days > 0);

            // Update DOM
            document.getElementById('comp-asin-title').innerText = compBrand;

            // Share Gap
            const shareGap = myShare - compShare;
            const shareEl = document.getElementById('share-gap');
            shareEl.innerText = (shareGap > 0 ? "+" : "") + shareGap.toFixed(1) + "%";
            shareEl.className = "metric-val " + (shareGap > 0 ? "text-blue" : "text-red");
            document.getElementById('share-detail').innerText = `Us: ${myShare.toFixed(1)}% | Them: ${compShare.toFixed(1)}%`;

            // Price Gap
            const priceGap = myPrice - compPrice;
            const priceEl = document.getElementById('price-gap');
            priceEl.innerText = (priceGap > 0 ? "+" : "") + "€" + priceGap.toFixed(2);
            // Higher price usually red contextually, but strategy depends. Let's keep neutral color or green if we are cheaper?
            // Let's assume being cheaper is "green" for competitiveness usually, but "red" for margin. Let's stick to neutral black.
            priceEl.style.color = "#202124"; 
            document.getElementById('price-detail').innerText = `Us: €${myPrice.toFixed(2)} | Them: €${compPrice.toFixed(2)}`;

            // Rank Gap (Lower is better)
            const rankGap = myRank - compRank;
            const rankEl = document.getElementById('rank-gap');
            rankEl.innerText = (rankGap > 0 ? "+" : "") + rankGap.toFixed(1); // Positive means we are worse (higher rank number)
            rankEl.className = "metric-val " + (rankGap < 0 ? "text-blue" : "text-red");

            // Promo
            document.getElementById('promo-gap').innerText = compPromo ? "ALERTA" : "Normal";
            document.getElementById('promo-gap').className = "metric-val " + (compPromo ? "text-red" : "text-blue");
            document.getElementById('promo-detail').innerText = `Cupón Activo: ${compPromo ? "SÍ" : "NO"}`;

            // Comparison Chart
            drawComparisonChart(myShare, compShare, myPrice, compPrice);
        }

        function drawComparisonChart(myShare, compShare, myPrice, compPrice) {
            const data = google.visualization.arrayToDataTable([
                ['Métrica', 'NaturaleBio', 'Competidor'],
                ['Share Market (%)', myShare, compShare],
                ['Precio Promedio (€)', myPrice, compPrice]
            ]);

            const options = {
                title: 'Comparativa Directa',
                chartArea: {width: '60%'},
                hAxis: {minValue: 0},
                colors: ['#4285F4', '#EA4335']
            };

            const chart = new google.visualization.BarChart(document.getElementById('chart_comparison'));
            chart.draw(data, options);
        }

    </script>
</body>
</html>