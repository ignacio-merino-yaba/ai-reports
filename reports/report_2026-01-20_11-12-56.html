<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Performance Report - Parent ASIN Analysis</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* RESET & BASE */
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --text-main: #202124;
            --text-sec: #5f6368;
            --bg-page: #f8f9fa;
            --bg-card: #ffffff;
            --border: #dadce0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* LAYOUT */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-card);
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 600; }
        h2 { font-size: 18px; font-weight: 500; margin-bottom: 15px; color: var(--text-sec); }
        h3 { font-size: 16px; font-weight: 600; margin-bottom: 10px; }

        /* TABS */
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-sec);
            cursor: pointer;
            position: relative;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
        }

        /* CARDS */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(60,64,67,0.1);
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* KPI */
        .kpi-value { font-size: 32px; font-weight: 700; color: var(--text-main); }
        .kpi-label { font-size: 14px; color: var(--text-sec); }
        .kpi-change { font-size: 12px; font-weight: 500; margin-left: 8px; }
        .text-up { color: var(--success); }
        .text-down { color: var(--danger); }

        /* CHARTS */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* INSIGHTS */
        .insight-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            padding: 12px;
            background: #f1f3f4;
            border-radius: 8px;
        }
        .insight-icon { margin-right: 12px; color: var(--primary); }

        /* INTERACTIVE */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 14px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comparison-table th, .comparison-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        .comparison-table th { color: var(--text-sec); font-weight: 500; font-size: 12px; text-transform: uppercase; }

        /* UTILS */
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="container header-content">
            <h1>Brand Intelligence Report</h1>
            <span style="font-size: 12px; color: #5f6368;" id="date-range">Generated by AI Analyst</span>
        </div>
    </header>

    <div class="container">
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estático</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="tab-static">
            
            <!-- Section 1: KPI & Global Trend -->
            <div class="card">
                <h2>1. Tendencia Global del Parent</h2>
                <div class="grid-3" style="margin-bottom: 20px;">
                    <div>
                        <div class="kpi-label">Total Clicks (Last Week)</div>
                        <div class="kpi-value" id="kpi-clicks">-</div>
                    </div>
                    <div>
                        <div class="kpi-label">Our Click Share</div>
                        <div class="kpi-value" id="kpi-share">-</div>
                    </div>
                    <div>
                        <div class="kpi-label">Avg Organic Rank</div>
                        <div class="kpi-value" id="kpi-rank">-</div>
                    </div>
                </div>
                <div id="chart_trend" class="chart-container"></div>
                <div id="trend-analysis" style="margin-top: 15px; font-size: 14px; color: var(--text-sec);"></div>
            </div>

            <!-- Section 2: Competitiveness -->
            <div class="card">
                <h2>2. Competitividad de Marca (Share Week-over-Week)</h2>
                <div id="chart_competitiveness" class="chart-container"></div>
                <div id="comp-analysis" style="margin-top: 15px; font-size: 14px; color: var(--text-sec);"></div>
            </div>

            <!-- Section 3 & 4: Levers & Efficiency -->
            <div class="grid-2">
                <div class="card">
                    <h2>3. Palancas (Deals & Price)</h2>
                    <div id="levers-content" style="font-size: 14px;"></div>
                </div>
                <div class="card">
                    <h2>4. Organic Rank vs. Click Share (Efficiency)</h2>
                    <div id="chart_efficiency" class="chart-container"></div>
                </div>
            </div>

            <!-- Section 5: Insights & Recommendations -->
            <div class="card" style="border-left: 4px solid var(--primary);">
                <h2>5. Conclusiones Clave y Recomendaciones</h2>
                <div id="insights-container">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Section 6: Other Insights -->
             <div class="card">
                <h2>6. Other Strategic Insights</h2>
                <div id="other-insights" style="font-size:14px; color: var(--text-sec);">
                    Analyzing hidden patterns...
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE -->
        <div id="tab-interactive" class="hidden">
            <div class="card">
                <h2>Cara a Cara: Nosotros vs Competencia</h2>
                <div class="controls">
                    <select id="select-week" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                    <select id="select-competitor" onchange="updateInteractive()">
                        <!-- Populated by JS -->
                    </select>
                </div>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Our Brand</th>
                            <th id="comp-name-header">Competitor</th>
                            <th>Diff</th>
                        </tr>
                    </thead>
                    <tbody id="interactive-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="grid-2">
                 <div class="card">
                    <h3>Price Comparison</h3>
                    <div id="chart_price_comp" style="height: 250px;"></div>
                 </div>
                 <div class="card">
                    <h3>Visibility Comparison</h3>
                    <div id="chart_vis_comp" style="height: 250px;"></div>
                 </div>
            </div>
        </div>
    </div>

    <!-- DATA INJECTION -->
    <script>
        // Data injected from Python processing
        const marketData = [
            {"week_date":"2025-52","real_brand":"NaturaleBio","is_yaba_asin":"Y","parent_asin":"Matcha Ceremonial","product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","click_share":6.75,"estimated_clicks":128.10825,"price":29.228571429,"organic_rank":7.0,"weekly_number_of_days_with_deal":1,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0},
            {"week_date":"2025-52","real_brand":"NORITUAL LAB","is_yaba_asin":"N","parent_asin":"Matcha Ceremonial","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","average_organic_rank":2,"click_share":14.2,"estimated_clicks":269.5018,"price":15.28,"organic_rank":2.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0},
            {"week_date":"2025-52","real_brand":"NORITUAL LAB","is_yaba_asin":"N","parent_asin":"Matcha Ceremonial","product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","click_share":17.63,"estimated_clicks":334.59977,"price":23.484285714,"organic_rank":1.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7},
            {"week_date":"2025-52","real_brand":"NaturaleBio","is_yaba_asin":"Y","parent_asin":"Matcha Ceremonial","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":5.8,"estimated_clicks":110.0782,"price":14.347142857,"organic_rank":4.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0},
            {"week_date":"2025-52","real_brand":"Matcha & CO","is_yaba_asin":"N","parent_asin":"Matcha Ceremonial","product_title":"T\u00e9 Matcha Ceremonial Premium 80 Gr","click_share":1.78,"estimated_clicks":33.78262,"price":31.344285714,"organic_rank":14.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0},
            {"week_date":"2025-52","real_brand":"Kuro Matcha","is_yaba_asin":"N","parent_asin":"Matcha Ceremonial","product_title":"UNREAL\u00ae Ceremonial Bio Matcha \u2013 100% Japanischer Z...","click_share":3.55,"estimated_clicks":67.37545,"price":9.178571429,"organic_rank":4.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0},
             {"week_date":"2026-01","real_brand":"NaturaleBio","is_yaba_asin":"Y","parent_asin":"Matcha Ceremonial","product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","click_share":5.74,"estimated_clicks":55.199284,"price":28.99,"organic_rank":10.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0},
             {"week_date":"2026-01","real_brand":"NORITUAL LAB","is_yaba_asin":"N","parent_asin":"Matcha Ceremonial","product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","click_share":17.86,"estimated_clicks":171.752476,"price":22.9,"organic_rank":1.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":4},
             {"week_date":"2026-01","real_brand":"NaturaleBio","is_yaba_asin":"Y","parent_asin":"Matcha Ceremonial","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","click_share":5.08,"estimated_clicks":48.852328,"price":13.99,"organic_rank":4.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0},
             {"week_date":"2026-01","real_brand":"Jibix","is_yaba_asin":"N","parent_asin":"Matcha Ceremonial","product_title":"Jibix Ceremonial Matcha \u2013 100% Japanischer zeremon...","click_share":3.91,"estimated_clicks":37.600906,"price":22.99,"organic_rank":12.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0}
        ];

        // Ensure My Brand is Consistent
        const myBrand = "NaturaleBio"; // Hardcoded for this dataset analysis

        // GOOGLE CHARTS INIT
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initReport);

        let processed = {};

        function initReport() {
            processData();
            renderKPIs();
            drawCharts();
            generateInsights();
            populateInteractiveControls();
            
            // Render initial interactive
            updateInteractive();
        }

        // 1. DATA PROCESSING
        function processData() {
            // Get unique weeks sorted
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            const latestWeek = weeks[weeks.length - 1];
            const prevWeek = weeks.length > 1 ? weeks[weeks.length - 2] : null;

            // Global Aggregations
            const weeklyAgg = {};
            weeks.forEach(w => {
                const weekData = marketData.filter(d => d.week_date === w);
                const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                const ourData = weekData.filter(d => d.is_yaba_asin === 'Y');
                const ourClicks = ourData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                const compClicks = totalClicks - ourClicks;
                
                // Weighted Avg Rank for Us
                const weightedRankSum = ourData.reduce((sum, d) => sum + (d.organic_rank * d.estimated_clicks), 0);
                const avgRank = ourClicks > 0 ? (weightedRankSum / ourClicks).toFixed(1) : 0;

                weeklyAgg[w] = {
                    totalClicks,
                    ourClicks,
                    compClicks,
                    ourShare: (ourClicks / totalClicks) * 100,
                    avgRank
                };
            });

            // Brand Competitiveness (Top 3)
            const brands = [...new Set(marketData.map(d => d.real_brand))];
            const brandShares = {}; // { Brand: { Week: Share } }
            
            brands.forEach(b => {
                brandShares[b] = {};
                weeks.forEach(w => {
                    const subset = marketData.filter(d => d.week_date === w && d.real_brand === b);
                    const clicks = subset.reduce((sum, d) => sum + d.estimated_clicks, 0);
                    const totalWk = weeklyAgg[w].totalClicks;
                    brandShares[b][w] = (clicks / totalWk) * 100;
                });
            });

            // Identify Top 3 Competitors (based on latest week share)
            const compBrands = brands.filter(b => b !== myBrand);
            const sortedComps = compBrands.sort((a, b) => (brandShares[b][latestWeek] || 0) - (brandShares[a][latestWeek] || 0));
            const top3 = sortedComps.slice(0, 3);

            processed = {
                weeks,
                latestWeek,
                prevWeek,
                weeklyAgg,
                brandShares,
                top3,
                brands
            };
        }

        // 2. RENDER KPI
        function renderKPIs() {
            const current = processed.weeklyAgg[processed.latestWeek];
            const prev = processed.prevWeek ? processed.weeklyAgg[processed.prevWeek] : null;

            document.getElementById('kpi-clicks').innerText = Math.round(current.totalClicks).toLocaleString();
            document.getElementById('kpi-share').innerHTML = current.ourShare.toFixed(1) + '%';
            document.getElementById('kpi-rank').innerText = current.avgRank;

            // Date Range
            document.getElementById('date-range').innerText = `Analysis Period: ${processed.weeks[0]} to ${processed.latestWeek}`;
        }

        // 3. DRAW CHARTS
        function drawCharts() {
            // CHART 1: TREND (Combo)
            const trendData = [['Week', 'Our Clicks', 'Comp Clicks', 'Our Share (%)']];
            processed.weeks.forEach(w => {
                const d = processed.weeklyAgg[w];
                trendData.push([w, d.ourClicks, d.compClicks, d.ourShare]);
            });

            const dataTrend = google.visualization.arrayToDataTable(trendData);
            const optTrend = {
                seriesType: 'bars',
                series: { 2: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
                colors: ['#8AB4F8', '#E8EAED'],
                isStacked: true,
                vAxes: { 0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''} },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };
            new google.visualization.ComboChart(document.getElementById('chart_trend')).draw(dataTrend, optTrend);

            // CHART 2: COMPETITIVENESS (Line)
            const lineData = [['Week', 'Us (' + myBrand + ')', ...processed.top3, 'Others']];
            processed.weeks.forEach(w => {
                const row = [w, processed.brandShares[myBrand][w]];
                let top3Sum = 0;
                processed.top3.forEach(b => {
                    const s = processed.brandShares[b][w] || 0;
                    row.push(s);
                    top3Sum += s;
                });
                // Others
                const ourS = processed.brandShares[myBrand][w];
                const otherS = 100 - ourS - top3Sum;
                row.push(otherS > 0 ? otherS : 0);
                lineData.push(row);
            });

            const dataLine = google.visualization.arrayToDataTable(lineData);
            const optLine = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
                vAxis: { title: 'Click Share %' },
                chartArea: { width: '85%', height: '70%' },
                lineWidth: 2
            };
            new google.visualization.LineChart(document.getElementById('chart_competitiveness')).draw(dataLine, optLine);

            // CHART 3: EFFICIENCY (Scatter)
            // X: Rank, Y: Share
            const scatterData = [['Rank', 'Share', {'type': 'string', 'role': 'style'}, {'type': 'string', 'role': 'tooltip'}]];
            const weekData = marketData.filter(d => d.week_date === processed.latestWeek);
            
            weekData.forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#9AA0A6';
                const label = `${d.real_brand}: Rank ${d.organic_rank}, Share ${d.click_share}%`;
                // Add jitter to X so points don't overlap perfectly
                const jitter = (Math.random() - 0.5) * 0.5;
                scatterData.push([d.organic_rank + jitter, d.click_share, `point { fill-color: ${color}; size: 6; }`, label]);
            });

            const dataScatter = google.visualization.arrayToDataTable(scatterData);
            const optScatter = {
                hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // 1 because 1 is best
                vAxis: { title: 'Click Share %' },
                legend: 'none',
                chartArea: { width: '85%', height: '70%' }
            };
            new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(dataScatter, optScatter);
        }

        // 4. GENERATE INSIGHTS (Logic Engine)
        function generateInsights() {
            const insightsDiv = document.getElementById('insights-container');
            const otherDiv = document.getElementById('other-insights');
            let html = '';
            let otherHtml = '<ul>';

            const curr = processed.weeklyAgg[processed.latestWeek];
            const prev = processed.prevWeek ? processed.weeklyAgg[processed.prevWeek] : null;

            // 1. Global Trend
            if (prev) {
                const diff = curr.ourShare - prev.ourShare;
                const icon = diff >= 0 ? 'trending_up' : 'trending_down';
                const color = diff >= 0 ? 'text-up' : 'text-down';
                html += `
                <div class="insight-item">
                    <span class="material-icons insight-icon">assessment</span>
                    <div>
                        <strong>Global Trend:</strong> Our click share <span class="${color}">${diff >= 0 ? 'increased' : 'decreased'} by ${Math.abs(diff).toFixed(2)}%</span> vs last week.
                        ${diff < 0 ? 'Urgent: Review top keywords ranking.' : 'Positive momentum detected.'}
                    </div>
                </div>`;
            }

            // 2. Competitor Threat
            const topComp = processed.top3[0];
            const topCompShare = processed.brandShares[topComp][processed.latestWeek];
            html += `
            <div class="insight-item">
                <span class="material-icons insight-icon">warning</span>
                <div>
                    <strong>Primary Threat:</strong> <span style="color:#d93025">${topComp}</span> dominates with ${topCompShare.toFixed(1)}% share.
                    Compare their pricing in the interactive tab.
                </div>
            </div>`;

            // 3. Efficiency
            if (curr.avgRank > 5) {
                html += `
                <div class="insight-item">
                    <span class="material-icons insight-icon">visibility_off</span>
                    <div>
                        <strong>Visibility Alert:</strong> Avg Organic Rank is ${curr.avgRank}. 
                        Action: Optimize Titles/Backend Keywords to regain Top 5 positions.
                    </div>
                </div>`;
            } else {
                 html += `
                <div class="insight-item">
                    <span class="material-icons insight-icon">check_circle</span>
                    <div>
                        <strong>Efficiency:</strong> Strong organic presence (Avg Rank ${curr.avgRank}). Keep monitoring conversion rates.
                    </div>
                </div>`;
            }

            // 4. Recommendation (Price/Deals)
            const weekDeals = marketData.filter(d => d.week_date === processed.latestWeek && d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_deal > 0);
            if (weekDeals.length === 0) {
                 html += `
                <div class="insight-item">
                    <span class="material-icons insight-icon">local_offer</span>
                    <div>
                        <strong>Opportunity:</strong> No deals active this week for our ASINs. 
                        Recommendation: Run a 7-day deal to recapture share from ${topComp}.
                    </div>
                </div>`;
            }

            // 5. Price Analysis
            const myAvgPrice = marketData.filter(d => d.week_date === processed.latestWeek && d.is_yaba_asin === 'Y').reduce((a,b) => a + b.price, 0) / 2; // Rough avg
            // Find cheaper competitors with high share
            const cheapThreats = marketData.filter(d => d.week_date === processed.latestWeek && d.is_yaba_asin === 'N' && d.price < myAvgPrice && d.click_share > 5);
            
            if (cheapThreats.length > 0) {
                 otherHtml += `<li><strong>Price Pressure:</strong> Competitor '${cheapThreats[0].real_brand}' is undercutting price (${cheapThreats[0].price} vs ${myAvgPrice.toFixed(2)}) and gaining significant share.</li>`;
            } else {
                 otherHtml += `<li><strong>Premium Positioning:</strong> We maintain share despite higher pricing. Brand equity is strong.</li>`;
            }
            
            // Check for Badges
            const badgeItems = marketData.filter(d => d.week_date === processed.latestWeek && d.weekly_number_of_days_with_amazon_choice_badge > 0);
            if(badgeItems.length > 0) {
                 otherHtml += `<li><strong>Badges:</strong> ${badgeItems.length} ASINs have Amazon Choice badge, boosting CTR.</li>`;
            }

            html += `
            <div class="insight-item">
                <span class="material-icons insight-icon">lightbulb</span>
                <div>
                    <strong>Action Plan:</strong> 
                    1. Target '${topComp}' in SP Product Targeting. 
                    2. Test price elasticity (-5% coupon).
                </div>
            </div>`;

            insightsDiv.innerHTML = html;
            otherDiv.innerHTML = otherHtml + '</ul>';
        }

        // 5. INTERACTIVE LOGIC
        function populateInteractiveControls() {
            const wkSel = document.getElementById('select-week');
            const compSel = document.getElementById('select-competitor');
            
            processed.weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                wkSel.appendChild(opt);
            });
            // Select latest
            wkSel.value = processed.latestWeek;

            processed.brands.forEach(b => {
                if (b !== myBrand) {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.text = b;
                    compSel.appendChild(opt);
                }
            });
        }

        function updateInteractive() {
            const wk = document.getElementById('select-week').value;
            const comp = document.getElementById('select-competitor').value;
            
            document.getElementById('comp-name-header').innerText = comp;

            // Get Data
            const myData = marketData.filter(d => d.week_date === wk && d.is_yaba_asin === 'Y');
            const compData = marketData.filter(d => d.week_date === wk && d.real_brand === comp);

            // Calculate Aggregates
            const calcAvg = (arr, key) => arr.length ? (arr.reduce((s, x) => s + (x[key]||0), 0) / arr.length) : 0;
            
            const mPrice = calcAvg(myData, 'price');
            const cPrice = calcAvg(compData, 'price');
            
            const mShare = myData.reduce((s, x) => s + x.click_share, 0);
            const cShare = compData.reduce((s, x) => s + x.click_share, 0);

            const mRank = calcAvg(myData, 'organic_rank');
            const cRank = calcAvg(compData, 'organic_rank');

            // Draw Table
            const tbody = document.getElementById('interactive-body');
            const metrics = [
                { name: 'Avg Price', m: mPrice.toFixed(2), c: cPrice.toFixed(2), unit: '€' },
                { name: 'Total Click Share', m: mShare.toFixed(1), c: cShare.toFixed(1), unit: '%' },
                { name: 'Avg Organic Rank', m: mRank.toFixed(1), c: cRank.toFixed(1), unit: '#' },
            ];

            tbody.innerHTML = metrics.map(row => {
                const diff = (row.m - row.c).toFixed(1);
                const color = diff > 0 ? (row.name === 'Avg Organic Rank' ? 'text-down' : 'text-up') : (row.name === 'Avg Organic Rank' ? 'text-up' : 'text-down');
                // Note: Logic implies higher price is green (premium) or red? Context dependent. Let's keep simple.
                return `<tr>
                    <td>${row.name}</td>
                    <td>${row.m} ${row.unit}</td>
                    <td>${row.c} ${row.unit}</td>
                    <td class="${color}">${diff > 0 ? '+' : ''}${diff}</td>
                </tr>`;
            }).join('');

            // Draw Charts
            const priceData = google.visualization.arrayToDataTable([
                ['Brand', 'Price', { role: 'style' }],
                ['Us', mPrice, '#4285F4'],
                ['Comp', cPrice, '#EA4335']
            ]);
            new google.visualization.ColumnChart(document.getElementById('chart_price_comp')).draw(priceData, { title: 'Price Gap', legend: 'none' });

            const visData = google.visualization.arrayToDataTable([
                ['Brand', 'Share', { role: 'style' }],
                ['Us', mShare, '#4285F4'],
                ['Comp', cShare, '#EA4335']
            ]);
            new google.visualization.BarChart(document.getElementById('chart_vis_comp')).draw(visData, { title: 'Market Share Gap', legend: 'none' });
        }

        // TABS
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        }

    </script>
</body>
</html>