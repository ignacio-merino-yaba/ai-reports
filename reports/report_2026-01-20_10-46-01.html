<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence: Matcha Premium</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #4285F4;
            --primary-light: #E8F0FE;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-800: #1f2937;
            --white: #ffffff;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--white);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .header .badge {
            background: var(--primary-light);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 600;
            color: var(--gray-800);
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: var(--white);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards & Sections */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card h2 {
            margin-top: 0;
            font-size: 18px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 12px;
            margin-bottom: 20px;
        }

        .metric-big {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-label {
            color: #6b7280;
            font-size: 14px;
        }

        .insight-list {
            list-style: none;
            padding: 0;
        }

        .insight-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .insight-list li:last-child { border-bottom: none; }

        .icon-box {
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px;
            border-radius: 8px;
            display: flex;
        }

        /* Recommendations */
        .rec-card {
            background: #f0f9ff;
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }

        /* Comparator */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            background: var(--white);
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
            min-width: 200px;
        }

        .vs-badge {
            background: var(--gray-800);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Charts */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        .kpi-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .kpi-box {
            text-align: center;
            flex: 1;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Parent ASIN Analysis: Matcha Premium</h1>
                <div style="color: #6b7280; font-size: 14px; margin-top: 4px;">Reporting Period: <span id="date-range">Calculating...</span></div>
            </div>
            <div class="badge">
                <span class="material-icons" style="font-size: 16px; vertical-align: text-bottom;">verified</span>
                Our Brand: <span id="brand-name">Loading...</span>
            </div>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('report')">
                <span class="material-icons">analytics</span> Reporte Ejecutivo
            </button>
            <button class="tab-btn" onclick="switchTab('comparator')">
                <span class="material-icons">compare_arrows</span> Comparador Interactivo
            </button>
        </div>

        <!-- TAB 1: EXECUTIVE REPORT -->
        <div id="report" class="tab-content active">
            
            <!-- Section 1: Global Trend -->
            <div class="card">
                <h2><span class="material-icons">trending_up</span> 1. Tendencia Global del Parent (Tracción y Visibilidad)</h2>
                <div id="chart_trend" class="chart-container"></div>
                <div class="insight-list" style="margin-top: 16px; font-size: 14px; color: #555;">
                    <p><strong>Interpretación:</strong> Las barras representan el volumen total de clics del mercado (demanda). La línea azul indica nuestro Click Share. Un aumento en la línea azul con barras estables indica ganancia neta de competitividad.</p>
                </div>
            </div>

            <!-- Section 2: Competitiveness -->
            <div class="card">
                <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Click Share vs Top 3)</h2>
                <div id="chart_competitiveness" class="chart-container"></div>
            </div>

            <!-- Section 3 & 4: Efficiency & Levers -->
            <div class="grid-2">
                <div class="card">
                    <h2><span class="material-icons">speed</span> 4. Eficiencia: Organic Rank vs Click Share</h2>
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Analizando la última semana. Eje X: Ranking (Menor es mejor). Eje Y: Cuota de Clics.</p>
                    <div id="chart_efficiency" class="chart-container"></div>
                </div>
                
                <div class="card">
                    <h2><span class="material-icons">tune</span> 3. Palancas de Crecimiento (Última Semana)</h2>
                    <div id="levers_table"></div>
                </div>
            </div>

            <!-- Section 5: Insights & Recommendations -->
            <div class="grid-2">
                <div class="card">
                    <h2><span class="material-icons">lightbulb</span> 5. Insights Clave</h2>
                    <ul class="insight-list" id="insights_list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
                <div class="card">
                    <h2><span class="material-icons">assignment_turned_in</span> Recomendaciones Accionables</h2>
                    <div id="recommendations_list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
             <!-- Section 6: Other Insights -->
             <div class="card">
                <h2><span class="material-icons">extension</span> 6. Other Insights (Oportunidades Ocultas)</h2>
                <ul class="insight-list">
                    <li>
                        <div class="icon-box"><span class="material-icons" style="font-size: 18px">visibility</span></div>
                        <span style="margin-left: 10px;"><strong>Volatilidad del Mercado:</strong> Se observan fluctuaciones significativas en el volumen de búsqueda semanal. Recomendamos alinear las campañas de PPC con los picos de demanda del mercado (barras grises en gráfico 1).</span>
                    </li>
                    <li>
                        <div class="icon-box"><span class="material-icons" style="font-size: 18px">new_releases</span></div>
                        <span style="margin-left: 10px;"><strong>Nuevos Entrantes:</strong> Marcas como 'Special Leaves' están ganando tracción orgánica rápidamente. Monitorizar sus precios y creatividades.</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="comparator" class="tab-content">
            <div class="controls">
                <div>
                    <label style="display:block; font-size:12px; margin-bottom:4px; font-weight:600;">Semana de Análisis</label>
                    <select id="comp_week_select" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="display:block; font-size:12px; margin-bottom:4px; font-weight:600;">Competidor a Analizar</label>
                    <select id="comp_brand_select" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="grid-2">
                <!-- Side by Side Stats -->
                <div class="card">
                    <h2><span class="material-icons">compare</span> Cara a Cara: Nosotros vs Competidor</h2>
                    <div id="comparison_table_div" style="width: 100%;"></div>
                </div>

                <!-- Price vs Share Chart -->
                <div class="card">
                    <h2><span class="material-icons">payments</span> Posicionamiento de Precio</h2>
                    <div id="chart_price_comp" class="chart-container"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. DATA INJECTION ---
        // Contains processed data from the Python step
        const marketData = [{"week_date": "2025-52", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 24.648571429, "estimated_clicks": 8954.802862, "click_share": 18.77, "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0}, {"week_date": "2025-52", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 15.058571429, "estimated_clicks": 5562.759796, "click_share": 11.66, "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.538571429, "estimated_clicks": 1789.05225, "click_share": 3.75, "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.855714286, "estimated_clicks": 1665.011294, "click_share": 3.49, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...", "price": 16.037142857, "estimated_clicks": 4017.018652, "click_share": 8.42, "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Grüntee-Pulver au...", "price": 16.037142857, "estimated_clicks": 4017.018652, "click_share": 8.42, "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "VAHDAM", "is_yaba_asin": "N", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Grüntee Pulver (100g, 50+ Tassen) A...", "price": 9.895714286, "estimated_clicks": 1998.967714, "click_share": 4.19, "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "bioKontor", "is_yaba_asin": "N", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 12.367142857, "estimated_clicks": 1164.076664, "click_share": 2.44, "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "bioKontor", "is_yaba_asin": "N", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 12.367142857, "estimated_clicks": 1164.076664, "click_share": 2.44, "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "Special Leaves", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.71, "estimated_clicks": 1622.07404, "click_share": 3.4, "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "Special Leaves", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.71, "estimated_clicks": 1622.07404, "click_share": 3.4, "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "VAHDAM", "is_yaba_asin": "N", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "price": 9.895714286, "estimated_clicks": 701.308482, "click_share": 1.47, "average_organic_rank": 20.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-52", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.704285714, "estimated_clicks": 1397.846158, "click_share": 2.93, "average_organic_rank": 23.0, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.27, "estimated_clicks": 723.89748, "click_share": 2.68, "average_organic_rank": NaN, "weekly_number_of_days_with_deal": NaN, "weekly_number_of_days_with_coupon": NaN, "weekly_number_of_days_with_best_seller_badge": NaN, "weekly_number_of_days_with_amazon_choice_badge": NaN}, {"week_date": "2026-01", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 14.6075, "estimated_clicks": 3484.4319, "click_share": 12.9, "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 23.91, "estimated_clicks": 5223.94674, "click_share": 19.34, "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 4.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.5275, "estimated_clicks": 988.60626, "click_share": 3.66, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.2225, "estimated_clicks": 904.87185, "click_share": 3.35, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.5575, "estimated_clicks": 1993.41918, "click_share": 7.38, "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.5575, "estimated_clicks": 1993.41918, "click_share": 7.38, "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "VAHDAM", "is_yaba_asin": "N", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 10.43, "estimated_clicks": 850.84965, "click_share": 3.15, "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "bioKontor", "is_yaba_asin": "N", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "estimated_clicks": 645.56529, "click_share": 2.39, "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "bioKontor", "is_yaba_asin": "N", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "estimated_clicks": 645.56529, "click_share": 2.39, "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "Special Leaves", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "estimated_clicks": 810.333, "click_share": 3.0, "average_organic_rank": 16.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 4.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "Special Leaves", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "estimated_clicks": 810.333, "click_share": 3.0, "average_organic_rank": 16.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 4.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2026-01", "final_brand": "UNREAL\u00ae", "is_yaba_asin": "N", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "price": 31.2725, "estimated_clicks": 424.07427, "click_share": 1.57, "average_organic_rank": 19.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 14.084285714, "estimated_clicks": 6803.60018, "click_share": 11.18, "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 24.03, "estimated_clicks": 10138.45966, "click_share": 16.66, "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 9.2, "estimated_clicks": 2342.92135, "click_share": 3.85, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 23.075714286, "estimated_clicks": 2245.55319, "click_share": 3.69, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.635714286, "estimated_clicks": 5385.67635, "click_share": 8.85, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "NORITUAL LAB", "is_yaba_asin": "N", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.635714286, "estimated_clicks": 5385.67635, "click_share": 8.85, "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "VAHDAM", "is_yaba_asin": "N", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 9.005714286, "estimated_clicks": 2123.84299, "click_share": 3.49, "average_organic_rank": 8.0, "weekly_number_of_days_with_deal": 5.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "Ceremonial", "is_yaba_asin": "N", "asin": "B0G1T7N675", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "price": 8.898571429, "estimated_clicks": 1557.89056, "click_share": 2.56, "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "Jean", "is_yaba_asin": "N", "asin": "B0F5BVFRC1", "product_title": "Jean & Len Handcreme I Love You So Matcha, f\u00fcr nor...", "price": 3.095714286, "estimated_clicks": 1168.41792, "click_share": 1.92, "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}, {"week_date": "2025-51", "final_brand": "Special Leaves", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.44, "estimated_clicks": 2117.75748, "click_share": 3.48, "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0}, {"week_date": "2025-51", "final_brand": "Special Leaves", "is_yaba_asin": "N", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.44, "estimated_clicks": 2117.75748, "click_share": 3.48, "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0}, {"week_date": "2025-51", "final_brand": "NaturaleBio", "is_yaba_asin": "Y", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 26.748571429, "estimated_clicks": 1795.22545, "click_share": 2.95, "average_organic_rank": 22.0, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_coupon": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0}];

        const ourBrand = "NaturaleBio";
        const topCompetitors = ["NORITUAL LAB", "Special Leaves", "VAHDAM"];

        // --- 2. LOGIC & INITIALIZATION ---
        google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
        google.charts.setOnLoadCallback(initDashboard);

        let uniqueWeeks = [];
        let uniqueBrands = [];

        function initDashboard() {
            // Process Data: Get Unique Weeks sorted
            uniqueWeeks = [...new Set(marketData.map(d => d.week_date))].sort();
            uniqueBrands = [...new Set(marketData.filter(d => d.final_brand !== ourBrand).map(d => d.final_brand))].sort();
            
            // Set Header Date Range
            document.getElementById('date-range').innerText = `${uniqueWeeks[0]} - ${uniqueWeeks[uniqueWeeks.length - 1]}`;
            document.getElementById('brand-name').innerText = ourBrand;

            // Render Report Charts
            drawTrendChart();
            drawCompetitivenessChart();
            drawEfficiencyChart();
            generateLeversTable();
            generateInsights();

            // Init Comparator
            initComparator();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // Highlight button
            const btnIndex = tabId === 'report' ? 0 : 1;
            document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');

            // Redraw charts if needed (sometimes hidden charts don't render size correctly)
            if(tabId === 'report') {
                drawTrendChart();
                drawCompetitivenessChart();
            }
        }

        // --- 3. CHART FUNCTIONS (REPORT) ---

        function drawTrendChart() {
            // Aggregation: Group by Week -> { TotalClicks, OurClicks, OurShare }
            const stats = uniqueWeeks.map(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                const ourData = weekData.filter(d => d.final_brand === ourBrand);
                const ourClicks = ourData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                const share = totalClicks > 0 ? (ourClicks / totalClicks) * 100 : 0;
                return [week, totalClicks, share];
            });

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Volumen Mercado (Clics)');
            data.addColumn('number', 'Nuestro Share (%)');

            data.addRows(stats);

            const options = {
                vAxes: {
                    0: {title: 'Volumen Mercado', gridlines: {color: '#f3f4f6'}},
                    1: {title: 'Click Share (%)', format: '#\'%\''}
                },
                hAxis: {title: 'Semana'},
                seriesType: 'bars',
                series: {1: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
                colors: ['#e5e7eb'],
                legend: {position: 'top'},
                animation: {startup: true, duration: 1000, easing: 'out'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        function drawCompetitivenessChart() {
            // Pivot: Week | OurBrand | Comp1 | Comp2 | Comp3 | Others
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', ourBrand);
            topCompetitors.forEach(c => data.addColumn('number', c));
            
            const rows = uniqueWeeks.map(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                
                const getShare = (brand) => {
                    const brandClicks = weekData.filter(d => d.final_brand === brand)
                        .reduce((sum, d) => sum + d.estimated_clicks, 0);
                    return totalClicks > 0 ? (brandClicks / totalClicks) * 100 : 0;
                };

                return [week, getShare(ourBrand), ...topCompetitors.map(c => getShare(c))];
            });

            data.addRows(rows);

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: { title: 'Share (%)' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'], // Google colors
                lineWidth: 3,
                pointSize: 5
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(data, options);
        }

        function drawEfficiencyChart() {
            // Scatter: Rank (X) vs Share (Y) for LATEST week
            const latestWeek = uniqueWeeks[uniqueWeeks.length - 1];
            const weekData = marketData.filter(d => d.week_date === latestWeek);

            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank');
            data.addColumn('number', 'Click Share (%)');
            data.addColumn({type: 'string', role: 'tooltip'});
            data.addColumn({type: 'string', role: 'style'}); // Color

            const rows = weekData.map(d => {
                const isUs = d.final_brand === ourBrand;
                const color = isUs ? 'point { fill-color: #4285F4; size: 10; }' : 'point { fill-color: #999; }';
                // Tooltip
                const tooltip = `${d.final_brand}\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`;
                // Handle missing rank
                if(!d.average_organic_rank) return null;
                return [d.average_organic_rank, d.click_share, tooltip, color];
            }).filter(r => r !== null);

            data.addRows(rows);

            const options = {
                hAxis: {title: 'Posición Orgánica (Menor es mejor)', direction: 1},
                vAxis: {title: 'Click Share (%)'},
                legend: 'none',
                colors: ['#4285F4']
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        function generateLeversTable() {
            // Compare Metrics for Our Brand vs Top Competitor (Avg) for Latest Week
            const latestWeek = uniqueWeeks[uniqueWeeks.length - 1];
            const weekData = marketData.filter(d => d.week_date === latestWeek);

            const usData = weekData.filter(d => d.final_brand === ourBrand);
            const compData = weekData.filter(d => d.final_brand !== ourBrand);

            const avgPriceUs = usData.reduce((s,d)=>s+d.price,0) / (usData.length || 1);
            const avgPriceComp = compData.reduce((s,d)=>s+d.price,0) / (compData.length || 1);

            const dealDaysUs = usData.reduce((s,d)=>s+d.weekly_number_of_days_with_deal,0);
            const dealDaysComp = compData.reduce((s,d)=>s+d.weekly_number_of_days_with_deal,0);

            // Simple HTML Table
            const html = `
                <table style="width:100%; border-collapse: collapse; font-size: 14px;">
                    <tr style="border-bottom: 1px solid #eee;">
                        <th style="text-align:left; padding:8px;">Métrica</th>
                        <th style="text-align:center; padding:8px; color:#4285F4;">${ourBrand}</th>
                        <th style="text-align:center; padding:8px; color:#666;">Competencia</th>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding:8px;">Precio Promedio</td>
                        <td style="text-align:center; font-weight:bold;">€${avgPriceUs.toFixed(2)}</td>
                        <td style="text-align:center;">€${avgPriceComp.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding:8px;">Días con Deal</td>
                        <td style="text-align:center;">${dealDaysUs}</td>
                        <td style="text-align:center;">${dealDaysComp}</td>
                    </tr>
                     <tr>
                        <td style="padding:8px;">Status</td>
                        <td style="text-align:center; font-size:12px;">
                            ${avgPriceUs > avgPriceComp ? '<span style="color:orange">Premium (+Price)</span>' : '<span style="color:green">Competitivo</span>'}
                        </td>
                        <td style="text-align:center;">-</td>
                    </tr>
                </table>
            `;
            document.getElementById('levers_table').innerHTML = html;
        }

        function generateInsights() {
            const list = document.getElementById('insights_list');
            const recList = document.getElementById('recommendations_list');
            
            // Logic for insights
            const latestWeek = uniqueWeeks[uniqueWeeks.length - 1];
            const prevWeek = uniqueWeeks[uniqueWeeks.length - 2];
            
            // Calc Share Delta
            const getShare = (w, brand) => {
                const wd = marketData.filter(d => d.week_date === w);
                const total = wd.reduce((s,d)=>s+d.estimated_clicks,0);
                const b = wd.filter(d => d.final_brand === brand).reduce((s,d)=>s+d.estimated_clicks,0);
                return total ? (b/total)*100 : 0;
            };

            const shareNow = getShare(latestWeek, ourBrand);
            const sharePrev = getShare(prevWeek, ourBrand);
            const delta = shareNow - sharePrev;

            // Insight 1: Trend
            let i1 = `<strong>Tendencia:</strong> Nuestra marca cierra la semana ${latestWeek} con un <strong>${shareNow.toFixed(1)}%</strong> de cuota, `;
            i1 += delta >= 0 ? `<span style="color:green">creciendo +${delta.toFixed(1)}%</span> vs semana anterior.` : `<span style="color:red">cayendo ${delta.toFixed(1)}%</span>.`;

            // Insight 2: Top Competitor
            const compShare = getShare(latestWeek, topCompetitors[0]);
            let i2 = `<strong>Competencia:</strong> El líder del segmento es <strong>${topCompetitors[0]}</strong> con un ${compShare.toFixed(1)}% de share.`;

            // Insight 3: Price
            // Check correlation price vs share roughly
            let i3 = "<strong>Precio:</strong> ";
            const weekData = marketData.filter(d => d.week_date === latestWeek);
            const usAvg = weekData.filter(d => d.final_brand === ourBrand).reduce((s,d)=>s+d.price,0) / weekData.filter(d => d.final_brand === ourBrand).length;
            const mktAvg = weekData.filter(d => d.final_brand !== ourBrand).reduce((s,d)=>s+d.price,0) / weekData.filter(d => d.final_brand !== ourBrand).length;
            
            if(usAvg > mktAvg * 1.2) i3 += "Posicionamiento Premium. Nuestro precio es >20% superior al promedio del mercado.";
            else if (usAvg < mktAvg * 0.9) i3 += "Estrategia de Penetración. Precio inferior al promedio para ganar volumen.";
            else i3 += "Precio alineado con el mercado.";

            // Insight 4: Efficiency
            let i4 = "<strong>Eficiencia SEO:</strong> ";
            const usRank = weekData.filter(d => d.final_brand === ourBrand && d.average_organic_rank).reduce((s,d)=>s+d.average_organic_rank,0) / 10; // rough avg
            if (usRank < 5) i4 += "Alta visibilidad orgánica (Top 5 promedio) impulsa el share sin depender excesivamente de anuncios.";
            else i4 += "Visibilidad orgánica mejorable. Ranking promedio fuera del Top 5.";

            // Insight 5: Risk
            let i5 = "<strong>Riesgo:</strong> ";
            if(delta < 0) i5 += "Pérdida de tracción reciente requiere revisión urgente de conversión.";
            else i5 += "Mantener ritmo de crecimiento ante posible reacción de competidores.";

            list.innerHTML = `
                <li><span class="material-icons" style="color:#4285F4; margin-right:8px;">show_chart</span> <span>${i1}</span></li>
                <li><span class="material-icons" style="color:#EA4335; margin-right:8px;">group</span> <span>${i2}</span></li>
                <li><span class="material-icons" style="color:#FBBC05; margin-right:8px;">sell</span> <span>${i3}</span></li>
                <li><span class="material-icons" style="color:#34A853; margin-right:8px;">visibility</span> <span>${i4}</span></li>
                <li><span class="material-icons" style="color:#666; margin-right:8px;">warning</span> <span>${i5}</span></li>
            `;

            // Recommendations
            recList.innerHTML = `
                <div class="rec-card">
                    <strong>1. Defender Top Keywords:</strong> Asegurar puja agresiva en las keywords donde el ranking orgánico ha caído para no perder el share ganado.
                </div>
                <div class="rec-card">
                    <strong>2. Análisis de Precios Competidor:</strong> ${topCompetitors[0]} está fuerte. Revisar si tienen cupones activos y considerar igualar oferta táctica.
                </div>
                <div class="rec-card">
                    <strong>3. Optimización de Listing:</strong> Si la eficiencia de ranking es baja, revisar CTR del título y la imagen principal.
                </div>
            `;
        }

        // --- 4. COMPARATOR LOGIC ---

        function initComparator() {
            const weekSel = document.getElementById('comp_week_select');
            const brandSel = document.getElementById('comp_brand_select');

            // Populate Weeks
            uniqueWeeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.appendChild(opt);
            });
            weekSel.value = uniqueWeeks[uniqueWeeks.length - 1]; // Select latest

            // Populate Competitors
            uniqueBrands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                brandSel.appendChild(opt);
            });
            // Select first competitor
            if(uniqueBrands.length > 0) brandSel.value = uniqueBrands[0];

            updateComparator();
        }

        function updateComparator() {
            const week = document.getElementById('comp_week_select').value;
            const compBrand = document.getElementById('comp_brand_select').value;

            const weekData = marketData.filter(d => d.week_date === week);
            
            // Aggregates
            const agg = (brand) => {
                const rows = weekData.filter(d => d.final_brand === brand);
                const count = rows.length;
                if(count === 0) return { price: 0, share: 0, deals: 0, rank: 0 };
                
                const price = rows.reduce((s,d) => s + d.price, 0) / count;
                const totalClicks = weekData.reduce((s,d) => s + d.estimated_clicks, 0);
                const brandClicks = rows.reduce((s,d) => s + d.estimated_clicks, 0);
                const share = totalClicks ? (brandClicks/totalClicks)*100 : 0;
                const deals = rows.reduce((s,d) => s + (d.weekly_number_of_days_with_deal > 0 ? 1 : 0), 0);
                // Rank avg (filter NaNs)
                const validRanks = rows.filter(d => d.average_organic_rank).map(d => d.average_organic_rank);
                const rank = validRanks.length ? validRanks.reduce((a,b)=>a+b,0)/validRanks.length : 0;

                return { price, share, deals, rank };
            };

            const usStats = agg(ourBrand);
            const compStats = agg(compBrand);

            // Draw Comparison Table
            const container = document.getElementById('comparison_table_div');
            const tableData = new google.visualization.DataTable();
            tableData.addColumn('string', 'KPI');
            tableData.addColumn('string', ourBrand);
            tableData.addColumn('string', compBrand);
            tableData.addColumn('string', 'Diferencia');

            const fmt = (n, s='') => `${s}${n.toFixed(2)}`;
            const diff = (a, b, inverse=false) => {
                const d = a - b;
                if(d === 0) return "=";
                const color = inverse ? (d < 0 ? 'green' : 'red') : (d > 0 ? 'green' : 'red');
                const symbol = d > 0 ? '▲' : '▼';
                return `<span style="color:${color}; font-weight:bold;">${symbol} ${d.toFixed(2)}</span>`;
            };

            tableData.addRows([
                ['Click Share (%)', fmt(usStats.share), fmt(compStats.share), diff(usStats.share, compStats.share)],
                ['Precio Promedio (€)', fmt(usStats.price, '€'), fmt(compStats.price, '€'), diff(usStats.price, compStats.price, true)], // Lower price usually green? Context dependent.
                ['Rank Orgánico Avg', usStats.rank.toFixed(1), compStats.rank.toFixed(1), diff(usStats.rank, compStats.rank, true)], // Lower rank is green
                ['Variantes con Deal', usStats.deals.toString(), compStats.deals.toString(), '-']
            ]);

            const table = new google.visualization.Table(container);
            table.draw(tableData, {allowHtml: true, width: '100%', cssClassNames: {headerRow: 'bg-gray-100'}});

            // Draw Price vs Share Bar Chart
            const chartData = google.visualization.arrayToDataTable([
                ['Metric', 'Precio (€)', 'Share (%)'],
                [ourBrand, usStats.price, usStats.share],
                [compBrand, compStats.price, compStats.share]
            ]);

            const chart = new google.visualization.ColumnChart(document.getElementById('chart_price_comp'));
            chart.draw(chartData, {
                colors: ['#4285F4', '#EA4335'], // Blue for price? No, series colors. 
                series: {
                    0: {targetAxisIndex: 0, color: '#888'}, // Price Gray
                    1: {targetAxisIndex: 1, color: '#4285F4'}  // Share Blue
                },
                vAxes: {
                    0: {title: 'Precio'},
                    1: {title: 'Share'}
                }
            });
        }

    </script>
</body>
</html>