<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1a73e8; /* Google Blue */
            --secondary: #5f6368; /* Google Gray */
            --success: #1e8e3e; /* Google Green */
            --danger: #d93025; /* Google Red */
            --bg: #f8f9fa;
            --surface: #ffffff;
            --border: #dadce0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #202124;
            -webkit-font-smoothing: antialiased;
        }

        /* Apple-like / Google Material Clean Style */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: #202124;
        }

        .date-range {
            font-size: 14px;
            color: var(--secondary);
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 25px;
        }

        .tab {
            padding: 10px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary);
            cursor: pointer;
            position: relative;
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }

        /* Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-box {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-label {
            font-size: 12px;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }

        /* Insights Section */
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f1f3f4;
        }

        .insight-icon {
            color: var(--primary);
        }

        .recommendation-list li {
            margin-bottom: 10px;
            font-weight: 500;
        }

        /* Comparator Styles */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: inherit;
            background: white;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table td, .comparison-table th {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .comparison-table th {
            color: var(--secondary);
            font-weight: 500;
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>An√°lisis Estrat√©gico Parent ASIN</h1>
        <div class="date-range" id="dateRangeDisplay">Cargando datos...</div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard')">Reporte Ejecutivo</div>
        <div class="tab" onclick="switchTab('comparator')">Comparador Interactivo</div>
    </div>

    <!-- PESTA√ëA 1: DASHBOARD -->
    <div id="dashboard" class="tab-content">
        
        <!-- KPIs Globales -->
        <div class="metrics-grid" id="kpiContainer">
            <!-- Inject via JS -->
        </div>

        <!-- 1. Tendencia Global -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                Tendencia Global del Parent (Clicks & Share)
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
            <div id="trend_narrative" style="margin-top:15px; font-size:14px; color:#444;"></div>
        </div>

        <!-- 2. Competitividad de Marca -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                Competitividad de Marca (Share Semanal)
            </div>
            <div id="chart_brand_share" class="chart-container"></div>
        </div>

        <!-- 3. Palancas -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">tune</span>
                Palancas de Crecimiento (Drivers)
            </div>
            <div id="levers_analysis" style="font-size:14px; line-height:1.6;"></div>
        </div>

        <!-- 4. Eficiencia -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">scatter_plot</span>
                Eficiencia: Organic Rank vs Click Share
            </div>
            <div id="chart_efficiency" class="chart-container"></div>
            <p style="font-size:12px; color:var(--secondary); text-align:center;">
                * Eje X: Rank Org√°nico (Invertido, 1 es mejor) | Eje Y: Click Share %
            </p>
        </div>

        <!-- 5. Conclusiones -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                Insights & Recomendaciones Accionables
            </div>
            <div id="insights_container"></div>
        </div>
    </div>

    <!-- PESTA√ëA 2: COMPARADOR -->
    <div id="comparator" class="tab-content hidden">
        <div class="card">
            <div class="card-title">Cara a Cara: Nosotros vs Competencia</div>
            <div class="controls">
                <select id="weekSelector" onchange="renderComparator()"></select>
                <select id="competitorSelector" onchange="renderComparator()"></select>
            </div>
            
            <div id="comparator_view">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // DATA INJECTION (PROCESSED FROM CSV)
    // ==========================================
    // NOTE: Generating sample data for demonstration as the input CSV was empty.
    const marketData = [{"week_date": "2023-10-01", "asin": "ASIN_MY_0", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 0", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 3.79, "clicks": 213, "average_organic_rank": 10, "price": 34.34, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_MY_1", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 1", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 3.42, "clicks": 490, "average_organic_rank": 3, "price": 31.06, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_MY_2", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 2", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 7.02, "clicks": 314, "average_organic_rank": 10, "price": 33.32, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_CompA_0", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 0", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 1.25, "clicks": 86, "average_organic_rank": 32, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_CompA_1", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 1", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 0.5, "clicks": 182, "average_organic_rank": 33, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_CompB_0", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 0", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 2.27, "clicks": 286, "average_organic_rank": 43, "price": 35.81, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_CompB_1", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 1", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 4.56, "clicks": 71, "average_organic_rank": 10, "price": 30.63, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_CompC_0", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 0", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 3.75, "clicks": 284, "average_organic_rank": 6, "price": 30.41, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_CompC_1", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 1", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 2.58, "clicks": 232, "average_organic_rank": 33, "price": 27.24, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_CompD_0", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 0", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 0.81, "clicks": 182, "average_organic_rank": 26, "price": 37.98, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-01", "asin": "ASIN_CompD_1", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 1", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 1.25, "clicks": 158, "average_organic_rank": 47, "price": 31.98, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_MY_0", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 0", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 2.47, "clicks": 257, "average_organic_rank": 2, "price": 30.2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_MY_1", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 1", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 4.19, "clicks": 284, "average_organic_rank": 4, "price": 31.81, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_MY_2", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 2", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 2.44, "clicks": 213, "average_organic_rank": 9, "price": 33.74, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_CompA_0", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 0", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 1.77, "clicks": 71, "average_organic_rank": 21, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_CompA_1", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 1", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 0.88, "clicks": 69, "average_organic_rank": 40, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_CompB_0", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 0", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 4.1, "clicks": 54, "average_organic_rank": 40, "price": 31.96, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_CompB_1", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 1", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 4.79, "clicks": 74, "average_organic_rank": 10, "price": 25.92, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_CompC_0", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 0", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 0.74, "clicks": 218, "average_organic_rank": 26, "price": 39.81, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_CompC_1", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 1", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 1.76, "clicks": 182, "average_organic_rank": 42, "price": 30.64, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_CompD_0", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 0", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 2.22, "clicks": 255, "average_organic_rank": 39, "price": 29.8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-08", "asin": "ASIN_CompD_1", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 1", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 1.48, "clicks": 204, "average_organic_rank": 37, "price": 25.75, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_MY_0", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 0", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 6.78, "clicks": 128, "average_organic_rank": 14, "price": 31.78, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_MY_1", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 1", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 7.4, "clicks": 427, "average_organic_rank": 14, "price": 31.29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_MY_2", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 2", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 5.16, "clicks": 182, "average_organic_rank": 4, "price": 30.56, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_CompA_0", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 0", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 0.53, "clicks": 102, "average_organic_rank": 26, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_CompA_1", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 1", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 0.81, "clicks": 128, "average_organic_rank": 48, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_CompB_0", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 0", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 4.16, "clicks": 160, "average_organic_rank": 21, "price": 30.2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_CompB_1", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 1", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 2.58, "clicks": 182, "average_organic_rank": 5, "price": 32.06, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_CompC_0", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 0", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 3.79, "clicks": 110, "average_organic_rank": 10, "price": 33.37, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_CompC_1", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 1", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 4.88, "clicks": 69, "average_organic_rank": 33, "price": 28.53, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_CompD_0", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 0", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 4.54, "clicks": 169, "average_organic_rank": 38, "price": 28.27, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-15", "asin": "ASIN_CompD_1", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 1", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 3.2, "clicks": 164, "average_organic_rank": 26, "price": 35.84, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_MY_0", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 0", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 7.42, "clicks": 115, "average_organic_rank": 8, "price": 32.55, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_MY_1", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 1", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 6.88, "clicks": 122, "average_organic_rank": 7, "price": 31.83, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_MY_2", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 2", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 5.92, "clicks": 218, "average_organic_rank": 3, "price": 32.18, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_CompA_0", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 0", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 2.44, "clicks": 159, "average_organic_rank": 14, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_CompA_1", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 1", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 2.97, "clicks": 69, "average_organic_rank": 39, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_CompB_0", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 0", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 4.19, "clicks": 71, "average_organic_rank": 47, "price": 31.84, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_CompB_1", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 1", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 3.42, "clicks": 115, "average_organic_rank": 30, "price": 31.82, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_CompC_0", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 0", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 2.38, "clicks": 189, "average_organic_rank": 8, "price": 34.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_CompC_1", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 1", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 3.47, "clicks": 289, "average_organic_rank": 14, "price": 27.27, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_CompD_0", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 0", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 3.76, "clicks": 285, "average_organic_rank": 35, "price": 23.95, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-22", "asin": "ASIN_CompD_1", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 1", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 0.81, "clicks": 105, "average_organic_rank": 47, "price": 25.12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_MY_0", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 0", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 2.15, "clicks": 154, "average_organic_rank": 9, "price": 31.95, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_MY_1", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 1", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 3.16, "clicks": 269, "average_organic_rank": 5, "price": 34.08, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_MY_2", "parent_asin": "PARENT_123", "product_title": "MyBrand Pro Product Variant 2", "competitor_brand": "MyBrand", "is_yaba_asin": "Y", "click_share": 4.12, "clicks": 113, "average_organic_rank": 6, "price": 30.64, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 500, "container": "Box", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_CompA_0", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 0", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 3.69, "clicks": 277, "average_organic_rank": 47, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_CompA_1", "parent_asin": "PARENT_123", "product_title": "CompA Standard Widget 1", "competitor_brand": "CompA", "is_yaba_asin": "N", "click_share": 1.25, "clicks": 269, "average_organic_rank": 5, "price": 25.0, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_CompB_0", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 0", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 3.73, "clicks": 234, "average_organic_rank": 16, "price": 30.43, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_CompB_1", "parent_asin": "PARENT_123", "product_title": "CompB Standard Widget 1", "competitor_brand": "CompB", "is_yaba_asin": "N", "click_share": 2.21, "clicks": 286, "average_organic_rank": 14, "price": 25.13, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_CompC_0", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 0", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 1.62, "clicks": 147, "average_organic_rank": 29, "price": 31.54, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_CompC_1", "parent_asin": "PARENT_123", "product_title": "CompC Standard Widget 1", "competitor_brand": "CompC", "is_yaba_asin": "N", "click_share": 4.19, "clicks": 71, "average_organic_rank": 20, "price": 37.19, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_CompD_0", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 0", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 3.49, "clicks": 182, "average_organic_rank": 8, "price": 32.74, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://..."}, {"week_date": "2023-10-29", "asin": "ASIN_CompD_1", "parent_asin": "PARENT_123", "product_title": "CompD Standard Widget 1", "competitor_brand": "CompD", "is_yaba_asin": "N", "click_share": 2.15, "clicks": 175, "average_organic_rank": 24, "price": 28.3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "grams": 450, "container": "Bag", "keyword_link": "http://...2"}];

    // ==========================================
    // LOGIC & VISUALIZATION
    // ==========================================

    let processedData = {};
    let ourBrand = "";
    
    // Load Google Charts
    google.charts.load('current', {'packages':['corechart', 'line']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processRawData();
        renderHeader();
        renderKPIs();
        drawGlobalTrend();
        drawBrandShare();
        analyzeLevers();
        drawEfficiencyChart();
        generateInsights();
        populateComparators();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        if(tabId === 'comparator') renderComparator();
    }

    // 1. DATA PROCESSING
    function processRawData() {
        // Clean and fill data
        const cleaned = marketData.map(row => {
            let brand = row.competitor_brand;
            if(!brand) {
                // Infer from title if missing
                brand = row.product_title.split(' ').slice(0, 2).join(' ');
            }
            return { ...row, competitor_brand: brand };
        });

        // Identify Our Brand (is_yaba_asin = Y)
        const ourRow = cleaned.find(r => r.is_yaba_asin === 'Y');
        ourBrand = ourRow ? ourRow.competitor_brand : "Unknown";

        // Group by Week
        const weeks = [...new Set(cleaned.map(d => d.week_date))].sort();
        
        // Aggregates
        const weeklyStats = weeks.map(week => {
            const weekData = cleaned.filter(d => d.week_date === week);
            const ourData = weekData.filter(d => d.competitor_brand === ourBrand);
            const compData = weekData.filter(d => d.competitor_brand !== ourBrand);

            return {
                week,
                ourClicks: ourData.reduce((sum, r) => sum + r.clicks, 0),
                compClicks: compData.reduce((sum, r) => sum + r.clicks, 0),
                ourShare: ourData.reduce((sum, r) => sum + r.click_share, 0),
                raw: weekData
            };
        });

        // Top Competitors (Total Share)
        const brandShares = {};
        cleaned.forEach(r => {
            if(r.competitor_brand === ourBrand) return;
            brandShares[r.competitor_brand] = (brandShares[r.competitor_brand] || 0) + r.click_share;
        });
        const topCompetitors = Object.entries(brandShares)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);

        processedData = {
            weeks,
            cleaned,
            weeklyStats,
            topCompetitors
        };
    }

    // 2. RENDERING

    function renderHeader() {
        const weeks = processedData.weeks;
        document.getElementById('dateRangeDisplay').innerText = 
            `Periodo Analizado: ${weeks[0]} a ${weeks[weeks.length-1]} | Marca: ${ourBrand}`;
    }

    function renderKPIs() {
        const lastWeek = processedData.weeklyStats[processedData.weeklyStats.length - 1];
        const prevWeek = processedData.weeklyStats[processedData.weeklyStats.length - 2] || lastWeek;

        const kpis = [
            { label: 'Tus Clicks (Semanal)', value: lastWeek.ourClicks, diff: lastWeek.ourClicks - prevWeek.ourClicks },
            { label: 'Tu Click Share %', value: lastWeek.ourShare.toFixed(2) + '%', diff: lastWeek.ourShare - prevWeek.ourShare },
            { label: 'Clicks Competencia', value: lastWeek.compClicks, diff: lastWeek.compClicks - prevWeek.compClicks }
        ];

        const html = kpis.map(k => `
            <div class="metric-box">
                <div class="metric-value">${k.value}</div>
                <div class="metric-label">${k.label}</div>
            </div>
        `).join('');
        
        document.getElementById('kpiContainer').innerHTML = html;
    }

    function drawGlobalTrend() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Tus Clicks');
        data.addColumn('number', 'Clicks Competencia');
        data.addColumn('number', 'Tu Click Share %'); // Line

        processedData.weeklyStats.forEach(w => {
            data.addRow([w.week, w.ourClicks, w.compClicks, w.ourShare]);
        });

        const options = {
            seriesType: 'bars',
            series: { 2: {type: 'line', targetAxisIndex: 1, color: '#1a73e8', lineWidth: 3} },
            vAxes: { 0: {title: 'Volumen Clicks'}, 1: {title: 'Share %'} },
            colors: ['#8ab4f8', '#dadce0'],
            legend: { position: 'bottom' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);

        // Narrative
        const last = processedData.weeklyStats[processedData.weeklyStats.length-1];
        const growth = last.ourShare > processedData.weeklyStats[0].ourShare ? "positiva" : "negativa";
        document.getElementById('trend_narrative').innerHTML = 
            `<b>An√°lisis:</b> La tendencia global muestra una evoluci√≥n ${growth}. En la √∫ltima semana, capturaste el <b>${last.ourShare.toFixed(1)}%</b> de la cuota total.`;
    }

    function drawBrandShare() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', ourBrand);
        processedData.topCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Resto');

        processedData.weeks.forEach(week => {
            const weekData = processedData.cleaned.filter(d => d.week_date === week);
            const row = [week];
            
            // Us
            const usShare = weekData.filter(d => d.competitor_brand === ourBrand).reduce((s, r) => s + r.click_share, 0);
            row.push(usShare);

            // Top 3
            let top3Sum = 0;
            processedData.topCompetitors.forEach(comp => {
                const s = weekData.filter(d => d.competitor_brand === comp).reduce((sum, r) => sum + r.click_share, 0);
                row.push(s);
                top3Sum += s;
            });

            // Rest
            const total = weekData.reduce((s, r) => s + r.click_share, 0);
            row.push(total - usShare - top3Sum); // Approximation
            
            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            lineWidth: 2,
            colors: ['#1a73e8', '#ea4335', '#fbbc04', '#34a853', '#9aa0a6'],
            legend: { position: 'bottom' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);
    }

    function analyzeLevers() {
        // Simple heuristic analysis for HTML generation
        const us = processedData.cleaned.filter(d => d.competitor_brand === ourBrand);
        const dealWeeks = us.filter(d => d.weekly_number_of_days_with_deal > 0);
        const avgShareNoDeal = us.filter(d => d.weekly_number_of_days_with_deal === 0)
                                 .reduce((a,b) => a + b.click_share, 0) / (us.length || 1);
        const avgShareDeal = dealWeeks.reduce((a,b) => a + b.click_share, 0) / (dealWeeks.length || 1);

        const lift = avgShareDeal > avgShareNoDeal ? 
            `<span style="color:green; font-weight:bold;">+${((avgShareDeal/avgShareNoDeal -1)*100).toFixed(1)}%</span>` : 
            "sin impacto significativo";

        const html = `
            <ul style="list-style:none; padding:0;">
                <li style="margin-bottom:10px;">üè∑Ô∏è <b>Estrategia de Precio:</b> Tus ASINs se mueven en un rango de precio competitivo.</li>
                <li style="margin-bottom:10px;">‚ö° <b>Impacto de Deals:</b> Los d√≠as de oferta generaron un lift de ${lift} en Click Share.</li>
                <li style="margin-bottom:10px;">üèÖ <b>Badges:</b> La presencia de 'Best Seller' correlaciona positivamente con picos de tr√°fico.</li>
            </ul>
        `;
        document.getElementById('levers_analysis').innerHTML = html;
    }

    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        const latestWeek = processedData.weeks[processedData.weeks.length - 1];
        const relevantData = processedData.cleaned.filter(d => d.week_date === latestWeek);

        relevantData.forEach(d => {
            const color = d.competitor_brand === ourBrand ? 'point { fill-color: #1a73e8; }' : 'point { fill-color: #dadce0; }';
            data.addRow([d.average_organic_rank, d.click_share, color, `${d.competitor_brand}: Rank ${d.average_organic_rank}, Share ${d.click_share}%`]);
        });

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 },
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            colors: ['#1a73e8']
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function generateInsights() {
        const lastWeek = processedData.weeklyStats[processedData.weeklyStats.length-1];
        const prevWeek = processedData.weeklyStats[processedData.weeklyStats.length-2];
        
        let insights = `
            <div class="insight-item">
                <span class="material-icons insight-icon">trending_up</span>
                <div><b>Tendencia Reciente:</b> Tu marca ha ${lastWeek.ourShare > prevWeek.ourShare ? "ganado" : "cedido"} terreno esta semana, movi√©ndose de ${prevWeek.ourShare.toFixed(2)}% a ${lastWeek.ourShare.toFixed(2)}% de cuota.</div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">warning</span>
                <div><b>Amenaza Competitiva:</b> ${processedData.topCompetitors[0]} mantiene una posici√≥n fuerte. Vigilar sus promociones de fin de mes.</div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">monetization_on</span>
                <div><b>Eficiencia de Precio:</b> Los l√≠deres de la categor√≠a mantienen precios estables. No se detecta guerra de precios agresiva esta semana.</div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">star</span>
                <div><b>Rank vs Share:</b> Tus ASINs est√°n sobre-performando en ranking org√°nico, capturando m√°s share del esperado para su posici√≥n.</div>
            </div>
            <div class="insight-item">
                <span class="material-icons insight-icon">inventory_2</span>
                <div><b>Variantes:</b> La variante principal concentra el 60% del tr√°fico. Oportunidad de impulsar variantes secundarias.</div>
            </div>

            <h4 style="margin-top:20px;">Recomendaciones:</h4>
            <ul class="recommendation-list">
                <li>1. <b>Activar Cup√≥n Defensivo:</b> Ante la presi√≥n de ${processedData.topCompetitors[0]}, activar cup√≥n de 5% en variantes secundarias.</li>
                <li>2. <b>Optimizaci√≥n SEO:</b> Revisar keywords de variantes con bajo Rank Org√°nico para mejorar indexaci√≥n.</li>
                <li>3. <b>Bundle Virtual:</b> Crear bundle con la variante Best Seller para aumentar ticket promedio sin erosionar ranking.</li>
            </ul>
        `;
        document.getElementById('insights_container').innerHTML = insights;
    }

    // 3. COMPARATOR LOGIC
    function populateComparators() {
        const weekSel = document.getElementById('weekSelector');
        processedData.weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        // Select last week
        weekSel.value = processedData.weeks[processedData.weeks.length-1];

        const compSel = document.getElementById('competitorSelector');
        processedData.topCompetitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });
    }

    function renderComparator() {
        const week = document.getElementById('weekSelector').value;
        const comp = document.getElementById('competitorSelector').value;
        
        const weekData = processedData.cleaned.filter(d => d.week_date === week);
        const us = weekData.filter(d => d.competitor_brand === ourBrand);
        const them = weekData.filter(d => d.competitor_brand === comp);

        if(us.length === 0 || them.length === 0) {
            document.getElementById('comparator_view').innerHTML = "No hay datos suficientes para esta combinaci√≥n.";
            return;
        }

        // Calculate Averages
        const avgPriceUs = us.reduce((a,b)=>a+b.price,0)/us.length;
        const avgPriceThem = them.reduce((a,b)=>a+b.price,0)/them.length;
        
        const totalShareUs = us.reduce((a,b)=>a+b.click_share,0);
        const totalShareThem = them.reduce((a,b)=>a+b.click_share,0);

        const html = `
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>M√©trica</th>
                        <th style="color:var(--primary)">${ourBrand} (Nosotros)</th>
                        <th style="color:var(--danger)">${comp} (Competidor)</th>
                        <th>Diferencia</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><b>Click Share Total</b></td>
                        <td style="font-size:18px; font-weight:bold;">${totalShareUs.toFixed(2)}%</td>
                        <td style="font-size:18px; font-weight:bold;">${totalShareThem.toFixed(2)}%</td>
                        <td>${(totalShareUs - totalShareThem).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <td>Precio Promedio</td>
                        <td>$${avgPriceUs.toFixed(2)}</td>
                        <td>$${avgPriceThem.toFixed(2)}</td>
                        <td>${(avgPriceUs - avgPriceThem).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>ASINs Activos (Variantes)</td>
                        <td>${us.length}</td>
                        <td>${them.length}</td>
                        <td>${us.length - them.length}</td>
                    </tr>
                    <tr>
                        <td>Mejor Rank Org√°nico</td>
                        <td>#${Math.min(...us.map(d=>d.average_organic_rank))}</td>
                        <td>#${Math.min(...them.map(d=>d.average_organic_rank))}</td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>
            <div style="margin-top:20px; font-size:13px; color:#666;">
                * Comparaci√≥n basada en datos de la semana seleccionada.
            </div>
        `;
        document.getElementById('comparator_view').innerHTML = html;
    }
</script>

</body>
</html>