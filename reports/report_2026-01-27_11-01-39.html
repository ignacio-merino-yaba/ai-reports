<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent ASIN Performance Report</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335; /* Google Red */
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-500: #6B7280;
            --gray-800: #1F2937;
            --white: #FFFFFF;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        header {
            background: var(--white);
            padding: 24px 32px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .subtitle {
            color: var(--gray-500);
            font-size: 14px;
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            background: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 999px;
            font-weight: 600;
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }

        .tab-btn.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-content {
            flex: 1;
            min-height: 300px;
            position: relative;
        }

        /* KPI Badges */
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .kpi-label {
            font-size: 14px;
            color: var(--gray-500);
        }

        /* Insights Section */
        .insight-box {
            background: rgba(66, 133, 244, 0.05);
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }
        
        .insight-box.warning {
            background: rgba(251, 188, 5, 0.1);
            border-left-color: var(--warning);
        }

        .insight-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .insight-text {
            font-size: 14px;
            color: var(--gray-800);
        }

        /* Interactive Elements */
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            background-color: var(--white);
            font-size: 14px;
            outline: none;
            cursor: pointer;
        }

        /* Utility */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        /* Table */
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--gray-100);
            color: var(--gray-500);
            font-size: 12px;
            text-transform: uppercase;
        }
        .custom-table td {
            padding: 12px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Parent ASIN Analysis Report</h1>
            <div class="subtitle">Detailed performance review & competitive landscape</div>
        </div>
        <div id="header-brand" style="text-align: right;">
            <!-- Brand Name Injected Here -->
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">üìä Static Report</button>
        <button class="tab-btn" onclick="switchTab('interactive')">‚öîÔ∏è Interactive Comparator</button>
    </div>

    <!-- PESTA√ëA 1: REPORTE EST√ÅTICO -->
    <div id="static-tab">
        
        <!-- KPI Row -->
        <div class="grid-3">
            <div class="card" style="height: auto; padding: 20px;">
                <div class="kpi-label">Total Clicks (Last Week)</div>
                <div class="kpi-value" id="kpi-clicks">-</div>
            </div>
            <div class="card" style="height: auto; padding: 20px;">
                <div class="kpi-label">Our Share of Voice</div>
                <div class="kpi-value" id="kpi-sov">-</div>
            </div>
            <div class="card" style="height: auto; padding: 20px;">
                <div class="kpi-label">Market Share Gap (vs #1 Comp)</div>
                <div class="kpi-value" id="kpi-gap">-</div>
            </div>
        </div>

        <!-- Section 1: Tendencia Global -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons" style="color:var(--primary)">trending_up</span>
                    Global Parent Trend (Clicks & Share)
                </div>
            </div>
            <div id="chart_trend" class="card-content"></div>
        </div>

        <!-- Section 2: Competitividad -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons" style="color:var(--danger)">speed</span>
                    Brand Competitiveness (Us vs Top 3)
                </div>
            </div>
            <div id="chart_competitiveness" class="card-content"></div>
        </div>

        <!-- Section 3 & 4: Grid -->
        <div class="grid-2">
            <!-- Palancas -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons" style="color:var(--warning)">bolt</span>
                        Drivers: Price & Promo Impact
                    </div>
                </div>
                <div id="chart_drivers" class="card-content"></div>
            </div>
            
            <!-- Efficiency -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons" style="color:var(--success)">scatter_plot</span>
                        Efficiency: Rank vs Click Share
                    </div>
                </div>
                <div id="chart_efficiency" class="card-content"></div>
            </div>
        </div>

        <!-- Section 5: Conclusiones -->
        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üí° Key Insights</div>
                </div>
                <div id="insights-container">
                    <!-- Dynamic Insights -->
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üöÄ Recommendations</div>
                </div>
                <div id="recommendations-container">
                    <!-- Dynamic Recommendations -->
                </div>
            </div>
        </div>
        
        <!-- Other Insights -->
        <div class="card" style="margin-top: 24px;">
             <div class="card-header">
                    <div class="card-title">üîç Other Strategic Insights</div>
             </div>
             <div style="padding: 10px; font-size: 14px; color: var(--gray-500);">
                Analysis of "Other" market behavior and emerging threats.
             </div>
             <div id="other-insights" style="padding: 10px;">
                <!-- Filled by JS -->
             </div>
        </div>

    </div>

    <!-- PESTA√ëA 2: INTERACTIVO -->
    <div id="interactive-tab" class="hidden">
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <div class="card-title">Head-to-Head Comparison</div>
                <div style="display: flex; gap: 10px;">
                    <select id="week-selector" onchange="updateInteractive()"></select>
                    <select id="comp-selector" onchange="updateInteractive()"></select>
                </div>
            </div>
            
            <div class="grid-2">
                <div style="text-align: center;">
                    <h3 style="color:var(--primary); margin-bottom: 10px;">Our Brand</h3>
                    <div class="kpi-value" id="our-price-display">-</div>
                    <div class="kpi-label">Avg Price</div>
                </div>
                <div style="text-align: center;">
                    <h3 style="color:var(--danger); margin-bottom: 10px;" id="comp-name-display">Competitor</h3>
                    <div class="kpi-value" id="comp-price-display">-</div>
                    <div class="kpi-label">Avg Price</div>
                </div>
            </div>

            <div style="margin-top: 24px;">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Us</th>
                            <th>Competitor</th>
                            <th>Diff</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-body">
                        <!-- Dynamic Rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- DATA INJECTION -->
<script>
    // Injected Data from Python process
    const marketData = [{"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B08YRXQ2JH", "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "real_brand": "Double Dragon", "is_yaba_asin": "N", "click_share": 4.92, "price": 6.98, "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "clicks": 1205.226816, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B06XTYYYJ8", "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "real_brand": "Heapwell Superfoods", "is_yaba_asin": "N", "click_share": 7.28, "price": 9.99, "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "clicks": 1783.343744, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 14.18, "price": 12.49, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "clicks": 3473.600864, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B07B29VZ6W", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 2.03, "price": 16.49, "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "clicks": 497.27854399999995, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B079VQ52MK", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "real_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 3.19, "price": 20.99, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "clicks": 781.4377119999999, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B09DQ1PWGX", "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "click_share": 4.68, "price": 2.1225, "average_organic_rank": 34, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "clicks": 1146.4352639999997, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B0F21VZMJQ", "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "click_share": 7.54, "price": 16.99, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 1, "clicks": 1847.0345919999997, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B0D9M91WZD", "product_title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "real_brand": "Perfect Ted", "is_yaba_asin": "N", "click_share": 2.37, "price": 11.0, "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "clicks": 580.566576, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B08YK2RPBZ", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "real_brand": "SuperSelf", "is_yaba_asin": "N", "click_share": 13.48, "price": 9.9, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 4, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "clicks": 3302.125504, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}, {"week_date": "2026-01", "parent_asin": "Matcha Premium", "asin": "B082DKRSB4", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "real_brand": "SuperSelf", "is_yaba_asin": "N", "click_share": 4.06, "price": 14.86, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 4, "weekly_number_of_days_with_coupon": 4, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "clicks": 994.5570879999999, "weekly_search_volume": 24496.48, "keywords": "matcha powder"}];
</script>

<script>
    // ------------------------------------------
    // 1. DATA PROCESSING LOGIC (Pure JS)
    // ------------------------------------------

    // Helper: Find "Our Brand"
    const ourBrandName = marketData.find(d => d.is_yaba_asin === 'Y')?.real_brand || "Our Brand";
    document.getElementById('header-brand').innerHTML = `<span style="font-weight:600; color:var(--primary)">${ourBrandName}</span> Analysis`;

    // Helper: Unique Weeks
    const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
    const lastWeek = weeks[weeks.length - 1];

    // Aggregations
    function getAggregatedData() {
        // Group by Brand and Week
        const brandStats = {};
        const totalMarketClicksByWeek = {};

        // First Pass: Market Totals
        marketData.forEach(d => {
            if (!totalMarketClicksByWeek[d.week_date]) totalMarketClicksByWeek[d.week_date] = 0;
            totalMarketClicksByWeek[d.week_date] += d.clicks;
        });

        // Second Pass: Brand Stats
        marketData.forEach(d => {
            const key = `${d.real_brand}_${d.week_date}`;
            if (!brandStats[key]) {
                brandStats[key] = {
                    brand: d.real_brand,
                    week: d.week_date,
                    clicks: 0,
                    revenue: 0, // rough proxy
                    count: 0,
                    sum_rank: 0,
                    sum_price: 0,
                    deal_days: 0,
                    coupon_days: 0,
                    is_us: d.is_yaba_asin === 'Y'
                };
            }
            brandStats[key].clicks += d.clicks;
            brandStats[key].sum_rank += d.average_organic_rank; // weighting later?
            brandStats[key].sum_price += d.price;
            brandStats[key].deal_days += d.weekly_number_of_days_with_deal;
            brandStats[key].coupon_days += d.weekly_number_of_days_with_coupon;
            brandStats[key].count += 1;
        });

        // Calculate Shares & Averages
        const processedBrands = Object.values(brandStats).map(b => ({
            ...b,
            click_share: (b.clicks / totalMarketClicksByWeek[b.week]) * 100,
            avg_price: b.sum_price / b.count,
            avg_rank: b.sum_rank / b.count
        }));

        return { processedBrands, totalMarketClicksByWeek };
    }

    const { processedBrands, totalMarketClicksByWeek } = getAggregatedData();

    // Identify Top 3 Competitors (Last Week)
    const lastWeekBrands = processedBrands.filter(b => b.week === lastWeek && !b.is_us);
    lastWeekBrands.sort((a, b) => b.click_share - a.click_share);
    const top3Competitors = lastWeekBrands.slice(0, 3).map(b => b.brand);

    // ------------------------------------------
    // 2. GOOGLE CHARTS SETUP
    // ------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'bar', 'line']});
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawDriversChart();
        drawEfficiencyChart();
        generateInsights();
        setupInteractive();
    }

    // --- CHART 1: TREND ---
    function drawTrendChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', 'Total Market Clicks');
        data.addColumn('number', 'Our Click Share %');
        data.addColumn('number', 'Competitor Avg Share %'); // Avg of top 3 for comparison

        weeks.forEach(w => {
            const totalClicks = totalMarketClicksByWeek[w];
            const ourStats = processedBrands.find(b => b.week === w && b.is_us);
            const compStats = processedBrands.filter(b => b.week === w && !b.is_us);
            const avgCompShare = compStats.reduce((sum, c) => sum + c.click_share, 0) / (compStats.length || 1);

            data.addRow([w, totalClicks, ourStats ? ourStats.click_share : 0, avgCompShare]);
        });

        const options = {
            seriesType: 'bars',
            series: {
                1: {type: 'line', targetAxisIndex: 1, color: '#4285F4'}, 
                2: {type: 'line', targetAxisIndex: 1, color: '#EA4335'}
            },
            vAxes: {
                0: {title: 'Volume'},
                1: {title: 'Share %', format: '#\'%\''}
            },
            legend: { position: 'bottom' },
            colors: ['#E5E7EB']
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    // --- CHART 2: COMPETITIVENESS ---
    function drawCompetitivenessChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Week');
        data.addColumn('number', ourBrandName);
        top3Competitors.forEach(c => data.addColumn('number', c));

        weeks.forEach(w => {
            const row = [w];
            // Us
            const ourStats = processedBrands.find(b => b.week === w && b.is_us);
            row.push(ourStats ? ourStats.click_share : 0);
            // Them
            top3Competitors.forEach(c => {
                const cStats = processedBrands.find(b => b.week === w && b.brand === c);
                row.push(cStats ? cStats.click_share : 0);
            });
            data.addRow(row);
        });

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853'],
            vAxis: { format: '#\'%\'' },
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    // --- CHART 3: DRIVERS (Last Week) ---
    function drawDriversChart() {
        // Comparison of Price vs Deal Days vs Coupon Days for Us vs Top 1 Comp
        const topComp = top3Competitors[0];
        const ourStats = processedBrands.find(b => b.week === lastWeek && b.is_us);
        const compStats = processedBrands.find(b => b.week === lastWeek && b.brand === topComp);

        const data = google.visualization.arrayToDataTable([
            ['Metric', 'Us', topComp || 'N/A'],
            ['Avg Price', ourStats?.avg_price || 0, compStats?.avg_price || 0],
            ['Deal Days', ourStats?.deal_days || 0, compStats?.deal_days || 0],
            ['Coupon Days', ourStats?.coupon_days || 0, compStats?.coupon_days || 0]
        ]);

        const options = {
            chartArea: {width: '50%'},
            colors: ['#4285F4', '#EA4335'],
            hAxis: { title: 'Value' }
        };

        const chart = new google.visualization.BarChart(document.getElementById('chart_drivers'));
        chart.draw(data, options);
    }

    // --- CHART 4: EFFICIENCY ---
    function drawEfficiencyChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'style'}); // Color
        data.addColumn({type: 'string', role: 'tooltip'});

        // Filter for last week data points (ASIN level)
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        
        currentData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? 'point { fill-color: #4285F4; size: 6; }' : 'point { fill-color: #999; size: 4; }';
            const label = `${d.product_title.substring(0, 30)}... (${d.real_brand})`;
            // Invert rank for visual (1 is high, 50 is low)
            data.addRow([d.average_organic_rank, d.click_share, color, label]);
        });

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: -1 },
            vAxis: { title: 'Click Share %' },
            legend: 'none'
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    // ------------------------------------------
    // 3. INSIGHTS & INTERACTIVITY
    // ------------------------------------------

    function generateInsights() {
        const ourStats = processedBrands.find(b => b.week === lastWeek && b.is_us);
        const topComp = processedBrands.find(b => b.week === lastWeek && b.brand === top3Competitors[0]);
        
        if (!ourStats) return;

        // KPI Updates
        document.getElementById('kpi-clicks').innerText = Math.round(ourStats.clicks).toLocaleString();
        document.getElementById('kpi-sov').innerText = ourStats.click_share.toFixed(1) + '%';
        
        const gap = topComp ? (ourStats.click_share - topComp.click_share).toFixed(1) : '0';
        const gapElem = document.getElementById('kpi-gap');
        gapElem.innerText = (gap > 0 ? '+' : '') + gap + '%';
        gapElem.style.color = gap > 0 ? 'var(--success)' : 'var(--danger)';

        // 1. Share Trend
        addInsight(
            "Market Position",
            `We hold <strong>${ourStats.click_share.toFixed(1)}%</strong> of click share this week. ` + 
            (topComp ? `Our closest competitor is <strong>${topComp.brand}</strong> with ${topComp.click_share.toFixed(1)}%.` : "")
        );

        // 2. Price Analysis
        if (topComp) {
            const priceDiff = ((ourStats.avg_price - topComp.avg_price) / topComp.avg_price) * 100;
            const priceText = priceDiff > 0 ? "more expensive" : "cheaper";
            addInsight(
                "Price Competitiveness",
                `Our average price is <strong>${Math.abs(priceDiff).toFixed(0)}% ${priceText}</strong> than the market leader. ` +
                (priceDiff > 20 ? "This significant premium might be limiting click conversion unless justified by strong differentiation." : "")
            );
        }

        // 3. Efficiency
        const rankMsg = ourStats.avg_rank < 5 ? "Strong organic visibility." : "Organic visibility is weak (Avg Rank > 5).";
        addInsight("Organic Efficiency", rankMsg);

        // Recommendations
        const recContainer = document.getElementById('recommendations-container');
        const recs = [];
        
        if (ourStats.coupon_days === 0) recs.push("<strong>Activate Coupons:</strong> No active coupons detected this week. Competitors with coupons are capturing higher CTR.");
        if (ourStats.avg_rank > 10) recs.push("<strong>SEO Audit:</strong> Organic rank is low. Review backend keywords and title relevance for 'Matcha'.");
        if (topComp && ourStats.avg_price > topComp.avg_price * 1.2) recs.push("<strong>Price Sensitivity:</strong> You are >20% above leader price. Consider a temporary price drop or justify value in main image.");
        
        recs.forEach(r => {
            const div = document.createElement('div');
            div.className = 'insight-box warning';
            div.innerHTML = `<div class="insight-text">${r}</div>`;
            recContainer.appendChild(div);
        });

        // Other Insights logic
        const otherBrands = processedBrands.filter(b => b.week === lastWeek && !b.is_us && !top3Competitors.includes(b.brand));
        const totalOtherShare = otherBrands.reduce((sum, b) => sum + b.click_share, 0);
        document.getElementById('other-insights').innerHTML = `
            <p><strong>Long Tail Fragmentation:</strong> "Other" brands collectively hold <strong>${totalOtherShare.toFixed(1)}%</strong> of the market.</p>
            <p style="margin-top:8px">This indicates ${totalOtherShare > 30 ? "a highly fragmented market with low barriers to entry." : "a consolidated market dominated by top players."}</p>
        `;
    }

    function addInsight(title, text) {
        const div = document.createElement('div');
        div.className = 'insight-box';
        div.innerHTML = `<div class="insight-title">${title}</div><div class="insight-text">${text}</div>`;
        document.getElementById('insights-container').appendChild(div);
    }

    function switchTab(tab) {
        document.getElementById('static-tab').classList.add('hidden');
        document.getElementById('interactive-tab').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(tab + '-tab').classList.remove('hidden');
        event.target.classList.add('active');
    }

    // Interactive Tab Logic
    function setupInteractive() {
        const weekSel = document.getElementById('week-selector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSel.appendChild(opt);
        });
        weekSel.value = lastWeek; // Default to last week

        const compSel = document.getElementById('comp-selector');
        top3Competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            compSel.appendChild(opt);
        });
        
        updateInteractive();
    }

    function updateInteractive() {
        const week = document.getElementById('week-selector').value;
        const comp = document.getElementById('comp-selector').value;
        
        const ourStats = processedBrands.find(b => b.week === week && b.is_us) || {};
        const compStats = processedBrands.find(b => b.week === week && b.brand === comp) || {};

        document.getElementById('comp-name-display').innerText = comp;
        document.getElementById('our-price-display').innerText = (ourStats.avg_price || 0).toFixed(2);
        document.getElementById('comp-price-display').innerText = (compStats.avg_price || 0).toFixed(2);

        const metrics = [
            { name: 'Click Share %', key: 'click_share', format: v => v.toFixed(2) + '%' },
            { name: 'Organic Rank', key: 'avg_rank', format: v => v.toFixed(1) },
            { name: 'Deal Days', key: 'deal_days', format: v => v },
            { name: 'Coupon Days', key: 'coupon_days', format: v => v }
        ];

        const tbody = document.getElementById('comparison-body');
        tbody.innerHTML = '';
        
        metrics.forEach(m => {
            const v1 = ourStats[m.key] || 0;
            const v2 = compStats[m.key] || 0;
            const diff = v1 - v2;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${m.name}</td>
                <td>${m.format(v1)}</td>
                <td>${m.format(v2)}</td>
                <td style="color:${diff > 0 ? 'var(--primary)' : 'var(--danger)'}">${diff > 0 ? '+' : ''}${m.format(diff)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

</script>

</body>
</html>