<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Parent ASIN: PARENT123</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        :root {
            --primary: #4285F4;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray: #F1F3F4;
            --text: #202124;
            --bg: #FFFFFF;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA;
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; color: var(--text); }
        .subtitle { font-size: 14px; color: #5F6368; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #EEEEEE;
            padding-bottom: 10px;
        }
        
        .card-title { font-size: 18px; font-weight: 600; margin: 0; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: var(--gray);
            padding: 16px;
            border-radius: 12px;
        }
        
        .stat-label { font-size: 12px; color: #5F6368; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--text); margin-top: 5px; }
        
        /* Charts Container */
        .chart-box {
            width: 100%;
            min-height: 400px;
        }

        /* Recommendations */
        .rec-list { list-style: none; padding: 0; }
        .rec-item { 
            padding: 12px; 
            border-left: 4px solid var(--primary); 
            background: #F8F9FA; 
            margin-bottom: 10px; 
            border-radius: 0 8px 8px 0;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--danger); }
        .bg-green { background: var(--success); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
        }
        
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: 'Inter', sans-serif;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Análisis de Parent ASIN</h1>
            <div class="subtitle">Inteligencia de Mercado & Competitividad</div>
        </div>
        <div id="date-range" class="subtitle"></div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTAÑA 1: REPORTE ESTÁTICO -->
    <div id="tab-static">
        
        <!-- Sección 1: Tendencia Global -->
        <div class="card">
            <div class="card-header">
                <span class="material-icons" style="color:var(--primary)">trending_up</span>
                <h2 class="card-title">1. Tendencia Global del Parent (Clicks & Share)</h2>
            </div>
            <div class="stats-grid" id="global-stats">
                <!-- Injected via JS -->
            </div>
            <div id="chart_global_trend" class="chart-box"></div>
            <div class="rec-item" id="global_insight">Analyzing...</div>
        </div>

        <!-- Sección 2: Competitividad -->
        <div class="card">
            <div class="card-header">
                <span class="material-icons" style="color:var(--danger)">pie_chart</span>
                <h2 class="card-title">2. Competitividad de Marca (Share %)</h2>
            </div>
            <div id="chart_brand_comp" class="chart-box"></div>
            <p id="brand_insight" style="font-size: 14px; color: #555; line-height: 1.5;"></p>
        </div>

        <!-- Sección 3: Palancas -->
        <div class="card">
            <div class="card-header">
                <span class="material-icons" style="color:var(--warning)">bolt</span>
                <h2 class="card-title">3. Impacto de Palancas (Deals, Choice, Price)</h2>
            </div>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div style="flex:1; min-width:300px;">
                     <div id="chart_levers_price" style="height: 300px;"></div>
                </div>
                <div style="flex:1; min-width:300px;">
                     <div id="table_levers" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Sección 4: Eficiencia -->
        <div class="card">
            <div class="card-header">
                <span class="material-icons" style="color:var(--success)">scatter_plot</span>
                <h2 class="card-title">4. Organic Rank vs Click Share (Eficiencia)</h2>
            </div>
            <div id="chart_efficiency" class="chart-box"></div>
            <div class="rec-item">
                <strong>Análisis:</strong> Los puntos arriba a la derecha indican alta eficiencia (buen ranking, alto share). 
                Los puntos abajo a la izquierda indican bajo ranking y bajo share.
                <br><em>Nuestros ASINs están marcados en azul.</em>
            </div>
        </div>

        <!-- Sección 5: Conclusiones -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <div class="card-header">
                <span class="material-icons">lightbulb</span>
                <h2 class="card-title">5. Conclusiones Clave y Recomendaciones</h2>
            </div>
            <h3>Insights</h3>
            <ul class="rec-list" id="insights_list"></ul>
            <h3>Recomendaciones Accionables</h3>
            <ul class="rec-list" id="recs_list"></ul>
        </div>

        <!-- Sección 6: Other Insights -->
        <div class="card">
            <div class="card-header">
                <span class="material-icons">visibility</span>
                <h2 class="card-title">6. Otros Hallazgos</h2>
            </div>
            <ul class="rec-list" id="other_insights"></ul>
        </div>

    </div>

    <!-- PESTAÑA 2: INTERACTIVO -->
    <div id="tab-interactive" class="hidden">
        <div class="controls">
            <div>
                <label>Semana:</label>
                <select id="sel_week" onchange="drawInteractive()"></select>
            </div>
            <div>
                <label>Competidor a Comparar:</label>
                <select id="sel_competitor" onchange="drawInteractive()"></select>
            </div>
        </div>

        <div class="stats-grid" id="interactive-stats">
            <!-- Stats Comparison -->
        </div>

        <div class="card">
             <div id="chart_interactive_comparison" class="chart-box"></div>
        </div>
    </div>

</div>

<script>
    // 1. DATA INJECTION
    const marketData = [{"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "YabaTech", "asin": "YAB1000", "product_title": "YabaTech Pro Widget 1", "clicks": 815, "click_share": 16.3, "price": 28.71, "is_yaba_asin": "Y", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "YabaTech", "asin": "YAB2000", "product_title": "YabaTech Pro Widget 2", "clicks": 883, "click_share": 17.66, "price": 28.69, "is_yaba_asin": "Y", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "AlphaComp", "asin": "ALP1000", "product_title": "AlphaComp Pro Widget 1", "clicks": 286, "click_share": 5.72, "price": 25.12, "is_yaba_asin": "N", "average_organic_rank": 50, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "AlphaComp", "asin": "ALP2000", "product_title": "AlphaComp Pro Widget 2", "clicks": 232, "click_share": 4.64, "price": 24.51, "is_yaba_asin": "N", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "BetaGear", "asin": "BET1000", "product_title": "BetaGear Pro Widget 1", "clicks": 490, "click_share": 9.8, "price": 36.56, "is_yaba_asin": "N", "average_organic_rank": 28, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "BetaGear", "asin": "BET2000", "product_title": "BetaGear Pro Widget 2", "clicks": 427, "click_share": 8.54, "price": 34.61, "is_yaba_asin": "N", "average_organic_rank": 40, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "GammaGadgets", "asin": "GAM1000", "product_title": "GammaGadgets Pro Widget 1", "clicks": 716, "click_share": 14.32, "price": 20.91, "is_yaba_asin": "N", "average_organic_rank": 50, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "GammaGadgets", "asin": "GAM2000", "product_title": "GammaGadgets Pro Widget 2", "clicks": 738, "click_share": 14.76, "price": 21.05, "is_yaba_asin": "N", "average_organic_rank": 35, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "CheapKnockoff", "asin": "CHE1000", "product_title": "CheapKnockoff Pro Widget 1", "clicks": 329, "click_share": 6.58, "price": 14.86, "is_yaba_asin": "N", "average_organic_rank": 31, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-01", "parent_asin": "PARENT123", "competitor_brand": "CheapKnockoff", "asin": "CHE2000", "product_title": "CheapKnockoff Pro Widget 2", "clicks": 316, "click_share": 6.32, "price": 14.47, "is_yaba_asin": "N", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "YabaTech", "asin": "YAB1001", "product_title": "YabaTech Pro Widget 1", "clicks": 284, "click_share": 5.68, "price": 31.02, "is_yaba_asin": "Y", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "YabaTech", "asin": "YAB2001", "product_title": "YabaTech Pro Widget 2", "clicks": 692, "click_share": 13.84, "price": 28.52, "is_yaba_asin": "Y", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "AlphaComp", "asin": "ALP1001", "product_title": "AlphaComp Pro Widget 1", "clicks": 662, "click_share": 13.24, "price": 25.54, "is_yaba_asin": "N", "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "AlphaComp", "asin": "ALP2001", "product_title": "AlphaComp Pro Widget 2", "clicks": 691, "click_share": 13.82, "price": 24.3, "is_yaba_asin": "N", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "BetaGear", "asin": "BET1001", "product_title": "BetaGear Pro Widget 1", "clicks": 472, "click_share": 9.44, "price": 36.71, "is_yaba_asin": "N", "average_organic_rank": 21, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "BetaGear", "asin": "BET2001", "product_title": "BetaGear Pro Widget 2", "clicks": 283, "click_share": 5.66, "price": 35.8, "is_yaba_asin": "N", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "GammaGadgets", "asin": "GAM1001", "product_title": "GammaGadgets Pro Widget 1", "clicks": 535, "click_share": 10.7, "price": 22.91, "is_yaba_asin": "N", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "GammaGadgets", "asin": "GAM2001", "product_title": "GammaGadgets Pro Widget 2", "clicks": 971, "click_share": 19.42, "price": 20.91, "is_yaba_asin": "N", "average_organic_rank": 39, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "CheapKnockoff", "asin": "CHE1001", "product_title": "CheapKnockoff Pro Widget 1", "clicks": 686, "click_share": 13.72, "price": 14.86, "is_yaba_asin": "N", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-08", "parent_asin": "PARENT123", "competitor_brand": "CheapKnockoff", "asin": "CHE2001", "product_title": "CheapKnockoff Pro Widget 2", "clicks": 535, "click_share": 10.7, "price": 14.5, "is_yaba_asin": "N", "average_organic_rank": 35, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "YabaTech", "asin": "YAB1002", "product_title": "YabaTech Pro Widget 1", "clicks": 328, "click_share": 6.56, "price": 29.83, "is_yaba_asin": "Y", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "YabaTech", "asin": "YAB2002", "product_title": "YabaTech Pro Widget 2", "clicks": 283, "click_share": 5.66, "price": 30.63, "is_yaba_asin": "Y", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "AlphaComp", "asin": "ALP1002", "product_title": "AlphaComp Pro Widget 1", "clicks": 268, "click_share": 5.36, "price": 26.69, "is_yaba_asin": "N", "average_organic_rank": 33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "AlphaComp", "asin": "ALP2002", "product_title": "AlphaComp Pro Widget 2", "clicks": 699, "click_share": 13.98, "price": 24.3, "is_yaba_asin": "N", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "BetaGear", "asin": "BET1002", "product_title": "BetaGear Pro Widget 1", "clicks": 286, "click_share": 5.72, "price": 36.43, "is_yaba_asin": "N", "average_organic_rank": 50, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "BetaGear", "asin": "BET2002", "product_title": "BetaGear Pro Widget 2", "clicks": 530, "click_share": 10.6, "price": 35.32, "is_yaba_asin": "N", "average_organic_rank": 24, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "GammaGadgets", "asin": "GAM1002", "product_title": "GammaGadgets Pro Widget 1", "clicks": 718, "click_share": 14.36, "price": 22.39, "is_yaba_asin": "N", "average_organic_rank": 33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "GammaGadgets", "asin": "GAM2002", "product_title": "GammaGadgets Pro Widget 2", "clicks": 252, "click_share": 5.04, "price": 22.95, "is_yaba_asin": "N", "average_organic_rank": 38, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "CheapKnockoff", "asin": "CHE1002", "product_title": "CheapKnockoff Pro Widget 1", "clicks": 269, "click_share": 5.38, "price": 14.86, "is_yaba_asin": "N", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-15", "parent_asin": "PARENT123", "competitor_brand": "CheapKnockoff", "asin": "CHE2002", "product_title": "CheapKnockoff Pro Widget 2", "clicks": 692, "click_share": 13.84, "price": 14.34, "is_yaba_asin": "N", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "YabaTech", "asin": "YAB1003", "product_title": "YabaTech Pro Widget 1", "clicks": 1373, "click_share": 27.46, "price": 29.56, "is_yaba_asin": "Y", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "YabaTech", "asin": "YAB2003", "product_title": "YabaTech Pro Widget 2", "clicks": 870, "click_share": 17.4, "price": 28.53, "is_yaba_asin": "Y", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "AlphaComp", "asin": "ALP1003", "product_title": "AlphaComp Pro Widget 1", "clicks": 352, "click_share": 7.04, "price": 26.25, "is_yaba_asin": "N", "average_organic_rank": 32, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "AlphaComp", "asin": "ALP2003", "product_title": "AlphaComp Pro Widget 2", "clicks": 718, "click_share": 14.36, "price": 26.69, "is_yaba_asin": "N", "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "BetaGear", "asin": "BET1003", "product_title": "BetaGear Pro Widget 1", "clicks": 536, "click_share": 10.72, "price": 36.31, "is_yaba_asin": "N", "average_organic_rank": 34, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "BetaGear", "asin": "BET2003", "product_title": "BetaGear Pro Widget 2", "clicks": 743, "click_share": 14.86, "price": 35.84, "is_yaba_asin": "N", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "GammaGadgets", "asin": "GAM1003", "product_title": "GammaGadgets Pro Widget 1", "clicks": 387, "click_share": 7.74, "price": 22.18, "is_yaba_asin": "N", "average_organic_rank": 33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "GammaGadgets", "asin": "GAM2003", "product_title": "GammaGadgets Pro Widget 2", "clicks": 289, "click_share": 5.78, "price": 20.91, "is_yaba_asin": "N", "average_organic_rank": 43, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "CheapKnockoff", "asin": "CHE1003", "product_title": "CheapKnockoff Pro Widget 1", "clicks": 380, "click_share": 7.6, "price": 15.69, "is_yaba_asin": "N", "average_organic_rank": 29, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}, {"week_date": "2023-10-22", "parent_asin": "PARENT123", "competitor_brand": "CheapKnockoff", "asin": "CHE2003", "product_title": "CheapKnockoff Pro Widget 2", "clicks": 978, "click_share": 19.56, "price": 14.73, "is_yaba_asin": "N", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "grams": 500, "organic_or_not": "Organic", "container": "Box", "keywords_link": "http://amazon.com/s?k=widget", "keyword": "widget keyword"}];

    // 2. HELPER FUNCTIONS
    // Identify Brand Logic: Competitor Brand > Title extraction > Unknown
    const getBrand = (row) => {
        if (row.competitor_brand && row.competitor_brand !== 'nan') return row.competitor_brand;
        if (row.product_title) return row.product_title.split(' ')[0];
        if (row.keyword_link) return "Unknown (Link)"; // Simplification
        return "Unknown Brand";
    };

    // Get Our Brand Name
    const ourAsins = marketData.filter(d => d.is_yaba_asin === 'Y');
    const ourBrandName = ourAsins.length > 0 ? getBrand(ourAsins[0]) : "Our Brand";
    
    // Unique Weeks (Sorted)
    const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
    document.getElementById('date-range').innerText = `Rango: ${weeks[0]} a ${weeks[weeks.length-1]}`;

    // 3. GOOGLE CHARTS SETUP
    google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processGlobalTrend();
        processCompetitiveness();
        processLevers();
        processEfficiency();
        generateInsights();
        setupInteractive();
    }

    // --- SECTION 1: GLOBAL TREND ---
    function processGlobalTrend() {
        // Aggregate by week and ownership
        const agg = {}; // week -> { ourClicks, compClicks, totalClicks }
        
        marketData.forEach(row => {
            if (!agg[row.week_date]) agg[row.week_date] = { our: 0, comp: 0, total: 0 };
            const clicks = parseFloat(row.clicks) || 0;
            if (row.is_yaba_asin === 'Y') agg[row.week_date].our += clicks;
            else agg[row.week_date].comp += clicks;
            agg[row.week_date].total += clicks;
        });

        const dataArray = [['Semana', 'Nuestros Clicks', 'Clicks Competencia', 'Nuestro Share Global (%)']];
        let lastWeekStats = {};
        
        weeks.forEach(w => {
            const d = agg[w];
            const share = d.total > 0 ? (d.our / d.total) * 100 : 0;
            dataArray.push([w, d.our, d.comp, share]);
            lastWeekStats = { clicks: d.our, share: share, total: d.total };
        });

        // Draw Chart
        const data = google.visualization.arrayToDataTable(dataArray);
        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}},
            colors: ['#4285F4', '#9AA0A6', '#FBBC05'],
            vAxes: { 0: {title: 'Volumen Clicks'}, 1: {title: '% Share', format: '#\'%\''} },
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };
        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);

        // Stats HTML
        document.getElementById('global-stats').innerHTML = `
            <div class="stat-item">
                <div class="stat-label">Clicks Última Semana</div>
                <div class="stat-value">${Math.round(lastWeekStats.clicks)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Share Última Semana</div>
                <div class="stat-value">${lastWeekStats.share.toFixed(1)}%</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Tendencia</div>
                <div class="stat-value" style="font-size:16px; color:${lastWeekStats.share > 10 ? 'var(--success)' : 'var(--danger)'}">
                    ${lastWeekStats.share > 10 ? 'Positiva ▲' : 'Baja ▼'}
                </div>
            </div>
        `;
        
        // Insight Text
        const prevWeek = weeks[weeks.length-2];
        const prevShare = agg[prevWeek] ? (agg[prevWeek].our / agg[prevWeek].total)*100 : 0;
        const diff = lastWeekStats.share - prevShare;
        document.getElementById('global_insight').innerHTML = `
            Comparado con la semana anterior, nuestra cuota de clicks ha variado un <strong>${diff.toFixed(1)}%</strong>.
            ${diff > 0 ? 'Estamos ganando tracción.' : 'Estamos perdiendo visibilidad frente a competidores.'}
        `;
    }

    // --- SECTION 2: COMPETITIVENESS ---
    function processCompetitiveness() {
        // Top 3 Competitors + Us + Rest
        const brandShares = {}; // brand -> total_clicks
        marketData.forEach(row => {
            const b = getBrand(row);
            const clicks = parseFloat(row.clicks) || 0;
            if (!brandShares[b]) brandShares[b] = 0;
            brandShares[b] += clicks;
        });

        // Identify Top 3 (excluding us)
        const sortedBrands = Object.keys(brandShares)
            .filter(b => b !== ourBrandName)
            .sort((a,b) => brandShares[b] - brandShares[a])
            .slice(0, 3);
        
        const keyBrands = [ourBrandName, ...sortedBrands, "Resto del Mercado"];

        // Build Time Series Data
        const header = ['Semana', ourBrandName, ...sortedBrands, 'Resto'];
        const rows = weeks.map(w => {
            const rowData = [w, 0, 0, 0, 0, 0]; // Init based on length
            let weekTotal = 0;
            
            // Calculate totals for this week
            const weekRows = marketData.filter(d => d.week_date === w);
            weekRows.forEach(r => weekTotal += (parseFloat(r.clicks)||0));

            if (weekTotal === 0) return rowData;

            weekRows.forEach(r => {
                const b = getBrand(r);
                const share = ((parseFloat(r.clicks)||0) / weekTotal) * 100;
                
                if (b === ourBrandName) rowData[1] += share;
                else if (sortedBrands.indexOf(b) === 0) rowData[2] += share;
                else if (sortedBrands.indexOf(b) === 1) rowData[3] += share;
                else if (sortedBrands.indexOf(b) === 2) rowData[4] += share;
                else rowData[5] += share; // Resto
            });
            return rowData;
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_comp'));
        chart.draw(data, {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#999'],
            vAxis: { title: '% Click Share' },
            lineWidth: 3
        });
        
        document.getElementById('brand_insight').innerText = `Competidores principales identificados: ${sortedBrands.join(', ')}. Nuestra marca (${ourBrandName}) compite directamente por la cuota de mercado.`;
    }

    // --- SECTION 3: LEVERS ---
    function processLevers() {
        // Price Analysis (Avg Price vs Total Share for latest week)
        const lastWeek = weeks[weeks.length-1];
        const currentData = marketData.filter(d => d.week_date === lastWeek);
        
        const brandStats = {};
        currentData.forEach(r => {
            const b = getBrand(r);
            if (!brandStats[b]) brandStats[b] = { clicks: 0, revenue: 0, count: 0 };
            brandStats[b].clicks += (parseFloat(r.clicks)||0);
            brandStats[b].revenue += (parseFloat(r.price)||0) * (parseFloat(r.clicks)||0); // weighted price
            brandStats[b].count++;
        });

        const scatterData = [['Marca', 'Precio Promedio', 'Total Clicks', 'Tipo']];
        Object.keys(brandStats).forEach(b => {
            const avgPrice = brandStats[b].clicks > 0 ? brandStats[b].revenue / brandStats[b].clicks : 0;
            scatterData.push([
                b, 
                avgPrice, 
                brandStats[b].clicks, 
                b === ourBrandName ? 'Nosotros' : 'Competencia'
            ]);
        });

        // Price Chart
        const dataPrice = google.visualization.arrayToDataTable(scatterData);
        new google.visualization.BubbleChart(document.getElementById('chart_levers_price')).draw(dataPrice, {
            title: 'Posicionamiento Precio vs Volumen (Última Semana)',
            hAxis: {title: 'Precio Promedio ($)'},
            vAxis: {title: 'Volumen Clicks'},
            bubble: {textStyle: {fontSize: 11}},
            colors: ['#EA4335', '#4285F4'] // Competencia Red, Nosotros Blue (sorted alphabetically usually, needs check)
        });

        // Deals Table
        // Calculate average share when Deal > 0 vs Deal = 0
        const dealsData = [['Estado', 'Avg Share %', 'Observed Weeks']];
        
        const withDeal = marketData.filter(d => d.weekly_number_of_days_with_deal > 0 && d.is_yaba_asin === 'Y');
        const withoutDeal = marketData.filter(d => d.weekly_number_of_days_with_deal === 0 && d.is_yaba_asin === 'Y');
        
        const avgShare = (arr) => {
            if (arr.length === 0) return 0;
            return arr.reduce((sum, r) => sum + (parseFloat(r.click_share)||0), 0) / arr.length;
        };

        dealsData.push(['Con Deal', avgShare(withDeal), withDeal.length]);
        dealsData.push(['Sin Deal', avgShare(withoutDeal), withoutDeal.length]);

        const tableData = google.visualization.arrayToDataTable(dealsData);
        new google.visualization.Table(document.getElementById('table_levers')).draw(tableData, {width: '100%', height: '100%'});
    }

    // --- SECTION 4: EFFICIENCY ---
    function processEfficiency() {
        const lastWeek = weeks[weeks.length-1];
        const data = marketData.filter(d => d.week_date === lastWeek);
        
        // Header: [Rank, Share, Tooltip(Title), Color]
        const chartData = [['Organic Rank', 'Click Share', {role: 'style'}, {role: 'tooltip'}]];
        
        data.forEach(r => {
            const isUs = r.is_yaba_asin === 'Y';
            const color = isUs ? '#4285F4' : '#EA4335';
            const rank = parseFloat(r.average_organic_rank) || 50;
            const share = parseFloat(r.click_share) || 0;
            
            chartData.push([
                rank, 
                share, 
                `point { size: 5; shape-type: circle; fill-color: ${color}; }`,
                `${r.product_title}\nRank: ${rank}\nShare: ${share}%`
            ]);
        });

        const dataTable = google.visualization.arrayToDataTable(chartData);
        new google.visualization.ScatterChart(document.getElementById('chart_efficiency')).draw(dataTable, {
            title: 'Eficiencia: Organic Rank vs Click Share (Última Semana)',
            hAxis: { title: 'Organic Rank (Menor es mejor)', direction: -1 }, // Invert axis so rank 1 is right or left? Usually rank 1 is best. Let's keep standard 0->50
            vAxis: { title: 'Click Share %' },
            legend: 'none'
        });
    }

    // --- SECTION 5: INSIGHTS GENERATION ---
    function generateInsights() {
        const insights = [];
        const recs = [];
        const others = [];

        // Logic based on last week data
        const lastWeek = weeks[weeks.length-1];
        const ourLastWeek = marketData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y');
        const compLastWeek = marketData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'N');

        const ourAvgPrice = ourLastWeek.reduce((s,c) => s + c.price, 0) / (ourLastWeek.length || 1);
        const compAvgPrice = compLastWeek.reduce((s,c) => s + c.price, 0) / (compLastWeek.length || 1);

        // Insight 1: Price
        if (ourAvgPrice > compAvgPrice * 1.1) {
            insights.push(`Tu precio promedio ($${ourAvgPrice.toFixed(2)}) es un 10% superior al de la competencia.`);
            recs.push(`Evaluar elasticidad de precio. Considerar cupón del 5-10% para ganar conversión.`);
        } else if (ourAvgPrice < compAvgPrice * 0.9) {
            insights.push(`Estás posicionado como opción económica ($${ourAvgPrice.toFixed(2)}).`);
            others.push(`Oportunidad de subir precio ligeramente si el ranking es fuerte.`);
        } else {
            insights.push(`Precio alineado con el mercado.`);
        }

        // Insight 2: Deals
        const dealsActive = ourLastWeek.some(d => d.weekly_number_of_days_with_deal > 0);
        if (!dealsActive) {
            recs.push(`No hay Deals activos en la última semana. Activar Lightning Deals para recuperar visibilidad.`);
        }

        // Insight 3: Rank
        const avgRank = ourLastWeek.reduce((s,c) => s + c.average_organic_rank, 0) / (ourLastWeek.length||1);
        insights.push(`Tu ranking orgánico promedio es ${avgRank.toFixed(1)}.`);
        if (avgRank > 10) recs.push(`Priorizar SEO en títulos y backend keywords para entrar al Top 10.`);

        // Fill Lists
        document.getElementById('insights_list').innerHTML = insights.map(i => `<li class="rec-item">${i}</li>`).join('');
        document.getElementById('recs_list').innerHTML = recs.map(i => `<li class="rec-item" style="border-left-color: var(--success)">${i}</li>`).join('');
        
        others.push("Revisar competidores emergentes en el cuadrante inferior izquierdo del gráfico de eficiencia.");
        document.getElementById('other_insights').innerHTML = others.map(i => `<li class="rec-item" style="border-left-color: var(--warning)">${i}</li>`).join('');
    }

    // --- TAB 2: INTERACTIVE ---
    function setupInteractive() {
        // Populate Selectors
        const selWeek = document.getElementById('sel_week');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w; opt.text = w;
            selWeek.appendChild(opt);
        });
        selWeek.value = weeks[weeks.length-1]; // Default last week

        const selComp = document.getElementById('sel_competitor');
        // Get unique competitors
        const compSet = new Set();
        marketData.forEach(r => { if(r.is_yaba_asin === 'N') compSet.add(getBrand(r)); });
        compSet.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.text = c;
            selComp.appendChild(opt);
        });

        drawInteractive();
    }

    function drawInteractive() {
        const week = document.getElementById('sel_week').value;
        const comp = document.getElementById('sel_competitor').value;

        // Filter Data
        const us = marketData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
        const them = marketData.filter(d => d.week_date === week && getBrand(d) === comp);

        // Calculate Metrics
        const calc = (arr, key) => arr.reduce((s, x) => s + (parseFloat(x[key])||0), 0);
        const usClicks = calc(us, 'clicks');
        const themClicks = calc(them, 'clicks');
        const usPrice = us.length ? calc(us, 'price')/us.length : 0;
        const themPrice = them.length ? calc(them, 'price')/them.length : 0;

        // Draw Comparison Chart
        const data = google.visualization.arrayToDataTable([
            ['Métrica', 'Nosotros', comp],
            ['Clicks', usClicks, themClicks],
            ['Precio ($)', usPrice, themPrice],
            ['Deal Days (Avg)', us.length?calc(us, 'weekly_number_of_days_with_deal')/us.length:0, them.length?calc(them, 'weekly_number_of_days_with_deal')/them.length:0]
        ]);

        const options = {
            title: `Comparativa Directa: ${week}`,
            vAxis: { title: 'Valor' },
            seriesType: 'bars',
            series: {1: {type: 'bars'}},
            colors: ['#4285F4', '#EA4335']
        };

        new google.visualization.ComboChart(document.getElementById('chart_interactive_comparison')).draw(data, options);
    }

    // --- UTILS ---
    window.switchTab = function(tabId) {
        document.getElementById('tab-static').classList.add('hidden');
        document.getElementById('tab-interactive').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        event.target.classList.add('active');
        
        // Redraw charts to fix hidden container dimension issues
        if(tabId === 'interactive') drawInteractive();
    }

</script>
</body>
</html>