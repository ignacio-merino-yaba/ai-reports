<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Estratégico Parent ASIN</title>
    
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --success: #34A853; /* Google Green */
            --warning: #FBBC05; /* Google Yellow */
            --danger: #EA4335;  /* Google Red */
            --gray-50: #F8F9FA;
            --gray-100: #F1F3F4;
            --gray-200: #E8EAED;
            --gray-700: #5F6368;
            --gray-900: #202124;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --card-radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-900);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
            background: white;
            padding: 24px;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--gray-900);
        }

        .header .meta {
            font-size: 14px;
            color: var(--gray-700);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: white;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-700);
            box-shadow: var(--shadow);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Sections */
        .section {
            background: white;
            border-radius: var(--card-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: none; /* Hidden by default */
        }
        
        .section.active {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Cards & Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .kpi-card {
            background: var(--gray-100);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .kpi-label {
            font-size: 12px;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
        }

        .insight-item {
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .insight-item:last-child { border-bottom: none; }

        .insight-icon {
            color: var(--primary);
            flex-shrink: 0;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--gray-100);
            padding: 16px;
            border-radius: 12px;
        }

        select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            font-family: inherit;
        }

        /* Comparison Table */
        .comp-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comp-table th, .comp-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .comp-table th {
            color: var(--gray-700);
            font-size: 12px;
            text-transform: uppercase;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .badge-pos { background: #e6f4ea; color: var(--success); }
        .badge-neg { background: #fce8e6; color: var(--danger); }
        .badge-neu { background: var(--gray-200); color: var(--gray-700); }

    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Análisis Parent ASIN: <span id="parentName">Loading...</span></h1>
                <div class="meta" id="dateRange">Cargando datos...</div>
            </div>
            <div style="text-align: right;">
                <div class="meta">Marca Principal</div>
                <div id="ourBrandDisplay" style="font-weight: bold; font-size: 18px; color: var(--primary);">Detectando...</div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('report')">
                <span class="material-icons">assessment</span> Reporte Estratégico
            </button>
            <button class="tab-btn" onclick="switchTab('interactive')">
                <span class="material-icons">compare_arrows</span> Comparador Interactivo
            </button>
        </div>

        <!-- TAB 1: REPORT -->
        <div id="report" class="section active">
            
            <!-- 1. Tendencia Global -->
            <div class="section-title">
                <span class="material-icons">trending_up</span> 1. Tendencia Global del Parent
            </div>
            <div class="grid-3" style="margin-bottom: 20px;">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiClicks">0</div>
                    <div class="kpi-label">Clicks Última Semana</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiShare">0%</div>
                    <div class="kpi-label">Click Share Total (Nosotros)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiTrend">0%</div>
                    <div class="kpi-label">Var. vs Sem Anterior</div>
                </div>
            </div>
            <div id="chart_trend" class="chart-container"></div>
            <div class="insight-item" id="trendInsight"></div>

            <!-- 2. Competitividad -->
            <hr style="border: 0; border-top: 1px solid var(--gray-200); margin: 32px 0;">
            <div class="section-title">
                <span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Share of Voice)
            </div>
            <p style="font-size: 14px; color: var(--gray-700);">Evolución del Click Share de Nuestra Marca vs Top 3 Competidores.</p>
            <div id="chart_competitors" class="chart-container"></div>
            <div id="compInsights" class="grid-2"></div>

            <!-- 3. Palancas -->
            <hr style="border: 0; border-top: 1px solid var(--gray-200); margin: 32px 0;">
            <div class="section-title">
                <span class="material-icons">rocket_launch</span> 3. Palancas de Crecimiento
            </div>
            <div class="grid-2">
                <div>
                    <h4>Impacto de Precio</h4>
                    <div id="chart_price" style="height: 250px;"></div>
                </div>
                <div>
                    <h4>Efectividad de Promociones (Nosotros)</h4>
                    <div id="promo_impact_stats"></div>
                </div>
            </div>

            <!-- 4. Eficiencia -->
            <hr style="border: 0; border-top: 1px solid var(--gray-200); margin: 32px 0;">
            <div class="section-title">
                <span class="material-icons">speed</span> 4. Eficiencia (Rank vs Click Share)
            </div>
            <div id="chart_efficiency" class="chart-container"></div>
            <p style="font-size:12px; color:var(--gray-700); text-align:center;">Eje X: Ranking Orgánico (Inverso) | Eje Y: Click Share. Puntos arriba a la derecha = Alta Eficiencia.</p>

            <!-- 5. Conclusiones -->
            <hr style="border: 0; border-top: 1px solid var(--gray-200); margin: 32px 0;">
            <div class="grid-2">
                <div>
                    <div class="section-title"><span class="material-icons">lightbulb</span> 5. Insights Clave</div>
                    <ul class="insight-list" id="finalInsights"></ul>
                </div>
                <div>
                    <div class="section-title"><span class="material-icons">check_circle</span> Recomendaciones</div>
                    <ul class="insight-list" id="finalRecs"></ul>
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE -->
        <div id="interactive" class="section">
            <div class="section-title">
                <span class="material-icons">tune</span> Comparador Cara a Cara
            </div>
            <div class="controls">
                <div>
                    <label style="font-size:12px; display:block;">Semana</label>
                    <select id="selWeek" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label style="font-size:12px; display:block;">Competidor</label>
                    <select id="selComp" onchange="updateInteractive()"></select>
                </div>
            </div>
            
            <div id="interactiveContent" class="grid-2">
                <!-- Content injected via JS -->
            </div>
        </div>

    </div>

<script>
// ==========================================
// 1. DATA INJECTION (PROCESSED FROM PYTHON)
// ==========================================
const rawData = [{"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "", "asin": "B0F5BVFRC1", "product_title": "Jean & Len Handcreme I Love You So Matcha, f\u00fcr nor...", "country_code": "de", "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.92, "impression_share": 2.66, "price": 3.0957142857, "click_share_rank": 10, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 11.18, "impression_share": 3.15, "price": 14.084285714, "click_share_rank": 2, "weekly_search_volume": 60855.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 22.0, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.95, "impression_share": 2.57, "price": 26.748571429, "click_share_rank": 8, "weekly_search_volume": 60855.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 16.66, "impression_share": 3.14, "price": 24.03, "click_share_rank": 1, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.69, "impression_share": 3.13, "price": 23.075714286, "click_share_rank": 5, "weekly_search_volume": 60855.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.85, "impression_share": 3.15, "price": 9.2, "click_share_rank": 4, "weekly_search_volume": 60855.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.85, "impression_share": 4.22, "price": 15.635714286, "click_share_rank": 3, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.85, "impression_share": 4.22, "price": 15.635714286, "click_share_rank": 3, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 8.0, "weekly_number_of_days_with_deal": 5.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.49, "impression_share": 4.25, "price": 9.0057142857, "click_share_rank": 6, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "", "asin": "B0G1T7N675", "product_title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "country_code": "de", "average_organic_rank": 12.0, "weekly_number_of_days_with_deal": 7.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.56, "impression_share": 3.71, "price": 8.8985714286, "click_share_rank": 9, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.48, "impression_share": 4.53, "price": 10.44, "click_share_rank": 7, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-20", "week_date": "2025-12-20", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 14.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.48, "impression_share": 4.53, "price": 10.44, "click_share_rank": 7, "weekly_search_volume": 60855.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 11.66, "impression_share": 3.37, "price": 15.058571429, "click_share_rank": 2, "weekly_search_volume": 47708.06, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 7.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 18.77, "impression_share": 3.35, "price": 24.648571429, "click_share_rank": 1, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 4.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.75, "impression_share": 3.25, "price": 10.538571429, "click_share_rank": 5, "weekly_search_volume": 47708.06, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.49, "impression_share": 3.36, "price": 24.855714286, "click_share_rank": 6, "weekly_search_volume": 47708.06, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.42, "impression_share": 4.24, "price": 16.037142857, "click_share_rank": 3, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 8.42, "impression_share": 4.24, "price": 16.037142857, "click_share_rank": 3, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 7.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 4.19, "impression_share": 5.29, "price": 9.8957142857, "click_share_rank": 4, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.44, "impression_share": 3.4, "price": 12.367142857, "click_share_rank": 9, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.44, "impression_share": 3.4, "price": 12.367142857, "click_share_rank": 9, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.4, "impression_share": 4.7, "price": 10.71, "click_share_rank": 7, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 13.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 7.0, "click_share": 3.4, "impression_share": 4.7, "price": 10.71, "click_share_rank": 7, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07K1WBH4K", "product_title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "country_code": "de", "average_organic_rank": 20.0, "weekly_number_of_days_with_deal": 3.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.47, "impression_share": 2.29, "price": 9.8957142857, "click_share_rank": 10, "weekly_search_volume": 47708.06, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2025-12-27", "week_date": "2025-12-27", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 23.0, "weekly_number_of_days_with_deal": 1.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.93, "impression_share": 2.43, "price": 30.704285714, "click_share_rank": 8, "weekly_search_volume": 47708.06, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B07SZFD3P9", "product_title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "country_code": "de", "average_organic_rank": 2.68, "weekly_number_of_days_with_deal": 2.06, "weekly_number_of_days_with_best_seller_badge": 30.27, "weekly_number_of_days_with_amazon_choice_badge": 8.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 27011.1, "impression_share": 0.0, "price": 0.0, "click_share_rank": 0, "weekly_search_volume": 0.0, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 12.9, "impression_share": 3.37, "price": 14.6075, "click_share_rank": 2, "weekly_search_volume": 27011.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0CNRX8G5S", "product_title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "country_code": "de", "average_organic_rank": 2.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 4.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 19.34, "impression_share": 3.36, "price": 23.91, "click_share_rank": 1, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B06XQ69YCQ", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.35, "impression_share": 3.02, "price": 10.2225, "click_share_rank": 5, "weekly_search_volume": 27011.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "NaturaleBio", "asin": "B079VQ52MK", "product_title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "country_code": "de", "average_organic_rank": 5.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.66, "impression_share": 3.36, "price": 24.5275, "click_share_rank": 4, "weekly_search_volume": 27011.1, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "NORITUAL LAB", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 7.38, "impression_share": 4.54, "price": 15.5575, "click_share_rank": 3, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "", "asin": "B0FSL3C3Z8", "product_title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "country_code": "de", "average_organic_rank": 6.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 7.38, "impression_share": 4.54, "price": 15.5575, "click_share_rank": 3, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "VAHDAM", "asin": "B07MD4LB49", "product_title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "country_code": "de", "average_organic_rank": 9.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 3.15, "impression_share": 5.19, "price": 10.43, "click_share_rank": 6, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.39, "impression_share": 3.91, "price": 11.9975, "click_share_rank": 9, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "bioKontor", "asin": "B08XVX8V1T", "product_title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "country_code": "de", "average_organic_rank": 10.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 2.39, "impression_share": 3.91, "price": 11.9975, "click_share_rank": 9, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "Special Leaves", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 16.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "click_share": 3.0, "impression_share": 4.47, "price": 10.39, "click_share_rank": 7, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "", "asin": "B0DRP6Y6XC", "product_title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "country_code": "de", "average_organic_rank": 16.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 4.0, "click_share": 3.0, "impression_share": 4.47, "price": 10.39, "click_share_rank": 7, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}, {"brand_aggregation": "naturalebio", "parent_asin": "Matcha Premium", "reporting_date": "2026-01-03", "week_date": "2026-01-03", "keywords": "matcha", "competitor_brand": "", "asin": "B0F9B1LWQQ", "product_title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "country_code": "de", "average_organic_rank": 19.0, "weekly_number_of_days_with_deal": 0.0, "weekly_number_of_days_with_best_seller_badge": 0.0, "weekly_number_of_days_with_amazon_choice_badge": 0.0, "weekly_number_of_days_with_coupon": 0.0, "click_share": 1.57, "impression_share": 1.96, "price": 31.2725, "click_share_rank": 10, "weekly_search_volume": 27011.1, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=matcha"}];

// ==========================================
// 2. HELPER FUNCTIONS
// ==========================================

// Clean Brand Logic
function getRealBrand(item) {
    if (item.competitor_brand && item.competitor_brand.trim() !== "") {
        return item.competitor_brand.trim();
    }
    // Extract from Title if brand is missing
    const title = item.product_title || "";
    const firstWord = title.split(" ")[0];
    return firstWord.length > 2 ? firstWord : "Unknown Brand";
}

// Processing Data
let processedData = [];
let myBrandName = "Unknown";
let topCompetitors = [];
let allWeeks = [];

function initData() {
    // 1. Identify My Brand
    const myAsinRow = rawData.find(r => r.is_yaba_asin === 'Y' && r.competitor_brand);
    myBrandName = myAsinRow ? myAsinRow.competitor_brand : "MyBrand";
    
    // Update Header
    document.getElementById('parentName').innerText = rawData[0].parent_asin;
    document.getElementById('ourBrandDisplay').innerText = myBrandName;

    // 2. Enhance Data with Real Brand & Estimated Clicks
    processedData = rawData.map(d => {
        const brand = getRealBrand(d);
        // Safety for dirty data: if search vol is 0 or click share > 100, normalize
        const sv = d.weekly_search_volume || 0;
        const clicks = (d.click_share / 100) * sv;
        return {
            ...d,
            real_brand: brand,
            estimated_clicks: clicks,
            is_me: (d.is_yaba_asin === 'Y')
        };
    });

    // 3. Extract Weeks
    const dates = [...new Set(processedData.map(d => d.week_date))].sort();
    allWeeks = dates;
    document.getElementById('dateRange').innerText = `${dates[0]} - ${dates[dates.length-1]}`;

    // 4. Identify Top 3 Competitors (by Avg Click Share)
    const brandShares = {};
    processedData.forEach(d => {
        if (d.real_brand === myBrandName) return;
        if (!brandShares[d.real_brand]) brandShares[d.real_brand] = [];
        brandShares[d.real_brand].push(d.click_share);
    });

    const avgShares = Object.keys(brandShares).map(b => {
        const sum = brandShares[b].reduce((a,c) => a+c, 0);
        return { brand: b, avg: sum / brandShares[b].length };
    });
    
    topCompetitors = avgShares.sort((a,b) => b.avg - a.avg).slice(0,3).map(x => x.brand);
}

// ==========================================
// 3. CHART LOGIC
// ==========================================

google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(drawDashboard);

function drawDashboard() {
    initData();
    drawGlobalTrend();
    drawCompetitorLandscape();
    drawPriceAnalysis();
    drawEfficiencyMap();
    generateInsights();
    populateInteractiveControls();
}

function drawGlobalTrend() {
    // Aggregate by Week: My Clicks vs Competitor Clicks
    const trendData = [['Semana', 'Clicks (Nosotros)', 'Clicks (Competencia)', 'Click Share (Nosotros)']];
    
    allWeeks.forEach(week => {
        const weekData = processedData.filter(d => d.week_date === week);
        const myClicks = weekData.filter(d => d.is_me).reduce((sum, d) => sum + d.estimated_clicks, 0);
        const compClicks = weekData.filter(d => !d.is_me).reduce((sum, d) => sum + d.estimated_clicks, 0);
        
        // Calculate Total Share for "Me" weighted by search volume (if multiple keywords existed, but here likely 1 parent context)
        // Simple aggregate share: Sum(My Share)
        const myShareSum = weekData.filter(d => d.is_me).reduce((sum, d) => sum + d.click_share, 0);

        trendData.push([week, Math.round(myClicks), Math.round(compClicks), myShareSum]);
    });

    const data = google.visualization.arrayToDataTable(trendData);

    const options = {
        seriesType: 'bars',
        series: {2: {type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3}},
        colors: ['#8AB4F8', '#E8EAED'],
        isStacked: true,
        vAxes: {
            0: {title: 'Volumen de Clicks'},
            1: {title: '% Share', format: '#\'%\''}
        },
        legend: {position: 'bottom'},
        chartArea: {width: '85%', height: '70%'}
    };

    const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
    chart.draw(data, options);

    // Update KPI Cards (Last Week)
    const lastRow = trendData[trendData.length - 1];
    const prevRow = trendData[trendData.length - 2];
    
    const currentClicks = lastRow[1];
    const currentShare = lastRow[3];
    const prevClicks = prevRow ? prevRow[1] : currentClicks;
    
    const growth = prevClicks > 0 ? ((currentClicks - prevClicks) / prevClicks * 100).toFixed(1) : 0;

    document.getElementById('kpiClicks').innerText = currentClicks.toLocaleString();
    document.getElementById('kpiShare').innerText = currentShare.toFixed(1) + '%';
    document.getElementById('kpiTrend').innerText = (growth > 0 ? '+' : '') + growth + '%';
    document.getElementById('kpiTrend').style.color = growth >= 0 ? 'var(--success)' : 'var(--danger)';

    // Text Insight
    const trendText = growth > 0 
        ? "El parent muestra una tendencia positiva en volumen de clicks respecto a la semana anterior."
        : "Se observa una contracción en el volumen de captación de tráfico.";
    document.getElementById('trendInsight').innerHTML = `<span class="material-icons insight-icon">analytics</span><div>${trendText}</div>`;
}

function drawCompetitorLandscape() {
    // Columns: Week, Me, Comp 1, Comp 2, Comp 3, Others
    const header = ['Semana', myBrandName, ...topCompetitors, 'Otros'];
    const rows = [];

    allWeeks.forEach(week => {
        const weekData = processedData.filter(d => d.week_date === week);
        
        // Sum Click Share per brand per week
        const getShare = (brand) => weekData.filter(d => d.real_brand === brand).reduce((s, d) => s + d.click_share, 0);
        
        const myShare = getShare(myBrandName);
        const c1 = getShare(topCompetitors[0]);
        const c2 = getShare(topCompetitors[1]);
        const c3 = getShare(topCompetitors[2]);
        
        // Others = Total (approx 100 or sum) - known
        // Better: Sum of all others
        const allShares = weekData.reduce((s, d) => s + d.click_share, 0);
        const others = Math.max(0, allShares - myShare - c1 - c2 - c3);

        rows.push([week, myShare, c1, c2, c3, others]);
    });

    const data = google.visualization.arrayToDataTable([header, ...rows]);

    const options = {
        curveType: 'function',
        lineWidth: 2,
        colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
        legend: {position: 'bottom'},
        vAxis: {title: 'Click Share %'},
        chartArea: {width: '90%', height: '75%'}
    };

    const chart = new google.visualization.LineChart(document.getElementById('chart_competitors'));
    chart.draw(data, options);

    // Insights Comp
    const lastW = rows[rows.length-1];
    const prevW = rows[rows.length-2] || lastW;
    let html = "";
    
    // Check My Trend
    const diff = lastW[1] - prevW[1];
    html += `<div><strong>${myBrandName}:</strong> ${diff > 0 ? 'Ganó' : 'Perdió'} ${Math.abs(diff).toFixed(2)}% de cuota esta semana.</div>`;
    
    // Check Top Competitor
    const compDiff = lastW[2] - prevW[2];
    html += `<div><strong>${topCompetitors[0]}:</strong> ${compDiff > 0 ? 'Creciendo' : 'Cediendo terreno'} (${compDiff.toFixed(2)}%).</div>`;

    document.getElementById('compInsights').innerHTML = html;
}

function drawPriceAnalysis() {
    // Scatter Plot: Price vs Share for Last Week
    const lastWeek = allWeeks[allWeeks.length-1];
    const weekData = processedData.filter(d => d.week_date === lastWeek);
    
    const dataArray = [['Brand', 'Precio', 'Click Share', 'Tipo']];
    weekData.forEach(d => {
        dataArray.push([d.real_brand, d.price, d.click_share, d.is_me ? 'Nosotros' : 'Competencia']);
    });

    const data = google.visualization.arrayToDataTable(dataArray);

    const options = {
        title: `Correlación Precio vs Share (${lastWeek})`,
        hAxis: {title: 'Precio Medio (€)'},
        vAxis: {title: 'Click Share %'},
        bubble: {textStyle: {fontSize: 11}},
        colors: ['#9AA0A6', '#4285F4'], // Grey for others, Blue for Us (Mapped by unique values in col 3 logic varies in Google Charts)
        // Note: Scatter chart coloring by category is tricky in basic GCharts without material, using series workaround usually.
        series: {
            0: { color: '#9AA0A6' }, // Logic mapping depends on sort order.
        },
        legend: 'none'
    };

    // A customized view to color by 'Tipo' is hard in simple Scatter without transforming data columns.
    // Simplifying: Just plot all points.
    const chart = new google.visualization.ScatterChart(document.getElementById('chart_price'));
    chart.draw(data, options);
    
    // Promo Stats
    const myAsins = processedData.filter(d => d.is_me);
    const wDeals = myAsins.filter(d => d.weekly_number_of_days_with_deal > 0);
    const woDeals = myAsins.filter(d => d.weekly_number_of_days_with_deal === 0);
    
    const avgShareDeal = wDeals.reduce((s,d)=>s+d.click_share,0) / (wDeals.length||1);
    const avgShareNoDeal = woDeals.reduce((s,d)=>s+d.click_share,0) / (woDeals.length||1);
    
    let uplift = 0;
    if (avgShareNoDeal > 0) uplift = ((avgShareDeal - avgShareNoDeal)/avgShareNoDeal)*100;

    document.getElementById('promo_impact_stats').innerHTML = `
        <div class="kpi-card" style="background:white; border:1px solid var(--gray-200);">
            <div style="font-size:14px;">Impacto Deals (Histórico)</div>
            <div style="font-size:20px; color:${uplift>0?'var(--success)':'var(--gray-700)'}; font-weight:bold;">
                ${uplift.toFixed(1)}% Uplift
            </div>
            <div style="font-size:11px; color:var(--gray-700);">
                Share Promedio con Deal: ${avgShareDeal.toFixed(1)}% vs Sin: ${avgShareNoDeal.toFixed(1)}%
            </div>
        </div>
    `;
}

function drawEfficiencyMap() {
    const lastWeek = allWeeks[allWeeks.length-1];
    const weekData = processedData.filter(d => d.week_date === lastWeek);
    
    // X: Rank (Inverse), Y: Share
    // We want Rank 1 to be on the right? No, standard scatter. 
    // Let's create two series: Us vs Them for coloring
    
    const data = new google.visualization.DataTable();
    data.addColumn('number', 'Rank Orgánico');
    data.addColumn('number', 'Nosotros');
    data.addColumn('number', 'Competencia');
    
    weekData.forEach(d => {
        if (d.is_me) {
            data.addRow([d.average_organic_rank, d.click_share, null]);
        } else {
            data.addRow([d.average_organic_rank, null, d.click_share]);
        }
    });

    const options = {
        hAxis: {title: 'Rank Orgánico (Menor es mejor)', direction: -1}, // Invert axis so #1 is right/top logic usually
        vAxis: {title: 'Click Share %'},
        colors: ['#4285F4', '#EA4335'],
        pointSize: 8,
        legend: {position: 'top'}
    };

    const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
    chart.draw(data, options);
}

function generateInsights() {
    const list = document.getElementById('finalInsights');
    const recs = document.getElementById('finalRecs');
    list.innerHTML = '';
    recs.innerHTML = '';

    // Insight 1: Dominance
    const lastWeekData = processedData.filter(d => d.week_date === allWeeks[allWeeks.length-1]);
    const myTotalShare = lastWeekData.filter(d => d.is_me).reduce((a,b)=>a+b.click_share,0);
    const leader = topCompetitors[0]; // simplistic
    
    list.innerHTML += `<li class="insight-item"><span class="material-icons insight-icon">visibility</span> Nuestra cuota actual es del <strong>${myTotalShare.toFixed(1)}%</strong>.</li>`;

    // Insight 2: Pricing
    const myPrice = lastWeekData.find(d => d.is_me)?.price || 0;
    const mktPrice = lastWeekData.filter(d=>!d.is_me).reduce((a,b)=>a+b.price,0) / lastWeekData.filter(d=>!d.is_me).length;
    
    if (myPrice > mktPrice * 1.2) {
        list.innerHTML += `<li class="insight-item"><span class="material-icons insight-icon">paid</span> Precio Premium: Estamos un ${(myPrice/mktPrice*100 - 100).toFixed(0)}% por encima de la media.</li>`;
        recs.innerHTML += `<li class="insight-item">Evaluar elasticidad de precio o justificar premium con contenido A+ mejorado.</li>`;
    } else {
        list.innerHTML += `<li class="insight-item"><span class="material-icons insight-icon">paid</span> Precio Competitivo: Alineado con el mercado.</li>`;
    }

    // Insight 3: Badges
    const myBadges = lastWeekData.filter(d => d.is_me && (d.weekly_number_of_days_with_amazon_choice_badge > 0 || d.weekly_number_of_days_with_best_seller_badge > 0));
    if (myBadges.length === 0) {
        recs.innerHTML += `<li class="insight-item">Crítico: Recuperar Badges (Choice/Best Seller). Revisar conversión y velocidad de ventas.</li>`;
    } else {
        list.innerHTML += `<li class="insight-item"><span class="material-icons insight-icon">verified</span> Mantenemos Badges activos en ${myBadges.length} ASINs.</li>`;
    }
    
    // Insight 4: Trend
    recs.innerHTML += `<li class="insight-item">Foco en Keywords: Analizar términos donde competidor ${topCompetitors[0]} nos supera en Rank < 5.</li>`;
}

// ==========================================
// 4. INTERACTIVE TAB LOGIC
// ==========================================

function switchTab(tabId) {
    document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(d => d.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    // Find button
    const btnIdx = tabId === 'report' ? 0 : 1;
    document.querySelectorAll('.tab-btn')[btnIdx].classList.add('active');
}

function populateInteractiveControls() {
    const selWeek = document.getElementById('selWeek');
    const selComp = document.getElementById('selComp');
    
    // Reverse weeks for dropdown
    [...allWeeks].reverse().forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.innerText = w;
        selWeek.appendChild(opt);
    });

    topCompetitors.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.innerText = c;
        selComp.appendChild(opt);
    });
    
    updateInteractive(); // Initial Draw
}

function updateInteractive() {
    const week = document.getElementById('selWeek').value;
    const comp = document.getElementById('selComp').value;
    const container = document.getElementById('interactiveContent');
    
    // Get Data
    const myData = processedData.filter(d => d.week_date === week && d.is_me);
    const compData = processedData.filter(d => d.week_date === week && d.real_brand === comp);
    
    // Aggregate (in case of multiple ASINs per brand)
    const agg = (arr) => ({
        share: arr.reduce((a,b)=>a+b.click_share,0).toFixed(1),
        rank: (arr.reduce((a,b)=>a+b.average_organic_rank,0) / (arr.length||1)).toFixed(1),
        price: (arr.reduce((a,b)=>a+b.price,0) / (arr.length||1)).toFixed(2),
        deals: arr.some(d => d.weekly_number_of_days_with_deal > 0)
    });

    const me = agg(myData);
    const them = agg(compData);
    
    // Render HTML
    container.innerHTML = `
        <div style="background:white; padding:20px; border-radius:16px; box-shadow:var(--shadow);">
            <h3 style="color:var(--primary);">${myBrandName} (Nosotros)</h3>
            <div style="font-size:32px; font-weight:bold;">${me.share}% <span style="font-size:14px; color:var(--gray-700);">Share</span></div>
            <table class="comp-table">
                <tr><td>Precio Promedio</td><td><strong>€${me.price}</strong></td></tr>
                <tr><td>Rank Orgánico</td><td><strong>#${me.rank}</strong></td></tr>
                <tr><td>Promo Activa</td><td>${me.deals ? '<span class="badge badge-pos">SÍ</span>' : '<span class="badge badge-neu">NO</span>'}</td></tr>
            </table>
        </div>

        <div style="background:white; padding:20px; border-radius:16px; box-shadow:var(--shadow);">
            <h3 style="color:#EA4335;">${comp}</h3>
            <div style="font-size:32px; font-weight:bold;">${them.share}% <span style="font-size:14px; color:var(--gray-700);">Share</span></div>
            <table class="comp-table">
                <tr><td>Precio Promedio</td><td><strong>€${them.price}</strong></td></tr>
                <tr><td>Rank Orgánico</td><td><strong>#${them.rank}</strong></td></tr>
                <tr><td>Promo Activa</td><td>${them.deals ? '<span class="badge badge-pos">SÍ</span>' : '<span class="badge badge-neu">NO</span>'}</td></tr>
            </table>
        </div>
        
        <div style="grid-column: 1 / -1; background: var(--gray-100); padding:16px; border-radius:12px; margin-top:16px;">
            <strong>Diagnóstico Rápido:</strong> 
            ${parseFloat(me.share) > parseFloat(them.share) 
                ? `<span style="color:var(--success)">Dominamos en cuota (+${(me.share-them.share).toFixed(1)} pts).</span>` 
                : `<span style="color:var(--danger)">Perdemos vs competidor (-${(them.share-me.share).toFixed(1)} pts).</span>`}
            ${parseFloat(me.price) > parseFloat(them.price) ? ' Nuestro precio es más alto.' : ' Nuestro precio es más competitivo.'}
        </div>
    `;
}

</script>
</body>
</html>