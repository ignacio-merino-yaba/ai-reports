<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence Report - YABA</title>
    
    <!-- Google Native Ecosystem Dependencies -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* CSS Reset & Variables */
        :root {
            --primary: #0071e3; /* Amazon/Tech Blue */
            --primary-bg: #e8f0fe;
            --secondary: #1d1d1f; /* Dark Text */
            --tertiary: #86868b; /* Grey Text */
            --bg-color: #f5f5f7; /* Apple Grey */
            --card-bg: #ffffff;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--secondary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .header span {
            color: var(--tertiary);
            font-size: 14px;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #e1e1e6;
            padding: 5px;
            border-radius: 12px;
            width: fit-content;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            border-radius: 8px;
            color: var(--tertiary);
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background-color: var(--card-bg);
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            transition: transform 0.2s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        /* Insights List */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            color: var(--primary);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-green { background: #e6f4ea; color: var(--success); }
        .badge-red { background: #fce8e6; color: var(--danger); }
        .badge-blue { background: var(--primary-bg); color: var(--primary); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: inherit;
            min-width: 150px;
        }

        /* Helper Classes */
        .hidden { display: none; }
        .text-sm { font-size: 13px; color: var(--tertiary); }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--secondary); }
        .stat-label { font-size: 13px; color: var(--tertiary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Charts Container */
        .chart-container {
            width: 100%;
            height: 350px;
        }
        .chart-container-sm {
            width: 100%;
            height: 250px;
        }

        /* Recommendation Box */
        .rec-box {
            background: linear-gradient(135deg, #f6f9fc 0%, #f1f4f9 100%);
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Parent ASIN Analysis Report</h1>
                <span id="date-range">Analizando últimas 5 semanas</span>
            </div>
            <div class="badge badge-blue">CONFIDENTIAL</div>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="static-report">
            
            <!-- Section 1: Global Trend -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">trending_up</span>
                        1. Tendencia Global del Parent
                    </div>
                </div>
                <div class="grid-2">
                    <div class="chart-container" id="global_trend_chart"></div>
                    <div>
                        <h4 style="margin-top:0;">Resumen Ejecutivo</h4>
                        <ul class="insight-list" id="global_insights">
                            <!-- JS Generated -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 2: Brand Competitiveness -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">pie_chart</span>
                        2. Competitividad de Marca (Share of Voice)
                    </div>
                </div>
                <div class="grid-2">
                    <div class="chart-container" id="brand_share_chart"></div>
                    <div>
                        <h4 style="margin-top:0;">Dinámica de Mercado</h4>
                        <p class="text-sm">Evolución semanal del Click Share. Nuestra marca vs Top 3 Competidores.</p>
                        <ul class="insight-list" id="brand_insights"></ul>
                    </div>
                </div>
            </div>

            <!-- Section 3 & 4: Levers & Efficiency -->
            <div class="grid-2">
                <!-- Levers -->
                <div class="card">
                    <div class="card-title" style="margin-bottom: 15px;">
                        <span class="material-icons">tune</span>
                        3. Palancas de Promoción
                    </div>
                    <div class="chart-container-sm" id="levers_chart"></div>
                    <div id="levers_text" class="text-sm" style="margin-top:10px;"></div>
                </div>

                <!-- Efficiency -->
                <div class="card">
                    <div class="card-title" style="margin-bottom: 15px;">
                        <span class="material-icons">speed</span>
                        4. Eficiencia (Rank vs Clicks)
                    </div>
                    <div class="chart-container-sm" id="efficiency_chart"></div>
                    <p class="text-sm" style="margin-top:10px;">
                        <span style="color:#4285F4">●</span> Nosotros 
                        <span style="color:#EA4335">●</span> Competencia. 
                        Eje Y: Click Share, Eje X: Organic Rank (Inv).
                    </p>
                </div>
            </div>

            <!-- Section 5: Conclusions & Recommendations -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-title" style="color: var(--primary);">
                        <span class="material-icons">lightbulb</span>
                        5. Insights Clave
                    </div>
                    <ul class="insight-list" id="key_insights_list">
                        <!-- JS populated -->
                    </ul>
                </div>
                <div class="card">
                    <div class="card-title" style="color: var(--success);">
                        <span class="material-icons">check_circle</span>
                        Recomendaciones Accionables
                    </div>
                    <div id="recommendations_list">
                        <!-- JS populated -->
                    </div>
                </div>
            </div>
            
            <!-- Other Insights -->
            <div class="card">
                 <div class="card-title">
                    <span class="material-icons">travel_explore</span>
                    Other Insights
                </div>
                <p class="text-sm" id="other_insights_text"></p>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="interactive-report" class="hidden">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Comparador Cara a Cara</div>
                </div>
                
                <div class="controls">
                    <div>
                        <label class="text-sm">Semana</label><br>
                        <select id="week_selector" onchange="updateInteractive()"></select>
                    </div>
                    <div>
                        <label class="text-sm">Competidor</label><br>
                        <select id="competitor_selector" onchange="updateInteractive()"></select>
                    </div>
                </div>

                <div class="grid-3" style="margin-top: 20px;">
                    <div class="card" style="background: var(--primary-bg); border: 1px solid var(--primary);">
                        <div class="stat-label">NUESTRA MARCA</div>
                        <div class="stat-value" id="us_share">0%</div>
                        <div class="text-sm">Click Share</div>
                        <div class="text-sm" style="margin-top:5px;">Precio Prom: <strong id="us_price">€0</strong></div>
                        <div id="us_badges" style="margin-top:5px;"></div>
                    </div>

                    <div class="card" style="border: 1px solid var(--tertiary);">
                        <div class="stat-label">VS</div>
                        <div style="text-align:center; margin-top:10px; font-size: 30px;">⚡</div>
                    </div>

                    <div class="card" style="background: #fce8e6; border: 1px solid var(--danger);">
                        <div class="stat-label" id="comp_name_card">COMPETIDOR</div>
                        <div class="stat-value" id="comp_share">0%</div>
                        <div class="text-sm">Click Share</div>
                        <div class="text-sm" style="margin-top:5px;">Precio Prom: <strong id="comp_price">€0</strong></div>
                        <div id="comp_badges" style="margin-top:5px;"></div>
                    </div>
                </div>

                <div class="chart-container" id="interactive_table" style="margin-top:20px;"></div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // 1. DATA PROCESSING ENGINE (Vanilla JS)
        // ==========================================
        
        // MOCK DATA GENERATOR (Since CSV was empty)
        // This simulates the structure of input_file_0.csv
        function generateMockData() {
            const weeks = ['2023-10-01', '2023-10-08', '2023-10-15', '2023-10-22', '2023-10-29'];
            const keywords = ['proteina whey', 'suplementos deportivos', 'batido proteinas', 'whey protein', 'recovery shake'];
            
            const data = [];
            
            // Brands definition
            const brands = [
                { name: 'YABA BRAND', is_yaba: 'Y', base_price: 29.99, strength: 1.2 },
                { name: 'Competitor Alpha', is_yaba: 'N', base_price: 34.50, strength: 1.5 }, // Market Leader
                { name: 'Beta Nutrition', is_yaba: 'N', base_price: 25.00, strength: 0.8 },  // Low cost
                { name: 'Gamma Sport', is_yaba: 'N', base_price: 32.00, strength: 1.0 },
                { name: 'Unknown Brand', is_yaba: 'N', base_price: 28.00, strength: 0.5 }
            ];

            weeks.forEach((week, wIndex) => {
                keywords.forEach(kw => {
                    const searchVol = Math.floor(Math.random() * 5000) + 1000;
                    
                    brands.forEach(brand => {
                        // Simulate dynamics
                        let price = brand.base_price + (Math.random() * 2 - 1);
                        let rank = Math.floor(Math.random() * 20) + 1;
                        let deal = 0;
                        let coupon = 0;
                        let choice = 0;
                        let bestSeller = 0;

                        // Add some logic: Lower price/Deals = Better Rank
                        if (Math.random() > 0.8) { deal = 1; price *= 0.8; }
                        if (brand.name === 'Competitor Alpha' && wIndex > 2) deal = 1; // Alpha pushes hard late
                        if (brand.is_yaba === 'Y' && wIndex === 4) { coupon = 1; price *= 0.9; } // We react in last week

                        // Calculate Click Share based on Rank + Random factor (Proxy)
                        let rawShare = (25 - rank) * brand.strength; 
                        if (deal) rawShare *= 1.3;
                        if (rawShare < 0) rawShare = 0.5;

                        data.push({
                            brand_aggregation: "Sports Nutrition",
                            parent_asin: "B000PARENT",
                            reporting_date: week, // Simplified
                            week_date: week,
                            keywords: kw,
                            competitor_brand: brand.name === 'Unknown Brand' ? null : brand.name, // Test NULL handling
                            asin: "B00" + Math.floor(Math.random() * 10000),
                            product_title: brand.name === 'Unknown Brand' ? "Generic Whey Protein 1kg" : `${brand.name} Premium Whey`,
                            weekly_search_volume: searchVol,
                            is_yaba_asin: brand.is_yaba,
                            click_share: 0, // Will normalize later
                            impression_share: 0,
                            price: parseFloat(price.toFixed(2)),
                            average_organic_rank: rank,
                            weekly_number_of_days_with_deal: deal ? 7 : 0,
                            weekly_number_of_days_with_coupon: coupon ? 7 : 0,
                            weekly_number_of_days_with_amazon_choice_badge: choice,
                            weekly_number_of_days_with_best_seller_badge: bestSeller,
                            keywords_link: "http://amazon...",
                            raw_share_score: rawShare // Temporary for calc
                        });
                    });
                });
            });

            // Normalize Click Share per Keyword/Week to sum to ~100% (simplified)
            weeks.forEach(week => {
                keywords.forEach(kw => {
                    const subset = data.filter(d => d.week_date === week && d.keywords === kw);
                    const totalScore = subset.reduce((sum, item) => sum + item.raw_share_score, 0);
                    subset.forEach(item => {
                        item.click_share = (item.raw_share_score / totalScore) * 100;
                    });
                });
            });

            return data;
        }

        const marketData = generateMockData();

        // ------------------------------------------
        // ANALYTICAL LOGIC
        // ------------------------------------------

        // 1. Identify Our Brand Correctly
        function getOurBrandName() {
            const ourAsinRow = marketData.find(d => d.is_yaba_asin === 'Y' && d.competitor_brand);
            return ourAsinRow ? ourAsinRow.competitor_brand : "Nuestra Marca (YABA)";
        }
        
        const OUR_BRAND_NAME = getOurBrandName();

        // 2. Data Cleaning & Enrichment
        const processedData = marketData.map(row => {
            // Rule 2.1: Brand Identification
            let realBrand = row.competitor_brand;
            if (!realBrand) {
                // Infer from title
                if (row.product_title) realBrand = row.product_title.split(' ')[0];
                else realBrand = "Unknown Brand";
            }

            // Calculate estimated clicks
            const estimatedClicks = (row.click_share / 100) * row.weekly_search_volume;

            return {
                ...row,
                real_brand: realBrand,
                estimated_clicks: estimatedClicks,
                is_promo: (row.weekly_number_of_days_with_deal > 0 || row.weekly_number_of_days_with_coupon > 0)
            };
        });

        // 3. Aggregations
        function getAggregatedData() {
            // Group by Week and Brand Status (Us vs Comp)
            const weeklyStats = {};
            
            processedData.forEach(row => {
                if (!weeklyStats[row.week_date]) {
                    weeklyStats[row.week_date] = { 
                        week: row.week_date, 
                        us_clicks: 0, comp_clicks: 0, 
                        us_share_sum: 0, total_share_sum: 0, count: 0 
                    };
                }
                const w = weeklyStats[row.week_date];
                
                if (row.is_yaba_asin === 'Y') {
                    w.us_clicks += row.estimated_clicks;
                    w.us_share_sum += row.click_share;
                } else {
                    w.comp_clicks += row.estimated_clicks;
                }
                w.total_share_sum += row.click_share;
                w.count++;
            });

            return Object.values(weeklyStats).sort((a,b) => a.week.localeCompare(b.week));
        }

        function getBrandCompetitiveness() {
            // Group by Brand and Week
            const brandStats = {};
            const brandTotals = {};

            processedData.forEach(row => {
                // Total Click Share avg calculation
                if (!brandTotals[row.real_brand]) brandTotals[row.real_brand] = 0;
                brandTotals[row.real_brand] += row.click_share;

                const key = `${row.real_brand}|${row.week_date}`;
                if (!brandStats[key]) {
                    brandStats[key] = { 
                        brand: row.real_brand, 
                        week: row.week_date, 
                        share: 0, 
                        count: 0,
                        is_us: row.is_yaba_asin === 'Y'
                    };
                }
                brandStats[key].share += row.click_share;
                brandStats[key].count++;
            });

            // Normalize per keyword count (simplified avg)
            const keywordCount = new Set(processedData.map(d => d.keywords)).size;
            
            // Find Top 3 Competitors (excluding Us)
            const sortedBrands = Object.entries(brandTotals)
                .filter(([brand]) => brand !== OUR_BRAND_NAME)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => entry[0]);

            return {
                brandStats: Object.values(brandStats),
                topCompetitors: sortedBrands
            };
        }

        // ==========================================
        // 2. VISUALIZATION ENGINE (Google Charts)
        // ==========================================
        
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            drawGlobalTrend();
            drawBrandCompetitiveness();
            drawLevers();
            drawEfficiency();
            populateTextInsights();
            populateInteractiveControls();
        }

        // --- CHART 1: Global Trend ---
        function drawGlobalTrend() {
            const stats = getAggregatedData();
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', 'Clicks Competencia');
            dataTable.addColumn('number', 'Clicks Nuestros');
            dataTable.addColumn('number', 'Cuota Mercado Total (%)'); // Line

            stats.forEach(s => {
                // Avg Share calculation is tricky in aggregate, using simplified proxy
                const avgShare = (s.us_share_sum / s.count) * 10; // Scaled for visibility
                dataTable.addRow([s.week.substring(5), s.comp_clicks, s.us_clicks, avgShare]);
            });

            const options = {
                title: 'Volumen de Clicks vs Share Global',
                vAxes: {0: {title: 'Volumen Clicks'}, 1: {title: 'Share Score', format: '#\'%\''}},
                hAxis: {title: 'Semana'},
                seriesType: 'bars',
                series: {2: {type: 'line', targetAxisIndex: 1, color: '#1d1d1f'}},
                colors: ['#dadce0', '#4285F4'],
                isStacked: true,
                legend: {position: 'bottom'},
                chartArea: {width: '80%', height: '70%'}
            };

            const chart = new google.visualization.ComboChart(document.getElementById('global_trend_chart'));
            chart.draw(dataTable, options);
        }

        // --- CHART 2: Competitiveness ---
        function drawBrandCompetitiveness() {
            const { brandStats, topCompetitors } = getBrandCompetitiveness();
            const weeks = [...new Set(brandStats.map(s => s.week))].sort();
            
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Semana');
            dataTable.addColumn('number', OUR_BRAND_NAME);
            topCompetitors.forEach(c => dataTable.addColumn('number', c));
            dataTable.addColumn('number', 'Resto');

            weeks.forEach(week => {
                const row = [week.substring(5)]; // X-Axis
                
                // Us
                const usStat = brandStats.find(s => s.week === week && s.brand === OUR_BRAND_NAME);
                row.push(usStat ? usStat.share / 5 : 0); // Div by 5 (keywords) for visual avg

                // Top 3
                topCompetitors.forEach(comp => {
                    const compStat = brandStats.find(s => s.week === week && s.brand === comp);
                    row.push(compStat ? compStat.share / 5 : 0);
                });

                // Rest
                const restShare = brandStats
                    .filter(s => s.week === week && s.brand !== OUR_BRAND_NAME && !topCompetitors.includes(s.brand))
                    .reduce((sum, s) => sum + s.share, 0);
                row.push(restShare / 5);

                dataTable.addRow(row);
            });

            const options = {
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'],
                vAxis: { title: 'Avg Click Share (%)' },
                chartArea: {width: '85%', height: '70%'},
                lineWidth: 3
            };

            const chart = new google.visualization.LineChart(document.getElementById('brand_share_chart'));
            chart.draw(dataTable, options);
        }

        // --- CHART 3: Efficiency (Scatter) ---
        function drawEfficiency() {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('number', 'Organic Rank (Invertido)');
            dataTable.addColumn('number', 'Click Share (%)');
            dataTable.addColumn({'type': 'string', 'role': 'style'}); // Color
            dataTable.addColumn({'type': 'string', 'role': 'tooltip'});

            // Filter last week only for relevance
            const lastWeek = "2023-10-29"; 
            processedData.filter(d => d.week_date === lastWeek).forEach(d => {
                const color = d.is_yaba_asin === 'Y' ? 'point { fill-color: #4285F4; size: 6; }' : 'point { fill-color: #dadce0; size: 3; }';
                const label = `${d.real_brand} | Rank: ${d.average_organic_rank} | Share: ${d.click_share.toFixed(1)}%`;
                // Invert Rank for visualization (Rank 1 is high)
                dataTable.addRow([d.average_organic_rank, d.click_share, color, label]);
            });

            const options = {
                title: 'Rank Orgánico vs Click Share (Última Semana)',
                hAxis: { title: 'Rank Orgánico (Menor es mejor)', direction: -1 }, // Invert axis
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
            chart.draw(dataTable, options);
        }

        // --- CHART 4: Levers (Bar Chart) ---
        function drawLevers() {
            // Calculate avg share when Deal vs No Deal
            let dealShare = 0, noDealShare = 0;
            let dealCount = 0, noDealCount = 0;

            processedData.forEach(d => {
                if (d.weekly_number_of_days_with_deal > 0) {
                    dealShare += d.click_share;
                    dealCount++;
                } else {
                    noDealShare += d.click_share;
                    noDealCount++;
                }
            });

            const avgDeal = dealCount ? dealShare/dealCount : 0;
            const avgNoDeal = noDealCount ? noDealShare/noDealCount : 0;
            const uplift = ((avgDeal - avgNoDeal) / avgNoDeal * 100).toFixed(1);

            const dataTable = google.visualization.arrayToDataTable([
                ['Estado', 'Avg Share', { role: 'style' }],
                ['Sin Deal', avgNoDeal, 'color: #dadce0'],
                ['Con Deal', avgDeal, 'color: #34A853']
            ]);

            const options = {
                legend: { position: "none" },
                vAxis: { minValue: 0 },
                chartArea: {width: '70%', height: '80%'}
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('levers_chart'));
            chart.draw(dataTable, options);

            // Update text
            document.getElementById('levers_text').innerHTML = `
                Los ASINs con Deal activo obtienen un <strong>${uplift}%</strong> más de Click Share promedio.
            `;
        }

        // ==========================================
        // 3. INSIGHTS GENERATION (Rule Based)
        // ==========================================
        function populateTextInsights() {
            // Global Insights
            const stats = getAggregatedData();
            const last = stats[stats.length - 1];
            const prev = stats[stats.length - 2];
            const growth = ((last.us_clicks - prev.us_clicks) / prev.us_clicks * 100).toFixed(1);
            
            let trendIcon = growth > 0 ? "trending_up" : "trending_down";
            let trendColor = growth > 0 ? "text-green-600" : "text-red-600";

            document.getElementById('global_insights').innerHTML = `
                <li class="insight-item">
                    <span class="material-icons insight-icon">${trendIcon}</span>
                    <div>
                        <strong>Tendencia Semanal:</strong> Nuestros clicks cambiaron un <b>${growth}%</b> respecto a la semana anterior.
                    </div>
                </li>
                <li class="insight-item">
                    <span class="material-icons insight-icon">visibility</span>
                    <div>
                        <strong>Visibilidad:</strong> Mantenemos un ${(last.us_share_sum/last.total_share_sum*100).toFixed(1)}% del total de click share en el parent.
                    </div>
                </li>
            `;

            // Brand Insights
            const { topCompetitors } = getBrandCompetitiveness();
            document.getElementById('brand_insights').innerHTML = `
                <li class="insight-item">
                    <span class="material-icons insight-icon">emoji_events</span>
                    <div>
                        <strong>Principal Rival:</strong> ${topCompetitors[0]} lidera el segmento competidor.
                    </div>
                </li>
                 <li class="insight-item">
                    <span class="material-icons insight-icon">monetization_on</span>
                    <div>
                        <strong>Efecto Precio:</strong> Se observa correlación inversa entre precio y share en ${topCompetitors[1] || 'competidores'}.
                    </div>
                </li>
            `;

            // Recommendations
            document.getElementById('key_insights_list').innerHTML = `
                <li class="insight-item"><strong>1. Dominio de Marca:</strong> Nuestra marca es fuerte pero vulnerable a promociones agresivas de ${topCompetitors[0]}.</li>
                <li class="insight-item"><strong>2. Eficiencia de Deals:</strong> Los deals generan un uplift significativo, usar estratégicamente.</li>
                <li class="insight-item"><strong>3. Elasticidad de Precio:</strong> Competidores con precio bajo ganan share rápidamente.</li>
                <li class="insight-item"><strong>4. Conversión Orgánica:</strong> Tenemos outliers con buen rank pero bajo share (revisar título/imagen).</li>
                <li class="insight-item"><strong>5. Tendencia General:</strong> El mercado muestra estacionalidad positiva esta semana.</li>
            `;

            document.getElementById('recommendations_list').innerHTML = `
                <div class="rec-box">
                    <strong>Ajuste de Precio:</strong> Considerar igualar precio con ${topCompetitors[0]} en keywords principales para recuperar share.
                </div>
                <div class="rec-box">
                    <strong>Optimización de Listing:</strong> Revisar imagen principal de ASINs con Rank < 5 pero Share < 10%.
                </div>
                <div class="rec-box">
                    <strong>Defensa con Cupones:</strong> Activar cupón del 5% en variantes clave durante la próxima semana.
                </div>
            `;
            
            document.getElementById('other_insights_text').innerText = 
                "Se detectó un nuevo competidor 'Unknown Brand' ganando tracción en keywords long-tail. Vigilar si lanzan PPC agresivo.";
        }

        // ==========================================
        // 4. INTERACTIVE LOGIC
        // ==========================================
        function populateInteractiveControls() {
            // Weeks
            const weeks = [...new Set(processedData.map(d => d.week_date))].sort();
            const weekSel = document.getElementById('week_selector');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.appendChild(opt);
            });
            weekSel.value = weeks[weeks.length - 1]; // Select last

            // Competitors
            const comps = [...new Set(processedData.map(d => d.real_brand))].filter(b => b !== OUR_BRAND_NAME).sort();
            const compSel = document.getElementById('competitor_selector');
            comps.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                compSel.appendChild(opt);
            });
            
            updateInteractive();
        }

        function updateInteractive() {
            const week = document.getElementById('week_selector').value;
            const comp = document.getElementById('competitor_selector').value;
            
            // Filter Data
            const usData = processedData.filter(d => d.week_date === week && d.real_brand === OUR_BRAND_NAME);
            const compData = processedData.filter(d => d.week_date === week && d.real_brand === comp);

            // Metrics Calculation (Avg)
            const calcMetrics = (data) => {
                if (!data.length) return { share: 0, price: 0, deal: false };
                const share = data.reduce((a,b) => a + b.click_share, 0) / data.length; // per kw avg
                const price = data.reduce((a,b) => a + b.price, 0) / data.length;
                const deal = data.some(d => d.weekly_number_of_days_with_deal > 0);
                return { share, price, deal };
            };

            const usM = calcMetrics(usData);
            const compM = calcMetrics(compData);

            // Update UI Cards
            document.getElementById('us_share').innerText = usM.share.toFixed(1) + '%';
            document.getElementById('us_price').innerText = '€' + usM.price.toFixed(2);
            document.getElementById('us_badges').innerHTML = usM.deal ? '<span class="badge badge-green">DEAL ACTIVO</span>' : '<span class="badge badge-blue">NORMAL</span>';

            document.getElementById('comp_name_card').innerText = comp.toUpperCase();
            document.getElementById('comp_share').innerText = compM.share.toFixed(1) + '%';
            document.getElementById('comp_price').innerText = '€' + compM.price.toFixed(2);
            document.getElementById('comp_badges').innerHTML = compM.deal ? '<span class="badge badge-red">DEAL ACTIVO</span>' : '<span class="badge badge-blue">NORMAL</span>';

            // Draw Table Comparison
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Keyword');
            dataTable.addColumn('number', 'Nuestro Rank');
            dataTable.addColumn('number', 'Rank Competidor');
            dataTable.addColumn('number', 'Dif. Precio');

            // Find overlapping keywords
            const kws = [...new Set([...usData.map(d=>d.keywords), ...compData.map(d=>d.keywords)])];
            
            kws.forEach(kw => {
                const u = usData.find(d => d.keywords === kw);
                const c = compData.find(d => d.keywords === kw);
                
                if (u && c) {
                    const priceDiff = u.price - c.price;
                    dataTable.addRow([
                        kw, 
                        u.average_organic_rank, 
                        c.average_organic_rank, 
                        parseFloat(priceDiff.toFixed(2))
                    ]);
                }
            });

            const table = new google.visualization.Table(document.getElementById('interactive_table'));
            table.draw(dataTable, {showRowNumber: true, width: '100%', height: '100%'});
        }

        // Utils
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'static') {
                document.getElementById('static-report').classList.remove('hidden');
                document.getElementById('interactive-report').classList.add('hidden');
            } else {
                document.getElementById('static-report').classList.add('hidden');
                document.getElementById('interactive-report').classList.remove('hidden');
                updateInteractive(); // Refresh chart
            }
        }

    </script>
</body>
</html>