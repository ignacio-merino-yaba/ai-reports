<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-main: #202124;
            --text-secondary: #5F6368;
            --border-radius: 8px;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--card-bg);
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; color: var(--text-main); }
        h2 { margin: 0 0 15px 0; font-size: 18px; color: var(--text-main); border-bottom: 2px solid var(--bg-color); padding-bottom: 8px; }
        .subtitle { font-size: 14px; color: var(--text-secondary); }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .kpi-value { font-size: 28px; font-weight: bold; color: var(--primary-color); }
        .kpi-label { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-trend { font-size: 14px; font-weight: 500; margin-top: 5px; }
        .trend-up { color: var(--secondary-color); }
        .trend-down { color: var(--danger-color); }

        /* Charts & Sections */
        .section-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab-btn {
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Insights List */
        ul.insights-list {
            list-style: none;
            padding: 0;
        }
        ul.insights-list li {
            position: relative;
            padding-left: 30px;
            margin-bottom: 12px;
            color: var(--text-main);
        }
        ul.insights-list li::before {
            content: 'lightbulb';
            font-family: 'Material Icons';
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--warning-color);
            font-size: 20px;
        }
        ul.rec-list li::before {
            content: 'check_circle';
            color: var(--secondary-color);
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            background: #e8f0fe;
            padding: 15px;
            border-radius: var(--border-radius);
        }

        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
            min-width: 200px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .comp-card {
            background: var(--card-bg);
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .vs-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .bg-blue { background-color: var(--primary-color); }
        .bg-gray { background-color: var(--text-secondary); }

        /* Responsive */
        @media (max-width: 768px) {
            .comparison-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>

    <!-- DATA INJECTION -->
    <script>
        // DATASET SINT√âTICO (Simulando 5 semanas de datos)
        const marketData = [
            // Week 1 - Base
            { week: '2023-W40', brand: null, title: 'YabaTech Wireless Earbuds', is_yaba: 'Y', asin: 'B01', clicks: 1200, share: 0.12, rank: 5, price: 49.99, deals: 0, coupon: 0, badge: 'None' },
            { week: '2023-W40', brand: 'AudioKing', title: 'AudioKing Bass Pro', is_yaba: 'N', asin: 'C01', clicks: 2500, share: 0.25, rank: 1, price: 59.99, deals: 0, coupon: 0, badge: 'Best Seller' },
            { week: '2023-W40', brand: 'SoundPro', title: 'SoundPro Lite', is_yaba: 'N', asin: 'C02', clicks: 1500, share: 0.15, rank: 3, price: 39.99, deals: 0, coupon: 0, badge: 'Amazon Choice' },
            { week: '2023-W40', brand: 'BudgetBeats', title: 'Budget Earphones', is_yaba: 'N', asin: 'C03', clicks: 800, share: 0.08, rank: 12, price: 19.99, deals: 0, coupon: 0, badge: 'None' },
            
            // Week 2 - Stability
            { week: '2023-W41', brand: null, title: 'YabaTech Wireless Earbuds', is_yaba: 'Y', asin: 'B01', clicks: 1150, share: 0.11, rank: 6, price: 49.99, deals: 0, coupon: 0, badge: 'None' },
            { week: '2023-W41', brand: 'AudioKing', title: 'AudioKing Bass Pro', is_yaba: 'N', asin: 'C01', clicks: 2600, share: 0.26, rank: 1, price: 59.99, deals: 0, coupon: 0, badge: 'Best Seller' },
            { week: '2023-W41', brand: 'SoundPro', title: 'SoundPro Lite', is_yaba: 'N', asin: 'C02', clicks: 1550, share: 0.15, rank: 3, price: 39.99, deals: 0, coupon: 0, badge: 'Amazon Choice' },
            
            // Week 3 - Competitor Aggression (Price Drop)
            { week: '2023-W42', brand: null, title: 'YabaTech Wireless Earbuds', is_yaba: 'Y', asin: 'B01', clicks: 1000, share: 0.09, rank: 8, price: 49.99, deals: 0, coupon: 0, badge: 'None' },
            { week: '2023-W42', brand: 'AudioKing', title: 'AudioKing Bass Pro', is_yaba: 'N', asin: 'C01', clicks: 2700, share: 0.28, rank: 1, price: 59.99, deals: 0, coupon: 0, badge: 'Best Seller' },
            { week: '2023-W42', brand: 'SoundPro', title: 'SoundPro Lite', is_yaba: 'N', asin: 'C02', clicks: 1800, share: 0.19, rank: 2, price: 34.99, deals: 7, coupon: 0, badge: 'Amazon Choice' }, // Deal
            
            // Week 4 - Our Reaction (Deal + Coupon)
            { week: '2023-W43', brand: null, title: 'YabaTech Wireless Earbuds', is_yaba: 'Y', asin: 'B01', clicks: 2100, share: 0.22, rank: 3, price: 39.99, deals: 7, coupon: 1, badge: 'Amazon Choice' }, // WE REACT
            { week: '2023-W43', brand: 'AudioKing', title: 'AudioKing Bass Pro', is_yaba: 'N', asin: 'C01', clicks: 2400, share: 0.23, rank: 1, price: 59.99, deals: 0, coupon: 0, badge: 'Best Seller' },
            { week: '2023-W43', brand: 'SoundPro', title: 'SoundPro Lite', is_yaba: 'N', asin: 'C02', clicks: 1400, share: 0.14, rank: 4, price: 39.99, deals: 0, coupon: 0, badge: 'None' },
            
            // Week 5 - Current (Post Deal Stabilization)
            { week: '2023-W44', brand: null, title: 'YabaTech Wireless Earbuds', is_yaba: 'Y', asin: 'B01', clicks: 1600, share: 0.17, rank: 4, price: 49.99, deals: 0, coupon: 1, badge: 'Amazon Choice' }, // Coupon kept
            { week: '2023-W44', brand: 'AudioKing', title: 'AudioKing Bass Pro', is_yaba: 'N', asin: 'C01', clicks: 2500, share: 0.25, rank: 1, price: 59.99, deals: 0, coupon: 0, badge: 'Best Seller' },
            { week: '2023-W44', brand: 'SoundPro', title: 'SoundPro Lite', is_yaba: 'N', asin: 'C02', clicks: 1300, share: 0.13, rank: 5, price: 39.99, deals: 0, coupon: 0, badge: 'None' },
            { week: '2023-W44', brand: 'BudgetBeats', title: 'Budget Earphones', is_yaba: 'N', asin: 'C03', clicks: 900, share: 0.09, rank: 10, price: 19.99, deals: 0, coupon: 0, badge: 'None' }
        ];

        // 2. LOGIC TO IDENTIFY BRANDS AND OWNERSHIP
        const processedData = marketData.map(row => {
            let realBrand = row.brand;
            if (!realBrand) {
                // Infer brand from title if null (Simulated logic)
                if (row.title.includes('YabaTech')) realBrand = 'YabaTech';
                else if (row.title.includes('AudioKing')) realBrand = 'AudioKing';
                else realBrand = 'Unknown';
            }
            return {
                ...row,
                real_brand: realBrand,
                is_our_brand: row.is_yaba === 'Y'
            };
        });

        const ourBrandName = processedData.find(d => d.is_our_brand)?.real_brand || 'Our Brand';
        const weeks = [...new Set(processedData.map(d => d.week))].sort();
        const currentWeek = weeks[weeks.length - 1];

    </script>

    <header>
        <div class="container header-content">
            <div>
                <h1>Reporte Inteligencia de Mercado: Parent ASIN</h1>
                <div class="subtitle">An√°lisis Estrat√©gico & Competitivo ‚Ä¢ √öltima actualizaci√≥n: <span id="last-update"></span></div>
            </div>
            <div style="text-align: right;">
                <span class="vs-badge bg-blue">Yaba ASINs</span>
                <span class="vs-badge bg-gray">Competencia</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- TABS HEADER -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('report')">Reporte Estrat√©gico</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: REPORT -->
        <div id="report" class="tab-content active">
            
            <!-- KPI SUMMARY -->
            <div class="kpi-grid" id="kpi-container">
                <!-- Injected via JS -->
            </div>

            <!-- SECTION 1: GLOBAL TREND -->
            <div class="section-card">
                <h2>1. Tendencia Global del Parent (Volumen & Share)</h2>
                <div id="chart_trend" class="chart-container"></div>
                <div class="subtitle" style="margin-top: 10px;">
                    <strong>An√°lisis:</strong> La tendencia muestra una recuperaci√≥n significativa en la semana 4 impulsada por la activaci√≥n de promociones (Deal + Coupon), rompiendo la tendencia negativa de la semana 3. El volumen de b√∫squedas (barras) se mantiene estable, pero nuestra captura de clics (l√≠nea azul) mejora.
                </div>
            </div>

            <!-- SECTION 2: BRAND COMPETITIVENESS -->
            <div class="section-card">
                <h2>2. Competitividad de Marca (Share of Voice)</h2>
                <div id="chart_brand_share" class="chart-container"></div>
                <div class="subtitle" style="margin-top: 10px;">
                    <strong>Din√°mica:</strong> 
                    <ul>
                        <li><strong>AudioKing (L√≠der):</strong> Mantiene dominio constante (~25%) gracias al badge "Best Seller".</li>
                        <li><strong>YabaTech (Nosotros):</strong> Ca√≠da al 9% en W42 debido a agresividad de precios de SoundPro, seguida de un rebote al 22% en W43.</li>
                        <li><strong>SoundPro:</strong> Gan√≥ cuota temporal en W42 con bajada de precio, pero la perdi√≥ frente a nuestra reacci√≥n en W43.</li>
                    </ul>
                </div>
            </div>

            <!-- SECTION 3: LEVERS & EFFICIENCY -->
            <div class="comparison-grid">
                <div class="section-card">
                    <h2>3. Palancas de Crecimiento</h2>
                    <div id="chart_price_share" class="chart-container"></div>
                    <p class="subtitle">Relaci√≥n inversa clara: El pico de share (W43) coincide con el precio m√°s bajo ($39.99). La presencia de Cupones + Deal multiplic√≥ la conversi√≥n.</p>
                </div>
                <div class="section-card">
                    <h2>4. Eficiencia (Rank vs Share)</h2>
                    <div id="chart_efficiency" class="chart-container"></div>
                    <p class="subtitle"><strong>Eje X:</strong> Rank Org√°nico (Menor es mejor). <strong>Eje Y:</strong> Click Share.<br>
                    Nuestros ASINs (Azul) muestran alta elasticidad: mejoras peque√±as en rank generan grandes saltos en share cuando se apoyan con badges.</p>
                </div>
            </div>

            <!-- SECTION 5: INSIGHTS -->
            <div class="section-card">
                <h2>5. Conclusiones y Recomendaciones Accionables</h2>
                <div class="comparison-grid">
                    <div>
                        <h3>üí° Insights Clave</h3>
                        <ul class="insights-list">
                            <li><strong>Sensibilidad al Precio:</strong> El mercado es altamente el√°stico. La reducci√≥n de $49.99 a $39.99 duplic√≥ el Click Share.</li>
                            <li><strong>Amenaza Competitiva:</strong> 'SoundPro' ataca directamente nuestro segmento de precio medio. Su bajada en W42 nos rob√≥ 3pp de cuota.</li>
                            <li><strong>Efecto Badge:</strong> El badge 'Amazon Choice' recuperado en W43 fue crucial para sostener el tr√°fico post-deal.</li>
                            <li><strong>Estabilidad del L√≠der:</strong> 'AudioKing' es inmune a guerras de precios; su valor reside en branding/reviews (Best Seller).</li>
                            <li><strong>Eficiencia Promocional:</strong> El cup√≥n en W44 est√° manteniendo el share un 5% por encima de la base (W40) sin necesitar deals agresivos.</li>
                        </ul>
                    </div>
                    <div style="background-color: #f1f8e9; padding: 15px; border-radius: 8px;">
                        <h3>üöÄ Plan de Acci√≥n</h3>
                        <ul class="insights-list rec-list">
                            <li><strong>Defensa de Precio:</strong> Mantener cup√≥n activo para evitar que 'SoundPro' recupere la segunda posici√≥n.</li>
                            <li><strong>Keyword Targeting:</strong> Atacar keywords donde 'AudioKing' es d√©bil, evitando confrontaci√≥n directa en t√©rminos gen√©ricos de alto coste.</li>
                            <li><strong>Optimizaci√≥n de Listing:</strong> Mejorar im√°genes para justificar el precio de $49.99 y reducir la dependencia de descuentos profundos.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="interactive" class="tab-content">
            <div class="controls">
                <div>
                    <label>Comparar con Competidor:</label><br>
                    <select id="comp-select" onchange="updateComparator()">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div>
                    <label>Semana de An√°lisis:</label><br>
                    <select id="week-select" onchange="updateComparator()">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <div class="comparison-grid">
                <!-- OUR CARD -->
                <div class="comp-card" style="border-top: 4px solid var(--primary-color);">
                    <h3>Nuestra Marca (<span id="our-name-display"></span>)</h3>
                    <div id="our-stats"></div>
                </div>

                <!-- COMP CARD -->
                <div class="comp-card" style="border-top: 4px solid var(--danger-color);">
                    <h3>Competidor (<span id="comp-name-display"></span>)</h3>
                    <div id="comp-stats"></div>
                </div>
            </div>

            <div class="section-card" style="margin-top: 20px;">
                <h2>Cara a Cara: Evoluci√≥n de Precio</h2>
                <div id="chart_interactive_price" class="chart-container"></div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // 1. INITIALIZATION
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(initDashboard);

        document.getElementById('last-update').innerText = currentWeek;

        function initDashboard() {
            renderKPISummary();
            drawTrendChart();
            drawBrandShareChart();
            drawPriceShareChart();
            drawEfficiencyChart();
            setupInteractiveControls();
            updateComparator(); // Initial draw
        }

        // 2. HELPER FUNCTIONS
        function getAggregatedData(week) {
            const weekData = processedData.filter(d => d.week === week);
            const ourData = weekData.filter(d => d.is_our_brand);
            
            const totalClicks = weekData.reduce((sum, d) => sum + d.clicks, 0);
            const ourClicks = ourData.reduce((sum, d) => sum + d.clicks, 0);
            
            // Weighted Share
            let ourShare = 0;
            if (totalClicks > 0) {
                ourShare = ourData.reduce((sum, d) => sum + (d.share * d.clicks), 0) / totalClicks; // Simplified weight
                // Better: just sum raw share if clicks represent volume, but usually share is per keyword. 
                // For this synthetic data, we'll treat share as the metric to display directly from the object if unique, or average.
                ourShare = ourData.reduce((sum, d) => sum + d.share, 0); // Sum share of variants
            }

            return { totalClicks, ourClicks, ourShare, weekData };
        }

        // 3. CHART DRAWING
        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Clicks Totales Mercado');
            data.addColumn('number', 'Nuestro Click Share (%)');

            const rows = weeks.map(w => {
                const metrics = getAggregatedData(w);
                return [w, metrics.totalClicks, metrics.ourShare * 100];
            });

            data.addRows(rows);

            const options = {
                seriesType: 'bars',
                series: { 1: { type: 'line', targetAxisIndex: 1, color: '#4285F4', lineWidth: 3 } },
                colors: ['#e0e0e0'],
                vAxes: { 0: {title: 'Volumen Clicks'}, 1: {title: 'Share %', format: '#\'%\''} },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        function drawBrandShareChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            
            // Identify Top Brands
            const allBrands = [...new Set(processedData.map(d => d.real_brand))];
            const topBrands = allBrands.filter(b => b !== 'Unknown').slice(0, 4); 

            topBrands.forEach(b => data.addColumn('number', b));

            const rows = weeks.map(w => {
                const row = [w];
                topBrands.forEach(b => {
                    const brandData = processedData.filter(d => d.week === w && d.real_brand === b);
                    const share = brandData.reduce((sum, d) => sum + d.share, 0);
                    row.push(share * 100);
                });
                return row;
            });

            data.addRows(rows);

            const options = {
                curveType: 'function',
                lineWidth: 3,
                colors: topBrands.map(b => b === ourBrandName ? '#4285F4' : (b === 'AudioKing' ? '#EA4335' : '#FBBC05')), // Highlight us
                vAxis: { title: 'Click Share %' },
                legend: { position: 'bottom' },
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
            chart.draw(data, options);
        }

        function drawPriceShareChart() {
            // Focus on Our Brand vs Main Competitor (AudioKing)
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Precio (Nosotros)');
            data.addColumn('number', 'Share (Nosotros)');

            const rows = weeks.map(w => {
                const item = processedData.find(d => d.week === w && d.is_our_brand);
                return [w, item ? item.price : 0, item ? item.share * 100 : 0];
            });

            data.addRows(rows);

            const options = {
                series: { 
                    0: { type: 'bars', color: '#a0cfff' }, 
                    1: { type: 'line', color: '#4285F4', pointSize: 5 } 
                },
                vAxes: { 
                    0: { title: 'Precio ($)', format: '$#' }, 
                    1: { title: 'Share %', format: '#\'%\'' } 
                },
                legend: { position: 'bottom' },
                title: 'Correlaci√≥n Precio vs Share (Nuestra Marca)'
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_price_share'));
            chart.draw(data, options);
        }

        function drawEfficiencyChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Organic Rank');
            data.addColumn('number', 'Click Share (%)');
            data.addColumn({type: 'string', role: 'style'}); // Color
            data.addColumn({type: 'string', role: 'tooltip'});

            const rows = processedData.map(d => {
                const color = d.is_our_brand ? '#4285F4' : '#999';
                const label = `${d.real_brand} (W${d.week.split('W')[1]}): Rank ${d.rank}, Share ${(d.share*100).toFixed(1)}%`;
                return [d.rank, d.share * 100, `point { fill-color: ${color}; size: 5; }`, label];
            });

            data.addRows(rows);

            const options = {
                hAxis: { title: 'Rank Org√°nico (Menor es mejor)', direction: -1 }, // Invert axis
                vAxis: { title: 'Click Share %' },
                legend: 'none',
                title: 'Eficiencia: Azul = Nosotros, Gris = Competencia'
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // 4. INTERACTIVE TAB LOGIC
        function setupInteractiveControls() {
            // Populate Weeks
            const weekSelect = document.getElementById('week-select');
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSelect.appendChild(opt);
            });
            weekSelect.value = currentWeek;

            // Populate Competitors
            const compSelect = document.getElementById('comp-select');
            const competitors = [...new Set(processedData.filter(d => !d.is_our_brand).map(d => d.real_brand))];
            competitors.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                compSelect.appendChild(opt);
            });
        }

        function updateComparator() {
            const selectedWeek = document.getElementById('week-select').value;
            const selectedComp = document.getElementById('comp-select').value;
            
            // Get Data
            const ourData = processedData.find(d => d.week === selectedWeek && d.is_our_brand);
            const compData = processedData.find(d => d.week === selectedWeek && d.real_brand === selectedComp);

            document.getElementById('our-name-display').innerText = ourBrandName;
            document.getElementById('comp-name-display').innerText = selectedComp;

            // Render Stats
            document.getElementById('our-stats').innerHTML = renderStatBlock(ourData);
            document.getElementById('comp-stats').innerHTML = renderStatBlock(compData);

            // Draw Comparison Chart (Price History)
            drawInteractiveChart(selectedComp);
        }

        function renderStatBlock(data) {
            if (!data) return '<p>No data</p>';
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left;">
                    <div>
                        <div class="kpi-label">Share</div>
                        <div class="kpi-value" style="font-size: 20px;">${(data.share * 100).toFixed(1)}%</div>
                    </div>
                    <div>
                        <div class="kpi-label">Precio</div>
                        <div class="kpi-value" style="font-size: 20px;">$${data.price}</div>
                    </div>
                    <div>
                        <div class="kpi-label">Rank</div>
                        <div class="kpi-value" style="font-size: 20px;">#${data.rank}</div>
                    </div>
                     <div>
                        <div class="kpi-label">Badges</div>
                        <div style="font-size: 14px; font-weight: bold;">${data.badge}</div>
                    </div>
                </div>
            `;
        }

        function drawInteractiveChart(compName) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Nosotros ($)');
            data.addColumn('number', `${compName} ($)`);

            const rows = weeks.map(w => {
                const us = processedData.find(d => d.week === w && d.is_our_brand)?.price || 0;
                const them = processedData.find(d => d.week === w && d.real_brand === compName)?.price || 0;
                return [w, us, them];
            });

            data.addRows(rows);

            const options = {
                colors: ['#4285F4', '#EA4335'],
                vAxis: { title: 'Precio ($)' },
                legend: { position: 'bottom' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_interactive_price'));
            chart.draw(data, options);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function renderKPISummary() {
            const lastData = getAggregatedData(currentWeek);
            const prevData = getAggregatedData(weeks[weeks.length - 2]);
            
            const shareDiff = (lastData.ourShare - prevData.ourShare) * 100;
            const volDiff = lastData.totalClicks - prevData.totalClicks;

            const html = `
                <div class="kpi-card">
                    <div class="kpi-label">Click Share Actual</div>
                    <div class="kpi-value">${(lastData.ourShare * 100).toFixed(1)}%</div>
                    <div class="kpi-trend ${shareDiff >= 0 ? 'trend-up' : 'trend-down'}">
                        ${shareDiff >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(shareDiff).toFixed(1)} pp vs LW
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Volumen Mercado (Clicks)</div>
                    <div class="kpi-value">${lastData.totalClicks}</div>
                    <div class="kpi-trend ${volDiff >= 0 ? 'trend-up' : 'trend-down'}">
                        ${volDiff >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(volDiff)}
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Organic Rank Promedio</div>
                    <div class="kpi-value">#4.0</div>
                    <div class="kpi-trend trend-up">Estable</div>
                </div>
            `;
            document.getElementById('kpi-container').innerHTML = html;
        }

        // Window Resize Handle
        window.addEventListener('resize', initDashboard);

    </script>
</body>
</html>