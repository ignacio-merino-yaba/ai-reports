<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Parent ASIN</title>
    
    <!-- Google Native Ecosystem Dependencies -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Variables & Reset */
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --danger: #EA4335;
            --warning: #FBBC05;
            --background: #F8F9FA;
            --surface: #FFFFFF;
            --text-main: #202124;
            --text-secondary: #5F6368;
            --border: #DADCE0;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 40px;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards & Sections */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-header .icon {
            color: var(--text-secondary);
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-box {
            background: #F1F3F4;
            padding: 16px;
            border-radius: 8px;
        }

        .kpi-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            margin-top: 4px;
        }

        .kpi-trend {
            font-size: 13px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* Insights List */
        .insights-list {
            list-style: none;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #F1F3F4;
            display: flex;
            gap: 12px;
        }
        
        .insights-list li:last-child {
            border-bottom: none;
        }

        .insight-icon {
            color: var(--primary);
            font-size: 20px;
        }

        .recommendation-icon {
            color: var(--secondary);
            font-size: 20px;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            color: var(--text-main);
        }

        /* Head-to-Head Table */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .h2h-card {
            text-align: center;
            padding: 32px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .h2h-card.us {
            background: #E8F0FE;
            border-color: #D2E3FC;
        }

        .h2h-card.them {
            background: #FCE8E6;
            border-color: #FAD2CF;
        }

        .h2h-metric {
            margin: 16px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 12px;
        }

        .h2h-val { font-size: 28px; font-weight: 700; }
        .h2h-lbl { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; }

        /* Badge Pills */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
        }
        .bg-blue { background: #E8F0FE; color: #1967D2; }
        .bg-green { background: #E6F4EA; color: #137333; }
        .bg-orange { background: #FEF7E0; color: #B06000; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Análisis de Parent ASIN</h1>
        <div style="font-size: 14px; color: var(--text-secondary);" id="reportDate"></div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static-tab">
        
        <!-- KPI Overview (Last Week) -->
        <div class="kpi-grid" id="kpi-container">
            <!-- Injected by JS -->
        </div>

        <!-- Section 1: Tendencia Global -->
        <div class="card">
            <div class="card-header">
                <span class="material-icons icon">trending_up</span>
                <h2>1. Tendencia Global del Parent (Volumen & Share)</h2>
            </div>
            <div id="trend_chart" class="chart-container"></div>
            <div class="insights-list" style="margin-top: 16px; padding: 0 16px;">
                <p style="font-size: 14px; color: #444;">
                    El gráfico combina el volumen total de clics (barras) con el Share de Clics (líneas).
                    La barra azul representa nuestros clics, la gris la competencia. La línea roja muestra nuestra cuota de mercado.
                </p>
            </div>
        </div>

        <!-- Section 2: Competitividad -->
        <div class="card">
            <div class="card-header">
                <span class="material-icons icon">pie_chart</span>
                <h2>2. Competitividad de Marca (Share Semanal)</h2>
            </div>
            <div id="competitiveness_chart" class="chart-container"></div>
        </div>

        <!-- Section 3 & 4 Grid -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">
            <!-- Palancas -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons icon">tune</span>
                    <h2>3. Palancas de Crecimiento</h2>
                </div>
                <div id="levers_chart" class="chart-container"></div>
                <p style="font-size:13px; color: var(--text-secondary); margin-top:10px;">
                    Comparación de precio promedio vs Click Share. Burbujas grandes indican presencia de Deals/Cupones.
                </p>
            </div>

            <!-- Efficiency -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons icon">scatter_plot</span>
                    <h2>4. Eficiencia (Rank vs Click Share)</h2>
                </div>
                <div id="efficiency_chart" class="chart-container"></div>
                <p style="font-size:13px; color: var(--text-secondary); margin-top:10px;">
                    <strong>Eje X:</strong> Rank Orgánico (Invertido, 1 es mejor). <strong>Eje Y:</strong> Click Share.
                    Puntos sobre la tendencia central son "Overperformers".
                </p>
            </div>
        </div>

        <!-- Section 5: Insights & Recommendations -->
        <div class="card">
            <div class="card-header">
                <span class="material-icons icon">lightbulb</span>
                <h2>5. Conclusiones y Acciones</h2>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--text-secondary);">Insights Clave</h3>
                    <ul class="insights-list" id="insights-list">
                        <!-- JS Injected -->
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--text-secondary);">Recomendaciones</h3>
                    <ul class="insights-list" id="recommendations-list">
                        <!-- JS Injected -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="interactive-tab" style="display: none;">
        <div class="controls">
            <div>
                <label style="display:block; font-size: 12px; margin-bottom:4px;">Seleccionar Semana</label>
                <select id="weekSelector" onchange="updateComparator()"></select>
            </div>
            <div>
                <label style="display:block; font-size: 12px; margin-bottom:4px;">Seleccionar Competidor</label>
                <select id="compSelector" onchange="updateComparator()"></select>
            </div>
        </div>

        <div class="comparison-grid">
            <!-- OUR ASIN -->
            <div class="h2h-card us">
                <h3 style="color: var(--primary);">Nuestra Marca</h3>
                <h4 id="ourBrandName" style="margin-bottom: 20px;">-</h4>
                
                <div class="h2h-metric">
                    <div class="h2h-val" id="us-share">0%</div>
                    <div class="h2h-lbl">Click Share</div>
                </div>
                <div class="h2h-metric">
                    <div class="h2h-val" id="us-price">$0</div>
                    <div class="h2h-lbl">Precio Promedio</div>
                </div>
                <div class="h2h-metric">
                    <div class="h2h-val" id="us-rank">0</div>
                    <div class="h2h-lbl">Rank Orgánico</div>
                </div>
                <div id="us-badges" style="margin-top: 16px;"></div>
            </div>

            <!-- COMPETITOR -->
            <div class="h2h-card them">
                <h3 style="color: var(--danger);">Competencia</h3>
                <h4 id="compBrandName" style="margin-bottom: 20px;">-</h4>
                
                <div class="h2h-metric">
                    <div class="h2h-val" id="them-share">0%</div>
                    <div class="h2h-lbl">Click Share</div>
                </div>
                <div class="h2h-metric">
                    <div class="h2h-val" id="them-price">$0</div>
                    <div class="h2h-lbl">Precio Promedio</div>
                </div>
                <div class="h2h-metric">
                    <div class="h2h-val" id="them-rank">0</div>
                    <div class="h2h-lbl">Rank Orgánico</div>
                </div>
                <div id="them-badges" style="margin-top: 16px;"></div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 24px;">
            <div class="card-header">
                <span class="material-icons icon">table_chart</span>
                <h2>Detalle ASIN por ASIN (Semana Seleccionada)</h2>
            </div>
            <div id="detail_table_div"></div>
        </div>
    </div>
</div>

<script>
    // ------------------------------------------------------------------
    // 1. DATA INJECTION
    // ------------------------------------------------------------------
    const marketData = [{"parent_asin":"B00PARENT01","week_date":"2023-10-02","asin":"B00YABA000","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 0","is_yaba_asin":"Y","clicks":100,"click_share":5.35,"organic_rank":9,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-02","asin":"B00YABA001","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 1","is_yaba_asin":"Y","clicks":173,"click_share":11.58,"organic_rank":1,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-02","asin":"B00COMP000","competitor_brand":"Comp A","product_title":"Comp A Standard Widget","is_yaba_asin":"N","clicks":314,"click_share":17.38,"organic_rank":27,"price":24.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-02","asin":"B00COMP001","competitor_brand":"Comp B","product_title":"Comp B Standard Widget","is_yaba_asin":"N","clicks":343,"click_share":17.06,"organic_rank":28,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-02","asin":"B00COMP002","competitor_brand":"Comp C","product_title":"Comp C Standard Widget","is_yaba_asin":"N","clicks":132,"click_share":3.89,"organic_rank":28,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-02","asin":"B00COMP003","competitor_brand":"SmallPlayer","product_title":"SmallPlayer Standard Widget","is_yaba_asin":"N","clicks":207,"click_share":14.07,"organic_rank":11,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-09","asin":"B00YABA000","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 0","is_yaba_asin":"Y","clicks":175,"click_share":13.04,"organic_rank":8,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-09","asin":"B00YABA001","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 1","is_yaba_asin":"Y","clicks":148,"click_share":10.63,"organic_rank":5,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":7,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-09","asin":"B00COMP000","competitor_brand":"Comp A","product_title":"Comp A Standard Widget","is_yaba_asin":"N","clicks":282,"click_share":10.97,"organic_rank":16,"price":24.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-09","asin":"B00COMP001","competitor_brand":"Comp B","product_title":"Comp B Standard Widget","is_yaba_asin":"N","clicks":285,"click_share":19.49,"organic_rank":6,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-09","asin":"B00COMP002","competitor_brand":"Comp C","product_title":"Comp C Standard Widget","is_yaba_asin":"N","clicks":168,"click_share":14.07,"organic_rank":13,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-09","asin":"B00COMP003","competitor_brand":"SmallPlayer","product_title":"SmallPlayer Standard Widget","is_yaba_asin":"N","clicks":380,"click_share":10.74,"organic_rank":28,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-16","asin":"B00YABA000","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 0","is_yaba_asin":"Y","clicks":157,"click_share":12.72,"organic_rank":1,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-16","asin":"B00YABA001","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 1","is_yaba_asin":"Y","clicks":207,"click_share":8.83,"organic_rank":4,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-16","asin":"B00COMP000","competitor_brand":"Comp A","product_title":"Comp A Standard Widget","is_yaba_asin":"N","clicks":204,"click_share":9.45,"organic_rank":20,"price":24.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-16","asin":"B00COMP001","competitor_brand":"Comp B","product_title":"Comp B Standard Widget","is_yaba_asin":"N","clicks":334,"click_share":14.47,"organic_rank":28,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-16","asin":"B00COMP002","competitor_brand":"Comp C","product_title":"Comp C Standard Widget","is_yaba_asin":"N","clicks":344,"click_share":19.42,"organic_rank":18,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-16","asin":"B00COMP003","competitor_brand":"SmallPlayer","product_title":"SmallPlayer Standard Widget","is_yaba_asin":"N","clicks":168,"click_share":18.96,"organic_rank":16,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-23","asin":"B00YABA000","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 0","is_yaba_asin":"Y","clicks":380,"click_share":7.2,"organic_rank":7,"price":29.99,"weekly_number_of_days_with_deal":5,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-23","asin":"B00YABA001","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 1","is_yaba_asin":"Y","clicks":206,"click_share":12.87,"organic_rank":7,"price":29.99,"weekly_number_of_days_with_deal":5,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-23","asin":"B00COMP000","competitor_brand":"Comp A","product_title":"Comp A Standard Widget","is_yaba_asin":"N","clicks":383,"click_share":15.06,"organic_rank":17,"price":24.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-23","asin":"B00COMP001","competitor_brand":"Comp B","product_title":"Comp B Standard Widget","is_yaba_asin":"N","clicks":225,"click_share":9.33,"organic_rank":30,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-23","asin":"B00COMP002","competitor_brand":"Comp C","product_title":"Comp C Standard Widget","is_yaba_asin":"N","clicks":344,"click_share":12.03,"organic_rank":4,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-23","asin":"B00COMP003","competitor_brand":"SmallPlayer","product_title":"SmallPlayer Standard Widget","is_yaba_asin":"N","clicks":297,"click_share":9.97,"organic_rank":9,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-30","asin":"B00YABA000","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 0","is_yaba_asin":"Y","clicks":272,"click_share":10.6,"organic_rank":2,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-30","asin":"B00YABA001","competitor_brand":"YabaBrand","product_title":"Yaba Premium Product Variant 1","is_yaba_asin":"Y","clicks":331,"click_share":14.49,"organic_rank":1,"price":29.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":7,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":500,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-30","asin":"B00COMP000","competitor_brand":"Comp A","product_title":"Comp A Standard Widget","is_yaba_asin":"N","clicks":213,"click_share":8.83,"organic_rank":2,"price":24.99,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":7,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-30","asin":"B00COMP001","competitor_brand":"Comp B","product_title":"Comp B Standard Widget","is_yaba_asin":"N","clicks":262,"click_share":18.91,"organic_rank":24,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-30","asin":"B00COMP002","competitor_brand":"Comp C","product_title":"Comp C Standard Widget","is_yaba_asin":"N","clicks":256,"click_share":14.61,"organic_rank":20,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"},{"parent_asin":"B00PARENT01","week_date":"2023-10-30","asin":"B00COMP003","competitor_brand":"SmallPlayer","product_title":"SmallPlayer Standard Widget","is_yaba_asin":"N","clicks":279,"click_share":14.07,"organic_rank":27,"price":35.0,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_number_of_days_with_coupon":0,"grams":450,"organic_or_not":"Organic"}];

    // ------------------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // ------------------------------------------------------------------

    // 2.1 Brand Identification Logic (Rule 2.1, 2.2)
    function identifyBrand(item) {
        if (item.competitor_brand) return item.competitor_brand;
        // Fallback logic
        if (item.product_title) {
            const firstWord = item.product_title.split(' ')[0];
            return firstWord.length > 2 ? firstWord : "Unknown";
        }
        return "Unknown Brand";
    }

    // Identify OUR brand (Rule 2.2)
    const ourAsinExample = marketData.find(d => d.is_yaba_asin === 'Y');
    const OUR_BRAND = ourAsinExample ? identifyBrand(ourAsinExample) : "YabaBrand";
    
    // Normalize data brands
    const cleanedData = marketData.map(d => ({
        ...d,
        brand: identifyBrand(d)
    }));

    // Get Unique Weeks (Sorted)
    const weeks = [...new Set(cleanedData.map(d => d.week_date))].sort();
    const lastWeek = weeks[weeks.length - 1];

    // 2.2 Aggregation Helper
    function aggregateByWeekAndType() {
        return weeks.map(week => {
            const weekData = cleanedData.filter(d => d.week_date === week);
            const us = weekData.filter(d => d.is_yaba_asin === 'Y');
            const them = weekData.filter(d => d.is_yaba_asin === 'N');

            const sumClicks = (arr) => arr.reduce((acc, curr) => acc + (curr.clicks || 0), 0);
            const avgShare = (arr) => {
                const total = arr.reduce((acc, curr) => acc + (curr.click_share || 0), 0);
                return arr.length ? total : 0; // Keeping it as sum of share for visibility
            };

            return {
                week,
                usClicks: sumClicks(us),
                themClicks: sumClicks(them),
                usShare: avgShare(us),
                themShare: avgShare(them)
            };
        });
    }

    // ------------------------------------------------------------------
    // 3. GOOGLE CHARTS SETUP
    // ------------------------------------------------------------------
    google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
        drawTrendChart();
        drawCompetitivenessChart();
        drawLeversChart();
        drawEfficiencyChart();
        renderKPIs();
        generateInsights();
        setupInteractiveControls();
    }

    // CHART 1: TREND (Combo Chart)
    function drawTrendChart() {
        const trendData = aggregateByWeekAndType();
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Semana');
        dataTable.addColumn('number', 'Nuestros Clics');
        dataTable.addColumn('number', 'Clics Competencia');
        dataTable.addColumn('number', 'Nuestra Cuota (%)');

        trendData.forEach(d => {
            dataTable.addRow([d.week.substring(5), d.usClicks, d.themClicks, d.usShare]);
        });

        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1, color: '#EA4335', lineWidth: 3 } },
            colors: ['#4285F4', '#DADCE0'],
            vAxes: {
                0: { title: 'Volumen Clics' },
                1: { title: 'Click Share %', format: '#\'%\'' }
            },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
        chart.draw(dataTable, options);
    }

    // CHART 2: COMPETITIVENESS (Line Chart)
    function drawCompetitivenessChart() {
        // Find Top 3 Competitors by Avg Share
        const compMap = {};
        cleanedData.filter(d => d.brand !== OUR_BRAND).forEach(d => {
            if(!compMap[d.brand]) compMap[d.brand] = [];
            compMap[d.brand].push(d.click_share);
        });

        const sortedComps = Object.keys(compMap).sort((a, b) => {
            const avgA = compMap[a].reduce((s,v)=>s+v,0) / compMap[a].length;
            const avgB = compMap[b].reduce((s,v)=>s+v,0) / compMap[b].length;
            return avgB - avgA;
        }).slice(0, 3); // Top 3

        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Semana');
        dataTable.addColumn('number', OUR_BRAND);
        sortedComps.forEach(c => dataTable.addColumn('number', c));
        dataTable.addColumn('number', 'Otros');

        weeks.forEach(week => {
            const weekData = cleanedData.filter(d => d.week_date === week);
            const getShare = (brand) => {
                // Sum share of all ASINs of that brand
                return weekData.filter(d => d.brand === brand)
                    .reduce((acc, curr) => acc + curr.click_share, 0);
            };

            const row = [week.substring(5)];
            row.push(getShare(OUR_BRAND)); // Our Brand
            
            let othersShare = 0;
            const allBrands = [...new Set(weekData.map(d => d.brand))];
            
            allBrands.forEach(b => {
                if (b === OUR_BRAND) return;
                if (sortedComps.includes(b)) {
                    // It's a top competitor, added later in loop
                } else {
                    othersShare += getShare(b);
                }
            });

            sortedComps.forEach(c => row.push(getShare(c)));
            row.push(othersShare);
            dataTable.addRow(row);
        });

        const options = {
            curveType: 'function',
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9AA0A6'],
            lineWidth: 3,
            legend: { position: 'bottom' },
            chartArea: { width: '90%', height: '75%' },
            vAxis: { format: '#\'%\'' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('competitiveness_chart'));
        chart.draw(dataTable, options);
    }

    // CHART 3: LEVERS (Bubble Chart) - Simplified as Scatter for Google Charts compatibility
    function drawLeversChart() {
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'ID');
        dataTable.addColumn('number', 'Precio ($)');
        dataTable.addColumn('number', 'Click Share (%)');
        dataTable.addColumn('string', 'Marca');
        dataTable.addColumn('number', 'Promo Size'); // For bubble size

        const lastWeekData = cleanedData.filter(d => d.week_date === lastWeek);
        
        lastWeekData.forEach(d => {
            const hasDeal = d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0;
            const size = hasDeal ? 2 : 1;
            dataTable.addRow([
                d.brand,
                d.price,
                d.click_share,
                d.brand === OUR_BRAND ? 'Nosotros' : 'Competencia',
                size
            ]);
        });

        const options = {
            hAxis: { title: 'Precio ($)' },
            vAxis: { title: 'Click Share (%)' },
            bubble: { textStyle: { fontSize: 11 } },
            colors: ['#EA4335', '#4285F4'], // Competencia Red, Us Blue
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.BubbleChart(document.getElementById('levers_chart'));
        chart.draw(dataTable, options);
    }

    // CHART 4: EFFICIENCY (Scatter)
    function drawEfficiencyChart() {
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('number', 'Rank Orgánico');
        dataTable.addColumn('number', 'Click Share');
        dataTable.addColumn({type: 'string', role: 'style'});
        dataTable.addColumn({type: 'string', role: 'tooltip'});

        const weekData = cleanedData.filter(d => d.week_date === lastWeek);

        weekData.forEach(d => {
            const color = d.is_yaba_asin === 'Y' ? '#4285F4' : '#9AA0A6';
            dataTable.addRow([
                d.organic_rank,
                d.click_share,
                `point { fill-color: ${color}; size: 6; }`,
                `${d.brand} | Rank: ${d.organic_rank} | Share: ${d.click_share}%`
            ]);
        });

        const options = {
            hAxis: { title: 'Organic Rank (Invertido)', direction: -1 }, // Rank 1 is right
            vAxis: { title: 'Click Share (%)' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
        chart.draw(dataTable, options);
    }

    // 4. KPI RENDERING & INSIGHTS
    function renderKPIs() {
        const currentData = aggregateByWeekAndType().find(w => w.week === lastWeek);
        const prevData = aggregateByWeekAndType().find(w => w.week === weeks[weeks.length - 2]);

        const kpis = [
            { label: 'Share Total (Nosotros)', val: currentData.usShare.toFixed(1) + '%', prev: prevData.usShare },
            { label: 'Clics Totales (Nosotros)', val: currentData.usClicks, prev: prevData.usClicks },
            { label: 'Presión Competitiva (Clics)', val: currentData.themClicks, prev: prevData.themClicks }
        ];

        const container = document.getElementById('kpi-container');
        container.innerHTML = kpis.map(k => {
            const diff = k.val.toString().replace('%','') - k.prev;
            const trendClass = diff >= 0 ? 'trend-up' : 'trend-down';
            const icon = diff >= 0 ? 'trending_up' : 'trending_down';
            return `
                <div class="kpi-box">
                    <div class="kpi-label">${k.label}</div>
                    <div class="kpi-value">${k.val}</div>
                    <div class="kpi-trend ${trendClass}">
                        <span class="material-icons" style="font-size:16px;">${icon}</span>
                        ${Math.abs(diff).toFixed(1)} vs semana ant.
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('reportDate').innerText = `Reporte generado al cierre de: ${lastWeek}`;
    }

    function generateInsights() {
        const current = aggregateByWeekAndType().find(w => w.week === lastWeek);
        const prev = aggregateByWeekAndType().find(w => w.week === weeks[weeks.length - 2]);
        const list = document.getElementById('insights-list');
        const recList = document.getElementById('recommendations-list');
        
        let insights = [];
        let recs = [];

        // Logic for Insights
        if (current.usShare > prev.usShare) {
            insights.push("Tendencia positiva: Nuestra cuota de clics ha crecido esta semana.");
        } else {
            insights.push("Alerta: Perdida de tracción en cuota de clics respecto a la semana anterior.");
            recs.push("Revisar agresividad de competidores en precio o puja.");
        }

        const dealImpact = cleanedData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y' && d.weekly_number_of_days_with_deal > 0);
        if (dealImpact.length > 0) {
            insights.push("Las promociones activas (Deals) han tenido presencia esta semana.");
        } else {
            insights.push("Sin actividad promocional agresiva (Deals) en nuestros ASINs esta semana.");
        }

        // Efficiency insight
        const myEff = cleanedData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'Y');
        const goodRankLowShare = myEff.some(d => d.organic_rank <= 5 && d.click_share < 5);
        if (goodRankLowShare) {
            insights.push("Eficiencia Baja: ASINs con buen ranking orgánico pero bajo Click Share (revisar Imagen/Título).");
            recs.push("Optimizar imagen principal y título para mejorar CTR en posiciones top.");
        } else {
            insights.push("Eficiencia Saludable: El ranking orgánico correlaciona bien con la captura de clics.");
        }

        // Competitor Insight
        const topComp = cleanedData.filter(d => d.week_date === lastWeek && d.is_yaba_asin === 'N')
                                   .sort((a,b) => b.click_share - a.click_share)[0];
        if (topComp) {
            insights.push(`Competidor dominante: ${topComp.brand} lidera con un ${topComp.click_share}% de share.`);
        }

        // Recommendations
        recs.push("Analizar brecha de precio con el competidor Top 1.");
        recs.push("Evaluar activación de cupón para recuperar share perdido en ASINs 'Underperformers'.");

        // Render
        list.innerHTML = insights.map(i => `<li><span class="material-icons insight-icon">chevron_right</span>${i}</li>`).join('');
        recList.innerHTML = recs.map(r => `<li><span class="material-icons recommendation-icon">task_alt</span>${r}</li>`).join('');
    }

    // ------------------------------------------------------------------
    // 5. INTERACTIVE TAB LOGIC
    // ------------------------------------------------------------------
    function setupInteractiveControls() {
        const weekSel = document.getElementById('weekSelector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            if(w === lastWeek) opt.selected = true;
            weekSel.appendChild(opt);
        });

        const compSel = document.getElementById('compSelector');
        const competitors = [...new Set(cleanedData.filter(d => d.is_yaba_asin === 'N').map(d => d.brand))];
        competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            compSel.appendChild(opt);
        });
        
        updateComparator();
    }

    function updateComparator() {
        const week = document.getElementById('weekSelector').value;
        const comp = document.getElementById('compSelector').value;

        // Filter Data
        const usData = cleanedData.filter(d => d.week_date === week && d.is_yaba_asin === 'Y');
        const themData = cleanedData.filter(d => d.week_date === week && d.brand === comp);

        // Aggregates
        const avg = (arr, key) => {
            if (!arr.length) return 0;
            return (arr.reduce((acc, curr) => acc + curr[key], 0) / arr.length).toFixed(1);
        };
        const sumShare = (arr) => arr.reduce((a,c) => a+c.click_share, 0).toFixed(1);

        // Update DOM - US
        document.getElementById('ourBrandName').innerText = OUR_BRAND;
        document.getElementById('us-share').innerText = sumShare(usData) + '%';
        document.getElementById('us-price').innerText = '$' + avg(usData, 'price');
        document.getElementById('us-rank').innerText = Math.round(avg(usData, 'organic_rank'));
        
        // Badges US
        let usBadges = '';
        if (usData.some(d => d.weekly_number_of_days_with_best_seller_badge > 0)) usBadges += '<span class="badge bg-orange">BestSeller</span>';
        if (usData.some(d => d.weekly_number_of_days_with_amazon_choice_badge > 0)) usBadges += '<span class="badge bg-blue">AmzChoice</span>';
        if (usData.some(d => d.weekly_number_of_days_with_deal > 0)) usBadges += '<span class="badge bg-green">Deal</span>';
        document.getElementById('us-badges').innerHTML = usBadges || '<span style="font-size:12px; color:#999">Sin Badges</span>';

        // Update DOM - THEM
        document.getElementById('compBrandName').innerText = comp;
        document.getElementById('them-share').innerText = sumShare(themData) + '%';
        document.getElementById('them-price').innerText = '$' + avg(themData, 'price');
        document.getElementById('them-rank').innerText = Math.round(avg(themData, 'organic_rank'));

        // Badges THEM
        let themBadges = '';
        if (themData.some(d => d.weekly_number_of_days_with_best_seller_badge > 0)) themBadges += '<span class="badge bg-orange">BestSeller</span>';
        if (themData.some(d => d.weekly_number_of_days_with_amazon_choice_badge > 0)) themBadges += '<span class="badge bg-blue">AmzChoice</span>';
        if (themData.some(d => d.weekly_number_of_days_with_deal > 0)) themBadges += '<span class="badge bg-green">Deal</span>';
        document.getElementById('them-badges').innerHTML = themBadges || '<span style="font-size:12px; color:#999">Sin Badges</span>';

        // Draw Table
        drawDetailTable(usData, themData);
    }

    function drawDetailTable(us, them) {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'ASIN');
        data.addColumn('string', 'Título');
        data.addColumn('string', 'Marca');
        data.addColumn('number', 'Precio');
        data.addColumn('number', 'Rank');
        data.addColumn('number', 'Share %');

        [...us, ...them].forEach(d => {
            data.addRow([
                d.asin, 
                d.product_title.substring(0, 30) + '...', 
                d.brand, 
                d.price, 
                d.organic_rank, 
                d.click_share
            ]);
        });

        const table = new google.visualization.Table(document.getElementById('detail_table_div'));
        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
    }

    // UI Utilities
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if (tabName === 'static') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('static-tab').style.display = 'block';
            document.getElementById('interactive-tab').style.display = 'none';
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('static-tab').style.display = 'none';
            document.getElementById('interactive-tab').style.display = 'block';
            // Force redraw of hidden charts/tables if needed
            updateComparator();
        }
    }

</script>

</body>
</html>