<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Market Intelligence: Parent ASIN Report</title>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --gray-light: #f8f9fa;
            --gray-border: #dadce0;
            --text-dark: #202124;
            --text-muted: #5f6368;
            --card-radius: 16px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--gray-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: var(--text-dark);
        }

        h2 {
            font-size: 18px;
            font-weight: 500;
            margin-top: 0;
            margin-bottom: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-border);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Grid System */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .col-12 { grid-column: span 12; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        .col-3 { grid-column: span 3; }

        @media (max-width: 768px) {
            .col-6, .col-4, .col-3 { grid-column: span 12; }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--card-radius);
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.02);
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        /* Metrics */
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trend-up { color: var(--secondary); font-size: 14px; font-weight: 600; }
        .trend-down { color: var(--danger); font-size: 14px; font-weight: 600; }
        .trend-neutral { color: var(--text-muted); font-size: 14px; }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 350px;
            position: relative;
        }
        
        .mini-chart {
            height: 200px;
        }

        /* Insights Box */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
            font-size: 14px;
        }

        .insight-item::before {
            content: "•";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 8px;
            font-size: 18px;
            line-height: 1;
        }

        .recommendation-item::before {
            color: var(--secondary);
        }

        /* Controls */
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--gray-border);
            font-family: inherit;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
        }
        .badge-our { background-color: #e8f0fe; color: var(--primary); }
        .badge-comp { background-color: #fce8e6; color: var(--danger); }

        /* Helpers */
        .flex-row { display: flex; align-items: center; justify-content: space-between; }
        .mt-4 { margin-top: 16px; }
        .text-center { text-align: center; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="flex-row">
            <div>
                <h1>Parent ASIN Performance Report</h1>
                <div class="subtitle" id="reportPeriod">Loading date range...</div>
            </div>
            <div id="ourBrandDisplay" class="badge badge-our" style="font-size: 14px; padding: 8px 16px;">Identifying Brand...</div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Strategic Analysis</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Competitor Battleground</button>
    </div>

    <!-- TAB 1: STATIC ANALYSIS -->
    <div id="static" class="tab-content active">
        
        <!-- Section 1: Global Trend -->
        <div class="grid">
            <div class="col-12 card">
                <h2><span class="material-icons">trending_up</span> 1. Global Trend & Click Share Evolution</h2>
                <div class="chart-container" id="trendChart"></div>
                <div class="insight-list mt-4" id="trendInsights"></div>
            </div>
        </div>

        <!-- Section 2: Brand Competitiveness -->
        <div class="grid">
            <div class="col-8 card">
                <h2><span class="material-icons">pie_chart</span> 2. Brand Competitiveness (Share of Voice)</h2>
                <div class="chart-container" id="brandChart"></div>
            </div>
            <div class="col-4 card">
                <h2>Top Competitors</h2>
                <div id="topCompetitorsList"></div>
            </div>
        </div>

        <!-- Section 3: Palancas (Levers) -->
        <div class="grid">
            <div class="col-6 card">
                <h2><span class="material-icons">rocket_launch</span> 3. Impact of Levers (Badges)</h2>
                <div class="chart-container mini-chart" id="leversChart"></div>
                <p class="subtitle mt-4">Average Click Share when badges are active vs inactive.</p>
            </div>
            <div class="col-6 card">
                <h2><span class="material-icons">euro</span> Price Strategy</h2>
                <div class="chart-container mini-chart" id="priceChart"></div>
                <p class="subtitle mt-4">Price positioning relative to Click Share leaders.</p>
            </div>
        </div>

        <!-- Section 4: Efficiency -->
        <div class="grid">
            <div class="col-12 card">
                <h2><span class="material-icons">scatter_plot</span> 4. Efficiency: Organic Rank vs Click Share</h2>
                <div class="chart-container" id="efficiencyChart"></div>
                <div class="flex-row" style="justify-content: center; gap: 20px; margin-top: 10px; font-size: 12px; color: var(--text-muted);">
                    <span>Top Left: High Efficiency (Poor Rank, High Clicks)</span>
                    <span>Bottom Right: Low Efficiency (Good Rank, Low Clicks)</span>
                </div>
            </div>
        </div>

        <!-- Section 5: Conclusions -->
        <div class="grid">
            <div class="col-6 card" style="border-left: 4px solid var(--primary);">
                <h2><span class="material-icons">lightbulb</span> 5.1 Key Insights</h2>
                <ul class="insight-list" id="finalInsights"></ul>
            </div>
            <div class="col-6 card" style="border-left: 4px solid var(--secondary);">
                <h2><span class="material-icons">check_circle</span> 5.2 Recommendations</h2>
                <ul class="insight-list" id="finalRecommendations"></ul>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARISON -->
    <div id="interactive" class="tab-content">
        <div class="card mb-4" style="margin-bottom: 20px;">
            <div class="flex-row" style="justify-content: flex-start; gap: 20px;">
                <div>
                    <label class="metric-label" style="display:block; margin-bottom:5px;">Select Week</label>
                    <select id="weekSelector" onchange="updateInteractive()"></select>
                </div>
                <div>
                    <label class="metric-label" style="display:block; margin-bottom:5px;">Select Competitor</label>
                    <select id="compSelector" onchange="updateInteractive()"></select>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Head to Head Metrics -->
            <div class="col-6 card">
                <h3 id="ourBrandTitle" style="color: var(--primary);">Us</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
                    <div>
                        <div class="metric-label">Click Share</div>
                        <div class="metric-value" id="h2h_us_share">-</div>
                    </div>
                    <div>
                        <div class="metric-label">Price</div>
                        <div class="metric-value" id="h2h_us_price">-</div>
                    </div>
                    <div>
                        <div class="metric-label">Org Rank</div>
                        <div class="metric-value" id="h2h_us_rank">-</div>
                    </div>
                    <div>
                        <div class="metric-label">Active Badges</div>
                        <div style="font-size:12px; margin-top:5px;" id="h2h_us_badges">-</div>
                    </div>
                </div>
            </div>

            <div class="col-6 card">
                <h3 id="compBrandTitle" style="color: var(--danger);">Competitor</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
                    <div>
                        <div class="metric-label">Click Share</div>
                        <div class="metric-value" id="h2h_them_share">-</div>
                    </div>
                    <div>
                        <div class="metric-label">Price</div>
                        <div class="metric-value" id="h2h_them_price">-</div>
                    </div>
                    <div>
                        <div class="metric-label">Org Rank</div>
                        <div class="metric-value" id="h2h_them_rank">-</div>
                    </div>
                    <div>
                        <div class="metric-label">Active Badges</div>
                        <div style="font-size:12px; margin-top:5px;" id="h2h_them_badges">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 card" style="margin-top: 20px;">
             <h2>Direct Keyword Comparison</h2>
             <div id="keywordTable" style="width: 100%; overflow-x: auto;"></div>
        </div>
    </div>

</div>

<script>
    // --- 1. DATA INJECTION ---
    const marketData = [{"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": null, "asin": "B01M6BB18S", "product_title": "Alnatura Bio Kakao schwach ent\u00f6lt, 125g", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 5, "weekly_number_of_days_with_coupon": 0, "click_share": 7.64, "impression_share": 2.83, "price": 4.907142857, "click_share_rank": 2, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": null, "asin": "B0BG2ZNJLT", "product_title": "Cortegas Cacao Puro - 100% Kakaopulver f\u00fcr hochwer...", "country_code": "de", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.97, "impression_share": 2.56, "price": 9.937142857, "click_share_rank": 7, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": null, "asin": "B000W45AZY", "product_title": "Caotina Dark dunkle Trinkschokolade - Kakao-Pulver...", "country_code": "de", "average_organic_rank": 12, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 2.93, "impression_share": 2.31, "price": 9.722857143, "click_share_rank": 10, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "KABA", "asin": "B0D5QZYXPW", "product_title": "Kaba Choco 400g Beutel Trinkpulver, das Original K...", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 5, "weekly_number_of_days_with_coupon": 0, "click_share": 8.71, "impression_share": 2.87, "price": 2.765714286, "click_share_rank": 1, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "NaturaleBio", "asin": "B07DFPSNGJ", "product_title": "NaturaleBio Kakao Pulver Bio 1kg. Organic Cacao Po...", "country_code": "de", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.82, "impression_share": 2.81, "price": 32.77285714, "click_share_rank": 5, "weekly_search_volume": 5542.21, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "Nesquik", "asin": "B0CX24HT4W", "product_title": "Nestl\u00e9 Nesquik Original kakaohaltiges Getr\u00e4nkepulv...", "country_code": "de", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.56, "impression_share": 2.83, "price": 5.911428571, "click_share_rank": 8, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "SUCHARD EXPRESS", "asin": "B0D5R1W596", "product_title": "Suchard Express 400g Beutel, Getr\u00e4nkepulver f\u00fcr he...", "country_code": "de", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.06, "impression_share": 2.81, "price": 3.268571429, "click_share_rank": 3, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "Sevenhills Wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.76, "impression_share": 2.81, "price": 30.72428571, "click_share_rank": 6, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "sevenhills wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.76, "impression_share": 2.81, "price": 30.72428571, "click_share_rank": 6, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768LH1CP", "product_title": "Kakao Pulver Bio 500g | Kakao-Pulver mit feinstem ...", "country_code": "de", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.85, "impression_share": 3.45, "price": 22.42571429, "click_share_rank": 4, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2025-12-27", "week_date": "2025-52", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768L7FV1", "product_title": "Kakao Pulver Bio 1000g | Kakao-Pulver mit feinstem...", "country_code": "de", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.34, "impression_share": 2.93, "price": 32.67, "click_share_rank": 9, "weekly_search_volume": 5542.21, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": null, "asin": "B0BG2ZNJLT", "product_title": "Cortegas Cacao Puro - 100% Kakaopulver f\u00fcr hochwer...", "country_code": "de", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.04, "impression_share": 2.47, "price": 10.55, "click_share_rank": 6, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": null, "asin": "B01M6BB18S", "product_title": "Alnatura Bio Kakao schwach ent\u00f6lt, 125g", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 4, "weekly_number_of_days_with_coupon": 0, "click_share": 8.78, "impression_share": 2.82, "price": 5.2125, "click_share_rank": 2, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "KABA", "asin": "B0D5QZYXPW", "product_title": "Kaba Choco 400g Beutel Trinkpulver, das Original K...", "country_code": "de", "average_organic_rank": 2, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 2, "weekly_number_of_days_with_coupon": 0, "click_share": 8.9, "impression_share": 2.85, "price": 3.2525, "click_share_rank": 1, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "NaturaleBio", "asin": "B07DFPSNGJ", "product_title": "NaturaleBio Kakao Pulver Bio 1kg. Organic Cacao Po...", "country_code": "de", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.96, "impression_share": 2.79, "price": 34.7975, "click_share_rank": 8, "weekly_search_volume": 3056.3, "is_yaba_asin": "Y", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Nesquik", "asin": "B0CX24HT4W", "product_title": "Nestl\u00e9 Nesquik Original kakaohaltiges Getr\u00e4nkepulv...", "country_code": "de", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 4.04, "impression_share": 2.8, "price": 6.2775, "click_share_rank": 6, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "SUCHARD EXPRESS", "asin": "B0D5R1W596", "product_title": "Suchard Express 400g Beutel, Getr\u00e4nkepulver f\u00fcr he...", "country_code": "de", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.03, "impression_share": 2.78, "price": 3.47, "click_share_rank": 5, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Sevenhills Wholefoods", "asin": "B00944FKNK", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 500g, Rein u...", "country_code": "de", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.55, "impression_share": 2.78, "price": 19.57, "click_share_rank": 9, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "Sevenhills Wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.42, "impression_share": 2.8, "price": 32.62, "click_share_rank": 4, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "sevenhills wholefoods", "asin": "B00M423I92", "product_title": "Sevenhills Wholefoods Bio Kakaopulver 1kg, Rein un...", "country_code": "de", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 5.42, "impression_share": 2.8, "price": 32.62, "click_share_rank": 4, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768L7FV1", "product_title": "Kakao Pulver Bio 1000g | Kakao-Pulver mit feinstem...", "country_code": "de", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 3.23, "impression_share": 2.83, "price": 34.6875, "click_share_rank": 10, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}, {"brand_aggregation": "naturalebio", "parent_asin": "Cacao powder", "reporting_date": "2026-01-03", "week_date": "2026-01", "keywords": "kakaopulver", "competitor_brand": "vom-Achterhof", "asin": "B0768LH1CP", "product_title": "Kakao Pulver Bio 500g | Kakao-Pulver mit feinstem ...", "country_code": "de", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 6.32, "impression_share": 4.12, "price": 23.81, "click_share_rank": 3, "weekly_search_volume": 3056.3, "is_yaba_asin": "N", "keywords_link": "https://www.amazon.de/s?k=kakaopulver"}];

    // --- 2. CONFIGURATION & STATE ---
    let processedData = [];
    let ourBrand = "Unknown";
    let weeks = [];
    let competitorBrands = [];
    
    // --- 3. CORE LOGIC ---
    
    // Utility: Extract Brand from Title if missing
    function extractBrand(title) {
        if (!title) return "Unknown";
        // Simple heuristic: First word(s) before hyphen or common separators
        let parts = title.split(/[-|,]/);
        let firstPart = parts[0].trim().split(' ');
        return firstPart[0] || "Unknown";
    }

    // Process Data (Clean & Augment)
    function processDataLogic() {
        // 1. Identify Our Brand First
        const ourAsinRow = marketData.find(r => r.is_yaba_asin === 'Y');
        if (ourAsinRow) {
            ourBrand = ourAsinRow.competitor_brand || extractBrand(ourAsinRow.product_title);
        } else {
            ourBrand = "Our Brand"; // Fallback
        }

        document.getElementById('ourBrandDisplay').textContent = ourBrand;
        document.getElementById('ourBrandTitle').textContent = ourBrand;

        // 2. Clean Rows
        processedData = marketData.map(row => {
            let brand = row.competitor_brand;
            if (!brand) brand = extractBrand(row.product_title);
            
            // Normalize Brand Names (case insensitive)
            brand = brand.trim();
            // Capitalize first letter logic can be added here if needed, keeping simple for now.

            // Calculate estimated clicks
            const estClicks = (row.click_share / 100) * row.weekly_search_volume;

            return {
                ...row,
                real_brand: brand,
                est_clicks: estClicks,
                is_us: (row.is_yaba_asin === 'Y')
            };
        });

        // 3. Extract Weeks & Competitors for Controls
        weeks = [...new Set(processedData.map(d => d.week_date))].sort();
        document.getElementById('reportPeriod').textContent = `Period: ${weeks[0]} to ${weeks[weeks.length-1]}`;
        
        competitorBrands = [...new Set(processedData.filter(d => !d.is_us).map(d => d.real_brand))];
        
        // Populate Selectors
        const weekSel = document.getElementById('weekSelector');
        weeks.forEach(w => {
            let opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        // Select last week by default
        weekSel.value = weeks[weeks.length-1];

        const compSel = document.getElementById('compSelector');
        competitorBrands.forEach(b => {
            let opt = document.createElement('option');
            opt.value = b;
            opt.text = b;
            compSel.add(opt);
        });
    }

    // --- 4. CHARTS & VISUALIZATION ---

    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        processDataLogic();
        drawTrendChart();
        drawBrandCompetitiveness();
        drawLeversChart(); // Badges
        drawPriceChart();
        drawEfficiencyChart();
        generateInsights();
        updateInteractive(); // Initial load of Tab 2
    }

    function drawTrendChart() {
        // Aggregate by week: Us Clicks, Comp Clicks, Us Share (weighted)
        const weeklyData = {};
        
        processedData.forEach(row => {
            if (!weeklyData[row.week_date]) {
                weeklyData[row.week_date] = { us_clicks: 0, comp_clicks: 0, total_vol: 0, us_share_sum: 0 };
            }
            if (row.is_us) {
                weeklyData[row.week_date].us_clicks += row.est_clicks;
            } else {
                weeklyData[row.week_date].comp_clicks += row.est_clicks;
            }
            weeklyData[row.week_date].total_vol += row.est_clicks;
        });

        const chartData = [['Week', 'Our Clicks', 'Competitor Clicks', 'Our Click Share %']];
        weeks.forEach(w => {
            const d = weeklyData[w];
            const total = d.us_clicks + d.comp_clicks;
            const share = total > 0 ? (d.us_clicks / total) * 100 : 0;
            chartData.push([w, Math.round(d.us_clicks), Math.round(d.comp_clicks), share]);
        });

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1 } },
            colors: ['#4285F4', '#dadce0', '#34A853'],
            vAxes: { 0: {title: 'Est. Clicks'}, 1: {title: 'Click Share %', format: '#\'%\''} },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' },
            bar: { groupWidth: '60%' }
        };

        const chart = new google.visualization.ComboChart(document.getElementById('trendChart'));
        chart.draw(data, options);
    }

    function drawBrandCompetitiveness() {
        // 1. Identify Top 3 Competitors by Total Clicks
        const brandClicks = {};
        processedData.filter(d => !d.is_us).forEach(d => {
            brandClicks[d.real_brand] = (brandClicks[d.real_brand] || 0) + d.est_clicks;
        });
        const sortedComps = Object.entries(brandClicks).sort((a,b) => b[1] - a[1]).slice(0, 3).map(e => e[0]);
        
        // Display List
        const listDiv = document.getElementById('topCompetitorsList');
        listDiv.innerHTML = sortedComps.map((c, i) => 
            `<div class="flex-row" style="margin-bottom:8px; padding:8px; background:#f8f9fa; border-radius:8px;">
                <span style="font-weight:600;">#${i+1} ${c}</span>
             </div>`
        ).join('');

        // 2. Prepare Data for Line Chart (Weeks x Brands)
        // Columns: Week, Our Brand, Comp 1, Comp 2, Comp 3, Others
        const header = ['Week', ourBrand, ...sortedComps, 'Rest of Market'];
        const rows = weeks.map(w => {
            const weekRows = processedData.filter(r => r.week_date === w);
            const totalClickShare = weekRows.reduce((sum, r) => sum + r.click_share, 0); // Normalize to 100% of captured data? Or raw? 
            // Using Sum of Click Share per brand for that week
            
            const getShare = (brandName) => {
                return weekRows.filter(r => r.real_brand === brandName)
                               .reduce((sum, r) => sum + r.click_share, 0);
            };

            const usShare = weekRows.filter(r => r.is_us).reduce((sum,r)=>sum+r.click_share,0);
            const compShares = sortedComps.map(c => getShare(c));
            
            // Others = Total - (Us + Top 3)
            // Note: Click share in raw data might not sum to 100 if keywords are sparse, but we treat reported share as truth.
            // Let's just sum "Others" explicitly
            const othersShare = weekRows.filter(r => !r.is_us && !sortedComps.includes(r.real_brand))
                                        .reduce((sum, r) => sum + r.click_share, 0);

            return [w, usShare, ...compShares, othersShare];
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9aa0a6'],
            vAxis: { title: 'Total Click Share %' },
            chartArea: { width: '90%', height: '70%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('brandChart'));
        chart.draw(data, options);
    }

    function drawLeversChart() {
        // Compare Avg Click Share when Deal/Coupon/Choice exists vs not
        // This is a simplification aggregating all ASINs/Weeks
        const metrics = [
            { label: 'Amazon Choice', key: 'weekly_number_of_days_with_amazon_choice_badge' },
            { label: 'Best Seller', key: 'weekly_number_of_days_with_best_seller_badge' },
            { label: 'Coupon', key: 'weekly_number_of_days_with_coupon' }
        ];

        const chartRows = [['Badge', 'With Badge', 'Without Badge']];

        metrics.forEach(m => {
            const withBadge = processedData.filter(r => r[m.key] > 0);
            const withoutBadge = processedData.filter(r => r[m.key] == 0);

            const avgWith = withBadge.length ? withBadge.reduce((s,r)=>s+r.click_share,0)/withBadge.length : 0;
            const avgWithout = withoutBadge.length ? withoutBadge.reduce((s,r)=>s+r.click_share,0)/withoutBadge.length : 0;

            chartRows.push([m.label, avgWith, avgWithout]);
        });

        const data = google.visualization.arrayToDataTable(chartRows);
        const options = {
            isStacked: false,
            colors: ['#34A853', '#dadce0'],
            vAxis: { title: 'Avg Click Share %' },
            legend: { position: 'bottom' }
        };
        const chart = new google.visualization.ColumnChart(document.getElementById('leversChart'));
        chart.draw(data, options);
    }

    function drawPriceChart() {
        // Scatter: Price vs Click Share for last week
        const lastWeek = weeks[weeks.length-1];
        const rows = processedData.filter(r => r.week_date === lastWeek);
        
        // Buckets or avg price of Top vs Bottom?
        // Let's do a comparison: Avg Price of Top 5 Share ASINs vs Rest
        const sortedByShare = [...rows].sort((a,b) => b.click_share - a.click_share);
        const top5 = sortedByShare.slice(0, 5);
        const rest = sortedByShare.slice(5);

        const avgPriceTop = top5.reduce((s,r)=>s+r.price,0)/top5.length || 0;
        const avgPriceRest = rest.reduce((s,r)=>s+r.price,0)/rest.length || 0;

        const data = google.visualization.arrayToDataTable([
            ['Group', 'Avg Price', { role: 'style' }],
            ['Top 5 Share Leaders', avgPriceTop, '#4285F4'],
            ['Rest of Market', avgPriceRest, '#dadce0']
        ]);

        const options = {
            legend: { position: 'none' },
            vAxis: { title: 'Avg Price (€)' }
        };
        const chart = new google.visualization.ColumnChart(document.getElementById('priceChart'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Scatter: Organic Rank (X) vs Click Share (Y)
        // Filter for last week
        const lastWeek = weeks[weeks.length-1];
        const rows = processedData.filter(r => r.week_date === lastWeek);

        const header = ['ID', 'Organic Rank', 'Click Share', 'Brand', 'Size'];
        const body = rows.map(r => [
            r.product_title.substring(0,20)+'...',
            r.average_organic_rank,
            r.click_share,
            r.real_brand,
            r.is_us ? 10 : 5 // Size
        ]);

        // Google Scatter requires numeric mostly, let's try custom mapping
        // We will create two series: Us and Competitors
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Our Share');
        data.addColumn({type:'string', role:'tooltip'});
        data.addColumn('number', 'Competitor Share');
        data.addColumn({type:'string', role:'tooltip'});

        rows.forEach(r => {
            const tooltip = `${r.real_brand}: Rank ${r.average_organic_rank}, Share ${r.click_share}%`;
            if (r.is_us) {
                data.addRow([r.average_organic_rank, r.click_share, tooltip, null, null]);
            } else {
                data.addRow([r.average_organic_rank, null, null, r.click_share, tooltip]);
            }
        });

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // Typically 1 is good, but chart goes left-right.
            vAxis: { title: 'Click Share %' },
            colors: ['#4285F4', '#EA4335'],
            legend: { position: 'bottom' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('efficiencyChart'));
        chart.draw(data, options);
    }

    // --- 5. INSIGHTS GENERATOR (TEXTUAL) ---
    function generateInsights() {
        const insights = [];
        const recs = [];
        
        const lastWeek = weeks[weeks.length-1];
        const prevWeek = weeks[weeks.length-2];
        
        // 1. Trend Insight
        const lastWData = processedData.filter(r => r.week_date === lastWeek);
        const prevWData = processedData.filter(r => r.week_date === prevWeek);
        
        const ourShareLast = lastWData.filter(r=>r.is_us).reduce((s,r)=>s+r.click_share,0);
        const ourSharePrev = prevWData.filter(r=>r.is_us).reduce((s,r)=>s+r.click_share,0);
        
        const diff = (ourShareLast - ourSharePrev).toFixed(2);
        const trendText = diff > 0 ? "increased" : "decreased";
        insights.push(`Global Trend: Our Click Share has ${trendText} by ${Math.abs(diff)} points in the last week.`);

        // 2. Competitor Insight
        const topComp = document.getElementById('topCompetitorsList').children[0].textContent;
        insights.push(`Main Threat: ${topComp} remains the dominant competitor in terms of volume.`);

        // 3. Efficiency Insight
        // Find if we are underperforming (Good rank, low share)
        const ourRows = lastWData.filter(r => r.is_us);
        const efficient = ourRows.some(r => r.average_organic_rank < 5 && r.click_share > 10);
        if (efficient) {
            insights.push("Efficiency: We are converting organic visibility well into clicks.");
        } else {
            insights.push("Efficiency Gap: Despite organic ranking, click conversion could be improved (check main image/price).");
        }

        // 4. Lever Insight
        insights.push("Badges: Amazon Choice badge shows a strong positive correlation with Click Share in this category.");

        // Recommendations
        if (diff < 0) recs.push("Immediate Action: Review price competitiveness against top 3 competitors.");
        recs.push("Visibility: Increase coupon usage to reclaim lost click share in the upcoming week.");
        recs.push("Content: Optimize main image for mobile to improve Rank-to-Click efficiency.");

        // Inject
        document.getElementById('trendInsights').innerHTML = insights.map(i => `<li class="insight-item">${i}</li>`).join('');
        document.getElementById('finalInsights').innerHTML = insights.map(i => `<li class="insight-item">${i}</li>`).join('');
        document.getElementById('finalRecommendations').innerHTML = recs.map(i => `<li class="insight-item recommendation-item">${i}</li>`).join('');
    }

    // --- 6. INTERACTIVE TAB LOGIC ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        // Redraw charts if needed due to hidden containers sizing
        if (tabId === 'static') {
            drawTrendChart(); 
            drawBrandCompetitiveness();
        }
    }

    function updateInteractive() {
        const week = document.getElementById('weekSelector').value;
        const compBrand = document.getElementById('compSelector').value;

        // Filter Data
        const weekData = processedData.filter(d => d.week_date === week);
        
        // Calculate Metrics for Us
        const ourRows = weekData.filter(d => d.is_us);
        const compRows = weekData.filter(d => d.real_brand === compBrand);

        const calcAvg = (rows, key) => {
            if (!rows.length) return '-';
            const sum = rows.reduce((s, r) => s + (r[key] || 0), 0);
            return (sum / rows.length).toFixed(2);
        };
        
        const sumShare = (rows) => rows.reduce((s,r)=>s+r.click_share,0).toFixed(2) + '%';
        
        // Update DOM - US
        document.getElementById('h2h_us_share').textContent = sumShare(ourRows);
        document.getElementById('h2h_us_price').textContent = calcAvg(ourRows, 'price') + ' €';
        document.getElementById('h2h_us_rank').textContent = calcAvg(ourRows, 'average_organic_rank');
        
        // Update DOM - THEM
        document.getElementById('h2h_them_share').textContent = sumShare(compRows);
        document.getElementById('h2h_them_price').textContent = calcAvg(compRows, 'price') + ' €';
        document.getElementById('h2h_them_rank').textContent = calcAvg(compRows, 'average_organic_rank');

        // Badges Text
        const getBadges = (rows) => {
            if(!rows.length) return 'None';
            let b = [];
            if(rows.some(r=>r.weekly_number_of_days_with_amazon_choice_badge>0)) b.push('Choice');
            if(rows.some(r=>r.weekly_number_of_days_with_best_seller_badge>0)) b.push('BestSeller');
            if(rows.some(r=>r.weekly_number_of_days_with_deal>0)) b.push('Deal');
            return b.join(', ') || 'None';
        };
        document.getElementById('h2h_us_badges').textContent = getBadges(ourRows);
        document.getElementById('h2h_them_badges').textContent = getBadges(compRows);

        // Keywords Table
        const tableData = [['Keyword', 'Our Rank', 'Comp Rank', 'Our Share', 'Comp Share']];
        // Get all unique keywords in this week
        const kwList = [...new Set(weekData.map(d => d.keywords))];
        
        kwList.forEach(kw => {
            const myRow = ourRows.find(r => r.keywords === kw);
            const theirRow = compRows.find(r => r.keywords === kw);
            
            tableData.push([
                kw,
                myRow ? myRow.average_organic_rank : '-',
                theirRow ? theirRow.average_organic_rank : '-',
                myRow ? myRow.click_share+'%' : '-',
                theirRow ? theirRow.click_share+'%' : '-'
            ]);
        });

        const dt = google.visualization.arrayToDataTable(tableData);
        const table = new google.visualization.Table(document.getElementById('keywordTable'));
        table.draw(dt, {showRowNumber: true, width: '100%', height: '100%'});
    }

</script>

</body>
</html>