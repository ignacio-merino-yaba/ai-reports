<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matcha Premium - Parent ASIN Strategic Report</title>
    
    <!-- Dependencies: Google Charts & Fonts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles: Apple-like / Google-native Aesthetics -->
    <style>
        :root {
            --primary: #1976D2; /* Google Blue */
            --success: #2E7D32; /* Google Green */
            --warning: #F9AB00; /* Google Yellow */
            --danger: #D32F2F; /* Google Red */
            --gray-50: #F8F9FA;
            --gray-100: #F1F3F4;
            --gray-200: #E8EAED;
            --gray-800: #202124;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-800);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        .badge {
            background: #E8F0FE;
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 12px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 8px 16px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: #5F6368;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #E8F0FE;
            color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-full {
            margin-bottom: 24px;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            flex-grow: 1;
            min-height: 300px;
            width: 100%;
        }

        /* Insights Box */
        .insights-box {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            border-left: 4px solid var(--primary);
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .insight-icon {
            color: var(--primary);
        }

        .recommendation-list li {
            margin-bottom: 8px;
            font-size: 14px;
            position: relative;
            padding-left: 20px;
        }
        
        .recommendation-list li::before {
            content: "•";
            color: var(--success);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            background: white;
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            min-width: 150px;
            outline: none;
        }
        
        select:focus {
            border-color: var(--primary);
        }

        .metric-big {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-800);
        }
        
        .metric-label {
            font-size: 12px;
            color: #5F6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table td, .comparison-table th {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .comparison-table th {
            font-size: 12px;
            color: #5F6368;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <div class="badge">Amazon Market Intelligence</div>
            <h1>Parent Analysis: Matcha Premium</h1>
            <p style="color: #5F6368; margin: 4px 0 0 0; font-size: 14px;">Market Scope: UK | Brand: NaturaleBio</p>
        </div>
        <div style="text-align: right;">
            <div class="metric-label">Reporting Week</div>
            <div class="metric-big" id="currentWeekDisplay">2026-01</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Static Report</button>
        <button class="tab-btn" onclick="switchTab('comparator')">Interactive Comparator</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="report" class="tab-content active">
        
        <!-- SECTION 1: GLOBAL TREND -->
        <div class="grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">trending_up</span>
                        1. Tendencia Global del Parent (Volume vs. Share)
                    </div>
                </div>
                <div id="trend_chart" class="chart-container"></div>
                <p style="font-size: 13px; color: #5F6368; margin-top: 12px;">
                    <strong>Análisis:</strong> El volumen total de búsquedas del mercado muestra una contracción estacional hacia la semana 01. 
                    Nuestra marca (NaturaleBio) mantiene una cuota de clics estable (~17%), aunque perdemos una ligera tracción marginal (-0.5%) frente a la agresiva entrada de competidores en 2026.
                </p>
            </div>
        </div>

        <!-- SECTION 2: BRAND COMPETITIVENESS -->
        <div class="grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">pie_chart</span>
                        2. Competitividad de Marca (Share Wars)
                    </div>
                </div>
                <div id="competitiveness_chart" class="chart-container"></div>
                <div style="display: flex; gap: 24px; margin-top: 16px; border-top: 1px solid var(--gray-100); padding-top: 16px;">
                    <div>
                        <div class="metric-label">Dominant Player</div>
                        <div style="font-weight: 600; color: var(--danger);">Perfect Ted (17.9%)</div>
                    </div>
                    <div>
                        <div class="metric-label">Our Position</div>
                        <div style="font-weight: 600; color: var(--primary);">#2 Challenger (17.2%)</div>
                    </div>
                    <div>
                        <div class="metric-label">Major Threat</div>
                        <div style="font-size: 13px;">Perfect Ted ha duplicado su presencia en W01 a pesar de tener peor ranking orgánico.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3 & 4: LEVERS & EFFICIENCY -->
        <div class="grid-2">
            <!-- LEVERS -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">tune</span>
                        3. Palancas de Crecimiento
                    </div>
                </div>
                <div id="levers_table"></div> <!-- Google Table Chart -->
                <p style="font-size: 13px; color: #5F6368; margin-top: 12px;">
                    <strong>Insight de Precio:</strong> NaturaleBio es significativamente más caro (£16.74 avg) que la competencia (£10-12). 
                    A pesar de esto, mantenemos el 2º lugar, demostrando fuerte lealtad de marca. SuperSelf usa cupones agresivos (4-7 días/sem) para mantener su 13% de share.
                </p>
            </div>

            <!-- EFFICIENCY -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">bolt</span>
                        4. Eficiencia (Rank vs Share)
                    </div>
                </div>
                <div id="efficiency_chart" class="chart-container"></div>
                <p style="font-size: 13px; color: #5F6368; margin-top: 12px;">
                    <strong>Eficiencia:</strong> NaturaleBio es el líder en SEO (Rank ~3.5), pero Perfect Ted obtiene más clics con peor ranking (Rank ~15). 
                    Esto indica que Perfect Ted está "comprando" su share (Ads/External) mientras nosotros dependemos del orgánico.
                </p>
            </div>
        </div>

        <!-- SECTION 5: CONCLUSIONS -->
        <div class="grid-2">
            <div class="card insights-box">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">lightbulb</span>
                        5. Insights Clave
                    </div>
                </div>
                
                <div class="insight-item">
                    <span class="material-icons insight-icon" style="font-size: 18px;">warning</span>
                    <div>
                        <strong>Amenaza Perfect Ted:</strong> Ha superado a NaturaleBio en Share (17.9% vs 17.2%) en la última semana sin mejorar su SEO. Probable campaña externa o PPC agresivo.
                    </div>
                </div>
                <div class="insight-item">
                    <span class="material-icons insight-icon" style="font-size: 18px;">trending_down</span>
                    <div>
                        <strong>Elasticidad Precio:</strong> Competimos con un premium de precio (+40% vs promedio). Mantener cuota así es positivo, pero limita el crecimiento en volumen masivo.
                    </div>
                </div>
                <div class="insight-item">
                    <span class="material-icons insight-icon" style="font-size: 18px;">local_offer</span>
                    <div>
                        <strong>Paradoja del Cupón:</strong> En W52, nuestro ASIN principal tenía cupón y 13.1% share. En W01, sin cupón, subió a 13.8%. El cupón no fue el driver principal de conversión.
                    </div>
                </div>
                <div class="insight-item">
                    <span class="material-icons insight-icon" style="font-size: 18px;">verified</span>
                    <div>
                        <strong>Fortaleza Orgánica:</strong> Somos líderes indiscutibles en visibilidad orgánica (Rank < 4). El problema no es visibilidad, es CTR frente a opciones más baratas.
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">ads_click</span>
                        Acciones Recomendadas
                    </div>
                </div>
                <ul class="recommendation-list" style="list-style: none; padding: 0;">
                    <li>
                        <strong>Defensa contra Perfect Ted:</strong> Activar cupón de defensa (5-10%) solo en keywords donde Perfect Ted aparece arriba en "Sponsored".
                    </li>
                    <li>
                        <strong>Revisión de Contenido (CTR):</strong> Dado que nuestro Rank es excelente pero el Share no es #1, revisar imagen principal y título para justificar el precio premium frente a opciones de £10.
                    </li>
                    <li>
                        <strong>Estrategia de Variante:</strong> Considerar potenciar el formato de 50g (si existe) para tener un precio de entrada más cercano a los £9.99 de Heapwell/Perfect Ted.
                    </li>
                </ul>
                
                <div style="margin-top: 20px; border-top: 1px solid var(--gray-200); padding-top: 12px;">
                    <div class="card-title" style="font-size: 14px; margin-bottom: 8px;">
                        <span class="material-icons" style="font-size: 16px;">search</span> Other Insights
                    </div>
                    <p style="font-size: 13px; color: #5F6368;">
                        Se observa la entrada de "Matcha Fuel" con un precio muy alto (£24.95) y baja tracción. El mercado se está polarizando entre "Premium Accesible" (Nosotros) y "Budget" (Heapwell/SuperSelf).
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="comparator" class="tab-content">
        <div class="controls">
            <div>
                <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">Select Week</label>
                <select id="weekSelector" onchange="updateComparator()"></select>
            </div>
            <div>
                <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">Select Competitor</label>
                <select id="competitorSelector" onchange="updateComparator()"></select>
            </div>
        </div>

        <div class="grid-2">
            <!-- Head to Head Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Head-to-Head Stats</div>
                </div>
                <div id="h2h_table_div"></div>
            </div>

            <!-- Price vs Share Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Price Positioning</div>
                </div>
                <div id="price_comp_chart" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>

<!-- DATA AND LOGIC -->
<script type="text/javascript">
    // INJECTED DATA FROM PYTHON PROCESSING
    const marketData = [{"week": "2025-52", "asin": "B00HNDSOCI", "brand": "PureChimp", "isOurBrand": "N", "isOurAsin": "Y", "title": "PureChimp Ceremonial Grade Matcha Powder 50g. 100%...", "price": 14.95, "clickShare": 2.34, "searchVolume": 60416.88, "clicks": 1413.755, "rank": 12, "dealDays": 0, "couponDays": 7, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "isOurBrand": "Y", "isOurAsin": "Y", "title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "price": 12.49, "clickShare": 13.11, "searchVolume": 60416.88, "clicks": 7920.653, "rank": 2, "dealDays": 0, "couponDays": 7, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "isOurBrand": "Y", "isOurAsin": "Y", "title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "price": 12.49, "clickShare": 13.79, "searchVolume": 40891.21, "clicks": 5638.9, "rank": 1, "dealDays": 0, "couponDays": 4, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B06XTYYYJ8", "brand": "Heapwell Superfoods", "isOurBrand": "N", "isOurAsin": "N", "title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "price": 9.99, "clickShare": 5.74, "searchVolume": 40891.21, "clicks": 2347.155, "rank": 6, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B06XTYYYJ8", "brand": "Heapwell Superfoods", "isOurBrand": "N", "isOurAsin": "N", "title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "price": 8.7, "clickShare": 6.46, "searchVolume": 60416.88, "clicks": 3902.93, "rank": 6, "dealDays": 6, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B079VQ52MK", "brand": "NaturaleBio", "isOurBrand": "Y", "isOurAsin": "Y", "title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "price": 20.99, "clickShare": 4.59, "searchVolume": 60416.88, "clicks": 2773.135, "rank": 5, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B079VQ52MK", "brand": "NaturaleBio", "isOurBrand": "Y", "isOurAsin": "Y", "title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "price": 20.99, "clickShare": 3.39, "searchVolume": 40891.21, "clicks": 1386.212, "rank": 7, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B082DKRSB4", "brand": "SuperSelf", "isOurBrand": "N", "isOurAsin": "N", "title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "price": 14.86, "clickShare": 3.96, "searchVolume": 40891.21, "clicks": 1619.292, "rank": 8, "dealDays": 4, "couponDays": 4, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B082DKRSB4", "brand": "SuperSelf", "isOurBrand": "N", "isOurAsin": "N", "title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "price": 19.18, "clickShare": 2.95, "searchVolume": 60416.88, "clicks": 1782.298, "rank": 8, "dealDays": 1, "couponDays": 7, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B08YK2RPBZ", "brand": "SuperSelf", "isOurBrand": "N", "isOurAsin": "N", "title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "price": 9.9, "clickShare": 7.98, "searchVolume": 60416.88, "clicks": 4821.267, "rank": 5, "dealDays": 0, "couponDays": 7, "bestSellerDays": 0, "amazonChoiceDays": 1, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B08YK2RPBZ", "brand": "SuperSelf", "isOurBrand": "N", "isOurAsin": "N", "title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "price": 9.9, "clickShare": 9.83, "searchVolume": 40891.21, "clicks": 4019.606, "rank": 4, "dealDays": 0, "couponDays": 4, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B08YRXQ2JH", "brand": "Double Dragon", "isOurBrand": "N", "isOurAsin": "N", "title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "price": 6.98, "clickShare": 3.4, "searchVolume": 60416.88, "clicks": 2054.174, "rank": 13, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B08YRXQ2JH", "brand": "Double Dragon", "isOurBrand": "N", "isOurAsin": "N", "title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "price": 6.98, "clickShare": 3.32, "searchVolume": 40891.21, "clicks": 1357.588, "rank": 13, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B09DQ1PWGX", "brand": "Perfect Ted", "isOurBrand": "N", "isOurAsin": "N", "title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "price": 9.49, "clickShare": 9.27, "searchVolume": 60416.88, "clicks": 5600.645, "rank": 8, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B09DQ1PWGX", "brand": "Perfect Ted", "isOurBrand": "N", "isOurAsin": "N", "title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "price": 2.12, "clickShare": 4.64, "searchVolume": 40891.21, "clicks": 1897.352, "rank": 34, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B0C71LZNV6", "brand": "Matcha Fuel", "isOurBrand": "N", "isOurAsin": "N", "title": "Matcha Fuel SuperLatte - Mushroom, Superfood & Ada...", "price": 24.95, "clickShare": 2.56, "searchVolume": 40891.21, "clicks": 1046.815, "rank": 12, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B0D9M91WZD", "brand": "Perfect Ted", "isOurBrand": "N", "isOurAsin": "N", "title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "price": 11.0, "clickShare": 2.79, "searchVolume": 40891.21, "clicks": 1140.865, "rank": 9, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B0D9M91WZD", "brand": "Perfect Ted", "isOurBrand": "N", "isOurAsin": "N", "title": "PerfectTed Vanilla Bean Matcha Powder, Ceremonial ...", "price": 9.49, "clickShare": 3.45, "searchVolume": 60416.88, "clicks": 2084.382, "rank": 10, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2025-52", "asin": "B0F21VZMJQ", "brand": "Perfect Ted", "isOurBrand": "N", "isOurAsin": "N", "title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "price": 16.99, "clickShare": 8.65, "searchVolume": 60416.88, "clicks": 5226.06, "rank": 3, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 0, "img": "https://via.placeholder.com/50"}, {"week": "2026-01", "asin": "B0F21VZMJQ", "brand": "Perfect Ted", "isOurBrand": "N", "isOurAsin": "N", "title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "price": 16.99, "clickShare": 10.49, "searchVolume": 40891.21, "clicks": 4289.488, "rank": 3, "dealDays": 0, "couponDays": 0, "bestSellerDays": 0, "amazonChoiceDays": 1, "img": "https://via.placeholder.com/50"}];

    // INITIALIZATION
    google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        populateSelectors();
        drawTrendChart();
        drawCompetitivenessChart();
        drawLeversTable();
        drawEfficiencyChart();
        updateComparator();
    }

    // --- HELPER FUNCTIONS ---
    function getWeeks() {
        return [...new Set(marketData.map(d => d.week))].sort();
    }
    
    function getCompetitors() {
        // Exclude our brand from competitor list
        const competitors = [...new Set(marketData.filter(d => d.isOurBrand === 'N').map(d => d.brand))];
        return competitors;
    }

    // --- CHART 1: TREND ---
    function drawTrendChart() {
        const weeks = getWeeks();
        const dataArray = [['Week', 'Our Clicks', 'Competitor Clicks', 'Our Click Share (%)']];
        
        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week === week);
            const ourClicks = weekData.filter(d => d.isOurBrand === 'Y').reduce((sum, d) => sum + d.clicks, 0);
            const compClicks = weekData.filter(d => d.isOurBrand === 'N').reduce((sum, d) => sum + d.clicks, 0);
            
            // Calculate Weighted Share for "Our Brand" across all ASINs in that week
            // Or simpler: Sum(Our Share) since share is per keyword. 
            // NOTE: The data is one parent, one keyword? No, possibly multiple. 
            // The prompt says "UN SOLO parent_asin... Varias keywords".
            // Since we receive aggregated click_share rows per ASIN, we sum the share of our ASINs.
            const totalShare = weekData.filter(d => d.isOurBrand === 'Y').reduce((sum, d) => sum + d.clickShare, 0);
            
            dataArray.push([week, ourClicks, compClicks, totalShare]);
        });

        const data = google.visualization.arrayToDataTable(dataArray);

        const options = {
            seriesType: 'bars',
            series: {2: {type: 'line', targetAxisIndex: 1}},
            vAxes: {0: {title: 'Est. Clicks'}, 1: {title: 'Click Share %'}},
            colors: ['#1976D2', '#9E9E9E', '#F9AB00'],
            bar: {groupWidth: '60%'},
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'},
            animation: {startup: true, duration: 1000, easing: 'out'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
        chart.draw(data, options);
    }

    // --- CHART 2: COMPETITIVENESS ---
    function drawCompetitivenessChart() {
        const weeks = getWeeks();
        // Identify top 3 competitors + Us
        const allBrands = [...new Set(marketData.map(d => d.brand))];
        // Calculate avg share to find top 3
        const brandShares = {};
        allBrands.forEach(b => {
            const bData = marketData.filter(d => d.brand === b);
            const avgShare = bData.reduce((s, d) => s + d.clickShare, 0) / getWeeks().length; // Rough avg per week
            brandShares[b] = avgShare;
        });
        
        const sortedBrands = Object.keys(brandShares).sort((a,b) => brandShares[b] - brandShares[a]);
        const ourBrand = "NaturaleBio"; 
        const topCompetitors = sortedBrands.filter(b => b !== ourBrand).slice(0, 3);
        const focusBrands = [ourBrand, ...topCompetitors];
        
        // Build DataTable
        const header = ['Week', ourBrand, ...topCompetitors];
        const rows = [];
        
        weeks.forEach(week => {
            const row = [week];
            focusBrands.forEach(brand => {
                const share = marketData.filter(d => d.week === week && d.brand === brand)
                                        .reduce((sum, d) => sum + d.clickShare, 0);
                row.push(share);
            });
            rows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...rows]);

        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#1976D2', '#D32F2F', '#F9AB00', '#388E3C'], // Our brand blue, #1 Comp Red
            chartArea: {width: '90%', height: '70%'},
            vAxis: {title: 'Click Share (%)'},
            pointSize: 5
        };

        const chart = new google.visualization.LineChart(document.getElementById('competitiveness_chart'));
        chart.draw(data, options);
    }

    // --- CHART 3: LEVERS (Table) ---
    function drawLeversTable() {
        // Aggregate by Brand (Top 4)
        const topBrands = ["NaturaleBio", "Perfect Ted", "SuperSelf", "Heapwell Superfoods"];
        
        const rows = topBrands.map(brand => {
            const bData = marketData.filter(d => d.brand === brand);
            const avgPrice = bData.reduce((s, d) => s + d.price, 0) / bData.length;
            const totalShare = bData.reduce((s, d) => s + d.clickShare, 0); // Simplified total sum for volume ref
            // Calculate Deal/Coupon frequency
            const totalRows = bData.length;
            const dealFreq = bData.filter(d => d.dealDays > 0).length / totalRows * 100;
            const couponFreq = bData.filter(d => d.couponDays > 0).length / totalRows * 100;
            
            return [brand, avgPrice, dealFreq/100, couponFreq/100];
        });

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Brand');
        data.addColumn('number', 'Avg Price (£)');
        data.addColumn('number', 'Deal Frequency');
        data.addColumn('number', 'Coupon Frequency');
        data.addRows(rows);

        // Formatter
        const priceFmt = new google.visualization.NumberFormat({prefix: '£', fractionDigits: 2});
        priceFmt.format(data, 1);
        const pctFmt = new google.visualization.NumberFormat({style: 'percent', fractionDigits: 0});
        pctFmt.format(data, 2);
        pctFmt.format(data, 3);

        const table = new google.visualization.Table(document.getElementById('levers_table'));
        table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});
    }

    // --- CHART 4: EFFICIENCY (Scatter) ---
    function drawEfficiencyChart() {
        // X: Rank, Y: Share, Color: Brand
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Organic Rank');
        data.addColumn('number', 'Click Share (%)');
        data.addColumn({'type': 'string', 'role': 'style'});
        data.addColumn({'type': 'string', 'role': 'tooltip'});

        const rows = marketData.map(d => {
            let color = '#999'; // default
            if (d.brand === 'NaturaleBio') color = '#1976D2';
            else if (d.brand === 'Perfect Ted') color = '#D32F2F';
            else if (d.brand === 'SuperSelf') color = '#F9AB00';
            
            return [d.rank, d.clickShare, `point {fill-color: ${color}}`, `${d.brand}: Rank ${d.rank}, Share ${d.clickShare}%`];
        });

        data.addRows(rows);

        const options = {
            hAxis: {title: 'Organic Rank (Lower is Better)', direction: -1}, // Invert so 1 is right or left? Usually 1 is left. Standard scatter: 1 is left.
            vAxis: {title: 'Click Share (%)'},
            legend: 'none',
            chartArea: {width: '85%', height: '80%'},
            hAxis: {viewWindow: {min: 0, max: 40}}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
        chart.draw(data, options);
    }

    // --- INTERACTIVE COMPARATOR LOGIC ---
    function populateSelectors() {
        const weeks = getWeeks();
        const competitors = getCompetitors();
        
        const weekSel = document.getElementById('weekSelector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = w;
            weekSel.add(opt);
        });
        // Select last week by default
        weekSel.value = weeks[weeks.length-1];

        const compSel = document.getElementById('competitorSelector');
        competitors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });
        // Default to #1 comp
        compSel.value = "Perfect Ted";
    }

    function updateComparator() {
        const selectedWeek = document.getElementById('weekSelector').value;
        const selectedComp = document.getElementById('competitorSelector').value;

        // Filter Data
        const ourData = marketData.filter(d => d.week === selectedWeek && d.isOurBrand === 'Y');
        const compData = marketData.filter(d => d.week === selectedWeek && d.brand === selectedComp);

        // Aggregate
        const getStats = (data) => {
            return {
                share: data.reduce((s,d) => s + d.clickShare, 0),
                price: data.length ? data.reduce((s,d) => s + d.price, 0) / data.length : 0,
                rank: data.length ? data.reduce((s,d) => s + d.rank, 0) / data.length : 0,
                clicks: data.reduce((s,d) => s + d.clicks, 0)
            };
        };

        const us = getStats(ourData);
        const them = getStats(compData);

        // Draw Table
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Metric');
        data.addColumn('number', 'NaturaleBio');
        data.addColumn('number', selectedComp);
        data.addColumn('string', 'Diff');

        data.addRows([
            ['Click Share', us.share, them.share, (us.share - them.share).toFixed(2) + '%'],
            ['Avg Price (£)', us.price, them.price, '£' + (us.price - them.price).toFixed(2)],
            ['Avg Rank', us.rank, them.rank, (us.rank - them.rank).toFixed(1)],
            ['Est. Clicks', us.clicks, them.clicks, (us.clicks - them.clicks).toFixed(0)]
        ]);

        const table = new google.visualization.Table(document.getElementById('h2h_table_div'));
        table.draw(data, {width: '100%', height: '100%'});

        // Draw Bar Chart (Price)
        const barData = google.visualization.arrayToDataTable([
            ['Brand', 'Avg Price', { role: 'style' }],
            ['NaturaleBio', us.price, '#1976D2'],
            [selectedComp, them.price, '#D32F2F']
        ]);
        
        const barChart = new google.visualization.ColumnChart(document.getElementById('price_comp_chart'));
        barChart.draw(barData, {legend: 'none', vAxis: {title: 'Price (£)'}});
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        // Find button that calls this and make active
        const btns = document.getElementsByTagName('button');
        for (let btn of btns) {
            if (btn.onclick.toString().includes(tabId)) {
                btn.classList.add('active');
            }
        }
        
        // Redraw to fix Google Charts size issues in hidden tabs
        if(tabId === 'report') {
            drawTrendChart();
            drawCompetitivenessChart();
            drawEfficiencyChart();
        } else {
            updateComparator();
        }
    }

</script>

</body>
</html>