<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado Amazon</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f5f5f7;
            --bg-card: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-blue: #0071e3;
            --accent-green: #34c759;
            --accent-red: #ff3b30;
            --border-radius: 16px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #e3e3e8;
            padding: 4px;
            border-radius: 99px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-btn {
            padding: 10px 24px;
            border: none;
            background: none;
            border-radius: 99px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Cards & Layout */
        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Metrics */
        .metric-group {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights List */
        .insights-list li {
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 3px solid var(--accent-blue);
        }
        .rec-list li {
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 3px solid var(--accent-green);
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #d2d2d7;
            font-size: 1rem;
            background-color: white;
        }

        /* Utility */
        .hidden { display: none; }
        .text-blue { color: var(--accent-blue); }
        .text-red { color: var(--accent-red); }
        
        /* Charts Container */
        .chart-container {
            width: 100%;
            height: 400px;
        }
        
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Market Intelligence Report</h1>
        <p id="report-subtitle">An√°lisis del Parent ASIN</p>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Reporte Estrat√©gico</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
    </div>

    <!-- PESTA√ëA 1: REPORTE ESTRAT√âGICO -->
    <div id="tab-static">
        
        <!-- Secci√≥n 1: Tendencia Global -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons text-blue">trending_up</span>
                1. Tendencia Global del Parent (Mercado Total)
            </div>
            <div class="metric-group" id="global-metrics">
                <!-- Metrics injected via JS -->
            </div>
            <div id="chart_global_trend" class="chart-container"></div>
            <p class="insight-text" id="global-insight" style="margin-top: 15px; font-style: italic; color: var(--text-secondary);"></p>
        </div>

        <!-- Secci√≥n 2: Competitividad de Marca -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons text-blue">pie_chart</span>
                2. Competitividad de Marca (Share of Voice)
            </div>
            <div id="chart_brand_share" class="chart-container"></div>
            <div class="grid-2" style="margin-top: 20px;">
                <div>
                    <h4>Dominio del Mercado</h4>
                    <p id="brand-dominance-text">Analizando datos...</p>
                </div>
                <div>
                    <h4>Top Competidores</h4>
                    <ul id="top-competitors-list"></ul>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <!-- Secci√≥n 3: Palancas -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons text-blue">rocket_launch</span>
                    3. Palancas de Crecimiento
                </div>
                <div id="table_levers" style="width: 100%;"></div>
                <p style="font-size: 0.9em; color: #888; margin-top: 10px;">*Impacto relativo en Click Share cuando la palanca est√° activa vs inactiva.</p>
            </div>

            <!-- Secci√≥n 4: Eficiencia -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons text-blue">speed</span>
                    4. Eficiencia (Rank vs Share)
                </div>
                <div id="chart_efficiency" class="chart-container"></div>
                <p id="efficiency-insight" style="margin-top: 10px; font-size: 0.95rem;"></p>
            </div>
        </div>

        <!-- Secci√≥n 5: Conclusiones -->
        <div class="card" style="border-left: 6px solid var(--accent-blue);">
            <div class="card-title">
                <span class="material-icons text-blue">lightbulb</span>
                5. Conclusiones y Recomendaciones
            </div>
            <div class="grid-2">
                <div>
                    <h3 style="color: var(--text-primary);">Insights Clave</h3>
                    <ul class="insights-list" id="final-insights">
                        <!-- Filled by JS -->
                    </ul>
                </div>
                <div>
                    <h3 style="color: var(--text-primary);">Acciones Recomendadas</h3>
                    <ul class="rec-list" id="final-recommendations">
                        <!-- Filled by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 6: Other Insights -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons text-blue">visibility</span>
                6. Other Insights & Anomalies
            </div>
            <ul id="other-insights-list" style="list-style-type: circle; padding-left: 20px; color: var(--text-secondary);">
                <!-- Filled by JS -->
            </ul>
        </div>
    </div>

    <!-- PESTA√ëA 2: COMPARADOR INTERACTIVO -->
    <div id="tab-interactive" class="hidden">
        <div class="card">
            <div class="card-title">
                <span class="material-icons text-blue">compare_arrows</span>
                Comparador Cara a Cara
            </div>
            <div class="controls">
                <label>Semana:</label>
                <select id="select-week" onchange="updateInteractive()"></select>
                
                <label>Comparar Nosotros vs:</label>
                <select id="select-competitor" onchange="updateInteractive()"></select>
            </div>

            <div class="grid-2">
                <div style="background: #f0f8ff; padding: 20px; border-radius: 12px; text-align: center;">
                    <h3 style="margin:0; color: var(--accent-blue);">Nuestra Marca</h3>
                    <div id="my-stats" style="margin-top: 15px;"></div>
                </div>
                <div style="background: #fff0f0; padding: 20px; border-radius: 12px; text-align: center;">
                    <h3 style="margin:0; color: var(--accent-red);" id="comp-name-display">Competidor</h3>
                    <div id="comp-stats" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div id="chart_interactive_comparison" class="chart-container" style="margin-top: 30px;"></div>
        </div>
    </div>

</div>

<script>
    // ---------------------------------------------------------
    // 1. DATA INJECTION (PROCESSED JSON)
    // ---------------------------------------------------------
    const marketData = [{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"Monte Nativo","asin":"B0C3FBKSLB","product_title":"Bio Matcha Pulver Monte Nativo (100g) - Matcha Tee...","country_code":"de","average_organic_rank":4.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":4.35,"impression_share":3.28,"price":10.424285714,"click_share_rank":5,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":2267.983425},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"Special Leaves","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","country_code":"de","average_organic_rank":11.0,"weekly_number_of_days_with_deal":7.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":7.0,"click_share":5.14,"impression_share":5.4,"price":9.375714286,"click_share_rank":4,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":2679.87007},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"Special Leaves","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","country_code":"de","average_organic_rank":11.0,"weekly_number_of_days_with_deal":7.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":7.0,"click_share":5.14,"impression_share":5.4,"price":9.375714286,"click_share_rank":4,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":2679.87007},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"NaturaleBio","asin":"B06XQ5DCYJ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","country_code":"de","average_organic_rank":2.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":11.88,"impression_share":3.26,"price":14.657142857,"click_share_rank":2,"weekly_search_volume":52137.55,"is_yaba_asin":"Y","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":6193.94094},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"NaturaleBio","asin":"B079VQ52MK","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","country_code":"de","average_organic_rank":5.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":3.59,"impression_share":3.25,"price":24.61,"click_share_rank":6,"weekly_search_volume":52137.55,"is_yaba_asin":"Y","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":1871.738045},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"Ceremonial","asin":"B0FWCJD5Y4","product_title":"Ceremonial Matcha Uji - Reines Gr\u00fcntee-Pulver aus ...","country_code":"de","average_organic_rank":18.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":2.91,"impression_share":2.3,"price":41.804285714,"click_share_rank":8,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":1517.202705},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"NORITUAL LAB","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","country_code":"de","average_organic_rank":6.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":8.66,"impression_share":5.44,"price":15.61,"click_share_rank":3,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":4515.11183},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"NORITUAL LAB","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","country_code":"de","average_organic_rank":6.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":8.66,"impression_share":5.44,"price":15.61,"click_share_rank":3,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":4515.11183},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"NaturaleBio","asin":"B07SZFD3P9","product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","country_code":"de","average_organic_rank":0.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":3.03,"impression_share":2.04,"price":30.603333333,"click_share_rank":7,"weekly_search_volume":52137.55,"is_yaba_asin":"Y","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":1579.767765},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"VAHDAM","asin":"B07MD4LB49","product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","country_code":"de","average_organic_rank":9.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":2.82,"impression_share":5.03,"price":10.467142857,"click_share_rank":9,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":1470.27891},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"NORITUAL LAB","asin":"B0CNRX8G5S","product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","country_code":"de","average_organic_rank":1.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":7.0,"weekly_number_of_days_with_coupon":0.0,"click_share":17.18,"impression_share":3.25,"price":23.992857143,"click_share_rank":1,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":8957.23109},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"bioKontor","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","country_code":"de","average_organic_rank":11.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":2.32,"impression_share":3.65,"price":12.037142857,"click_share_rank":10,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":1209.59116},{"brand_aggregation":"naturalebio","parent_asin":"Matcha Premium","reporting_date":"2026-01-10","week_date":"2026-02","keywords":"matcha","competitor_brand":"bioKontor","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","country_code":"de","average_organic_rank":11.0,"weekly_number_of_days_with_deal":0.0,"weekly_number_of_days_with_best_seller_badge":0.0,"weekly_number_of_days_with_amazon_choice_badge":0.0,"weekly_number_of_days_with_coupon":0.0,"click_share":2.32,"impression_share":3.65,"price":12.037142857,"click_share_rank":10,"weekly_search_volume":52137.55,"is_yaba_asin":"N","keywords_link":"https://www.amazon.de/s?k=matcha","estimated_clicks":1209.59116}];

    // ---------------------------------------------------------
    // 2. LOGIC & INITIALIZATION
    // ---------------------------------------------------------
    
    // Google Charts Initialization
    google.charts.load('current', {'packages':['corechart', 'table']});
    google.charts.setOnLoadCallback(initDashboard);

    // Global Vars
    let uniqueWeeks = [];
    let myBrand = "";
    let cleanData = [];

    function initDashboard() {
        // 1. Preprocess Data (Deduplicate)
        // Deduplicate based on ASIN + Week, keeping the one with most info
        const map = new Map();
        marketData.forEach(row => {
            const key = `${row.week_date}_${row.asin}`;
            if (!map.has(key)) {
                map.set(key, row);
            } else {
                // If existing has no brand but new one does, swap
                if ((!map.get(key).competitor_brand || map.get(key).competitor_brand === "Unknown Brand") && 
                    (row.competitor_brand && row.competitor_brand !== "Unknown Brand")) {
                    map.set(key, row);
                }
            }
        });
        cleanData = Array.from(map.values());

        // 2. Identify Meta-Data
        uniqueWeeks = [...new Set(cleanData.map(d => d.week_date))].sort();
        
        // Find My Brand (is_yaba_asin = 'Y')
        const myBrandRow = cleanData.find(d => d.is_yaba_asin === 'Y');
        myBrand = myBrandRow ? myBrandRow.competitor_brand : "Nuestra Marca";
        if (!myBrand) myBrand = "Nuestra Marca";

        // Update Subtitle
        document.getElementById('report-subtitle').innerText = 
            `Parent: ${cleanData[0].parent_asin} | Brand: ${myBrand} | Weeks: ${uniqueWeeks.length}`;

        // 3. Draw Sections
        drawGlobalTrend();
        drawBrandShare();
        drawLeversTable();
        drawEfficiencyChart();
        generateInsights();
        populateInteractiveControls();
    }

    // --- HELPERS ---
    function formatNum(n) { return n.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:1}); }
    function formatCurrency(n) { return n.toLocaleString(undefined, {style:'currency', currency:'EUR'}); }

    // ---------------------------------------------------------
    // SECTION 1: GLOBAL TREND
    // ---------------------------------------------------------
    function drawGlobalTrend() {
        // Aggregates per week
        const weekStats = {};
        uniqueWeeks.forEach(w => {
            const rows = cleanData.filter(d => d.week_date === w);
            const totalClicks = rows.reduce((sum, r) => sum + (r.estimated_clicks || 0), 0);
            
            // Calculate Weighted Click Share of "Us"
            const myRows = rows.filter(d => d.competitor_brand === myBrand);
            const myClicks = myRows.reduce((sum, r) => sum + (r.estimated_clicks || 0), 0);
            const myShare = totalClicks > 0 ? (myClicks / totalClicks) * 100 : 0; // Relative to visible market
            
            weekStats[w] = { totalClicks, myShare };
        });

        // Setup Data Table
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', 'Volumen de Clics (Mercado)');
        data.addColumn('number', 'Cuota de Clics (Nuestra Marca)');

        uniqueWeeks.forEach(w => {
            data.addRow([w, weekStats[w].totalClicks, weekStats[w].myShare]);
        });

        // Metrics HTML
        const lastWeek = uniqueWeeks[uniqueWeeks.length-1];
        const lastData = weekStats[lastWeek];
        document.getElementById('global-metrics').innerHTML = `
            <div>
                <div class="metric-value">${formatNum(lastData.totalClicks)}</div>
                <div class="metric-label">Clics Totales (Semana ${lastWeek})</div>
            </div>
            <div>
                <div class="metric-value text-blue">${formatNum(lastData.myShare)}%</div>
                <div class="metric-label">Nuestra Cuota</div>
            </div>
        `;

        // Chart Options
        const options = {
            seriesType: 'bars',
            series: { 1: {type: 'line', targetAxisIndex: 1} },
            colors: ['#86868b', '#0071e3'],
            vAxes: { 0: {title: 'Clics'}, 1: {title: 'Share %', format: '#\'%\''} },
            legend: { position: 'bottom' },
            chartArea: { width: '80%', height: '70%' },
            backgroundColor: 'transparent'
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_global_trend'));
        chart.draw(data, options);

        // Insight Text
        const prevWeek = uniqueWeeks.length > 1 ? uniqueWeeks[uniqueWeeks.length-2] : null;
        if(prevWeek) {
            const growth = lastData.totalClicks - weekStats[prevWeek].totalClicks;
            const sign = growth >= 0 ? "creci√≥" : "decreci√≥";
            document.getElementById('global-insight').innerText = 
                `El volumen de mercado ${sign} un ${formatNum(Math.abs((growth/weekStats[prevWeek].totalClicks)*100))}% respecto a la semana anterior.`;
        } else {
             document.getElementById('global-insight').innerText = "Datos insuficientes para an√°lisis de tendencia temporal (solo 1 semana disponible).";
        }
    }

    // ---------------------------------------------------------
    // SECTION 2: BRAND SHARE
    // ---------------------------------------------------------
    function drawBrandShare() {
        // Identify Top 3 Competitors by Total Volume across all weeks
        const brandVolumes = {};
        cleanData.forEach(r => {
            if(r.competitor_brand === myBrand) return;
            brandVolumes[r.competitor_brand] = (brandVolumes[r.competitor_brand] || 0) + r.estimated_clicks;
        });
        
        const topCompetitors = Object.entries(brandVolumes)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);

        // Build Data Table
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Semana');
        data.addColumn('number', myBrand);
        topCompetitors.forEach(c => data.addColumn('number', c));
        data.addColumn('number', 'Resto');

        uniqueWeeks.forEach(w => {
            const rows = cleanData.filter(d => d.week_date === w);
            const total = rows.reduce((s,r) => s + r.estimated_clicks, 0);
            
            const getShare = (brand) => {
                const bClicks = rows.filter(r => r.competitor_brand === brand).reduce((s,r) => s + r.estimated_clicks, 0);
                return total > 0 ? (bClicks / total) * 100 : 0;
            };

            const rowData = [w, getShare(myBrand)];
            let topCompShare = 0;
            topCompetitors.forEach(c => {
                const s = getShare(c);
                rowData.push(s);
                topCompShare += s;
            });
            
            // "Others" is 100 - (Mine + Top3)
            rowData.push(Math.max(0, 100 - (rowData[1] + topCompShare)));
            data.addRow(rowData);
        });

        const options = {
            curveType: 'function',
            colors: ['#0071e3', '#ff3b30', '#ff9500', '#af52de', '#86868b'],
            chartArea: { width: '85%', height: '75%' },
            legend: { position: 'bottom' },
            vAxis: { format: '#\'%\'' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_brand_share'));
        chart.draw(data, options);

        // Fill Text Info
        document.getElementById('top-competitors-list').innerHTML = topCompetitors.map(c => `<li>${c}</li>`).join('');
        
        // Domianance logic
        const lastW = uniqueWeeks[uniqueWeeks.length-1];
        const lastRows = cleanData.filter(d => d.week_date === lastW);
        const myRank = lastRows.filter(r => r.competitor_brand === myBrand).reduce((s,r) => s + r.click_share, 0); // approx share sum
        // Simply check ranking in the generated data
        const lastRowIdx = data.getNumberOfRows() - 1;
        const myLastShare = data.getValue(lastRowIdx, 1);
        const comp1Share = data.getValue(lastRowIdx, 2);
        
        if (myLastShare > comp1Share) {
            document.getElementById('brand-dominance-text').innerText = `Lideramos la categor√≠a esta semana con un ${formatNum(myLastShare)}% de cuota.`;
            document.getElementById('brand-dominance-text').classList.add('text-blue');
        } else {
            document.getElementById('brand-dominance-text').innerText = `Seguimos al l√≠der con un ${formatNum(myLastShare)}% (L√≠der: ${formatNum(comp1Share)}%).`;
        }
    }

    // ---------------------------------------------------------
    // SECTION 3: LEVERS TABLE
    // ---------------------------------------------------------
    function drawLeversTable() {
        // Logic: Calculate Average Click Share for My Brand when lever is ON vs OFF
        // Since we aggregate at Parent level, we check if ANY ASIN of ours had the lever
        
        const levers = [
            { id: 'deal', col: 'weekly_number_of_days_with_deal', label: 'Deals' },
            { id: 'coupon', col: 'weekly_number_of_days_with_coupon', label: 'Cupones' },
            { id: 'choice', col: 'weekly_number_of_days_with_amazon_choice_badge', label: 'Amz Choice' }
        ];

        const myRows = cleanData.filter(r => r.competitor_brand === myBrand);
        
        const tableData = [['Palanca', 'Share Prom. (Activo)', 'Share Prom. (Inactivo)', 'Impacto']];
        
        levers.forEach(lev => {
            const onRows = myRows.filter(r => r[lev.col] > 0);
            const offRows = myRows.filter(r => r[lev.col] === 0);
            
            const avgOn = onRows.length ? onRows.reduce((s,r) => s + r.click_share, 0) / onRows.length : 0;
            const avgOff = offRows.length ? offRows.reduce((s,r) => s + r.click_share, 0) / offRows.length : 0;
            
            const impact = avgOff > 0 ? ((avgOn - avgOff)/avgOff)*100 : 0;
            
            tableData.push([
                lev.label, 
                {v: avgOn, f: formatNum(avgOn)+'%'}, 
                {v: avgOff, f: formatNum(avgOff)+'%'}, 
                {v: impact, f: (impact > 0 ? '+' : '') + formatNum(impact) + '%', p: {style: impact > 0 ? 'color:green;font-weight:bold' : 'color:red'}}
            ]);
        });

        const data = google.visualization.arrayToDataTable(tableData);
        const table = new google.visualization.Table(document.getElementById('table_levers'));
        table.draw(data, {allowHtml: true, width: '100%', cssClassNames: {headerRow: 'simple-header'}});
    }

    // ---------------------------------------------------------
    // SECTION 4: EFFICIENCY
    // ---------------------------------------------------------
    function drawEfficiencyChart() {
        const lastWeek = uniqueWeeks[uniqueWeeks.length-1];
        const rows = cleanData.filter(r => r.week_date === lastWeek);

        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank Org√°nico');
        data.addColumn('number', 'Click Share');
        data.addColumn({type: 'string', role: 'tooltip'});
        data.addColumn({type: 'string', role: 'style'});

        rows.forEach(r => {
            const isMe = r.competitor_brand === myBrand;
            const color = isMe ? '#0071e3' : '#86868b';
            const tooltip = `${r.competitor_brand}\nRank: ${r.average_organic_rank}\nShare: ${r.click_share}%\nPrice: ${formatCurrency(r.price)}`;
            data.addRow([r.average_organic_rank, r.click_share, tooltip, `point { fill-color: ${color}; size: ${isMe?10:5}; }`]);
        });

        const options = {
            hAxis: { title: 'Rank Org√°nico (Menor es mejor)', direction: 1 }, // 1 because 1 is left
            vAxis: { title: 'Click Share %' },
            legend: 'none',
            chartArea: { width: '80%', height: '70%' }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
        
        document.getElementById('efficiency-insight').innerHTML = 
            `Los puntos <b style="color:#0071e3">Azules</b> somos nosotros. Si est√°n por encima de la tendencia visual de los grises, somos m√°s eficientes capturando clics para esa posici√≥n.`;
    }

    // ---------------------------------------------------------
    // SECTION 5: GENERATE INSIGHTS
    // ---------------------------------------------------------
    function generateInsights() {
        const insights = [];
        const recs = [];
        const others = [];

        // Analysis Vars
        const lastWeek = uniqueWeeks[uniqueWeeks.length-1];
        const lastRows = cleanData.filter(d => d.week_date === lastWeek);
        const myLastRows = lastRows.filter(r => r.competitor_brand === myBrand);
        
        // 1. Price Competitiveness
        const myAvgPrice = myLastRows.length ? myLastRows.reduce((s,r) => s+r.price,0)/myLastRows.length : 0;
        const marketAvgPrice = lastRows.length ? lastRows.reduce((s,r) => s+r.price,0)/lastRows.length : 0;
        
        if (myAvgPrice > marketAvgPrice * 1.1) {
            insights.push(`Tu precio promedio (${formatCurrency(myAvgPrice)}) es superior al del mercado (${formatCurrency(marketAvgPrice)}). Esto puede limitar el Click Share si no hay diferenciaci√≥n clara.`);
            recs.push("Evaluar una estrategia de precios promocionales o cupones para reducir la barrera de entrada.");
        } else {
            insights.push(`Tu posicionamiento de precio es competitivo (${formatCurrency(myAvgPrice)} vs ${formatCurrency(marketAvgPrice)} avg mercado).`);
        }

        // 2. Rank Efficiency
        const myBestRank = Math.min(...myLastRows.map(r => r.average_organic_rank));
        if (myBestRank > 5) {
            insights.push(`Tu mejor posici√≥n org√°nica es ${myBestRank}. Est√°s fuera del Top 5 visible.`);
            recs.push("Incrementar puja en PPC para keywords principales y mejorar CTR con imagen principal optimizada.");
        } else {
            insights.push(`Tienes visibilidad org√°nica fuerte (Top Rank: ${myBestRank}).`);
        }

        // 3. Deals Impact (from logic in section 3)
        // Check if competitors have deals
        const compsWithDeals = lastRows.filter(r => r.competitor_brand !== myBrand && r.weekly_number_of_days_with_deal > 0).length;
        if (compsWithDeals > 0) {
            insights.push(`${compsWithDeals} ASINs competidores est√°n activos con Deals esta semana.`);
            others.push("Monitorear agresividad promocional de competidores emergentes.");
        }

        // 4. Global Trend
        if (uniqueWeeks.length === 1) {
            insights.push("Reporte basado en snapshot semanal (sin hist√≥rico suficiente para tendencia).");
        }

        // 5. Anomalies
        const zeroShare = myLastRows.filter(r => r.click_share === 0);
        if (zeroShare.length > 0) {
            others.push(`${zeroShare.length} de tus variantes tienen 0% de Click Share a pesar de estar indexadas.`);
            recs.push("Revisar variantes sin tr√°fico: ¬øMalas keywords o contenido deficiente?");
        }

        // Populate HTML
        const fillList = (id, list) => {
            const el = document.getElementById(id);
            el.innerHTML = list.length ? list.map(t => `<li>${t}</li>`).join('') : '<li>Sin datos suficientes.</li>';
        };

        fillList('final-insights', insights);
        fillList('final-recommendations', recs);
        fillList('other-insights-list', others);
    }

    // ---------------------------------------------------------
    // TAB 2: INTERACTIVE
    // ---------------------------------------------------------
    function switchTab(tab) {
        if(tab === 'static') {
            document.getElementById('tab-static').classList.remove('hidden');
            document.getElementById('tab-interactive').classList.add('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        } else {
            document.getElementById('tab-static').classList.add('hidden');
            document.getElementById('tab-interactive').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            // Redraw invisible charts fix
            updateInteractive();
        }
    }

    function populateInteractiveControls() {
        const weekSel = document.getElementById('select-week');
        uniqueWeeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.innerText = w;
            weekSel.appendChild(opt);
        });
        weekSel.value = uniqueWeeks[uniqueWeeks.length-1];

        const compSel = document.getElementById('select-competitor');
        const brands = [...new Set(cleanData.map(d => d.competitor_brand))].filter(b => b !== myBrand).sort();
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            compSel.appendChild(opt);
        });
        if(brands.length > 0) compSel.value = brands[0];
    }

    function updateInteractive() {
        const week = document.getElementById('select-week').value;
        const comp = document.getElementById('select-competitor').value;
        document.getElementById('comp-name-display').innerText = comp;

        // Get Data
        const weekData = cleanData.filter(d => d.week_date === week);
        
        // Aggregate Helper
        const getStats = (brand) => {
            const rows = weekData.filter(r => r.competitor_brand === brand);
            if (rows.length === 0) return { price: 0, share: 0, rank: 0, deals: 0 };
            
            const totalShare = rows.reduce((s,r) => s + r.click_share, 0);
            const avgPrice = rows.reduce((s,r) => s + r.price, 0) / rows.length;
            const avgRank = rows.reduce((s,r) => s + r.average_organic_rank, 0) / rows.length;
            const hasDeal = rows.some(r => r.weekly_number_of_days_with_deal > 0) ? "S√≠" : "No";
            
            return { price: avgPrice, share: totalShare, rank: avgRank, deals: hasDeal };
        };

        const myStats = getStats(myBrand);
        const compStats = getStats(comp);

        // Render Cards
        const renderStatHTML = (s) => `
            <div style="font-size:3rem; font-weight:700;">${formatNum(s.share)}%</div>
            <div style="color:#666; margin-bottom:10px;">Click Share</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left; font-size:0.9rem;">
                <div>üè∑Ô∏è Precio: <b>${formatCurrency(s.price)}</b></div>
                <div>üèÜ Rank: <b>${formatNum(s.rank)}</b></div>
                <div>‚ö° Deal: <b>${s.deals}</b></div>
            </div>
        `;

        document.getElementById('my-stats').innerHTML = renderStatHTML(myStats);
        document.getElementById('comp-stats').innerHTML = renderStatHTML(compStats);

        // Render Comparison Chart
        const data = google.visualization.arrayToDataTable([
            ['M√©trica', 'Nosotros', comp],
            ['Share %', myStats.share, compStats.share],
            ['Precio (‚Ç¨)', myStats.price, compStats.price],
            ['Rank (Invertido)', 20 - myStats.rank, 20 - compStats.rank] // Invert rank for visual (higher bar is better)
        ]);

        const options = {
            title: 'Comparativa Directa (Rank normalizado a barra)',
            colors: ['#0071e3', '#ff3b30'],
            chartArea: { width: '70%', height: '70%' },
            vAxis: { minValue: 0 }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_interactive_comparison'));
        chart.draw(data, options);
    }

</script>
</body>
</html>