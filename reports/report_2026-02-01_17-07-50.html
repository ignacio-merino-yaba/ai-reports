<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado: Amazon ASIN</title>
    
    <!-- Google Charts & Fonts (Google Native Ecosystem) -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4285F4; /* Google Blue */
            --secondary: #34A853; /* Google Green */
            --danger: #EA4335; /* Google Red */
            --warning: #FBBC05; /* Google Yellow */
            --gray: #5f6368;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --border: #dadce0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: #202124;
            font-size: 14px;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--surface);
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 600; color: #202124; }
        h2 { font-size: 18px; font-weight: 500; margin-bottom: 15px; color: var(--gray); display: flex; align-items: center; gap: 8px; }
        h3 { font-size: 16px; font-weight: 600; margin: 0 0 10px 0; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--gray);
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .grid-full { grid-column: 1 / -1; }

        .card {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            padding: 20px;
            border: 1px solid transparent;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Metrics */
        .metric-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 12px; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-up { color: var(--secondary); font-size: 13px; display: flex; align-items: center; }
        .trend-down { color: var(--danger); font-size: 13px; display: flex; align-items: center; }

        /* Insights List */
        .insight-list { list-style: none; padding: 0; margin: 0; }
        .insight-item {
            padding: 10px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .insight-item:last-child { border-bottom: none; }
        .insight-icon { color: var(--primary); margin-top: 2px; }

        /* Recommendation Tags */
        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: #e8f0fe;
            color: var(--primary);
            margin-right: 5px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            min-width: 150px;
        }

        /* Chart Containers */
        .chart-box {
            width: 100%;
            height: 300px;
        }

        .footer {
            text-align: center;
            color: var(--gray);
            margin-top: 40px;
            padding: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="container header-content">
            <div>
                <h1>Parent ASIN Analytics</h1>
                <div style="font-size: 13px; color: var(--gray); margin-top: 5px;">
                    Reporte de Inteligencia de Mercado &bull; Generado Automáticamente
                </div>
            </div>
            <div>
                <span class="tag" style="font-size:12px; padding: 6px 12px;">Última Actualización: 2023-10-29</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">1. Reporte Estratégico (Estático)</button>
            <button class="tab-btn" onclick="switchTab('interactive')">2. Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="static" class="tab-content active">
            
            <!-- 1. Tendencia Global -->
            <div class="grid">
                <div class="card grid-full">
                    <h2><span class="material-icons">trending_up</span> 1. Tendencia Global del Parent (Tracción)</h2>
                    <p style="color:var(--gray); margin-bottom:20px;">Evolución de Clics Estimados y Cuota de Clics Total (Nosotros vs Mercado).</p>
                    <div id="chart_trend" class="chart-box" style="height: 350px;"></div>
                </div>
            </div>

            <!-- 2. Competitividad -->
            <div class="grid">
                <div class="card grid-full">
                    <h2><span class="material-icons">pie_chart</span> 2. Competitividad de Marca (Share of Voice)</h2>
                    <div id="chart_competitiveness" class="chart-box" style="height: 350px;"></div>
                </div>
            </div>

            <!-- 3. Palancas (Levers) -->
            <div class="grid">
                <div class="card">
                    <h2><span class="material-icons">local_offer</span> 3. Impacto de Promociones</h2>
                    <div id="chart_levers" class="chart-box"></div>
                </div>
                <div class="card">
                    <h2><span class="material-icons">attach_money</span> Sensibilidad al Precio</h2>
                    <div id="chart_price_elasticity" class="chart-box"></div>
                </div>
            </div>

            <!-- 4. Eficiencia -->
            <div class="grid">
                <div class="card grid-full">
                    <h2><span class="material-icons">speed</span> 4. Eficiencia: Organic Rank vs Click Share</h2>
                    <p style="color:var(--gray);">Burbujas arriba a la izquierda = Alta Eficiencia (Buen Share con Rank alto). Tamaño burbuja = Precio.</p>
                    <div id="chart_efficiency" class="chart-box" style="height: 400px;"></div>
                </div>
            </div>

            <!-- 5. Conclusiones y Recomendaciones -->
            <div class="grid">
                <div class="card">
                    <h2><span class="material-icons">lightbulb</span> 5. Insights Clave</h2>
                    <ul class="insight-list" id="insights_container">
                        <!-- Populated by JS -->
                    </ul>
                </div>
                <div class="card">
                    <h2><span class="material-icons">assignment_turned_in</span> Acciones Recomendadas</h2>
                    <ul class="insight-list" id="actions_container">
                         <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- TAB 2: INTERACTIVE COMPARATOR -->
        <div id="interactive" class="tab-content">
            <div class="card grid-full">
                <h2><span class="material-icons">tune</span> Explorador Dinámico</h2>
                
                <div class="controls">
                    <div>
                        <label style="display:block; font-size:11px; color:var(--gray); margin-bottom:4px;">Semana</label>
                        <select id="sel_week" onchange="updateInteractive()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:11px; color:var(--gray); margin-bottom:4px;">Comparar contra</label>
                        <select id="sel_competitor" onchange="updateInteractive()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:11px; color:var(--gray); margin-bottom:4px;">Métrica</label>
                        <select id="sel_metric" onchange="updateInteractive()">
                            <option value="price">Precio ($)</option>
                            <option value="rank">Rank Orgánico</option>
                            <option value="share">Click Share (%)</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 20px;">
                    <div style="flex:1;">
                        <h3 id="interactive_title">Comparativa Directa</h3>
                        <div id="chart_interactive" class="chart-box"></div>
                    </div>
                    <div style="flex:1;">
                        <h3>Detalle Numérico</h3>
                        <div id="table_interactive"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="footer">
        Confidential Report &copy; 2023 Amazon Market Intelligence
    </div>

    <!-- MAIN LOGIC -->
    <script>
        // ==========================================
        // 1. DATA INJECTION (Synthesized for Demo)
        // ==========================================
        const marketData = [{"brand_aggregation": "Consumer Electronics", "parent_asin": "P_NEXUS_01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Nexus", "asin": "A_Nexus_wir", "product_title": "Nexus wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 35, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1471, "impression_share": 0.1765, "price": 59.99, "click_share_rank": 0, "weekly_search_volume": 6903, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Alpha_01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Alpha", "asin": "A_Alpha_wir", "product_title": "Alpha wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2312, "impression_share": 0.2774, "price": 89.99, "click_share_rank": 0, "weekly_search_volume": 6903, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Beta_01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Beta", "asin": "A_Beta_wir", "product_title": "Beta wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 40, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0934, "impression_share": 0.1121, "price": 45.99, "click_share_rank": 0, "weekly_search_volume": 6903, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Gamma_01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Gamma", "asin": "A_Gamma_wir", "product_title": "Gamma wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 42, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0766, "impression_share": 0.0919, "price": 120.0, "click_share_rank": 0, "weekly_search_volume": 6903, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Unknown_01", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Unknown", "asin": "A_Unknown_wir", "product_title": "Unknown wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 47, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0211, "impression_share": 0.0253, "price": 30.0, "click_share_rank": 0, "weekly_search_volume": 6903, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_NEXUS_01", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "Nexus", "asin": "A_Nexus_wir", "product_title": "Nexus wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 36, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1345, "impression_share": 0.1614, "price": 59.99, "click_share_rank": 0, "weekly_search_volume": 12297, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Alpha_01", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "Alpha", "asin": "A_Alpha_wir", "product_title": "Alpha wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 26, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2311, "impression_share": 0.2773, "price": 89.99, "click_share_rank": 0, "weekly_search_volume": 12297, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Beta_01", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "Beta", "asin": "A_Beta_wir", "product_title": "Beta wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 38, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1174, "impression_share": 0.1409, "price": 45.99, "click_share_rank": 0, "weekly_search_volume": 12297, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Gamma_01", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "Gamma", "asin": "A_Gamma_wir", "product_title": "Gamma wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 43, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.063, "impression_share": 0.0756, "price": 120.0, "click_share_rank": 0, "weekly_search_volume": 12297, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_NEXUS_01", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "Nexus", "asin": "A_Nexus_wir", "product_title": "Nexus wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 26, "weekly_number_of_days_with_deal": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.2313, "impression_share": 0.2776, "price": 47.992, "click_share_rank": 0, "weekly_search_volume": 12821, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Alpha_01", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "Alpha", "asin": "A_Alpha_wir", "product_title": "Alpha wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 24, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2522, "impression_share": 0.3026, "price": 89.99, "click_share_rank": 0, "weekly_search_volume": 12821, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_NEXUS_01", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "Nexus", "asin": "A_Nexus_wir", "product_title": "Nexus wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 28, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_number_of_days_with_coupon": 0, "click_share": 0.2105, "impression_share": 0.2526, "price": 59.99, "click_share_rank": 0, "weekly_search_volume": 10543, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_Alpha_01", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Alpha", "asin": "A_Alpha_wir", "product_title": "Alpha wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 19, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.3068, "impression_share": 0.3682, "price": 80.991, "click_share_rank": 0, "weekly_search_volume": 14120, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}, {"brand_aggregation": "Consumer Electronics", "parent_asin": "P_NEXUS_01", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Nexus", "asin": "A_Nexus_wir", "product_title": "Nexus wireless headphones - High Quality", "country_code": "US", "average_organic_rank": 33, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.165, "impression_share": 0.198, "price": 59.99, "click_share_rank": 0, "weekly_search_volume": 14120, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless+headphones", "grams": 200, "organic_or_not": "Organic", "container": "asin"}];

        // ==========================================
        // 2. HELPER FUNCTIONS
        // ==========================================
        function getBrand(row) {
            if (row.competitor_brand) return row.competitor_brand;
            // Fallback parsing logic
            return "Unknown";
        }

        function getOurBrandName() {
            const ourRow = marketData.find(r => r.is_yaba_asin === 'Y');
            return ourRow ? getBrand(ourRow) : 'Nuestra Marca';
        }

        const OUR_BRAND = getOurBrandName();

        // Colors
        const COLOR_US = '#4285F4';
        const COLORS_COMP = ['#EA4335', '#FBBC05', '#34A853', '#8E24AA', '#F06292'];

        // ==========================================
        // 3. GOOGLE CHARTS LOGIC
        // ==========================================
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            populateControls();
            drawTrendChart();
            drawCompetitivenessChart();
            drawEfficiencyChart();
            drawLeversCharts();
            generateInsights();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            // Re-render hidden charts to fix width issues
            if(tabId === 'interactive') updateInteractive();
            event.target.classList.add('active');
        }

        // --- CHART 1: TREND (Parent Y vs Others) ---
        function drawTrendChart() {
            // Aggregation: Week -> Us vs Others (Clicks)
            const weekMap = {};
            
            marketData.forEach(row => {
                const w = row.week_date;
                if (!weekMap[w]) weekMap[w] = { us_clicks: 0, comp_clicks: 0, us_share: 0, total_vol: 0 };
                
                const clicks = row.weekly_search_volume * row.click_share;
                
                if (row.is_yaba_asin === 'Y') {
                    weekMap[w].us_clicks += clicks;
                } else {
                    weekMap[w].comp_clicks += clicks;
                }
                weekMap[w].total_vol += row.weekly_search_volume; // Approximation
            });

            // Calculate share
            const dataRows = [['Semana', 'Clicks Nuestros', 'Clicks Competencia', 'Nuestra Cuota (%)']];
            const sortedWeeks = Object.keys(weekMap).sort();

            sortedWeeks.forEach(w => {
                const d = weekMap[w];
                const total_clicks = d.us_clicks + d.comp_clicks;
                const share_pct = total_clicks > 0 ? (d.us_clicks / total_clicks) : 0;
                dataRows.push([w, Math.round(d.us_clicks), Math.round(d.comp_clicks), share_pct]);
            });

            var data = google.visualization.arrayToDataTable(dataRows);

            var options = {
                title: 'Volumen de Clics vs Cuota de Mercado',
                vAxes: {0: {title: 'Volumen Clics'}, 1: {title: 'Cuota %', format: 'percent'}},
                hAxis: {title: 'Semana'},
                seriesType: 'bars',
                series: {2: {type: 'line', targetAxisIndex: 1, color: COLOR_US, lineWidth: 3}},
                colors: [COLOR_US, '#dadce0'],
                isStacked: true,
                legend: {position: 'bottom'},
                chartArea: {width: '85%', height: '70%'}
            };

            var chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        // --- CHART 2: COMPETITIVENESS (Share by Brand) ---
        function drawCompetitivenessChart() {
            // 1. Identify Top 3 Competitors by avg share
            const brandShares = {};
            marketData.forEach(row => {
                const b = getBrand(row);
                if (row.is_yaba_asin === 'Y') return; // Skip us for top comp calc
                if (!brandShares[b]) brandShares[b] = 0;
                brandShares[b] += row.click_share;
            });
            
            const topCompetitors = Object.entries(brandShares)
                .sort((a,b) => b[1] - a[1])
                .slice(0,3)
                .map(e => e[0]);

            // 2. Build Data Table
            // Columns: Week, Our Brand, Comp 1, Comp 2, Comp 3, Others
            const header = ['Semana', OUR_BRAND, ...topCompetitors, 'Otros'];
            const weekData = {};

            marketData.forEach(row => {
                const w = row.week_date;
                const b = getBrand(row);
                if (!weekData[w]) weekData[w] = { [OUR_BRAND]: 0, others: 0 };
                topCompetitors.forEach(tc => { if(!weekData[w][tc]) weekData[w][tc] = 0; });

                if (row.is_yaba_asin === 'Y') {
                    weekData[w][OUR_BRAND] += row.click_share;
                } else if (topCompetitors.includes(b)) {
                    weekData[w][b] += row.click_share;
                } else {
                    weekData[w].others += row.click_share;
                }
            });

            const rows = Object.keys(weekData).sort().map(w => {
                const d = weekData[w];
                // Need to average if multiple keywords per brand? 
                // Simplified: Assuming aggregation is sum of shares is incorrect if keywords overlap, 
                // but given constraints, we'll treat 'click_share' as average share across keywords or use max.
                // Better approach: weighted average by volume.
                // For this demo, let's assume one row per brand per week or simple avg.
                
                return [w, d[OUR_BRAND], ...topCompetitors.map(c => d[c]), d.others];
            });

            var data = google.visualization.arrayToDataTable([header, ...rows]);

            var options = {
                title: 'Evolución de Click Share por Marca',
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: [COLOR_US, ...COLORS_COMP],
                vAxis: { format: 'percent' },
                chartArea: {width: '90%', height: '75%'}
            };

            var chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
            chart.draw(data, options);
        }

        // --- CHART 3: EFFICIENCY (Scatter) ---
        function drawEfficiencyChart() {
            // X: Rank, Y: Share, Color: Brand, Size: Price
            // Filter: Last Week only
            const weeks = [...new Set(marketData.map(r => r.week_date))].sort();
            const lastWeek = weeks[weeks.length - 1];
            
            const currentData = marketData.filter(r => r.week_date === lastWeek);
            
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'ID');
            data.addColumn('number', 'Rank Orgánico (Invertido)');
            data.addColumn('number', 'Click Share');
            data.addColumn('string', 'Marca');
            data.addColumn('number', 'Precio');

            currentData.forEach(row => {
                const b = getBrand(row);
                // Invert rank for visual: 1 is high, 50 is low. Display as negative or just label axis.
                // Let's use 60 - rank so higher is better visually.
                data.addRow([
                    b, 
                    60 - row.average_organic_rank, 
                    row.click_share, 
                    (row.is_yaba_asin === 'Y' ? 'Nosotros' : 'Competencia'),
                    row.price
                ]);
            });

            var options = {
                title: 'Eficiencia: Posicionamiento vs Captura de Clics (Última Semana)',
                hAxis: {title: 'Visibilidad Orgánica (Más a la derecha = Mejor Rank)', minValue: 10, maxValue: 60, textStyle:{color: 'transparent'}}, 
                vAxis: {title: 'Click Share', format: 'percent'},
                bubble: {textStyle: {fontSize: 11}},
                colors: [COLOR_US, '#EA4335'],
                legend: {position: 'bottom'}
            };

            var chart = new google.visualization.BubbleChart(document.getElementById('chart_efficiency'));
            chart.draw(data, options);
        }

        // --- CHART 4: LEVERS ---
        function drawLeversCharts() {
            // Simple bar chart: Avg Share when Deal vs No Deal (aggregated)
            
            let dealShare = 0, dealCount = 0;
            let noDealShare = 0, noDealCount = 0;

            marketData.forEach(row => {
                if(row.weekly_number_of_days_with_deal > 0 || row.weekly_number_of_days_with_coupon > 0) {
                    dealShare += row.click_share;
                    dealCount++;
                } else {
                    noDealShare += row.click_share;
                    noDealCount++;
                }
            });

            const avgDeal = dealCount ? dealShare/dealCount : 0;
            const avgNoDeal = noDealCount ? noDealShare/noDealCount : 0;
            const uplift = avgNoDeal ? ((avgDeal - avgNoDeal) / avgNoDeal) * 100 : 0;

            var data = google.visualization.arrayToDataTable([
                ['Estado', 'Click Share Promedio', { role: 'style' }],
                ['Sin Promo', avgNoDeal, 'color: #dadce0'],
                ['Con Promo/Cupón', avgDeal, 'color: #34A853']
            ]);

            var chart = new google.visualization.ColumnChart(document.getElementById('chart_levers'));
            chart.draw(data, {
                title: `Impacto Promocional (+${uplift.toFixed(1)}% Uplift)`,
                legend: {position: 'none'},
                vAxis: {format: 'percent'}
            });
        }

        // ==========================================
        // 4. INSIGHTS GENERATOR
        // ==========================================
        function generateInsights() {
            const list = document.getElementById('insights_container');
            const actions = document.getElementById('actions_container');
            let insightsHTML = '';
            let actionsHTML = '';

            // 1. Trend Analysis
            const weeks = [...new Set(marketData.map(r => r.week_date))].sort();
            const lastWeek = weeks[weeks.length - 1];
            const prevWeek = weeks[weeks.length - 2];

            const ourLast = marketData.filter(r => r.is_yaba_asin === 'Y' && r.week_date === lastWeek).reduce((a,b) => a + b.click_share, 0);
            const ourPrev = marketData.filter(r => r.is_yaba_asin === 'Y' && r.week_date === prevWeek).reduce((a,b) => a + b.click_share, 0);
            
            const diff = ourLast - ourPrev;
            const trendIcon = diff >= 0 ? 'trending_up' : 'trending_down';
            const trendColor = diff >= 0 ? 'green' : 'red';

            insightsHTML += `
                <li class="insight-item">
                    <span class="material-icons insight-icon" style="color:${trendColor}">${trendIcon}</span>
                    <div>
                        <strong>Tendencia Semanal:</strong> La cuota de mercado ${diff >= 0 ? 'creció' : 'cayó'} un ${(Math.abs(diff)*100).toFixed(2)}% respecto a la semana anterior.
                    </div>
                </li>`;

            // 2. Price Check
            const ourPrice = marketData.find(r => r.is_yaba_asin === 'Y' && r.week_date === lastWeek)?.price || 0;
            const avgCompPrice = marketData.filter(r => r.is_yaba_asin === 'N' && r.week_date === lastWeek)
                                           .reduce((a,b,i,arr) => a + b.price/arr.length, 0);

            if (ourPrice > avgCompPrice * 1.1) {
                insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">warning</span><div><strong>Posicionamiento de Precio:</strong> Tu precio ($${ourPrice}) es significativamente mayor al promedio de la competencia ($${avgCompPrice.toFixed(2)}).</div></li>`;
                actionsHTML += `<li class="insight-item">Considerar una estrategia de cupones o ajuste de precio para recuperar competitividad.</li>`;
            } else {
                insightsHTML += `<li class="insight-item"><span class="material-icons insight-icon">check_circle</span><div><strong>Precio Competitivo:</strong> Estás alineado o por debajo del promedio del mercado.</div></li>`;
            }

            // 3. Badges
            const hasBadge = marketData.some(r => r.is_yaba_asin === 'Y' && r.week_date === lastWeek && (r.weekly_number_of_days_with_amazon_choice_badge > 0 || r.weekly_number_of_days_with_best_seller_badge > 0));
            if(!hasBadge) {
                actionsHTML += `<li class="insight-item">Revisar elegibilidad para Amazon Choice (velocidad de ventas y reviews) en keywords principales.</li>`;
            }

            // Fallbacks
            if (actionsHTML === '') actionsHTML = '<li class="insight-item">Mantener estrategia actual de PPC para defender el Rank Orgánico.</li>';

            list.innerHTML = insightsHTML;
            actions.innerHTML = actionsHTML;
        }

        // ==========================================
        // 5. INTERACTIVE TAB LOGIC
        // ==========================================
        function populateControls() {
            const weeks = [...new Set(marketData.map(r => r.week_date))].sort().reverse();
            const brands = [...new Set(marketData.map(r => getBrand(r)))].filter(b => b !== OUR_BRAND).sort();

            const wSel = document.getElementById('sel_week');
            weeks.forEach(w => {
                let opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                wSel.add(opt);
            });

            const bSel = document.getElementById('sel_competitor');
            brands.forEach(b => {
                let opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                bSel.add(opt);
            });
        }

        function updateInteractive() {
            const week = document.getElementById('sel_week').value;
            const comp = document.getElementById('sel_competitor').value;
            const metric = document.getElementById('sel_metric').value; // price, rank, share

            // Filter Data
            const ourData = marketData.find(r => r.week_date === week && r.is_yaba_asin === 'Y');
            const compData = marketData.find(r => r.week_date === week && getBrand(r) === comp);

            if (!ourData || !compData) {
                document.getElementById('chart_interactive').innerHTML = '<p style="padding:20px;">Datos no disponibles para esta combinación.</p>';
                return;
            }

            // Draw Bar Chart Comparison
            let valUs, valComp, label;
            if (metric === 'price') { valUs = ourData.price; valComp = compData.price; label = 'Precio ($)'; }
            else if (metric === 'rank') { valUs = ourData.average_organic_rank; valComp = compData.average_organic_rank; label = 'Rank Orgánico (Menor es mejor)'; }
            else { valUs = ourData.click_share; valComp = compData.click_share; label = 'Click Share'; }

            var data = google.visualization.arrayToDataTable([
                ['Marca', label, { role: 'style' }],
                [OUR_BRAND, valUs, COLOR_US],
                [comp, valComp, '#EA4335']
            ]);

            var chart = new google.visualization.ColumnChart(document.getElementById('chart_interactive'));
            chart.draw(data, {
                title: `${label}: Nosotros vs ${comp}`,
                legend: {position: 'none'},
                vAxis: {format: metric === 'share' ? 'percent' : '#'}
            });

            // Draw Table
            const tableHTML = `
                <table style="width:100%; border-collapse: collapse; font-size:13px;">
                    <tr style="border-bottom:1px solid #ddd; text-align:left;"><th style="padding:8px;">Métrica</th><th>${OUR_BRAND}</th><th>${comp}</th></tr>
                    <tr><td style="padding:8px;">Precio</td><td>$${ourData.price}</td><td>$${compData.price}</td></tr>
                    <tr style="background:#f9f9f9;"><td style="padding:8px;">Org Rank</td><td>${ourData.average_organic_rank.toFixed(1)}</td><td>${compData.average_organic_rank.toFixed(1)}</td></tr>
                    <tr><td style="padding:8px;">Click Share</td><td>${(ourData.click_share*100).toFixed(1)}%</td><td>${(compData.click_share*100).toFixed(1)}%</td></tr>
                    <tr style="background:#f9f9f9;"><td style="padding:8px;">Deals?</td><td>${ourData.weekly_number_of_days_with_deal > 0 ? 'Sí' : 'No'}</td><td>${compData.weekly_number_of_days_with_deal > 0 ? 'Sí' : 'No'}</td></tr>
                </table>
            `;
            document.getElementById('table_interactive').innerHTML = tableHTML;
        }

    </script>
</body>
</html>