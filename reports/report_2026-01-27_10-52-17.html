<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado: Matcha Premium</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* CSS Reset & Base Styles (Apple-like / Clean) */
        :root {
            --primary-blue: #4285F4;
            --success-green: #34A853;
            --warning-orange: #FBBC05;
            --danger-red: #EA4335;
            --gray-bg: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-dark: #1D1D1F;
            --text-light: #86868B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--gray-bg);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .badge {
            background: #E8F0FE;
            color: var(--primary-blue);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            border-bottom: 1px solid #E5E5E5;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            position: relative;
        }
        .tab-btn.active {
            color: var(--primary-blue);
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-blue);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid System */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }
        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }

        /* KPI Cards */
        .kpi-value { font-size: 32px; font-weight: 700; color: var(--text-dark); }
        .kpi-label { font-size: 14px; color: var(--text-light); margin-top: 4px; }
        .kpi-trend { font-size: 12px; font-weight: 500; margin-left: 8px; }
        .trend-up { color: var(--success-green); }
        .trend-down { color: var(--danger-red); }

        /* Insights List */
        .insight-list { list-style: none; padding: 0; }
        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.5;
        }
        .insight-icon { color: var(--primary-blue); min-width: 24px; }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #E5E5E5;
            font-size: 14px;
            background-color: #fff;
            outline: none;
            min-width: 200px;
        }

        /* Data Table */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #F0F0F0; }
        th { font-weight: 600; color: var(--text-light); font-size: 12px; text-transform: uppercase; }
        td { font-size: 14px; }
        .product-link { color: var(--primary-blue); text-decoration: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .col-8, .col-6, .col-4 { grid-column: span 12; }
            .header-content { flex-direction: column; align-items: flex-start; gap: 12px; }
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- DATA INJECTION -->
    <script>
        // Data processed from CSV
        const marketData = [{"week_date":"2026-01","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","competitor_brand":"bioKontor","is_yaba_asin":"N","click_share":2.39,"estimated_clicks":645.609266,"average_organic_rank":10.0,"price":11.9975,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2026-01","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","competitor_brand":"bioKontor","is_yaba_asin":"N","click_share":2.39,"estimated_clicks":645.609266,"average_organic_rank":10.0,"price":11.9975,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2025-52","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","competitor_brand":"bioKontor","is_yaba_asin":"N","click_share":2.44,"estimated_clicks":1163.819976,"average_organic_rank":10.0,"price":12.367142857,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2025-52","asin":"B08XVX8V1T","product_title":"Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...","competitor_brand":"bioKontor","is_yaba_asin":"N","click_share":2.44,"estimated_clicks":1163.819976,"average_organic_rank":10.0,"price":12.367142857,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2025-52","asin":"B0CNRX8G5S","product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","competitor_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":18.77,"estimated_clicks":8952.828258,"average_organic_rank":2.0,"price":24.648571429,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2026-01","asin":"B0CNRX8G5S","product_title":"Ceremonial Matcha - Reines Matcha Pulver aus Japan...","competitor_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":19.34,"estimated_clicks":5224.302596,"average_organic_rank":2.0,"price":23.91,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2026-01","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","competitor_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":7.38,"estimated_clicks":1993.554972,"average_organic_rank":6.0,"price":15.5575,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2026-01","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","competitor_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":7.38,"estimated_clicks":1993.554972,"average_organic_rank":6.0,"price":15.5575,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2025-52","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","competitor_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":8.42,"estimated_clicks":4016.132868,"average_organic_rank":6.0,"price":16.037142857,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2025-52","asin":"B0FSL3C3Z8","product_title":"Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...","competitor_brand":"NORITUAL LAB","is_yaba_asin":"N","click_share":8.42,"estimated_clicks":4016.132868,"average_organic_rank":6.0,"price":16.037142857,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2026-01","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","competitor_brand":"Special Leaves","is_yaba_asin":"N","click_share":3.0,"estimated_clicks":810.3882,"average_organic_rank":16.0,"price":10.39,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2026-01","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","competitor_brand":"Special Leaves","is_yaba_asin":"N","click_share":3.0,"estimated_clicks":810.3882,"average_organic_rank":16.0,"price":10.39,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":4,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2025-52","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","competitor_brand":"Special Leaves","is_yaba_asin":"N","click_share":3.4,"estimated_clicks":1621.71636,"average_organic_rank":13.0,"price":10.71,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2025-52","asin":"B0DRP6Y6XC","product_title":"Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...","competitor_brand":"Special Leaves","is_yaba_asin":"N","click_share":3.4,"estimated_clicks":1621.71636,"average_organic_rank":13.0,"price":10.71,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":7,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2026-01","asin":"B07SZFD3P9","product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","competitor_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":2.68,"estimated_clicks":723.946792,"average_organic_rank":100.0,"price":30.27,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2025-52","asin":"B07SZFD3P9","product_title":"NaturaleBio Matcha Ceremonial Grade 100g. Original...","competitor_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":2.93,"estimated_clicks":1397.537922,"average_organic_rank":23.0,"price":30.704285714,"weekly_number_of_days_with_deal":1,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2026-01","asin":"B06XQ69YCQ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","competitor_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.35,"estimated_clicks":904.93349,"average_organic_rank":5.0,"price":10.2225,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2025-52","asin":"B079VQ52MK","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","competitor_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.49,"estimated_clicks":1664.644146,"average_organic_rank":5.0,"price":24.855714286,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2026-01","asin":"B079VQ52MK","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","competitor_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.66,"estimated_clicks":988.673604,"average_organic_rank":5.0,"price":24.5275,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2025-52","asin":"B06XQ69YCQ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","competitor_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":3.75,"estimated_clicks":1788.65775,"average_organic_rank":4.0,"price":10.538571429,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2025-52","asin":"B06XQ5DCYJ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","competitor_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":11.66,"estimated_clicks":5561.533164,"average_organic_rank":2.0,"price":15.058571429,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2026-01","asin":"B06XQ5DCYJ","product_title":"NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...","competitor_brand":"NaturaleBio","is_yaba_asin":"Y","click_share":12.9,"estimated_clicks":3484.66926,"average_organic_rank":2.0,"price":14.6075,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2026-01","asin":"B0F9B1LWQQ","product_title":"UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...","competitor_brand":"UNREAL","is_yaba_asin":"N","click_share":1.57,"estimated_clicks":424.103158,"average_organic_rank":19.0,"price":31.2725,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2026-01","asin":"B07MD4LB49","product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","competitor_brand":"VAHDAM","is_yaba_asin":"N","click_share":3.15,"estimated_clicks":850.90761,"average_organic_rank":9.0,"price":10.43,"weekly_number_of_days_with_deal":0,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":27012.94,"keywords":"matcha"},{"week_date":"2025-52","asin":"B07MD4LB49","product_title":"VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...","competitor_brand":"VAHDAM","is_yaba_asin":"N","click_share":4.19,"estimated_clicks":1998.526926,"average_organic_rank":7.0,"price":9.895714286,"weekly_number_of_days_with_deal":3,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"},{"week_date":"2025-52","asin":"B07K1WBH4K","product_title":"VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...","competitor_brand":"VAHDAM","is_yaba_asin":"N","click_share":1.47,"estimated_clicks":701.153838,"average_organic_rank":20.0,"price":9.895714286,"weekly_number_of_days_with_deal":3,"weekly_number_of_days_with_coupon":0,"weekly_number_of_days_with_best_seller_badge":0,"weekly_number_of_days_with_amazon_choice_badge":0,"weekly_search_volume":47697.54,"keywords":"matcha"}];
        
        // Configuration
        const myBrand = "NaturaleBio"; // Derived from analysis
        
        // Colors
        const colors = {
            us: '#4285F4',
            comp1: '#EA4335',
            comp2: '#FBBC05',
            comp3: '#34A853',
            rest: '#9AA0A6'
        };

        // Initialize Google Charts
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            renderKPIs();
            drawTrendChart();
            drawBrandCompetitivenessChart();
            drawEfficiencyChart();
            populateInteractiveTab();
        }

        // --- SECTION 1: TRENDS ---
        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Clicks Totales');
            data.addColumn('number', 'Mi Cuota (%)');
            data.addColumn('number', 'Cuota Comp. (%)');

            // Aggregate by Week
            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            
            const rows = weeks.map(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const totalClicks = weekData.reduce((sum, d) => sum + d.estimated_clicks, 0);
                // Unique ASIN check required for Share Sum to avoid duplication? Data already unique per row
                // Sum Click Share for Me vs Others
                const myShare = weekData.filter(d => d.competitor_brand === myBrand)
                                        .reduce((sum, d) => sum + d.click_share, 0);
                const compShare = weekData.filter(d => d.competitor_brand !== myBrand)
                                          .reduce((sum, d) => sum + d.click_share, 0);
                return [week, totalClicks, myShare, compShare];
            });

            data.addRows(rows);

            const options = {
                title: 'Evoluci√≥n de Mercado: Volumen vs Visibilidad',
                seriesType: 'bars',
                series: {
                    0: { targetAxisIndex: 0, color: '#E8EAED' }, // Bars for Volume
                    1: { type: 'line', targetAxisIndex: 1, color: colors.us, lineWidth: 3 },
                    2: { type: 'line', targetAxisIndex: 1, color: colors.rest, lineDashStyle: [4, 4] }
                },
                vAxes: {
                    0: { title: 'Clicks Estimados', textStyle: {color: '#999'} },
                    1: { title: 'Click Share (%)', format: '#\'%\''}
                },
                hAxis: { title: 'Semana' },
                legend: { position: 'bottom' },
                chartArea: { width: '80%', height: '70%' }
            };

            const chart = new google.visualization.ComboChart(document.getElementById('trend_chart'));
            chart.draw(data, options);
        }

        // --- SECTION 2: COMPETITIVENESS ---
        function drawBrandCompetitivenessChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', myBrand);
            
            // Find Top 3 Competitors dynamically
            const brandShares = {};
            marketData.forEach(d => {
                if (d.competitor_brand === myBrand) return;
                brandShares[d.competitor_brand] = (brandShares[d.competitor_brand] || 0) + d.click_share;
            });
            const topCompetitors = Object.entries(brandShares)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 3)
                .map(e => e[0]);

            topCompetitors.forEach(comp => data.addColumn('number', comp));
            data.addColumn('number', 'Resto');

            const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
            
            const rows = weeks.map(week => {
                const weekData = marketData.filter(d => d.week_date === week);
                const getShare = (brand) => weekData.filter(d => d.competitor_brand === brand).reduce((s,x) => s + x.click_share, 0);
                
                const myShare = getShare(myBrand);
                const c1 = getShare(topCompetitors[0] || 'N/A');
                const c2 = getShare(topCompetitors[1] || 'N/A');
                const c3 = getShare(topCompetitors[2] || 'N/A');
                
                // Calculate Rest
                const allShare = weekData.reduce((s,x) => s + x.click_share, 0);
                const trackedShare = myShare + c1 + c2 + c3;
                const restShare = allShare - trackedShare;

                return [week, myShare, c1, c2, c3, restShare > 0 ? restShare : 0];
            });

            data.addRows(rows);

            const options = {
                title: 'Cuota de Clics por Marca',
                curveType: 'function',
                lineWidth: 2,
                colors: [colors.us, colors.comp1, colors.comp2, colors.comp3, '#E0E0E0'],
                vAxis: { title: 'Click Share (%)' },
                chartArea: { width: '85%', height: '70%' },
                legend: { position: 'bottom' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('brand_chart'));
            chart.draw(data, options);
        }

        // --- SECTION 4: EFFICIENCY ---
        function drawEfficiencyChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Rank Org√°nico (Invertido)');
            data.addColumn('number', 'Click Share (%)');
            data.addColumn({type: 'string', role: 'style'}); // Color
            data.addColumn({type: 'string', role: 'tooltip'});

            // Filter for latest week
            const latestWeek = marketData.reduce((max, p) => p.week_date > max ? p.week_date : max, marketData[0].week_date);
            const currentData = marketData.filter(d => d.week_date === latestWeek);

            const rows = currentData.map(d => {
                const isMe = d.competitor_brand === myBrand;
                const color = isMe ? `point { size: 6; fill-color: ${colors.us}; }` : 
                             (d.click_share > 5 ? `point { size: 5; fill-color: ${colors.comp1}; }` : `point { fill-color: #CCC; }`);
                
                // Rank trick: Display logic in visual is usually Rank 1 is top. 
                // Scatter chart X axis usually goes low -> high. 
                // We plot Rank directly but mentally "Left is better".
                
                return [
                    d.average_organic_rank, 
                    d.click_share, 
                    color, 
                    `${d.competitor_brand}\n${d.product_title.substring(0,30)}...\nRank: ${d.average_organic_rank}\nShare: ${d.click_share}%`
                ];
            });

            data.addRows(rows);

            const options = {
                title: 'Eficiencia: Rank Org√°nico vs Click Share (√öltima Semana)',
                hAxis: { title: 'Rank Org√°nico (Menor es Mejor)', direction: 1, viewWindow: {min: 0, max: 30} },
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                chartArea: { width: '85%', height: '70%' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('efficiency_chart'));
            chart.draw(data, options);
        }

        // --- HELPER: KPIS ---
        function renderKPIs() {
            const latestWeek = marketData.reduce((max, p) => p.week_date > max ? p.week_date : max, marketData[0].week_date);
            const prevWeek = marketData.reduce((max, p) => (p.week_date < latestWeek && p.week_date > max) ? p.week_date : max, '0000-00');
            
            // Need robust fallback if only 1 week exists
            const hasHistory = prevWeek !== '0000-00';

            const getMyShare = (w) => marketData.filter(d => d.week_date === w && d.competitor_brand === myBrand)
                                                .reduce((sum, d) => sum + d.click_share, 0);
            
            const currShare = getMyShare(latestWeek);
            const pastShare = hasHistory ? getMyShare(prevWeek) : currShare;
            const diff = currShare - pastShare;

            // Render
            document.getElementById('kpi_share').innerHTML = 
                `${currShare.toFixed(2)}% <span class="kpi-trend ${diff >= 0 ? 'trend-up' : 'trend-down'}">
                ${diff >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(diff).toFixed(2)}pp</span>`;
            
            document.getElementById('reporting_period').innerText = `Semana: ${latestWeek}`;
        }

        // --- INTERACTIVITY ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            if(tabId === 'interactive') populateInteractiveTab();
        }

        function populateInteractiveTab() {
            const weekSelect = document.getElementById('week_select');
            const compSelect = document.getElementById('comp_select');
            
            // Populate Weeks if empty
            if (weekSelect.options.length === 0) {
                const weeks = [...new Set(marketData.map(d => d.week_date))].sort().reverse();
                weeks.forEach(w => weekSelect.add(new Option(w, w)));
            }

            // Populate Competitors if empty
            if (compSelect.options.length === 0) {
                const comps = [...new Set(marketData.map(d => d.competitor_brand))].sort();
                comps.forEach(c => {
                    if(c !== myBrand) compSelect.add(new Option(c, c));
                });
            }

            updateInteractiveTable();
        }

        function updateInteractiveTable() {
            const week = document.getElementById('week_select').value;
            const comp = document.getElementById('comp_select').value;
            const container = document.getElementById('interactive_table_div');

            const myData = marketData.filter(d => d.week_date === week && d.competitor_brand === myBrand);
            const compData = marketData.filter(d => d.week_date === week && d.competitor_brand === comp);

            // Create comparisons (Aggregation per brand)
            const agg = (arr) => ({
                share: arr.reduce((s,x) => s + x.click_share, 0).toFixed(2),
                avgPrice: (arr.reduce((s,x) => s + x.price, 0) / (arr.length || 1)).toFixed(2),
                avgRank: (arr.reduce((s,x) => s + x.average_organic_rank, 0) / (arr.length || 1)).toFixed(1),
                deals: arr.reduce((s,x) => s + x.weekly_number_of_days_with_deal, 0),
                coupons: arr.reduce((s,x) => s + x.weekly_number_of_days_with_coupon, 0)
            });

            const me = agg(myData);
            const them = agg(compData);

            let html = `
                <table style="margin-top:20px;">
                    <thead>
                        <tr style="background:#f8f9fa;">
                            <th>M√©trica</th>
                            <th style="color:${colors.us}; font-size:16px;">${myBrand} (Nosotros)</th>
                            <th style="color:${colors.comp1}; font-size:16px;">${comp}</th>
                            <th>Diferencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Click Share Total</strong></td>
                            <td class="kpi-value" style="font-size:20px;">${me.share}%</td>
                            <td class="kpi-value" style="font-size:20px;">${them.share}%</td>
                            <td>${(me.share - them.share).toFixed(2)}pp</td>
                        </tr>
                        <tr>
                            <td>Precio Promedio</td>
                            <td>${me.avgPrice}‚Ç¨</td>
                            <td>${them.avgPrice}‚Ç¨</td>
                            <td>${(me.avgPrice - them.avgPrice).toFixed(2)}‚Ç¨</td>
                        </tr>
                        <tr>
                            <td>Rank Org√°nico Prom.</td>
                            <td>${me.avgRank}</td>
                            <td>${them.avgRank}</td>
                            <td>${(them.avgRank - me.avgRank).toFixed(1)} pos</td>
                        </tr>
                        <tr>
                            <td>D√≠as con Deal</td>
                            <td>${me.deals}</td>
                            <td>${them.deals}</td>
                            <td>${me.deals - them.deals}</td>
                        </tr>
                        <tr>
                            <td>D√≠as con Cup√≥n</td>
                            <td>${me.coupons}</td>
                            <td>${them.coupons}</td>
                            <td>${me.coupons - them.coupons}</td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top:24px; padding:16px; background:#e8f0fe; border-radius:8px; color:#1a73e8; font-size:14px;">
                    <strong>üí° Insight R√°pido:</strong> 
                    ${ parseFloat(me.share) > parseFloat(them.share) ? 
                       `Est√°s dominando en cuota (+${(me.share - them.share).toFixed(1)}%) a pesar de tener un precio ${ parseFloat(me.avgPrice) > parseFloat(them.avgPrice) ? 'mayor' : 'menor'}.` :
                       `${comp} te supera en cuota. Revisa si sus ${them.coupons} d√≠as de cup√≥n est√°n influyendo.`
                    }
                </div>
            `;
            
            container.innerHTML = html;
        }

    </script>

    <!-- UI STRUCTURE -->
    <div class="container">
        
        <header>
            <div class="header-content container">
                <div>
                    <span class="badge">Informe Parent ASIN</span>
                    <h1>An√°lisis de Mercado: Matcha Premium</h1>
                    <p class="kpi-label" id="reporting_period">Cargando datos...</p>
                </div>
                <div style="text-align: right;">
                    <div class="kpi-label">Cuota de Mercado (NaturaleBio)</div>
                    <div id="kpi_share" class="kpi-value">--%</div>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Ejecutivo</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- TAB 1: STATIC REPORT -->
        <div id="static" class="tab-content">
            
            <!-- Section 1: Trend -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">trending_up</span>
                    1. Tendencia Global del Parent
                </div>
                <div id="trend_chart" style="width: 100%; height: 350px;"></div>
                <div class="insight-list" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <li class="insight-item">
                        <span class="material-icons insight-icon">info</span>
                        <div>
                            <strong>Contracci√≥n Estacional:</strong> El volumen de b√∫squeda ha ca√≠do dr√°sticamente (~43%) en la √∫ltima semana (Post-Navidad), pasando de 47k a 27k clicks estimados.
                        </div>
                    </li>
                    <li class="insight-item">
                        <span class="material-icons insight-icon">check_circle</span>
                        <div>
                            <strong>Resiliencia de Marca:</strong> A pesar de la ca√≠da del mercado, <strong>NaturaleBio</strong> ha mantenido e incluso incrementado ligeramente su cuota de clicks (de 21.8% a 22.6%).
                        </div>
                    </li>
                </div>
            </div>

            <div class="grid">
                <!-- Section 2: Competitiveness -->
                <div class="col-8">
                    <div class="card" style="height: 100%;">
                        <div class="card-title">
                            <span class="material-icons">pie_chart</span>
                            2. Competitividad de Marca
                        </div>
                        <div id="brand_chart" style="width: 100%; height: 300px;"></div>
                        <p style="font-size:13px; color:#666; margin-top:10px;">
                            <strong>An√°lisis:</strong> NORITUAL LAB es el competidor dominante con cuotas cercanas al 20%. Special Leaves mantiene una posici√≥n estable. NaturaleBio (Nosotros) se mantiene s√≥lida en segunda posici√≥n agregada.
                        </p>
                    </div>
                </div>

                <!-- Section 3: Insights Text (Summary) -->
                <div class="col-4">
                    <div class="card" style="height: 100%; background: #F8F9FA;">
                        <div class="card-title">
                            <span class="material-icons">lightbulb</span>
                            5. Conclusiones Clave
                        </div>
                        <ul class="insight-list">
                            <li class="insight-item">
                                <span class="material-icons insight-icon" style="font-size:18px;">arrow_forward</span>
                                <div><strong>Dominio en Precio Premium:</strong> NaturaleBio mantiene cuota con precios estables (~24-30‚Ç¨ para ceremonial), mientras competidores como Special Leaves atacan el segmento bajo (10‚Ç¨).</div>
                            </li>
                            <li class="insight-item">
                                <span class="material-icons insight-icon" style="font-size:18px;">warning</span>
                                <div><strong>Amenaza de Cupones:</strong> Competidores como NORITUAL LAB y Special Leaves est√°n usando cupones (4-7 d√≠as/semana) agresivamente para captar tr√°fico en temporada baja.</div>
                            </li>
                            <li class="insight-item">
                                <span class="material-icons insight-icon" style="font-size:18px;">star</span>
                                <div><strong>Eficiencia Org√°nica:</strong> Tenemos ASINs con Rank Org√°nico 2 y 5 (Top of Search) que generan la mayor√≠a del tr√°fico. Proteger estas posiciones es cr√≠tico.</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 4: Efficiency -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">gps_fixed</span>
                    4. Eficiencia: Rank vs Click Share
                </div>
                <div id="efficiency_chart" style="width: 100%; height: 400px;"></div>
                <div style="margin-top:15px; font-size:14px; color:#555;">
                    <em>Eje X: Rank Org√°nico (M√°s a la izquierda es mejor posicionamiento). Eje Y: % de Clicks que se lleva el producto.</em>
                    <br>
                    Los puntos <strong>azules</strong> somos nosotros. Se observa que nuestros productos Top Rank (pos 2-5) capturan >10% de cuota, mostrando alta eficiencia.
                </div>
            </div>

            <!-- Recommendations -->
            <div class="card" style="border-left: 5px solid var(--success-green);">
                <div class="card-title" style="color: var(--success-green);">
                    <span class="material-icons">rocket_launch</span>
                    Recomendaciones Accionables
                </div>
                <div class="grid">
                    <div class="col-4">
                        <strong>1. Defensa de Posici√≥n</strong>
                        <p style="font-size:13px; color:#666;">Dado el bajo volumen de b√∫squeda actual, la conversi√≥n es clave. No subir precios en las pr√≥ximas 2 semanas para no perder el Rank 2-5 que sostiene la cuenta.</p>
                    </div>
                    <div class="col-4">
                        <strong>2. Respuesta a Cupones</strong>
                        <p style="font-size:13px; color:#666;">NORITUAL LAB usa cupones intensivos. Valorar activar un cup√≥n de 5% (clip coupon) en el ASIN B07SZFD3P9 para mejorar el CTR sin erosionar el precio base.</p>
                    </div>
                    <div class="col-4">
                        <strong>3. Optimizaci√≥n de Variantes</strong>
                        <p style="font-size:13px; color:#666;">La variante "Culinary" (precios bajos) de la competencia gana tracci√≥n. Evaluar si nuestro ASIN de entrada (B06XQ69YCQ) necesita revisi√≥n de keywords visuales.</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- TAB 2: INTERACTIVE -->
        <div id="interactive" class="tab-content hidden">
            <div class="card">
                <div class="card-title">Comparador Cara a Cara</div>
                <div class="controls">
                    <div>
                        <label style="display:block; font-size:12px; margin-bottom:4px; font-weight:600;">Semana</label>
                        <select id="week_select" onchange="updateInteractiveTable()"></select>
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; margin-bottom:4px; font-weight:600;">Competidor a Analizar</label>
                        <select id="comp_select" onchange="updateInteractiveTable()"></select>
                    </div>
                </div>
                <div id="interactive_table_div"></div>
            </div>
        </div>

    </div>

</body>
</html>