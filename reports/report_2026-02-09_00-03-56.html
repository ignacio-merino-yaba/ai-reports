<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Rendimiento: Matcha Premium</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* Google-Native Material-like Design (CSS Variables) */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC05; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --gray-100: #f8f9fa;
            --gray-200: #e8eaed;
            --gray-700: #5f6368;
            --gray-900: #202124;
            --card-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--gray-100);
            color: var(--gray-900);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Container */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { margin: 0; font-size: 24px; color: var(--primary-color); }
        .header .meta { font-size: 14px; color: var(--gray-700); }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .kpi-value { font-size: 32px; font-weight: bold; color: var(--primary-color); }
        .kpi-label { font-size: 14px; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-sub { font-size: 12px; color: var(--success-color); margin-top: 5px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            background: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Content Sections */
        .section-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gray-900);
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 10px;
        }
        
        /* Charts Containers */
        .chart-wrapper {
            width: 100%;
            min-height: 400px;
        }

        /* Insights List */
        .insights-list { list-style: none; padding: 0; }
        .insights-list li {
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 10px;
            align-items: start;
        }
        .insights-list li:last-child { border-bottom: none; }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-pos { background: #e6f4ea; color: var(--success-color); }
        .badge-neg { background: #fce8e6; color: var(--danger-color); }
        .badge-neu { background: #f1f3f4; color: var(--gray-700); }

        /* Comparison Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #dadce0;
            font-family: inherit;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    
    <!-- Header -->
    <div class="header">
        <div>
            <h1>Reporte Parent ASIN: Matcha Premium</h1>
            <div class="meta" id="date-range">Analizando última semana disponible</div>
        </div>
        <div style="text-align: right;">
            <div style="font-weight: bold; color: var(--primary-color);">Nuestras Marcas</div>
            <div id="our-brands-list">NaturaleBio, PureChimp</div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('report')">Reporte Estratégico</button>
        <button class="tab-btn" onclick="switchTab('compare')">Comparador Interactivo</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="tab-report">
        
        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Clicks (Est.)</div>
                <div class="kpi-value" id="kpi-clicks">-</div>
                <div class="kpi-sub">Mercado Total</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Nuestro Click Share</div>
                <div class="kpi-value" id="kpi-share">-</div>
                <div class="kpi-sub">Vs Competidores</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Competidor Top</div>
                <div class="kpi-value" id="kpi-top-comp" style="font-size: 24px;">-</div>
                <div class="kpi-sub" id="kpi-top-share">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Precio Promedio</div>
                <div class="kpi-value" id="kpi-price">-</div>
                <div class="kpi-sub" id="kpi-price-diff">-</div>
            </div>
        </div>

        <!-- Section 1: Trend -->
        <div class="section-card">
            <div class="section-title">
                <span class="material-icons">show_chart</span>
                1. Tendencia Global & Visibilidad (Share)
            </div>
            <div id="chart_trend" class="chart-wrapper"></div>
            <p class="meta" style="margin-top:10px;">*Barras: Volumen Clicks | Línea: Nuestro % Share</p>
        </div>

        <!-- Section 2: Competitiveness -->
        <div class="section-card">
            <div class="section-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Share vs Top 3)
            </div>
            <div id="chart_competitiveness" class="chart-wrapper"></div>
        </div>

        <!-- Section 3: Palancas -->
        <div class="section-card">
            <div class="section-title">
                <span class="material-icons">rocket_launch</span>
                3. Palancas de Conversión (Impacto)
            </div>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div id="chart_drivers" class="chart-wrapper" style="flex:1; min-width:300px;"></div>
                <div style="flex:1; min-width:300px; padding: 20px; background: #f8f9fa; border-radius:8px;">
                    <h4>Análisis de Drivers:</h4>
                    <ul class="insights-list" id="drivers-text">
                        <!-- Dynamic content -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 4: Efficiency -->
        <div class="section-card">
            <div class="section-title">
                <span class="material-icons">bubble_chart</span>
                4. Eficiencia Orgánica (Rank vs Share)
            </div>
            <div id="chart_efficiency" class="chart-wrapper"></div>
            <p class="meta">Eje X: Ranking Orgánico (Menor es mejor) | Eje Y: Click Share | Tamaño: Precio</p>
        </div>

        <!-- Section 5: Insights -->
        <div class="section-card" style="border-left: 5px solid var(--primary-color);">
            <div class="section-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones y Recomendaciones
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <div>
                    <h4 style="color:var(--gray-700)">Insights Clave</h4>
                    <ul class="insights-list" id="key-insights">
                        <!-- Injected via JS -->
                    </ul>
                </div>
                <div>
                    <h4 style="color:var(--primary-color)">Recomendaciones Accionables</h4>
                    <ul class="insights-list" id="recommendations">
                        <!-- Injected via JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="tab-compare" style="display: none;">
        <div class="controls">
            <div>
                <label>Métrica:</label>
                <select id="comp-metric" onchange="drawComparison()">
                    <option value="click_share">Click Share (%)</option>
                    <option value="price">Precio (£)</option>
                    <option value="average_organic_rank">Ranking Orgánico</option>
                </select>
            </div>
            <div>
                <label>Competidor VS:</label>
                <select id="comp-select" onchange="drawComparison()">
                    <!-- Populated by JS -->
                </select>
            </div>
        </div>
        <div class="section-card">
            <div id="chart_comparison" class="chart-wrapper"></div>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // 1. DATA INJECTION
    // ==========================================
    // Injected JSON data from Python processing
    const marketData = [{"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B06XQ5DCYJ", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "competitor_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 14.1, "estimated_clicks": 6466.25718, "price": 12.49, "average_organic_rank": 1, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 7, "weekly_search_volume": 45859.98}, {"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B079VQ52MK", "product_title": "NaturaleBio Japanese Organic Matcha Green Tea Powd...", "competitor_brand": "NaturaleBio", "is_yaba_asin": "Y", "click_share": 3.27, "estimated_clicks": 1499.6213460000001, "price": 20.99, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 45859.98}, {"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B09DQ1PWGX", "product_title": "PerfectTed Organic Matcha Powder, Ceremonial Grade...", "competitor_brand": "Perfect Ted", "is_yaba_asin": "N", "click_share": 9.0, "estimated_clicks": 4127.3982000000005, "price": 8.49, "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 45859.98}, {"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B06XTYYYJ8", "product_title": "Heapwell Matcha Powder - 50g | High Grade Japanese...", "competitor_brand": "Heapwell Superfoods", "is_yaba_asin": "N", "click_share": 5.11, "estimated_clicks": 2343.4449780000004, "price": 9.99, "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 45859.98}, {"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B082DKRSB4", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "competitor_brand": "SuperSelf", "is_yaba_asin": "N", "click_share": 3.61, "estimated_clicks": 1655.545278, "price": 19.18, "average_organic_rank": 8, "weekly_number_of_days_with_deal": 1, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 45859.98}, {"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B0F21VZMJQ", "product_title": "PerfectTed Original Matcha Powder, Ceremonial Grad...", "competitor_brand": "Perfect Ted", "is_yaba_asin": "N", "click_share": 6.24, "estimated_clicks": 2861.662752, "price": 16.99, "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 1, "weekly_search_volume": 45859.98}, {"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B00HNDSOCI", "product_title": "PureChimp Ceremonial Grade Matcha Powder 50g. 100%...", "competitor_brand": "PureChimp", "is_yaba_asin": "Y", "click_share": 2.26, "estimated_clicks": 1036.435548, "price": 12.841428571, "average_organic_rank": 12, "weekly_number_of_days_with_deal": 6, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 45859.98}, {"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B08YK2RPBZ", "product_title": "SuperSelf Organic Matcha Powder - Ceremonial Grade...", "competitor_brand": "SuperSelf", "is_yaba_asin": "N", "click_share": 13.87, "estimated_clicks": 6360.779226, "price": 9.9, "average_organic_rank": 3, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 7, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 45859.98}, {"week_date": "2026-02", "parent_asin": "Matcha Premium", "asin": "B08YRXQ2JH", "product_title": "Double Dragon | 100% Organic | Premium Matcha Gree...", "competitor_brand": "Double", "is_yaba_asin": "N", "click_share": 4.82, "estimated_clicks": 2210.451036, "price": 6.98, "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_coupon": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_search_volume": 45859.98}];

    // ==========================================
    // 2. SETUP & UTILS
    // ==========================================
    google.charts.load('current', {'packages':['corechart', 'bar']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        calculateKPIs();
        populateCompetitorDropdown();
        drawTrendChart();
        drawCompetitivenessChart();
        drawEfficiencyChart();
        drawDriversChart();
        generateInsights();
    }

    // Helper: Distinct Brands
    const myBrands = [...new Set(marketData.filter(d => d.is_yaba_asin === 'Y').map(d => d.competitor_brand))];
    const competitorBrands = [...new Set(marketData.filter(d => d.is_yaba_asin === 'N').map(d => d.competitor_brand))];
    
    // Helper: Colors
    const colorOurBrand = '#4285F4';
    const colorComp1 = '#EA4335';
    const colorComp2 = '#FBBC05';
    const colorComp3 = '#34A853';
    const colorGray = '#9AA0A6';

    // ==========================================
    // 3. LOGIC & DRAWING
    // ==========================================

    function calculateKPIs() {
        // Simple aggregation for the latest week (assuming data is mostly one week in this snippet)
        const totalClicks = marketData.reduce((acc, curr) => acc + curr.estimated_clicks, 0);
        
        const myData = marketData.filter(d => d.is_yaba_asin === 'Y');
        const compData = marketData.filter(d => d.is_yaba_asin === 'N');

        const myClicks = myData.reduce((acc, curr) => acc + curr.estimated_clicks, 0);
        const myShare = (myClicks / totalClicks) * 100;

        // Top Competitor
        const compMap = {};
        compData.forEach(d => {
            compMap[d.competitor_brand] = (compMap[d.competitor_brand] || 0) + d.estimated_clicks;
        });
        const sortedComps = Object.entries(compMap).sort((a,b) => b[1] - a[1]);
        const topComp = sortedComps[0];
        const topCompShare = (topComp[1] / totalClicks) * 100;

        // Prices
        const myAvgPrice = myData.reduce((acc,c) => acc + c.price, 0) / myData.length;
        const mktAvgPrice = marketData.reduce((acc,c) => acc + c.price, 0) / marketData.length;
        const priceDiff = ((myAvgPrice - mktAvgPrice)/mktAvgPrice)*100;

        // Update DOM
        document.getElementById('date-range').innerText = `Semana: ${marketData[0].week_date}`;
        document.getElementById('our-brands-list').innerText = myBrands.join(', ');
        
        document.getElementById('kpi-clicks').innerText = Math.round(totalClicks).toLocaleString();
        document.getElementById('kpi-share').innerText = myShare.toFixed(1) + '%';
        
        document.getElementById('kpi-top-comp').innerText = topComp[0];
        document.getElementById('kpi-top-share').innerText = topCompShare.toFixed(1) + '% Share';
        
        document.getElementById('kpi-price').innerText = '£' + myAvgPrice.toFixed(2);
        
        const priceEl = document.getElementById('kpi-price-diff');
        priceEl.innerText = (priceDiff > 0 ? '+' : '') + priceDiff.toFixed(1) + '% vs Media';
        priceEl.style.color = priceDiff > 0 ? '#EA4335' : '#34A853'; // Red if more expensive (simple logic)
    }

    function drawTrendChart() {
        // Aggregate by week
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const dataTable = [['Semana', 'Volumen Clicks', 'Nuestro Share (%)']];

        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalC = weekData.reduce((a,c) => a + c.estimated_clicks, 0);
            const myC = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((a,c) => a + c.estimated_clicks, 0);
            const share = (myC / totalC) * 100;
            dataTable.push([week, totalC, share]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            seriesType: 'bars',
            series: {1: {type: 'line', targetAxisIndex: 1, color: colorOurBrand, lineWidth: 3}},
            vAxes: {0: {title: 'Clicks'}, 1: {title: 'Share %', format: '#\'%\''}},
            colors: ['#dadce0'],
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
        chart.draw(data, options);
    }

    function drawCompetitivenessChart() {
        // Identify top 3 brands
        const brandClicks = {};
        marketData.forEach(d => {
            if(d.is_yaba_asin === 'N') {
                brandClicks[d.competitor_brand] = (brandClicks[d.competitor_brand] || 0) + d.estimated_clicks;
            }
        });
        const top3 = Object.entries(brandClicks).sort((a,b) => b[1] - a[1]).slice(0,3).map(x => x[0]);
        
        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        const header = ['Semana', 'Nuestra Marca', ...top3, 'Resto'];
        const dataRows = [];

        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            const totalC = weekData.reduce((a,c) => a + c.estimated_clicks, 0);
            
            // Ours
            const myC = weekData.filter(d => d.is_yaba_asin === 'Y').reduce((a,c) => a + c.estimated_clicks, 0);
            const myS = (myC/totalC)*100;

            const row = [week, myS];

            // Top 3
            let top3Sum = 0;
            top3.forEach(b => {
                const bC = weekData.filter(d => d.competitor_brand === b).reduce((a,c) => a + c.estimated_clicks, 0);
                const bS = (bC/totalC)*100;
                row.push(bS);
                top3Sum += bS;
            });

            // Rest
            row.push(100 - myS - top3Sum);
            dataRows.push(row);
        });

        const data = google.visualization.arrayToDataTable([header, ...dataRows]);
        const options = {
            curveType: 'function',
            lineWidth: 3,
            colors: [colorOurBrand, colorComp1, colorComp2, colorComp3, '#eeeeee'],
            legend: {position: 'bottom'},
            vAxis: {title: 'Click Share (%)'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_competitiveness'));
        chart.draw(data, options);
    }

    function drawEfficiencyChart() {
        // Scatter: X=Rank, Y=Share, Color=IsOurs, Size=Price
        const dataTable = [['ID', 'Rank', 'Share', 'Tipo', 'Precio']];
        
        marketData.forEach(d => {
            dataTable.push([
                d.competitor_brand,
                d.average_organic_rank,
                d.click_share,
                d.is_yaba_asin === 'Y' ? 'Nuestro' : 'Competencia',
                d.price
            ]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            hAxis: {title: 'Rank Orgánico (Inverso)', direction: -1},
            vAxis: {title: 'Click Share (%)'},
            bubble: {textStyle: {fontSize: 10}},
            colors: [colorComp1, colorOurBrand], // Auto assigns by label order usually
            legend: {position: 'bottom'},
            chartArea: {width: '85%', height: '70%'}
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_efficiency'));
        chart.draw(data, options);
    }

    function drawDriversChart() {
        // Simple analysis: Share of products with Deals vs Without
        // Group by attribute
        const withDeal = marketData.filter(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);
        const noDeal = marketData.filter(d => d.weekly_number_of_days_with_deal === 0 && d.weekly_number_of_days_with_coupon === 0);

        const avgShareDeal = withDeal.length ? withDeal.reduce((a,c)=>a+c.click_share,0)/withDeal.length : 0;
        const avgShareNoDeal = noDeal.length ? noDeal.reduce((a,c)=>a+c.click_share,0)/noDeal.length : 0;

        const data = google.visualization.arrayToDataTable([
            ['Condición', 'Avg Share', { role: 'style' }],
            ['Con Promo/Deal', avgShareDeal, '#34A853'],
            ['Sin Promo', avgShareNoDeal, '#9AA0A6']
        ]);

        const options = {
            legend: {position: 'none'},
            vAxis: {title: 'Avg Click Share %'},
            bar: {groupWidth: "50%"}
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chart_drivers'));
        chart.draw(data, options);

        // Generate text for this section
        const list = document.getElementById('drivers-text');
        const diff = ((avgShareDeal - avgShareNoDeal)/avgShareNoDeal)*100;
        
        list.innerHTML = `
            <li><span class="badge badge-pos">Impacto</span> Las variantes con promociones tienen un <b>${diff.toFixed(0)}%</b> más de share promedio.</li>
            <li><span class="badge badge-neu">Volumen</span> ${withDeal.length} ASINs activos con promo vs ${noDeal.length} sin ella.</li>
        `;
    }

    function generateInsights() {
        const insights = document.getElementById('key-insights');
        const recs = document.getElementById('recommendations');
        
        // Data processing for insights
        const myData = marketData.filter(d => d.is_yaba_asin === 'Y');
        const compData = marketData.filter(d => d.is_yaba_asin === 'N');
        
        const myBest = myData.sort((a,b) => b.click_share - a.click_share)[0];
        const mktLeader = marketData.sort((a,b) => b.click_share - a.click_share)[0];
        
        // Insight 1: Dominance
        let htmlI = `<li><span class="badge ${myBest.asin === mktLeader.asin ? 'badge-pos' : 'badge-neg'}">Liderazgo</span> `;
        if(myBest.asin === mktLeader.asin) {
            htmlI += `Tu ASIN (${myBest.competitor_brand}) es el líder del mercado con ${myBest.click_share}% share.</li>`;
        } else {
            htmlI += `El líder es ${mktLeader.competitor_brand} (${mktLeader.click_share}%), superando a tu mejor ASIN (${myBest.click_share}%).</li>`;
        }

        // Insight 2: Pricing
        const myAvgP = myData.reduce((a,c)=>a+c.price,0)/myData.length;
        const compAvgP = compData.reduce((a,c)=>a+c.price,0)/compData.length;
        const priceGap = ((myAvgP - compAvgP)/compAvgP)*100;
        
        htmlI += `<li><span class="badge ${priceGap > 10 ? 'badge-neg' : 'badge-neu'}">Precio</span> `;
        htmlI += `Tus productos son un <b>${Math.abs(priceGap).toFixed(1)}% ${priceGap>0?'más caros':'más baratos'}</b> que la competencia promedio.</li>`;

        // Insight 3: Deals
        const myDeals = myData.filter(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0).length;
        htmlI += `<li><span class="badge badge-neu">Promociones</span> Tienes ${myDeals} ASINs con actividad promocional activa esta semana.</li>`;

        // Insight 4: Efficiency
        const efficientAsins = myData.filter(d => d.average_organic_rank > 5 && d.click_share > 5);
        if(efficientAsins.length > 0) {
            htmlI += `<li><span class="badge badge-pos">Oportunidad</span> Detectados ${efficientAsins.length} ASINs con alto share a pesar de bajo rank orgánico (Alta conversión).</li>`;
        }

        insights.innerHTML = htmlI;

        // Recommendations
        let htmlR = ``;
        if(priceGap > 20) htmlR += `<li><b>Ajuste de Precio:</b> La brecha de precio es alta. Evaluar cupón del 10-15% para recuperar competitividad.</li>`;
        if(mktLeader.weekly_number_of_days_with_amazon_choice_badge > 0 && myBest.weekly_number_of_days_with_amazon_choice_badge === 0) {
            htmlR += `<li><b>Badges:</b> El líder tiene Amazon Choice. Revisar keywords del título para alinear con la búsqueda exacta.</li>`;
        }
        if(myDeals === 0) htmlR += `<li><b>Activación:</b> Activar Deals en variantes de baja rotación para mejorar el ranking orgánico.</li>`;
        
        recs.innerHTML = htmlR;
    }

    // ==========================================
    // 4. INTERACTIVE TAB LOGIC
    // ==========================================

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
        
        document.getElementById('tab-report').style.display = tab === 'report' ? 'block' : 'none';
        document.getElementById('tab-compare').style.display = tab === 'compare' ? 'block' : 'none';
        
        if(tab === 'compare') drawComparison();
    }

    function populateCompetitorDropdown() {
        const select = document.getElementById('comp-select');
        competitorBrands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            select.appendChild(opt);
        });
        // Select top competitor by default
        if(competitorBrands.length > 0) select.value = competitorBrands[0];
    }

    function drawComparison() {
        const compBrand = document.getElementById('comp-select').value;
        const metric = document.getElementById('comp-metric').value;
        const metricName = document.getElementById('comp-metric').selectedOptions[0].text;

        const weeks = [...new Set(marketData.map(d => d.week_date))].sort();
        
        const dataTable = [['Semana', 'Nuestra Marca', compBrand]];

        weeks.forEach(week => {
            const weekData = marketData.filter(d => d.week_date === week);
            
            // Avg metric for Us
            const myRows = weekData.filter(d => d.is_yaba_asin === 'Y');
            const myVal = myRows.length ? myRows.reduce((a,c) => a + c[metric], 0) / myRows.length : 0;

            // Avg metric for Them
            const compRows = weekData.filter(d => d.competitor_brand === compBrand);
            const compVal = compRows.length ? compRows.reduce((a,c) => a + c[metric], 0) / compRows.length : 0;

            dataTable.push([week, myVal, compVal]);
        });

        const data = google.visualization.arrayToDataTable(dataTable);
        const options = {
            title: `Comparativa: ${metricName}`,
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: [colorOurBrand, colorComp1],
            vAxis: {title: metricName}
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_comparison'));
        chart.draw(data, options);
    }

</script>

</body>
</html>