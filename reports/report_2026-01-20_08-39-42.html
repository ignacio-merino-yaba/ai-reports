<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Inteligencia de Mercado - Amazon ASIN</title>
    
    <!-- Google Charts Loader -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #0071e3;
            --secondary: #86868b;
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --text-light: #86868b;
            --danger: #ff3b30;
            --success: #34c759;
            --border-radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        header p {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            background: #e3e3e8;
            padding: 4px;
            border-radius: 50px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-btn {
            padding: 10px 24px;
            border: none;
            background: transparent;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: var(--card-bg);
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Content Sections */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards & Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .card h2 {
            font-size: 1.25rem;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* KPI Boxes */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .kpi-box {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        .kpi-label {
            font-size: 0.9rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Charts */
        .chart-box {
            width: 100%;
            height: 350px;
        }

        /* Lists */
        ul.insights-list {
            list-style: none;
            padding: 0;
        }
        ul.insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        ul.insights-list li:last-child {
            border-bottom: none;
        }
        .material-icons.icon-blue { color: var(--primary); }
        .material-icons.icon-red { color: var(--danger); }
        .material-icons.icon-green { color: var(--success); }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            align-items: center;
        }
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
            outline: none;
            flex: 1;
        }

        /* Comparison Table */
        .comp-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .comp-table th {
            text-align: left;
            padding: 15px;
            color: var(--text-light);
            font-weight: 500;
            border-bottom: 1px solid #eee;
        }
        .comp-table td {
            padding: 20px 15px;
            font-size: 1.1rem;
            border-bottom: 1px solid #f5f5f5;
        }
        .comp-table .winner {
            color: var(--success);
            font-weight: 600;
        }
        .comp-table .loser {
            color: var(--danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .kpi-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Análisis de Rendimiento ASIN</h1>
            <p id="report-date-range">Cargando fechas...</p>
        </header>

        <!-- Navegación -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('static')">Reporte Ejecutivo</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Comparador Interactivo</button>
        </div>

        <!-- Pestaña 1: Reporte Estático -->
        <div id="tab-static" class="tab-content active">
            
            <!-- KPIs -->
            <div class="kpi-container">
                <div class="kpi-box">
                    <div class="kpi-value" id="kpi-us-share">-</div>
                    <div class="kpi-label">Click Share (Última Sem.)</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-value" id="kpi-us-rank">-</div>
                    <div class="kpi-label">Rank Orgánico Promedio</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-value" id="kpi-market-trend">-</div>
                    <div class="kpi-label">Tendencia Mercado</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-value" id="kpi-top-comp">-</div>
                    <div class="kpi-label">Competidor Top</div>
                </div>
            </div>

            <!-- Gráficos Principales -->
            <div class="grid-2">
                <div class="card">
                    <h2><span class="material-icons icon-blue">trending_up</span> Tendencia Global del Parent</h2>
                    <div id="chart_trend" class="chart-box"></div>
                </div>
                <div class="card">
                    <h2><span class="material-icons icon-red">show_chart</span> Competitividad de Marca</h2>
                    <div id="chart_share" class="chart-box"></div>
                </div>
            </div>

            <!-- Eficiencia y Recomendaciones -->
            <div class="grid-2">
                <div class="card">
                    <h2><span class="material-icons icon-green">speed</span> Eficiencia: Rank vs Share</h2>
                    <p style="font-size:0.9rem; color:#888;">Eje X: Rank (Menor es mejor) | Eje Y: Click Share</p>
                    <div id="chart_scatter" class="chart-box"></div>
                </div>
                <div class="card">
                    <h2><span class="material-icons">lightbulb</span> Insights y Recomendaciones</h2>
                    <div id="insights-container">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña 2: Comparador Interactivo -->
        <div id="tab-interactive" class="tab-content">
            <div class="controls">
                <div>
                    <label style="font-size: 0.8rem; color: #888; display:block;">Semana</label>
                    <select id="select-week" onchange="updateComparator()"></select>
                </div>
                <div>
                    <label style="font-size: 0.8rem; color: #888; display:block;">Competidor</label>
                    <select id="select-comp" onchange="updateComparator()"></select>
                </div>
            </div>

            <div class="card">
                <h2>Cara a Cara: <span id="comp-names-title" style="color:var(--primary)">Nosotros vs Competencia</span></h2>
                <table class="comp-table">
                    <thead>
                        <tr>
                            <th>Métrica</th>
                            <th id="th-us">Nuestra Marca</th>
                            <th id="th-them">Competidor</th>
                            <th>Diferencia</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-body">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h2>Detalle de ASINs (Semana Seleccionada)</h2>
                <div id="asins-detail-list" style="font-family: monospace; font-size: 0.9rem; color: #555;"></div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. DATOS INYECTADOS ---
        const marketData = {"our_brand": "NaturaleBio", "top_competitors": ["NORITUAL LAB", "Ceremonial", "Matcha"], "trend_data": [{"week": "2025-W51", "yaba_clicks": 13187.0, "comp_clicks": 29995.0, "yaba_share": 21.67}, {"week": "2025-W52", "yaba_clicks": 10415.0, "comp_clicks": 25261.0, "yaba_share": 21.83}, {"week": "2026-W01", "yaba_clicks": 6102.0, "comp_clicks": 13398.0, "yaba_share": 22.59}], "brand_curve_data": [{"week": "2025-W51", "Us": 21.67, "Comp1": 25.51, "Comp2": 11.41, "Comp3": 3.48, "Others": 8.89}, {"week": "2025-W52", "Us": 21.83, "Comp1": 27.19, "Comp2": 8.42, "Comp3": 3.4, "Others": 13.94}, {"week": "2026-W01", "Us": 22.59, "Comp1": 26.72, "Comp2": 7.38, "Comp3": 3.0, "Others": 12.5}], "scatter_data": [{"asin": "B0DRP6Y6XC", "brand": "Special Leaves", "is_us": false, "rank": 16.0, "share": 3.0, "price": 10.39, "grams": "N/A"}, {"asin": "B08XVX8V1T", "brand": "bioKontor", "is_us": false, "rank": 10.0, "share": 2.39, "price": 11.9975, "grams": "N/A"}, {"asin": "B07MD4LB49", "brand": "VAHDAM", "is_us": false, "rank": 9.0, "share": 3.15, "price": 10.43, "grams": "N/A"}, {"asin": "B0F9B1LWQQ", "brand": "UNREAL\u00ae", "is_us": false, "rank": 19.0, "share": 1.57, "price": 31.2725, "grams": "N/A"}, {"asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "is_us": true, "rank": 2.0, "share": 12.9, "price": 14.6075, "grams": "N/A"}, {"asin": "B0CNRX8G5S", "brand": "NORITUAL LAB", "is_us": false, "rank": 2.0, "share": 19.34, "price": 23.91, "grams": "N/A"}, {"asin": "B079VQ52MK", "brand": "NaturaleBio", "is_us": true, "rank": 5.0, "share": 3.66, "price": 24.5275, "grams": "N/A"}, {"asin": "B0FSL3C3Z8", "brand": "NORITUAL LAB", "is_us": false, "rank": 6.0, "share": 7.38, "price": 15.5575, "grams": "N/A"}, {"asin": "B06XQ69YCQ", "brand": "NaturaleBio", "is_us": true, "rank": 5.0, "share": 3.35, "price": 10.2225, "grams": "N/A"}, {"asin": "B07SZFD3P9", "brand": "NaturaleBio", "is_us": true, "rank": null, "share": 2.68, "price": 30.27, "grams": "N/A"}, {"asin": "B0DRP6Y6XC", "brand": "Matcha", "is_us": false, "rank": 16.0, "share": 3.0, "price": 10.39, "grams": "N/A"}, {"asin": "B0FSL3C3Z8", "brand": "Ceremonial", "is_us": false, "rank": 6.0, "share": 7.38, "price": 15.5575, "grams": "N/A"}, {"asin": "B08XVX8V1T", "brand": "Bio", "is_us": false, "rank": 10.0, "share": 2.39, "price": 11.9975, "grams": "N/A"}], "insights": ["La tendencia de clicks para NaturaleBio es decreciente (13187.0 vs 6102.0).", "En la \u00faltima semana, el l\u00edder en cuota fue Comp1 con un 26.72%.", "Nuestro posicionamiento org\u00e1nico promedio es 4.0 con una cuota media de 5.6%.", "Se observa una fuerte correlaci\u00f3n entre precios bajos y alta cuota de clicks en el segmento de competidores.", "Marcas emergentes como Matcha est\u00e1n ganando tracci\u00f3n en las \u00faltimas 2 semanas."], "recommendations": ["Ajustar precios en los ASINs con ranking < 5 pero bajo click share para mejorar conversi\u00f3n.", "Activar cupones en semanas de baja demanda org\u00e1nica para sostener la visibilidad.", "Revisar t\u00edtulos y keywords de los competidores Top 3 para cerrar la brecha de relevancia."], "raw_data": [{"week": "2025-W51", "asin": "B079VQ52MK", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 23.075714286, "share": 3.69, "rank": 5.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 2245.55319}, {"week": "2025-W51", "asin": "B07MD4LB49", "brand": "VAHDAM", "is_us": "N", "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 9.005714286, "share": 3.49, "rank": 8.0, "deal_days": 5.0, "coupon_days": 0.0, "clicks": 2123.84299}, {"week": "2025-W51", "asin": "B0DRP6Y6XC", "brand": "Matcha", "is_us": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.44, "share": 3.48, "rank": 14.0, "deal_days": 0.0, "coupon_days": 7.0, "clicks": 2117.7574799999998}, {"week": "2025-W51", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 14.084285714, "share": 11.18, "rank": 2.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 6803.600179999999}, {"week": "2025-W51", "asin": "B0CNRX8G5S", "brand": "NORITUAL LAB", "is_us": "N", "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 24.03, "share": 16.66, "rank": 2.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 10138.45966}, {"week": "2025-W51", "asin": "B06XQ69YCQ", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 9.2, "share": 3.85, "rank": 5.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 2342.92135}, {"week": "2025-W51", "asin": "B0F5BVFRC1", "brand": "Jean", "is_us": "N", "title": "Jean & Len Handcreme I Love You So Matcha, f\u00fcr nor...", "price": 3.095714286, "share": 1.92, "rank": 12.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 1168.4179199999999}, {"week": "2025-W51", "asin": "B0G1T7N675", "brand": "Ceremonial", "is_us": "N", "title": "Ceremonial Matcha Pulver BIO-Qualit\u00e4t 50g ideal zu...", "price": 8.898571429, "share": 2.56, "rank": 12.0, "deal_days": 7.0, "coupon_days": 0.0, "clicks": 1557.89056}, {"week": "2025-W51", "asin": "B0DRP6Y6XC", "brand": "Special Leaves", "is_us": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.44, "share": 3.48, "rank": 14.0, "deal_days": 0.0, "coupon_days": 7.0, "clicks": 2117.7574799999998}, {"week": "2025-W51", "asin": "B0FSL3C3Z8", "brand": "Ceremonial", "is_us": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.635714286, "share": 8.85, "rank": 5.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 5385.67635}, {"week": "2025-W51", "asin": "B07SZFD3P9", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 26.748571429, "share": 2.95, "rank": 22.0, "deal_days": 7.0, "coupon_days": 0.0, "clicks": 1795.2254500000001}, {"week": "2025-W51", "asin": "B0FSL3C3Z8", "brand": "NORITUAL LAB", "is_us": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.635714286, "share": 8.85, "rank": 5.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 5385.67635}, {"week": "2025-W52", "asin": "B0DRP6Y6XC", "brand": "Matcha", "is_us": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.71, "share": 3.4, "rank": 13.0, "deal_days": 0.0, "coupon_days": 7.0, "clicks": 1622.07404}, {"week": "2025-W52", "asin": "B079VQ52MK", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.855714286, "share": 3.49, "rank": 5.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 1665.011294}, {"week": "2025-W52", "asin": "B06XQ69YCQ", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.538571429, "share": 3.75, "rank": 4.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 1789.05225}, {"week": "2025-W52", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 15.058571429, "share": 11.66, "rank": 2.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 5562.759795999999}, {"week": "2025-W52", "asin": "B07SZFD3P9", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.704285714, "share": 2.93, "rank": 23.0, "deal_days": 1.0, "coupon_days": 0.0, "clicks": 1397.846158}, {"week": "2025-W52", "asin": "B07MD4LB49", "brand": "VAHDAM", "is_us": "N", "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 9.895714286, "share": 4.19, "rank": 7.0, "deal_days": 3.0, "coupon_days": 0.0, "clicks": 1998.9677140000001}, {"week": "2025-W52", "asin": "B07K1WBH4K", "brand": "VAHDAM", "is_us": "N", "title": "VAHDAM, Vanille Matcha Gr\u00fcner Tee Pulver (100g, 50...", "price": 9.895714286, "share": 1.47, "rank": 20.0, "deal_days": 3.0, "coupon_days": 0.0, "clicks": 701.3084819999999}, {"week": "2025-W52", "asin": "B0FSL3C3Z8", "brand": "NORITUAL LAB", "is_us": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.037142857, "share": 8.42, "rank": 6.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 4017.0186519999997}, {"week": "2025-W52", "asin": "B0FSL3C3Z8", "brand": "Ceremonial", "is_us": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 16.037142857, "share": 8.42, "rank": 6.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 4017.0186519999997}, {"week": "2025-W52", "asin": "B08XVX8V1T", "brand": "bioKontor", "is_us": "N", "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 12.367142857, "share": 2.44, "rank": 10.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 1164.076664}, {"week": "2025-W52", "asin": "B08XVX8V1T", "brand": "Bio", "is_us": "N", "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 12.367142857, "share": 2.44, "rank": 10.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 1164.076664}, {"week": "2025-W52", "asin": "B0DRP6Y6XC", "brand": "Special Leaves", "is_us": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.71, "share": 3.4, "rank": 13.0, "deal_days": 0.0, "coupon_days": 7.0, "clicks": 1622.07404}, {"week": "2025-W52", "asin": "B0CNRX8G5S", "brand": "NORITUAL LAB", "is_us": "N", "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 24.648571429, "share": 18.77, "rank": 2.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 8954.802862}, {"week": "2026-W01", "asin": "B0DRP6Y6XC", "brand": "Special Leaves", "is_us": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "share": 3.0, "rank": 16.0, "deal_days": 0.0, "coupon_days": 4.0, "clicks": 810.333}, {"week": "2026-W01", "asin": "B08XVX8V1T", "brand": "bioKontor", "is_us": "N", "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "share": 2.39, "rank": 10.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 645.56529}, {"week": "2026-W01", "asin": "B07MD4LB49", "brand": "VAHDAM", "is_us": "N", "title": "VAHDAM, Matcha Gr\u00fcntee Pulver (100g, 50+ Tassen) A...", "price": 10.43, "share": 3.15, "rank": 9.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 850.84965}, {"week": "2026-W01", "asin": "B0F9B1LWQQ", "brand": "UNREAL\u00ae", "is_us": "N", "title": "UNREAL\u00ae 100g Ceremonial Bio Matcha \u2013 100% Japanisc...", "price": 31.2725, "share": 1.57, "rank": 19.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 424.07427}, {"week": "2026-W01", "asin": "B06XQ5DCYJ", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 14.6075, "share": 12.9, "rank": 2.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 3484.4319}, {"week": "2026-W01", "asin": "B0CNRX8G5S", "brand": "NORITUAL LAB", "is_us": "N", "title": "Ceremonial Matcha - Reines Matcha Pulver aus Japan...", "price": 23.91, "share": 19.34, "rank": 2.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 5223.946739999999}, {"week": "2026-W01", "asin": "B079VQ52MK", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 24.5275, "share": 3.66, "rank": 5.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 988.6062599999999}, {"week": "2026-W01", "asin": "B0FSL3C3Z8", "brand": "NORITUAL LAB", "is_us": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.5575, "share": 7.38, "rank": 6.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 1993.41918}, {"week": "2026-W01", "asin": "B06XQ69YCQ", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Tee Pulver Bio - Premium-Qualit...", "price": 10.2225, "share": 3.35, "rank": 5.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 904.87185}, {"week": "2026-W01", "asin": "B07SZFD3P9", "brand": "NaturaleBio", "is_us": "Y", "title": "NaturaleBio Matcha Ceremonial Grade 100g. Original...", "price": 30.27, "share": 2.68, "rank": null, "deal_days": null, "coupon_days": null, "clicks": 723.89748}, {"week": "2026-W01", "asin": "B0DRP6Y6XC", "brand": "Matcha", "is_us": "N", "title": "Matcha Pulver - 90g - 100% Nat\u00fcrlich & Fein Gemahl...", "price": 10.39, "share": 3.0, "rank": 16.0, "deal_days": 0.0, "coupon_days": 4.0, "clicks": 810.333}, {"week": "2026-W01", "asin": "B0FSL3C3Z8", "brand": "Ceremonial", "is_us": "N", "title": "Ceremonial Matcha Ryoku - Reines Gr\u00fcntee-Pulver au...", "price": 15.5575, "share": 7.38, "rank": 6.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 1993.41918}, {"week": "2026-W01", "asin": "B08XVX8V1T", "brand": "Bio", "is_us": "N", "title": "Bio Matcha Pulver 100 g \u2013 Japan Matcha Tee, 100% n...", "price": 11.9975, "share": 2.39, "rank": 10.0, "deal_days": 0.0, "coupon_days": 0.0, "clicks": 645.56529}]};

        // --- 2. LOGICA DE VISUALIZACIÓN ---
        
        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(initDashboard);

        function initDashboard() {
            populateKPIs();
            populateInsights();
            populateControls();
            drawTrendChart();
            drawShareChart();
            drawScatterChart();
        }

        function populateKPIs() {
            // Fechas
            const weeks = marketData.trend_data.map(d => d.week);
            document.getElementById('report-date-range').innerText = `Periodo: ${weeks[0]} - ${weeks[weeks.length-1]}`;
            
            // KPIs de última semana
            const lastWeekData = marketData.brand_curve_data[marketData.brand_curve_data.length-1];
            document.getElementById('kpi-us-share').innerText = lastWeekData.Us + '%';
            document.getElementById('kpi-top-comp').innerText = marketData.top_competitors[0] || 'N/A';

            // Rank medio (Scatter Data is last week only)
            const usASINs = marketData.scatter_data.filter(d => d.is_us);
            const avgRank = usASINs.reduce((acc, curr) => acc + (curr.rank || 0), 0) / usASINs.length;
            document.getElementById('kpi-us-rank').innerText = isNaN(avgRank) ? '-' : avgRank.toFixed(1);

            // Tendencia
            const trend = marketData.trend_data[marketData.trend_data.length-1].yaba_clicks > marketData.trend_data[0].yaba_clicks ? 'Alcista' : 'Bajista';
            document.getElementById('kpi-market-trend').innerText = trend;
        }

        function populateInsights() {
            const container = document.getElementById('insights-container');
            const ul = document.createElement('ul');
            ul.className = 'insights-list';

            // Insights
            marketData.insights.forEach(txt => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="material-icons icon-blue">analytics</span> <span>${txt}</span>`;
                ul.appendChild(li);
            });

            // Recommendations
            marketData.recommendations.forEach(txt => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="material-icons icon-green">check_circle</span> <span>Recomendación: ${txt}</span>`;
                ul.appendChild(li);
            });

            container.appendChild(ul);
        }

        function drawTrendChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', 'Clicks Nuestros');
            data.addColumn('number', 'Clicks Competencia');
            data.addColumn('number', 'Nuestra Cuota (%)');

            marketData.trend_data.forEach(d => {
                data.addRow([d.week, d.yaba_clicks, d.comp_clicks, d.yaba_share]);
            });

            const options = {
                title: 'Volumen de Clicks vs Cuota de Mercado',
                vAxes: {
                    0: {title: 'Volumen Clicks'},
                    1: {title: 'Cuota %', format: '#\'%\''}
                },
                hAxis: {title: 'Semana'},
                seriesType: 'bars',
                series: {2: {type: 'line', targetAxisIndex: 1, color: '#0071e3', lineWidth: 3}},
                colors: ['#86868b', '#e5e5ea'],
                legend: {position: 'bottom'},
                bar: {groupWidth: "70%"},
                backgroundColor: 'transparent'
            };

            const chart = new google.visualization.ComboChart(document.getElementById('chart_trend'));
            chart.draw(data, options);
        }

        function drawShareChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Semana');
            data.addColumn('number', marketData.our_brand);
            
            // Map Comp1, Comp2, Comp3 to real names
            const comps = marketData.top_competitors;
            data.addColumn('number', comps[0] || 'Comp 1');
            data.addColumn('number', comps[1] || 'Comp 2');
            data.addColumn('number', 'Resto');

            marketData.brand_curve_data.forEach(d => {
                data.addRow([d.week, d.Us, d.Comp1, d.Comp2, d.Others]);
            });

            const options = {
                title: 'Evolución de Click Share (%)',
                curveType: 'function',
                legend: { position: 'bottom' },
                colors: ['#0071e3', '#ff3b30', '#ff9500', '#8e8e93'],
                lineWidth: 2,
                pointSize: 5,
                backgroundColor: 'transparent',
                vAxis: { format: "#'%'" }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chart_share'));
            chart.draw(data, options);
        }

        function drawScatterChart() {
            const data = new google.visualization.DataTable();
            data.addColumn('number', 'Ranking Orgánico');
            data.addColumn('number', 'Click Share (%)');
            data.addColumn({type: 'string', role: 'style'});
            data.addColumn({type: 'string', role: 'tooltip'});

            marketData.scatter_data.forEach(d => {
                const color = d.is_us ? '#0071e3' : '#ff3b30';
                const label = `${d.brand} (Rank: ${d.rank}, Share: ${d.share}%)`;
                // Google charts scatter points
                data.addRow([d.rank, d.share, `point {fill-color: ${color}; size: 6}`, label]);
            });

            const options = {
                title: 'Eficiencia: Rank Orgánico vs Click Share (Última Semana)',
                hAxis: { title: 'Rank Orgánico (Menor es mejor)', direction: 1 }, // Rank 1 is left? Usually scatter implies low=left. Rank 1 is better.
                vAxis: { title: 'Click Share (%)' },
                legend: 'none',
                backgroundColor: 'transparent'
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_scatter'));
            chart.draw(data, options);
        }

        // --- 3. LÓGICA INTERACTIVA ---

        function populateControls() {
            const weekSel = document.getElementById('select-week');
            const weeks = [...new Set(marketData.raw_data.map(d => d.week))].sort();
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = w;
                weekSel.appendChild(opt);
            });
            // Select latest
            weekSel.value = weeks[weeks.length-1];

            const compSel = document.getElementById('select-comp');
            // Get unique brands that are NOT us
            const brands = [...new Set(marketData.raw_data.filter(d => d.is_us !== 'Y' && d.brand !== marketData.our_brand).map(d => d.brand))];
            brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = b;
                compSel.appendChild(opt);
            });
            // Default select first top competitor if avail
            if (marketData.top_competitors.length > 0) {
                compSel.value = marketData.top_competitors[0];
            } else if (brands.length > 0) {
                compSel.value = brands[0];
            }
        }

        function updateComparator() {
            const week = document.getElementById('select-week').value;
            const competitor = document.getElementById('select-comp').value;
            const usName = marketData.our_brand;

            document.getElementById('th-us').innerText = usName;
            document.getElementById('th-them').innerText = competitor;
            document.getElementById('comp-names-title').innerText = `${usName} vs ${competitor}`;

            // Filter data
            const weekData = marketData.raw_data.filter(d => d.week === week);
            const usData = weekData.filter(d => d.is_us === 'Y' || d.brand === usName);
            const themData = weekData.filter(d => d.brand === competitor);

            // Calculate Metrics
            const metrics = [
                { id: 'price', label: 'Precio Promedio', fmt: v => '€' + v.toFixed(2) },
                { id: 'share', label: 'Click Share Total', fmt: v => v.toFixed(2) + '%' },
                { id: 'rank', label: 'Rank Orgánico Prom (Top 3)', fmt: v => v.toFixed(1) },
                { id: 'deal_days', label: 'Días con Oferta (Prom)', fmt: v => v.toFixed(1) }
            ];

            const tbody = document.getElementById('comparison-body');
            tbody.innerHTML = '';

            metrics.forEach(m => {
                const usVal = getMetricValue(usData, m.id);
                const themVal = getMetricValue(themData, m.id);
                const diff = usVal - themVal;
                
                // Logic for winner (High Share is good, Low Price/Rank is good?? Depends)
                // Let's just show raw diff
                let diffStr = (diff > 0 ? '+' : '') + diff.toFixed(2);
                if (m.id === 'price') diffStr = '€' + diffStr;
                if (m.id === 'share') diffStr += '%';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.label}</td>
                    <td style="font-weight:600; color:#0071e3">${m.fmt(usVal)}</td>
                    <td style="font-weight:600; color:#ff3b30">${m.fmt(themVal)}</td>
                    <td style="color:${diff > 0 ? 'green' : (diff < 0 ? 'red' : 'gray')}">${diffStr}</td>
                `;
                tbody.appendChild(tr);
            });

            // List ASINs
            const listDiv = document.getElementById('asins-detail-list');
            listDiv.innerHTML = '';
            
            // Show Us
            listDiv.innerHTML += `<strong>${usName} ASINs:</strong><br>`;
            usData.forEach(d => {
                listDiv.innerHTML += `• ${d.asin} (${d.title.substring(0,30)}...) - Share: ${d.share}% - Rank: ${d.rank}<br>`;
            });
            listDiv.innerHTML += `<br><strong>${competitor} ASINs:</strong><br>`;
            themData.forEach(d => {
                listDiv.innerHTML += `• ${d.asin} (${d.title.substring(0,30)}...) - Share: ${d.share}% - Rank: ${d.rank}<br>`;
            });
        }

        function getMetricValue(dataList, metric) {
            if (dataList.length === 0) return 0;
            if (metric === 'share') return dataList.reduce((sum, d) => sum + (d.share || 0), 0);
            
            // Averages
            let sum = 0; 
            let count = 0;
            dataList.forEach(d => {
                let val = d[metric];
                if (val !== undefined && val !== null && !isNaN(val)) {
                    sum += parseFloat(val);
                    count++;
                }
            });
            return count > 0 ? sum / count : 0;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            // Find button
            const btnIndex = tabName === 'static' ? 0 : 1;
            document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');

            // Redraw charts if static
            if (tabName === 'static') {
                drawTrendChart();
                drawShareChart();
                drawScatterChart();
            } else {
                updateComparator(); // Init comparator if first click
            }
        }

    </script>
</body>
</html>