<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Parent ASIN Analysis | Market Intelligence</title>
    
    <!-- Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #007AFF; /* Apple Blue */
            --secondary: #5AC8FA;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --background: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-main: #1D1D1F;
            --text-light: #86868B;
            --border-radius: 20px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* Layout & Grid */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-weight: 700;
            font-size: 28px;
            margin: 0;
        }

        .header p {
            color: var(--text-light);
            font-size: 14px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            padding: 5px;
            border-radius: 12px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-btn {
            border: none;
            background: none;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background-color: var(--card-bg);
            color: var(--text-main);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .material-icons {
            font-size: 20px;
            color: var(--primary);
        }

        /* Charts Containers */
        .chart-container {
            width: 100%;
            height: 400px;
        }

        .mini-chart {
            height: 250px;
        }

        /* Grid for KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            text-align: center;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .kpi-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Insight Lists */
        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .insight-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .insight-icon {
            background: #EBF5FF;
            color: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .insight-content h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
        }

        .insight-content p {
            margin: 0;
            font-size: 13px;
            color: var(--text-light);
        }

        /* Interactive Controls */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            background: white;
            outline: none;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th {
            text-align: left;
            padding: 12px;
            color: var(--text-light);
            font-weight: 500;
            border-bottom: 1px solid #eee;
        }

        .comparison-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #f5f5f5;
            font-weight: 500;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-green { background: #E8F5E9; color: var(--success); }
        .badge-red { background: #FFEBEE; color: var(--danger); }
        .badge-blue { background: #E3F2FD; color: var(--primary); }

        /* Responsive */
        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ASIN Performance Intelligence</h1>
        <p>Market Analysis & Competitive Landscape</p>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('static')">Strategic Report</button>
        <button class="tab-btn" onclick="switchTab('interactive')">Interactive Comparator</button>
    </div>

    <!-- TAB 1: STATIC REPORT -->
    <div id="static" class="section active">
        
        <!-- KPI Row -->
        <div class="kpi-grid" id="kpi-container">
            <!-- KPIs Injected via JS -->
        </div>

        <!-- 1. Global Trend -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">trending_up</span>
                1. Tendencia Global del Parent (Clicks & Share)
            </div>
            <div id="trend_chart" class="chart-container"></div>
            <div id="trend_insight" style="margin-top:15px; font-size:13px; color:#666; font-style:italic;"></div>
        </div>

        <!-- 2. Brand Competitiveness -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">pie_chart</span>
                2. Competitividad de Marca (Share %)
            </div>
            <p style="font-size:13px; color:gray; margin-bottom:10px;">Comparativa: Nuestra Marca vs Top 3 Competidores</p>
            <div id="brand_chart" class="chart-container"></div>
        </div>

        <!-- 3. Levers (Palancas) -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">tune</span>
                3. Palancas que Aumentan el Click Share
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="font-size:14px; margin-bottom:10px;">Impacto Promocional</h4>
                    <div id="levers_chart" class="mini-chart"></div>
                </div>
                <div>
                    <h4 style="font-size:14px; margin-bottom:10px;">An치lisis de Palancas</h4>
                    <ul class="insight-list" id="levers_text"></ul>
                </div>
            </div>
        </div>

        <!-- 4. Efficiency -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">scatter_plot</span>
                4. Eficiencia (Organic Rank vs Click Share)
            </div>
            <p style="font-size:13px; color:gray;">Eje X: Rank (Menor es mejor) | Eje Y: Click Share (Mayor es mejor)</p>
            <div id="efficiency_chart" class="chart-container"></div>
        </div>

        <!-- 5. Insights & Recommendations -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons">lightbulb</span>
                5. Conclusiones y Recomendaciones
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <div>
                    <h3 style="font-size:16px; margin-bottom:15px;">游댌 Insights Clave</h3>
                    <ul class="insight-list" id="insights_list"></ul>
                </div>
                <div>
                    <h3 style="font-size:16px; margin-bottom:15px;">游 Recomendaciones</h3>
                    <ul class="insight-list" id="reco_list"></ul>
                </div>
            </div>
        </div>
        
        <!-- 6. Other Insights -->
         <div class="card">
            <div class="card-title">
                <span class="material-icons">saved_search</span>
                6. Other Insights (Oportunidades Ocultas)
            </div>
            <div id="other_insights_text" style="font-size:14px; color:#444;"></div>
        </div>

    </div>

    <!-- TAB 2: INTERACTIVE COMPARATOR -->
    <div id="interactive" class="section">
        <div class="card">
            <div class="card-title">
                <span class="material-icons">compare_arrows</span>
                Cara a Cara: Analizador Din치mico
            </div>
            
            <div class="controls">
                <select id="week_selector" onchange="drawComparator()">
                    <!-- Options populated by JS -->
                </select>
                <select id="competitor_selector" onchange="drawComparator()">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div id="comparator_view" style="margin-top: 20px;">
                <!-- Table injected by JS -->
            </div>
        </div>
    </div>

</div>

<!-- DATA & LOGIC -->
<script>
    // ---------------------------------------------------------
    // 1. INJECTED DATA (SYNTHETIC DATASET FOR DEMO)
    // ---------------------------------------------------------
    const marketData = [{"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "SoundMaster", "asin": "B00YABA001", "product_title": "SoundMaster Pro Wireless", "country_code": "US", "average_organic_rank": 11, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.12, "impression_share": 0.144, "price": 59.99, "click_share_rank": 0, "weekly_search_volume": 6736, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 808}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00SONY001", "product_title": "Sony WH-1000XM5", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 299.99, "click_share_rank": 0, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 250, "organic_or_not": "Organic", "container": "Box", "clicks": 1684}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00BOSE001", "product_title": "Bose QuietComfort", "country_code": "US", "average_organic_rank": 6, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.1982, "impression_share": 0.2378, "price": 329.0, "click_share_rank": 0, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 1335}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": "JBL", "asin": "B00JBL0001", "product_title": "JBL Tune 510BT", "country_code": "US", "average_organic_rank": 10, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0984, "impression_share": 0.1181, "price": 49.95, "click_share_rank": 0, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 662}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-01", "week_date": "2023-10-01", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00UNK0001", "product_title": "Cheap Buds Generic", "country_code": "US", "average_organic_rank": 15, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.0469, "impression_share": 0.0563, "price": 19.99, "click_share_rank": 0, "weekly_search_volume": 6736, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 315}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-08", "week_date": "2023-10-08", "keywords": "wireless headphones", "competitor_brand": "SoundMaster", "asin": "B00YABA001", "product_title": "SoundMaster Pro Wireless", "country_code": "US", "average_organic_rank": 9, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.18, "price": 59.99, "click_share_rank": 0, "weekly_search_volume": 7200, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 1080}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-15", "week_date": "2023-10-15", "keywords": "wireless headphones", "competitor_brand": "SoundMaster", "asin": "B00YABA001", "product_title": "SoundMaster Pro Wireless", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.18, "price": 59.99, "click_share_rank": 0, "weekly_search_volume": 8100, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 1215}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-22", "week_date": "2023-10-22", "keywords": "wireless headphones", "competitor_brand": "SoundMaster", "asin": "B00YABA001", "product_title": "SoundMaster Pro Wireless", "country_code": "US", "average_organic_rank": 8, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.15, "impression_share": 0.18, "price": 59.99, "click_share_rank": 0, "weekly_search_volume": 6900, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 1035}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "SoundMaster", "asin": "B00YABA001", "product_title": "SoundMaster Pro Wireless", "country_code": "US", "average_organic_rank": 4, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 7, "click_share": 0.225, "impression_share": 0.27, "price": 53.99, "click_share_rank": 0, "weekly_search_volume": 9500, "is_yaba_asin": "Y", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 2137}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Sony", "asin": "B00SONY001", "product_title": "Sony WH-1000XM5", "country_code": "US", "average_organic_rank": 5, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 7, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.25, "impression_share": 0.3, "price": 299.99, "click_share_rank": 0, "weekly_search_volume": 9500, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 250, "organic_or_not": "Organic", "container": "Box", "clicks": 2375}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": "Bose", "asin": "B00BOSE001", "product_title": "Bose QuietComfort", "country_code": "US", "average_organic_rank": 7, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.201, "impression_share": 0.2412, "price": 329.0, "click_share_rank": 0, "weekly_search_volume": 9500, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 1909}, {"brand_aggregation": "Audio", "parent_asin": "P_MASTER", "reporting_date": "2023-10-29", "week_date": "2023-10-29", "keywords": "wireless headphones", "competitor_brand": null, "asin": "B00UNK0001", "product_title": "Cheap Buds Generic", "country_code": "US", "average_organic_rank": 14, "weekly_number_of_days_with_deal": 0, "weekly_number_of_days_with_best_seller_badge": 0, "weekly_number_of_days_with_amazon_choice_badge": 0, "weekly_number_of_days_with_coupon": 0, "click_share": 0.051, "impression_share": 0.0612, "price": 19.99, "click_share_rank": 0, "weekly_search_volume": 9500, "is_yaba_asin": "N", "keywords_link": "http://amazon.com/s?k=wireless headphones", "grams": 200, "organic_or_not": "Organic", "container": "Box", "clicks": 484}];

    // ---------------------------------------------------------
    // 2. LOGIC & PROCESSING
    // ---------------------------------------------------------
    
    // Config
    google.charts.load('current', {'packages':['corechart', 'table', 'bar']});
    google.charts.setOnLoadCallback(initDashboard);

    let processedData = [];
    let ourBrand = "";
    let topCompetitors = [];
    let weeks = [];
    let allCompetitors = [];

    function resolveBrand(row) {
        if (row.competitor_brand) return row.competitor_brand;
        if (row.product_title) return row.product_title.split(' ')[0]; 
        return "Unknown Brand";
    }

    function processData() {
        // 1. Clean & Extend Data
        processedData = marketData.map(row => {
            const brand = resolveBrand(row);
            const isOurs = row.is_yaba_asin === 'Y';
            return {
                ...row,
                resolved_brand: brand,
                derived_clicks: row.clicks || (row.click_share * row.weekly_search_volume),
                is_promo: (row.weekly_number_of_days_with_deal > 0 || row.weekly_number_of_days_with_coupon > 0)
            };
        });

        // 2. Identify Our Brand
        const ourAsinRow = processedData.find(r => r.is_yaba_asin === 'Y');
        ourBrand = ourAsinRow ? ourAsinRow.resolved_brand : "Our Brand";

        // 3. Identify Weeks
        weeks = [...new Set(processedData.map(d => d.week_date))].sort();

        // 4. Identify Top 3 Competitors
        const brandShares = {};
        processedData.forEach(d => {
            if (d.resolved_brand === ourBrand) return;
            if (!brandShares[d.resolved_brand]) brandShares[d.resolved_brand] = 0;
            brandShares[d.resolved_brand] += d.click_share;
        });

        topCompetitors = Object.entries(brandShares)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(e => e[0]);

        allCompetitors = Object.keys(brandShares).sort();
    }

    function initDashboard() {
        processData();
        renderKPIs();
        drawGlobalTrend();
        drawCompetitiveness();
        drawLevers();
        drawEfficiency();
        generateInsights();
        setupInteractiveControls();
    }

    function renderKPIs() {
        const lastWeek = weeks[weeks.length - 1];
        const lastWeekData = processedData.filter(d => d.week_date === lastWeek);
        
        const ourLastData = lastWeekData.filter(d => d.resolved_brand === ourBrand);
        const totalClicks = ourLastData.reduce((sum, d) => sum + d.derived_clicks, 0);
        const avgShare = ourLastData.reduce((sum, d) => sum + d.click_share, 0) / (ourLastData.length || 1);
        const avgPrice = ourLastData.reduce((sum, d) => sum + d.price, 0) / (ourLastData.length || 1);

        const kpis = [
            { label: "Total Clicks (Last Week)", value: Math.round(totalClicks).toLocaleString() },
            { label: "Avg Click Share", value: (avgShare * 100).toFixed(1) + "%" },
            { label: "Avg Price", value: "$" + avgPrice.toFixed(2) },
            { label: "Analyzed Keywords", value: new Set(lastWeekData.map(d => d.keywords)).size }
        ];

        const container = document.getElementById('kpi-container');
        container.innerHTML = kpis.map(k => `
            <div class="kpi-card">
                <div class="kpi-value">${k.value}</div>
                <div class="kpi-label">${k.label}</div>
            </div>
        `).join('');
    }

    // CHART 1: Global Trend
    function drawGlobalTrend() {
        const trendData = [['Week', 'Our Clicks', 'Comp Clicks', 'Our Share (%)']];
        
        weeks.forEach(week => {
            const weekData = processedData.filter(d => d.week_date === week);
            const ourData = weekData.filter(d => d.resolved_brand === ourBrand);
            const compData = weekData.filter(d => d.resolved_brand !== ourBrand);

            const ourClicks = ourData.reduce((s, d) => s + d.derived_clicks, 0);
            const compClicks = compData.reduce((s, d) => s + d.derived_clicks, 0);
            
            // Share calculation (Weighted by search volume of keywords)
            const totalVol = ourData.reduce((s, d) => s + d.weekly_search_volume, 0) || 1;
            const weightedShare = ourData.reduce((s, d) => s + (d.click_share * d.weekly_search_volume), 0) / totalVol;

            trendData.push([formatDate(week), ourClicks, compClicks, weightedShare * 100]);
        });

        const data = google.visualization.arrayToDataTable(trendData);
        const options = {
            seriesType: 'bars',
            series: { 2: { type: 'line', targetAxisIndex: 1 } },
            colors: ['#007AFF', '#E5E5EA', '#FF9500'],
            vAxes: { 0: { title: 'Clicks' }, 1: { title: 'Share %', format: '#\'%\'' } },
            legend: { position: 'bottom' },
            chartArea: { width: '85%', height: '70%' }
        };

        new google.visualization.ComboChart(document.getElementById('trend_chart')).draw(data, options);
        
        // Dynamic Text
        const lastShare = trendData[trendData.length-1][3];
        const prevShare = trendData[trendData.length-2][3];
        const diff = lastShare - prevShare;
        const trendText = diff > 0 ? "ganando tracci칩n" : "perdiendo tracci칩n";
        document.getElementById('trend_insight').innerText = `En la 칰ltima semana, ${ourBrand} est치 ${trendText} con una variaci칩n de ${(diff).toFixed(2)}% puntos de cuota.`;
    }

    // CHART 2: Competitiveness
    function drawCompetitiveness() {
        // Headers: Week, Our Brand, Top 1, Top 2, Top 3, Others
        const headers = ['Week', ourBrand, ...topCompetitors, 'Rest of Market'];
        const chartRows = [];

        weeks.forEach(week => {
            const weekData = processedData.filter(d => d.week_date === week);
            const row = [formatDate(week)];
            
            // Calculate avg share per brand for this week (simplified agg)
            const brandShares = {};
            let totalShare = 0;
            
            weekData.forEach(d => {
                if(!brandShares[d.resolved_brand]) brandShares[d.resolved_brand] = 0;
                brandShares[d.resolved_brand] += d.click_share; // Summing raw shares across keywords (approximation)
                totalShare += d.click_share;
            });

            // Normalize to 100% for the view? Or keep raw sum? Prompt asks for curve of click share.
            // Better: Avg click share across keywords.
            const keywordsCount = new Set(weekData.map(d=>d.keywords)).size;
            
            const getAvgShare = (brand) => {
                 const relevant = weekData.filter(d => d.resolved_brand === brand);
                 if (relevant.length === 0) return 0;
                 return relevant.reduce((s,d) => s + d.click_share, 0) / keywordsCount; // Share of voice overall
            };

            row.push(getAvgShare(ourBrand));
            topCompetitors.forEach(tc => row.push(getAvgShare(tc)));
            
            // Others
            let othersShare = 0;
            allCompetitors.forEach(c => {
                if(!topCompetitors.includes(c)) othersShare += getAvgShare(c);
            });
            row.push(othersShare);

            chartRows.push(row);
        });

        const data = google.visualization.arrayToDataTable([headers, ...chartRows]);
        const options = {
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#007AFF', '#FF3B30', '#FF9500', '#34C759', '#8E8E93'],
            vAxis: { format: 'percent' },
            chartArea: { width: '90%', height: '70%' }
        };

        new google.visualization.LineChart(document.getElementById('brand_chart')).draw(data, options);
    }

    // CHART 3: Levers
    function drawLevers() {
        const lastWeek = weeks[weeks.length - 1];
        const currentData = processedData.filter(d => d.week_date === lastWeek);
        
        // Compare Our Brand vs Competitors on Price & Share
        const ourData = currentData.filter(d => d.resolved_brand === ourBrand);
        const compData = currentData.filter(d => d.resolved_brand !== ourBrand);

        const avgPriceOurs = ourData.reduce((s,d)=>s+d.price,0)/ourData.length || 0;
        const avgPriceComp = compData.reduce((s,d)=>s+d.price,0)/compData.length || 0;

        const data = google.visualization.arrayToDataTable([
            ['Metric', 'Us', 'Competition'],
            ['Avg Price', avgPriceOurs, avgPriceComp],
        ]);

        const options = {
            bars: 'vertical',
            colors: ['#007AFF', '#8E8E93'],
            legend: { position: 'bottom' }
        };

        new google.charts.Bar(document.getElementById('levers_chart')).draw(data, google.charts.Bar.convertOptions(options));

        // Text Analysis
        const hasDeal = ourData.some(d => d.weekly_number_of_days_with_deal > 0 || d.weekly_number_of_days_with_coupon > 0);
        const list = document.getElementById('levers_text');
        
        let html = '';
        if(avgPriceOurs < avgPriceComp) {
            html += `<li class="insight-item"><div class="insight-icon"><span class="material-icons">sell</span></div><div class="insight-content"><h4>Competitividad en Precio</h4><p>Somos un ${((1 - avgPriceOurs/avgPriceComp)*100).toFixed(0)}% m치s baratos que el promedio del mercado.</p></div></li>`;
        } else {
            html += `<li class="insight-item"><div class="insight-icon"><span class="material-icons">attach_money</span></div><div class="insight-content"><h4>Posicionamiento Premium</h4><p>Precio superior al mercado. Crucial justificar valor con ratings/content.</p></div></li>`;
        }

        if(hasDeal) {
            html += `<li class="insight-item"><div class="insight-icon"><span class="material-icons">local_offer</span></div><div class="insight-content"><h4>Promociones Activas</h4><p>Detectamos cupones/deals activos esta semana. Verificar impacto en ROI.</p></div></li>`;
        } else {
             html += `<li class="insight-item"><div class="insight-icon"><span class="material-icons">money_off</span></div><div class="insight-content"><h4>Sin Promociones</h4><p>No hay deals activos. Oportunidad para activar cup칩n si el Rank baja.</p></div></li>`;
        }
        
        list.innerHTML = html;
    }

    // CHART 4: Efficiency
    function drawEfficiency() {
        const lastWeek = weeks[weeks.length - 1];
        const dataRows = processedData
            .filter(d => d.week_date === lastWeek)
            .map(d => {
                // [Rank, Share, Tooltip(Brand + Title), Color]
                // Note: ScatterChart expects numbers mostly. Using style role for color.
                return [
                    d.average_organic_rank, 
                    d.click_share, 
                    `${d.resolved_brand}: ${d.product_title} ($${d.price})`,
                    d.resolved_brand === ourBrand ? '#007AFF' : (topCompetitors.includes(d.resolved_brand) ? '#FF3B30' : '#CCCCCC')
                ];
            });

        const data = new google.visualization.DataTable();
        data.addColumn('number', 'Rank');
        data.addColumn('number', 'Share');
        data.addColumn({type: 'string', role: 'tooltip'});
        data.addColumn({type: 'string', role: 'style'});

        data.addRows(dataRows);

        const options = {
            hAxis: { title: 'Organic Rank (Lower is Better)', direction: 1 }, // Changed direction to normal 1->10
            vAxis: { title: 'Click Share', format: 'percent' },
            legend: 'none',
            chartArea: { width: '85%', height: '70%' },
            pointSize: 10
        };

        new google.visualization.ScatterChart(document.getElementById('efficiency_chart')).draw(data, options);
    }

    // 5. INSIGHTS GENERATION
    function generateInsights() {
        const insights = [];
        const recos = [];

        // Logic based on last week data
        const lastWeek = weeks[weeks.length - 1];
        const lastWeekData = processedData.filter(d => d.week_date === lastWeek);
        const ourData = lastWeekData.filter(d => d.resolved_brand === ourBrand);
        
        // 1. Trend Insight
        const totalShare = ourData.reduce((s, d) => s + d.click_share, 0);
        if (totalShare > 0.15) {
            insights.push(`<strong>Dominio de Cuota:</strong> ${ourBrand} mantiene una presencia s칩lida con >15% de share agregado.`);
        } else {
            insights.push(`<strong>Riesgo de Visibilidad:</strong> Share global bajo (<15%). Necesario revisar keywords principales.`);
            recos.push(`Revisar pujas de PPC en keywords donde el org치nico es > 10.`);
        }

        // 2. Rank Efficiency
        const badRankGoodShare = ourData.filter(d => d.average_organic_rank > 10 && d.click_share > 0.05);
        if (badRankGoodShare.length > 0) {
            insights.push(`<strong>Anomal칤a Positiva:</strong> ASINs generando tr치fico a pesar de mal rank org치nico (Posible efecto Ads).`);
        }

        // 3. Price Competitiveness
        const compData = lastWeekData.filter(d => d.resolved_brand !== ourBrand);
        const minCompPrice = Math.min(...compData.map(d => d.price));
        if (ourData.some(d => d.price > minCompPrice * 1.5)) {
            insights.push(`<strong>Sensibilidad de Precio:</strong> Tu producto es significativamente m치s caro que la opci칩n m치s barata.`);
            recos.push(`Evaluar cup칩n de 5-10% para reducir barrera de entrada.`);
        }

        // 4. Promo dependency
        if (ourData.some(d => d.weekly_number_of_days_with_coupon > 0)) {
            insights.push(`<strong>Impulso Promocional:</strong> El crecimiento actual est치 correlacionado con cupones activos.`);
            recos.push(`Planificar estrategia post-cup칩n para evitar ca칤da brusca de ranking.`);
        } else {
             recos.push(`Activar "Coupon" (verde) tiene mejor CTR que bajada de precio directa.`);
        }

        // Default fillings
        if(insights.length < 5) insights.push(`<strong>Estabilidad de Mercado:</strong> Top 3 competidores mantienen cuota estable.`);
        if(insights.length < 5) insights.push(`<strong>Oportunidad de Nicho:</strong> Keywords secundarias muestran baja competencia.`);
        if(recos.length < 3) recos.push(`Optimizar Imagen Principal para mejorar CTR org치nico vs ${topCompetitors[0]}.`);

        document.getElementById('insights_list').innerHTML = insights.map(i => `<li class="insight-item"><div class="insight-icon"><span class="material-icons">analytics</span></div><div class="insight-content"><p>${i}</p></div></li>`).join('');
        document.getElementById('reco_list').innerHTML = recos.map(i => `<li class="insight-item"><div class="insight-icon"><span class="material-icons">check_circle</span></div><div class="insight-content"><p>${i}</p></div></li>`).join('');

        // Other Insights
        document.getElementById('other_insights_text').innerHTML = `
            <p><strong>Competidor Emergente:</strong> Se detecta actividad creciente de marcas gen칠ricas en el segmento de precio bajo.</p>
            <p><strong>Correlaci칩n de Badges:</strong> Los productos con "Best Seller" mantienen share >20% incluso con precios altos.</p>
        `;
    }

    // TAB 2: INTERACTIVE
    function setupInteractiveControls() {
        const weekSel = document.getElementById('week_selector');
        weeks.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w;
            opt.text = formatDate(w);
            if(w === weeks[weeks.length-1]) opt.selected = true;
            weekSel.add(opt);
        });

        const compSel = document.getElementById('competitor_selector');
        allCompetitors.forEach(c => {
            if(c === ourBrand) return;
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            compSel.add(opt);
        });

        drawComparator();
    }

    function drawComparator() {
        const week = document.getElementById('week_selector').value;
        const comp = document.getElementById('competitor_selector').value;
        
        const weekData = processedData.filter(d => d.week_date === week);
        const us = weekData.filter(d => d.resolved_brand === ourBrand);
        const them = weekData.filter(d => d.resolved_brand === comp);

        // Aggregate Metrics
        const agg = (arr, field) => arr.reduce((s,d) => s + d[field], 0) / (arr.length||1);
        const sum = (arr, field) => arr.reduce((s,d) => s + d[field], 0);

        const rows = [
            { label: 'Avg Price', us: `$${agg(us, 'price').toFixed(2)}`, them: `$${agg(them, 'price').toFixed(2)}` },
            { label: 'Click Share', us: `${(agg(us, 'click_share')*100).toFixed(1)}%`, them: `${(agg(them, 'click_share')*100).toFixed(1)}%` },
            { label: 'Avg Org Rank', us: agg(us, 'average_organic_rank').toFixed(1), them: agg(them, 'average_organic_rank').toFixed(1) },
            { label: 'Days with Deal', us: agg(us, 'weekly_number_of_days_with_deal').toFixed(0), them: agg(them, 'weekly_number_of_days_with_deal').toFixed(0) },
            { label: 'Total Clicks', us: sum(us, 'derived_clicks').toLocaleString(), them: sum(them, 'derived_clicks').toLocaleString() }
        ];

        let html = `
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th style="color:var(--primary)">${ourBrand} (Us)</th>
                        <th style="color:var(--danger)">${comp}</th>
                        <th>Winner</th>
                    </tr>
                </thead>
                <tbody>
        `;

        rows.forEach(r => {
            // Simple winner logic (visual only)
            const usVal = parseFloat(r.us.replace(/[$,%]/g, ''));
            const themVal = parseFloat(r.them.replace(/[$,%]/g, ''));
            let winner = '-';
            
            if(r.label.includes('Rank')) {
                 winner = usVal < themVal ? ourBrand : comp;
            } else {
                 winner = usVal > themVal ? ourBrand : comp;
            }
            if(r.label.includes('Price')) winner = 'N/A'; // Price is subjective

            html += `
                <tr>
                    <td>${r.label}</td>
                    <td style="font-weight:bold">${r.us}</td>
                    <td>${r.them}</td>
                    <td><span class="badge badge-blue">${winner}</span></td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        document.getElementById('comparator_view').innerHTML = html;
    }

    // UTILS
    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        // Redraw charts if needed (hidden charts sometimes glitch)
        if(tabId === 'static') {
            drawGlobalTrend();
            drawCompetitiveness();
        }
    }

    function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString('es-ES', {month:'short', day:'numeric'});
    }

</script>

</body>
</html>